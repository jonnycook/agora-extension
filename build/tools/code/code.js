// Generated by CoffeeScript 1.7.1
var load, save;

load = function(name, cb) {
  return chrome.storage.local.get('codeDev', function(data) {
    var _ref;
    return cb((_ref = data.codeDev) != null ? _ref[name] : void 0);
  });
};

save = function(name, value) {
  return chrome.storage.local.get('codeDev', function(data) {
    if (data.codeDev == null) {
      data.codeDev = {};
    }
    data.codeDev[name] = value;
    return chrome.storage.local.set({
      codeDev: data.codeDev
    });
  });
};

$(function() {
  var Sites, compileTimer, createEntryEl, doRun, encodeHtml, evalEl, output, run, update, updateOutput, usingSite;
  evalEl = $('<iframe src="scrapeDev/eval.html" />').appendTo('body').hide();
  usingSite = 0;
  (function() {
    var el;
    el = $('<div id="sitesArea"> <input type="text" name="usingSite" value="0"> <textarea id="sites" /> </div>').appendTo('body');
    $('#sites').change(function() {
      Sites.updateSites($(this).val());
      return save('sites', $(this).val());
    });
    return $('[name=usingSite]').keyup(function() {
      usingSite = parseInt($(this).val());
      return update();
    });
  })();
  load('sites', function(sites) {
    $('#sites').val(sites);
    return Sites.updateSites(sites);
  });
  encodeHtml = function(html) {
    return html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  };
  update = function() {
    var _ref;
    if ((_ref = Sites.siteList[usingSite]) != null ? _ref.content : void 0) {
      $('#html').html(encodeHtml(Sites.siteList[usingSite].content));
      return doRun();
    }
  };
  Sites = {
    sites: {},
    siteList: [],
    downloadSite: function(site) {
      console.debug("downloading site " + site);
      this.sites[site] = {
        index: this.siteList.length
      };
      this.siteList[this.sites[site].index] = this.sites[site];
      return $.get(site, ((function(_this) {
        return function(response) {
          _this.sites[site].content = response;
          return update();
        };
      })(this)), 'text');
    },
    updateSites: function(sitesString) {
      var site, sites, _i, _len, _results;
      sites = sitesString.split(/\s+/g);
      _results = [];
      for (_i = 0, _len = sites.length; _i < _len; _i++) {
        site = sites[_i];
        site = site.trim();
        if (site) {
          if (!this.sites[site]) {
            _results.push(this.downloadSite(site));
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }
  };
  $('<div id="area"> <div id="html" /> <div id="editor" /> <div id="outputPanel"> <input type="text"> <div id="output" /> </div> </div>').appendTo('body');
  $('#outputPanel > input').keyup(function() {
    save('filter', $(this).val());
    return updateOutput();
  });
  load('filter', function(filter) {
    return $('#outputPanel > input').val(filter);
  });
  doRun = function() {
    var code;
    if (Sites.siteList[usingSite]) {
      code = CoffeeScript.compile(editor.getValue(), {
        bare: true
      });
      return run(code);
    }
  };
  run = function(code) {
    var subject;
    code = code.replace(/(.*?)\s*=\s*matchAll/g, function(match, variable) {
      return "set('" + variable + "'); " + match;
    });
    code = code.replace(/(.*?)\s*=\s*.*?\.match/g, function(match, variable) {
      return "set('" + variable + "'); " + match;
    });
    code = code.replace(/(.*?)\s*=\s*\/.*?\/\.exec/g, function(match, variable) {
      return "set('" + variable + "'); " + match;
    });
    subject = Sites.siteList[usingSite].content;
    return evalEl.get(0).contentWindow.postMessage({
      subject: subject,
      code: code
    }, '*');
  };
  compileTimer = null;
  setTimeout((function() {
    editor.doc.on('change', function() {
      save('code', editor.getValue());
      clearTimeout(compileTimer);
      return compileTimer = setTimeout((function() {
        return doRun();
      }), 200);
    });
    return chrome.storage.local.get('codeDev', function(data) {
      var _ref;
      return editor.setValue((_ref = data.codeDev) != null ? _ref.code : void 0);
    });
  }), 0);
  createEntryEl = function(entry) {
    var el, match, matches, matchesEl, _i, _j, _k, _len, _len1, _len2, _ref, _ref1;
    el = $("<div class='entry' />");
    if (entry.type === 'match') {
      if (entry.name) {
        el.append("<div class='name'>" + entry.name + "</div>");
      }
      if (entry.value) {
        el.append('<ul />');
        _ref = entry.value;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          match = _ref[_i];
          el.find('ul').append($('<li />').html(encodeHtml(match)));
        }
      } else {
        el.html('no match');
      }
      return el;
    } else if (entry.type === 'matchAll') {
      if (entry.name) {
        el.append("<div class='name'>" + entry.name + "</div>");
      }
      el.append('<ul />');
      _ref1 = entry.value;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        matches = _ref1[_j];
        matchesEl = $('<li><ul /></ul>').appendTo(el.children('ul'));
        for (_k = 0, _len2 = matches.length; _k < _len2; _k++) {
          match = matches[_k];
          matchesEl.children('ul').append($('<li />').html(encodeHtml(match)));
        }
      }
      return el;
    } else if (entry.type === 'variable') {
      el.append("<div class='name'>" + entry.name + "</div>");
      el.append("<div class='json'>" + (JSON.stringify(entry.value, void 0, 2)) + "</div>");
      return el;
    }
  };
  output = null;
  updateOutput = function() {
    var entry, filter, name, _i, _j, _k, _l, _len, _len1, _len2, _len3, _results, _results1;
    $('#output').html('');
    if (output) {
      if ($('#outputPanel > input').val()) {
        filter = $('#outputPanel > input').val().split(/,\s*/);
        for (_i = 0, _len = filter.length; _i < _len; _i++) {
          name = filter[_i];
          for (_j = 0, _len1 = output.length; _j < _len1; _j++) {
            entry = output[_j];
            if (entry.name && entry.name === name) {
              $('#output').append(createEntryEl(entry));
            }
          }
        }
        _results = [];
        for (_k = 0, _len2 = output.length; _k < _len2; _k++) {
          entry = output[_k];
          if (!entry.name) {
            _results.push($('#output').append(createEntryEl(entry)));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      } else {
        _results1 = [];
        for (_l = 0, _len3 = output.length; _l < _len3; _l++) {
          entry = output[_l];
          _results1.push($('#output').append(createEntryEl(entry)));
        }
        return _results1;
      }
    }
  };
  return window.addEventListener('message', function(event) {
    output = event.data;
    return updateOutput();
  });
});

//# sourceMappingURL=code.map
