// Generated by CoffeeScript 1.10.0
define(['taxonomy', 'util', 'underscore'], function(taxonomy, util, _) {
  var SiteProduct;
  return SiteProduct = (function() {
    function SiteProduct(product) {
      this.product = product;
    }

    SiteProduct.prototype.properties = function(properties, cb) {};

    SiteProduct.prototype.usedProperties = function(type, cb) {
      var count, i, len, properties, property, results, usedProperties;
      properties = taxonomy.properties(type);
      count = properties.length;
      if (count) {
        usedProperties = [];
        results = [];
        for (i = 0, len = properties.length; i < len; i++) {
          property = properties[i];
          results.push((function(_this) {
            return function(property) {
              return _this.property(property, function(value) {
                if (value !== void 0) {
                  usedProperties.push(property);
                }
                if (!--count) {
                  return cb(usedProperties);
                }
              });
            };
          })(this)(property));
        }
        return results;
      } else {
        return cb([]);
      }
    };

    SiteProduct.prototype.property = function(path, cb) {
      var func, parts, ref, ref1;
      parts = path.split('.');
      func = (ref = this.types) != null ? (ref1 = ref[parts[0]]) != null ? ref1[parts[1]] : void 0 : void 0;
      if (func) {
        return func.call(this, cb);
      } else {
        return cb();
      }
    };

    SiteProduct.prototype.reviews = function(cb) {
      return this.product["with"]('reviews', function(reviews) {
        return cb({
          reviews: reviews != null ? reviews : []
        });
      });
    };

    SiteProduct.prototype.genWidgets = function(obj, widgetDefs) {
      var dataType, name, o, parts, prop, ref, type, value, widget, widgetDef, widgets;
      widgets = [];
      for (prop in widgetDefs) {
        widgetDef = widgetDefs[prop];
        value = (function() {
          var i, len;
          if (widgetDef.obj) {
            return widgetDef.obj;
          } else {
            parts = prop.split('.');
            o = obj;
            for (i = 0, len = parts.length; i < len; i++) {
              name = parts[i];
              o = o[name];
            }
            return o;
          }
        })();
        if (value == null) {
          continue;
        }
        dataType = _.isString(value) ? 'string' : _.isArray(value) ? 'array' : _.isPlainObject(value) ? 'object' : void 0;
        type = (function() {
          if (prop === 'reviews') {
            return 'Reviews';
          } else {
            switch (dataType) {
              case 'string':
                return 'html';
              case 'array':
                return 'List';
              case 'object':
                return 'Details';
            }
          }
        })();
        if (type === 'Reviews') {
          if (value.length === 0) {
            continue;
          }
        }
        if (_.isString(widgetDef)) {
          widgetDef = {
            title: widgetDef,
            type: type
          };
        }
        widget = {
          type: (ref = widgetDef.type) != null ? ref : type,
          data: {
            title: widgetDef.title
          }
        };
        if (widget.type === 'html') {
          if (widgetDef.stripHtml == null) {
            widgetDef.stripHtml = true;
          }
          widget.data.maxHeight = widgetDef.maxHeight != null ? widgetDef.maxHeight : 'none';
        } else if (widget.type === 'Reviews') {
          if (widgetDef.maxHeight != null) {
            widget.data.maxHeight = widgetDef.maxHeight;
          }
          if (widgetDef.count != null) {
            widget.data.count = widgetDef.count;
          }
        }
        if (widget.type === 'html' && widgetDef.stripHtml) {
          widget.data.content = util.stripHtml(value, null, this.baseUrl);
        } else {
          if (widget.type === 'Reviews') {
            value = _.map(value, (function(_this) {
              return function(review) {
                var mapping, newReview, p, ref1;
                newReview = _.clone(review);
                newReview.url = util.url(newReview.url);
                if (widgetDef.map) {
                  ref1 = widgetDef.map;
                  for (p in ref1) {
                    mapping = ref1[p];
                    if (_.isFunction(mapping)) {
                      newReview[p] = mapping(review);
                    } else {
                      newReview[p] = review[mapping];
                    }
                  }
                }
                newReview.review = util.stripHtml(newReview.review, null, _this.baseUrl);
                return newReview;
              };
            })(this));
          } else {
            if (widget.type === 'List') {
              value = _.map(value, (function(_this) {
                return function(v) {
                  return util.stripHtml(v, null, _this.baseUrl);
                };
              })(this));
            }
            if (widgetDef.map) {
              if (dataType === 'array') {
                value = _.map(value, widgetDef.map);
              } else if (dataType === 'string') {
                if (_.isString(widgetDef.map)) {
                  value = value[widgetDef.map];
                } else {
                  value = widgetDef.map(value);
                }
              }
            }
          }
          widget.data.content = value;
        }
        widgets.push(widget);
      }
      return widgets;
    };

    return SiteProduct;

  })();
});

//# sourceMappingURL=SiteProduct.js.map
