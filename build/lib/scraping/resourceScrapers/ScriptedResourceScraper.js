// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['underscore', '../ResourceScraper', 'BlockRunner', '../DeclarativeScraper'], function(_, ResourceScraper, BlockRunner, DeclarativeScraper) {
  var ScriptedResourceScraper;
  return ScriptedResourceScraper = (function(_super) {
    __extends(ScriptedResourceScraper, _super);

    function ScriptedResourceScraper(script) {
      this.script = script;
      if (this === window) {
        return ResourceScraper(arguments);
      }
    }

    ScriptedResourceScraper.prototype.value = function(arg) {
      if (_.isUndefined(arg)) {
        return this.vCont.value;
      } else if (typeof arg === 'object' && !_.isArray(arg)) {
        if (typeof this.vCont.value !== 'object') {
          this.vCont.value = {};
        }
        return _.extend(this.vCont.value, arg);
      } else {
        return this.vCont.value = arg;
      }
    };

    ScriptedResourceScraper.prototype.scrape = function(cb) {
      var A, a;
      this.vCont = {};
      A = function() {};
      A.prototype = this;
      a = new A;
      _.extend(a, BlockRunner.prototype);
      BlockRunner.call(a, this.script);
      a.onDone((function(_this) {
        return function() {
          return cb(_this.vCont.value);
        };
      })(this));
      return a.exec();
    };

    ScriptedResourceScraper.prototype.get = function(url, cb, fail) {
      if (fail == null) {
        fail = null;
      }
      return this.propertyScraper.productScraper.background.httpRequest(url, {
        method: 'get',
        dataType: 'text',
        cb: (function(_this) {
          return function(responseText, response) {
            if (response.status === 200 || response.status === 'success') {
              return cb.call(_this, responseText);
            } else {
              if (fail) {
                return fail(response);
              } else {
                throw new Error("" + url + ": http status " + response.status);
              }
            }
          };
        })(this)
      });
    };

    ScriptedResourceScraper.prototype.post = function(url, data, cb) {
      return this.propertyScraper.productScraper.background.httpRequest(url, {
        method: 'post',
        dataType: 'text',
        data: data,
        cb: (function(_this) {
          return function(responseText, response) {
            if (response.status === 200 || response.status === 'success') {
              return cb.call(_this, responseText);
            } else {
              throw new Error("" + url + ": http status " + response.status);
            }
          };
        })(this)
      });
    };

    ScriptedResourceScraper.prototype.matchAll = function(string, pattern, group) {
      var match, matches, _i, _j, _len, _len1, _results, _results1;
      if (group == null) {
        group = false;
      }
      matches = string.match(new RegExp((_.isString(pattern) ? pattern : pattern.source), 'g'));
      if (matches) {
        if (group === false) {
          _results = [];
          for (_i = 0, _len = matches.length; _i < _len; _i++) {
            match = matches[_i];
            _results.push(match.match(pattern));
          }
          return _results;
        } else {
          _results1 = [];
          for (_j = 0, _len1 = matches.length; _j < _len1; _j++) {
            match = matches[_j];
            _results1.push(match.match(pattern)[group]);
          }
          return _results1;
        }
      } else {
        return [];
      }
    };

    ScriptedResourceScraper.prototype.getResource = function(resourceName, cb) {
      var resourceFetcher;
      resourceFetcher = this.propertyScraper.productScraper.resource(resourceName);
      return resourceFetcher.fetch((function(_this) {
        return function(resource) {
          return cb.call(_this, resource);
        };
      })(this));
    };

    ScriptedResourceScraper.prototype.declarativeScraper = function(name, property, subject) {
      var e, result, scraper, scrapers, _i, _len, _ref;
      if (property == null) {
        property = this.propertyScraper.propertyName;
      }
      if (subject == null) {
        subject = null;
      }
      scrapers = this.propertyScraper.productScraper.background.declarativeScrapers;
      for (_i = 0, _len = scrapers.length; _i < _len; _i++) {
        scraper = scrapers[_i];
        if (scraper.site === this.site.name && scraper.name === name) {
          if (scraper.properties[property]) {
            scraper = new DeclarativeScraper(scraper.properties[property]);
            try {
              result = (_ref = scraper.scrape(subject != null ? subject : this.resource)[0]) != null ? _ref.value : void 0;
              if (this.map) {
                return this.map(result);
              } else {
                return result;
              }
            } catch (_error) {
              e = _error;
              e.info = {
                path: scraper.getPath()
              };
              throw e;
            }
          } else {
            return null;
          }
        }
      }
      throw new Error("failed to find scraper for " + this.site.name + " " + this.name);
    };

    return ScriptedResourceScraper;

  })(ResourceScraper);
});

//# sourceMappingURL=ScriptedResourceScraper.map
