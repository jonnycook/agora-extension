// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/JsonResourceScraper', 'scraping/resourceScrapers/DeclarativeResourceScraper', 'util', 'underscore'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, JsonResourceScraper, DeclarativeResourceScraper, util, _) {
  var LandsEndProductScraper;
  return LandsEndProductScraper = (function(_super) {
    __extends(LandsEndProductScraper, _super);

    function LandsEndProductScraper() {
      return LandsEndProductScraper.__super__.constructor.apply(this, arguments);
    }

    LandsEndProductScraper.prototype.version = 1;

    LandsEndProductScraper.prototype.parseSid = function(sid) {
      var id, style, _ref;
      _ref = sid.split('-'), id = _ref[0], style = _ref[1];
      return {
        id: id,
        style: style
      };
    };

    LandsEndProductScraper.productSid = function(background, url, cb, retrievalId) {
      return background.httpRequest(url, {
        cb: function(response) {
          var id, _ref;
          id = (_ref = response.match(/<span id="mobileItemNumber_(\d*)">/)) != null ? _ref[1] : void 0;
          if (id) {
            return cb("" + id + "-" + retrievalId);
          } else {
            return cb();
          }
        }
      });
    };

    LandsEndProductScraper.prototype.resources = {
      productPage: {
        url: function() {
          return "http://www.landsend.com/pp/StylePage-" + this.productSid.style + "_AL.html";
        }
      },
      reviewData: {
        url: function() {
          return "http://landsend.ugc.bazaarvoice.com/2008-en_us/" + this.productSid.id + "/reviews.djs?format=embeddedhtml";
        }
      }
    };

    LandsEndProductScraper.prototype.properties = {
      title: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var regExp, style;
          regExp = new RegExp("Style(\\d*)\.number = " + this.productSid.style);
          style = regExp.exec(this.resource)[1];
          regExp = new RegExp("Style" + style + ".longName = \"([^\"]*)\";");
          return this.value(regExp.exec(this.resource)[1]);
        })
      },
      price: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var matches;
          matches = /<span class='pp-was-price'>\$[^<]*<\/span>\s*<span>\s*NOW \$([^<]*)/.exec(this.resource);
          if (matches) {
            return this.value(matches[1]);
          } else {
            matches = /<p id="productPrice_\d*" class="pp-summary-price" >\s*<span>\$([^<]*)<\/span>\s*- \$([^<]*?)\s*<\/p>/.exec(this.resource);
            if (matches) {
              return this.value("" + matches[1] + " - $" + matches[2]);
            } else {
              matches = /<p id="productPrice_\d*" class="pp-summary-price"\s*>\s*\$([\d.]*)/.exec(this.resource);
              if (matches) {
                return this.value(matches[1]);
              }
            }
          }
        })
      },
      image: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'image')
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var color, colorMatch, colorMatches, colors, i, id, image, imageId, imageMap, imageMatch, imageMatches, images, mainImages, more, name, order, properties, propertyMatch, propertyMatches, valueMatches, __, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _ref, _ref1;
          more = this.declarativeScraper('scraper', 'more');
          more.sizes = _.unique(this.matchAll(this.resource, /<a href="#" id="sizeId_\d*_\d*_([^"]*)/, 1));
          colorMatches = this.matchAll(this.resource, /<a id="colorId_\d*_\d*_([^"]*)"[^>]*>\s*<span>([^<]*)/);
          colors = {};
          for (_i = 0, _len = colorMatches.length; _i < _len; _i++) {
            colorMatch = colorMatches[_i];
            colors[colorMatch[1]] = colorMatch[2];
          }
          more.colors = (function() {
            var _results;
            _results = [];
            for (id in colors) {
              name = colors[id];
              _results.push({
                name: name,
                id: id
              });
            }
            return _results;
          })();
          propertyMatches = this.matchAll(this.resource, /id="featureWrapper_([\S\s]*?)End of pp-sel/, 1);
          properties = {};
          for (_j = 0, _len1 = propertyMatches.length; _j < _len1; _j++) {
            propertyMatch = propertyMatches[_j];
            name = propertyMatch.match(/<h3 class="pp-selector-label">\s*([^<]*)/)[1].trim();
            if (properties[name] == null) {
              properties[name] = [];
            }
            valueMatches = this.matchAll(propertyMatch, /<span class="pp-accessibility-text"><\/span>\s*([\S\s]*?)\s*<\/a>/, 1);
            properties[name] = _.unique(properties[name].concat(valueMatches));
          }
          mainImages = _.unique(this.matchAll(this.resource, /<img class="default" src="([^?]*)/, 1));
          order = [];
          for (i = _k = 0, _len2 = mainImages.length; _k < _len2; i = ++_k) {
            image = mainImages[i];
            order.push(image.match(/_([^_]*)_[^_]*$/)[1]);
          }
          order = _.unique(order);
          imageMatches = _.unique(this.matchAll(this.resource, /ProductImage\d*\.fileName = "(\d*_[^_]*_[^_]*_([^"]*))"/, 1));
          imageMap = {};
          for (_l = 0, _len3 = imageMatches.length; _l < _len3; _l++) {
            imageMatch = imageMatches[_l];
            _ref = imageMatch.match(/_([^_]*)_([^_]*)$/), __ = _ref[0], id = _ref[1], color = _ref[2];
            if (imageMap[color] == null) {
              imageMap[color] = {};
            }
            imageMap[color][id] = imageMatch;
          }
          images = {};
          _ref1 = more.colors;
          for (_m = 0, _len4 = _ref1.length; _m < _len4; _m++) {
            color = _ref1[_m];
            images[color.id] = (function() {
              var _len5, _n, _results;
              _results = [];
              for (_n = 0, _len5 = order.length; _n < _len5; _n++) {
                imageId = order[_n];
                _results.push("http://s7.landsend.com/is/image/LandsEnd/" + imageMap[color.id][imageId]);
              }
              return _results;
            })();
          }
          more.images = images;
          more.properties = properties;
          return this.value(more);
        })
      },
      rating: {
        resource: 'reviewData',
        scraper: PatternResourceScraper([
          [
            /Write the first review<\\\/a>/, 0, function() {
              return 0;
            }
          ], [/alt=\\"(.*?) \/ 5\\"/, 1]
        ])
      },
      ratingCount: {
        resource: 'reviewData',
        scraper: PatternResourceScraper([
          [
            /Write the first review<\\\/a>/, 0, function() {
              return 0;
            }
          ], [/<span class=\\"BVRRNumber\\">(\d+)/, 1]
        ])
      },
      reviews: {
        resource: 'reviewData',
        scraper: ScriptedResourceScraper(function() {
          var authorMatches, contentMatches, dateMatches, i, ratingsMatches, reviews, reviewsText, titleMatch, titleMatches, _ref;
          reviewsText = (_ref = this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/)) != null ? _ref[1] : void 0;
          if (reviewsText) {
            titleMatches = this.matchAll(reviewsText, /<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/, 1);
            contentMatches = this.matchAll(reviewsText, /<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/, 1);
            ratingsMatches = this.matchAll(reviewsText, /title=\\"(\d+) \/ 5\\"/, 1);
            authorMatches = this.matchAll(reviewsText, /<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/, 1);
            dateMatches = this.matchAll(reviewsText, /<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/, 1);
            reviews = (function() {
              var _i, _len, _results;
              _results = [];
              for (i = _i = 0, _len = titleMatches.length; _i < _len; i = ++_i) {
                titleMatch = titleMatches[i];
                _results.push({
                  title: titleMatch,
                  content: contentMatches[i],
                  rating: ratingsMatches[i],
                  author: authorMatches[i],
                  date: dateMatches[i]
                });
              }
              return _results;
            })();
            return this.value(reviews);
          } else {
            return this.value([]);
          }
        })
      }
    };

    return LandsEndProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=LandsEndProductScraper.map
