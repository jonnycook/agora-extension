// Generated by CoffeeScript 1.10.0
var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/JsonResourceScraper', 'underscore'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, JsonResourceScraper, _) {
  var KmartProductScraper;
  return KmartProductScraper = (function(superClass) {
    extend(KmartProductScraper, superClass);

    function KmartProductScraper() {
      return KmartProductScraper.__super__.constructor.apply(this, arguments);
    }

    KmartProductScraper.testProducts = [];

    KmartProductScraper.prototype.resources = {
      productPage: {
        url: function() {
          return "http://www.kmart.com/-/p-" + this.productSid;
        }
      },
      productData: {
        type: 'json',
        url: function() {
          return "http://www.kmart.com/content/pdp/config/products/v1/products/" + this.productSid + "?site=kmart";
        }
      },
      priceData: {
        type: 'json',
        url: function() {
          var number;
          number = this.productSid.value;
          if (number[number.length - 1] === 'P') {
            number = number.substr(0, number.length - 1);
          }
          return "http://www.kmart.com/content/pdp/products/pricing/" + number + "?variation=0&regionCode=0";
        }
      }
    };

    KmartProductScraper.prototype.properties = {
      title: {
        resource: 'productData',
        scraper: JsonResourceScraper(function(data) {
          return data.data.product.seo.title.match(/([^-]+)-/)[1].trim();
        })
      },
      price: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var number, price, priceUrl;
          price = '';
          number = this.productSid.value;
          console.debug('asdf');
          console.debug(number);
          if (number[number.length - 1] === 'P') {
            number = number.substr(0, number.length - 1);
          }
          priceUrl = "http://www.kmart.com/content/pdp/products/pricing/" + number + "?variation=0&regionCode=0";
          this.execBlock(function() {
            this.get(priceUrl, function(response) {
              var altPriceUrl, originalPrice;
              originalPrice = JSON.parse(response);
              if (originalPrice['price-response']['item-response']['sell-price']['$']) {
                if (originalPrice['price-response']['item-response']['sell-price']['$'] !== "0.00") {
                  price = originalPrice['price-response']['item-response']['sell-price']['$'];
                } else {
                  altPriceUrl = "http://www.kmart.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber=" + number + "P";
                  this.execBlock(function() {
                    this.get(altPriceUrl, function(response) {
                      originalPrice = response.match(/"prodDispPrice":"([^,]+|[^"]+)/);
                      if (originalPrice) {
                        price = originalPrice[1];
                      }
                      this.value(price);
                      return this.done(true);
                    });
                    return null;
                  });
                }
              }
              this.value(price);
              return this.done(true);
            });
            return null;
          });
          return this.value(price);
        })
      },
      image: {
        resource: 'productData',
        scraper: JsonResourceScraper(function(data) {
          if (data.data.product.assets.imgs[0].vals[0].src.indexOf('?') === -1) {
            return data.data.product.assets.imgs[0].vals[0].src + "?hei=623&wid=623&qlt=50,0&op_sharpen=1&op_usm=0.9,0.5,0,0";
          } else {
            return data.data.product.assets.imgs[0].vals[0].src;
          }
        })
      },
      rating: {
        resource: 'productData',
        scraper: ScriptedResourceScraper(function() {
          var ratUrl, rating;
          rating = '';
          ratUrl = "http://www.kmart.com/content/pdp/ratings/single/search/Kmart/" + this.productSid + "&targetType=product&limit=1&offset=0";
          this.execBlock(function() {
            this.get(ratUrl, function(response) {
              rating = JSON.parse(response);
              if (rating['data']['overall_rating']) {
                rating = rating['data']['overall_rating'];
              }
              this.value(rating);
              return this.done(true);
            });
            return null;
          });
          return this.value(rating);
        })
      },
      ratingCount: {
        resource: 'productData',
        scraper: ScriptedResourceScraper(function() {
          var ratUrl, ratingCount;
          ratingCount = '';
          ratUrl = "http://www.kmart.com/content/pdp/ratings/single/search/Kmart/" + this.productSid + "&targetType=product&limit=1&offset=0";
          this.execBlock(function() {
            this.get(ratUrl, function(response) {
              ratingCount = JSON.parse(response);
              if (ratingCount['data']['review_count']) {
                ratingCount = ratingCount['data']['review_count'];
              }
              this.value(ratingCount);
              return this.done(true);
            });
            return null;
          });
          return this.value(ratingCount);
        })
      },
      reviews: {
        resource: 'productData',
        scraper: ScriptedResourceScraper(function() {
          var ratUrl, revs;
          ratUrl = "http://www.kmart.com/content/pdp/ratings/single/search/Kmart/" + this.productSid + "&targetType=product&limit=10000&offset=0";
          revs = [];
          this.execBlock(function() {
            this.get(ratUrl, function(response) {
              var author, entry, i, j, len, len1, rat, ref, ref1, revHash, reviews;
              reviews = JSON.parse(response);
              if (reviews['data']['reviews']) {
                ref = reviews['data']['reviews'];
                for (i = 0, len = ref.length; i < len; i++) {
                  entry = ref[i];
                  revHash = {};
                  author = {};
                  author["name"] = entry['author']['screenName'];
                  author["url"] = "http://www.kmart.com/shc/s/PublicProfileView?requestType=public_profile&langId=-1&storeId=10153&key=" + entry['author']['extUserId'];
                  revHash["author"] = author;
                  revHash["kmartVerifiedPurchase"] = entry['author']['isBuyer'];
                  revHash["title"] = entry['summary'];
                  revHash["review"] = entry['content'];
                  if (entry['attribute_rating']) {
                    ref1 = entry['attribute_rating'];
                    for (j = 0, len1 = ref1.length; j < len1; j++) {
                      rat = ref1[j];
                      if (rat['attribute'] === "overall_rating" && rat['attribute_type'] === "numeric") {
                        revHash["rating"] = rat['value'];
                      }
                    }
                  }
                  revHash["time"] = entry['published_date'];
                  revs.push(revHash);
                }
              }
              this.value(revs);
              return this.done(true);
            });
            return null;
          });
          return this.value(revs);
        })
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var descUrl, description, imgUrl, number, priceUrl, ratUrl, revs, specs, switches, value;
          switches = {
            images: true,
            description: true,
            specifications: true,
            originalPrice: true,
            shipping: false
          };
          value = {};
          if (switches.images) {
            imgUrl = "http://www.kmart.com/content/pdp/config/products/v1/products/" + this.productSid + "?site=kmart";
            this.execBlock(function() {
              this.get(imgUrl, function(response) {
                var altPocket, color, colorName, entry, i, imageArr, images, j, k, l, len, len1, len2, len3, len4, len5, len6, m, n, o, pocket, ref, ref1, ref2, ref3, ref4, ref5, ref6, theColor, variant, variantName;
                images = JSON.parse(response);
                if (images['data']['product']['variants']) {
                  if (images['data']['product']['variants']['definingAttrs']) {
                    imageArr = [];
                    ref = images['data']['product']['variants']['definingAttrs'];
                    for (i = 0, len = ref.length; i < len; i++) {
                      pocket = ref[i];
                      if (pocket['name'] === 'Color') {
                        ref1 = pocket['vals'];
                        for (j = 0, len1 = ref1.length; j < len1; j++) {
                          color = ref1[j];
                          variant = {};
                          variantName = {};
                          colorName = color['name'];
                          variant['primaryImg'] = color['primaryImg']['attrs']['src'];
                          variant['swatchImg'] = color['swatchImg']['attrs']['src'];
                          ref2 = images['product']['variants']['sku'];
                          for (k = 0, len2 = ref2.length; k < len2; k++) {
                            altPocket = ref2[k];
                            theColor = altPocket['name'].match(/Color:([^,]*|$)/)[1];
                            if (theColor === colorName) {
                              if (altPocket['alternateImg']) {
                                ref3 = altPocket['alternateImg'];
                                for (l = 0, len3 = ref3.length; l < len3; l++) {
                                  entry = ref3[l];
                                  variant['altImg'] = entry['src'];
                                }
                              }
                            }
                          }
                          variantName[colorName] = variant;
                          imageArr.push(variantName);
                        }
                      }
                    }
                    value.images = imageArr;
                  }
                } else {
                  imageArr = [];
                  ref4 = images['data']['product']['assets']['imgs'];
                  for (m = 0, len4 = ref4.length; m < len4; m++) {
                    pocket = ref4[m];
                    if (pocket['type'] === 'P') {
                      ref5 = pocket['vals'];
                      for (n = 0, len5 = ref5.length; n < len5; n++) {
                        entry = ref5[n];
                        variant = {};
                        variantName = {};
                        variant['primaryImg'] = entry['src'];
                        variantName["Main"] = variant;
                        imageArr.push(variantName);
                      }
                    } else if (pocket['type'] === 'A') {
                      ref6 = pocket['vals'];
                      for (o = 0, len6 = ref6.length; o < len6; o++) {
                        entry = ref6[o];
                        variant = {};
                        variantName = {};
                        variant['primaryImg'] = entry['src'];
                        variantName["Other"] = variant;
                        imageArr.push(variantName);
                      }
                    }
                  }
                  value.images = imageArr;
                }
                this.done(true);
                return this.value(value);
              });
              return null;
            });
          }
          if (switches.reviews) {
            ratUrl = "http://www.kmart.com/content/pdp/ratings/single/search/Kmart/" + this.productSid + "&targetType=product&limit=10000&offset=0";
            revs = [];
            this.execBlock(function() {
              this.get(ratUrl, function(response) {
                var author, entry, i, j, len, len1, rat, ref, ref1, revHash, reviews;
                reviews = JSON.parse(response);
                if (reviews['data']['reviews']) {
                  ref = reviews['data']['reviews'];
                  for (i = 0, len = ref.length; i < len; i++) {
                    entry = ref[i];
                    revHash = {};
                    author = {};
                    author["name"] = entry['author']['screenName'];
                    author["url"] = "http://www.kmart.com/shc/s/PublicProfileView?requestType=public_profile&langId=-1&storeId=10153&key=" + entry['author']['extUserId'];
                    revHash["author"] = author;
                    revHash["kmartVerifiedPurchase"] = entry['author']['isBuyer'];
                    revHash["title"] = entry['summary'];
                    revHash["review"] = entry['content'];
                    if (entry['attribute_rating']) {
                      ref1 = entry['attribute_rating'];
                      for (j = 0, len1 = ref1.length; j < len1; j++) {
                        rat = ref1[j];
                        if (rat['attribute'] === "overall_rating" && rat['attribute_type'] === "numeric") {
                          revHash["rating"] = rat['value'];
                        }
                      }
                    }
                    revHash["time"] = entry['published_date'];
                    revs.push(revHash);
                  }
                  value.reviews = revs;
                }
                this.done(true);
                return this.value(value);
              });
              return null;
            });
          }
          if (switches.description) {
            descUrl = "http://www.kmart.com/content/pdp/config/products/v1/products/" + this.productSid + "?site=kmart";
            description = null;
            this.execBlock(function() {
              this.get(descUrl, function(response) {
                description = JSON.parse(response);
                if (description['data']['product']['desc'][0]['type'] === 'S') {
                  if (description['data']['product']['desc'][1]['type'] === 'L') {
                    value.description = description['data']['product']['desc'][0]['val'] + description['data']['product']['desc'][1]['val'];
                  } else {
                    value.description = description['data']['product']['desc'][0]['val'];
                  }
                } else if (description['data']['product']['seo']['desc']) {
                  value.description = description['data']['product']['seo']['desc'];
                }
                this.done(true);
                return this.value(value);
              });
              return null;
            });
          }
          if (switches.specifications) {
            descUrl = "http://www.kmart.com/content/pdp/config/products/v1/products/" + this.productSid + "?site=kmart";
            specs = {};
            this.execBlock(function() {
              this.get(descUrl, function(response) {
                var entry, i, j, len, len1, ref, ref1, specHash, specifications, thing;
                specifications = JSON.parse(response);
                if (specifications['data']['product']['specs']) {
                  ref = specifications['data']['product']['specs'];
                  for (i = 0, len = ref.length; i < len; i++) {
                    entry = ref[i];
                    specHash = {};
                    ref1 = entry['attrs'];
                    for (j = 0, len1 = ref1.length; j < len1; j++) {
                      thing = ref1[j];
                      specHash[thing['name']] = thing['val'];
                    }
                    specs[entry['grpName']] = specHash;
                  }
                  value.specifications = specs;
                }
                this.done(true);
                return this.value(value);
              });
              return null;
            });
          }
          if (switches.originalPrice) {
            number = this.productSid.value;
            if (number[number.length - 1] === 'P') {
              number = number.substr(0, number.length - 1);
            }
            priceUrl = "http://www.kmart.com/content/pdp/products/pricing/" + number + "?variation=0&regionCode=0";
            this.execBlock(function() {
              this.get(priceUrl, function(response) {
                var altPriceUrl, originalPrice;
                originalPrice = JSON.parse(response);
                if (originalPrice['price-response']['item-response']['regular-price']) {
                  if (originalPrice['price-response']['item-response']['regular-price'] !== "0.00") {
                    value.originalPrice = originalPrice['price-response']['item-response']['regular-price'];
                  } else {
                    altPriceUrl = "http://www.kmart.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber=" + number + "P";
                    this.execBlock(function() {
                      this.get(altPriceUrl, function(response) {
                        originalPrice = response.match(/"prodRegPrice":([^,]+|[^"]+)/);
                        if (originalPrice) {
                          value.originalPrice = originalPrice[1];
                        }
                        this.done(true);
                        return this.value(value);
                      });
                      return null;
                    });
                  }
                }
                this.done(true);
                return this.value(value);
              });
              return null;
            });
          }
          return this.value(value);
        })
      }
    };

    return KmartProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=KmartProductScraper.js.map
