// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/JsonResourceScraper', 'scraping/resourceScrapers/DeclarativeResourceScraper', 'underscore'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, JsonResourceScraper, DeclarativeResourceScraper, _) {
  var MakeMeChicProductScraper;
  return MakeMeChicProductScraper = (function(_super) {
    __extends(MakeMeChicProductScraper, _super);

    function MakeMeChicProductScraper() {
      return MakeMeChicProductScraper.__super__.constructor.apply(this, arguments);
    }

    MakeMeChicProductScraper.prototype.parseSid = function(sid) {
      return {
        name: sid
      };
    };

    MakeMeChicProductScraper.prototype.resources = {
      productPage: {
        url: function() {
          return "http://www.makemechic.com/" + this.productSid.name + ".html";
        }
      }
    };

    MakeMeChicProductScraper.prototype.properties = {
      title: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'title')
      },
      price: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'price')
      },
      image: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'image')
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var color, colorAbbreviation, colorId, imageUrl, images, match, more, obj, option, _fn, _i, _j, _len, _len1, _ref, _ref1, _ref2;
          more = this.declarativeScraper('scraper', 'more');
          imageUrl = /<meta property="og:image" content="([^"]*)/.exec(this.resource)[1];
          colorAbbreviation = imageUrl.match(/\/\w+-([a-z]+)[^\/]*\.jpg$/)[1];
          colorId = (_ref = this.resource.match(new RegExp("<li class=\"color-swatch-85-(\\d*)\\s*\">\\s*<span[^>]*>[^<]*</span>\\s*<img class=\"image-base\" src=\"[^\"]*\/\\w+-" + colorAbbreviation + ".\\w+\""))) != null ? _ref[1] : void 0;
          if (colorId) {
            _ref1 = more.colors;
            for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
              color = _ref1[_i];
              if (color.id === colorId) {
                more.color = color.name;
                break;
              }
            }
          }
          match = /var spConfig = new Product.Config\((.*?)\);/.exec(this.resource)[1];
          obj = JSON.parse(match);
          images = {};
          more.images = images;
          _ref2 = obj.attributes[85].options;
          _fn = (function(_this) {
            return function(option) {
              return _this.execBlock(function() {
                this.post("http://www.makemechic.com/cloudzoom/ajax/images/", _.map(option.products, function(i) {
                  return "products[]=" + i;
                }).join('&'), function(response) {
                  var imgs;
                  imgs = JSON.parse(response);
                  images[option.label] = _.map(imgs, function(img) {
                    return {
                      small: img.small,
                      big: img.big
                    };
                  });
                  this.value(more);
                  return this.done(true);
                });
                return null;
              });
            };
          })(this);
          for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
            option = _ref2[_j];
            _fn(option);
          }
          return this.value(more);
        })
      }
    };

    return MakeMeChicProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=MakeMeChicProductScraper.map
