// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/JsonResourceScraper', 'scraping/resourceScrapers/DeclarativeResourceScraper', 'underscore'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, JsonResourceScraper, DeclarativeResourceScraper, _) {
  var FreePeopleProductScraper;
  return FreePeopleProductScraper = (function(_super) {
    __extends(FreePeopleProductScraper, _super);

    function FreePeopleProductScraper() {
      return FreePeopleProductScraper.__super__.constructor.apply(this, arguments);
    }

    FreePeopleProductScraper.prototype.parseSid = function(sid) {
      var color, id, name, _ref;
      _ref = sid.split(':'), id = _ref[0], name = _ref[1], color = _ref[2];
      return {
        id: id,
        name: name,
        color: color
      };
    };

    FreePeopleProductScraper.productSid = function(background, url, cb) {
      return background.httpRequest(url, {
        cb: function(response) {
          var id, name;
          name = /<link rel="canonical" href="http:\/\/www\.freepeople\.com\/([^\/]*)\/"\/>/.exec(response)[1];
          id = response.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1];
          return cb("" + id + ":" + name);
        }
      });
    };

    FreePeopleProductScraper.prototype.resources = {
      productPage: {
        url: function() {
          var url;
          url = "http://www.freepeople.com/" + this.productSid.name;
          if (this.productSid.color) {
            url += "/_/productOptionIDs/" + this.productSid.color;
          }
          return url;
        }
      },
      reviewData: {
        url: function() {
          return "http://freepeople.ugc.bazaarvoice.com/3393/" + this.productSid.id + "/reviews.djs?format=embeddedhtml";
        }
      }
    };

    FreePeopleProductScraper.prototype.properties = {
      title: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'title')
      },
      price: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'price')
      },
      image: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'image')
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var colorId, i, imageData, imageMap, imageMatches, images, img, imgs, match, matches, more, _base, _i, _len, _name, _name1, _ref;
          more = this.declarativeScraper('scraper', 'more');
          matches = /var productImages = \$\.namespace\('WEBLINC.productImages'\);([\S\s]*?)<\/script>/.exec(this.resource)[1];
          imageMatches = this.matchAll(matches, /productImages\['[^']*'\]\["([^"]*)"\]\["([^"]*)"]\["(aliasName|altSize|zoomSize|detailSize)"\] = "([^"]*)";/);
          imageMap = {};
          for (_i = 0, _len = imageMatches.length; _i < _len; _i++) {
            match = imageMatches[_i];
            if (imageMap[_name = match[1]] == null) {
              imageMap[_name] = {};
            }
            if ((_base = imageMap[match[1]])[_name1 = match[2]] == null) {
              _base[_name1] = {};
            }
            imageMap[match[1]][match[2]][match[3]] = match[4];
          }
          images = {};
          for (colorId in imageMap) {
            imageData = imageMap[colorId];
            imgs = [];
            for (i in imageData) {
              img = imageData[i];
              imgs.push({
                altSize: img.altSize,
                detailSize: img.detailSize,
                zoomSize: img.zoomSize
              });
            }
            images[((_ref = imageData['0']) != null ? _ref : imageData['a']).aliasName] = imgs;
          }
          more.images = images;
          more.currentColor = /<dd class="alias" itemprop="color" data-integration="productDetail-colorAlias">([^<]*)/.exec(this.resource)[1];
          return this.value(more);
        })
      },
      rating: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var id;
          id = this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1];
          return this.execBlock(function() {
            this.get("http://freepeople.ugc.bazaarvoice.com/3393/" + id + "/reviews.djs?format=embeddedhtml", (function(_this) {
              return function(response) {
                var _ref, _ref1;
                _this.value((_ref = (_ref1 = response.match(/title=\\"([\d.]*) out of 5\\"/)) != null ? _ref1[1] : void 0) != null ? _ref : 0);
                return _this.done(true);
              };
            })(this));
            return null;
          });
        })
      },
      ratingCount: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var id;
          id = this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1];
          return this.execBlock(function() {
            this.get("http://freepeople.ugc.bazaarvoice.com/3393/" + id + "/reviews.djs?format=embeddedhtml", (function(_this) {
              return function(response) {
                var _ref, _ref1;
                _this.value((_ref = (_ref1 = response.match(/<span class=\\"BVRRNumber\\">(\d*)<\\\/span> product reviews/)) != null ? _ref1[1] : void 0) != null ? _ref : 0);
                return _this.done(true);
              };
            })(this));
            return null;
          });
        })
      },
      reviews: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var id;
          id = this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1];
          return this.execBlock(function() {
            this.get("http://freepeople.ugc.bazaarvoice.com/3393/" + id + "/reviews.djs?format=embeddedhtml", (function(_this) {
              return function(response) {
                var authorMatches, contentMatches, dateMatches, i, ratingsMatches, reviews, reviewsText, titleMatch, titleMatches, _ref;
                reviewsText = (_ref = response.match(/BVRRDisplayContentBodyID([\S\s]*)/)) != null ? _ref[1] : void 0;
                if (reviewsText) {
                  titleMatches = _this.matchAll(reviewsText, /<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/, 1);
                  contentMatches = _this.matchAll(reviewsText, /<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/, 1);
                  ratingsMatches = _this.matchAll(reviewsText, /title=\\"(\d+) out of 5\\"/, 1);
                  authorMatches = _this.matchAll(reviewsText, /<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/, 1);
                  dateMatches = _this.matchAll(reviewsText, /<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/, 1);
                  reviews = (function() {
                    var _i, _len, _results;
                    _results = [];
                    for (i = _i = 0, _len = titleMatches.length; _i < _len; i = ++_i) {
                      titleMatch = titleMatches[i];
                      _results.push({
                        title: titleMatch,
                        content: contentMatches[i],
                        rating: ratingsMatches[i],
                        author: authorMatches[i],
                        date: dateMatches[i]
                      });
                    }
                    return _results;
                  })();
                  _this.value(reviews);
                } else {
                  _this.values([]);
                }
                return _this.done(true);
              };
            })(this));
            return null;
          });
        })
      }
    };

    return FreePeopleProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=FreePeopleProductScraper.map
