// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/DeclarativeResourceScraper', 'underscore', 'ext/AmazonProductScraper'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, DeclarativeResourceScraper, _, AmazonProductScraperExt) {
  var AmazonProductScraper;
  return AmazonProductScraper = (function(_super) {
    __extends(AmazonProductScraper, _super);

    function AmazonProductScraper() {
      return AmazonProductScraper.__super__.constructor.apply(this, arguments);
    }

    AmazonProductScraper.productSid = function(url, cb) {};

    AmazonProductScraper.testProducts = ['B00C66C950', 'B00EIRFYS4', 'B00GK9HH4C'];

    AmazonProductScraper.testing = {
      skipTest: ['more.reviews']
    };

    AmazonProductScraper.prototype.version = 5;

    AmazonProductScraper.prototype.resources = {
      offerListing: {
        url: function() {
          return "http://www.amazon.com/gp/offer-listing/" + this.productSid + "/ref=olp_sort_p?ie=UTF8&shipPromoFilter=0&sort=price&me=&seller=&condition=new";
        }
      },
      offerListingPricePlusShipping: {
        url: function() {
          return "http://www.amazon.com/gp/offer-listing/" + this.productSid + "/ref=olp_sort_p?ie=UTF8&shipPromoFilter=0&sort=sip&me=&seller=&condition=new";
        }
      },
      productPage: {
        url: function() {
          return "http://www.amazon.com/gp/product/" + this.productSid + "/?psc=1";
        }
      }
    };

    AmazonProductScraper.prototype.properties = {
      rating: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'rating')
      },
      ratingCount: {
        resource: 'productPage',
        scraper: DeclarativeResourceScraper('scraper', 'ratingCount')
      },
      title: {
        resource: 'offerListing',
        scraper: ScriptedResourceScraper(function() {
          return this["try"]({
            1: function() {
              var matches;
              console.log(this.resource);
              matches = this.resource.match(/<span id="btAsinTitle">([^<]*)<\/span>/);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            2: function() {
              var matches;
              matches = this.resource.match(/<h1 class="producttitle\s*">\s*([\s\S]*?)\s*?<\/h1>/);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            3: function() {
              var matches;
              matches = this.resource.match(/<h1 class='a-spacing-none'>\s*([^<]*?)<\h1/);
              if (matches) {
                this.value(matches[1].trim().replace(/\s+/g, ' '));
                return true;
              } else {
                return false;
              }
            },
            4: function() {
              var matches;
              matches = this.resource.match(/New offers for\s*<\/span>\s*<\/div>\s*(.*?)<\/h1>/);
              if (matches) {
                this.value(matches[1].trim().replace(/\s+/g, ' '));
                return true;
              } else {
                return false;
              }
            }
          });
        })
      },
      price: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          return this["try"]({
            buyNewPrice: function() {
              var matches;
              matches = this.resource.match(/<span class="bb_price">\s*\$([^<])\s*</);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            priceLarge: function() {
              var matches;
              matches = this.resource.match(/class="priceLarge">\$([^<]*)</);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            wirelessPriceFromPrice: function() {
              var matches;
              matches = this.resource.match(/id="wirelessPriceFromPrice"[^>]*>\$([^<]*)</);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            1: function() {
              var matches;
              matches = this.resource.match('<span class="a-color-price a-size-large">\\$([^<]*)</span>');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            2: function() {
              var matches;
              matches = this.resource.match('<span id="priceblock_ourprice" class="a-size-medium a-color-price">\\$([^<]*)</span>');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            3: function() {
              var matches;
              matches = this.resource.match('<span class="a-size-medium a-color-price offer-price a-text-normal">\\$([^<]*)</span>');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            4: function() {
              var matches;
              matches = this.resource.match('<span id="current-price" style="display: inline">&#36;([^<]*)</span>');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            5: function() {
              var matches;
              matches = this.resource.match(/<span id="priceblock_saleprice" class="a-size-medium a-color-price">\$([^<]*)<\/span>/);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            6: function() {
              var matches;
              matches = this.resource.safeMatch(/<span id="actualPriceValue"><b class="priceLarge">\$([^<]*)<\/b>/);
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            }
          });
        })
      },
      image: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          return this["try"]({
            1: function() {
              var image, matches;
              matches = this.resource.match(/thumb_0_inner[\S\s]*?(http:\/\/ecx.images-amazon.com\/.*?\.jpg)/);
              if (matches) {
                image = matches[1];
                image = image.substr(0, image.length - 5) + '0_.jpg';
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            2: function() {
              var matches;
              matches = this.resource.match('<img.*?(http[^"]+)" id="prodImage"');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            3: function() {
              var matches;
              matches = this.resource.match('id="main-image" src="http([^"]*)"');
              if (matches) {
                this.value('http' + matches[1]);
                return true;
              } else {
                return false;
              }
            },
            4: function() {
              var matches;
              matches = this.resource.match('src="([^"]+)"\\s*id="original-main-image"');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            5: function() {
              var matches;
              matches = this.resource.match('var imageHashMain = \\["([^"]*)"');
              if (matches) {
                this.value(matches[1]);
                return true;
              } else {
                return false;
              }
            },
            6: function() {
              var image, matches;
              matches = this.resource.match('src="([^"]+)" id="prodImage"');
              if (matches) {
                image = matches[1];
                image = image.replace(/\d+(_\.\w+)^/, '300$1');
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            7: function() {
              var image, matches;
              matches = this.resource.match('class="imgTagWrapper">\\s*<img src=\'([^\']*)');
              if (matches) {
                image = matches[1];
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            8: function() {
              var image, matches;
              matches = this.resource.match('<img alt="" src="[^"]*" data-old-hires="([^"]+)"');
              if (matches) {
                image = matches[1].replace(/^(http:\/\/ecx\.images-amazon\.com\/images\/.\/[^.]*\._)[^_]*(_\.jpg)$/, '$1UX500$2');
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            9: function() {
              var image, matches;
              matches = this.resource.match(/data-a-dynamic-image="\{&quot;([^&]*)/);
              if (matches) {
                image = matches[1];
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            10: function() {
              var image, matches;
              matches = this.resource.match('<img id="imgBlkFront" src="(http://ecx\.images-amazon\.com/images/I/[^.]*)');
              if (matches) {
                image = matches[1] + '.jpg';
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            11: function() {
              var image, matches;
              matches = this.resource.match(/<div id="imgTagWrapperId" class="imgTagWrapper">\s*<img alt="" src="([^"]*)/);
              if (matches) {
                image = matches[1] + '.jpg';
                this.value(image);
                return true;
              } else {
                return false;
              }
            },
            12: function() {
              var image, matches;
              matches = this.resource.match(/<td id="fbt_x_img">\s*<img src="(http:\/\/ecx\.images-amazon\.com\/images\/I\/[^.]*)/);
              if (matches) {
                image = matches[1] + '.jpg';
                this.value(image);
                return true;
              } else {
                return false;
              }
            }
          });
        })
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var detailMatches, features, match, matches, more, selectedVarations, switches, variationsMatch, _i, _j, _len, _len1, _ref, _ref1, _ref2, _ref3;
          switches = {
            images: true,
            features: true,
            details: true,
            description: true,
            category: true
          };
          more = {};
          if (switches.images) {
            matches = this.resource.match(/data\["colorImages"\] = ([^;]*);/);
            if (matches) {
              if (matches[1] === '{}') {
                matches = this.resource.match(/var data = \{\s*'colorImages': \{ 'initial': ([\S\s]*?)\},\s*'colorToAsin':/);
                more.images = {
                  initial: JSON.parse(matches[1])
                };
                more.currentStyle = 'initial';
              } else {
                more.images = JSON.parse(matches[1]);
                more.currentStyle = this.resource.safeMatch('data\\["landingAsinColor"\\] = \'([^\']*)\'')[1];
              }
            } else {
              matches = this.resource.match(/var def = colorImages \? colorImages\[data\.defaultColor\] : \[\];\s*colorImages = ([^;]*);/);
              if (matches) {
                more.images = JSON.parse(matches[1]);
                more.currentStyle = (_ref = this.resource.match(/selected_variations\["color_name"\]='([^']*)';/)) != null ? _ref[1] : void 0;
              }
            }
            if (!more.currentStyle) {
              variationsMatch = (_ref1 = this.resource.match(/<table class="variations"([\S\s]*?)<\/table>/)) != null ? _ref1[1] : void 0;
              if (variationsMatch) {
                selectedVarations = this.matchAll(variationsMatch, /<div id=\S* class="variationSelected">\s*<b class="variationDefault">[^<]*<\/b>\s*<b class="variationLabel">([^<]*)<\/b>/, 1);
                more.currentStyle = selectedVarations.join(' ');
              }
            }
          }
          if (switches.features) {
            matches = (_ref2 = this.resource.match(/<div id="feature-bullets"[^>]*>([\S\s]*?)<\/div>\s*<\/div>/)) != null ? _ref2[1] : void 0;
            if (matches) {
              matches = this.matchAll(matches, /<li><span[^>]*>([\S\s]*?)<\/span>/);
              features = [];
              for (_i = 0, _len = matches.length; _i < _len; _i++) {
                match = matches[_i];
                features.push(match[1]);
              }
              more.features = features;
            }
          }
          if (switches.details) {
            matches = this.resource.match(/<div id="detailBullets_feature_div">([\S\s]*?)<\/ul>/);
            if (matches) {
              matches = this.matchAll(matches[1], /<li><span class="a-list-item">([\S\s]*?)<\/span><\/li>/);
              more.details = {};
              for (_j = 0, _len1 = matches.length; _j < _len1; _j++) {
                match = matches[_j];
                detailMatches = match[1].safeMatch(/<span class="a-text-bold">([^:]*):\s*<\/span>\s*<span>([\S\s]*?)<\/span>/);
                more.details[detailMatches[1]] = detailMatches[2];
              }
            }
          }
          if (switches.description) {
            more.description = (_ref3 = this.resource.match(/<div id="productDescription" class="a-section a-spacing-small">\s*([\S\s]*?)\s*<\/div>/)) != null ? _ref3[1] : void 0;
          }
          if (switches.category) {
            matches = this.resource.match(/<h2 class="a-spacing-mini">Look for Similar Items by Category<\/h2>\s*<p>([\S\s]*?)<\/p>/);
            if (matches) {
              matches = this.matchAll(matches[1], /<a class="a-link-normal" href="[^"]*">([^<]*)<\/a>/);
              more.category = _.map(matches, function(o) {
                return o[1];
              });
            }
          }
          AmazonProductScraperExt.more.call(this, switches, more);
          return this.value(more);
        })
      },
      reviews: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var amazonVerifiedPurchase, authorName, authorUrl, badgeMatch, badgeMatches, badges, commentsCount, commentsUrl, count, helpfulCount, helpfulTotal, matches, rating, review, reviewMatch, reviewMatches, reviews, reviewsUrl, time, title, url, __, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref10, _ref11, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9;
          reviews = [];
          reviewsUrl = null;
          count = 0;
          matches = this.resource.match(/<div id='revMHRL' class='mb30'>([\S\s]*?)<div id="revF" style="margin: 0 0 30px 25px;">/);
          if (matches) {
            reviewMatches = this.matchAll(matches[1], /<div id="rev-[^-]*-[^>]*>([\S\s]*?)<\/div>  <\/div><\/div>/);
            for (_i = 0, _len = reviewMatches.length; _i < _len; _i++) {
              _ref = reviewMatches[_i], __ = _ref[0], reviewMatch = _ref[1];
              rating = parseInt(reviewMatch.match(/<span>(.*?) out of 5 stars<\/span>/)[1]);
              time = reviewMatch.match(/<span class="inlineblock txtsmall">([^<]*)/)[1];
              _ref1 = reviewMatch.match(/<a href="([^"]*)" class="txtlarge gl3 gr4 reviewTitle valignMiddle"><strong>([^<]*)/), __ = _ref1[0], url = _ref1[1], title = _ref1[2];
              review = reviewMatch.match(/<div class="drkgry">\s*([\S\s]*?)<\/div>/)[1].trim();
              review = review.replace('display:none', '');
              _ref2 = reviewMatch.match(/<a href="([^"]*?)" class="noTextDecoration">(?:(\d+) )?Comments?<\/a>/), __ = _ref2[0], commentsUrl = _ref2[1], commentsCount = _ref2[2];
              _ref4 = (_ref3 = reviewMatch.match(/<div class="gry txtsmall hlp">(\d+) of (\d+) people found the following review helpful<\/div>/)) != null ? _ref3 : [], __ = _ref4[0], helpfulCount = _ref4[1], helpfulTotal = _ref4[2];
              amazonVerifiedPurchase = reviewMatch.match(/<span class="orange strong avp">Amazon Verified Purchase<\/span>/) ? true : false;
              _ref5 = reviewMatch.match(/<span class="gry">By<\/span>\s*<a href="([^"]*)" class="noTextDecoration">([^<]*)/), __ = _ref5[0], authorUrl = _ref5[1], authorName = _ref5[2];
              badgeMatches = this.matchAll(reviewMatch, /<span class='c7yBadge[^']*'>([^<]*)<\/span>/);
              badges = [];
              for (_j = 0, _len1 = badgeMatches.length; _j < _len1; _j++) {
                badgeMatch = badgeMatches[_j];
                badges.push(badgeMatch[1]);
              }
              reviews.push({
                rating: rating,
                url: url,
                title: title,
                time: time,
                review: review,
                author: {
                  url: "http://www.amazon.com" + authorUrl,
                  name: authorName,
                  badges: badges
                },
                helpfulCount: helpfulCount,
                helpfulTotal: helpfulTotal,
                amazonVerifiedPurchase: amazonVerifiedPurchase,
                comments: {
                  url: commentsUrl,
                  count: commentsCount != null ? commentsCount : 0
                }
              });
            }
            _ref6 = this.resource.match(/<a id="seeAllReviewsUrl" href="([^"]*)" class="txtlarge noTextDecoration">\s*<strong>\s*See all ([\d,]+) customer reviews \(newest first\)/), __ = _ref6[0], reviewsUrl = _ref6[1], count = _ref6[2];
          } else {
            matches = this.resource.match(/<div id="revMHRL" class="a-section">([\S\s]*?)<div id="revF" class="a-section">/);
            if (matches) {
              reviewMatches = this.matchAll(matches[1], /<div id="rev-[^-]*-[^>]*>([\S\s]*?)Was this review helpful to you?/);
              for (_k = 0, _len2 = reviewMatches.length; _k < _len2; _k++) {
                _ref7 = reviewMatches[_k], __ = _ref7[0], reviewMatch = _ref7[1];
                rating = parseInt(reviewMatch.match(/title="(.*?) out of 5 stars"/)[1]);
                matches = reviewMatch.match(/<span class="a-color-secondary"> on ([^<]*)/);
                time = matches ? matches[1] : reviewMatch.match(/<\/span>\s*on\s*([^<]*)<\/span>/)[1];
                _ref8 = reviewMatch.match(/<a class="a-link-normal a-text-normal a-color-base" href="([^"]*)"><span class="a-size-base a-text-bold">([^<]*)/), __ = _ref8[0], url = _ref8[1], title = _ref8[2];
                review = reviewMatch.match(/<div class="a-section">([\S\s]*?)<\/div>/)[1].trim();
                _ref9 = reviewMatch.match(/<a class="a-link-normal comment-link" title="(\d*)" href="([^"]*)">/), __ = _ref9[0], commentsCount = _ref9[1], commentsUrl = _ref9[2];
                _ref11 = (_ref10 = reviewMatch.match(/<span class="a-size-small a-color-secondary">(\d*) of (\d*) people found the following review helpful<\/span>/)) != null ? _ref10 : [], __ = _ref11[0], helpfulCount = _ref11[1], helpfulTotal = _ref11[2];
                amazonVerifiedPurchase = reviewMatch.match(/<span class="a-size-mini a-color-state a-text-bold">\s*Amazon Verified Purchase\s*<\/span>/) ? true : false;
                authorUrl = authorName = null;
                matches = reviewMatch.match(/<span class="a-color-secondary">\s*By\s*<\/span>\s*<a href="([^"]*)" class="noTextDecoration">([^<]*)<\/a>/);
                if (matches) {
                  __ = matches[0], authorUrl = matches[1], authorName = matches[2];
                } else {
                  authorName = 'A Customer';
                }
                reviews.push({
                  rating: rating,
                  url: url,
                  title: title,
                  time: time,
                  review: review,
                  author: {
                    url: authorUrl ? "http://www.amazon.com" + authorUrl : void 0,
                    name: authorName
                  },
                  helpfulCount: helpfulCount,
                  helpfulTotal: helpfulTotal,
                  amazonVerifiedPurchase: amazonVerifiedPurchase,
                  comments: {
                    url: commentsUrl,
                    count: commentsCount != null ? commentsCount : 0
                  }
                });
              }
              matches = this.resource.match(/<a href="([^"]*)">([\d,]*) customer reviews<\/a>/);
              if (matches) {
                reviewsUrl = matches[1];
                count = matches[2];
              } else {
                matches = this.resource.match(/<a class="a-link-emphasis a-text-bold" href="([^"]*)">\s*See all ([\d,]*) customer reviews \(newest first\)\s*<\/a>/);
                if (matches) {
                  reviewsUrl = matches[1];
                  count = matches[2];
                } else {
                  matches = this.resource.match(/<a class="a-link-emphasis a-nowrap" href="([^"]*)">See the customer review<\/a>/);
                  if (matches) {
                    count = 1;
                    reviewsUrl = matches[1];
                  } else {
                    matches = this.resource.match(/<a class="a-link-emphasis a-nowrap" href="([^"]*)">See both customer reviews \(newest first\)<\/a>/);
                    if (matches) {
                      count = 2;
                      reviewsUrl = matches[1];
                    }
                  }
                }
              }
            }
          }
          return this.value({
            reviews: reviews,
            url: reviewsUrl,
            count: count
          });
        })
      }
    };

    return AmazonProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=AmazonProductScraper.map
