// Generated by CoffeeScript 1.10.0
var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

define(['scraping/ProductScraper', 'scraping/resourceScrapers/PatternResourceScraper', 'scraping/resourceScrapers/ScriptedResourceScraper', 'scraping/resourceScrapers/JsonResourceScraper', 'underscore'], function(ProductScraper, PatternResourceScraper, ScriptedResourceScraper, JsonResourceScraper, _) {
  var ToysRUsProductScraper;
  return ToysRUsProductScraper = (function(superClass) {
    extend(ToysRUsProductScraper, superClass);

    function ToysRUsProductScraper() {
      return ToysRUsProductScraper.__super__.constructor.apply(this, arguments);
    }

    ToysRUsProductScraper.testProducts = ['13018810'];

    ToysRUsProductScraper.prototype.resources = {
      productPage: {
        url: function() {
          return "http://www.toysrus.com/product/index.jsp?productId=" + this.productSid;
        }
      }
    };

    ToysRUsProductScraper.prototype.properties = {
      title: {
        resource: 'productPage',
        scraper: PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/), 1)
      },
      price: {
        resource: 'productPage',
        scraper: PatternResourceScraper([[new RegExp(/<meta property="eb:saleprice" content="([^"]*)/), 1], [new RegExp(/<meta property="eb:price" content="([^"]*)/), 1]])
      },
      image: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var link;
          link = /<input name=enh_0 type=hidden value="([^"]*)/.exec(this.resource)[1];
          return this.value("http://www.toysrus.com" + link);
        })
      },
      more: {
        resource: 'productPage',
        scraper: ScriptedResourceScraper(function() {
          var altImageCheck, altImageUrl, description, i, image, imageMatches, images, len, mainDesc, match, matches, switches, url, value;
          switches = {
            images: true,
            description: true,
            rating: true,
            ratingCount: true,
            originalPrice: true,
            shipping: false
          };
          value = {};
          if (switches.description) {
            description = [];
            mainDesc = this.resource.match(/<h3>Product Description<\/h3>([\S\s]*?)<div/);
            if (mainDesc) {
              description.push("<div>" + mainDesc[1]);
            }
            value.description = description;
          }
          if (switches.rating) {
            matches = this.resource.match(/var POWERREVIEWS=([\S\s]*?)<\/script>/);
            if (matches) {
              matches = matches[1].match(/,s:([^,]*)/);
              value.rating = matches[1];
            }
          }
          if (switches.reviewCount) {
            matches = this.resource.match(/var POWERREVIEWS=([\S\s]*?)<\/script>/);
            if (matches) {
              matches = matches[1].match(/,rc:([^,]*)/);
              value.reviewCount = matches[1];
            }
          }
          if (switches.originalPrice) {
            matches = this.resource.match(/<meta property="eb:price" content="([^"]*)/);
            if (matches) {
              value.originalPrice = matches[1];
            }
          }
          if (switches.images) {
            images = [];
            matches = this.resource.match(/<div class="altImages([\S\s]*?)<div id="leftSide">/);
            if (matches) {
              imageMatches = matches[1].match(/href="javascript:swapImage\('([^']*)/g);
              if (imageMatches) {
                for (i = 0, len = imageMatches.length; i < len; i++) {
                  match = imageMatches[i];
                  image = match.match(/href="javascript:swapImage\('([^']*)/);
                  images.push("http://www.toysrus.com" + image[1]);
                }
              }
            }
            altImageCheck = this.resource.match(/(http:\/\/content.webcollage.net\/toysrus\/smart-button)/);
            if (altImageCheck) {
              altImageUrl = "http://content.webcollage.net/toysrus/smart-button?ird=true&channel-product-id=" + this.productSid;
              this.execBlock(function() {
                this.get(altImageUrl, function(response) {
                  var j, len1;
                  matches = response.match(/<div class=\\"wc-gallery-thumb\\"([\S\s]*?)<\\\/div>/g);
                  if (matches) {
                    for (j = 0, len1 = matches.length; j < len1; j++) {
                      match = matches[j];
                      image = match.match(/wcobj=\\"([\S\s]*?)\\"/)[1];
                      images.push(image.replace(/\\"+/gm, '"').replace(/\\\/+/gm, '/'));
                    }
                  }
                  this.done(true);
                  return this.value(value);
                });
                return null;
              });
            }
            if (images.length <= 0) {
              url = "http://www.toysrus.com" + this.resource.match(/<input name=enh_0 type=hidden value="([^"]*)/)[1];
              if (url.match(/([\S\s]*?)enh-z6\.jpg/)) {
                images.push(url.match(/([\S\s]*?)enh-z6\.jpg/)[1] + "dt.jpg");
              } else {
                images.push(url.match(/([\S\s]*?)dt\.jpg/)[1] + "dt.jpg");
              }
            }
            value.images = images;
          }
          return this.value(value);
        })
      }
    };

    return ToysRUsProductScraper;

  })(ProductScraper);
});

//# sourceMappingURL=ToysRUsProductScraper.js.map
