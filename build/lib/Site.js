// Generated by CoffeeScript 1.7.1
var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

define(['underscore', 'siteConfig'], function(_, siteConfig) {
  var Site;
  return Site = (function() {
    Site.productClasses = {};

    Site.sites = {};

    Site.siteForUrl = function(url) {
      var config, name, part, _i, _len, _ref, _ref1;
      url = (_ref = url.match('^https?://(.*)$')) != null ? _ref[1] : void 0;
      if (url) {
        for (name in siteConfig) {
          config = siteConfig[name];
          if (config.hosts) {
            _ref1 = config.hosts;
            for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
              part = _ref1[_i];
              if (url.substr(0, part.length) === part) {
                return this.site(name, part);
              }
            }
          }
        }
      }
      return null;
    };

    Site.site = function(name, host) {
      var config, matches;
      if (matches = name.match(/^General\/(.*)$/)) {
        return new Site('General', siteConfig.General, matches[1]);
      } else {
        if (this.sites["" + name + ";" + host]) {
          return this.sites["" + name + ";" + host];
        } else {
          config = siteConfig[name];
          if (config) {
            return this.sites["" + name + ";" + host] = new Site(name, config, host);
          } else {
            throw new Error("No site '" + name + "'");
          }
        }
      }
    };

    Site.productSid = function(background, url, cb) {
      var site;
      site = this.siteForUrl(url);
      return site.productSid(background, url, cb);
    };

    Site.siteById = function(id) {
      var host, name, site, _ref;
      site = this.site(id);
      if (!site) {
        _ref = id.split('/'), name = _ref[0], host = _ref[1];
        site = this.site(name, host);
      }
      return site;
    };

    Site.id = 0;

    function Site(name, config, host) {
      var allFeatures;
      this.name = name;
      this.config = config;
      this.host = host;
      this.nid = Site.id++;
      this.hosts = config.hosts, this.icon = config.icon;
      this.url = "http://agora.sh/site.php?name=" + this.name;
      allFeatures = ['offers', 'reviews', 'rating', 'priceWatch'];
      this.features = config.excludedFeatures ? _.difference(allFeatures, config.excludedFeatures) : allFeatures;
      this._productScraper = {};
    }

    Site.prototype.hasFeature = function(feature) {
      return __indexOf.call(this.features, feature) >= 0;
    };

    Site.prototype.id = function() {
      if (this.name === 'General') {
        return "" + this.name + "/" + this.host;
      } else {
        return this.name;
      }
    };

    Site.prototype.getSiteInjector = function(background, cb) {
      var siteInjectorName;
      siteInjectorName = "" + this.name + "SiteInjector";
      return background.require(["sites/" + this.name + "/" + siteInjectorName], (function(_this) {
        return function(siteInjector) {
          return cb(siteInjector, _this);
        };
      })(this));
    };

    Site.prototype.getSiteScraper = function(background, cb) {
      var siteScraperName;
      siteScraperName = "" + this.name + "SiteScraper";
      return background.require(["sites/" + this.name + "/" + siteScraperName], function(siteScraper) {
        return cb(siteScraper);
      });
    };

    Site.prototype.productScraperClass = function(background, cb) {
      var productScraperName;
      productScraperName = "" + this.name + "ProductScraper";
      return background.require(["sites/" + this.name + "/" + productScraperName], function(productScraper) {
        return cb(productScraper);
      });
    };

    Site.prototype.productSid = function(background, url, cb, retrievalId) {
      return this.productScraperClass(background, (function(_this) {
        return function(productScraper) {
          return productScraper.productSid(background, url, cb, retrievalId);
        };
      })(this));
    };

    Site.prototype.productScraper = function(background, productSid, cb) {
      var _ref, _ref1;
      if ((_ref = this._productScraper) != null ? _ref[productSid] : void 0) {
        return cb((_ref1 = this._productScraper) != null ? _ref1[productSid] : void 0);
      } else {
        if (this.cbs == null) {
          this.cbs = {};
        }
        if (this.cbs[productSid]) {
          return this.cbs[productSid].push(cb);
        } else {
          this.cbs[productSid] = [cb];
          return this.productScraperClass(background, (function(_this) {
            return function(productScraper) {
              var scraper, _i, _len, _ref2;
              _this._productScraper[productSid] = scraper = new productScraper(_this, productSid, background);
              _ref2 = _this.cbs[productSid];
              for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                cb = _ref2[_i];
                cb(scraper);
              }
              return delete _this.cbs[productSid];
            };
          })(this));
        }
      }
    };

    Site.prototype.productUrl = function(sid) {
      return this.config.productUrl(sid);
    };

    Site.prototype.product = function(background, product, cb) {
      var productClassName, siteProduct;
      if (this.config.hasProductClass) {
        if (Site.productClasses[this.name]) {
          siteProduct = new Site.productClasses[this.name](product);
          siteProduct.site = this;
          return cb(siteProduct);
        } else {
          productClassName = "" + this.name + "Product";
          return background.require(["sites/" + this.name + "/" + productClassName], (function(_this) {
            return function(productClass) {
              Site.productClasses[_this.name] = productClass;
              siteProduct = new productClass(product);
              siteProduct.site = _this;
              return cb(siteProduct);
            };
          })(this));
        }
      } else {
        return cb();
      }
    };

    return Site;

  })();
});

//# sourceMappingURL=Site.map
