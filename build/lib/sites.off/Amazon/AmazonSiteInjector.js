// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(function() {
  return {
    d: ['BCSiteInjector'],
    c: function() {
      var AmazonSiteInjector, matchProductSid;
      matchProductSid = function(url) {
        var matches, productSid;
        matches = new RegExp('(?:/gp/product/|/dp/)([^/]*)').exec(url);
        if (matches) {
          productSid = matches[1];
          if (productSid === 'B004LLIKVU') {
            return;
          }
          return productSid;
        }
      };
      return AmazonSiteInjector = (function(_super) {
        __extends(AmazonSiteInjector, _super);

        function AmazonSiteInjector() {
          return AmazonSiteInjector.__super__.constructor.apply(this, arguments);
        }

        AmazonSiteInjector.prototype.siteName = 'Amazon';

        AmazonSiteInjector.prototype.pages = function() {
          return {
			'http://www\.amazon\.com/((.*?/)?dp/|gp/product/)': {
				drag: '#prodImageCell img, .main-image-inner-wrapper img, img#main-image, #imgTagWrapperId img, #imgBlkFront, #fbt_x_img img, #main-image-container .imgTagWrapper img',

				elHook: '.buyingDetailsGrid > tbody',	
				init: function() {
					function onVariationChange() {
						var prevASIN = Client.productID;
						
						var id = setInterval(function() {
							var asin = Client.site.productID();
							
							// The combination selected isn't valid
							if ((!t$('#addToCartButton') || $('#addToCartButton').style.cursor == 'not-allowed') && !t$('.dpSprite.s_seeAllBuying')) {
								clearInterval(id);
								Client.clearProduct();
							}
							
							// Waiting for the combination to load...
							else {
								if (Client.productID) {
									Client.clearProduct(true);
								}
								
								// The combination loaded
								if (asin != prevASIN) {
									Client.productInit();
									clearInterval(id);
								}
							}
						}, 100);
					}
				
					// Variation swatches
					var variations = t$$('.variations .swatchOuter');
					for (var i = 0; i < variations.length; ++ i) {
						var variation = variations[i];
						
						variation.addEventListener('click', function() {
							if (this.firstChild.nextSibling.className == 'swatchSelect') return;
							onVariationChange();
						}, true);
					}
					
					// Variation dropdowns
					variations = t$$('.twister_dropdown');
					for (var i = 0; i < variations.length; ++ i) {
						var variation = variations[i];
						
						variation.addEventListener('change', function() {
							onVariationChange();
						}, true);
					}
					
					
					// Products don't start out with the "real" add to cart button...
					//if (t$('#priceBlock .priceLarge') && $('#priceBlock .priceLarge').textContent.indexOf('-') == -1 || !t$('#priceBlock .priceLarge')) {
					// Products will only start out disabled if there is a dropdown
					if (variations.length == 0) {
						Client.productInit();
					}
					else {
						Client.clearProduct();
					}
				},
				
				productID: function() { var func = function() {
					if (t$('#buyBoxAudible')) {
						return;
					}
					
					//return JSON.parse(t$('#tell-a-friend span.a-declarative').getAttribute('data-a-modal')).url.match(/&id=([^&]*)&/)[1];


					try {
						return t$('#swftext').href.match(/contentID=(.*?)&/)[1]
					}
					catch (e) {
						try {
							return t$('#swfText').href.match(/contentID=(.*?)&/)[1]
						}
						catch (e) {
							throw e;
						}
					}


					http://www.amazon.com/PS3-250GB-Last-Bundle-Playstation-3/dp/B00HK74G2E/?psc=1

					// Some clothes (and possible other types of products) have pages set up for variations, but they don't actually have options (correction: they do have options, but they are hidden swatches...)
					// These pages start out with the wrong ASIN, and switch to it after some indeterminate amount of time. However, the like button starts out with the correct ASIN
					if (t$('.variationSelected') && !(jQuery('.variations .swatchOuter:visible').length || t$('.twister_dropdown'))) {
						return $('.amazonLikeButton').id.split('_')[1];
					}
					else {
						/*if (!this._once || t$('#buyboxDivId') && t$('#buyboxDivId').style.display == 'none') {
							this._once = true;
							
							// Only products with variations have this
							var el = t$('#detail-bullets_feature_div .content > ul');
							if (el) {
								var matches = /<b>ASIN:\s*<\/b>\s*(.*?)<\/li>/.exec(el.innerHTML);
								return matches[1];
							}
							else {
								return $('#ASIN').value;
							}
						}
						else {*/
							return $('#ASIN').value;
						//}
					}
				
					// #ASIN for Amazon Digital Services products starts out as the ASIN for the non-downloadable version, but it seems like this element always contains the correct ASIN
					var alt = t$('#cdPostBoxForm [name=originInstanceID]');
					if (alt) {
						return alt.value;
					}
					else {
						return $('#ASIN').value;
					}
				}
				
				var productID = func();
				console.debug('ProductID:', productID);
				return productID;
				
				}
			}
		};
        };

        AmazonSiteInjector.prototype.initOverlay = function(overlayView) {
          return overlayView.el.css('z-index', 999999);
        };

        AmazonSiteInjector.prototype.onInitPage = function() {
          var initProduct, initProducts, loadRecomendations, loader;
          $('#page-footer, body').css({
            paddingBottom: 74
          });
          $.fn.disableSelection = function() {
            this.css('user-select', 'none');
            this.css('-moz-user-select', 'none');
            return this.css('-webkit-user-select', 'none');
          };
          $.fn.enableSelection = function() {
            this.css('user-select', '');
            this.css('-moz-user-select', '');
            return this.css('-webkit-user-select', '');
          };
          $('body').delegate('#magnifierLens', 'mouseover', (function(_this) {
            return function() {
              var down, event;
              $('#magnifierLens').unbind('.agora');
              down = false;
              event = null;
              return $('#magnifierLens').bind('mousedown.agora', function(e) {
                down = true;
                $('html').disableSelection();
                event = e;
                return true;
              }).bind('mouseup.agora', function() {
                return down = false;
              }).bind('mousemove.agora', function() {
                var el, selector, _i, _len, _ref;
                if (down) {
                  down = false;
                  selector = '#main-image, #landingImage, #prodImageCell img, .main-image-inner-wrapper img, img#main-image, #imgTagWrapperId img, #imgBlkFront, #fbt_x_img img, #main-image-container .imgTagWrapper img';
                  _ref = $(selector);
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    el = _ref[_i];
                    _this.clearProductEl(el);
                  }
                  selector = selector.split(', ').map(function(str) {
                    return str + ':visible';
                  }).join(', ');
                  _this.products($(selector), {
                    siteName: _this.siteName,
                    productSid: _this.Client.site.productID()
                  }, {
                    area: 'main'
                  });
                  return setTimeout((function() {
                    $('#magnifierLens').remove();
                    $('#zoomWindow').hide();
                    $(selector).trigger(event);
                    return $('html').one('mouseup', function() {
                      return $('html').enableSelection();
                    });
                  }), 100);
                }
              });
            };
          })(this));
          $('body').delegate(':not(.-agora) a img:not([agora])', 'mouseover', function() {
            var productSid;
            productSid = matchProductSid($(this).parents('a').attr('href'));
            if (productSid) {
              return initProduct(this, productSid, true);
            }
          });
          initProduct = (function(_this) {
            return function(el, sid, mousedover) {
              var extraOverlayElements;
              el = $(el);
              extraOverlayElements = null;
              if (el.parent().hasClass('imageBox')) {
                extraOverlayElements = el.parents('a');
              }
              return _this.initProductEl(el, {
                siteName: _this.siteName,
                productSid: sid
              }, {
                hovering: mousedover,
                extraOverlayElements: extraOverlayElements,
                area: 'listing'
              });
            };
          })(this);
          window.initProducts = initProducts = function() {
            return $(':not(.-agora) a img[src^="http://ecx.images-amazon.com/images/I/"]').each(function() {
              var a, productSid;
              a = $(this).parents('a:first');
              productSid = matchProductSid(a.attr('href'));
              if (productSid) {
                return initProduct($(this), productSid, false);
              }
            });
          };
          window.clearProducts = (function(_this) {
            return function() {
              var el, _i, _len, _ref, _results;
              _ref = $('a img[src^="http://ecx.images-amazon.com/images/I/"]');
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                el = _ref[_i];
                if (matchProductSid($(el).parents('a:first').attr('href'))) {
                  _results.push(_this.clearProductEl(el));
                } else {
                  _results.push(void 0);
                }
              }
              return _results;
            };
          })(this);
          loadRecomendations = function() {
            var intervalId;
            return intervalId = setInterval((function() {
              if (!$('#rhf .rhf_loading_outer').length) {
                clearTimeout(intervalId);
                return initProducts();
              }
            }), 500);
          };
          $('body').delegate('#rvisColumn .rhf-RVIs a img', 'mousedown', function() {
            return setTimeout(loadRecomendations, 100);
          });
          loader = function(opts) {
            var load, timerId;
            timerId = null;
            load = function(el) {
              var asins, contEl, count, func, startOverLink;
              clearTimeout(timerId);
              contEl = $(el).parents("" + opts.container + ":first");
              asins = [];
              count = 0;
              contEl.find("" + opts.slide + " > div:first-child").each(function(i) {
                asins[i] = $(this).attr('data-asin');
                return ++count;
              });
              startOverLink = $(this).hasClass(opts.startOver);
              func = function() {
                contEl.find(opts.slide).each(function(i) {
                  var asin;
                  if ($(this).hasClass(opts.empty)) {
                    return;
                  }
                  asin = $(this).children('div:first-child').attr('data-asin');
                  if (asins[i] !== asin) {
                    asins[i] = asin;
                    return --count;
                  }
                });
                if (count <= 0) {
                  if (!startOverLink) {
                    clearTimeout(timerId);
                  }
                  console.log(asins);
                  return initProducts();
                }
              };
              if (startOverLink) {
                return setTimeout(func, 500);
              } else {
                return timerId = setInterval(func, 100);
              }
            };
            return $('body').delegate("" + opts.nav + ", " + opts.container + " " + opts.startOver, 'mousedown', function() {
              return load(this);
            });
          };
          loader({
            container: '.a-carousel-container',
            slide: '.a-carousel-card',
            nav: '.a-carousel-container .a-carousel-goto-nextpage .a-button-inner, .a-carousel-container .a-carousel-goto-prevpage .a-button-inner',
            startOver: '.a-carousel-restart',
            empty: 'a-carousel-card-empty'
          });
          loader({
            container: '.shoveler',
            slide: '.shoveler-content ul li',
            nav: '.shoveler span.s_shvlNext, .shoveler .next-button a, .shoveler span.s_shvlBack',
            startOver: 'a.start-over-link',
            empty: 'shoveler-progress'
          });
          setInterval(initProducts, 2000);
          return $(function() {
            var loadOtherId, updateSearchResults;
            loadRecomendations();
            initProducts();
            $('body').load(initProducts);
            loadOtherId = setInterval((function() {
              if (!$('#rhf_container .rhf_loading_outer').length) {
                clearTimeout(loadOtherId);
                return initProducts();
              }
            }), 500);
            $('body').delegate('.s9ShovelerBackBookendButton, .s9ShovelerNextBookendButton', 'mousedown', function() {
              return setTimeout(initProducts, 500);
            });
            updateSearchResults = function() {
              var timerId;
              console.log('update');
              $('#btfResults').append('<div id="agoraTester" />');
              return timerId = setInterval((function() {
                console.log($('#agoraTester').length);
                if (!$('#agoraTester').length) {
                  clearTimeout(timerId);
                  return initProducts();
                }
              }), 500);
            };
            $('body').delegate('#sort', 'change', updateSearchResults);
            $('body').delegate('#pagn a, #refinements a, #kindOfSort_content a, #breadCrumb a, #relatedSearches a', 'mousedown', updateSearchResults);
            return $('.nav-searchbar-inner.nav-prime-menu').submit(updateSearchResults);
          });
        };

        return AmazonSiteInjector;

      })(BCSiteInjector);
    }
  };
});

//# sourceMappingURL=AmazonSiteInjector.map
