// Generated by CoffeeScript 1.10.0
var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

define(['View', 'Site', 'Formatter'], function(View, Site, Formatter) {
  var OffersView;
  return OffersView = (function(superClass) {
    extend(OffersView, superClass);

    function OffersView() {
      return OffersView.__super__.constructor.apply(this, arguments);
    }

    OffersView.nextId = 0;

    OffersView.id = function(args) {
      return ++this.nextId;
    };

    OffersView.prototype.initAsync = function(args, done) {
      return this.resolveObject(args, (function(_this) {
        return function(product) {
          var offers, selectedOffer, updateOffers, updateSelectedOffer;
          _this.product = product;
          _this.product.retrieve('offers');
          updateOffers = function() {
            var cheapest, condition, heading, i, j, k, len, len1, o, offer, productOffers, ref, ref1, theseOffers, viewOffers;
            if (_this.product.get('offers')) {
              productOffers = _this.product.get('offers');
              viewOffers = [];
              ref = ['new', 'used', 'refurbished'];
              for (j = 0, len = ref.length; j < len; j++) {
                condition = ref[j];
                if (productOffers[condition]) {
                  theseOffers = productOffers[condition];
                  cheapest = theseOffers[0];
                  heading = condition.substr(0, 1).toUpperCase() + condition.substr(1);
                  heading += " (" + (Formatter.price(cheapest.price)) + ")";
                  o = {
                    heading: heading,
                    offers: []
                  };
                  for (i = k = 0, len1 = theseOffers.length; k < len1; i = ++k) {
                    offer = theseOffers[i];
                    o.offers.push({
                      id: condition + "." + i,
                      data: offer,
                      price: Formatter.price(offer.price),
                      site: offer.site,
                      url: offer.url,
                      title: offer.title,
                      image: offer != null ? (ref1 = offer.images) != null ? ref1[0] : void 0 : void 0,
                      api: offer.api
                    });
                  }
                  viewOffers.push(o);
                }
              }
              offers.set(viewOffers);
              return updateSelectedOffer();
            }
          };
          updateSelectedOffer = function() {
            var condition, i, j, k, len, len1, offer, productOffers, ref, theseOffers;
            if (_this.product.get('offers') && _this.product.get('offer')) {
              productOffers = _this.product.get('offers');
              ref = ['new', 'used', 'refurbished'];
              for (j = 0, len = ref.length; j < len; j++) {
                condition = ref[j];
                if (productOffers[condition]) {
                  theseOffers = productOffers[condition];
                  for (i = k = 0, len1 = theseOffers.length; k < len1; i = ++k) {
                    offer = theseOffers[i];
                    if (offer.url === _this.product.get('offer').url && offer.price === _this.product.get('offer').price) {
                      selectedOffer.set(condition + "." + i);
                      return;
                    }
                  }
                }
              }
            }
            return selectedOffer.set(null);
          };
          offers = _this.clientValue();
          selectedOffer = _this.clientValue();
          _this.product.field('offers').observe(updateOffers);
          updateOffers();
          _this.product.field('offer').observe(updateSelectedOffer);
          _this.data = {
            offers: offers,
            selectedOffer: selectedOffer
          };
          return done();
        };
      })(this));
    };

    OffersView.prototype.methods = {
      setOffer: function(view, offer) {
        return this.product.set('offer', {
          site: offer.site,
          url: offer.url,
          price: offer.price
        });
      }
    };

    return OffersView;

  })(View);
});

//# sourceMappingURL=OffersView.js.map
