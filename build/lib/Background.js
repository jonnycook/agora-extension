// Generated by CoffeeScript 1.7.1
define(['client/ContentScript'], function(ContentScript) {
  var Background;
  return Background = (function() {
    Background.prototype.apiVersion = '0.0.1';

    Background.prototype.contentScriptListen = function(eventName, tabId) {
      var l;
      if (l = this.contentScriptListeners[eventName]) {
        if (l.indexOf(tabId) === -1) {
          return l.push(tabId);
        }
      } else {
        return this.contentScriptListeners[eventName] = [tabId];
      }
    };

    Background.prototype.setDomain = function(domain) {
      this.domain = domain;
      return this.apiRoot = "http://" + this.domain + "/ext/";
    };

    function Background(opts) {
      if (opts == null) {
        opts = {};
      }
      if (opts.client == null) {
        opts.client = true;
      }
      if (typeof env !== 'undefined') {
        if (this.domain == null) {
          this.domain = env.domain;
        }
      }
      this.apiRoot = "http://" + this.domain + "/ext/";
      if (opts.client) {
        this.listeners = {};
        this.contentScriptListeners = {};
        this.onRequest((function(_this) {
          return function(request, sender, sendResponse) {
            var eventSource, i, l, listener;
            if ((request.version != null) && request.version !== _this.version) {
              sendResponse('oldVersion');
              return true;
            } else {
              switch (request.request) {
                case 'injectUtilScripts':
                  _this.injectUtilScripts(sender, sendResponse);
                  return true;
                case 'listen':
                  if (l = _this.contentScriptListeners[request.eventName]) {
                    if (l.indexOf(sender.id) === -1) {
                      return l.push(sender.id);
                    }
                  } else {
                    return _this.contentScriptListeners[request.eventName] = [sender.id];
                  }
                  break;
                case 'stopListening':
                  if (l = _this.contentScriptListeners[request.eventName]) {
                    i = l.indexOf(sender.id);
                    l.splice(i, 1);
                    if (!l.length) {
                      return delete _this.contentScriptListeners[request.eventName];
                    }
                  }
                  break;
                case 'BackgroundMessage':
                  if (listener = _this.listeners[request.messageName]) {
                    eventSource = {
                      url: sender.url,
                      tabId: sender.id
                    };
                    listener(eventSource, request.args, sendResponse);
                  } else {
                    console.log("No listener for " + request.event);
                  }
                  return true;
              }
            }
          };
        })(this));
      }
      String.prototype.safeMatch = function(pattern) {
        var matches;
        if (this.match) {
          matches = this.match(pattern);
          if (matches) {
            return matches;
          } else {
            throw new Error("" + pattern + " not found in " + this);
          }
        }
      };
    }

    Background.prototype.triggerContentScriptEvent = function(eventName, args, debug) {
      var l, tabID, _i, _len, _ref, _results;
      if (debug == null) {
        debug = false;
      }
      l = this.contentScriptListeners[eventName];
      if (debug) {
        console.debug('triggerContentScriptEvent', eventName, args, (_ref = this.contentScriptListeners[eventName]) != null ? _ref.length : void 0);
      }
      if (l) {
        _results = [];
        for (_i = 0, _len = l.length; _i < _len; _i++) {
          tabID = l[_i];
          _results.push(this.sendRequest(tabID, {
            eventName: eventName,
            args: args
          }));
        }
        return _results;
      }
    };

    Background.prototype.listen = function(request, cb) {
      return this.listeners[request] = cb;
    };

    Background.prototype.logError = function(type, message, file, line, column, stack, info, args) {
      if (!env.dontSubmitErrors) {
        return this.httpRequest("" + this.apiRoot + "logErrors.php", {
          method: 'post',
          data: {
            type: type,
            args: args,
            error: {
              message: message,
              file: file,
              line: line,
              column: column,
              info: info,
              stack: stack
            },
            userId: this.userId,
            extVersion: this.version,
            apiVersion: this.apiVersion,
            clientId: this.clientId
          }
        });
      }
    };

    Background.prototype.error = function() {
      var arg, args, error, i, realError, _i, _len, _ref;
      args = [];
      error = {};
      realError = null;
      _ref = Array.prototype.slice.call(arguments, 1);
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        arg = _ref[i];
        if (arg instanceof Error) {
          realError = arg;
          error = {
            message: arg.message,
            stack: arg.stack,
            info: arg.info,
            line: arg.line
          };
        } else {
          args.push(arg);
        }
      }
      this.logError(arguments[0], error.message, error.file, error.line, error.column, error.stack, error.info, args);
      if (realError && !env.gracefulFailure) {
        throw realError;
      }
    };

    Background.prototype.log = function() {
      var arg, args, error, i, realError, _i, _len;
      console.debug.apply(console, arguments);
      args = [];
      error = {};
      realError = null;
      for (i = _i = 0, _len = arguments.length; _i < _len; i = ++_i) {
        arg = arguments[i];
        args.push(arg);
      }
      return setTimeout(((function(_this) {
        return function() {
          return _this.httpRequest("" + _this.apiRoot + "log.php", {
            method: 'post',
            data: {
              args: JSON.stringify(args),
              timestamp: new Date().getTime(),
              userId: _this.userId,
              extVersion: _this.version,
              instanceId: _this.instanceId,
              clientId: _this.clientId
            }
          });
        };
      })(this)), 0);
    };

    Background.prototype.contentScript = function() {};

    Background.prototype.httpGet = function(opts) {};

    Background.prototype.require = function(modules, cb) {};

    Background.prototype.unregisterTab = function(tabId) {
      var event, i, tabIds, _ref, _results;
      console.log('unregistering tab', tabId);
      _ref = this.contentScriptListeners;
      _results = [];
      for (event in _ref) {
        tabIds = _ref[event];
        i = tabIds.indexOf(tabId);
        if (i !== -1) {
          tabIds.splice(i, 1);
          if (!tabIds.length) {
            _results.push(delete this.contentScriptListeners[event]);
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    Background.prototype.reset = function() {
      return this.contentScriptListeners = {};
    };

    Background.prototype.ping = function() {
      return this.httpRequest("" + this.apiRoot + "ping.php", {
        data: {
          id: this.instanceId,
          version: this.version,
          state: this.state
        },
        cb: (function(_this) {
          return function(response) {
            var command, _i, _len, _ref, _results;
            if (response) {
              response = JSON.parse(response);
              if (response.commands) {
                _ref = response.commands;
                _results = [];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  command = _ref[_i];
                  _results.push((function(command) {
                    return agora.updater.commandExecuter.executeCommand(JSON.parse(command.command), function(result) {
                      return _this.httpRequest("" + _this.apiRoot + "returnCommand.php", {
                        method: 'post',
                        data: {
                          commandId: command.id,
                          result: JSON.stringify(result)
                        }
                      });
                    });
                  })(command));
                }
                return _results;
              }
            }
          };
        })(this)
      });
    };

    return Background;

  })();
});

//# sourceMappingURL=Background.map
