// Generated by CoffeeScript 1.10.0
var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

define(['./ObservableArray', './ObservableObject', './Record', 'underscore', 'util'], function(ObservableArray, ObservableObject, Record, _, util) {
  var Table;
  return Table = (function() {
    function Table(name1, args) {
      var base, base1, base2, base3, base4, base5, base6, contents, field, fieldName, i, j, len, len1, name, r, record, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, referent, rel, rels, type, value;
      this.name = name1;
      if (args) {
        this.schema = args.schema, contents = args.contents;
      }
      this.records = new ObservableArray;
      this.records.name = "Table::" + this.name;
      if (contents) {
        for (i = 0, len = contents.length; i < len; i++) {
          record = contents[i];
          this.addRecord(record);
        }
      }
      this.mappings = {};
      this.rid = 1;
      this._recordsByRid = {};
      if (this.schema == null) {
        this.schema = {};
      }
      if ((base = this.schema).fields == null) {
        base.fields = [];
      }
      if ((base1 = this.schema).types == null) {
        base1.types = {};
      }
      if ((base2 = this.schema).defaultValues == null) {
        base2.defaultValues = {};
      }
      this.records.observe((function(_this) {
        return function(mutation) {
          if (mutation.type === 'deletion') {
            return delete _this._recordsByRid[mutation.value.get('id')];
          }
        };
      })(this));
      if (args != null ? args.graph : void 0) {
        this.onGraph = true;
        this.graphRoot = args.graph.root;
        this.graphRels = rels = [];
        ref = args.graph;
        for (name in ref) {
          rel = ref[name];
          if (!_.isArray(rel)) {
            rel = [rel];
          }
          for (j = 0, len1 = rel.length; j < len1; j++) {
            r = rel[j];
            if (r.table) {
              rels.push({
                table: r.table,
                owns: r.owns,
                owner: r.owner,
                field: name,
                filter: r.filter
              });
            } else if (r.field) {
              rels.push({
                foreignKey: true,
                field: r.field,
                table: name,
                owns: r.owns,
                owner: r.owner,
                filter: r.filter
              });
            }
          }
        }
      } else {
        this.onGraph = args != null ? args.onGraph : void 0;
      }
      this.canBeExternal = (ref1 = args != null ? (ref2 = args.graph) != null ? ref2.canBeExternal : void 0 : void 0) != null ? ref1 : true;
      if (this.schema) {
        if ((base3 = this.schema).fields == null) {
          base3.fields = [];
        }
        if (this.schema.referents) {
          ref3 = this.schema.referents;
          for (field in ref3) {
            referent = ref3[field];
            if (!((ref4 = this.schema) != null ? (ref5 = ref4.types) != null ? ref5[field] : void 0 : void 0)) {
              if ((base4 = this.schema).types == null) {
                base4.types = {};
              }
              this.schema.types[field] = 'id';
            }
          }
        }
        if (this.schema.autoIncrement) {
          if ((base5 = this.schema).types == null) {
            base5.types = {};
          }
          this.schema.types[this.schema.autoIncrement] = 'int';
        }
        if (this.schema.defaultValues) {
          ref6 = this.schema.defaultValues;
          for (fieldName in ref6) {
            value = ref6[fieldName];
            if (indexOf.call(this.schema.fields, fieldName) < 0) {
              this.schema.fields.push(fieldName);
            }
            if (!this.schema.types || !(fieldName in this.schema.types)) {
              if ((base6 = this.schema).types == null) {
                base6.types = {};
              }
              this.schema.types[fieldName] = (function() {
                if (_.isBoolean(value)) {
                  return 'bool';
                } else if (_.isString(value)) {
                  return 'string';
                } else if (_.isNumber(value)) {
                  if (value % 1 === 0) {
                    return 'int';
                  } else {
                    return 'float';
                  }
                } else {
                  throw new Error("invalid default value");
                }
              })();
            }
          }
        }
        if (this.schema.types) {
          ref7 = this.schema.types;
          for (fieldName in ref7) {
            type = ref7[fieldName];
            if (indexOf.call(this.schema.fields, fieldName) < 0) {
              this.schema.fields.push(fieldName);
            }
            switch (type) {
              case 'object':
                this.mappings[fieldName] = function(value) {
                  if (_.isString(value)) {
                    return JSON.parse(value);
                  } else {
                    return value;
                  }
                };
                break;
              case 'datetime':
                this.mappings[fieldName] = function(value) {
                  if (_.isString(value)) {
                    return Date.parse(value);
                  } else {
                    return value;
                  }
                };
                break;
              case 'bool':
                this.mappings[fieldName] = function(value) {
                  if (_.isBoolean(value)) {
                    return value;
                  } else if (_.isString(value)) {
                    if (value === 'true') {
                      return true;
                    } else if (value === 'false') {
                      return false;
                    } else {
                      return !!parseInt(value);
                    }
                  } else if (_.isNumber) {
                    return !!value;
                  }
                };
                break;
              case 'int':
                this.mappings[fieldName] = function(value) {
                  if (_.isString(value)) {
                    value = value.replace(/,/g, '');
                  }
                  return parseInt(value);
                };
                break;
              case 'float':
                this.mappings[fieldName] = function(value) {
                  return parseFloat(value);
                };
                break;
              case 'id':
                this.mappings[fieldName] = function(value) {
                  if (typeof value === 'string' && value[0] === 'G') {
                    return value;
                  } else {
                    return parseInt(value);
                  }
                };
            }
          }
        }
      }
    }

    Table.prototype.clear = function() {
      this["delete"](function() {
        return 1;
      });
      return this._recordsByRid = {};
    };

    Table.prototype.executeChanges = function(changes, source) {
      var key, record, recordChanges, ref, ref1, ref2, ref3, ref4, ref5, ref6, referentTable, results1, rid, value;
      results1 = [];
      for (rid in changes) {
        recordChanges = changes[rid];
        rid = (ref = (ref1 = this.db.globalToLocalMapping) != null ? (ref2 = ref1[this.name]) != null ? ref2[rid] : void 0 : void 0) != null ? ref : rid;
        if (recordChanges === 'deleted') {
          results1.push(this.records.deleteIf(function(record) {
            return record.id == rid;
          }));
        } else {
          for (key in recordChanges) {
            value = recordChanges[key];
            if (referentTable = (ref3 = this.schema) != null ? (ref4 = ref3.referents) != null ? ref4[key] : void 0 : void 0) {
              if (_.isFunction(referentTable)) {
                referentTable = referentTable(recordChanges);
              }
              recordChanges[key] = (ref5 = (ref6 = this.db.globalToLocalMapping[referentTable]) != null ? ref6[value] : void 0) != null ? ref5 : value;
            }
          }
          record = this._recordsByRid[rid];
          if (record) {
            results1.push((function() {
              var results2;
              results2 = [];
              for (key in recordChanges) {
                value = recordChanges[key];
                if (record.get(key) !== value) {
                  results2.push(record.set(key, value));
                } else {
                  results2.push(void 0);
                }
              }
              return results2;
            })());
          } else {
            results1.push(this._addRecord(recordChanges, rid));
          }
        }
      }
      return results1;
    };

    Table.prototype.serialize = function() {
      var table;
      table = {
        rid: this.rid,
        records: {}
      };
      this.records.each(function(record) {
        return table.records[record.id] = record.serialize();
      });
      return table;
    };

    Table.prototype._nextAutoIncrement = function() {
      if (!this._autoIncrement) {
        return this._autoIncrement = 1;
      } else {
        return ++this._autoIncrement;
      }
    };

    Table.prototype._addRecord = function(data, rid) {
      var field, i, len, record, ref, ref1, type;
      if (this.schema) {
        if (this.schema.fields) {
          ref = this.schema.fields;
          for (i = 0, len = ref.length; i < len; i++) {
            field = ref[i];
            if (!(field in data)) {
              data[field] = null;
            }
          }
        }
        if (this.schema.types) {
          ref1 = this.schema.types;
          for (field in ref1) {
            type = ref1[field];
            if (!(field in data)) {
              data[field] = null;
            }
          }
        }
      }
      record = new Record(rid, data, this.mappings, this);
      this.records.push(record);
      this._recordsByRid[record.id] = record;
      return record;
    };

    Table.prototype.addRecord = function(data) {
      var field, fieldName, i, len, ref, ref1, value;
      if (this.schema) {
        if (this.schema.autoIncrement) {
          if (!data[this.schema.autoIncrement]) {
            data[this.schema.autoIncrement] = this._nextAutoIncrement();
          } else {
            data[this.schema.autoIncrement] = parseInt(data[this.schema.autoIncrement]);
            if (this._autoIncrement < data[this.schema.autoIncrement] || !this._autoIncrement) {
              this._autoIncrement = data[this.schema.autoIncrement];
            }
          }
        }
        if (this.schema.defaultValues) {
          ref = this.schema.defaultValues;
          for (fieldName in ref) {
            value = ref[fieldName];
            if (!(fieldName in data)) {
              data[fieldName] = value;
            }
          }
        }
        if (this.schema.fields) {
          ref1 = this.schema.fields;
          for (i = 0, len = ref1.length; i < len; i++) {
            field = ref1[i];
            if (!(field in data)) {
              data[field] = null;
            }
          }
        }
      }
      return this._addRecord(data, this.rid++);
    };

    Table.prototype.insert = function(data) {
      return this.addRecord(data);
    };

    Table.prototype.select = function(query) {
      var results;
      results = [];
      this.records.each((function(_this) {
        return function(record) {
          if (query(record)) {
            return results.push(record);
          }
        };
      })(this));
      return results;
    };

    Table.prototype.selectFirst = function(query) {
      return util.find(this.records, query);
    };

    Table.prototype["delete"] = function(predicate) {
      return this.records.deleteIf(function(record) {
        return predicate(record);
      });
    };

    Table.prototype.observe = function(observer) {
      var observeField, observeRecord;
      observeField = function(record, field) {
        return record.field(field).observe(function(mutation) {
          return observer({
            type: 'update',
            record: record,
            field: field
          });
        });
      };
      observeRecord = (function(_this) {
        return function(record) {
          var field, i, len, ref, results1;
          if (record.table.schema.fields) {
            ref = record.table.schema.fields;
            results1 = [];
            for (i = 0, len = ref.length; i < len; i++) {
              field = ref[i];
              results1.push(observeField(record, field));
            }
            return results1;
          }
        };
      })(this);
      this.records.each(observeRecord);
      return this.records.observe(function(mutation) {
        if (mutation.type === 'insertion') {
          observer({
            type: 'insertion',
            record: mutation.value
          });
          return observeRecord(mutation.value);
        } else if (mutation.type === 'deletion') {
          return observer({
            type: 'deletion',
            record: mutation.value
          });
        }
      });
    };

    Table.prototype.byId = function(id) {
      return this._recordsByRid[id];
    };

    Table.prototype.byGlobalId = function(id) {
      var ref, ref1, ref2;
      return this.byId((ref = (ref1 = this.db.globalToLocalMapping) != null ? (ref2 = ref1[this.name]) != null ? ref2[id] : void 0 : void 0) != null ? ref : id);
    };

    Table.prototype.bySaneId = function(id) {
      return this.byGlobalId("G" + id);
    };

    return Table;

  })();
});

//# sourceMappingURL=Table.js.map
