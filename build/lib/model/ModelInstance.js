// Generated by CoffeeScript 1.7.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __slice = [].slice;

define(['./HasManyRelationship', './HasOneRelationship', './ObservableObject'], function(HasManyRelationship, HasOneRelationship, ObservableObject) {
  var ModelInstance;
  return ModelInstance = (function(_super) {
    __extends(ModelInstance, _super);

    ModelInstance.prototype._createRelationship = function(constructor, relName) {
      if (typeof constructor === 'function') {
        return constructor(this);
      } else {
        if (typeof constructor.model === 'string') {
          constructor.model = this.model.manager.getModel(constructor.model);
        }
        switch (constructor.type) {
          case 'hasMany':
            return new HasManyRelationship(this, constructor, relName);
          case 'hasOne':
            return new HasOneRelationship(this, constructor, relName);
        }
      }
    };

    ModelInstance.prototype._createRelationships = function() {
      var relArgs, relName, relationships, _results;
      this._relationships = {};
      if (relationships = this.model.relationships) {
        _results = [];
        for (relName in relationships) {
          relArgs = relationships[relName];
          _results.push(this._relationships[relName] = this._createRelationship(relArgs, relName));
        }
        return _results;
      }
    };

    ModelInstance.prototype._initRelationships = function() {
      var rel, relName, _ref, _results;
      _ref = this._relationships;
      _results = [];
      for (relName in _ref) {
        rel = _ref[relName];
        _results.push(typeof rel.init === "function" ? rel.init() : void 0);
      }
      return _results;
    };

    ModelInstance.prototype.saneId = function() {
      return this.record.saneId();
    };

    ModelInstance.prototype.createRelationships = function(shouldCreateRelationships) {
      if (this.model.manager.relationshipsPaused) {
        return this.model.manager.relationshipsQueue.push(this);
      } else if (shouldCreateRelationships) {
        this._createRelationships();
        return this._initRelationships();
      }
    };

    function ModelInstance(model, record) {
      this.model = model;
      this.record = record;
      this.modelName = this.model.name;
      this.retrieving = {};
    }

    ModelInstance.prototype._get = function(propertyName) {
      return this.record.get(propertyName);
    };

    ModelInstance.prototype.get = function(propertyName) {
      var prop, rel, _ref, _ref1;
      if (rel = (_ref = this._relationships) != null ? _ref[propertyName] : void 0) {
        return rel;
      } else if (prop = (_ref1 = this.model.properties) != null ? _ref1[propertyName] : void 0) {
        return prop.call(this);
      } else {
        return this._get(propertyName);
      }
    };

    ModelInstance.prototype.set = function(propertyName, value, timestamp) {
      return this.record.set(propertyName, value, timestamp);
    };

    ModelInstance.prototype.field = function(name) {
      return this.record.field(name);
    };

    ModelInstance.prototype["delete"] = function() {
      return this.model["delete"](this);
    };

    ModelInstance.prototype.tableName = function() {
      return this.record.tableName();
    };

    ModelInstance.prototype.equals = function(instance) {
      return this.model === instance.model && this.get('id') === instance.get('id');
    };

    ModelInstance.prototype.isA = function(modelName) {
      return modelName === this.modelName;
    };

    ModelInstance.prototype.retrieve = function(field, cb, force) {
      if (cb == null) {
        cb = null;
      }
      if (force == null) {
        force = false;
      }
      if (this.get(field) === null || force) {
        if (this.retrieving[field]) {
          if (cb) {
            return this.retrieving[field].push(cb);
          }
        } else {
          this.retrieving[field] = [];
          if (cb) {
            this.retrieving[field].push(cb);
          }
          return this.retrievers[field].call(this, (function(_this) {
            return function(value) {
              var _i, _len, _ref;
              _this.set(field, value);
              if (_this.retrieving[field]) {
                _ref = _this.retrieving[field];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  cb = _ref[_i];
                  cb(value);
                }
              }
              return delete _this.retrieving[field];
            };
          })(this));
        }
      } else if (cb) {
        return cb(this.get(field));
      }
    };

    ModelInstance.prototype["with"] = function() {
      var cb, count, done, field, fields, i, values, _i, _j, _len, _results;
      fields = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), cb = arguments[_i++];
      values = [];
      done = function() {
        if (!--count) {
          return cb.apply(null, values);
        }
      };
      count = fields.length;
      _results = [];
      for (i = _j = 0, _len = fields.length; _j < _len; i = ++_j) {
        field = fields[i];
        _results.push((function(_this) {
          return function(field, i) {
            if (_this.retrieving[field]) {
              return _this.retrieving[field].push(function(value) {
                values[i] = value;
                return done();
              });
            } else {
              if (_this.get(field) === null) {
                return _this.retrieve(field, function(value) {
                  values[i] = value;
                  return done();
                });
              } else {
                values[i] = _this.get(field);
                return done();
              }
            }
          };
        })(this)(field, i));
      }
      return _results;
    };

    return ModelInstance;

  })(ObservableObject);
});

//# sourceMappingURL=ModelInstance.map
