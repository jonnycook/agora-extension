var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/BCSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var BCSiteInjector;return BCSiteInjector=function(_super){__extends(BCSiteInjector,_super);function BCSiteInjector(){return BCSiteInjector.__super__.constructor.apply(this,arguments)}return BCSiteInjector.prototype.init=function(){var $,Client,t$,t$$,that;return t$=function(_this){return function(){return _this.contentScript.querySelector.apply(_this.contentScript,arguments)}}(this),t$$=function(_this){return function(){return _this.contentScript.querySelectorAll.apply(_this.contentScript,arguments)}}(this),$=function(_this){return function(){return _this.contentScript.safeQuerySelector.apply(_this.contentScript,arguments)}}(this),eval("var pages = ("+this.pages.toString()+")()"),this.pages=pages,that=this,this.Client=Client={productID:null,clearProduct:function(boolValue){return console.log("Client.clearProduct("+boolValue+")"),this.productInit()},productInit:function(){this.inited=!1;try{that.sid=this.productID=this.site.productID();if(!this.productID){this.clearProduct();return}console.log("Detected product:",this.productID)}catch(e){throw console.log("Failed to init product"),e}}}},BCSiteInjector.prototype.run=function(){return this.init(),this.url=document.location.href,$(function(_this){return function(){var el,page,pageMatch,_i,_len,_ref,_ref1,_results;_ref=_this.pages,_results=[];for(pageMatch in _ref){page=_ref[pageMatch];if(_this.url.match(pageMatch)){console.log("matched "+pageMatch),_this.Client.site=page,_this.Client.site.init(),_ref1=$(page.drag);for(_i=0,_len=_ref1.length;_i<_len;_i++)el=_ref1[_i],_this.products(el,{productSid:_this.sid},{area:"main",initOverlay:function(overlay){return overlay.addAlwaysShow("productPage")}});setInterval(function(){var sid,_j,_len1,_ref2,_results1;sid=_this.Client.site.productID();if(_this.sid!==sid){_this.sid=sid,_ref2=$(page.drag),_results1=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++)el=_ref2[_j],_this.clearProductEl(el),_results1.push(_this.products(el,{productSid:_this.sid},{area:"main",initOverlay:function(overlay){return overlay.addAlwaysShow("productPage")}}));return _results1}},2e3);break}_results.push(void 0)}return _results}}(this)),this.initPage(function(_this){return function(){_this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent();if(_this.onInitPage)return _this.onInitPage()}}(this)),!0},BCSiteInjector}(SiteInjector)}}}),define("client/ContentScript",[],function(){return function(){var ContentScript;return ContentScript=function(){function ContentScript(){this.listeners={},this.eventMap={},this.onRequest(function(_this){return function(request){var l,listener,_i,_len,_results;if(request.eventName){_this.eventMap[request.eventName]?Debug.log("ReceivedRequest",request.eventName,_this.eventMap[request.eventName],request.args):Debug.log("ReceivedRequest",request.eventName,request.args);if(l=_this.listeners[request.eventName]){_results=[];for(_i=0,_len=l.length;_i<_len;_i++)listener=l[_i],_results.push(listener(request.args));return _results}}}}(this))}return ContentScript.prototype.mapEvent=function(event,obj){return this.eventMap[event]=obj},ContentScript.prototype.listen=function(eventName,listener,tag){return this.eventMap[eventName],this.listeners[eventName]?this.listeners[eventName].push(listener):(this.listeners[eventName]=[listener],this.sendRequest({request:"listen",eventName:eventName,version:this.version},function(_this){return function(response){if(response==="oldVersion")return siteInjector.onOldVersion()}}(this)))},ContentScript.prototype.stopListening=function(eventName,listener,tag){var i,l;this.eventMap[eventName];if(l=this.listeners[eventName]){i=l.indexOf(listener),i!==-1&&l.splice(i,1);if(!l.length)return this.sendRequest({request:"stopListening",eventName:eventName,version:this.version},function(_this){return function(response){if(response==="oldVersion")return siteInjector.onOldVersion()}}(this)),delete this.listeners[eventName]}},ContentScript.prototype.reloadExtension=function(){return this.triggerBackgroundEvent("reloadExtension")},ContentScript.prototype.triggerBackgroundEvent=function(eventName,args,cb){return this.sendRequest({request:"BackgroundMessage",messageName:eventName,args:args,version:this.version},function(_this){return function(response){return response==="oldVersion"?siteInjector.onOldVersion():typeof cb=="function"?cb(response):void 0}}(this))},ContentScript.prototype.querySelector=function(selector){return document.querySelector(selector)},ContentScript.prototype.querySelectorAll=function(selector){return document.querySelectorAll(selector)},ContentScript.prototype.createElement=function(tag){return document.createElement(tag)},ContentScript.prototype.safeQuerySelector=function(selector){var el;el=this.querySelector(selector);if(el)return el;throw new Error(""+selector+" no found")},ContentScript.prototype.selfQuerySelectorAll=function(selector){var els;els=this.querySelectorAll;if(els.length)return els;throw new Error(""+selector+" not found")},ContentScript}()}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/DataDrivenSiteInjector",[],function(){return{d:["SiteInjector"],c:function(){var DataDrivenSiteInjector,doHandleOverlay,handleOverlay;return doHandleOverlay=function(overlayEl,image,hide){var down,event;return hide==null&&(hide=!1),$(overlayEl).unbind(".agora"),down=!1,event=null,Q(overlayEl).bind("mousedown.agora",function(e){return down=!0,Q("html").disableSelection(),e.preventDefault(),event=e,!0}).bind("mouseup.agora",function(){return down=!1,!0}).bind("mousemove.agora",function(e){if(down)return down=!1,hide&&Q(this).hide(),image.trigger(event),setTimeout(function(_this){return function(){return image.trigger(event)}}(this),100),$("html").one("mouseup",function(_this){return function(){$("html").enableSelection();if(hide)return $(_this).show()}}(this))})},handleOverlay=function(overlayEl,image,hide){return hide==null&&(hide=!1),Q("body").delegate(overlayEl,"mouseover",function(){return doHandleOverlay(overlayEl,image($(this)),hide)})},DataDrivenSiteInjector=function(_super){__extends(DataDrivenSiteInjector,_super),DataDrivenSiteInjector.productListing={testProductLink:function(a){return!0},productSid:function(href){return this.parseUrl(href)},productData:function(href,a,img){var productSid;productSid=this.productListing.productSid.call(this,href,a,img);if(productSid)return{productSid:productSid}}},DataDrivenSiteInjector.productPage={productSid:function(){throw new Error("unimplemented")},test:function(){return $('meta[property="og:type"]').attr("content")==="product"},waitFor:"body",imgEl:null,productSid:function(href){return this.parseUrl(document.location.href)}};function DataDrivenSiteInjector(){DataDrivenSiteInjector.__super__.constructor.apply(this,arguments),_.isFunction(this.productListing)||(this.productListing=_.extend(_.clone(DataDrivenSiteInjector.productListing),this.productListing)),this.productPage=_.extend(_.clone(DataDrivenSiteInjector.productPage),this.productPage)}return DataDrivenSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var doInitProducts,initProducts,that,_base;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),Q(_this.shoppingBarView.el).appendTo(document.body),_this.shoppingBarView.represent(),_.isFunction(_this.productListing)?_this.productListing.call(_this):((_base=_this.productListing).image==null&&(_base.image=_this.productListing.imgSelector),_this.productListing.init&&_this.productListing.init.call(_this),_this.productListing.mode===2?(_this.productListing.overlay&&handleOverlay(_this.productListing.overlay,_this.productListing.overlayImage),doInitProducts=function(selector,params){var a,el,href,img,positionEl,productData,_i,_len,_ref,_results;_ref=$(selector),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],img=params.image&&params.image!==selector?params.image($(el)):el,a=params.anchor?params.anchor($(el)):$(img).parents("a"),href=a.prop("href"),productData=params.productData.call(_this,href,a,$(img),$(el)),productData?(positionEl=params.positionA?a:params.position?params.position($(el)):img,params.anchorProxy&&doHandleOverlay(a,img),_this.initProductEl(img,productData,{overlay:!1}),params.forcePositioned&&Q(a).css("position","relative"),_results.push(_this.attachOverlay({positionEl:$(positionEl),attachEl:a,productData:productData,overlayZIndex:9999,position:params.overlayPosition}))):_results.push(void 0);return _results},window.initProducts=initProducts=function(){var params,selector,_base1,_ref,_results;typeof (_base1=_this.productListing).custom=="function"&&_base1.custom();if(_this.productListing.selectors){_ref=_this.productListing.selectors,_results=[];for(selector in _ref)params=_ref[selector],_results.push(doInitProducts(selector,params));return _results}return doInitProducts(_this.productListing.image,_this.productListing)},$(initProducts),Q(window).load(initProducts),Q.setInterval(initProducts,2e3),_this.productListing.image&&(that=_this,Q("body").delegate(_this.productListing.image,"mouseenter",function(){var a,href,img,productData;img=this,a=$(img).parents("a"),href=a.prop("href"),productData=that.productListing.productData.call(that,href,a,$(img));if(productData)return that.initProductEl(this,productData,{overlay:!1})}))):(window.initProducts=initProducts=function(){var a,contEl,href,img,imgEl,productSid,_i,_len,_ref,_results;_ref=$(_this.productListing.image),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),href=a.prop("href"),productSid=_this.productListing.productSid.call(_this,href,a,$(img)),productSid?_this.productListing.container&&$(img).parents(_this.productListing.container).length?(contEl=$(img).parents(_this.productListing.container),_this.initProductEl(contEl,{productSid:productSid},{image:!1,overlayZIndex:_this.productListing.overlayZIndex,overlayPosition:_this.productListing.overlayPosition}),_results.push(function(){var _j,_len1,_ref1,_results1;_ref1=a.find("img"),_results1=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++)imgEl=_ref1[_j],_results1.push(this.initProductEl(imgEl,{productSid:productSid},{overlay:!1}));return _results1}.call(_this))):_results.push(_this.initProductEl(img,{productSid:productSid},{overlayPosition:_this.productListing.overlayPosition})):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),Q.setInterval(initProducts,2e3))),$(function(){var lastProductSid,overlay,overlayEl,update,_base1,_ref,_ref1;if((_ref=_this.productPage)!=null?typeof _ref.test=="function"?_ref.test():void 0:void 0)return console.debug("product page"),_this.productPage.initPage&&_this.productPage.initPage.call(_this),_this.productPage.mode===2?(_this.productPage.overlay&&((_base1=_this.productPage).hideOverlay==null&&(_base1.hideOverlay=!0),overlay=_this.productPage.overlay,Q("body").delegate(overlay,"mouseover",function(){var down,event;return $(overlay).unbind(".agora"),down=!1,event=null,Q(overlay).bind("mousedown.agora",function(e){return down=!0,Q("html").disableSelection(),e.preventDefault(),event=e,!0}).bind("mouseup.agora",function(){return down=!1,!0}).bind("mousemove.agora",function(e){var el,selector,_i,_len,_ref1;if(down){down=!1,selector=_this.productPage.image,_ref1=$(selector);for(_i=0,_len=_ref1.length;_i<_len;_i++)el=_ref1[_i],_this.clearProductEl(el),_this.initProductEl(el,{productSid:_this.productPage.productSid.call(_this),variant:_this.productPage.variant},{overlay:!1});return setTimeout(function(){return _this.productPage.hideOverlay&&Q(overlay).hide(),console.debug($(selector)),$(selector).trigger(event),$("html").one("mouseup",function(){$("html").enableSelection();if(_this.productPage.hideOverlay)return $(overlay).show()})},100)}})})),_this.productPage.image&&(that=_this,lastProductSid=null,Q("body").delegate(_this.productPage.image,"mouseenter",function(){var img,productSid;return img=this,productSid=that.productPage.productSid.call(that),that.clearProductEl(this),that.initProductEl(this,{productSid:productSid,variant:that.productPage.variant},{overlay:!1})})),update=function(){var _ref1,_ref2;return console.debug(_this.productPage.productSid.call(_this)),_this.removeOverlay($(_this.productPage.attach)),_this.attachOverlay({attachEl:$(_this.productPage.attach),positionEl:$((_ref1=_this.productPage.position)!=null?_ref1:_this.productPage.image),productData:{productSid:_this.productPage.productSid.call(_this)},overlayZIndex:(_ref2=_this.productPage.zIndex)!=null?_ref2:9999,init:function(overlay){return overlay.addAlwaysShow("productPage")}})},_this.waitFor(_this.productPage.attach,function(){return lastProductSid=null,Q.setInterval(function(){var productSid;productSid=_this.productPage.productSid.call(_this);if(productSid&&productSid!==lastProductSid)return lastProductSid=productSid,update()},500)})):(_this.productPage.overlayEl&&(overlayEl=_this.productPage.overlayEl,Q("body").delegate(overlayEl,"mouseover",function(){var down,event;return $(overlayEl).unbind(".agora"),down=!1,event=null,Q(overlayEl).bind("mousedown.agora",function(e){return down=!0,Q("html").disableSelection(),e.preventDefault(),event=e,!0}).bind("mouseup.agora",function(){return down=!1,!0}).bind("mousemove.agora",function(e){var selector;if(down)return down=!1,selector=_this.productPage.imgEl,setTimeout(function(){return Q(overlayEl).hide(),$(selector).trigger(event),$("html").one("mouseup",function(){return $("html").enableSelection(),$(overlayEl).show()})},100)})})),update=function(){var el,_ref1;return console.debug(_this.productPage.productSid.call(_this)),_this.productPage.initProduct?_this.productPage.initProduct.call(_this):(el=_this.productPage.imgEl,_this.clearProductEl(el),_this.initProductEl(el,{productSid:_this.productPage.productSid.call(_this)},{overlayZIndex:(_ref1=_this.productPage.overlayZIndex)!=null?_ref1:1e3,initOverlay:function(overlay){return overlay.addAlwaysShow("productPage")}}))},_this.waitFor((_ref1=_this.productPage.waitFor)!=null?_ref1:_this.productPage.imgEl,function(){return lastProductSid=null,Q.setInterval(function(){var productSid;productSid=_this.productPage.productSid.call(_this);if(productSid&&productSid!==lastProductSid)return lastProductSid=productSid,update()},1e3)}))})}}(this))},DataDrivenSiteInjector}(SiteInjector)}}}),define("client/Debug",[],function(){return function(){var Debug;return Debug=function(){function Debug(){}return Debug.stackTrace=function(){var trace;return trace=Error().stack,trace=trace.split("\n").slice(3,-2),_.map(trace,function(line){var matches;matches=line.match(/at (.*?) \(/);if(matches)return matches[1]})},Debug.log=function(){var args,caller,i,ignoreList,item,list,matched,trace,_i,_j,_len,_len1;ignoreList=[["triggerBackgroundEvent","DeleteView"],["triggerBackgroundEvent"],["callBackgroundMethod"],[/^listen/],[/^stopListening/],["CLIENT:"],[/^Process/],["ConnectView"],["ReceivedRequest"]];for(_i=0,_len=ignoreList.length;_i<_len;_i++){list=ignoreList[_i],matched=!0;for(i=_j=0,_len1=list.length;_j<_len1;i=++_j){item=list[i],typeof item=="string"?arguments[i]!==item&&(matched=!1):item.exec(arguments[i])||(matched=!1);if(!matched)break}if(matched)return}return trace=this.stackTrace(),args=Array.prototype.slice.call(arguments,0,arguments.length),caller=trace[1],args.unshift("CLIENT:"),console.debug.apply(console,args)},Debug}()}}),define("client/devAction",[],function(){return function(){var devAction;return console.debug("devAction"),devAction={reloadDevAction:function(){return window.devActionReloaded=!0,chrome.runtime.sendMessage({action:"reloadModules",modules:["devAction"]})},devAction:function(){return Q.undo(),View.clear(),$(".-agora").remove(),chrome.runtime.sendMessage({action:"reloadModules",modules:["views/SocialShareView","DataDrivenSiteInjector","views/compare/CompareView",{module:"../sites/Zappos/ZapposSiteInjector",className:"SpecificSiteInjector"}]}),setTimeout(function(){return reloadStyles(),doSiteInjection()},1e3)}},window.devActionReloaded&&(delete window.devActionReloaded,devAction.devAction()),devAction}}),define("client/Frame",[],function(){return function(){var Frame,center,positionForAboveCentered,positioned,relativeToScreen;return positionForAboveCentered=function(p,sateliteEl,contEl){var distance,margin,top,_ref,_ref1,_ref2;return margin=10,distance=(_ref=(_ref1=sateliteEl.data("args"))!=null?_ref1.distance:void 0)!=null?_ref:10,top=((_ref2=sateliteEl.data("args"))!=null?_ref2.position:void 0)==="below"?p.top+distance:p.top-sateliteEl.height()-distance,{left:Math.max(margin+window.scrollX,Math.min(p.left-sateliteEl.width()/2,window.scrollX+contEl.width()-sateliteEl.width()-margin)),top:top}},center=function(el,frameEl){var top,_ref;return top=((_ref=frameEl.data("args"))!=null?_ref.position:void 0)==="below"?el.offset().top+el.height():el.offset().top,{left:el.offset().left+el.outerWidth()/2,top:top}},relativeToScreen=function(position){return{left:position.left-window.scrollX,top:position.top-window.scrollY}},positioned=function(pos,position){return position==null&&(position="absolute"),{position:position,left:pos.left,top:pos.top}},Frame=function(){function Frame(){}return Frame.wrapInFrame=function(el,args){var clientEl,close,frameEl,pos,_ref;args==null&&(args={}),args.type==null&&(args.type="hover"),frameEl=null,close=function(){return Frame.close(frameEl)};switch(args.type){case"ds":pos=(_ref=args.pos)!=null?_ref:"top",frameEl=$("<table class='-agora v-frame "+pos+"'> <tr><td class='tl'></td><td class='t'></td><td class='tr'></td></tr> <tr><td class='l'></td><td class='c'><div class='client'></div></td><td class='r'></td></tr> <tr><td class='bl'></td><td class='b'></td><td class='br'></td></tr> </table>");break;case"hover":frameEl=$("<div class='-agora v-frame'> <div class='client' /> </div>");break;case"balloon":frameEl=$('<div class="-agora v-frame"> <span class="-string" /> <div class="client" /> </div>'),args.color==="dark"&&frameEl.addClass("dark");break;case"tooltip":frameEl=$('<div class="-agora v-frame"> <span class="-arrow" /> <div class="client" /> </div>');break;case"fullscreen":frameEl=$("<div class='-agora v-frame'> <div class='client' /> </div>").scroll(function(e){return e.stopPropagation()})}return frameEl.addClass(args.type),frameEl.data("args",args),args.close&&(frameEl.append($('<a href="#" class="close" />').click(function(){return close(),!1})),util.tooltip(frameEl.find(".close"),"close")),clientEl=frameEl.find(".client"),args.scroll&&clientEl.css({overflow:"auto"}),frameEl.data("client",clientEl),args.width&&clientEl.width(args.width),args.height&&clientEl.height(args.height),clientEl.append(el).end(),frameEl},Frame.updatePositionClass=function(frameEl){return frameEl.data("position")&&frameEl.removeClass(frameEl.data("position")),frameEl.addClass(frameEl.data("args").position),frameEl.data("position",frameEl.data("args").position)},Frame.fixFrameAt=function(position,frameEl,contEl){var aw,bp,p,w;contEl==null&&(contEl=$(window)),this.updatePositionClass(frameEl),frameEl.css({position:"absolute"}),frameEl.css(positioned(relativeToScreen(positionForAboveCentered(position,frameEl,contEl)),"fixed"));if(frameEl.hasClass("ds"))return p=Math.max(15,Math.min(position.left-frameEl.offset().left,frameEl.width()-15)),w=634,aw=8,bp=(w-aw)/2+p,frameEl.find(".b").css({backgroundPosition:""+bp+"px 0"});if(frameEl.hasClass("balloon"))return p=Math.max(15,Math.min(position.left-frameEl.offset().left,frameEl.width()-15)),frameEl.find(".-string").css({left:p});if(frameEl.hasClass("tooltip"))return p=Math.max(2,Math.min(position.left-frameEl.offset().left,frameEl.width()-2)),w=14,aw=14,bp=(w-aw)/2+p,frameEl.find(".-arrow").css({left:p})},Frame.positionFrameAboveAndCentered=function(anchorEl,frameEl,contEl){var aw,bp,p,w;contEl==null&&(contEl=$(window)),this.updatePositionClass(frameEl),frameEl.css({position:"absolute"}),frameEl.css(positioned(positionForAboveCentered(center(anchorEl,frameEl),frameEl,contEl)));if(frameEl.hasClass("ds"))return p=anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,w=634,aw=8,bp=(w-aw)/2+p,frameEl.find(".b").css({backgroundPosition:""+bp+"px 0"});if(frameEl.hasClass("balloon"))return p=Math.max(2+scroll,Math.min(anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,frameEl.width()-2)),frameEl.find(".-string").css({left:p});if(frameEl.hasClass("tooltip"))return p=Math.max(2,Math.min(anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,frameEl.width()-2)),frameEl.find(".-arrow").css({left:p})},Frame.fixFrameAboveAndCentered=function(anchorEl,frameEl,contEl){return contEl==null&&(contEl=null),this.fixFrameAt(center(anchorEl,frameEl),frameEl,contEl)},Frame.setFrameAboveAndCentered=function(anchorEl,frameEl,contEl){var el;contEl==null&&(contEl=null),el=anchorEl;while(el.get(0)!==document.body){if(el.css("position")==="fixed"){this.fixFrameAboveAndCentered(anchorEl,frameEl,contEl);return}el=el.offsetParent()}return this.positionFrameAboveAndCentered(anchorEl,frameEl,contEl)},Frame.fixAtEl=function(anchorEl,frameEl){return this.fixFrameAt(center(anchorEl),frameEl,$(window))},Frame.positionInCenterOfScreen=function(frameEl){var resize,resizeTimerId;return frameEl.css({position:"absolute"}),resize=function(){var height,width,_base,_ref;return frameEl.data("args").resize&&(_ref=typeof (_base=frameEl.data("args")).resize=="function"?_base.resize($(window).width(),$(window).height()):void 0,width=_ref[0],height=_ref[1],frameEl.data("client").width(width).height(height).triggerHandler("resize")),frameEl.css({left:($(window).width()-frameEl.width())/2+window.scrollX,top:($(window).height()-frameEl.height())/2+window.scrollY}),!0},resizeTimerId=null,$(window).resize(function(){return frameEl.parent().get(0)?(clearTimeout(resizeTimerId),resizeTimerId=setTimeout(resize,10)):$(window).unbind("resize",arguments.callee)}),resize(),setTimeout(resize,10)},Frame.close=function(frameEl,animate){var _ref,_ref1;animate==null&&(animate=!0);if(!$.contains(document,frameEl.get(0)))return;return frameEl.data("args").type==="fullscreen"&&($(document.body).removeClass("-agora-modelOpen"),$(".-agora-fullscreenOverlay").remove(),delete this.currentFullscreenFrameEl),frameEl.unbind(),animate?frameEl.fadeOut(_.isNumber(animate)?animate:200,function(){var _ref,_ref1;return(_ref=frameEl.data("args"))!=null&&typeof _ref.onClose=="function"&&_ref.onClose(),(_ref1=frameEl.data("args"))!=null&&typeof _ref1.close=="function"&&_ref1.close(),frameEl.remove()}):((_ref=frameEl.data("args"))!=null&&typeof _ref.onClose=="function"&&_ref.onClose(),(_ref1=frameEl.data("args"))!=null&&typeof _ref1.close=="function"&&_ref1.close(),frameEl.remove())},Frame.show=function(frameEl){var resize,resizeTimerId;return frameEl.data("args").type==="fullscreen"&&(this.currentFullscreenFrameEl&&this.close(this.currentFullscreenFrameEl),this.currentFullscreenFrameEl=frameEl,resize=function(){return frameEl.data("client").triggerHandler("resize"),!0},resizeTimerId=null,Q(window).resize(function(){return frameEl.parent().get(0)?(clearTimeout(resizeTimerId),resizeTimerId=setTimeout(resize,10)):$(window).unbind("resize",arguments.callee)}),resize(),Q(document.body).addClass("-agora-modelOpen")),frameEl.css({opacity:0}).animate({opacity:1},100)},Frame.frame=function(el,args){var frame;return args==null&&(args=null),frame=new Frame,frame.args=args!=null?args:{},frame.el=Frame.wrapInFrame(el,frame.args),frame.el.data("frame",frame),frame},Frame.frameFixedAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame.frame(el,args),frame.showFixedAbove(anchorEl),frame},Frame.showPositionedAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame.frame(el,args),frame.showPositionedAbove(anchorEl),frame},Frame.frameAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame.frame(el,args),(args!=null?args.parent:void 0)&&frame.el.appendTo(args.parent),frame.showAbove(anchorEl),frame},Frame.frameAround=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame.frame(el,args),frame.showAround(anchorEl),frame},Frame.prototype.shown=function(){return this.el.parent().length},Frame.prototype.showFixedAbove=function(el){return this.shown()||this.el.appendTo(document.body),this.update=function(_this){return function(){return Frame.fixFrameAboveAndCentered(el,_this.el)}}(this),this.update(),Frame.show(this.el)},Frame.prototype.showPositionedAbove=function(el){return this.shown()||this.el.appendTo(document.body),Frame.positionFrameAboveAndCentered(el,this.el),Frame.show(this.el)},Frame.prototype.showAbove=function(el){return this.shown()||this.el.appendTo(document.body),this.update=function(_this){return function(){return Frame.setFrameAboveAndCentered(el,_this.el)}}(this),this.update(),Frame.show(this.el)},Frame.prototype.showAround=function(el){var _base;(_base=this.args).position==null&&(_base.position="above"),this.showAbove(el);if(this.args.position==="above"&&this.el.offset().top<$(window).scrollTop())return this.args.position="below",this.showAbove(el)},Frame.prototype.show=function(){return this.shown()||this.el.appendTo(document.body),Frame.show(this.el)},Frame.prototype.close=function(animate){return animate==null&&(animate=!0),Frame.close(this.el,animate)},Frame}()}}),define("client/Frame2",[],function(){return function(){var Frame2,center,positionForAboveCentered,positioned,relativeToScreen;return positionForAboveCentered=function(p,sateliteEl,contEl){var distance,margin,top,_ref,_ref1,_ref2;return margin=10,distance=(_ref=(_ref1=sateliteEl.data("args"))!=null?_ref1.distance:void 0)!=null?_ref:10,top=((_ref2=sateliteEl.data("args"))!=null?_ref2.position:void 0)==="below"?p.top+distance:p.top-sateliteEl.height()-distance,{left:Math.max(margin,Math.min(p.left-sateliteEl.width()/2,contEl.width()-sateliteEl.width()-margin)),top:top}},center=function(el,frameEl){var top,_ref;return top=((_ref=frameEl.data("args"))!=null?_ref.position:void 0)==="below"?el.offset().top+el.height():el.offset().top,{left:el.offset().left+el.outerWidth()/2,top:top}},relativeToScreen=function(position){return{left:position.left,top:position.top-window.scrollY}},positioned=function(pos,position){return position==null&&(position="absolute"),{position:position,left:pos.left,top:pos.top}},Frame2=function(){function Frame2(){}return Frame2.center=center,Frame2.wrapInFrame=function(el,args){var clientEl,close,frameEl,pos,_ref;args==null&&(args={}),args.type==null&&(args.type="hover"),frameEl=null,close=function(){return Frame2.close(frameEl)};switch(args.type){case"ds":pos=(_ref=args.pos)!=null?_ref:"top",frameEl=$("<table class='-agora v-frame "+pos+"'> <tr><td class='tl'></td><td class='t'></td><td class='tr'></td></tr> <tr><td class='l'></td><td class='c'><div class='client'></div></td><td class='r'></td></tr> <tr><td class='bl'></td><td class='b'></td><td class='br'></td></tr> </table>");break;case"hover":frameEl=$("<div class='-agora v-frame'> <div class='client' /> </div>");break;case"balloon":frameEl=$('<div class="-agora v-frame"> <span class="-string" /> <div class="client" /> </div>'),args.color==="dark"&&frameEl.addClass("dark");break;case"tooltip":frameEl=$('<div class="-agora v-frame"> <span class="-arrow" /> <div class="client" /> </div>');break;case"fullscreen":frameEl=$("<div class='-agora v-frame'> <div class='client' /> </div>").scroll(function(e){return e.stopPropagation()})}return frameEl.addClass(args.type),frameEl.data("args",args),args.close&&(frameEl.append($('<a href="#" class="close" />').click(function(){return close(),!1})),util.tooltip(frameEl.find(".close"),"close")),clientEl=frameEl.find(".client"),args.scroll&&clientEl.css({overflow:"auto"}),frameEl.data("client",clientEl),args.width&&clientEl.width(args.width),args.height&&clientEl.height(args.height),clientEl.append(el).end(),frameEl},Frame2.updatePositionClass=function(frameEl){return frameEl.data("position")&&frameEl.removeClass(frameEl.data("position")),frameEl.addClass(frameEl.data("args").position),frameEl.data("position",frameEl.data("args").position)},Frame2.fixFrameAt=function(position,frameEl,contEl){var aw,bp,p,w;contEl==null&&(contEl=$(window)),this.updatePositionClass(frameEl),frameEl.css({position:"absolute"}),frameEl.css(positioned(relativeToScreen(positionForAboveCentered(position,frameEl,contEl)),"fixed"));if(frameEl.hasClass("ds"))return p=Math.max(15,Math.min(position.left-frameEl.offset().left,frameEl.width()-15)),w=634,aw=8,bp=(w-aw)/2+p,frameEl.find(".b").css({backgroundPosition:""+bp+"px 0"});if(frameEl.hasClass("balloon"))return p=Math.max(15,Math.min(position.left-frameEl.offset().left,frameEl.width()-15)),frameEl.find(".-string").css({left:p});if(frameEl.hasClass("tooltip"))return p=Math.max(2,Math.min(position.left-frameEl.offset().left,frameEl.width()-2)),w=14,aw=14,bp=(w-aw)/2+p,frameEl.find(".-arrow").css({left:p})},Frame2.positionFrameAboveAndCentered=function(anchorEl,frameEl,contEl){var aw,bp,p,w;contEl==null&&(contEl=$(window)),this.updatePositionClass(frameEl),frameEl.css({position:"absolute"}),frameEl.css(positioned(positionForAboveCentered(center(anchorEl,frameEl),frameEl,contEl)));if(frameEl.hasClass("ds"))return p=anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,w=634,aw=8,bp=(w-aw)/2+p,frameEl.find(".b").css({backgroundPosition:""+bp+"px 0"});if(frameEl.hasClass("balloon"))return p=Math.max(2,Math.min(anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,frameEl.width()-2)),frameEl.find(".-string").css({left:p});if(frameEl.hasClass("tooltip"))return p=Math.max(2,Math.min(anchorEl.offset().left+anchorEl.outerWidth()/2-frameEl.offset().left,frameEl.width()-2)),frameEl.find(".-arrow").css({left:p})},Frame2.fixFrameAboveAndCentered=function(anchorEl,frameEl,contEl){return contEl==null&&(contEl=null),this.fixFrameAt(center(anchorEl,frameEl),frameEl,contEl)},Frame2.setFrameAboveAndCentered=function(anchorEl,frameEl,contEl){var el;contEl==null&&(contEl=null),el=anchorEl;while(el.get(0)!==document.body){if(el.css("position")==="fixed"){this.fixFrameAboveAndCentered(anchorEl,frameEl,contEl);return}el=el.offsetParent()}return this.positionFrameAboveAndCentered(anchorEl,frameEl,contEl)},Frame2.fixAtEl=function(anchorEl,frameEl){return this.fixFrameAt(center(anchorEl),frameEl,$(window))},Frame2.positionInCenterOfScreen=function(frameEl){var resize,resizeTimerId;return frameEl.css({position:"absolute"}),resize=function(){var height,width,_base,_ref;return frameEl.data("args").resize&&(_ref=typeof (_base=frameEl.data("args")).resize=="function"?_base.resize($(window).width(),$(window).height()):void 0,width=_ref[0],height=_ref[1],frameEl.data("client").width(width).height(height).triggerHandler("resize")),frameEl.css({left:($(window).width()-frameEl.width())/2,top:($(window).height()-frameEl.height())/2+scrollY}),!0},resizeTimerId=null,$(window).resize(function(){return frameEl.parent().get(0)?(clearTimeout(resizeTimerId),resizeTimerId=setTimeout(resize,10)):$(window).unbind("resize",arguments.callee)}),resize(),setTimeout(resize,10)},Frame2.close=function(frameEl,animate){var _ref,_ref1;animate==null&&(animate=!0);if(!$.contains(document,frameEl.get(0)))return;return frameEl.data("args").type==="fullscreen"&&($(document.body).removeClass("-agora-modelOpen"),$(".-agora-fullscreenOverlay").remove(),delete this.currentFullscreenFrameEl),frameEl.unbind(),animate?frameEl.fadeOut(200,function(){var _ref,_ref1;return(_ref=frameEl.data("args"))!=null&&typeof _ref.onClose=="function"&&_ref.onClose(),(_ref1=frameEl.data("args"))!=null&&typeof _ref1.close=="function"&&_ref1.close(),frameEl.remove()}):((_ref=frameEl.data("args"))!=null&&typeof _ref.onClose=="function"&&_ref.onClose(),(_ref1=frameEl.data("args"))!=null&&typeof _ref1.close=="function"&&_ref1.close(),frameEl.remove())},Frame2.show=function(frameEl){var resize,resizeTimerId;return frameEl.data("args").type==="fullscreen"&&(this.currentFullscreenFrameEl&&this.close(this.currentFullscreenFrameEl),this.currentFullscreenFrameEl=frameEl,resize=function(){return frameEl.data("client").triggerHandler("resize"),!0},resizeTimerId=null,Q(window).resize(function(){return frameEl.parent().get(0)?(clearTimeout(resizeTimerId),resizeTimerId=setTimeout(resize,10)):$(window).unbind("resize",arguments.callee)}),resize(),Q(document.body).addClass("-agora-modelOpen")),frameEl.css({opacity:0}).animate({opacity:1},100)},Frame2.frame=function(el,args){var frame;return args==null&&(args=null),frame=new Frame2,frame.args=args!=null?args:{},frame.el=Frame2.wrapInFrame(el,frame.args),frame.el.data("frame",frame),frame},Frame2.frameFixedAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame2.frame(el,args),frame.showFixedAbove(anchorEl),frame},Frame2.showPositionedAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame2.frame(el,args),frame.showPositionedAbove(anchorEl),frame},Frame2.frameAbove=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame2.frame(el,args),(args!=null?args.parent:void 0)&&frame.el.appendTo(args.parent),frame.showAbove(anchorEl),frame},Frame2.frameAround=function(anchorEl,el,args){var frame;return args==null&&(args=null),frame=Frame2.frame(el,args),frame.showAround(anchorEl),frame},Frame2.prototype.shown=function(){return this.el.parent().length},Frame2.prototype.showFixedAbove=function(el){return this.shown()||this.el.appendTo(document.body),this.update=function(_this){return function(){return Frame2.fixFrameAboveAndCentered(el,_this.el)}}(this),this.update(),Frame2.show(this.el)},Frame2.prototype.showPositionedAbove=function(el){return this.shown()||this.el.appendTo(document.body),Frame2.positionFrameAboveAndCentered(el,this.el),Frame2.show(this.el)},Frame2.prototype.showAbove=function(el){return this.shown()||this.el.appendTo(document.body),this.update=function(_this){return function(){return Frame2.setFrameAboveAndCentered(el,_this.el)}}(this),this.update(),Frame2.show(this.el)},Frame2.prototype.showAround=function(el){var _base;(_base=this.args).position==null&&(_base.position="above"),this.showAbove(el);if(this.args.position==="above"&&this.el.offset().top<$(window).scrollTop())return this.args.position="below",this.showAbove(el)},Frame2.prototype.show=function(){return this.shown()||this.el.appendTo(document.body),Frame2.show(this.el)},Frame2.prototype.close=function(animate){return animate==null&&(animate=!0),Frame2.close(this.el,animate)},Frame2}()}}),define("client/icons",[],function(){return{d:[],c:function(){return{get:function(type,opts){var component,components,file,has2x,i,map,name,position,size,sizes,systems,_i,_len,_ref;opts==null&&(opts={}),systems={computer:["harddrive","monitor","cpu","ram","motherboard","graphicsCard","powerSupply","keyboard","mouse","soundcard","cooling","speakers"]},map={};for(name in systems){components=systems[name];for(i=_i=0,_len=components.length;_i<_len;i=++_i)component=components[i],map[component]={system:name,position:i}}file=position=size=null,has2x=!0,file=type,opts.color==null&&(opts.color="darkGray"),opts.inverted&&(file+="(inverted)");if(opts.color==="white")file+="White";else if(opts.color==="lightGray")file+="LightGray";else{if(opts.color!=="darkGray")throw new Error("invalid color");file+="DarkGray"}return opts.size==="large"&&(file+="Large"),has2x&&typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>1&&(file+="@2x"),sizes=opts.inverted?{}:opts.size==="large"?{babyToy:{width:102,height:103},list:{width:109,height:117},trousers:{width:93,height:82}}:{list:{width:24,height:24},computer:{width:30,height:32},bundle:{width:30,height:27},babyToy:{width:30,height:30},trousers:{width:24,height:21}},size=(_ref=sizes[type])!=null?_ref:{width:48,height:48},opts.size==="small"&&(size.width/=2,size.height/=2),{position:position,file:"images/icons/"+file+".png",size:size}},setIcon:function(el,type,opts){var iconInfo,_ref;opts==null&&(opts={});if(!type)return this.clearIcon(el);iconInfo=this.get(type,opts),((_ref=opts.itemClass)!=null?_ref:!0)&&el.addClass("t-item"),opts.inverted&&el.addClass("icon-inverted"),iconInfo.position?el.css({backgroundPosition:"-"+iconInfo.position.left+"px -"+iconInfo.position.top+"px"}):el.css({backgroundPosition:"center"}),el.css({backgroundImage:"url('"+contentScript.resourceUrl(iconInfo.file)+"')",backgroundRepeat:"no-repeat"});if(opts.size==="contain")return el.css({backgroundSize:"contain"});if(iconInfo.size)return el.css({backgroundSize:""+iconInfo.size.width+"px "+iconInfo.size.height+"px"})},clearIcon:function(el){return el.removeClass("icon-inverted"),el.css({backgroundPosition:"",backgroundImage:"",backgroundRepeat:""})}}}}}),define("client/Observable",[],function(){return function(){var Observable;return Observable=function(){function Observable(){}return Observable.prototype.observe=function(event,observer){return this.observers==null&&(this.observers={}),this.observers[event]?this.observers[event].push(observer):this.observers[event]=[observer]},Observable.prototype.trigger=function(event){var observer,_i,_len,_ref,_results;if(this.observers[event]){_ref=this.observers[event],_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)observer=_ref[_i],_results.push(observer.apply(null,Array.prototype.slice.call(arguments,1)));return _results}},Observable}()}});var __slice=[].slice;define("client/SiteInjector",[],function(){return{d:["View","views/ProductOverlayView","Frame","util"],c:function(){var ChangeCapsule,SiteInjector,showingModal,textMap;return showingModal=!1,textMap={AccessWorkspace:"Click on the preview to access the Workspace for this Decision.",AccessProductPortalFromWorkspace:"Click on the product's image to access the Product Portal.",AccessProductPortalFromPopup:"Click on the product's image to access the Product Portal.",Workspace:"The Workspace is an open-ended product comparison environment. It displays the product considerations of a Decision in a fullscreen view. Press the ESC key or click the close button at the top right to exit.","Workspace/Dismiss":"Click the X to dismiss a product you’re considering off to the side. Click a dismissed product to return it.",Select:"Click the checkmark to select the item as one you have chosen among your considerations. The Decision will then be represented by that — as well as any other item you have selected — on the Belt and in the Workspace.","Workspace/ReturnToParent":"You can return to the main Decision by click this thumbnail.","Belt/RemoveItem":"To remove a product from the Belt, simply drag it off.",AddFeeling:"You can record the feelings and thoughts you have about the products you are shopping for. Type a thought or feeling and press enter, or just press ESC to close this dialog and continue on to the next step.",AddData:"You can paste links to blogs, videos, or other websites that have information related to the product and hit enter to add the attached content feed.",AccessEditDescriptor:"Edit your decision.",EditDescriptor:"Describe what you're shopping for."},window._tutorial=function(type,el,args){el==null&&(el=null),args==null&&(args=null);if(showingModal||window.tutorialInProgress)return;return contentScript.triggerBackgroundEvent("tutorialCheck",type,function(showTutorial){var cb,close,closed;if(showTutorial)return close=null,closed=!1,cb=null,args?_.isFunction(args)?(cb=args,args={}):cb=args.cb:args={},el||(args.close=!0),typeof cb=="function"&&cb(function(delay){return delay==null&&(delay=!0),close?close(delay):closed=!0}),setTimeout(function(){var attachEl,connectorEl,currentPosition,distance,elPos,offsetParent,offsetParentPos,pos,position,positionEl,setPosition,text,tipEl;if(closed||showingModal)return;return text=textMap[showTutorial],tipEl=$("<div class='-agora tip'>"+text+"</div>"),tipEl.css({position:"absolute",width:200,opacity:0}),args.close&&(tipEl.addClass("hasClose"),tipEl.append($('<span class="close" />').click(function(){return close(!1),showingModal=!1})),util.tooltip(tipEl.find(".close"),"close")),close=function(delay){return delay==null&&(delay=!0),delay?setTimeout(function(){return close(!1)},300):tipEl.fadeOut(function(){return tipEl.remove()})},el?(position="right",_.isArray(el)&&(_.isArray(type)?el=el[type.indexOf(showTutorial)]:el=el[0]),attachEl=positionEl=null,el.attachEl&&el.positionEl?(attachEl=el.attachEl,positionEl=el.positionEl,el.position&&(position=el.position)):(attachEl=el.parent(),positionEl=el),tipEl.append('<div class="connector" />'),attachEl.append(tipEl),offsetParent=util.positioned(attachEl),offsetParentPos=offsetParent.offset(),elPos=positionEl.offset(),pos={left:elPos.left-offsetParentPos.left,top:elPos.top-offsetParentPos.top},distance=20,currentPosition=null,setPosition=function(position){currentPosition=position;if(position==="right")return tipEl.css({left:pos.left+positionEl.width()+distance,top:pos.top+positionEl.outerHeight()/2-tipEl.outerHeight()/2}),tipEl.offset().left+tipEl.width()<=$(window).width();if(position==="left")return tipEl.css({left:pos.left-tipEl.outerWidth()-distance,top:pos.top+positionEl.outerHeight()/2-tipEl.outerHeight()/2}),tipEl.offset().left>=0;if(position==="top")return tipEl.css({top:pos.top-tipEl.outerHeight()-distance,left:pos.left+positionEl.outerWidth()/2-tipEl.outerWidth()/2}),tipEl.offset().left>=0;if(position==="bottom")return tipEl.css({top:pos.top+positionEl.outerHeight()+distance,left:pos.left+positionEl.outerWidth()/2-tipEl.outerWidth()/2}),tipEl.offset().left>=0},setPosition(position)||(position==="right"?setPosition("left"):position==="top"&&setPosition("bottom")),tipEl.addClass(currentPosition),connectorEl=tipEl.find(".connector"),currentPosition==="left"||currentPosition==="right"?connectorEl.css({top:Math.max(0,Math.min(tipEl.height(),elPos.top-tipEl.offset().top+positionEl.outerHeight()/2-connectorEl.height()/2))}):(currentPosition==="top"||currentPosition==="bottom")&&connectorEl.css({left:Math.max(0,Math.min(tipEl.width(),elPos.left-tipEl.offset().left+positionEl.outerWidth()/2-connectorEl.width()/2))})):(showingModal=!0,tipEl.addClass("modal"),tipEl.appendTo(document.body),tipEl.css({left:$(window).width()/2-tipEl.outerWidth()/2,top:$(window).height()/2-tipEl.outerHeight()/2+$(window).scrollTop()})),tipEl.animate({opacity:1}),setTimeout(function(){return contentScript.triggerBackgroundEvent("tutorialSeen",showTutorial)},500)},50)})},ChangeCapsule=function(){var addChange,changes,func;return changes=[],addChange=function(){var args,type;return type=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],changes.push({type:type,args:args})},func=function(){var args,jq,obj;return args=1<=arguments.length?__slice.call(arguments,0):[],jq=$.apply(null,args),obj={jq:jq,addClass:function(className){return addChange("$.addClass",jq,className),jq.addClass(className),obj},attr:function(name,value){return addChange("$.attr",jq,name,value),jq.attr(name,value),obj},css:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange("$.css",jq,args),jq.css.apply(jq,args),obj},data:function(name,value){return addChange("$.data",jq,name,value),jq.data(name,value),obj},append:function(el){return addChange("$.append",jq,el),jq.append(el),obj},appendTo:function(el){return addChange("$.appendTo",jq,el),jq.appendTo(el),obj},load:function(func){return addChange("$.load",jq,func),jq.load(func),obj},resize:function(func){return addChange("$.resize",jq,func),jq.resize(func),obj},blur:function(func){return addChange("$.blur",jq,func),jq.blur(func),obj},focus:function(func){return addChange("$.focus",jq,func),jq.focus(func),obj},delegate:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange.apply(null,["$.delegate",jq].concat(__slice.call(args))),jq.delegate.apply(jq,args),obj},bind:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange.apply(null,["$.bind",jq].concat(__slice.call(args))),jq.bind.apply(jq,args),obj},hide:function(){return addChange("$.hide",jq),jq.hide(),obj},disableSelection:function(){return addChange("$.disableSelection",jq),jq.disableSelection(),obj},mouseenter:function(func){return addChange("$.mouseenter",jq,func),jq.mouseenter(func),obj},mouseleave:function(func){return addChange("$.mouseleave",jq,func),jq.mouseleave(func),obj}}},_.extend(func,{setTimeout:function(func,time){var id;return id=setTimeout(func,time),addChange("setTimeout",id),id},setInterval:function(func,time){var id;return id=setInterval(func,time),addChange("setInterval",id),id},undo:function(){var args,i,type,_i,_ref,_ref1,_results;_results=[];for(i=_i=_ref=changes.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i){_ref1=changes[i],type=_ref1.type,args=_ref1.args;switch(type){case"setTimeout":_results.push(clearTimeout(args[0]));break;case"setInterval":_results.push(clearInterval(args[0]));break;case"$.addClass":_results.push(args[0].removeClass(args[1]));break;case"$.attr":_results.push(args[0].removeAttr(args[1]));break;case"$.data":_results.push(args[0].data(args[1],null));break;case"$.append":_results.push($(args[1]).remove());break;case"$.appendTo":_results.push(args[0].remove());break;case"$.load":_results.push(args[0].unbind("load",args[1]));break;case"$.blur":_results.push(args[0].unbind("blur",args[1]));break;case"$.focus":_results.push(args[0].unbind("focus",args[1]));break;case"$.delegate":_results.push(args[0].undelegate(args[1],args[2],args[3]));break;case"$.bind":_results.push(args[0].unbind(args[1],args[2]));break;case"$.hide":_results.push(args[0].show());break;case"$.disableSelection":_results.push(args[0].enableSelection());break;case"$.mouseenter":_results.push(args[0].unbind("mouseenter",args[1]));break;case"$.mouseleave":_results.push(args[0].unbind("mouseleave",args[1]));break;default:_results.push(void 0)}}return _results}}),func},SiteInjector=function(){SiteInjector.prototype.onOldVersion=function(){if(!this.alertedOldVersion)return this.alertedOldVersion=!0,this.shoppingBarView.el.addClass("reload")};function SiteInjector(contentScript,continueTutorial,siteName){this.contentScript=contentScript,this.continueTutorial=continueTutorial,this.siteName=siteName,window.Q=this.c=ChangeCapsule()}return SiteInjector.prototype.waitFor=function(query,cb){var interval,queryString;return interval=0,typeof query=="string"&&(queryString=query,query=function(_this){return function(){return _this.contentScript.querySelector(queryString)}}(this)),this.c.setTimeout(function(_this){return function(){var r;return r=null,(r=query())?cb(r):_this.c.setTimeout(arguments.callee,interval)}}(this),interval)},SiteInjector.prototype.run=function(){return!0},SiteInjector.prototype.initPage=function(cb){var initTimer;return initTimer=this.c.setInterval(function(_this){return function(){var callWhen,callWhenNot,doTutorial,stepStartTime,tutorialDialog,tutorialSteps;if(document.body){Agora.dev&&Q("body").addClass("-agora-dev"),clearInterval(initTimer),cb(),callWhen=function(el,cb){var timerId;return timerId=setInterval(function(){if($(el).length)return cb(),clearInterval(timerId)},50)},callWhenNot=function(el,cb){var timerId;return timerId=setInterval(function(){if(!$(el).length)return cb(),clearInterval(timerId)},50)};if(_this.continueTutorial)return window.tutorialInProgress=!0,window.suppressPopups=!0,tutorialSteps=[function(next){return _this.waitFor(function(){var el;el=$(".-agora.v-shoppingBar .actions .moveUp");if(el.length)return el.offset().top>$(window).height()/2},function(){return _this.c.setTimeout(function(){return tutorialDialog.show($(".v-shoppingBar .actions"),{orientation:"above"},{text:"Now click this back arrow to navigate back out of the Decision to the main level of the Belt where you can create new Decisions or add more products to your existing ones.",audio:"http://files.agora.sh/tutorialaudio/12_01.mp3"}),$(".v-shoppingBar .moveUp").one("click",function(){return setTimeout(next,1e3)})},0)})},function(next){return window.suppressShoppingBarMenu=!1,tutorialDialog.show($(".-agora.v-shoppingBar .actions"),{orientation:"above"},{text:"Now let's quickly learn how collaborative shopping works. First, hover over the <b>Belt Menu</b>.",audio:"http://files.agora.sh/tutorialaudio/13_01.mp3"}),callWhen(".-agora .shoppingBarMenu",next)},function(next){return tutorialDialog.show($(".-agora .shoppingBarMenu .sharedWithYou"),{orientation:"right"},{text:"And click the <b>Shared With You</b> icon.",audio:"http://files.agora.sh/tutorialaudio/14_01.mp3"}),callWhen(".-agora .v-sharedWithYou",next)},function(next){return tutorialDialog.show($(".-agora .v-sharedWithYou"),{orientation:"right"},{text:"<p>This menu lists all the things that have been shared with you. If there are items in the list, you can click the checkmarks to add them to your belt.</p> <p>Click the close button at the top right of the window to continue.</p>",audio:"http://files.agora.sh/tutorialaudio/15_01.mp3"}),callWhenNot(".-agora .v-sharedWithYou",next)},function(next){return tutorialDialog.show($(".-agora.v-shoppingBar .decision"),{orientation:"above"},{text:"Next, click this <b>Decision</b>.",audio:"http://files.agora.sh/tutorialaudio/16_01.mp3"}),callWhen(".-agora.v-shoppingBar.Decision",next)},function(next){return tutorialDialog.show($(".-agora.v-shoppingBar .actions .moveUp"),{orientation:"above"},{text:"Now hover over the <b>back button</b>.",audio:"http://files.agora.sh/tutorialaudio/17_01.mp3"}),callWhen(".-agora .shoppingBarMenu",next)},function(next){return tutorialDialog.show($(".-agora .shoppingBarMenu .collaborate"),{orientation:"right"},{text:"And click the <b>Collaborate</b> icon.",audio:"http://files.agora.sh/tutorialaudio/18_01.mp3"}),callWhen(".-agora .v-collaborate",next)},function(next){var id;return tutorialDialog.show($(".-agora .v-collaborate"),{orientation:"right"},{text:"<p>This window allows you to see the collaborators and activity happening in the Decision. If you’re the owner you can invite or remove collaborators.</p> <p>Invite someone to help you shop or hit the close button at the top left.</p>",audio:"http://files.agora.sh/tutorialaudio/19_01.mp3"}),id=callWhenNot(".-agora .v-collaborate",next),callWhen(".-agora .v-share",function(){return callWhenNot(".-agora .v-share",function(){return clearInterval(id),next()})})},function(next){return tutorialDialog.show({left:$(window).width()/2,top:$(window).height()/4,pointer:!1,width:400},"below",{text:'<p>Congratulations! You\'ve finished the tour. You should now have a basic idea of what Agora is all about.</p> <ul> <li>To learn more, check out our <a target="_blank" href="http://agora.sh/manual.html">user manual</a>.</li> <li>Use Agora on any of our <a target="_blank" href="http://agora.sh/supportedSites.html">supported sites</a>.</li> <li>If you have any questions or comments, you may <a target="_blank" href="http://agora.sh/contact.html">contact us</a>.</li> </ul> <p>Thanks for using Agora, and happy shopping!</p> <a class="virtualHighFive">Virtual High Five!</a>',audio:"http://files.agora.sh/tutorialaudio/20_01.mp3"},function(){return tutorialDialog.frameEl.find(".virtualHighFive").click(function(){return next(),tutorialDialog.close()})}),_this.contentScript.triggerBackgroundEvent("tutorialFinished"),delete window.tutorialInProgress,delete window.suppressPopups}],stepStartTime=null,doTutorial=function(i){i>0&&(console.debug("time",i+11,(new Date).getTime()-stepStartTime),tracking.time("Tutorial","Step"+(i+11),(new Date).getTime()-stepStartTime));if(tutorialSteps[i])return this.contentScript.triggerBackgroundEvent("tutorialStep",i+12),stepStartTime=(new Date).getTime(),console.debug(i+12),tutorialSteps[i](function(){return doTutorial(i+1)})},tutorialDialog=new TutorialDialog(20,12),window.suppressShoppingBarMenu=!0,$(function(){return doTutorial(0)})}}}(this),200)},SiteInjector.prototype.startContentClipping=function(){return $("body").removeClass("-agora-disabled"),util.showDialog(function(_this){return function(){var addDataView;return addDataView=new AddDataView(_this.contentScript,{type:"drag",url:document.location.href,title:document.title}),addDataView.shoppingBarView=_this,addDataView}}(this))},SiteInjector.prototype.toggle=function(){return $("body").toggleClass("-agora-disabled")},SiteInjector.prototype.clearProductEl=function(el){return el=$(el),util.terminateDragging(el),el.data("agora")&&(el.data("agora").overlayView&&el.data("agora").overlayView.destruct(),el.removeData("agora")),el.removeAttr("agora")},SiteInjector.prototype.initProductEl=function(el,productData,opts){return opts==null&&(opts={}),this.products(el,productData,opts)},SiteInjector.prototype.removeOverlay=function(attachEl){var _ref;return(_ref=attachEl.data("overlay"))!=null&&typeof _ref.destruct=="function"&&_ref.destruct(),attachEl.removeAttr("agora")},SiteInjector.prototype.attachOverlay=function(opts){var productOverlay,_ref;if(opts.attachEl.attr("agora"))return;return"siteName"in opts.productData||(opts.productData.siteName=this.siteName),Q(opts.attachEl).attr("agora",!0),productOverlay=new ProductOverlayView(contentScript,opts.productData,null,{attachEl:opts.attachEl,positionEl:opts.positionEl,hovering:opts.hovering,position:(_ref=opts.position)!=null?_ref:"topRight"}),opts.overlayZIndex!=null&&productOverlay.el.css("zIndex",opts.overlayZIndex),productOverlay.represent(opts.productData),typeof this.initOverlay=="function"&&this.initOverlay(productOverlay),typeof opts.init=="function"?opts.init(productOverlay):void 0},SiteInjector.prototype.products=function(selector,productData,opts){var a,config,contentScript,el,productOverlay,variant,_ref;opts==null&&(opts={}),variant=null,productData.variant&&(variant=productData.variant,delete productData.variant),el=$(selector);if(el.attr("agora")){if(!!el.data("agora"))return;el.parents("a").removeAttr("agora"),ProductOverlayView.clear(el)}opts.image==null&&(opts.image=!0),opts.overlay==null&&(opts.overlay=!0),"siteName"in productData||(productData.siteName=this.siteName),Q(el).attr("productSid",productData.productSid),contentScript=this.contentScript,config=this.config,Q(el).data("agora",{opts:opts}),Q(el).attr("agora",!0);if(opts.overlay&&(config!=null?config.productBadges:void 0)!==!1){a=el.parents("a");if(a.length===0||!a.attr("agora"))a.length&&Q(a).attr("agora",!0),productOverlay=new ProductOverlayView(contentScript,_.clone(productData),el.get(0),{hovering:opts.hovering,extra:opts.extraOverlayElements,position:(_ref=opts.overlayPosition)!=null?_ref:"topRight"}),opts.overlayZIndex!=null&&productOverlay.el.css("zIndex",opts.overlayZIndex),productOverlay.represent(_.clone(productData)),typeof this.initOverlay=="function"&&this.initOverlay(productOverlay),typeof opts.initOverlay=="function"&&opts.initOverlay(productOverlay),el.data("agora").overlayView=productOverlay}if(opts.image)return util.initDragging(el,{acceptsDrop:!1,affect:!1,context:"page",helper:function(event){return $('<div class="-agora -agora-productClip t-item dragging" style="position:absolute"> <span class="p-image"></span> <div class="g-productInfo"> <span class="p-title">loading...</span> <span class="p-site">loading...</span> <span class="p-price">loading...</span> </div> </div>')},start:function(_this){return function(event,ui){var clip,clipTimerId,image,item,itemState,marginLeft,marginTop,offsetX,offsetY,payload,payloadCb,price,sendPayload,site,size,target,title,view;return shoppingBarView.startDrag(),tracking.event("Site","dragProduct",opts.area),target=$(event.currentTarget),target.css({opacity:.25}),image=ui.helper.find(".p-image"),image.css({backgroundImage:"url('"+target.attr("src")+"')",width:target.width(),height:target.height()}),title=ui.helper.find(".p-title"),site=ui.helper.find(".p-site"),price=ui.helper.find(".p-price"),view=new View(_this.contentScript),view.type="ProductClip",view.onData=function(data){return data.title.get()&&title.html(data.title.get()),view.observe(data.title,function(mutation){return title.html(mutation.value)}),data.site.get()&&site.html(data.site.get()),view.observe(data.site,function(mutation){return site.html(mutation.value)}),data.price.get()&&price.html(data.price.get()),view.observe(data.price,function(mutation){return price.html(mutation.value)})},sendPayload=null,payload=null,payloadCb=function(cb){return payload?cb(payload):sendPayload=cb},ui.helper.data("dragging").data=payloadCb,marginLeft=marginTop=0,offsetX=event.pageX-target.offset().left+marginLeft,offsetY=event.pageY-target.offset().top+marginTop,ui.helper.css({marginLeft:marginLeft,width:target.width(),height:target.height(),zIndex:999999}),ui.helper.find(".g-productInfo").css({opacity:0}),size={width:48,height:48},clip=function(){var curve,time;return time=200,curve=null,ui.helper.animate({marginLeft:offsetX-size.width*.9,marginTop:offsetY-size.height*.9,width:148,height:size.height},time,curve),image.animate({width:44,height:44},time,curve),setTimeout(function(){if(!itemState)return ui.helper.find(".g-productInfo").animate({opacity:1},time,curve)},time)},itemState=!1,item=function(){var time;return itemState=!0,time=300,image.animate({width:44,height:44},time),ui.helper.find(".g-productInfo").stop(!0).animate({opacity:0},time,function(){}),ui.helper.stop(!0).animate({width:size.width,height:size.height,marginLeft:offsetX-size.width/2,marginTop:offsetY-size.height/2},time)},productData.elementType="Product",_.isFunction(variant)?productData.variant=variant():variant!=null&&(productData.variant=variant),productData.variant&&console.debug("variant: %s",productData.variant),sendPayload?sendPayload(productData):payload=productData,view.represent(productData),ui.args.onDraggedOver=function(el){return el?(clearTimeout(clipTimerId),itemState||item(),ui.helper.addClass("adding")):ui.helper.removeClass("adding")},ui.args.stop=function(event,ui){return shoppingBarView.stopDrag(),view.destruct(),target.animate({opacity:1},"linear"),ui.helper.animate({marginLeft:offsetX,marginTop:offsetY,width:10,height:10,opacity:0},100,"linear",function(){return ui.helper.remove()})},clipTimerId=setTimeout(clip,100)}}(this)})},SiteInjector}()}}}),define("client/TipDialog",[],function(){return function(){var TipDialog;return TipDialog=function(){function TipDialog(){}return TipDialog}()}});var __slice=[].slice;define("client/tracking",[],function(){return function(){return{page:function(path,params){return params==null&&(params={}),contentScript.triggerBackgroundEvent("tracking",{type:"page",path:path,params:params})},event:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],contentScript.triggerBackgroundEvent("tracking",{type:"event",args:args})},time:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],contentScript.triggerBackgroundEvent("tracking",{type:"time",args:args})}}}}),define("client/TutorialDialog",[],function(){return function(){var TutorialDialog;return TutorialDialog=function(){function TutorialDialog(steps,step){var i,_i;this.steps=steps,this.step=step,this.pointerEl=$('<div class="-agora tutorialPointer"><span class="frame" /><span class="frameNoArrow" /><span class="logo" /></div>'),this.frameEl=$('<div class="-agora tutorialDialog"> <div class="steps" /> <div class="cont" /> <div class="audioControls"><a href="#" class="replay" /><a href="#" class="mute" /></div> </div>');if(this.steps)for(i=_i=1;1<=steps?_i<=steps:_i>=steps;i=1<=steps?++_i:--_i)this.frameEl.find(".steps").append($('<span class="step" />'));this.frameEl.css({position:"absolute"}),this.frameEl.appendTo(document.body),this.pointerEl.css({position:"absolute"}),this.pointerEl.appendTo(document.body),this.pointerEl.hide(),this.frameEl.hide(),this.distance=50,this.currentStep=step,this.setMuted=function(_this){return function(muted){_this.muted=muted,_this.muted?_this.frameEl.addClass("muted"):_this.frameEl.removeClass("muted"),_this.audio&&(_this.audio.muted=_this.muted),chrome.storage.local.set({tutorial:{muted:_this.muted}})}}(this),chrome.storage.local.get("tutorial",function(_this){return function(data){if(data.tutorial)return _this.setMuted(data.tutorial.muted)}}(this)),this.frameEl.find(".audioControls .mute").click(function(_this){return function(){return _this.setMuted(!_this.muted),!1}}(this)),this.frameEl.find(".audioControls .replay").click(function(_this){return function(){return _this.audio&&(_this.audio.currentTime=0,_this.audio.play()),!1}}(this))}return TutorialDialog.prototype.showCenter=function(width,content,cb){return cb==null&&(cb=null),this.show({left:$(window).width()/2,top:$(window).height()/4,pointer:!1,width:width},"below",content,cb)},TutorialDialog.prototype.show=function(anchorEl,orientation,content,cb){var adjust,anchorHeight,anchorPos,anchorWidth,audioUrl,calcFramePos,factor,framePos,frameSize,next,playAudio,pointer,pointerAngle,pointerPos,transitionAngle,updateSteps,_ref;cb==null&&(cb=null),framePos=pointerPos=pointerAngle=null,this.pointerEl.show(),this.frameEl.show(),anchorPos=anchorWidth=anchorHeight=pointer=null,audioUrl=void 0,content.audio&&(audioUrl=content.audio),content.text&&(content=content.text),adjust=0,_.isPlainObject(orientation)&&("adjust"in orientation&&(adjust=orientation.adjust),orientation=orientation.orientation),"top"in anchorEl&&"left"in anchorEl?(anchorPos=anchorEl,anchorWidth=anchorHeight=0,pointer=(_ref=anchorEl.pointer)!=null?_ref:!0):(anchorPos=anchorEl.offset(),anchorWidth=anchorEl.outerWidth(),anchorHeight=anchorEl.outerHeight(),pointer=!0),next=function(_this){return function(){return anchorEl.top&&anchorEl.left?anchorEl.width?_this.frameEl.css({maxWidth:anchorEl.width}):_this.frameEl.css({maxWidth:""}):_this.frameEl.css({maxWidth:""})}}(this),calcFramePos=function(_this){return function(){var pos;return pos=function(){switch(orientation){case"left":return{left:anchorPos.left-this.frameEl.outerWidth()-this.distance,top:anchorPos.top+anchorHeight/2-this.frameEl.outerHeight()/2};case"right":return{left:anchorPos.left+anchorWidth+this.distance+(adjust!=null?adjust:0),top:anchorPos.top+anchorHeight/2-this.frameEl.outerHeight()/2};case"above":return{left:anchorPos.left+anchorWidth/2-this.frameEl.outerWidth()/2,top:anchorPos.top-this.frameEl.outerHeight()-this.distance};case"below":return{left:anchorPos.left+anchorWidth/2-this.frameEl.outerWidth()/2,top:anchorPos.top+anchorHeight+this.distance}}}.call(_this),pos.left=Math.max(5,Math.min($(window).width()-5,pos.left)),pos.top=Math.max(0,Math.min($(window).height()+$(window).scrollTop()-_this.frameEl.outerHeight(),pos.top)),pos}}(this),frameSize=55,factor=.57;switch(orientation){case"left":pointerPos={left:anchorPos.left-frameSize-this.distance+frameSize*factor,top:anchorPos.top+anchorHeight/2-this.pointerEl.outerHeight()/2},pointerAngle="90deg";break;case"right":pointerPos={left:anchorPos.left+anchorWidth+this.distance-frameSize*factor+(adjust!=null?adjust:0),top:anchorPos.top+anchorHeight/2-this.pointerEl.outerHeight()/2},this.prevPointerAngle==="-180deg"?pointerAngle="-90deg":this.prevPointerAngle==="180deg"?pointerAngle="270deg":pointerAngle="-90deg";break;case"above":pointerPos={left:anchorPos.left+anchorWidth/2-frameSize/2,top:anchorPos.top-this.pointerEl.outerHeight()-this.distance+this.pointerEl.height()*factor},this.prevOrientation==="right"?pointerAngle="-180deg":pointerAngle="180deg";break;case"below":pointerPos={left:anchorPos.left+anchorWidth/2-frameSize/2,top:anchorPos.top+anchorHeight+this.distance-this.pointerEl.height()*factor},pointerAngle="0deg"}return transitionAngle=this.prevOrientation!==orientation,this.prevOrientation=orientation,this.prevPointerAngle=pointerAngle,updateSteps=function(_this){return function(){var contWidth,el,i,marginLeft,stepWidth,_i,_len,_ref1;stepWidth=10,contWidth=_this.frameEl.find(".cont").width(),marginLeft=(contWidth-stepWidth*_this.steps)/(_this.steps-1),_ref1=_this.frameEl.find(".steps .step");for(i=_i=0,_len=_ref1.length;_i<_len;i=++_i)el=_ref1[i],i!==0&&$(el).css("marginLeft",marginLeft),i+1<=_this.step&&$(el).addClass("filled");return++_this.step}}(this),playAudio=function(_this){return function(){if(_this.audio)return _this.muted&&(_this.audio.muted=!0),_this.audio.play()}}(this),this.audio&&this.audio.pause(),audioUrl?this.audio=new Audio(audioUrl):this.audio=null,this.shown?this.frameEl.fadeOut(function(_this){return function(){return next(),_this.frameEl.find(".cont").html("").append(content),_this.pointerEl.animate(pointerPos,function(){return _this.frameEl.css(calcFramePos()),setTimeout(updateSteps,0),_this.frameEl.fadeIn(function(){return playAudio(),typeof cb=="function"?cb():void 0})}),_this.prevPointer===pointer?pointer&&transitionAngle&&_this.pointerEl.find(".frame").animate({transform:"rotate("+pointerAngle+")"}):pointer?(_this.pointerEl.find(".frame").css({transform:"rotate("+pointerAngle+")"}).fadeIn(),_this.pointerEl.find(".frameNoArrow").fadeOut()):(_this.pointerEl.find(".frame").fadeOut(),_this.pointerEl.find(".frameNoArrow").fadeIn()),_this.prevPointer=pointer}}(this)):(next(),this.shown=!0,this.frameEl.find(".cont").append(content),this.frameEl.css(calcFramePos()),this.pointerEl.css(pointerPos),this.prevPointer=pointer,setTimeout(updateSteps,0),pointer?(this.pointerEl.find(".frame").css({transform:"rotate("+pointerAngle+")"}),this.pointerEl.find(".frameNoArrow").hide()):(this.pointerEl.find(".frame").hide(),this.pointerEl.find(".frameNoArrow").show()),playAudio(),typeof cb=="function"?cb():void 0)},TutorialDialog.prototype.close=function(){return this.frameEl.fadeOut(),this.audio&&this.audio.pause(),this.pointerEl.fadeOut()},TutorialDialog}()}}),define("client/util",[],function(){return{d:[],c:function(){var util;return util={draggingListeners:{},nextDraggingListenerId:1,terminateDragging:function(baseEl){var draggingListenerId;baseEl.unbind("mousedown.dragging");if(baseEl.data("dragging")){baseEl.unbind("mousedown.dragging"),baseEl.removeData("dragging");if(draggingListenerId=baseEl.data("draggingListenerId"))return delete util.draggingListeners[draggingListenerId],baseEl.removeData("draggingListenerId")}},initDragging:function(baseEl,args){var draggingListenerId;args==null&&(args={}),baseEl.data("dragging")&&baseEl.unbind("mousedown.dragging"),args.affect!==!1&&Q(baseEl).data("dragging",args),(args.onDroppedOn||args.onDragOver||args.onDragOut||args.dragArea||args.root)&&Q(baseEl).attr("dragarea",!0),args.root&&Q(baseEl).attr("draggingroot",!0),"acceptsDrop"in args&&args.acceptsDrop===!1||Q(baseEl).attr("acceptsdrop",!0);if("enabled"in args&&!args.enabled)return;if(args.onUserStartDrag||args.onUserEndDrag)draggingListenerId=util.nextDraggingListenerId++,util.draggingListeners[draggingListenerId]={baseEl:baseEl,args:args},Q(baseEl).data("draggingListenerId",draggingListenerId);return Q(baseEl).bind("mousedown.dragging",function(e){var curEl,dragging,el,i,parents,selector;if(typeof args.cancel=="function"?args.cancel():void 0)return;selector="[dragarea]",dragging={startDrag:function(e){var draggingCont,draggingContEl,el,helper,offset,overlay,rootEl,states,_base,_base1;return this.started=!0,draggingContEl=null,draggingCont=function(){return draggingContEl||(draggingContEl=$('<div class="-agora -agoraDraggingCont">').css({position:"absolute",left:0,top:0}).appendTo(document.body)),draggingContEl},overlay=$("<div />").css({position:"fixed",left:0,right:0,top:0,bottom:0,zIndex:9999999999}).appendTo(document.body),offset={x:e.pageX-this.el.offset().left,y:e.pageY-this.el.offset().top},args.helper&&(helper=args.helper(e,this.el,offset),helper.data("dragging",args),helper.appendTo(draggingCont()),this.el=helper),typeof (_base=this.el.data("dragging")).start=="function"&&_base.start(e,{helper:this.el,args:args}),el=this.el,args.context==="shoppingBar"&&el.addClass("activeDrag"),rootEl=args.context==="shoppingBar"?baseEl.parents("[draggingroot=true]"):$(".-agora.v-shoppingBar .content"),this.mousemove=function(e){var left,top,_base1;left=e.pageX-this.el.offsetParent().offset().left-offset.x,top=e.pageY-this.el.offsetParent().offset().top-offset.y,this.state&&this.state.mousemove(e,left,top)===!1&&(this.state=states.global,this.state.init(),this.el.css({zIndex:99999999}),typeof (_base1=el.data("dragging")).onGlobal=="function"&&_base1.onGlobal(),this.state.mousemove(e,left,top));if(!this.state)return left=e.pageX-this.el.offsetParent().offset().left-offset.x,top=e.pageY-this.el.offsetParent().offset().top-offset.y,this.el.css({left:left,top:top})},this.mouseup=function(e){var _ref;return args.context==="shoppingBar"&&this.el.removeClass("activeDrag"),(_ref=this.state)!=null&&typeof _ref.mouseup=="function"&&_ref.mouseup(e),overlay!=null&&overlay.remove(),setTimeout(function(){if(draggingContEl)return draggingContEl.remove()},1e3)},states={list:function(){var containerEl,contentEl,count,currentIndex,direction,elementAtIndex,elements,i,indexForSegment,posForIndex,removed,startIndex,updatePos,_i,_ref,_ref1,_ref2;containerEl=el.parents(".element").first(),containerEl.length===0&&(containerEl=rootEl),contentEl=(_ref=(_ref1=containerEl.data("dragging"))!=null?_ref1.contentEl:void 0)!=null?_ref:containerEl,elements=contentEl.children(".element"),removed=!1,direction="ltr";for(i=_i=0,_ref2=elements.length;0<=_ref2?_i<_ref2:_i>_ref2;i=0<=_ref2?++_i:--_i)if(elements.get(i)===el.get(0)){currentIndex=startIndex=i;break}return count=elements.length,el.css({position:"absolute"}),elementAtIndex=function(index){var resolvedIndex;return removed?index>=startIndex?$(elements.get(index+1)):$(elements.get(index)):index===currentIndex?el:(resolvedIndex=index,index>currentIndex&&resolvedIndex--,resolvedIndex>=startIndex&&resolvedIndex++,$(elements.get(resolvedIndex)))},indexForSegment=function(start,end){var width,x,_j;x=0;for(i=_j=0;0<=count?_j<count:_j>count;i=0<=count?++_j:--_j){width=elementAtIndex(i).data("view").width();if(i!==currentIndex&&start<x+width/2&&end>x+width/2)return i;x+=width+contentEl.data("spacing")}return currentIndex},posForIndex=function(index){var pos,_j;if(index===0)return 0;pos=0;for(i=_j=0;0<=index?_j<index:_j>index;i=0<=index?++_j:--_j)pos+=elementAtIndex(i).data("view").width()+contentEl.data("spacing");return pos},updatePos=function(el,i){if(direction==="ltr")return el.stop(!0,!0).animate({left:posForIndex(i)},150);if(direction==="rtl")return el.stop(!0,!0).animate({right:posForIndex(i)},150)},{mousemove:function(e,left,top){var index,lock,prevCurrent,right,_j,_ref3;lock=!1;if(!lock&&(e.pageY-el.offsetParent().offset().top<-35||e.pageX-(contentEl.offset().left+contentEl.width())>100||contentEl.offset().left-e.pageX>100)){if(currentIndex!==null){removed=!0;for(i=_j=0,_ref3=count-1;0<=_ref3?_j<_ref3:_j>_ref3;i=0<=_ref3?++_j:--_j)updatePos(elementAtIndex(i),i);dragging.fromEl=containerEl}return!1}direction==="ltr"?el.css({left:Math.min(Math.max(0,left),contentEl.width()-el.width())}):direction==="rtl"&&(right=contentEl.width()-left,el.css({right:Math.min(Math.max(0,right),contentEl.width()-el.width())})),index=indexForSegment(left,left+el.width());if(index!==void 0&&currentIndex!==index){prevCurrent=currentIndex,currentIndex=index;if(prevCurrent!==null)return updatePos(elementAtIndex(prevCurrent),prevCurrent)}},mouseup:function(e){var _base1,_j,_ref3;for(i=_j=0;0<=count?_j<count:_j>count;i=0<=count?++_j:--_j)updatePos(elementAtIndex(i),i);return(_ref3=containerEl.data("dragging"))!=null&&typeof _ref3.onReorder=="function"&&_ref3.onReorder(el,startIndex,currentIndex),el.removeClass("activeDrag"),typeof (_base1=el.data("dragging")).stop=="function"?_base1.stop(e):void 0}}}(),global:function(){var activeEl,bundleActionTimer,deeper,drill,dropAction,highlightEl,rootEls,setActiveEl,shallower,skipRoot;return skipRoot=!1,rootEls=[],$("[draggingroot]").each(function(){return rootEls.push(this)}),rootEls.sort(function(a,b){var _ref,_ref1;return((_ref=$(b).data("dragging").rootZIndex)!=null?_ref:0)-((_ref1=$(a).data("dragging").rootZIndex)!=null?_ref1:0)}),activeEl=null,dropAction="default",bundleActionTimer=null,highlightEl=function(el){var _ref;return((_ref=el.data("dragging"))!=null?_ref.highlightEl:void 0)?el.data("dragging").highlightEl:el},setActiveEl=function(el){var curEl,data,dragOutList,dragOverList,els,i,_base1,_base2,_i,_j,_k,_len,_len1,_ref,_ref1,_ref2,_results;if(activeEl&&el&&el.get(0)===activeEl.get(0))return;dragOutList=[],dragOverList=[];if(activeEl){highlightEl(activeEl).removeClass("activeDrop"),curEl=activeEl;for(;;){curEl.data("dragging")||console.debug(curEl),curEl.data("dragging")&&dragOutList.push(curEl.data("dragging")),curEl=curEl.parents(selector).first();if(!curEl.length)break}(_ref=activeEl.data("dragging"))!=null&&typeof _ref.onInactive=="function"&&_ref.onInactive()}activeEl=el,dragging.el.data("dragging")&&typeof (_base1=dragging.el.data("dragging")).onDraggedOver=="function"&&_base1.onDraggedOver(activeEl,dragging.el);if(activeEl){typeof (_base2=activeEl.data("dragging")).onActive=="function"&&_base2.onActive(),els=[],els.push(activeEl.get(0)),activeEl.parents(selector).each(function(){return els.push(this)});for(i=_i=_ref1=els.length-1;_ref1<=0?_i<=0:_i>=0;i=_ref1<=0?++_i:--_i){curEl=$(els[i]),dragOverList.push(curEl.data("dragging"));if(((_ref2=curEl.data("dragging"))!=null?_ref2.immutableContents:void 0)&&!dragging.el.data("dragging").breaksImmutability)break}highlightEl(activeEl).addClass("activeDrop")}for(_j=0,_len=dragOutList.length;_j<_len;_j++)data=dragOutList[_j],_.contains(dragOverList,data)||typeof data.onDragOut=="function"&&data.onDragOut();_results=[];for(_k=0,_len1=dragOverList.length;_k<_len1;_k++)data=dragOverList[_k],_.contains(dragOutList,data)?_results.push(void 0):_results.push(typeof data.onDragOver=="function"?data.onDragOver():void 0);return _results},deeper=function(e){var childEl,childOffset,children,i,sel,_i,_ref,_ref1;sel=selector,activeEl.data("dragging").immutableContents&&!dragging.el.data("dragging").breaksImmutability&&(sel+="[breaksimmutability]"),children=((_ref=activeEl.data("dragging").contentEl)!=null?_ref:activeEl).children(sel);if(children.length>0)for(i=_i=0,_ref1=children.length-1;0<=_ref1?_i<=_ref1:_i>=_ref1;i=0<=_ref1?++_i:--_i){if(el.get(0)===children.get(i))continue;childEl=$(children.get(i)),childOffset=childEl.offset();if(e.pageX>childOffset.left&&e.pageY>childOffset.top&&e.pageX<childOffset.left+childEl.outerWidth()&&e.pageY<childOffset.top+childEl.outerHeight())return setActiveEl(childEl),!0}return!1},drill=function(e,el){var childEl,childOffset,children,i,sel,_i,_ref,_ref1;sel=selector,el.data("dragging").immutableContents&&!dragging.el.data("dragging").breaksImmutability&&(sel+="[breaksimmutability]"),children=((_ref=el.data("dragging").contentEl)!=null?_ref:el).children(sel);if(children.length>0)for(i=_i=0,_ref1=children.length-1;0<=_ref1?_i<=_ref1:_i>=_ref1;i=0<=_ref1?++_i:--_i){if(el.get(0)===children.get(i))continue;childEl=$(children.get(i)),childOffset=childEl.offset();if(e.pageX>childOffset.left&&e.pageY>childOffset.top&&e.pageX<childOffset.left+childEl.outerWidth()&&e.pageY<childOffset.top+childEl.outerHeight())return drill(e,childEl)}return el},shallower=function(e){var contOffset,parentEl,_results;contOffset=activeEl.offset(),_results=[];while(!(e.pageX>contOffset.left&&e.pageY>contOffset.top&&e.pageX<contOffset.left+activeEl.outerWidth()&&e.pageY<contOffset.top+activeEl.outerHeight())){parentEl=activeEl.parents(selector).first();if(!parentEl.length){setActiveEl(null);break}setActiveEl(parentEl),_results.push(contOffset=activeEl.offset())}return _results},{init:function(){return el.appendTo(draggingCont()),this.start()},start:function(){var id,listener,_base1,_ref,_results;setActiveEl(null),args.context!=="page"&&!dragging.fromEl&&(dragging.fromEl=baseEl.parents(selector).first()),_ref=util.draggingListeners,_results=[];for(id in _ref)listener=_ref[id],_results.push(typeof (_base1=listener.args).onUserStartDrag=="function"?_base1.onUserStartDrag():void 0);return _results},mousemove:function(e,left,top){var contOffset,contentEl,frameEl,hoverEl,_i,_j,_len,_len1,_ref,_ref1,_results;bundleActionTimer&&clearTimeout(bundleActionTimer),el.css({left:left,top:top}),hoverEl=null;for(_i=0,_len=rootEls.length;_i<_len;_i++){rootEl=rootEls[_i],contentEl=$(rootEl),contOffset=contentEl.offset();if(e.pageX>contOffset.left&&e.pageY>contOffset.top&&e.pageX<contOffset.left+contentEl.outerWidth()&&e.pageY<contOffset.top+contentEl.outerHeight()){hoverEl=drill(e,contentEl);break}}setActiveEl(hoverEl),activeEl&&(bundleActionTimer=setTimeout(function(){var _base1;return typeof (_base1=activeEl.data("dragging")).onHoldOver=="function"?_base1.onHoldOver(el):void 0},(_ref=activeEl.data("dragging").holdDelay)!=null?_ref:500));return},mouseup:function(e){var id,listener,receivingEl,_base1,_base2,_base3,_ref,_ref1,_ref2;bundleActionTimer&&clearTimeout(bundleActionTimer),_ref=util.draggingListeners;for(id in _ref)listener=_ref[id],typeof (_base1=listener.args).onUserEndDrag=="function"&&_base1.onUserEndDrag();return receivingEl=null,activeEl&&(receivingEl=activeEl.attr("acceptsdrop")?activeEl:activeEl.parents("[acceptsdrop]").first()),typeof (_base2=el.data("dragging")).stop=="function"&&_base2.stop(e,{helper:dragging.el,receivingEl:receivingEl}),typeof (_base3=el.data("dragging")).onDropped=="function"&&_base3.onDropped(receivingEl),receivingEl?(_ref1=receivingEl.data("dragging"))!=null&&typeof _ref1.onDroppedOn=="function"&&_ref1.onDroppedOn(el,dragging.fromEl,dropAction):dragging.fromEl&&((_ref2=dragging.fromEl.data("dragging"))!=null?typeof _ref2.onRemove=="function"?_ref2.onRemove(el):void 0:void 0)!==!1&&el.remove(),setActiveEl(null)}}}()},args.context==="shoppingBar"?this.state=states.list:this.state=states.global,typeof (_base1=this.state).start=="function"&&_base1.start(),dragging.mousemove(e)}},dragging.el=function(){var _i,_ref,_ref1;if(args.context!=="page"){parents=baseEl.parents(selector),el=baseEl;for(i=_i=_ref=parents.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i){curEl=$(parents.get(i));if((_ref1=curEl.data("dragging"))!=null?_ref1.immutableContents:void 0){curEl.data("dragging").enabled?el=$(parents.get(i)):el=null;break}}return el}return baseEl}();if(dragging.el)return $(window).bind("mousemove.dragging",function(e){return e.currentTarget=baseEl,dragging.started||dragging.startDrag(e),dragging.mousemove(e)}),$(window).bind("mouseup.dragging",function(e){$(window).unbind(".dragging"),e.currentTarget=baseEl;if(dragging.started)return dragging.mouseup(e)}),!1})},getBarItem:function(data,parentView,shoppingBarView,selectMode){var barItemView;return barItemView=parentView.createView("BarItem",shoppingBarView,{selectMode:selectMode}),barItemView.represent(data),barItemView},isMutable:function(el){var curEl,i,parents,_i,_ref,_ref1;parents=el.parents(".element");for(i=_i=_ref=parents.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i){curEl=$(parents.get(i));if((_ref1=curEl.data("dragging"))!=null?_ref1.immutableContents:void 0)return!1}return!0},isFixed:function(el){while(el.get(0)!==document.body){if(el.css("position")==="fixed")return!0;el=el.offsetParent()}return!1},showPopup:function(el,args){var cancelClose,cb,close,init,initiateClose,open,pin,pinned,popupEl,shouldClose,timerId,unpin;return args.close==null&&(args.close=!0),popupEl=timerId=open=null,shouldClose=!0,cancelClose=function(){return clearTimeout(timerId),shouldClose=!1},initiateClose=function(time){return time==null&&(time=500),_.isNumber(time)||(time=500),pinned?shouldClose=!0:(clearTimeout(timerId),timerId=setTimeout(close,time))},close=function(){if(popupEl)return args.onClose(popupEl),popupEl=null,el.unbind("mouseleave",initiateClose).unbind("mouseenter",cancelClose)},pinned=!1,pin=function(){return cancelClose(),pinned=!0},unpin=function(){pinned=!1;if(shouldClose)return initiateClose(),shouldClose=!1},init=function(){if(args.close)return popupEl.mouseenter(cancelClose).mouseleave(initiateClose)},cb=function(el){return popupEl=el,init()},popupEl=args.createPopup(cb,close),popupEl&&init(),args.close&&(el.mouseleave(initiateClose),el.mouseenter(cancelClose)),{close:close,pin:pin,unpin:unpin,initiateClose:initiateClose,cancelClose:cancelClose}},popupTrigger2:function(el,args){var addEl,cancelClose,cancelOpen,close,closing,closingTimerId,els,initiateClose,onEnter,onLeave,open,openTimerId,over,pin,pinned,popupEl,shouldClose,timerId,unpin;return popupEl=timerId=open=null,shouldClose=!1,closing=!1,cancelClose=function(){return clearTimeout(timerId),shouldClose=!1,closing=!1},cancelOpen=function(){return clearTimeout(openTimerId)},initiateClose=function(){var _ref;closing=!0;if(pinned)return shouldClose=!0;clearTimeout(timerId);if(open)return timerId=setTimeout(close,(_ref=args.closeDelay)!=null?_ref:500)},close=function(animate){var _i,_len;animate==null&&(animate=!1),clearTimeout(openTimerId);if(popupEl){args.onClose(popupEl,animate),popupEl=null,clearInterval(closingTimerId),closing=!1;for(_i=0,_len=els.length;_i<_len;_i++)el=els[_i],el.unbind("mouseenter",onEnter).unbind("mouseleave",onLeave)}return open=!1},pinned=!1,pin=function(){return pinned=!0},unpin=function(){pinned=!1;if(shouldClose)return initiateClose(),shouldClose=!1},over=0,els=[],onEnter=function(){return++over,cancelClose()},onLeave=function(){--over;if(!open)return cancelOpen();if(over<=0&&!closing)return initiateClose()},addEl=function(el){return els.push(el),el.mouseenter(onEnter).mouseleave(onLeave)},closingTimerId=null,openTimerId=null,el.bind("mouseenter.popup",function(_this){return function(){var _ref;return onEnter(),openTimerId=setTimeout(function(){var cb,e,init,inited;if(open)return cancelClose();inited=!1,init=function(){return inited=!0,addEl(popupEl)},cb=function(el){return open?(popupEl=el,init()):args.onClose(el)},open=!0,e=args.createPopup(cb,close,addEl),popupEl||(popupEl=e);if(popupEl&&!inited)return init();if(popupEl===!1)return open=!1},(_ref=args.delay)!=null?_ref:200)}}(this)),el.bind("mouseleave.popup",onLeave),{close:close,pin:pin,unpin:unpin,cancelOpen:cancelOpen,addEl:addEl}},popupTrigger:function(el,args){var addEl,cancelClose,cancelOpen,close,initiateClose,open,pin,pinned,popupEl,shouldClose,timerId,unpin;return popupEl=timerId=open=null,shouldClose=!1,cancelClose=function(){return clearTimeout(timerId),shouldClose=!1},cancelOpen=function(){return clearTimeout(timerId)},initiateClose=function(){if(pinned)return shouldClose=!0;clearTimeout(timerId);if(open)return timerId=setTimeout(close,500)},close=function(){return clearTimeout(timerId),popupEl&&(args.onClose(popupEl),popupEl=null),open=!1},pinned=!1,pin=function(){return pinned=!0},unpin=function(){pinned=!1;if(shouldClose)return initiateClose(),shouldClose=!1},addEl=function(el){return el.mouseenter(cancelClose).mouseleave(initiateClose)},el.bind("mouseenter.popup",function(_this){return function(){return cancelClose(),timerId=setTimeout(function(){var cb,init;if(open)return cancelClose();init=function(){return addEl(popupEl)},cb=function(el){return open?(popupEl=el,init()):args.onClose(el)},open=!0,popupEl=args.createPopup(cb,close,addEl);if(popupEl)return init();if(popupEl===!1)return open=!1},200)}}(this)),el.bind("mouseleave.popup",function(_this){return function(){return initiateClose()}}(this)),{close:close,pin:pin,unpin:unpin,cancelOpen:cancelOpen}},clearPopupTrigger:function(el){return el.unbind(".popup")},showDialog:function(createView,params){var view,_showDialog;params==null&&(params={}),_showDialog=function(){var frameEl;return view.close=function(){return view.destruct(),Frame.close(frameEl)},view.sizeChanged=function(){return Frame.positionInCenterOfScreen(frameEl)},frameEl=Frame.wrapInFrame(view.el,{close:function(){return view.destruct()}}),frameEl.appendTo(document.body),Frame.positionInCenterOfScreen(frameEl),Frame.show(frameEl)},view=createView(function(v){return view=v,_showDialog()});if(view)return _showDialog()},styleSelect:function(selectEl,opts){var autoSize,el,hasLabel,sizeCalcEl,updateLabel,width,_ref,_ref1;return opts==null&&(opts={}),autoSize=(_ref=opts.autoSize)!=null?_ref:!0,hasLabel=(_ref1=opts.label)!=null?_ref1:!0,el=$('<span class="t-select" />').css({position:"relative"}),el.addClass(opts["class"]),updateLabel=function(){var label,selected;return selected=selectEl.children(":selected"),label=selected.html(),el.html(label),hasLabel&&(selected.index()===0?el.addClass("label"):el.removeClass("label")),selectEl.after(el)},autoSize&&(sizeCalcEl=$('<div class="-agora t-selectOptions" />').css({position:"absolute",visibility:"hidden"}),selectEl.children().each(function(){return $('<div class="t-option" />').css({whiteSpace:"nowrap",fontSize:12}).html(this.innerHTML).appendTo(sizeCalcEl)}),sizeCalcEl.appendTo(document.body),width=sizeCalcEl.width(),sizeCalcEl.remove(),el.css({width:width+15})),selectEl.change(function(){return updateLabel()}),el.mousedown(function(){var close,ignore,optionsEl;return close=function(){return el.animate({opacity:1},100),optionsEl.fadeOut(100,function(){return optionsEl.remove()})},ignore=!0,setTimeout(function(){return ignore=!1},500),optionsEl=$('<div class="-agora t-selectOptions" />'),selectEl.children().each(function(){var optionEl;return optionEl=$("<span class='t-option' value='"+this.value+"'>"+this.innerHTML+"</span>"),this.selected&&(optionEl.addClass("selected"),optionEl.attr("selected",!0)),optionsEl.append(optionEl),optionEl.mousedown(function(e){return e.stopPropagation()}),optionEl.mouseup(function(_this){return function(){if(!ignore||!$(_this).prop("selected"))optionEl.addClass("selected"),$(_this).prop("selected",!0),selectEl.trigger("change"),updateLabel(),close();return ignore=!1}}(this))}),optionsEl.appendTo(el),optionsEl.mousemove(function(e){return optionsEl.children().each(function(){var offset;offset=$(this).offset();if(e.pageY>offset.top&&e.pageY<offset.top+$(this).outerHeight())return optionsEl.find(".selected").removeClass("selected"),$(this).addClass("selected")})}),optionsEl.css({position:"absolute",width:el.outerWidth(),zIndex:9999999999}),optionsEl.css({left:0,top:Math.max(4,el.offset().top-optionsEl.children(".selected").position().top)-el.offset().top}),!1}),selectEl.css({display:"none"}),updateLabel()},tooltip2:function(el,text,opts){var addEl,cancelClose,close,closeTimer,closing,closingTimerId,count,entered,frame,initiateClose,left,onFrame,open,shouldOpen,timerId;opts==null&&(opts={}),opts.type==null&&(opts.type="text"),el.data("hasTooltip")&&util.clearTooltip(el),frame=null,timerId=null,el.data("hasTooltip",!0),onFrame=null,count=0,shouldOpen=!0,open=!1,closing=!1,closingTimerId=null,close=function(){return clearTimeout(timerId),open=!1,frame?(frame.el.unbind("mouseleave",left).unbind(".mouseenter",entered),frame.close(),typeof opts.onClose=="function"&&opts.onClose(),count=0,closing=!1,clearInterval(closingTimerId)):shouldOpen=!1},entered=function(){return++count,cancelClose()},left=function(){--count;if(!open)return clearTimeout(timerId)},closeTimer=null,initiateClose=function(){return closing=!0,frame?closeTimer=setTimeout(close,opts.canFocus?200:0):(shouldOpen=!1,clearTimeout(timerId))},cancelClose=function(){return clearTimeout(closeTimer),closing=!1},addEl=function(el){return el.mouseleave(left).mouseenter(entered)},opts.canFocus&&(onFrame=function(){return addEl(frame.el)}),el.bind("mouseenter.tooltip",function(){var _ref;document.body.addEventListener("click",function(){return close(),document.body.removeEventListener("click",arguments.callee,!0)},!0);if(!frame)return shouldOpen=!0,timerId=setTimeout(function(){var contentEl,onClose,view,_ref,_ref1;if(!(el.get(0).parentNode&&shouldOpen&&(typeof opts.cancel=="function"?!opts.cancel():!void 0)))return;contentEl=opts.type==="text"?document.createTextNode(typeof text=="function"?text():text):opts.type==="html"?$(text):void 0,view=null,onClose=function(){return frame=null,view!=null?view.destruct():void 0},opts.parentView&&(view=opts.parentView.createView()),typeof opts.init=="function"&&opts.init(contentEl,close,view),frame=Frame.frameAround((_ref=opts.anchor)!=null?_ref:el,contentEl,_.extend(_.clone(opts),{type:(_ref1=opts.frameType)!=null?_ref1:"tooltip",onClose:onClose})),opts["class"]&&frame.el.addClass(opts["class"]),typeof onFrame=="function"&&onFrame(),open=!0,closingTimerId=setInterval(function(){if(!count&&!closing)return initiateClose()},50);if(view)return view.useEl(frame.el)},(_ref=opts.delay)!=null?_ref:500)}),addEl(el);if(opts.anchor)return addEl(opts.anchor)},tooltip:function(el,text,opts){var addEl,cancelClose,close,closeTimer,count,entered,frame,initiateClose,left,onFrame,open,shouldOpen,timerId;opts==null&&(opts={}),opts.type==null&&(opts.type="text"),el.data("hasTooltip")&&util.clearTooltip(el),frame=null,timerId=null,el.data("hasTooltip",!0),onFrame=null,count=0,shouldOpen=!0,open=!1,close=function(){return clearTimeout(timerId),open=!1,frame?(frame.el.unbind("mouseleave",left).unbind(".mouseenter",entered),frame.close(),typeof opts.onClose=="function"&&opts.onClose(),count=0):shouldOpen=!1},entered=function(){return++count,cancelClose()},left=function(){--count;if(count<=0)return initiateClose()},closeTimer=null,initiateClose=function(){return frame?closeTimer=setTimeout(close,opts.canFocus?200:0):(shouldOpen=!1,clearTimeout(timerId))},cancelClose=function(){return clearTimeout(closeTimer)},addEl=function(el){return el.mouseleave(left).mouseenter(entered)},opts.canFocus&&(onFrame=function(){return addEl(frame.el)}),el.bind("mouseenter.tooltip",function(){document.body.addEventListener("click",function(){return close(),document.body.removeEventListener("click",arguments.callee,!0)},!0);if(!frame)return shouldOpen=!0,timerId=setTimeout(function(){var contentEl,onClose,view,_ref,_ref1;if(!(el.get(0).parentNode&&shouldOpen&&(typeof opts.cancel=="function"?!opts.cancel():!void 0)))return;contentEl=opts.type==="text"?document.createTextNode(typeof text=="function"?text():text):opts.type==="html"?$(text):void 0,view=null,onClose=function(){return frame=null,view!=null?view.destruct():void 0},opts.parentView&&(view=opts.parentView.createView()),typeof opts.init=="function"&&opts.init(contentEl,close,view),frame=Frame.frameAround((_ref=opts.anchor)!=null?_ref:el,contentEl,_.extend(_.clone(opts),{type:(_ref1=opts.frameType)!=null?_ref1:"tooltip",onClose:onClose})),opts["class"]&&frame.el.addClass(opts["class"]),typeof onFrame=="function"&&onFrame(),open=!0;if(view)return view.useEl(frame.el)},500)}),addEl(el);if(opts.anchor)return addEl(opts.anchor)},clearTooltip:function(el){if(el.data("hasTooltip"))return el.removeData("hasTooltip"),el.unbind(".tooltip")},resolveDraggingData:function(el,cb){var elData;return elData=el.data("dragging").data?el.data("dragging").data:{view:el.data("view").id},typeof elData=="function"?elData(function(_this){return function(data){return cb(data)}}(this)):cb(elData)},emotionClass:function(positive,negative){return positive&&negative?"mixed":positive?positive>1?"veryPositive":"positive":negative?negative>1?"veryNegative":"negative":"neutral"},positionClass:function(pro,against){if(pro)return"for";if(against)return"against"},openProductPreview:function(productData,fromView){var frameEl,productPreviewView;return fromView==null&&(fromView=null),productPreviewView=new ProductPreviewView(contentScript),fromView&&(productPreviewView.basePath=fromView.path(),fromView.event("openProductPreview")),productPreviewView.represent(productData),tracking.page(productPreviewView.path()),productPreviewView.close=function(){return Frame.close(frameEl)},frameEl=Frame.wrapInFrame(productPreviewView.el,{type:"fullscreen",resize:function(width,height){return[width-20,height-20]},close:function(){return productPreviewView.destruct()}}),frameEl.children(".close").css({top:15}),frameEl.appendTo(document.body),Frame.show(frameEl),productPreviewView.shown()},trapScrolling:function(el){return el.bind("DOMMouseScroll mousewheel",function(ev){var $this,delta,height,prevent,scrollHeight,scrollTop,up;$this=$(this),scrollTop=this.scrollTop,scrollHeight=this.scrollHeight,height=$this.height(),delta=ev.type==="DOMMouseScroll"?ev.originalEvent.detail*-40:ev.originalEvent.wheelDelta,up=delta>0,prevent=function(){return ev.stopPropagation(),ev.preventDefault(),ev.returnValue=!1,!1};if(!up&&-delta>scrollHeight-height-scrollTop)return $this.scrollTop(scrollHeight),prevent();if(up&&delta>scrollTop)return $this.scrollTop(0),prevent()})},createPopout:function(anchorEl,opts){var init,remove;return opts==null&&(opts={}),opts.anchor==null&&(opts.anchor="bottom"),opts.flexibleHeight==null&&(opts.flexibleHeight=!0),_.isFunction(opts.el)||opts.el.hide(),init=function(el,remove){var close,connectorEl,side,updatePos,updateSide;remove==null&&(remove=!0),el.css("position","absolute"),side=opts.side,anchorEl.append(connectorEl=$('<div class="popoutConnector" />').css("position","absolute").addClass(side));switch(opts.anchor){case"top":el.css({top:-9});break;case"bottom":el.css({bottom:-9});break;case"middle":el.css({top:-el.outerHeight()/2+anchorEl.height()/2})}return updateSide=function(){var _ref,_ref1,_ref2,_ref3;switch(side){case"left":return el.css({right:anchorEl.outerWidth()+3+((_ref=opts.distance)!=null?_ref:0)}),connectorEl.css({marginLeft:-((_ref1=opts.distance)!=null?_ref1:0)});case"right":return el.css({left:anchorEl.outerWidth()+3+((_ref2=opts.distance)!=null?_ref2:0)}),connectorEl.css({marginRight:-((_ref3=opts.distance)!=null?_ref3:0)})}},updatePos=function(){var height;updateSide(),side==="left"?el.offset().left<0&&(connectorEl.removeClass("left").addClass("right"),side="right",updateSide()):side==="right"&&el.offset().left+el.width()>$(window).width()&&(connectorEl.removeClass("right").addClass("left"),side="left",updateSide());switch(opts.anchor){case"top":case"middle":el.offset().top<$(window).scrollTop()+10&&el.css({top:$(window).scrollTop()+10-anchorEl.offset().top}),el.offset().top+el.outerHeight()>$(window).scrollTop()+$(window).height()-10&&el.css({top:$(window).scrollTop()+$(window).height()-10-el.outerHeight()-anchorEl.offset().top});if(opts.flexibleHeight&&el.offset().top<$(window).scrollTop()+10)return height=$(window).height()-20,el.css({height:height,top:$(window).scrollTop()+10-anchorEl.offset().top});break;case"bottom":el.offset().top-$(window).scrollTop()<10&&el.css({bottom:anchorEl.offset().top+anchorEl.height()-$(window).scrollTop()-el.outerHeight()-10});if(el.offset().top-$(window).scrollTop()+el.outerHeight()>$(window).height()-42)return el.css({height:$(window).height()-66-20}),el.css({bottom:anchorEl.offset().top+anchorEl.height()-$(window).scrollTop()-el.outerHeight()-10})}},updatePos(),close=function(){return typeof opts.onClose=="function"&&opts.onClose(),typeof onClose=="function"&&onClose(),remove?el.remove():el.hide(),anchorEl.removeClass("active"),connectorEl.remove()},anchorEl.removeClass("hover").addClass("active"),{updatePos:updatePos,close:close}},_.isFunction(opts.el)?opts.el(function(el,onClose){return el.appendTo(anchorEl),init(el,!0)}):(remove=!1,opts.el.parent().length||(opts.el.appendTo(anchorEl),remove=!0),opts.el.show(),init(opts.el,remove))},popoutTrigger:function(triggerEl,opts){var close,closeTimerId,initiateClose,opened,pin,pinned,shouldClose,unpin;return opts==null&&(opts={}),opts.anchor==null&&(opts.anchor="bottom"),_.isFunction(opts.el)||opts.el.hide(),pinned=shouldClose=!1,opened=!1,pin=function(){return pinned=!0},unpin=function(){pinned=!1;if(shouldClose)return close(),shouldClose=!1},closeTimerId=null,close=initiateClose=null,triggerEl.mouseenter(function(_this){return function(){var openTimerId;if(opened){triggerEl.one("mouseleave",initiateClose),clearTimeout(closeTimerId);return}return triggerEl.addClass("hover"),openTimerId=setTimeout(function(){var init;return init=function(el,remove){var connectorEl,updatePos;remove==null&&(remove=!0),opened=!0;switch(opts.side){case"left":el.addClass("left popout").css({position:"absolute",right:triggerEl.outerWidth()+3});break;case"right":el.addClass("right popout").css({position:"absolute",left:triggerEl.outerWidth()+3})}switch(opts.anchor){case"top":el.css({top:0});break;case"bottom":el.css({bottom:-9})}return triggerEl.append(connectorEl=$('<div class="popoutConnector" />').addClass(opts.side)),updatePos=function(){var height;switch(opts.anchor){case"top":el.offset().top+el.outerHeight()>$(window).scrollTop()+$(window).height()-42&&el.css({top:$(window).scrollTop()+$(window).height()-66-10-el.outerHeight()-triggerEl.offset().top});if(el.offset().top<$(window).scrollTop()+10)return height=$(window).height()-66-20,el.css({height:height,top:$(window).scrollTop()+10-triggerEl.offset().top});break;case"bottom":el.offset().top-$(window).scrollTop()<10&&el.css({bottom:triggerEl.offset().top+triggerEl.height()-$(window).scrollTop()-el.outerHeight()-10});if(el.offset().top-$(window).scrollTop()+el.outerHeight()>$(window).height()-42)return el.css({height:$(window).height()-66-20}),el.css({bottom:triggerEl.offset().top+triggerEl.height()-$(window).scrollTop()-el.outerHeight()-10})}},updatePos(),close=function(){return pinned?shouldClose=!0:(typeof onClose=="function"&&onClose(),remove?el.fadeOut(200,function(){return el.remove(),triggerEl.removeClass("active")}):el.fadeOut(200,function(){return triggerEl.removeClass("active")}),connectorEl.fadeOut(200,function(){return connectorEl.remove()}),opened=!1)},initiateClose=function(){return closeTimerId=setTimeout(close,200)},triggerEl.one("mouseleave",initiateClose),triggerEl.removeClass("hover").addClass("active"),[updatePos,close]},_.isFunction(opts.el)?opts.el(function(el,onClose){return el.css("position","absolute"),el.appendTo(triggerEl),init(el)},{pin:pin,unpin:unpin}):(opts.el.show(),init(opts.el,!1))},200),triggerEl.one("mouseleave",function(){return clearTimeout(openTimerId),triggerEl.removeClass("hover")}),{pin:pin,unpin:unpin}}}(this))},observeOffers:function(view,el,data){var offers,updateAlternative,updateCurrent;return offers=data,el.html('<span class="current offer"><span class="price" /><span class="icon" /></span>'),updateCurrent=function(){var current;return current=offers.current.get(),util.tooltip(el.find(".current .icon").css("backgroundImage","url("+current.siteIcon+")"),current.siteName),el.find(".current .price").html(current.price),current.cheaper?el.find(".current").addClass("cheaper"):el.find(".current").removeClass("cheaper")},updateAlternative=function(_this){return function(){var alternative;alternative=offers.alternative.get(),el.find(".alternative").remove();if(alternative)return el.append('<span class="alternative offer"><span class="price" /><span class="icon" /></span>'),alternative.cheaper&&el.find(".alternative").addClass("cheaper"),util.tooltip(el.find(".alternative .icon").css("backgroundImage","url("+alternative.siteIcon+")"),alternative.siteName),el.find(".alternative .price").html(alternative.price)}}(this),updateCurrent(),offers.current.observe(updateCurrent),updateAlternative(),offers.alternative.observe(updateAlternative)},scrollbar:function(wrapper,opts){opts==null&&(opts={});if(window.navigator.appVersion.indexOf("Windows")!==-1)return setTimeout(function(_this){return function(){var w;wrapper.css({overflow:"hidden"}),w=$("<div />").css({width:"100%",height:"100%"}).addClass("antiscroll-inner"),w.append(wrapper.children()),wrapper.append(w),wrapper.antiscroll({useVScroll:!1});if(opts.trapScrolling)return util.trapScrolling(w)}}(this),0);if(opts.trapScrolling)return util.trapScrolling(wrapper)},initScrollbar:function(el,opts){var bars,scrolling,timerId,wrapper;opts==null&&(opts={}),opts.trapScrolling==null&&(opts.trapScrolling=!0),opts.absolute==null&&(opts.absolute=!0),el.addClass("scroll"),wrapper=$('<div class="scrollWrapper" />'),wrapper.append(el.children()),wrapper.appendTo(el),wrapper.css("padding",el.css("padding")),opts.trapScrolling&&util.trapScrolling(wrapper),opts.absolute||(el.css("position")==="static"&&el.css("position","relative"),wrapper.css({position:"static",maxHeight:el.css("maxHeight")}));if(window.navigator.appVersion.indexOf("Windows")!==-1)return wrapper.addClass("hasScrollBars"),bars=[],el.hasClass("vertical")&&function(){var thumbEl,update;return thumbEl=$('<div class="scrollThumb vertical" />'),thumbEl.appendTo(el),update=function(){return thumbEl.height(Math.max(30,wrapper.height()/wrapper.get(0).scrollHeight*wrapper.height())),thumbEl.css("top",wrapper.scrollTop()/(wrapper.get(0).scrollHeight-wrapper.height())*(wrapper.height()-thumbEl.height()))},bars.push({el:thumbEl,update:update})}(),el.hasClass("horizontal")&&function(){var thumbEl,update;return thumbEl=$('<div class="scrollThumb horizontal" />'),thumbEl.appendTo(el),update=function(){return thumbEl.width(Math.max(30,wrapper.width()/wrapper.get(0).scrollWidth*wrapper.width())),thumbEl.css("left",wrapper.scrollLeft()/(wrapper.get(0).scrollWidth-wrapper.width())*(wrapper.width()-thumbEl.width()))},bars.push({el:thumbEl,update:update})}(),scrolling=!1,timerId=null,wrapper.scroll(function(){var bar,_i,_len;for(_i=0,_len=bars.length;_i<_len;_i++)bar=bars[_i],bar.update();clearTimeout(timerId),timerId=setTimeout(function(){return el.removeClass("scrolling"),scrolling=!1},1e3);if(!scrolling)return el.addClass("scrolling"),scrolling=!0}),setTimeout(function(){var bar,_i,_len,_results;_results=[];for(_i=0,_len=bars.length;_i<_len;_i++)bar=bars[_i],_results.push(bar.update());return _results},50),el.addClass("scrolling"),setTimeout(function(){return el.removeClass("scrolling")},2e3)},draggableImage:function(args){return util.initDragging(args.el,{acceptsDrop:!1,affect:!1,context:"page",cancel:args.cancel,helper:function(event){return $('<div class="-agora -agora-productClip t-item dragging" style="position:absolute"> <span class="p-image"></span> <div class="g-productInfo"> <span class="p-title">loading...</span> <span class="p-site">loading...</span> <span class="p-price">loading...</span> </div> </div>')},start:function(_this){return function(event,ui){var clip,clipTimerId,height,image,item,itemState,marginLeft,marginTop,offsetX,offsetY,price,site,size,target,title,view,width;return typeof args.onStart=="function"&&args.onStart(),shoppingBarView.startDrag(),target=$(event.currentTarget),width=target.width(),height=target.height(),image=ui.helper.find(".p-image"),image.css({backgroundImage:"url('"+(args.image?args.image():args.el.attr("src"))+"')",width:width,height:height}),title=ui.helper.find(".p-title"),site=ui.helper.find(".p-site"),price=ui.helper.find(".p-price"),view=new View(args.view.contentScript),view.type="ProductClip",view.onData=function(data){return data.title.get()&&title.html(data.title.get()),view.observe(data.title,function(mutation){return title.html(mutation.value)}),data.site.get()&&site.html(data.site.get()),view.observe(data.site,function(mutation){return site.html(mutation.value)}),data.price.get()&&price.html(data.price.get()),view.observe(data.price,function(mutation){return price.html(mutation.value)})},ui.helper.data("dragging").data=args.productData(),marginLeft=0,marginTop=0,offsetX=event.pageX-target.offset().left+marginLeft,offsetY=event.pageY-target.offset().top+marginTop,ui.helper.css({marginLeft:marginLeft,width:width,height:height,zIndex:999999}),ui.helper.find(".g-productInfo").css({opacity:0}),size={width:48,height:48},clip=function(){var curve,time;return time=200,curve=null,ui.helper.animate({marginLeft:offsetX-size.width*.9,marginTop:offsetY-size.height*.9,width:148,height:size.height},time,curve),image.animate({width:44,height:44},time,curve),setTimeout(function(){if(!itemState)return ui.helper.find(".g-productInfo").animate({opacity:1},time,curve)},time)},itemState=!1,item=function(){var time;return itemState=!0,time=300,image.animate({width:44,height:44},time),ui.helper.find(".g-productInfo").stop(!0).animate({opacity:0},time,function(){}),ui.helper.stop(!0).animate({width:size.width,height:size.height,marginLeft:offsetX-size.width/2,marginTop:offsetY-size.height/2},time)},view.represent(args.productData()),ui.args.onDraggedOver=function(el){return el?(clearTimeout(clipTimerId),itemState||item(),ui.helper.addClass("adding")):ui.helper.removeClass("adding")},ui.args.stop=function(event,ui){return shoppingBarView.startDrag(),view.destruct(),ui.helper.animate({marginLeft:offsetX,marginTop:offsetY,width:10,height:10,opacity:0},100,"linear",function(){return ui.helper.remove()})},clipTimerId=setTimeout(clip,100)}}(this)})},initMosaic:function(view,el,selector,dataSource){var classesForLength,contents,prevLength,updateForLength;return contents=view.listInterface(el,selector,function(_this){return function(el,data,pos,onRemove){return data&&el.css("background-image","url("+data+")"),el}}(this)),contents.setDataSource(dataSource),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(_this){return function(){return el.removeClass(classesForLength[prevLength]),el.addClass(classesForLength[prevLength=contents.length()])}}(this),contents.onLengthChanged=updateForLength,updateForLength()},decisionPreview:function(args){var updateTooltip;return updateTooltip=function(_this){return function(){var text,_ref,_ref1;return text=((_ref=args.descriptor.get())!=null?_ref.descriptor:void 0)?(_ref1=args.descriptor.get())!=null?_ref1.descriptor:void 0:"<i>Edit Decision</i>",util.tooltip2(args.anchorEl(),"<span class='descriptorTooltip'> <span class='preview'><span class='image' /></span> <div class='descriptorWrapper'><span class='icon' /> <span class='descriptor'>"+text+"</span><a class='edit' href='#' /></div> </span>",{parentView:args.view,canFocus:!0,type:"html",anchor:args.selection.length()?args.el:void 0,distance:20,frameType:"balloon",delay:300,cancel:function(){return window.suppressPopups||args.view.shoppingBarView.disableProductPopups},init:function(el,close,view){var classesForLength,contents,edit,openCompareView,prevLength,updateForLength,_ref2;return args.view.shoppingBarView.propOpen(view),args.view.shoppingBarView.disableProductPopups=!0,icons.setIcon(el.find(".icon"),(_ref2=args.icon.get())!=null?_ref2:"list",{size:"small"}),el.find(".icon").removeClass("t-item"),edit=function(){var editDescriptorView,frame;return editDescriptorView=args.view.createView("EditDescriptor"),args.view.shoppingBarView.propOpen(editDescriptorView),editDescriptorView._mouseenter(!0),editDescriptorView.close=function(){return frame.close()},editDescriptorView.represent(args.view.data.get().id),frame=Frame.frameAround(args.el,editDescriptorView.el,{type:"balloon",distance:20,close:function(){return frame.close(),editDescriptorView.destruct()}}),tracking.page(""+args.view.path()+"/"+editDescriptorView.pathElement()),!1},el.find(".edit").click(edit),openCompareView=function(){var compareTileView,frameEl;return tracking.page(""+args.view.path()+"/DecisionPreview/Compare"),compareTileView=new CompareView(args.view.contentScript),compareTileView.shoppingBarView=args.view.shoppingBarView,frameEl=Frame.wrapInFrame(compareTileView.el,{type:"fullscreen",scroll:!0,resize:function(width,height){return[width-100,height-100]},close:function(){return compareTileView.destruct()}}),compareTileView.close=function(){return Frame.close(frameEl)},frameEl.appendTo(document.body),Frame.show(frameEl),compareTileView.setContEl(frameEl.data("client")),compareTileView.backEl=compareTileView.contEl,compareTileView.el.css({margin:"20px auto 0"}),compareTileView.represent({decision:{id:args.view.data.get().id}})},el.find(".descriptor").click(edit),el.find(".preview").click(openCompareView),contents=view.listInterface(el.find(".preview"),".image",function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}),contents.setDataSource(args.preview),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(){return el.find(".preview").removeClass(classesForLength[prevLength]),el.find(".preview").addClass(classesForLength[prevLength=contents.length()])},contents.onLengthChanged=updateForLength,updateForLength(),_tutorial(["AccessWorkspace","AccessEditDescriptor"],[el.find(".preview"),el.find(".descriptor")])},onClose:function(){return delete args.view.shoppingBarView.disableProductPopups}})}}(this),args.descriptor.observe(updateTooltip),args.selection.observe(updateTooltip),updateTooltip()},presentViewAsModalDialog:function(type,args,params){var view;return params==null&&(params={}),params.waitUntilRepresented?(view=View.createView(type),view.represent(args,function(){return util.showDialog(function(){return view})})):util.showDialog(function(){return view=View.createView(type),view.represent(args),view})},positioned:function(el){var i,parent,parents;if(el.css("position")!=="static"||el.get(0)===document.body)return el;parents=el.parents(),i=0;while(i<parents.length){parent=$(parents.get(i));if(parent.css("position")!=="static"||parent.get(0)===document.body)return parent;++i}}}}}}),define("client/util2",[],function(){return function(){return{setRating:function(el,rating,animate){var delay,i,intRating,speed,starEl,_i,_len,_ref;animate==null&&(animate=!1);if(rating==="(error)"){_ref=el.find("div div");for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)starEl=_ref[i],$(starEl).css({width:0});return el.addClass("error")}return el.removeClass("error"),intRating=parseInt(rating),el.find("div div").css({width:0}),speed=100,delay=-10,setTimeout(function(){var _j,_len1,_ref1;_ref1=el.find("div div");for(i=_j=0,_len1=_ref1.length;_j<_len1;i=++_j)starEl=_ref1[i],i<intRating&&(animate?function(starEl,i){return setTimeout(function(){return $(starEl).animate({width:18},speed)},i*(speed+delay))}(starEl,i):$(starEl).css({width:18}));if(rating-intRating)return animate?setTimeout(function(){return el.find("div:nth-child("+(intRating+1)+") div").animate({width:18*(rating-intRating)},speed)},intRating*(speed+delay)):el.find("div:nth-child("+(intRating+1)+") div").css({width:18*(rating-intRating)})},animate?500:0)},ratingHtml:"<div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div>"}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;define("client/View",[],function(){return function(){var ClientArray,ClientObject,ClientValue,Event,ListInterface,ValueInterface,View,deserialize;return ClientObject=function(){function ClientObject(args){this.args=args,this._id=args._id,this.contentScript=args.contentScript,this._name=args._name,this.view=args.view,this.listener=function(_this){return function(data){var eventType,observer,_i,_len,_ref,_results;data=_.clone(data),eventType=data.event,delete data.event;switch(eventType){case"mutation":typeof _this.onMutation=="function"&&_this.onMutation(data);if(_this.observers){_ref=_this.observers,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)observer=_ref[_i],_results.push(observer(data));return _results}break;case"disconnection":return _this.clearObservers()}}}(this),this.contentScript.mapEvent("ClientObjectEvent:"+this._id,this._name),this.contentScript.listen("ClientObjectEvent:"+this._id,this.listener,this.args.view)}return ClientObject.prototype.observe=function(cb,tag){if(!cb)throw new Error("Null observer");return this.observers==null&&(this.observers=[]),this.observers.push(cb),this.tags==null&&(this.tags=[]),this.tags.push(tag)},ClientObject.prototype.stopObserving=function(observer){var index;if(this.observers){index=this.observers.indexOf(observer);if(index!==-1)return this.observers.splice(index,1)}},ClientObject.prototype.clearObservers=function(){return this.observers=null,this.tags=null},ClientObject.prototype.clearObjs=function(removeFromView){var obj,_i,_len,_ref;removeFromView==null&&(removeFromView=!0);if(this.objs){_ref=this.objs;for(_i=0,_len=_ref.length;_i<_len;_i++)obj=_ref[_i],obj.destruct(removeFromView);return delete this.objs}},ClientObject.prototype.destruct=function(removeFromView){return removeFromView==null&&(removeFromView=!0),this.clearObservers(),removeFromView&&this.view&&this.view.clientObjects.splice(this.view.clientObjects.indexOf(this),1),this.clearObjs(removeFromView),this.contentScript.stopListening("ClientObjectEvent:"+this._id,this.listener,this)},ClientObject.prototype.setObjs=function(objs){return this.objs=objs},ClientObject.prototype.deserialize=function(data,objs){return this.view?this.view.deserialize(data,objs):deserialize(data,{ClientArray:ClientArray,ClientValue:ClientValue},{contentScript:this.contentScript},null,objs)},ClientObject}(),ClientArray=function(_super){__extends(ClientArray,_super),ClientArray.prototype.__type="ClientArray";function ClientArray(args){ClientArray.__super__.constructor.apply(this,arguments),this._array=args._array}return ClientArray.prototype.each=function(cb){return _.each(this._array,cb)},ClientArray.prototype.forEach=function(cb){return this.each(cb)},ClientArray.prototype.setArray=function(array){return this._array=array},ClientArray.prototype["delete"]=function(pos){return this._array.splice(pos,1)},ClientArray.prototype.insert=function(el,pos){return pos===0?this._array.unshift(el):pos===this._array.length?this._array.push(el):this._array.splice(pos,0,el)},ClientArray.prototype.move=function(from,to){var el;if(from!==to)return el=this._array.splice(from,1)[0],this._array.splice(to,0,el)},ClientArray.prototype._sync=function(obj){return this.setArray(this.view.deserialize(obj._array))},ClientArray.prototype.onMutation=function(mutation){switch(mutation.type){case"insertion":return this.insert(this.view.deserialize(mutation.value),mutation.position);case"deletion":return this["delete"](mutation.position);case"movement":return this.move(mutation.from,mutation.to);case"setArray":return this.setArray(this.view.deserialize(mutation.array))}},ClientArray.prototype.get=function(i){return this._array[i]},ClientArray.prototype.length=function(){return this._array.length},ClientArray}(ClientObject),window.ClientValue=ClientValue=function(_super){__extends(ClientValue,_super),ClientValue.prototype.__type="ClientValue";function ClientValue(args){ClientValue.__super__.constructor.apply(this,arguments),this._scalar=args._scalar}return ClientValue.prototype._set=function(value){return this.clearObjs(),this.objs=[],this._scalar=this.deserialize(value,this.objs)},ClientValue.prototype._sync=function(obj){return this._set(obj._scalar)},ClientValue.prototype.onMutation=function(mutation){return this._set(mutation.value)},ClientValue.prototype.get=function(){return this._scalar},ClientValue}(ClientObject),deserialize=function(obj,classMap,extraArgs,passThru,objs){var className,classObj,i,item,name,theseObjs,value,_i,_len;if(_.isObject(obj)){obj=_.clone(obj);if(_.isArray(obj))for(i=_i=0,_len=obj.length;_i<_len;i=++_i)item=obj[i],obj[i]=deserialize(item,classMap,extraArgs,passThru,objs);else if(className=obj.__class__){delete obj.__class__;if(!(classObj=classMap[className]))throw new Error("no class "+className);theseObjs=[],obj=new classObj(_.extend(deserialize(obj,classMap,extraArgs,passThru,theseObjs),extraArgs)),typeof obj.setObjs=="function"&&obj.setObjs(theseObjs),typeof passThru=="function"&&passThru(obj),objs!=null&&objs.push(obj)}else if(obj.constructor===Object)for(name in obj)value=obj[name],obj[name]=deserialize(value,classMap,extraArgs,passThru,objs)}return obj},ValueInterface=function(){function ValueInterface(view,el,attr){this.view=view,this.el=el,this.attr=attr!=null?attr:null}return ValueInterface.prototype.setMapping=function(mapping){return this.mapping=mapping,this},ValueInterface.prototype.set=function(value){return this.value=value,this.mapping&&(value=this.mapping(value)),this.attr?this.el.attr(this.attr,value):this.el.html(value)},ValueInterface.prototype.get=function(){return this.value},ValueInterface.prototype.setDataSource=function(dataSource,trigger){return this.dataSource=dataSource,this.trigger=trigger,this._observer&&dataSource.stopObserving(this._observer),this.set(dataSource.get()),typeof this.trigger=="function"&&this.trigger(dataSource.get(),this.el),dataSource.observe(this._observer=function(_this){return function(mutation){return _this.set(mutation.value),typeof _this.trigger=="function"?_this.trigger(mutation.value,_this.el):void 0}}(this))},ValueInterface.prototype.destruct=function(){if(this._observer)return this.dataSource.stopObserving(this._observer)},ValueInterface}(),ListInterface=function(){ListInterface.id=1,ListInterface.prototype.setDataSource=function(dataSource){var _ref;return(_ref=this.dataSource)!=null&&_ref.stopObserving(this._observer),this.dataSource=dataSource,this.set(dataSource),dataSource.observe(this._observer=function(_this){return function(mutation){switch(mutation.type){case"insertion":return _this.insert(_this.view.deserialize(mutation.value),mutation.position);case"deletion":return _this["delete"](mutation.position);case"movement":return _this.move(mutation.from,mutation.to);case"setArray":return _this.set(_this.view.deserialize(mutation.array))}}}(this))},ListInterface.prototype.destruct=function(){var _ref;return(_ref=this.dataSource)!=null?_ref.stopObserving(this._observer):void 0};function ListInterface(view,el,selector,mapping){this.view=view,this.el=el,this.selector=selector,this.mapping=mapping,this.id=ListInterface.id++,this.template=$(el.find(this.selector).get(0));if(this.template.length===0)throw new Error("Failed to find template");this.prevSibling=this.template.prev(),this.nextSibling=this.template.next(),this.parent=this.template.parent();if(this.parent.length===0)throw new Error("BAD");this.els=[],this.deleteCbs=[]}return ListInterface.prototype.get=function(position){return this.els[position]},ListInterface.prototype.clear=function(){var cb,_i,_len,_ref;this.el.find(this.selector).remove(),this.els=[],_ref=this.deleteCbs;for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],typeof cb=="function"&&cb();return this.deleteCbs=[],typeof this.onLengthChanged=="function"?this.onLengthChanged():void 0},ListInterface.prototype.set=function(data){return this.clear(),data.forEach(function(_this){return function(item,i){return _this.insert(item,i,!1)}}(this)),typeof this.onMutation=="function"?this.onMutation():void 0},ListInterface.prototype["delete"]=function(i){var el,_base;return el=this.els[i],this.els.splice(i,1),this.onDelete?this.onDelete(el,function(){return el.remove()}):el.remove(),typeof (_base=this.deleteCbs)[i]=="function"&&_base[i](),this.deleteCbs.splice(i,1),typeof this.onLengthChanged=="function"&&this.onLengthChanged(),typeof this.onMutation=="function"?this.onMutation():void 0},ListInterface.prototype.insert=function(data,pos,signalMutation){var el,next,setDeleteCb;signalMutation==null&&(signalMutation=!0),setDeleteCb=function(_this){return function(cb){return _this.deleteCbs.splice(pos,0,cb)}}(this),el=this.mapping(this.template.clone(),data,pos,setDeleteCb),next=this.els[pos],next?this.parent.get(0).insertBefore(el.get(0),next.get(0)):this.parent.get(0).insertBefore(el.get(0),this.nextSibling.get(0)),pos===0?this.els.unshift(el):pos===this.els.length?this.els.push(el):this.els.splice(pos,0,el),typeof this.onInsert=="function"&&this.onInsert(el),typeof this.onLengthChanged=="function"&&this.onLengthChanged();if(signalMutation)return typeof this.onMutation=="function"?this.onMutation():void 0},ListInterface.prototype.push=function(data){return this.insert(data,this.els.length)},ListInterface.prototype.move=function(from,to){var el;return el=this.els[from],from>to?el.detach().insertBefore(this.els[to]):el.detach().insertAfter(this.els[to]),el=this.els.splice(from,1)[0],this.els.splice(to,0,el),el=this.deleteCbs.splice(from,1)[0],this.deleteCbs.splice(to,0,el),typeof this.onMove=="function"&&this.onMove(from,to),typeof this.onMutation=="function"?this.onMutation():void 0},ListInterface.prototype.length=function(){return this.els.length},ListInterface}(),Event=function(){function Event(){this.subscribers=[]}return Event.prototype.subscribe=function(subscriber){return this.subscribers.push(subscriber)},Event.prototype.fire=function(){var args,subscriber,_i,_len,_ref,_results;args=1<=arguments.length?__slice.call(arguments,0):[],_ref=this.subscribers,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)subscriber=_ref[_i],_results.push(subscriber.apply(null,args));return _results},Event}(),window.View_views={},window.View_nextClientId=1,View=function(){View.flexibleViews={},View.clear=function(){var View_nextClientId,View_views,id,view;for(id in View_views)view=View_views[id],view.destruct();return View_views={},View_nextClientId=1,this.flexibleViews={}},View.windowResized=function(){return clearTimeout(this.resizeTimerId),this.resizeTimerId=setTimeout(function(_this){return function(){var view,viewId,_ref,_results;_ref=_this.flexibleViews,_results=[];for(viewId in _ref)view=_ref[viewId],_results.push(typeof view.updateLayout=="function"?view.updateLayout():void 0);return _results}}(this),50)},View.isClientValue=function(obj){return obj.__type==="ClientValue"},View.isClientArray=function(obj){return obj.__type==="ClientArray"},View.createView=function(){var args,className,view;return className=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],view=null,className?(className.match(/View$/)||(className+="View"),eval("klass = "+className),args&&args.length?view=function(func,args,ctor){ctor.prototype=func.prototype;var child=new ctor,result=func.apply(child,args);return Object(result)===result?result:child}(klass,[contentScript].concat(__slice.call(args)),function(){}):view=new klass(contentScript)):view=new View(contentScript),view},View.prototype.withData=function(data,cb){return data.get()!=null&&cb(data.get()),data.observe(function(mutation){return cb(data.get(),mutation)})};function View(){var args,contentScript;contentScript=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],this.contentScript=contentScript,this.clientId=View_nextClientId++,this.clientObjects=[],this.observedObjects=[],this.views=[],this.interfaces=[],this.trackingViews=[],this.mouseEnteredCount=0,this.prevMouseEnteredCount=0,typeof this.init=="function"&&this.init.apply(this,args),this.flexibleLayout&&(View.flexibleViews[this.clientId]=this),View.inited||(View.inited=!0,$(window).resize(function(){return View.windowResized()})),this.events={onDestruct:new Event}}return View.prototype.alsoRepresent=function(view){return this.representList==null&&(this.representList=[]),this.representList.push(view)},View.prototype.useEl=function(el){return this.el=el,el.data("view",this),el.mouseenter(function(_this){return function(){return _this._mouseenter(!0)}}(this)),el.mouseleave(function(_this){return function(){return _this._mouseleave(!0)}}(this)),el},View.prototype.viewEl=function(html){var el;return el=$(html),this.useEl(el),el},View.prototype.createView=function(){var args,className,view;return className=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],view=View.createView.apply(View,[className].concat(__slice.call(args))),this.views.push(view),view.parent=this,view},View.prototype.view=function(){return this.createView.apply(this,arguments)},View.prototype.syncWithValue=function(value,cb){return cb(value.get()),this.observe(value,function(){return cb(value.get())})},View.prototype.isAttached=function(){return typeof this.id!="undefined"},View.prototype.attach=function(cb){return this.contentScript.triggerBackgroundEvent("CreateView",{type:this.type},function(_this){return function(response){_this.id=response.id,_this.el&&_this.el.attr("agora:id",_this.id),View_views[_this.id]=_this,_this.contentScript.listen("ViewMethod:"+_this.id,function(args){return _this.callMethod(args.name,args.params)});if(cb)return cb()}}(this))},View.prototype.detach=function(){this.clearClientObjects(),this.contentScript.stopListening("ViewMethod:"+this.id);if(this.id!=null)return this.contentScript.triggerBackgroundEvent("DeleteView",{id:this.id})},View.prototype.represent=function(args,cb){var view,_i,_len,_ref;this.args=args;if(this.isAttached()){typeof this.onRepresent=="function"&&this.onRepresent(this.args);if(this.representList){_ref=this.representList;for(_i=0,_len=_ref.length;_i<_len;_i++)view=_ref[_i],view.represent(this.args)}return this.contentScript.triggerBackgroundEvent("ConnectView",{id:this.id,args:args},function(_this){return function(response){var clientObject,ids,map,_j,_len1,_ref1;_this.data=_this.deserialize(response.data),map={},ids=[],_ref1=_this.clientObjects;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)clientObject=_ref1[_j],ids.push(clientObject._id),map[clientObject._id]=clientObject;return _this.contentScript.triggerBackgroundEvent("GetClientObjects",ids,function(response){var id,value;for(id in response)value=response[id],map[id]._sync(value);return typeof _this.onData=="function"&&_this.onData(_this.data),typeof cb=="function"?cb():void 0})}}(this))}return this.attach(function(_this){return function(){return _this.represent(args,cb)}}(this))},View.prototype.deserialize=function(data,objs){return deserialize(data,{ClientArray:ClientArray,ClientValue:ClientValue},{contentScript:this.contentScript,view:this},function(_this){return function(obj){return _this.clientObjects.push(obj)}}(this),objs)},View.prototype.callBackgroundMethod=function(methodName,args,returnValueCb){if(this.id)return this.contentScript.triggerBackgroundEvent("CallViewBackgroundMethod",{view:this.type,id:this.id,methodName:methodName,args:args,timestamp:(new Date).getTime()},function(response){return returnValueCb(response)});throw new Error("not connected")},View.prototype._addInterface=function(iface){return this.interfaces.push(iface),iface},View.prototype.listInterface=function(el,selector,mapping){return this._addInterface(new ListInterface(this,el,selector,mapping))},View.prototype.valueInterface=function(el,attr){return attr==null&&(attr=null),this._addInterface(new ValueInterface(this,el,attr))},View.prototype.callMethod=function(name,params){var method;if(this.methods&&(method=this.methods[name]))return method.apply(this,params)},View.prototype.observe=function(observable,observer){return this.observedObjects.push({object:observable,observer:observer}),observable.observe(observer,this)},View.prototype.observeObject=function(observable,observer){return this.observe(observable,observer)},View.prototype.clearClientObjects=function(){var clientObject,_i,_len,_ref;_ref=this.clientObjects;for(_i=0,_len=_ref.length;_i<_len;_i++)clientObject=_ref[_i],clientObject.destruct(!1);return this.clientObjects=[]},View.prototype.clearInterfaces=function(){var iface,_i,_len,_ref;_ref=this.interfaces;for(_i=0,_len=_ref.length;_i<_len;_i++)iface=_ref[_i],iface.destruct();return this.interfaces=[]},View.prototype.trackView=function(view){return view.trackingViews==null&&(view.trackingViews=[]),view.trackingViews.push(this),this.trackedViews==null&&(this.trackedViews=[]),this.trackedViews.push(view)},View.prototype.clearViews=function(){var view,_i,_len,_ref;_ref=_.clone(this.views);for(_i=0,_len=_ref.length;_i<_len;_i++)view=_ref[_i],view||console.error("null view!",this),view!=null&&view.destruct(!0,this);return this.views=[]},View.prototype.stopObservingObjects=function(){var object,observer,_i,_len,_ref,_ref1;_ref=this.observedObjects;for(_i=0,_len=_ref.length;_i<_len;_i++)_ref1=_ref[_i],object=_ref1.object,observer=_ref1.observer,object.stopObserving(observer);return this.observedObjects=[]},View.prototype.clear=function(){var view,_i,_len,_ref;this.clearClientObjects(),this.stopObservingObjects(),this.clearViews(),this.clearInterfaces();if(this.trackedViews){_ref=this.trackedViews;for(_i=0,_len=_ref.length;_i<_len;_i++)view=_ref[_i],view.destruct(!0,this)}return delete this.trackedViews},View.prototype.pathElement=function(){var parts;return parts=this.type.split("/"),parts[parts.length-1]},View.prototype.path=function(){return this.type?this.basePath?""+this.basePath+"/"+this.pathElement():this.parent?""+this.parent.path()+"/"+this.pathElement():"/"+this.pathElement():this.parent?this.parent.path():"/"},View.prototype.event=function(action,label){var parts;return label==null&&(label=null),parts=this.type.split("/"),tracking.event(parts[parts.length-1],action,label)},View.prototype.separate=function(){var view,_i,_len,_ref;_.pull(this.parent.views,this);if(this.trackingViews){_ref=this.trackingViews;for(_i=0,_len=_ref.length;_i<_len;_i++)view=_ref[_i],_.pull(view.trackedViews,this)}return delete this.trackingViews},View.prototype.destruct=function(removeFromParent,destructor){removeFromParent==null&&(removeFromParent=!0),destructor==null&&(destructor=null);if(this.noDestruct)return;this.mouseEntered&&this._mouseleave(!0);if(!this.destructed)return this.flexibleLayout&&delete View.flexibleViews[this.clientId],this.detach(),this.clear(),this.parent&&removeFromParent&&_.pull(this.parent.views,this),this.destructed=!0,this.events.onDestruct.fire()},View.prototype.shown=function(){},View.prototype._testMouseEntered=function(){return clearTimeout(this._testMouseEnteredTimerId),this._testMouseEnteredTimerId=setTimeout(function(_this){return function(){if(_this.mouseEnteredCount!==_this.prevMouseEnteredCount)return _this.mouseEnteredCount&&!_this.prevMouseEnteredCount?typeof _this.onMouseenter=="function"&&_this.onMouseenter():!_this.mouseEnteredCount&&_this.prevMouseEnteredCount&&typeof _this.onMouseleave=="function"&&_this.onMouseleave(),_this.prevMouseEnteredCount=_this.mouseEnteredCount}}(this),100)},View.prototype._mouseenter=function(self){var _ref;self==null&&(self=!1);if(self){if(this.mouseEntered)return;this.mouseEntered=!0}return this.mouseEnteredCount++,(_ref=this.parent)!=null&&_ref._mouseenter(),this._testMouseEntered()},View.prototype._mouseleave=function(self){var _ref;self==null&&(self=!1);if(self){if(!this.mouseEntered)return;this.mouseEntered=!1}return this.mouseEnteredCount--,(_ref=this.parent)!=null&&_ref._mouseleave(),this._testMouseEntered()},View}()}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/AddArgumentView",[],function(){return{d:["View","util","icons"],c:function(){var AddArgumentView;return AddArgumentView=function(_super){__extends(AddArgumentView,_super),AddArgumentView.prototype.type="AddArgument";function AddArgumentView(){var arugmentEl,parse,positionPreviewEl;AddArgumentView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-addArgument dark"> <div class="content"> <ul class="arguments"> <li> <span class="position" /> <span class="thought" /> <a href="#" class="delete" /> </li> </ul> <form> <input type="text" name="argument" placeholder="Add argument" autocomplete="off"><span class="positionPreview" /> <!--<input type="submit" value="Add">--> </form> </div> </div>'),parse=function(argument){var against,char,i,j,pro,_i,_j,_ref,_ref1;against=0,pro=0,argument=argument.trim();for(i=_i=0,_ref=argument.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){char=argument[i];if(char==="-")++against;else{if(char!=="+")break;++pro}}argument=argument.substr(i);for(j=_j=_ref1=argument.length-1;_ref1<=0?_j<0:_j>0;j=_ref1<=0?++_j:--_j){char=argument[j];if(char==="-")++against;else{if(char!=="+")break;++pro}}return argument=argument.substr(0,j+1).trim(),[pro,against,argument]},arugmentEl=this.el.find("[name=argument]"),positionPreviewEl=this.el.find(".positionPreview"),arugmentEl.keydown(function(_this){return function(e){if(e.keyCode===27)return _this.close(!0)}}(this)),arugmentEl.keyup(function(_this){return function(e){var against,position,pro,_ref;return _ref=parse(arugmentEl.val()),pro=_ref[0],against=_ref[1],position=util.positionClass(pro,against),positionPreviewEl.removeClass().addClass("positionPreview").addClass(position)}}(this)),this.el.find("form").submit(function(_this){return function(e){var against,pro,thought,_ref;return e.preventDefault(),_ref=parse(arugmentEl.val()),pro=_ref[0],against=_ref[1],thought=_ref[2],_this.callBackgroundMethod("add",[pro,against,thought]),_this.el.find('form [name="argument"]').val(""),setTimeout(function(){return _this.close()},700),!1}}(this))}return AddArgumentView.prototype.onData=function(data){var iface;return this.data=data,iface=this.listInterface(this.el,".arguments li",function(_this){return function(el,data,pos,onRemove){var previousPosition,updateForPosition,view;return view=_this.view(),onRemove(function(){return view.destruct()}),view.valueInterface(el.find(".thought")).setDataSource(data.thought),previousPosition=null,updateForPosition=function(){var position;return position=util.positionClass(data["for"].get(),data.against.get()),previousPosition&&el.find(".position").removeClass(previousPosition),el.find(".position").addClass(position),previousPosition=position},data["for"].observe(updateForPosition),data.against.observe=updateForPosition,updateForPosition(),el.find(".delete").click(function(){return _this.callBackgroundMethod("delete",data.id),!1}),el}}(this)),iface.onInsert=function(_this){return function(){return typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),iface.onDelete=function(_this){return function(el,del){return del(),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),iface.setDataSource(data),setTimeout(function(_this){return function(){return _this.el.find("[name=argument]").get(0).focus()}}(this),50)},AddArgumentView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/AddDataView",[],function(){return{d:["View","util","icons"],c:function(){var AddDataView;return AddDataView=function(_super){__extends(AddDataView,_super),AddDataView.prototype.type="AddData";function AddDataView(contentScript,opts){var args,formEl,linkEl,selection,selectionText,setType,type,viewType;AddDataView.__super__.constructor.apply(this,arguments),viewType=opts.type,viewType==="drag"?this.el=this.viewEl('<div class="v-addData t-dialog"> <h2>Clip</h2> <div class="content"> <form> <div class="field"> <select name="type"> <option>Content Type</option> <option value="image">Image</option> <option value="video">Video</option> <option value="url">Page</option> <option value="plainText">Text</option> <option value="richText">Rich Text</option> </select> </div> <div class="field"><input type="text" name="title" placeholder="Title"></div> <div class="field"><input type="text" name="url" placeholder="URL"></div> <div class="field"><input type="text" name="text" placeholder="Text"></div> <div class="field"><input type="text" name="comment" placeholder="Comment"></div> </form> <span class="t-item -agora-addData-link" /> </div> </div>'):viewType==="connected"&&(this.el=this.viewEl('<div class="v-addData t-dialog"> <div class="content"> <form> <div class="field"> <select name="type"> <option>Content Type</option> <option value="image">Image</option> <option value="video">Video</option> <option value="url">Page</option> <option value="plainText">Text</option> <option value="richText">Rich Text</option> </select> </div> <div class="field"><input type="text" name="title" placeholder="Title"></div> <div class="field"><input type="text" name="url" placeholder="URL"></div> <div class="field"><input type="text" name="text" placeholder="Text"></div> <div class="field"><input type="text" name="comment" placeholder="Comment"></div> <input type="submit"> </form> </div> </div>')),this.el.addClass(viewType),setType=function(_this){return function(type){return _this.el.find("select[name=type] option[value="+type+"]").prop("selected",!0),_this.el.find("[name=type]").trigger("change")}}(this),this.values={},this.set=function(_this){return function(prop,value){return _this.values[prop]=value,prop==="type"?setType(value):_this.el.find("input[name="+prop+"]").val(value)}}(this),opts.title&&this.set("title",opts.title),type=null,opts.url.match(/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/)?this.set("url",opts.url):(type="plainText",this.set("text",opts.url)),viewType==="drag"&&(rangy.initialized||rangy.init(),selection=rangy.getSelection(),selectionText=selection.toString(),selectionText!==""&&(type="plainText",this.set("text",selectionText))),type||opts.url.match(/(^https?:\/\/www\.youtube.com\/watch|^http:\/\/vimeo.com\/\d+)/)&&(type="video"),args={object:opts.args},type&&this.set("type",type),args.url=opts.url,this.represent(args),viewType==="drag"?(linkEl=this.el.find(".-agora-addData-link"),formEl=this.el.find("form").get(0),util.tooltip(linkEl,"drag to a product",{position:"below"}),util.initDragging(linkEl,{context:"page",action:"addData",breaksImmutability:!0,data:function(cb){return cb({action:"addData",data:{type:formEl.type.value,title:formEl.title.value,url:formEl.url.value,text:formEl.text.value,comment:formEl.comment.value}})},helper:function(e,el){return el.clone().addClass("-agora dragging")},onDraggedOver:function(activeEl,helperEl){return activeEl?helperEl.addClass("adding"):helperEl.removeClass("adding")},start:function(_this){return function(){return linkEl.css({opacity:.5})}}(this),stop:function(_this){return function(event,ui){return linkEl.animate({opacity:1}),ui.helper.detach(),_this.close()}}(this)})):viewType==="connected"&&this.el.find("form").submit(function(_this){return function(){return _this.submit(),!1}}(this)),util.styleSelect(this.el.find("[name=type]"),{autoSize:!1})}return AddDataView.prototype.submit=function(){var formEl;return formEl=this.el.find("form").get(0),this.callBackgroundMethod("add",{type:formEl.type.value,title:formEl.title.value,url:formEl.url.value,text:formEl.text.value,comment:formEl.comment.value}),this.close(),typeof this.onSubmit=="function"?this.onSubmit():void 0},AddDataView.prototype.onData=function(data){data.title&&!this.values.title&&this.set("title",data.title);if(data.type&&!this.values.type)return this.set("type",data.type)},AddDataView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/AddDescriptorView",[],function(){return{d:["View","util","icons"],c:function(){var AddDescriptorView;return AddDescriptorView=function(_super){__extends(AddDescriptorView,_super),AddDescriptorView.prototype.type="AddDescriptor";function AddDescriptorView(){var descriptorEl,el,parseTimerId;AddDescriptorView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-addDescriptor t-dialog"> <h2>Add something</h2> <div class="content"> <form class="dark"> <div class="group descriptor"> <div class="field"><input type="text" class="descriptor" placeholder="Describe what you are looking for"></div> </div> <div class="group"> <div class="field"><label>Product</label> <input type="text" name="product" placeholder="Product"></div> <div class="field"><label>Purpose</label> <input type="text" name="purpose" placeholder="Purpose"></div> <div class="field"><label>Context</label> <input type="text" name="context" placeholder="Context"></div> </div> <div class="group properties"> <div class="field"><label>Properties</label> <input type="text" name="properties" placeholder="Properties"></div> </div> <div class="group recipient"> <div class="field"><label>Recipient</label> <input type="text" name="recipient" placeholder="Recipient"></div> <div class="field"><label>Relationship</label> <input type="text" name="recipient.relationship" placeholder="Relationship"></div> <div class="field"><label>Age</label> <input type="text" name="recipient.age" placeholder="Age"></div> <div class="field"> <label>Sex</label> <select name="recipient.sex"> <option>Sex</option> <option name="male">Male</option> <option name="female">Female</option> </select> </div> </div> <div class="group gift"> <div class="field"><label>Gift</label> <input type="checkbox" name="gift"> </div> <div class="field gift"><label>Occasion</label> <input type="text" name="gift.occasion" placeholder="Occasion"></div> </div> </form> <span class="t-item -agora-newItem" /> </div> </div>'),icons.setIcon(this.el.find(".-agora-newItem"),"list"),parseTimerId=null,descriptorEl=this.el.find("input.descriptor"),descriptorEl.keydown(function(_this){return function(){return clearTimeout(parseTimerId),parseTimerId=setTimeout(function(){return _this.callBackgroundMethod("parse",[descriptorEl.val()])},500)}}(this)),util.styleSelect(this.el.find('[name="recipient.sex"]'),{autoSize:!1}),el=this.el.find(".-agora-newItem"),util.tooltip(this.el.find(".-agora-newItem"),function(_this){return function(){return descriptorEl.val()}}(this),{position:"below"}),util.initDragging(this.el.find(".-agora-newItem"),{data:function(_this){return function(cb){var descriptor,_ref;return descriptor=(_ref=_this.descriptor)!=null?_ref:{},descriptor.descriptor=descriptorEl.val(),cb({action:"new",type:"descriptor",descriptor:descriptor})}}(this),context:"page",onDraggedOver:function(activeEl,helperEl){return activeEl?helperEl.addClass("adding"):helperEl.removeClass("adding")},helper:function(){return el.clone().addClass("-agora dragging")},start:function(){return el.css({opacity:.5})},stop:function(_this){return function(event,ui){return el.animate({opacity:1}),ui.helper.detach(),_this.close()}}(this)}),setTimeout(function(_this){return function(){return descriptorEl.get(0).focus()}}(this),50)}return AddDescriptorView.prototype.onData=function(data){return this.data=data,data.observe(function(_this){return function(){var descriptor,_ref,_ref1,_ref10,_ref11,_ref12,_ref13,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;return descriptor=_this.descriptor=data.get().descriptor,_this.el.find('[name="product"]').val((_ref=(_ref1=descriptor.product)!=null?_ref1.type:void 0)!=null?_ref:""),_this.el.find('[name="purpose"]').val((_ref2=descriptor.purpose)!=null?_ref2:""),_this.el.find('[name="context"]').val((_ref3=descriptor.context)!=null?_ref3:""),((_ref4=descriptor.product)!=null?_ref4.properties:void 0)?_this.el.find('[name="properties"]').val(descriptor.product.properties.join(", ")):_this.el.find('[name="properties"]').val(""),_this.el.find('[name="recipient"]').val((_ref5=(_ref6=descriptor.person)!=null?_ref6.name:void 0)!=null?_ref5:""),_this.el.find('[name="recipient.relationship"]').val((_ref7=(_ref8=descriptor.person)!=null?_ref8.relationship:void 0)!=null?_ref7:""),_this.el.find('[name="recipient.age"]').val((_ref9=(_ref10=descriptor.person)!=null?_ref10.age:void 0)!=null?_ref9:""),((_ref11=descriptor.person)!=null?_ref11.sex:void 0)?_this.el.find('[name="recipient.sex"]').children("[name="+((_ref12=descriptor.person)!=null?_ref12.sex:void 0)+"]").prop("selected",!0):_this.el.find('[name="recipient.sex"]').children(":first").prop("selected",!0),_this.el.find('[name="recipient.sex"]').trigger("change"),"occasion"in descriptor?(_this.el.find('[name="gift"]').prop("checked",!0),_this.el.find('[name="gift.occasion"]').val(descriptor.occasion)):(_this.el.find('[name="gift"]').prop("checked",!1),_this.el.find('[name="gift.occasion"]').val("")),icons.setIcon(_this.el.find(".-agora-newItem"),(_ref13=data.get().icon)!=null?_ref13:"list")}}(this))},AddDescriptorView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/AddFeelingView",[],function(){return{d:["View","util","icons"],c:function(){var AddFeelingView;return AddFeelingView=function(_super){__extends(AddFeelingView,_super);function AddFeelingView(){return AddFeelingView.__super__.constructor.apply(this,arguments)}return AddFeelingView.prototype.type="AddFeeling",AddFeelingView.prototype.init=function(args){var emotionEl,feelingEl,parse;return args==null&&(args={}),this.el=this.viewEl('<div class="v-addFeeling dark"> <div class="content"> <ul class="feelings"> <li> <span class="emotion" /> <span class="thought" /> <a href="#" class="delete" /> </li> </ul> <form> <input type="text" name="feeling" placeholder="Add feeling" autocomplete="off"><span class="emotionSummary neutral" /> <!--<input type="submit" value="Add">--> </form> </div> </div>'),parse=function(feeling){var char,emotion,emotionWords,i,index,j,map,matchingFeeling,negative,pattern,positive,word,wordList,words,_i,_j,_k,_l,_len,_len1,_ref,_ref1;negative=0,positive=0,feeling=feeling.trim();for(i=_i=0,_ref=feeling.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){char=feeling[i];if(char==="-")++negative;else{if(char!=="+")break;++positive}}feeling=feeling.substr(i);for(j=_j=_ref1=feeling.length-1;_ref1<=0?_j<0:_j>0;j=_ref1<=0?++_j:--_j){char=feeling[j];if(char==="-")++negative;else{if(char!=="+")break;++positive}}feeling=feeling.substr(0,j+1).trim();if(!negative&&!positive){words={"-2":["hate","really dont like","terrible","disgusting"],"-1":["dont like","bad","ugly","poor","stupid","dumb","shitty","stinks","nasty","wretched","low quality","sad"],1:["like","cool","good","nice","classy","tasteful","cute","happy"],2:["love","awesome","great","perfect","fantastic","wonderful","beautiful","sensational","magical"]},wordList=[],map={};for(emotion in words){emotionWords=words[emotion];for(_k=0,_len=emotionWords.length;_k<_len;_k++)word=emotionWords[_k],map[word]=parseInt(emotion),wordList.push(word)}wordList.sort(function(a,b){return b.length-a.length}),matchingFeeling=feeling.replace("'","").split(/\s+/).join(" ");for(_l=0,_len1=wordList.length;_l<_len1;_l++)word=wordList[_l],pattern=new RegExp("\\b"+word+"\\b","i"),(index=matchingFeeling.search(pattern))!==-1&&(matchingFeeling=matchingFeeling.replace(pattern,""),emotion=map[word],emotion<0?negative-=emotion:emotion>0&&(positive+=emotion))}return[positive,negative,feeling]},feelingEl=this.el.find("[name=feeling]"),emotionEl=this.el.find(".emotionSummary"),feelingEl.keydown(function(_this){return function(e){if(e.keyCode===27)return _this.close(!0),e.stopPropagation()}}(this)),feelingEl.keyup(function(_this){return function(e){var emotion,negative,positive,_ref;return typeof _this.pin=="function"&&_this.pin(),_ref=parse(feelingEl.val()),positive=_ref[0],negative=_ref[1],emotion=util.emotionClass(positive,negative),emotionEl.removeClass().addClass("emotionSummary").addClass(emotion)}}(this)),this.el.find("form").submit(function(_this){return function(e){var negative,positive,thought,_ref;return e.preventDefault(),_ref=parse(feelingEl.val()),positive=_ref[0],negative=_ref[1],thought=_ref[2],args.auto?_this.event("add","auto"):_this.event("add"),_this.callBackgroundMethod("add",[positive,negative,thought]),_this.el.find('form [name="feeling"]').val(""),setTimeout(function(){return _this.close()},700),!1}}(this))},AddFeelingView.prototype.onData=function(data){var iface;return this.data=data,iface=this.listInterface(this.el,".feelings li",function(_this){return function(el,data,pos,onRemove){var previousEmotion,updateForEmotion,view;return view=_this.view(),onRemove(function(){return view.destruct()}),view.valueInterface(el.find(".thought")).setDataSource(data.thought),previousEmotion=null,updateForEmotion=function(){var emotion;return emotion=util.emotionClass(data.positive.get(),data.negative.get()),previousEmotion&&el.find(".emotion").removeClass(previousEmotion),el.find(".emotion").addClass(emotion),previousEmotion=emotion},data.positive.observe(updateForEmotion),data.negative.observe=updateForEmotion,updateForEmotion(),el.find(".delete").click(function(){return _this.event("delete"),_this.callBackgroundMethod("delete",data.id),!1}),el}}(this)),iface.onInsert=function(_this){return function(){return typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),iface.onDelete=function(_this){return function(el,del){return del(),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),iface.setDataSource(data),setTimeout(function(_this){return function(){return _this.el.find("[name=feeling]").get(0).focus()}}(this),50)},AddFeelingView.prototype.shown=function(){return this.event("open"),_tutorial("AddFeeling",this.el.find('form [name="feeling"]'))},AddFeelingView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/AddItemView",[],function(){return{d:["View","util","icons"],c:function(){var AddItemView;return AddItemView=function(_super){__extends(AddItemView,_super),AddItemView.prototype.type="AddItem";function AddItemView(){var type,_fn,_i,_len,_ref;AddItemView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-addItem t-dialog"> <h2>Add something</h2> <div class="content"> <input type="text" class="filter" placeholder="Describe what you are looking for"> <div class="itemList"> <!--<span class="item" />--> </div> </div> </div>'),_ref=["decision","bundle","computer","session","list","descriptor"],_fn=function(_this){return function(type){var el;return el=$("<span class='-agora-newItem' />"),icons.setIcon(el,type),util.tooltip(el,type,{position:"below"}),util.initDragging(el,{data:function(cb){return cb(type==="descriptor"?{action:"new",type:type,descriptor:_this.el.find(".filter").val()}:{action:"new",type:type})},context:"page",onDraggedOver:function(activeEl,helperEl){return activeEl?helperEl.addClass("adding"):helperEl.removeClass("adding")},helper:function(){return el.clone().addClass("-agora dragging")},start:function(){return el.css({opacity:.5})},stop:function(event,ui){return el.animate({opacity:1}),ui.helper.detach(),_this.close()}}),_this.el.find(".itemList").append(el)}}(this);for(_i=0,_len=_ref.length;_i<_len;_i++)type=_ref[_i],_fn(type)}return AddItemView.prototype.onData=function(data){this.data=data},AddItemView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/BuyView",[],function(){return{d:["View","util","icons"],c:function(){var BuyView;return BuyView=function(_super){__extends(BuyView,_super),BuyView.prototype.type="Buy";function BuyView(){BuyView.__super__.constructor.apply(this,arguments),this.viewEl('<div class="v-buy t-dialog"> <h2>Buy</h2> <div class="content"> <iframe /> </div> </div>')}return BuyView.prototype.onData=function(data){if(data.url)return this.el.find("iframe").attr("src",data.url)},BuyView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ChatView",[],function(){return{d:["View","Frame","views/OffersView","views/DataView","views/AddFeelingView","views/AddArgumentView"],c:function(){var ChatView;return ChatView=function(_super){__extends(ChatView,_super);function ChatView(){return ChatView.__super__.constructor.apply(this,arguments)}return ChatView.prototype.type="Chat",ChatView.prototype.init=function(bagsbyEl){var messageEl;return this.bagsbyEl=bagsbyEl,this.el=this.viewEl('<div class="v-chat"> <div class="wrapper scroll vertical"> <div class="intro">Hey there! It looks like you’re doing some shopping! Let me know if you have any questions or comments and I’ll get back to you ASAP.</div> <ul class="messages"><li class="message" /></ul> </div> <form> <input type="text" placeholder="Type a message and press enter to send..." class="message"> </form> </div>'),this.el.find("form").submit(function(){return!1}),this.messageEl=messageEl=this.el.find("form .message"),messageEl.keyup(function(_this){return function(e){if(e.keyCode===27){_this.close();return}return e.keyCode===13&&(_this.callBackgroundMethod("sendMessage",[messageEl.val()]),messageEl.val("")),_this.callBackgroundMethod("writingMessage",[messageEl.val()])}}(this)),Q(window).blur(function(_this){return function(){return _this.windowFocused=!1}}(this)),Q(window).focus(function(_this){return function(){_this.windowFocused=!0;if(_this.isReadingMessages())return _this.callBackgroundMethod("readNewMessages")}}(this))},ChatView.prototype.isReadingMessages=function(){return this.windowFocused&&this.open},ChatView.prototype.scrollToBottom=function(){return this.el.find(".wrapper .scrollWrapper").scrollTop(this.el.find(".wrapper .scrollWrapper").get(0).scrollHeight)},ChatView.prototype.onData=function(data){var iface;return this.data=data,this.withData(data.online,function(_this){return function(online){return online?(_this.el.addClass("online"),_this.bagsbyEl.addClass("online")):(_this.el.removeClass("online"),_this.bagsbyEl.removeClass("online"))}}(this)),iface=this.listInterface(this.el,".messages .message",function(_this){return function(el,data,pos,onRemove){return el.html("<span class='sender"+(data.sender?"":" you")+"'>"+(data.sender?"Bagsby":"you")+"</span> <span class='content'>"+data.content+"</span> ")}}(this)),this.data.newMessages.observe(function(_this){return function(){if(_this.isReadingMessages())return _this.callBackgroundMethod("readNewMessages")}}(this)),this.withData(data.newUnreadMessages,function(_this){return function(newUnreadMessages){return newUnreadMessages?_this.bagsbyEl.addClass("newMessages"):_this.bagsbyEl.removeClass("newMessages")}}(this)),iface.onInsert=function(_this){return function(){typeof _this.sizeChanged=="function"&&_this.sizeChanged();if(_this.lockedAtBottom)return _this.scrollToBottom()}}(this),iface.onDelete=function(_this){return function(el,del){return del(),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),iface.setDataSource(data.messages)},ChatView.prototype.onDisplay=function(){var lockBottom,unlockBottom,wrapperEl;return this.lockedAtBottom=!0,setTimeout(function(_this){return function(){return _this.messageEl.get(0).focus()}}(this),10),this.open=!0,this.windowFocused=!0,this.callBackgroundMethod("readNewMessages"),this.initedScrollbar||(util.initScrollbar(this.el.find(".wrapper"),{absolute:!1}),this.initedScrollbar=!0,wrapperEl=this.el.find(".wrapper .scrollWrapper"),this.lockedAtBottom=!1,lockBottom=function(_this){return function(){if(!_this.lockedAtBottom)return _this.lockedAtBottom=!0}}(this),unlockBottom=function(_this){return function(){if(_this.lockedAtBottom)return _this.lockedAtBottom=!1}}(this),wrapperEl.scroll(function(_this){return function(){return wrapperEl.get(0).scrollHeight-wrapperEl.height()-wrapperEl.scrollTop()<=5?lockBottom():unlockBottom()}}(this))),this.scrollToBottom()},ChatView.prototype.onClose=function(){return this.open=!1},ChatView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/CollaborateView",[],function(){return{d:["View","util","icons","Frame2","views/DecisionPreviewView"],c:function(){var CollaborateView;return CollaborateView=function(_super){__extends(CollaborateView,_super),CollaborateView.prototype.type="Collaborate";function CollaborateView(){CollaborateView.__super__.constructor.apply(this,arguments),this.viewEl('<div class="v-collaborate collaborators"> <div class="tabs"> <div class="tab collaborators">Collaborators</div> <div class="tab activity">Activity</div> </div> <div class="content"> <div class="collaborators"> <ul class="collaborators"> <li class="collaborator"> <span class="abbreviation" /> <span class="name" /> <a href="#" class="delete" /> </li> </ul> <a href="#" class="invite">Invite Collaborators</a> </div> <div class="activity"> <ul class="activity"> <li class="entry"> <span class="type" /> <span class="imagePreview" /> <span class="text" /> <span class="timestamp" /> </li> </ul> </div> </div> </div>'),this.el.find(".tabs .collaborators").click(function(_this){return function(){return _this.el.removeClass("activity"),_this.el.addClass("collaborators")}}(this)),this.el.find(".tabs .activity").click(function(_this){return function(){return _this.el.addClass("activity"),_this.el.removeClass("collaborators")}}(this)),util.trapScrolling(this.el.find("ul.activity")),this.el.find(".invite").click(function(_this){return function(){return util.showDialog(function(){var view;return view=new ShareView(_this.contentScript),view.represent(_this.args),view}),!1}}(this))}return CollaborateView.prototype.onDisplay=function(){},CollaborateView.prototype.onClose=function(){},CollaborateView.prototype.configure=function(data){return this.stateView&&this.stateView.destruct(),this.stateView=this.createView(),data.owner?this.el.addClass("owner"):this.el.removeClass("owner"),this.el.find("ul.collaborators").html('<li class="collaborator"> <span class="abbreviation" /> <span class="name" /> <a href="#" class="delete" /> </li>'),this.stateView.listInterface(this.el.find("ul.collaborators"),".collaborator",function(_this){return function(el,data,pos,onRemove){var view;return view=_this.stateView.createView(),onRemove(function(){return view.destruct()}),data.pending?(el.addClass("pending"),el.find(".abbreviation").html("..."),el.find(".name").html(data.name+" (pending)"),el.find(".delete").click(function(){return _this.callBackgroundMethod("deletePending",[data.id]),!1})):(view.withData(data.abbreviation,function(abbreviation){return el.find(".abbreviation").html(abbreviation)}),data.color==="#FFFFFF"&&el.find(".abbreviation").addClass("white"),el.find(".abbreviation").css({backgroundColor:data.color}),view.withData(data.name,function(name){return data.owner&&(name+=" (owner)"),el.find(".name").html(name)}),data.owner?el.find(".delete").remove():el.find(".delete").click(function(){return _this.callBackgroundMethod("delete",[data.id]),!1})),el}}(this)).setDataSource(data.collaborators),this.el.find("ul.activity").html('<li class="entry"> <span class="type" /> <span class="imagePreview" /> <span class="text" /> <span class="timestamp" /> </li>'),this.stateView.listInterface(this.el.find("ul.activity"),".entry",function(_this){return function(el,data,pos,onRemove){var classesForLength,comp,image,imageEl,objEl,textEl,view,_fn,_i,_j,_len,_len1,_ref,_ref1;view=_this.stateView.createView(),onRemove(function(){return view.destruct()}),el.addClass(data.type.replace(".","-"));if(data.images.length){el.addClass("hasImage"),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},el.find(".imagePreview").addClass(classesForLength[data.images.length]),_ref=data.images,_fn=function(imageEl){if(image==="decision")return icons.setIcon(imageEl,"list",{itemClass:!1});if(image==="bundle")return icons.setIcon(imageEl,"bundle",{itemClass:!1});if(image!=="belt")return _this.withData(image,function(image){return imageEl.css("backgroundImage","url("+image+")")})};for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],imageEl=$('<span class="image" />').appendTo(el.find(".imagePreview")),_fn(imageEl)}textEl=el.find(".text"),_ref1=data.text;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)comp=_ref1[_j],typeof comp=="string"?textEl.append(document.createTextNode(comp)):(objEl=$('<span class="object" />'),comp.type==="user"?(objEl.addClass("user"),objEl.html("<span class='name'>"+comp.text+"</span> <span class='color' style='background-color: "+comp.color+"' />")):comp.model?(comp.model==="Product"?(objEl.addClass("product"),function(comp,objEl){var popup;return objEl.click(function(){return util.openProductPreview({modelName:"Product",instanceId:comp.id})}),_this.el.find(".activity").one("scroll",function(){return popup.close()}),popup=util.popupTrigger2(objEl,{delay:300,closeDelay:0,createPopup:function(cb,close,addEl){var connectorEl,frame,productPopupView,updateConnectorEl;return productPopupView=_this.createView("ProductPopupView",{unconstrainedPictureHeight:!0}),tracking.page(""+_this.path()+"/"+productPopupView.pathElement()),frame=Frame.frameAbove(objEl,productPopupView.el,{type:"balloon",distance:10,position:objEl.offset().top-$(window).scrollTop()<$(window).height()/3?"below":"above",onClose:function(){return productPopupView.destruct(),productPopupView=null}}),productPopupView.close=close,productPopupView.sizeChanged=function(){return frame.update(),updateConnectorEl()},productPopupView.addEl=addEl,productPopupView.shown(),setTimeout(function(){return frame.update()},500),productPopupView.represent({modelName:"Product",instanceId:comp.id}),typeof _this.addExtension=="function"&&_this.addExtension(frame.el),connectorEl=$("<div />"),connectorEl.appendTo(frame.el),updateConnectorEl=function(){var height;return height=objEl.offset().top-(frame.el.offset().top+frame.el.height()),connectorEl.css({position:"absolute",bottom:-height,left:0,width:"100%",height:height})},updateConnectorEl(),frame.el},onClose:function(el){var _ref2;return typeof _this.removeExtension=="function"&&_this.removeExtension(el.data("frame").el),(_ref2=el.data("frame"))!=null?typeof _ref2.close=="function"?_ref2.close(100):void 0:void 0}}),objEl.mousedown(function(){return popup.close()})}(comp,objEl)):comp.model==="Decision"&&(objEl.addClass("decision"),function(comp,objEl){var popup;return _this.el.find(".activity").one("scroll",function(){return popup.close()}),popup=util.popupTrigger2(objEl,{delay:300,closeDelay:0,createPopup:function(cb,close,addEl){var connectorEl,decisionPreviewView,frame,updateConnectorEl;return window.suppressPopups?!1:(decisionPreviewView=_this.createView("DecisionPreview"),decisionPreviewView.editInModalDialog=!0,decisionPreviewView.represent({modelName:"Decision",instanceId:comp.id}),decisionPreviewView.close=close,decisionPreviewView.editEnv=function(cb){return cb(objEl)},tracking.page(""+_this.path()+"/"+decisionPreviewView.pathElement()),frame=Frame.frameAbove(objEl,decisionPreviewView.el,{type:"balloon",distance:10,position:objEl.offset().top-$(window).scrollTop()<$(window).height()/3?"below":"above",onClose:function(){return decisionPreviewView.destruct(),decisionPreviewView=null}}),typeof _this.addExtension=="function"&&_this.addExtension(frame.el),decisionPreviewView.sizeChanged=function(){return frame.update(),updateConnectorEl()},connectorEl=$("<div />"),connectorEl.appendTo(frame.el),updateConnectorEl=function(){var height;return height=objEl.offset().top-(frame.el.offset().top+frame.el.height()),connectorEl.css({position:"absolute",bottom:-height,left:0,width:"100%",height:height})},updateConnectorEl(),frame.el)},onClose:function(el){var _ref2;return typeof _this.removeExtension=="function"&&_this.removeExtension(el.data("frame").el),(_ref2=el.data("frame"))!=null?typeof _ref2.close=="function"?_ref2.close(100):void 0:void 0}}),objEl.mousedown(function(){return popup.close()})}(comp,objEl)),objEl.html(comp.text)):objEl.html(comp.text),textEl.append(objEl)),textEl.append(document.createTextNode(" "));return el.find(".timestamp").html(data.timestamp),el}}(this)).setDataSource(data.activity)},CollaborateView.prototype.onData=function(data){return this.withData(data,function(_this){return function(data){return _this.configure(data)}}(this))},CollaborateView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/BundleTileItem",[],function(){return{d:["View","util","views/compare/ListTileItem"],c:function(){var BundleTileItem;return BundleTileItem=function(_super){__extends(BundleTileItem,_super);function BundleTileItem(){return BundleTileItem.__super__.constructor.apply(this,arguments)}return BundleTileItem.prototype.type="Bundle",BundleTileItem.prototype.html="",BundleTileItem.prototype.init=function(){return BundleTileItem.__super__.init.apply(this,arguments),this.el.children(".grip").mouseenter(function(){if($(this).parent().hasClass("hover")&&util.isMutable($(this).parent()))return $(this).addClass("hover")}).mouseleave(function(){if(util.isMutable($(this).parent())&&!$(this).parent().hasClass("dragging"))return $(this).removeClass("hover")})},BundleTileItem.prototype.updateTilesLayout=function(params,state){var gripEl,i,segment,_i,_len,_ref,_results;BundleTileItem.__super__.updateTilesLayout.apply(this,arguments),this.el.children(".grip").remove(),_ref=this.segments,_results=[];for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)segment=_ref[i],gripEl=$('<div class="grip" />'),this.segments.length>1&&(i===0?gripEl.addClass("left"):i===this.segments.length-1?gripEl.addClass("right"):gripEl.addClass("middle")),gripEl.css({position:"absolute",left:segment.left,width:segment.width,top:segment.top+params.rowHeight+7,height:10}),_results.push(gripEl.appendTo(this.el));return _results},BundleTileItem}(ListTileItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/CompareView",[],function(){return{d:["View","util","views/compare/TileItemView","views/ProductPreviewView","views/EditDescriptorView"],c:function(){var CompareView;return CompareView=function(_super){__extends(CompareView,_super),CompareView.prototype.type="compare/Compare";function CompareView(contentScript,contEl,backEl,_public){this.contEl=contEl,this.backEl=backEl,this["public"]=_public!=null?_public:!1,CompareView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="-agora v-compareTile"> <h2 class="title" /> <ul class="breadcrumbs" /> <div class="client" /> </div>'),contEl&&this.setContEl(contEl),this["public"]&&this.el.addClass("public"),this.clientEl=this.el.find(".client"),this.titleEl=this.el.find(".title"),this.layout="masonry",$(window).keyup(this.keyListener=function(_this){return function(e){var pathLength;if(e.keyCode===27)return pathLength=_this.el.find(".breadcrumbs li").length,pathLength===1?typeof _this.close=="function"?_this.close():void 0:_this.callBackgroundMethod("gotoPath",pathLength-2)}}(this))}return CompareView.prototype.items=function(){return this.el.find(".items > .tileItem")},CompareView.prototype.setContEl=function(contEl){return this.contEl=contEl,contEl.resize(function(_this){return function(){return _this.updateLayout()}}(this)),this.contEl.append(this.menuEl=$('<div class="agoraMenu"> <div class="group"> <div class="item agora"><a href="http://agora.sh" target="_blank" /></div> <!--<div class="item home"><a href="#" /></div>--> </div> <div class="group"> <div class="item selectionMode"> <a href="#" /> <div class="submenu"> <a href="#" class="wrap"><label>wrap</label></a> <a href="#" class="extract"><label>extract</label></a> <a href="#" class="split"><label>split</label></a> <a href="#" class="delete"><label>delete</label></a> <a href="#" class="bundle"><label>bundle</label></a> </div> </div> <div class="item settings"> <a href="#" /> <div class="submenu"> <div class="properties" /> </div> </div> <div class="item share"> <a href="#" /> </div> </div> </div>')),this["public"]&&this.menuEl.addClass("public"),this.menuEl.find(".selectionMode .submenu").hide(),this.menuEl.find(".selectionMode").click(function(_this){return function(){return _this.selectMode?(_this.event("select"),_this.disableSelection()):(_this.event("cancelSelect"),_this.enableSelection()),!1}}(this)),this.menuEl.find(".share a").click(function(_this){return function(){return util.presentViewAsModalDialog("SocialShare",{viewId:_this.id},{waitUntilRepresented:!0}),!1}}(this)),this.menuEl.find(".selectionMode .wrap").click(function(_this){return function(){return _this.wrapSelection("decision"),!1}}(this)),this.menuEl.find(".selectionMode .extract").click(function(_this){return function(){return _this.extractSelection(),!1}}(this)),this.menuEl.find(".selectionMode .split").click(function(_this){return function(){return _this.splitSelection(),!1}}(this)),this.menuEl.find(".selectionMode .delete").click(function(_this){return function(){return _this.deleteSelection(),!1}}(this)),this.menuEl.find(".selectionMode .bundle").click(function(_this){return function(){return _this.wrapSelection("bundle"),!1}}(this)),this.menuEl.find(".settings").click(function(_this){return function(){return!1}}(this)),util.popoutTrigger(this.menuEl.find(".settings"),{side:"right",anchor:"top",el:this.menuEl.find(".settings .submenu")})},CompareView.prototype.eachSelectable=function(cb){return this.el.find(".items").children(".tileItem").each(function(){return cb($(this).data("view"))})},CompareView.prototype.enableSelection=function(){if(!this.selectMode)return this.eachSelectable(function(view){return view.enableSelection()}),this.menuEl.find(".selectionMode").addClass("enabled"),this.selectionMenuFuncs=util.createPopout(this.menuEl.find(".selectionMode"),{side:"right",anchor:"middle",el:this.menuEl.find(".selectionMode .submenu"),flexibleHeight:!1}),this.selectMode=!0},CompareView.prototype.disableSelection=function(){if(this.selectMode)return this.menuEl.find(".selectionMode").removeClass("enabled"),this.eachSelectable(function(view){return view.disableSelection()}),this.selectMode=!1,this.selectionMenuFuncs.close()},CompareView.prototype.selected=function(){var selected;return selected=[],this.eachSelectable(function(view){if(view.selected)return selected.push(view.id)}),selected},CompareView.prototype.wrapSelection=function(type){return this.event("wrap"),this.callBackgroundMethod("wrap",[type,this.selected()]),this.disableSelection()},CompareView.prototype.deleteSelection=function(){return this.event("delete"),this.callBackgroundMethod("delete",[this.selected()]),this.disableSelection()},CompareView.prototype.extractSelection=function(){return this.event("extract"),this.callBackgroundMethod("extract",[this.selected()]),this.disableSelection()},CompareView.prototype.splitSelection=function(){return this.event("split"),this.callBackgroundMethod("split",[this.selected()]),this.disableSelection()},CompareView.prototype.updateLayout=function(){var contWidth,height,margin,padding,params,rowHeight,size,state;if(this.state==="Decision"){if(this.barItemLoadCount)return;margin=parseInt(this.clientEl.children(".items").children(".tileItem:first").css("marginBottom")),size=this.clientEl.children(".items").children(".tileItem:first").outerWidth(),this["public"]||!this.showingDismissalList?this.subDecision?padding=170:padding=100:padding=332,contWidth=Math.floor((this.contEl.width()-padding)/(size+margin))*(size+margin)-margin,this.clientEl.css({width:contWidth}),this.el.width(contWidth),this.el.height(""),this.clientEl.children(".items").css({width:contWidth}),this.clientEl.find(".dismissalList").css({top:this.clientEl.offset().top-this.clientEl.find(".items").offset().top,marginTop:-65});switch(this.layout){case"tiles":return rowHeight=size,params={margin:margin,contWidth:contWidth,rowHeight:rowHeight},state={x:0,y:0,cols:0,rows:1,maxWidth:0},this.items().each(function(){var itemEl;return itemEl=$(this),itemEl.data("view").barItem.updateTilesLayout(params,state)}),height=state.rows*rowHeight+(state.rows-1)*margin,this.clientEl.children(".items").css({height:state.rows*rowHeight+(state.rows-1)*margin}),this.clientEl.css({height:height});case"masonry":return this.items().each(function(){var itemEl;itemEl=$(this);if(itemEl.data("view").barItem)return itemEl.data("view").barItem.updateMasonryLayout()}),this.clientEl.children(".items").masonry("reloadItems").masonry({columnWidth:size,itemSelector:".rootItem",gutter:margin}),this.clientEl.css({height:this.clientEl.children(".items").height()-margin})}}else if(this.state==="Product")return contWidth=$(window).width()-220,this.clientEl.css({width:contWidth}),this.el.width(contWidth),this.el.height($(window).height()-100),this.clientEl.outerHeight(this.el.height()-(this.clientEl.offset().top-this.el.offset().top)-40)},CompareView.prototype.childWidthChanged=function(view){return this.updateLayout()},CompareView.prototype.barItemLoadCount=0,CompareView.prototype.loadBarItem=function(barItem){return++this.barItemLoadCount},CompareView.prototype.barItemLoaded=function(barItem){--this.barItemLoadCount;if(!this.barItemLoadCount)return this.updateLayout(),this.el.animate({opacity:1},100)},CompareView.prototype.initBreadcrumbs=function(breadcrumbs){var breadcrumb,breadcrumbsEl,_i,_len,_results;breadcrumbsEl=this.el.children(".breadcrumbs"),breadcrumbsEl.html(""),_results=[];for(_i=0,_len=breadcrumbs.length;_i<_len;_i++)breadcrumb=breadcrumbs[_i],_results.push(function(_this){return function(breadcrumb){var breadcrumbEl;breadcrumbEl=$('<li><span class="images" /></li>').appendTo(breadcrumbsEl),breadcrumbEl.click(function(){return _this.callBackgroundMethod("gotoPath",breadcrumbEl.index())});if(View.isClientArray(breadcrumb))return breadcrumbEl.find(".images").append($('<span class="image" />')),util.initMosaic(_this,breadcrumbEl,".image",breadcrumb);if(View.isClientValue(breadcrumb))return breadcrumbEl.find(".images").css({backgroundImage:"url("+breadcrumb.get()+")"})}}(this)(breadcrumb));return _results},CompareView.prototype.configure=function(data){var arrowEl,contents,dismissalListIface,lastBreadcrumbEl,opened,productPreviewView,updateForLengthChanged,updateIcon,updateProperties;return this.clientView?this.clientView.clear():this.clientView=this.view(),this.clientEl.html(""),this.titleEl.html(""),this.state&&this.el.removeClass(this.state),this.state==="Decision"&&util.terminateDragging(this.contEl),this.state=data.state,this.el.addClass(this.state),this.backEl.removeClass("v-compareTile-background"),this.clientEl.removeClass("frame"),this.el.children(".breadcrumbs").hide(),this.initBreadcrumbs(data.breadcrumbs),data.breadcrumbs.length>1&&(this.backEl.addClass("v-compareTile-background"),this.clientEl.addClass("frame"),this.el.children(".breadcrumbs").show(),lastBreadcrumbEl=this.el.children(".breadcrumbs").children("li:last"),arrowEl=$('<span class="-arrow" />').appendTo(this.clientEl),arrowEl.css({position:"absolute",top:-42,left:lastBreadcrumbEl.offset().left-this.el.offset().left+lastBreadcrumbEl.width()/2-arrowEl.width()/2}),_tutorial("Workspace/ReturnToParent",this.el.children(".breadcrumbs").children("li:first"))),data.state==="Decision"?(data.breadcrumbs.length>1?this.subDecision=!0:this.subDecision=!1,this.clientEl.append('<div class="properties" /> <div class="items"> <div class="tileItem" /> </div> <div class="dismissalList"> <a href="#" class="clear" /> <ul> <li> <a href="#" class="restore" /> <a href="#" class="remove" /> </li> </ul> </div>'),this.clientEl.find(".items").data("view",this),this["public"]||(util.initDragging(this.clientEl.find(".items"),{enabled:!1,root:!0,rootZIndex:0,acceptsDrop:!0,onDroppedOn:function(_this){return function(el,fromEl){return _this.onDroppedOn(el,fromEl,_this.el.find(".items")),el.remove(),!1}}(this)}),util.initDragging(this.contEl,{enabled:!1,root:!0,rootZIndex:-1,acceptsDrop:!0,onDroppedOn:function(_this){return function(el,fromEl){return _this.onDroppedOn(el,fromEl,_this.el.find(".items")),el.remove(),!1}}(this)})),this.clientEl.children(".items").addClass(this.layout),contents=this.clientView.listInterface(this.el,".items > .tileItem",function(_this){return function(el,data,pos,onRemove){var tileItemView;return tileItemView=_this.clientView.createView("TileItemView",_this,{selectMode:_this.selectMode}),tileItemView.represent(data),tileItemView,onRemove(function(){return tileItemView.destruct()}),tileItemView.el.addClass("rootItem"),tileItemView.el}}(this)),contents.onDelete=function(_this){return function(el,del){return del(),_this.updateLayout()}}(this),contents.onInsert=function(_this){return function(el){return _this.updateLayout()}}(this),contents.onMove=function(_this){return function(){return _this.updateLayout()}}(this),this.el.find(".dismissalList").hide(),this.el.find(".dismissalList .clear").click(function(_this){return function(){return _this.callBackgroundMethod("clearDismissalList"),!1}}(this)),util.tooltip(this.el.find(".dismissalList .clear"),"clear",{position:"below"}),this.el.css({opacity:0}),this.barItemLoadCount=0,data.contents&&(contents.setDataSource(data.contents),this.barItemLoadCount===0&&(this.updateLayout(),this.el.css({opacity:""}))),data.dismissalList&&(dismissalListIface=this.clientView.listInterface(this.el.find(".dismissalList ul"),"li",function(_this){return function(el,data,pos,onRemove){var view;return view=_this.clientView.createView(),onRemove(function(){return view.destruct()}),typeof data=="string"?el.css("background-image","url("+data+")"):(el.append($('<span class="image" />')),util.initMosaic(view,el,".image",data)),el.find(".restore").click(function(){return _this.event("restore"),_this.callBackgroundMethod("restore",[el.index()]),!1}),el.find(".remove").click(function(){return _this.event("removeDismissed"),_this.callBackgroundMethod("removeDismissed",[el.index()]),!1}),util.tooltip(el.find(".remove"),"remove"),el}}(this)),dismissalListIface.setDataSource(data.dismissalList),updateForLengthChanged=function(_this){return function(){return dismissalListIface.length()?(_this.showingDismissalList=!0,_this.el.find(".dismissalList").show()):(_this.showingDismissalList=!1,_this.el.find(".dismissalList").hide()),_this.updateLayout()}}(this),dismissalListIface.onLengthChanged=updateForLengthChanged,updateForLengthChanged()),this.titleEl.html('<span class="icon" /><span class="descriptor" /><a href="#" class="edit" />'),opened=!1,this.titleEl.find(".edit").click(function(_this){return function(){var editDescriptorView,frame;return opened||(opened=!0,editDescriptorView=new EditDescriptorView(_this.contentScript),editDescriptorView.close=function(){return frame.close()},editDescriptorView.represent(data.args.decisionId),frame=Frame.frameAround(_this.titleEl.find(".edit"),editDescriptorView.el,{type:"balloon",distance:15,close:function(){return frame.close(),opened=!1}}),tracking.page(""+_this.path()+"/"+editDescriptorView.pathElement()),_this.event("editDescriptor")),!1}}(this)),util.tooltip(this.titleEl.find(".edit"),"edit",{position:"below"}),data.descriptor&&this.clientView.valueInterface(this.titleEl.find(".descriptor")).setDataSource(data.descriptor),updateIcon=function(_this){return function(){var _ref;return icons.setIcon(_this.titleEl.find(".icon"),(_ref=data.icon.get())!=null?_ref:"list",{size:"small",color:"white"}),_this.titleEl.find(".icon").removeClass("t-item")}}(this),data.icon.observe(updateIcon),updateIcon(),updateProperties=function(_this){return function(){var prop,propertiesEl,_i,_len,_ref,_results;propertiesEl=_this.menuEl.find(".settings .properties"),propertiesEl.html("");if(data.properties.get()){_ref=data.properties.get(),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)prop=_ref[_i],_results.push(function(prop){var propEl;return"count"in prop?(propertiesEl.append(propEl=$("<div class='property'><input type='checkbox' class='selected'> <label>"+prop.label+"&nbsp;("+prop.count+")</label></div>")),prop.count===0&&propEl.addClass("none")):propertiesEl.append(propEl=$("<div class='property'><input type='checkbox' class='selected'> <label>"+prop.label+"</label></div>")),propEl.find(".selected").change(function(){return _this.event("toggleProperty"),_this.callBackgroundMethod("setProperty",[prop.path,propEl.find(".selected").prop("checked")])}).prop("checked",prop.selected.get()),propEl.click(function(){return propEl.find(".selected").prop("checked",!propEl.find(".selected").prop("checked")),propEl.find(".selected").triggerHandler("change")})}(prop));return _results}}}(this),updateProperties(),data.properties.observe(updateProperties)):data.state==="Product"&&(productPreviewView=this.clientView.createView("ProductPreviewView",{"public":this["public"]}),productPreviewView.represent(data.productId,function(_this){return function(){return productPreviewView.el.children(".head").appendTo(_this.titleEl)}}(this)),productPreviewView.el.appendTo(this.clientEl),tracking.page(""+this.path()+"/"+productPreviewView.pathElement())),this.updateLayout()},CompareView.prototype.onDroppedOn=function(el,fromEl,toEl,dropAction){return util.resolveDraggingData(el,function(_this){return function(data){return fromEl?(_this.event("move"),_this.callBackgroundMethod("move",[data,{view:toEl.data("view").id},dropAction])):(_this.event("drop"),_this.callBackgroundMethod("drop",[data,{view:toEl.data("view").id},dropAction]))}}(this))},CompareView.prototype.destruct=function(){return CompareView.__super__.destruct.apply(this,arguments),$(window).unbind("keyup",this.keyListener)},CompareView.prototype.onData=function(data){return this.configure(data.get()),data.observe(function(_this){return function(){return _this.configure(data.get())}}(this)),_tutorial("Workspace")},CompareView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/DecisionTileItem",[],function(){return{d:["views/compare/TileItem","util"],c:function(){var DecisionTileItem;return DecisionTileItem=function(_super){__extends(DecisionTileItem,_super);function DecisionTileItem(){return DecisionTileItem.__super__.constructor.apply(this,arguments)}return DecisionTileItem.prototype.draggingData=function(){return{immutableContents:!0}},DecisionTileItem.prototype.onData=function(data,itemData){var popup,updateIcon,updateTooltip;return this.el.append('<span class="count"><!--<span class="selection" />/--><span class="list" /></span>'),this.el.append("<span class='preview'><span class='image' /><span class='icon' /></span>"),this.el.append('<span class="shareIndicator" />'),this.view.withData(data.shared,function(_this){return function(shared){return shared?_this.el.addClass("shared"):_this.el.removeClass("shared")}}(this)),updateIcon=function(_this){return function(){var _ref;return icons.setIcon(_this.el,(_ref=data.icon.get())!=null?_ref:"list",{size:"large"})}}(this),this.listItem=new ListTileItem(this.view,!0),this.listItem.onEmpty=updateIcon,this.listItem.onNotEmpty=function(_this){return function(){return icons.clearIcon(_this.el)}}(this),updateIcon(),data.icon.observe(function(_this){return function(){if(_this.listItem.empty)return updateIcon()}}(this)),this.listItem.setup({state:"expanded",contents:data.selection}),function(_this){return function(){var classesForLength,contents,prevLength,updateForLength;return contents=_this.view.listInterface(_this.el.find(".preview"),".image",function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}),contents.setDataSource(data.preview),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(){return _this.el.find(".preview").removeClass(classesForLength[prevLength]),_this.el.find(".preview").addClass(classesForLength[prevLength=contents.length()])},contents.onLengthChanged=updateForLength,updateForLength()}}(this)(),function(_this){return function(){return updateIcon=function(){var _ref;return icons.setIcon(_this.el.find(".preview .icon"),(_ref=data.icon.get())!=null?_ref:"list",{itemClass:!1})},data.icon.observe(function(){return updateIcon()}),updateIcon()}}(this)(),function(_this){return function(){var updateForListSize;return updateForListSize=function(){return data.listSize.get()===0?_this.el.addClass("emptyList"):_this.el.removeClass("emptyList"),_this.el.find(".count .list").html(data.listSize.get())},data.listSize.observe(updateForListSize),updateForListSize()}}(this)(),this.el.find(".count").click(function(_this){return function(e){return tracking.event("Compare","openDecision"),_this.callBackgroundMethod("click"),e.stopPropagation()}}(this)),this.view.compareView["public"]||(updateTooltip=function(_this){return function(){var text,_ref,_ref1;return text=((_ref=data.descriptor.get())!=null?_ref.descriptor:void 0)?(_ref1=data.descriptor.get())!=null?_ref1.descriptor:void 0:"<i>Edit Decision</i>",util.tooltip(_this.el.find(".count"),"<span class='descriptorTooltip'> <span class='preview'><span class='image' /></span> <div class='descriptorWrapper'><span class='icon' /> <span class='descriptor'>"+text+"</span><a class='edit' href='#' /></div> </span>",{parentView:_this.view,canFocus:!0,type:"html",frameType:"balloon",init:function(el,close,view){var classesForLength,contents,edit,prevLength,updateForLength,_ref2;return icons.setIcon(el.find(".icon"),(_ref2=data.icon.get())!=null?_ref2:"list",{size:"small"}),el.find(".icon").removeClass("t-item"),edit=function(){var editDescriptorView,frame;return editDescriptorView=new EditDescriptorView(_this.view.contentScript),tracking.page(""+_this.view.path()+"/"+editDescriptorView.pathElement()),tracking.event("Compare","editDescriptor","item"),editDescriptorView.close=function(){return frame.close()},editDescriptorView.represent(_this.view.data.get().id),frame=Frame.frameAround(_this.el.find(".count"),editDescriptorView.el,{type:"balloon",distance:15,close:function(){return frame.close()}}),!1},el.find(".edit").click(edit),el.find(".preview").click(function(){return _this.callBackgroundMethod("click")}),el.find(".descriptor").click(edit),contents=view.listInterface(el.find(".preview"),".image",function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}),contents.setDataSource(data.preview),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(){return el.find(".preview").removeClass(classesForLength[prevLength]),el.find(".preview").addClass(classesForLength[prevLength=contents.length()])},contents.onLengthChanged=updateForLength,updateForLength()}})}}(this),data.descriptor.observe(updateTooltip),updateTooltip()),this.el.click(function(_this){return function(){if(_this.el.hasClass("empty"))return _this.callBackgroundMethod("click")}}(this)),this.el.find(".count .selection").html(data.selectionSize.get()),data.selectionSize.observe(function(_this){return function(){return _this.el.find(".count .selection").html(data.selectionSize.get())}}(this)),itemData.user&&this.el.find(".shareIndicator").css("backgroundColor",itemData.user.color),popup=util.popupTrigger2(this.el.find(".shareIndicator"),{delay:300,createPopup:function(_this){return function(cb,close,addEl){var collaborateView,frame;return window.suppressPopups?!1:(collaborateView=_this.view.createView("Collaborate"),collaborateView.addExtension=function(el){return addEl(el)},collaborateView.removeExtension=function(el){},frame=Frame.frameAbove(_this.el.find(".shareIndicator"),collaborateView.el,{type:"balloon",distance:20,onClose:function(){return collaborateView.destruct(),collaborateView=null}}),collaborateView.close=close,collaborateView.sizeChanged=function(){return frame.update()},collaborateView.addEl=addEl,collaborateView.shown(),collaborateView.represent(_this.view.args),cb(frame.el,null))}}(this),onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null?typeof _ref.close=="function"?_ref.close():void 0:void 0}})},DecisionTileItem.prototype.updateTilesLayout=function(params,state){var countEl,lastSegment;return this.listItem.updateTilesLayout(params,state),lastSegment=this.listItem.segments[this.listItem.segments.length-1],countEl=this.el.children(".count"),countEl.css({left:lastSegment.left+lastSegment.width-countEl.outerWidth(),top:lastSegment.top+lastSegment.height-countEl.outerHeight()})},DecisionTileItem.prototype.updateMasonryLayout=function(){return this.listItem.updateMasonryLayout()},DecisionTileItem.prototype.destruct=function(){return DecisionTileItem.__super__.destruct.apply(this,arguments),this.listItem.destruct()},DecisionTileItem}(TileItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/ListTileItem",[],function(){return{d:["views/compare/TileItem","util"],c:function(){var ListTileItem;return ListTileItem=function(_super){__extends(ListTileItem,_super),ListTileItem.prototype.html="",ListTileItem.prototype.itemSpacing=10,ListTileItem.prototype.supportsCreateBundle=function(){return!1},ListTileItem.prototype.draggingData=function(){return{type:this.type,immutableContents:this.args.readOnly,onRippedOut:function(_this){return function(el){}}(this),onReorder:function(_this){return function(el,startIndex,endIndex){return _this.callBackgroundMethod("reorder",[startIndex,endIndex])}}(this),onDragOver:function(_this){return function(){if(_this.state==="expanded"&&!_this.args.readOnly&&!_this.expanded)return _this.startedDrag=!0,_this.expand()}}(this),onDragOut:function(_this){return function(){if(_this.expanded)return _this.view.shoppingBarView.queueShrink(_this)}}(this)}};function ListTileItem(){ListTileItem.__super__.constructor.apply(this,arguments),this.args.readOnly||(this.startEdit=function(_this){return function(){return _this.expand()}}(this),this.stopEdit=function(_this){return function(){return _this.shrink()}}(this)),this.el.addClass("list")}return ListTileItem.prototype.childrenCount=function(){return this.el.children(".element").length},ListTileItem.prototype.items=function(){return this.el.children(".tileItem")},ListTileItem.prototype.updateTilesLayout=function(params,state){var actionsEl,backingEl,el,endRow,endX,i,lastSegment,newParams,offsetX,offsetY,segment,startRow,startX,_i,_j,_k,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;offsetX=(_ref=(_ref1=params.offset)!=null?_ref1.x:void 0)!=null?_ref:0,offsetY=(_ref2=(_ref3=params.offset)!=null?_ref3.y:void 0)!=null?_ref2:0,this.el.css({left:state.x-offsetX,top:state.y-offsetY}),newParams=_.clone(params),newParams.offset={x:state.x,y:state.y},startX=state.x,startRow=state.rows-1,_ref4=this.items();for(_i=0,_len=_ref4.length;_i<_len;_i++)el=_ref4[_i],el=$(el),el.data("view").barItem.updateTilesLayout(newParams,state);endRow=endX=null,state.x===0?(endRow=state.rows-2,endX=params.contWidth+params.margin):(endRow=state.rows-1,endX=state.x),this.segments=[];if(startRow!==endRow){this.segments.push({left:0,top:0,width:params.contWidth-startX,height:params.rowHeight});if(startRow!==endRow-1)for(i=_j=_ref5=startRow+1,_ref6=endRow-1;_ref5<=_ref6?_j<=_ref6:_j>=_ref6;i=_ref5<=_ref6?++_j:--_j)this.segments.push({left:-startX,top:(i-startRow)*(params.rowHeight+params.margin),width:params.contWidth,height:params.rowHeight});this.segments.push({left:-startX,top:(endRow-startRow)*(params.rowHeight+params.margin),width:endX-params.margin,height:params.rowHeight})}else this.segments.push({left:0,top:0,width:endX-startX-params.margin,height:params.rowHeight});this.el.children(".backing").remove(),_ref7=_.clone(this.segments).reverse();for(i=_k=0,_len1=_ref7.length;_k<_len1;i=++_k)segment=_ref7[i],backingEl=$('<div class="backing" />').prependTo(this.el).css({position:"absolute"}).css(segment),this.segments.length>1&&(i===0?backingEl.addClass("right"):i===this.segments.length-1?backingEl.addClass("left"):backingEl.addClass("middle"));return lastSegment=this.segments[this.segments.length-1],actionsEl=this.el.children(".actions"),actionsEl.css({left:lastSegment.left+lastSegment.width-actionsEl.outerWidth()-2,top:lastSegment.top+2})},ListTileItem.prototype.updateMasonryLayout=function(){var el,y,_i,_len,_ref;y=0;if(this.items().length){this.empty=!1,typeof this.onNotEmpty=="function"&&this.onNotEmpty(),_ref=this.items();for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],el=$(el),el.css({top:y,left:0}),el.data("view").barItem.updateMasonryLayout(),y+=el.outerHeight()+40;return this.el.height(y-40-12)}return this.empty=!0,typeof this.onEmpty=="function"&&this.onEmpty(),this.el.height(185)},ListTileItem.prototype.shrink=function(){if(this.expanded)return this.expanded=!1,this.updateLayout(),this.widthChanged(),this.addDrop.remove(),this.el.removeClass("hasAddDrop")},ListTileItem.prototype.expand=function(){var el;if(!this.expanded)return this.expanded=!0,this.updateLayout(),this.widthChanged(),this.el.addClass("hasAddDrop"),el=$('<a href="#" class="addDrop"></a>').click(function(_this){return function(e){var dialogEl;return dialogEl=Frame.wrapInFrame('<a href="#" class="computer">Add Computer</a>'),dialogEl.find(".computer").click(function(){return _this.callBackgroundMethod("add",["computer"]),Frame.close(dialogEl),!1}),dialogEl.appendTo(document.body),Frame.fixFrameAboveAndCentered(el,dialogEl),e.stopPropagation(),!1}}(this)),util.initDragging(el,{enabled:!1,acceptsDrop:!1,onDragOver:function(_this){return function(){}}(this)}),this.addDrop=el,this.el.append(el)},ListTileItem.prototype.setup=function(data){var classesForLength,contents,prevLength,updateForLength,_base;return this.contentsView=this.view.view.createView(),this.state=data.state,this.el.addClass(this.state),this.state==="expanded"?(this.el.append($('<div class="element" />')),contents=this.contentsView.listInterface(this.el,".element",function(_this){return function(el,data,pos,onRemove){var tileItemView;return tileItemView=_this.view.createView("TileItemView",_this.view.compareView),tileItemView.represent(data),tileItemView,_this.contentsView.trackView(tileItemView),onRemove(function(){return tileItemView.destruct()}),tileItemView.el}}(this)),contents.setDataSource(data.contents),updateForLength=function(_this){return function(){return contents.length()?_this.el.removeClass("empty"):_this.el.addClass("empty")}}(this),contents.onLengthChanged=updateForLength,updateForLength(),contents.onInsert=function(_this){return function(){return _this.widthChanged(),_this.view.updateLayout()}}(this),contents.onDelete=function(_this){return function(el,del){return del(),_this.widthChanged(),_this.view.updateLayout()}}(this),contents.onMove=function(_this){return function(){return _this.view.updateLayout()}}(this)):this.state==="collapsed"&&(this.el.bind("click.list",function(_this){return function(){return _this.view.callBackgroundMethod("click")}}(this)),this.el.append($('<span class="image" />')),contents=this.view.view.listInterface(this.view.el,".image",function(_this){return function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}}(this)),contents.setDataSource(data.contents),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(_this){return function(){return _this.el.removeClass(classesForLength[prevLength]),_this.el.addClass(classesForLength[prevLength=contents.length()])}}(this),contents.onLengthChanged=updateForLength,updateForLength()),this.view.updateLayout(),typeof (_base=this.view.parent).childWidthChanged=="function"?_base.childWidthChanged(this):void 0},ListTileItem.prototype.onData=function(data){return this.setup(data.state.get()),this.observeObject(data.state,function(_this){return function(){return _this.clearState(),_this.setup(data.state.get())}}(this))},ListTileItem.prototype.clearState=function(){this.el.removeClass(this.state),this.contentsView.destruct();switch(this.state){case"collapsed":return this.el.find(".image").remove();case"expanded":return this.el.unbind(".list"),this.el.children(".element").remove()}},ListTileItem.prototype.destruct=function(){return ListTileItem.__super__.destruct.apply(this,arguments),this.clearState()},ListTileItem}(TileItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/ProductTileItem",[],function(){return{d:["views/compare/TileItem","views/ProductPopupView","util","Frame"],c:function(){var ProductTileItem;return ProductTileItem=function(_super){__extends(ProductTileItem,_super);function ProductTileItem(){return ProductTileItem.__super__.constructor.apply(this,arguments)}return ProductTileItem.prototype.html=function(layout){var html;return html=function(){switch(layout){case"tiles":return'<span class="image" /><a />';case"masonry":return'<div><img class="image" /><a /><ul class="properties"><li /></ul><div class="productMenu" /></div>'}}()},ProductTileItem.prototype.width=function(){return ProductTileItem.__super__.width.apply(this,arguments)+48},ProductTileItem.prototype.init=function(){var triggerEl;ProductTileItem.__super__.init.apply(this,arguments),triggerEl=this.el.find(".image"),triggerEl.click(function(_this){return function(){return _this.callBackgroundMethod("click")}}(this)),triggerEl.css("cursor","pointer"),this.el.bind("mouseenter.tutorial",function(_this){return function(){return _tutorial(["AccessProductPortalFromWorkspace","Workspace/Dismiss","Select"],[_this.el.find(".image"),{positionEl:_this.el.find(".actions .dismiss"),attachEl:_this.el},{positionEl:_this.el.find(".actions .chosen"),attachEl:_this.el}],function(close){return _this.el.find(".image").one("mousedown",close),_this.el.one("mouseleave",close)})}}(this));if(this.view.compareView["public"]&&!this.view.contentScript.webApp)return util.draggableImage({view:this.view,el:this.el.find(".image"),productData:function(_this){return function(){return _this.view.args}}(this)})},ProductTileItem.prototype.updateMasonryLayout=function(){return this.el.height(Math.max(70,this.el.children("div").height()))},ProductTileItem.prototype.onData=function(data){var iface,lastEmotion,updateForImage,updateForLastFeeling;return this.data=data,updateForImage=function(){switch(this.view.compareView.layout){case"tiles":return function(_this){return function(){if(data.image.get())return _this.el.find(".image").css({backgroundImage:"url("+data.image.get()+")"})}}(this);case"masonry":return function(_this){return function(){var updateMenuPos;return updateMenuPos=function(){return _this.el.find(".productMenu").css({bottom:6})},_this.el.find(".image").attr("src",data.image.get()).load(function(){return _this.widthChanged(),updateMenuPos()}),_this.el.find(".image").prop("complete")&&(_this.widthChanged(),updateMenuPos()),updateMenuPos()}}(this)}}.call(this),updateForImage(),data.image.observe(updateForImage),this.view.compareView.layout==="masonry"&&(iface=this.view.listInterface(this.el.find(".properties"),"li",function(_this){return function(el,data,pos,onRemove){var argumentsIface,feelingsIface,view;view=_this.view.createView(),onRemove(function(){return view.destruct()});switch(data.property){case"price":_this.view.createView("ProductPrice",el).represent(data.value);break;case"rating":data.value&&(el.addClass("rating").html("<div class='ratingInfo'><span class='rating'>"+util2.ratingHtml+"</span><span class='reviews'>Loading...</span>"),util2.setRating(el.find(".rating"),data.value.rating.get()),data.value.rating.observe(function(){return util2.setRating(el.find(".rating"),data.value.rating.get())}),view.valueInterface(el.find(".reviews")).setDataSource(data.value.ratingCount));break;case"title":view.valueInterface(el).setDataSource(data.value);break;case"feelings":el.html('<ul class="feelings"> <li> <span class="emotion" /> <span class="thought" /> <a href="#" class="delete" /> </li> </ul>'),feelingsIface=view.listInterface(el,".feelings li",function(el,data,pos,onRemove){var feelingsView,previousEmotion,updateForEmotion;return feelingsView=view.view(),onRemove(function(){return feelingsView.destruct()}),feelingsView.valueInterface(el.find(".thought")).setDataSource(data.thought),previousEmotion=null,updateForEmotion=function(){var emotion;return emotion=util.emotionClass(data.positive.get(),data.negative.get()),previousEmotion&&el.find(".emotion").removeClass(previousEmotion),el.find(".emotion").addClass(emotion),previousEmotion=emotion},data.positive.observe(updateForEmotion),data.negative.observe=updateForEmotion,updateForEmotion(),el.find(".delete").click(function(){return _this.callBackgroundMethod("deleteFeeling",data.id),!1}),el}),feelingsIface.onMutation=function(){return typeof _this.widthChanged=="function"?_this.widthChanged():void 0},feelingsIface.setDataSource(data.value);break;case"arguments":el.html('<ul class="arguments"> <li> <span class="position" /> <span class="thought" /> <a href="#" class="delete" /> </li> </ul>'),argumentsIface=view.listInterface(el,".arguments li",function(el,data,pos,onRemove){var argumentsView,previousPosition,updateForPosition;return argumentsView=view.view(),onRemove(function(){return argumentsView.destruct()}),argumentsView.valueInterface(el.find(".thought")).setDataSource(data.thought),previousPosition=null,updateForPosition=function(){var position;return position=util.positionClass(data["for"].get(),data.against.get()),previousPosition&&el.find(".position").removeClass(previousPosition),el.find(".position").addClass(position),previousPosition=position},data["for"].observe(updateForPosition),data.against.observe=updateForPosition,updateForPosition(),el.find(".delete").click(function(){return _this.callBackgroundMethod("deleteArgument",data.id),!1}),el}),argumentsIface.onMutation=function(){return _this.widthChanged()},argumentsIface.setDataSource(data.value);break;default:view.valueInterface(el).setDataSource(data.value)}return el}}(this)),iface.onMutation=function(_this){return function(){return typeof _this.widthChanged=="function"?_this.widthChanged():void 0}}(this),iface.setDataSource(data.properties),this.view.createView("ProductMenu",this.el.find(".productMenu"),{orientation:"horizontal",pinSidebar:function(_this){return function(){return _this.el.addClass("pinSidebar")}}(this),unpinSidebar:function(_this){return function(){return _this.el.removeClass("pinSidebar")}}(this)}).represent(this.view.args)),this.el.append('<span class="feelingBadge"><span class="icon" /><span class="text">buffalo</span></span>'),lastEmotion=null,updateForLastFeeling=function(_this){return function(){var emotionClass;return lastEmotion&&_this.el.find(".feelingBadge").removeClass(lastEmotion),data.lastFeeling.get()?(_this.el.find(".feelingBadge").show(),_this.el.find(".feelingBadge .text").html(data.lastFeeling.get().thought),emotionClass=util.emotionClass(data.lastFeeling.get().positive,data.lastFeeling.get().negative),_this.el.find(".feelingBadge").addClass(emotionClass),lastEmotion=emotionClass):_this.el.find(".feelingBadge").hide()}}(this),data.lastFeeling.observe(updateForLastFeeling),updateForLastFeeling(),this.widthChanged()},ProductTileItem.prototype.destruct=function(){ProductTileItem.__super__.destruct.apply(this,arguments),this.el.css("backgroundImage",""),this.el.css("cursor","");if(this.popupFrame)return this.popupFrame.el.remove()},ProductTileItem}(TileItem)}}}),define("client/views/compare/TileItem",[],function(){return{d:["util"],c:function(){var TileItem;return TileItem=function(){function TileItem(view,args){this.view=view,this.args=args!=null?args:{},this.el=view.el,this.elementType=view.elementType}return TileItem.prototype.supportsCreateBundle=function(){return!0},TileItem.prototype.callBackgroundMethod=function(name,args){return this.view.callBackgroundMethod(name,args)},TileItem.prototype.observeObject=function(obj,observer){return this.view.view.observeObject(obj,observer)},TileItem.prototype.widthChanged=function(){return this.view.updateLayout()},TileItem.prototype.updateTilesLayout=function(params,state){var width;width=this.el.width(),state.rows===1&&++state.cols,params.offset?this.el.css({left:state.x-params.offset.x,top:state.y-params.offset.y}):this.el.css({left:state.x,top:state.y}),state.x+=width,state.x>state.maxWidth&&(state.maxWidth=state.x),state.x+=params.margin;if(state.x+width>params.contWidth)return state.x=0,++state.rows,state.y+=params.rowHeight+params.margin},TileItem.prototype.updateMasonryLayout=function(){},TileItem.prototype.init=function(data){var draggingData,orgDraggingData,_ref,_ref1;_.isFunction(this.html)?this.el.html(this.html(this.view.compareView.layout)):this.el.html(this.html),this.el.addClass(this.elementType.toLowerCase()),this.el.addClass(this.view.compareView.layout),this.onData(data.barItemData,data);if(!this.view.compareView["public"])return draggingData=null,"draggingData"in this.args?this.args.draggingData&&(draggingData=(_ref=typeof this.draggingData==="function"?this.draggingData():void 0)!=null?_ref:{},_.extend(draggingData,this.args.draggingData),util.initDragging(this.el,draggingData)):draggingData=(_ref1=typeof this.draggingData==="function"?this.draggingData():void 0)!=null?_ref1:{},orgDraggingData=_.clone(draggingData),_.extend(draggingData,{type:this.elementType,helper:function(_this){return function(event,el,offset){var barItemView;return barItemView=new BarItemView(_this.view.contentScript,{queueShrink:function(){},addEditListener:function(){},itemSpacing:10,animateSpeed:10,stopShrink:function(){},removeEditListener:function(){},mouseEnteredBarItemView:function(){},mouseLeftBarItemView:function(){},loadBarItem:function(){},barItemLoaded:function(){return offset.x=barItemView.el.width()-10,offset.y=barItemView.el.height()-10},stopDrag:function(){},startDrag:function(){}}),barItemView.parent={childWidthChanged:function(){}},barItemView.represent(_this.view.args),barItemView.el.addClass("dragging")}}(this),start:function(_this){return function(event,ui){_this.el.remove();if(orgDraggingData.start)return orgDraggingData.start.apply(_this,arguments)}}(this),stop:function(_this){return function(){_this.el.removeClass("dragging");if(orgDraggingData.stop)return orgDraggingData.stop.apply(_this,arguments)}}(this),onDroppedOn:function(_this){return function(el,fromEl,dropAction){return _this.view.compareView.onDroppedOn(el,fromEl,_this.el,dropAction),el.remove(),orgDraggingData.onDroppedOn?orgDraggingData.onDroppedOn.apply(_this,arguments):!1}}(this),onGlobal:function(_this){return function(){return _this.view.noDestruct=!0,_this.view.separate()}}(this),onDropped:function(_this){return function(receivingEl){delete _this.view.noDestruct;if(!receivingEl)return _this.callBackgroundMethod("delete"),_this.view.destruct()}}(this),onDraggedOver:function(_this){return function(el,draggingEl){el?(draggingEl.addClass("adding"),draggingEl.removeClass("removing")):(draggingEl.removeClass("adding"),draggingEl.addClass("removing"));if(orgDraggingData.onDraggedOver)return orgDraggingData.onDraggedOver.apply(_this,arguments)}}(this)}),util.initDragging(this.el,draggingData)},TileItem.prototype.destruct=function(){return this.el.unbind(),this.el.removeClass(this.elementType.toLowerCase()),this.el.html("")},TileItem}()}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/TileItemView",[],function(){return{d:["View","util","views/compare/ProductTileItem","views/compare/BundleTileItem","views/compare/DecisionTileItem","views/compare/UnauthorizedTileItem"],c:function(){var TileItemView;return TileItemView=function(_super){__extends(TileItemView,_super),TileItemView.prototype.type="compare/TileItem";function TileItemView(contentScript,compareView,opts){this.compareView=compareView,this.opts=opts!=null?opts:{},TileItemView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="tileItem"></div>'),this.selectMode=this.opts.selectMode}return TileItemView.prototype.updateLayout=function(){return this.compareView.updateLayout()},TileItemView.prototype.childWidthChanged=function(view){var _base;return this.updateLayout(),typeof (_base=this.parent).childWidthChanged=="function"?_base.childWidthChanged(this):void 0},TileItemView.prototype.enableSelection=function(force){force==null&&(force=!1);if(!this.selectMode||!!force)return this.selectMode=!0,this.el.addClass("selectMode"),this.el.append($('<input type="checkbox" class="select">').click(function(_this){return function(e){return e.stopPropagation(),_this.selected=!_this.selected,!0}}(this)))},TileItemView.prototype.disableSelection=function(){if(this.selectMode)return delete this.selectMode,delete this.selected,this.el.find(".select").remove(),this.el.removeClass("selectMode")},TileItemView.prototype.update=function(data){var el,_base,_base1;this.barItem&&(this.clearViews(),this.barItem.destruct(),typeof (_base=this.parent).destructChild=="function"&&_base.destructChild(this)),this.view=this.createView();if(data){data.type?this.elementType=data.type:this.elementType="Placeholder";if(!__classes[""+this.elementType+"TileItem"])throw new Error("No class "+this.elementType+"TileItem");this.barItem=new __classes[""+this.elementType+"TileItem"](this,this.opts.barItemArgs),this.barItem.init(data,this.opts.barItemArgs),data.creator&&(el=$('<span class="userIndicator" />').css("background-color",data.creator.color),util.tooltip(el,function(){return data.creator.name.get()}),this.el.append(el)),data.selected&&(this.el.append('<div class="actions"><a href="#" class="dismiss" /><input type="checkbox" class="chosen"></div>'),this.el.find(".chosen").prop("checked",data.selected.get()).click(function(_this){return function(e){return e.stopPropagation(),tracking.event("Compare","toggleChosen"),_this.callBackgroundMethod("setSelected",[_this.el.find(".chosen").prop("checked")])}}(this)),this.observeObject(data.selected,function(_this){return function(){return _this.el.find(".chosen").prop("checked",data.selected.get())}}(this)),util.tooltip(this.el.find(".chosen"),"choose"),this.el.find(".dismiss").click(function(_this){return function(){return tracking.event("Compare","dismiss"),_this.callBackgroundMethod("dismiss"),!1}}(this)),util.tooltip(this.el.find(".dismiss"),"dismiss"),typeof (_base1=this.barItem).initActions=="function"&&_base1.initActions())}if(this.selectMode)return this.enableSelection(!0)},TileItemView.prototype.represent=function(){TileItemView.__super__.represent.apply(this,arguments);if(!this.loadNotify)return this.compareView.loadBarItem(this),this.loadNotify=!0},TileItemView.prototype.destruct=function(){var _base,_ref;if(!this.noDestruct)return(_ref=this.barItem)!=null&&_ref.destruct(),typeof (_base=this.parent).destructChild=="function"&&_base.destructChild(this),TileItemView.__super__.destruct.apply(this,arguments)},TileItemView.prototype.onData=function(data){return this.data=data,this.update(data.get()),data.observe(function(_this){return function(){return _this.update(data.get())}}(this)),this.compareView.barItemLoaded(this)},TileItemView.prototype.path=function(){return this.compareView.path()},TileItemView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/compare/UnauthorizedTileItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame","icons"],c:function(){var UnauthorizedTileItem;return UnauthorizedTileItem=function(_super){__extends(UnauthorizedTileItem,_super);function UnauthorizedTileItem(){return UnauthorizedTileItem.__super__.constructor.apply(this,arguments)}return UnauthorizedTileItem.prototype.width=function(){return UnauthorizedTileItem.__super__.width.apply(this,arguments)+48},UnauthorizedTileItem.prototype.onData=function(barItemData,data){return this.data=data,this.el.addClass(data.objectType),this.widthChanged()},UnauthorizedTileItem.prototype.destruct=function(){return UnauthorizedTileItem.__super__.destruct.apply(this,arguments),this.el.removeClass(this.data.objectType)},UnauthorizedTileItem}(TileItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/CompetitiveProcessView",[],function(){return{d:["View"],c:function(){var CompetitiveProcessView;return CompetitiveProcessView=function(_super){__extends(CompetitiveProcessView,_super),CompetitiveProcessView.prototype.type="CompetitiveProcess";function CompetitiveProcessView(){CompetitiveProcessView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-competitiveProess"> <div class="elements"> <div class="element" /> </div> </div>'),this.elementsEl=this.el.find(".elements"),this.el.find(".elements").data("spacing",5).attr("draggingroot",!0)}return CompetitiveProcessView.prototype.updateLayout=function(animate){var itemSpacing,width,x;return animate==null&&(animate=!1),x=0,itemSpacing=5,this.el.children(".elements").children(".element").each(function(){return animate?$(this).stop(!0,!0).animate({left:x}):$(this).css({left:x}),x+=$(this).data("view").width()+itemSpacing}),width=Math.max(0,x-itemSpacing),this.el.children(".elements").css("width",width?width:48)},CompetitiveProcessView.prototype.childWidthChanged=function(){return this.updateLayout()},CompetitiveProcessView.prototype.initEl=function(el,row){var mousemove,newTop,offset;return offset=null,newTop=null,el.css({top:-row*48}),mousemove=function(_this){return function(e){var newRow;newTop=Math.min(0,e.pageY-_this.elementsEl.offset().top-offset.y),newRow=-Math.round(newTop/48);if(row!==newRow)return row=newRow,_this.callBackgroundMethod("setRow",[el.data("view").id,row]),el.stop(!0).animate({top:-row*48})}}(this),el.mousedown(function(_this){return function(e){return offset={x:e.pageX-el.offset().left,y:e.pageY-el.offset().top},$(window).mousemove(mousemove),$(window).one("mouseup",function(){return $(window).unbind("mousemove",mousemove)})}}(this))},CompetitiveProcessView.prototype.onData=function(data){var contents;return this.data=data,contents=this.listInterface(this.el,".element",function(_this){return function(el,data,pos,onRemove){var barItemView;return barItemView=_this.createView("BarItemView",_this.shoppingBarView,{barItemArgs:{draggingData:{immutableContents:!0,enabled:!1}}}),barItemView.changedType=function(){return _this.initEl(barItemView.el,data.row.get())},barItemView.represent(data.barItem),onRemove(function(){return barItemView.destruct()}),barItemView.el}}(this)),contents.setDataSource(data),contents.onInsert=function(_this){return function(){return _this.updateLayout(!0)}}(this),contents.onDelete=function(_this){return function(el,del){return del(),_this.updateLayout(!0)}}(this),contents.onMove=function(_this){return function(){return _this.updateLayout(!0)}}(this),this.updateLayout()},CompetitiveProcessView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ContactView",[],function(){return{d:["View","util","icons"],c:function(){var ContactView;return ContactView=function(_super){__extends(ContactView,_super),ContactView.prototype.type="Contact";function ContactView(){ContactView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-contact t-dialog"> <h2>Contact</h2> <div class="content"> <form class="dark"> <input type="text" name="subject" placeholder="Subject (optional)"> <div class="messageWrapper"> <textarea placeholder="Message" name="message"></textarea> </div> <span class="thankYou">Thank you for contacting us! We will get back to you as soon as we can.</span> <input type="Submit"> </form> </div> </div>'),this.el.submit(function(_this){return function(){return _this.callBackgroundMethod("submit",[_this.el.find('[name="subject"]').val(),_this.el.find('[name="message"]').val()]),_this.el.addClass("sent"),setTimeout(function(){return _this.close()},1500),!1}}(this)),setTimeout(function(_this){return function(){return _this.el.find('[name="subject"]').get(0).focus()}}(this),10)}return ContactView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/CouponsView",[],function(){return{d:["View","Frame"],c:function(){var CouponsView;return CouponsView=function(_super){__extends(CouponsView,_super),CouponsView.prototype.type="Coupons";function CouponsView(contentScript){this.contentScript=contentScript,CouponsView.__super__.constructor.call(this,this.contentScript),this.el=$('<div class="-agora v-coupons"> <div class="cont"> Loading deals... </div> </div>'),util.trapScrolling(this.el.find(".cont"))}return CouponsView.prototype.onData=function(data){var update;return update=function(_this){return function(){var contEl,deal,_i,_len,_ref;contEl=_this.el.find(".cont");if(data.get()){contEl.html(""),_ref=data.get();for(_i=0,_len=_ref.length;_i<_len;_i++)deal=_ref[_i],contEl.append("<div class='deal'><a target='_blank' href='"+deal.href+"'>"+deal.offer_text+"</a></div>")}return typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),data.observe(update),update()},CouponsView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/DataView",[],function(){return{d:["View","util","icons"],c:function(){var DataView;return DataView=function(_super){__extends(DataView,_super),DataView.prototype.type="Data";function DataView(){var addDataView,opened;DataView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-data"> <div class="cont"> <ul class="data"> <li /> </ul> <div class="addWrapper"><input type="text" class="add" placeholder="Paste URL to add content"></div> </div> </div>'),util.trapScrolling(this.el.find(".data")),opened=!1,addDataView=null,this.el.find(".add").keyup(function(_this){return function(e){if(e.keyCode===13){if(opened)return addDataView.submit(),_this.event("addData")}else if(_this.el.find(".add").val()!==""){if(!opened)return opened=!0,_this.event("beginAddData"),addDataView=_this.createView("AddData",{type:"connected",url:_this.el.find(".add").val(),args:_this.args}),addDataView.onSubmit=function(){return _this.el.find(".add").val("")},_this.popout=util.createPopout(_this.el.find(".addWrapper"),{el:addDataView.el,side:"left",anchor:"middle",distance:17,onClose:function(){return delete _this.popout,opened=!1}}),addDataView.close=_this.popout.close}else if(opened)return _this.event("cancelAddData"),_this.popout.close()}}(this))}return DataView.prototype.onData=function(data){var dataIface,updateSize;return this.data=data,dataIface=this.listInterface(this.el,".data li",function(_this){return function(el,data,pos,onRemove){var updateForUrl,view;view=_this.view(),onRemove(function(){return view.destruct()}),el.addClass(data.type.get());switch(data.type.get()){case"plainText":el.html("<span class='text' /> <a href='#' target='_blank' class='url'>Page</a> <span class='date' />"),view.valueInterface(el.find(".text")).setDataSource(data.text),view.valueInterface(el.find(".url")).setDataSource(data.url,function(value,el){return el.attr("href",value)});break;case"video":el.html('<a href="#" class="title" /> <span class="videoWrapper" />'),view.valueInterface(el.find(".title")).setDataSource(data.title),updateForUrl=function(){var matches;return matches=/https?:\/\/www\.youtube\.com\/watch\?.*?v=(.*?)(&|$)/.exec(data.url.get()),matches&&el.find(".videoWrapper").html("<iframe class='videoPlayer' width='314' height='177' src='//www.youtube.com/embed/"+matches[1]+"' frameborder='0' allowfullscreen></iframe>"),el.find(".title").attr("href",data.url.get())},updateForUrl(),data.url.observe(updateForUrl);break;case"image":el.html('<a href="#" class="title" target="_blank" /> <a class="image" target="_blank" /> <span class="date" />'),updateForUrl=function(){return el.find(".image").css({backgroundImage:"url("+data.url.get()+")"}),el.find(".image").attr("href",data.url.get())},data.url.observe(updateForUrl),updateForUrl(),view.valueInterface(el.find(".title")).setDataSource(data.title),view.valueInterface(el.find(".title"),"href").setDataSource(data.url);break;case"url":el.html('<a class="title" target="_blank" /> <span class="date" />'),view.valueInterface(el.find(".title")).setDataSource(data.title),view.valueInterface(el.find(".title"),"href").setDataSource(data.url)}return el.append("<a href='#' class='delete' />").find(".delete").click(function(){return _this.event("delete"),_this.callBackgroundMethod("delete",data.id),!1}),util.tooltip(el.find(".delete"),"delete",{position:"below"}),el}}(this)),data.length()?this.el.removeClass("empty"):this.el.addClass("empty"),updateSize=function(_this){return function(){var height,lastEl;return dataIface.length()?_this.el.removeClass("empty"):_this.el.addClass("empty"),_this.popout&&_this.popout.updatePos(),lastEl=_this.el.find(".data li:last"),height=30,lastEl.length&&(height+=lastEl.offset().top-_this.el.find(".data").offset().top+lastEl.outerHeight()+10),_this.el.find(".cont").css({height:height}),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this),dataIface.setDataSource(data),dataIface.onLengthChanged=updateSize,setTimeout(updateSize,0)},DataView.prototype.shown=function(){return this.event("open"),_tutorial("AddData",this.el.find(".add"))},DataView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/DecisionPreviewView",[],function(){return{d:["View","Frame","views/OffersView","views/DataView","views/AddFeelingView","views/AddArgumentView"],c:function(){var DecisionPreviewView;return DecisionPreviewView=function(_super){__extends(DecisionPreviewView,_super);function DecisionPreviewView(){return DecisionPreviewView.__super__.constructor.apply(this,arguments)}return DecisionPreviewView.prototype.type="DecisionPreview",DecisionPreviewView.prototype.init=function(){return this.viewEl('<span class="descriptorTooltip"> <span class="preview"><span class="image" /></span> <div class="descriptorWrapper"><span class="icon" /> <span class="descriptor" /><a class="edit" href="#" /></div> </span>')},DecisionPreviewView.prototype.onData=function(data){var classesForLength,contents,edit,openCompareView,prevLength,text,updateForLength,_ref,_ref1,_ref2;return text=((_ref=data.descriptor.get())!=null?_ref.descriptor:void 0)?(_ref1=data.descriptor.get())!=null?_ref1.descriptor:void 0:"<i>Edit Decision</i>",this.el.find(".descriptorWrapper .descriptor").html(text),icons.setIcon(this.el.find(".icon"),(_ref2=data.icon.get())!=null?_ref2:"list",{size:"small"}),this.el.find(".icon").removeClass("t-item"),util.tooltip(this.el.find(".edit"),"edit"),edit=function(_this){return function(){return _this.editInModalDialog?(tracking.page(""+_this.path()+"/EditDescriptor"),util.presentViewAsModalDialog("EditDescriptor",_this.args)):_this.editEnv(function(el){var editDescriptorView,frame;return editDescriptorView=_this.createView("EditDescriptor"),editDescriptorView._mouseenter(!0),editDescriptorView.close=function(){return frame.close()},editDescriptorView.represent({decision:_this.args}),frame=Frame.frameAround(el,editDescriptorView.el,{type:"balloon",distance:20,close:function(){return frame.close(),editDescriptorView.destruct()}}),tracking.page(""+_this.path()+"/"+editDescriptorView.pathElement())})}}(this),this.el.find(".edit").click(function(){return edit(),!1}),this.el.find(".descriptor").click(function(){return edit(),!1}),openCompareView=function(_this){return function(){var compareTileView,frameEl;return tracking.page(""+_this.path()+"/Compare"),compareTileView=new CompareView(_this.contentScript),compareTileView.shoppingBarView=shoppingBarView,frameEl=Frame.wrapInFrame(compareTileView.el,{type:"fullscreen",scroll:!0,resize:function(width,height){return[width-100,height-100]},close:function(){return compareTileView.destruct()}}),compareTileView.close=function(){return Frame.close(frameEl)},frameEl.appendTo(document.body),Frame.show(frameEl),compareTileView.setContEl(frameEl.data("client")),compareTileView.backEl=compareTileView.contEl,compareTileView.el.css({margin:"20px auto 0"}),compareTileView.represent(_this.args)}}(this),this.el.find(".preview").click(openCompareView),contents=this.listInterface(this.el.find(".preview"),".image",function(_this){return function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}}(this)),contents.setDataSource(data.preview),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(_this){return function(){return _this.el.find(".preview").removeClass(classesForLength[prevLength]),_this.el.find(".preview").addClass(classesForLength[prevLength=contents.length()])}}(this),contents.onLengthChanged=updateForLength,updateForLength(),typeof this.sizeChanged=="function"?this.sizeChanged():void 0},DecisionPreviewView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/EditDescriptorView",[],function(){return{d:["View","util","icons"],c:function(){var EditDescriptorView;return EditDescriptorView=function(_super){__extends(EditDescriptorView,_super),EditDescriptorView.prototype.type="EditDescriptor";function EditDescriptorView(){var descriptorEl,el,parseTimerId,parsing;EditDescriptorView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="v-editDescriptor t-dialog"> <h2>Edit Decision</h2> <div class="content"> <form> <div class="fields dark"> <div class="group descriptor"> <div class="field"><input type="text" class="descriptor" name="descriptor" placeholder="Describe what you are looking for"></div> </div> <div class="group"> <div class="field"><label>Product</label> <input type="text" name="product" placeholder="Product"></div> <div class="field"><label>Purpose</label> <input type="text" name="purpose" placeholder="Purpose"></div> <div class="field"><label>Context</label> <input type="text" name="context" placeholder="Context"></div> </div> <div class="group properties"> <div class="field"><label>Properties</label> <input type="text" name="properties" placeholder="Properties"></div> </div> <div class="group recipient"> <div class="field"><label>Recipient</label> <input type="text" name="recipient" placeholder="Recipient"></div> <div class="field"><label>Relationship</label> <input type="text" name="recipient.relationship" placeholder="Relationship"></div> <div class="field"><label>Age</label> <input type="text" name="recipient.age" placeholder="Age"></div> <div class="field"> <label>Sex</label> <select name="recipient.sex"> <option>Sex</option> <option value="male">Male</option> <option value="female">Female</option> </select> </div> </div> <div class="group gift"> <div class="field"><label>Gift</label> <input type="checkbox" name="gift"> </div> <div class="field gift"><label>Occasion</label> <input type="text" name="gift.occasion" placeholder="Occasion"></div> </div> <div class="buttons"> <!--<input type="button" class="button cancel" value="cancel">--> <input type="submit" class="button" value="confirm"> </div> </div> </form> </div> </div>'),parseTimerId=null,descriptorEl=this.el.find("input.descriptor"),parsing=0,descriptorEl.keydown(function(_this){return function(){return clearTimeout(parseTimerId),parseTimerId=setTimeout(function(){if(_this.lastDescriptor!==descriptorEl.val())return parsing++,_this.lastDescriptor=descriptorEl.val(),_this.callBackgroundMethod("parse",[descriptorEl.val()])},500)}}(this)),util.styleSelect(this.el.find('[name="recipient.sex"]'),{autoSize:!1}),el=this.el.find(".-agora-newItem"),util.tooltip(this.el.find(".-agora-newItem"),function(_this){return function(){return descriptorEl.val()}}(this),{position:"below"}),this.el.find("form").submit(function(_this){return function(){var descriptor,person,product;return clearTimeout(parseTimerId),_this.lastDescriptor!==descriptorEl.val()?(_this.callBackgroundMethod("parse",[descriptorEl.val(),!0]),_this.close(),!1):(descriptor={},descriptor.descriptor=descriptorEl.val(),product=null,_this.el.find('[name="product"]').val()!==""&&(product==null&&(product={}),product.type=_this.el.find('[name="product"]').val()),_this.el.find('[name="properties"]').val()!==""&&(product==null&&(product={}),product.properties=_.map(_this.el.find('[name="properties"]').val().split(","),function(p){return p.trim()})),product&&(descriptor.product=product),_this.el.find('[name="purpose"]').val()!==""&&(descriptor.purpose=_this.el.find('[name="purpose"]').val()),_this.el.find('[name="context"]').val()!==""&&(descriptor.context=_this.el.find('[name="context"]').val()),person=null,_this.el.find('[name="recipient"]').val()!==""&&(person==null&&(person={}),person.name=_this.el.find('[name="recipient"]').val()),_this.el.find('[name="recipient.relationship"]').val()!==""&&(person==null&&(person={}),person.relationship=_this.el.find('[name="recipient.relationship"]').val()),_this.el.find('[name="recipient.age"]').val()!==""&&(person==null&&(person={}),person.age=_this.el.find('[name="recipient.age"]').val()),_this.el.find('[name="recipient.sex"] ').val()!==""&&(person==null&&(person={}),person.sex=_this.el.find('[name="recipient.sex"]').val()),person&&(descriptor.person=person),_this.el.find('[name="gift.occasion"]').val()!==""&&(descriptor.occasion=_this.el.find('[name="gift.occasion"]').val()),descriptor.version=_this.version,_this.callBackgroundMethod("updateDescriptor",descriptor),_this.close(),!1)}}(this)),setTimeout(function(_this){return function(){return descriptorEl.get(0).focus()}}(this),50)}return EditDescriptorView.prototype.onData=function(data){var update;return this.data=data,_tutorial("EditDescriptor",{positionEl:this.el.find('[name="descriptor"]'),attachEl:this.el}),update=function(_this){return function(){var descriptor,_ref,_ref1,_ref10,_ref11,_ref12,_ref13,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;return descriptor=_this.descriptor=(_ref=data.get())!=null?_ref:{},_this.version=descriptor.version,descriptor.descriptor&&_this.el.find('[name="descriptor"]').val(descriptor.descriptor),_this.lastDescriptor=_this.el.find('[name="descriptor"]').val(),_this.el.find('[name="product"]').val((_ref1=(_ref2=descriptor.product)!=null?_ref2.type:void 0)!=null?_ref1:""),_this.el.find('[name="purpose"]').val((_ref3=descriptor.purpose)!=null?_ref3:""),_this.el.find('[name="context"]').val((_ref4=descriptor.context)!=null?_ref4:""),((_ref5=descriptor.product)!=null?_ref5.properties:void 0)?_this.el.find('[name="properties"]').val(descriptor.product.properties.join(", ")):_this.el.find('[name="properties"]').val(""),_this.el.find('[name="recipient"]').val((_ref6=(_ref7=descriptor.person)!=null?_ref7.name:void 0)!=null?_ref6:""),_this.el.find('[name="recipient.relationship"]').val((_ref8=(_ref9=descriptor.person)!=null?_ref9.relationship:void 0)!=null?_ref8:""),_this.el.find('[name="recipient.age"]').val((_ref10=(_ref11=descriptor.person)!=null?_ref11.age:void 0)!=null?_ref10:""),((_ref12=descriptor.person)!=null?_ref12.sex:void 0)?_this.el.find('[name="recipient.sex"]').children("[value="+((_ref13=descriptor.person)!=null?_ref13.sex:void 0)+"]").prop("selected",!0):_this.el.find('[name="recipient.sex"]').children(":first").prop("selected",!0),_this.el.find('[name="recipient.sex"]').trigger("change"),"occasion"in descriptor?(_this.el.find('[name="gift"]').prop("checked",!0),_this.el.find('[name="gift.occasion"]').val(descriptor.occasion)):(_this.el.find('[name="gift"]').prop("checked",!1),_this.el.find('[name="gift.occasion"]').val(""))}}(this),update(),data.observe(function(_this){return function(){return--_this.parsing,update()}}(this))},EditDescriptorView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/OffersView",[],function(){return{d:["View","Frame"],c:function(){var OffersView;return OffersView=function(_super){__extends(OffersView,_super),OffersView.prototype.type="Offers";function OffersView(contentScript){this.contentScript=contentScript,OffersView.__super__.constructor.call(this,this.contentScript),this.el=$('<div class="-agora v-offers images"> <div class="cont"> Loading offers... </div> </div>'),this.el.find(".n-remove").click(function(_this){return function(){return _this.callBackgroundMethod("remove")}}(this)),util.trapScrolling(this.el.find(".cont"))}return OffersView.prototype.onData=function(data){var updateOffers,updateSelectedOffer;return updateOffers=function(_this){return function(){var contEl,offer,offerSection,offers,offersEl,sectionEl,_fn,_i,_j,_len,_len1,_ref;contEl=_this.el.find(".cont");if(data.offers.get()){contEl.html(""),offers=data.offers.get();if(offers.length)for(_i=0,_len=offers.length;_i<_len;_i++){offerSection=offers[_i],sectionEl=$('<div class="section" />'),sectionEl.append("<h2>"+offerSection.heading+"</h2>"),offersEl=$('<ul class="offers" />'),_ref=offerSection.offers,_fn=function(offer){var offerEl;return offerEl=$("<li class='offer' data-api='"+offer.api+"' offerid='"+offer.id+"'> <a href='"+offer.url+"' target='_blank' class='photo' style='background-image:url("+offer.image+")'></a> <a href='"+offer.url+"' target='_blank' class='title'>"+offer.title+"</a> <span class='site'>"+offer.site+"</span> <span class='price'>"+offer.price+"</span> </li>"),offerEl.find(".price").click(function(){return _this.event("setOffer"),_this.callBackgroundMethod("setOffer",offer.data),!1}),offersEl.append(offerEl)};for(_j=0,_len1=_ref.length;_j<_len1;_j++)offer=_ref[_j],_fn(offer);sectionEl.append(offersEl),contEl.append(sectionEl)}else contEl.html("No offers")}return typeof _this.sizeChanged=="function"&&_this.sizeChanged(),updateSelectedOffer()}}(this),updateSelectedOffer=function(_this){return function(){return _this.el.find(".offer.selected").removeClass("selected"),_this.el.find("[offerid='"+data.selectedOffer.get()+"'").addClass("selected")}}(this),data.offers.observe(updateOffers),updateOffers(),data.selectedOffer.observe(updateSelectedOffer)},OffersView.prototype.shown=function(){return this.event("open")},OffersView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ProductAddedView",[],function(){return{d:["View","Frame"],c:function(){var ProductAddedView;return ProductAddedView=function(_super){__extends(ProductAddedView,_super),ProductAddedView.prototype.type="ProductAdded";function ProductAddedView(contentScript){this.contentScript=contentScript,ProductAddedView.__super__.constructor.call(this,this.contentScript),this.el=$('<div class="-agora v-productAdded"> <span class="p-picture"></span> <div class="g-info"> <span class="p-title t-field" data-name="title"> <span class="display">Legend of Zelda: A Link to the Past</span> <span class="edit-w"><span class="w"><input type="text" class="edit"></span></span> </span> <span class="p-site">Amazon</span> <span class="p-price t-field" data-name="price"> <span class="display"></span> <span class="edit-w"><span class="w"><input type="text" class="edit"></span></span> </span> </div> <span class="v-button small n-close">Done</span> </div>'),this.el.find(".n-remove").click(function(_this){return function(){return _this.callBackgroundMethod("remove",null,function(returnVal){return console.log(returnVal)})}}(this)),this.editingCount=0,this.isEditing={},this.el.mouseenter(function(_this){return function(){return _this.mouseOver=!0,_this.updateInUse()}}(this)),this.el.mouseleave(function(_this){return function(){return _this.mouseOver=!1,_this.updateInUse()}}(this))}return ProductAddedView.prototype.updateInUse=function(){if(this.mouseOver||this.editingCount){if(!this.inUse)return this.inUse=!0,typeof this.onStartedUsing=="function"?this.onStartedUsing():void 0}else if(this.inUse)return this.inUse=!1,typeof this.onStoppedUsing=="function"?this.onStoppedUsing():void 0},ProductAddedView.prototype.onData=function(data){var enableEditModeForField,fields,image,price,site,title,updateField;return title=this.el.find(".p-title"),site=this.el.find(".p-site"),image=this.el.find(".p-picture"),price=this.el.find(".p-price"),fields={price:{display:"displayPrice"}},updateField=function(field,edit){var display,name,_ref;name=field.attr("data-name");if(display=(_ref=fields[name])!=null?_ref.display:void 0){field.find(".display").html(data[display].get());if(edit)return field.find(".edit").val(data[name].get())}else if(data[name].get()){field.find(".display").html(data[name].get());if(edit)return field.find(".edit").val(data[name].get())}},enableEditModeForField={},this.el.find(".t-field").each(function(_this){return function(i,el){var closeEdit,display,edit,editModeEnabled,enabledEditMode,field,name,save,_ref;return field=$(el),name=field.attr("data-name"),updateField(field,!0),edit=field.find(".edit"),enabledEditMode=function(startEditing){startEditing==null&&(startEditing=!0),field.addClass("s-editing"),setTimeout(function(){return edit.get(0).select(),edit.get(0).focus()},0);if(!_this.isEditing[name]&&startEditing)return _this.isEditing[name]=!0,++_this.editingCount,_this.updateInUse()},enableEditModeForField[name]=enabledEditMode,editModeEnabled=function(){return field.hasClass("s-editing")},closeEdit=function(){return _this.isEditing[name]&&(delete _this.isEditing[name],--_this.editingCount,_this.updateInUse()),field.removeClass("s-editing"),edit.get(0).blur()},(data[name].get()===""||name==="price")&&enabledEditMode(!1),field.find(".display").dblclick(enabledEditMode),(display=(_ref=fields[name])!=null?_ref.display:void 0)&&_this.observe(data[display],function(mutation){return updateField(field,!editModeEnabled())}),_this.observe(data[name],function(mutation){return updateField(field,!editModeEnabled())}),save=function(){var d;return d={},d[name]=edit.val(),_this.callBackgroundMethod("set",[d]),closeEdit()},edit.keydown(function(e){var nextField;switch(e.which){case 9:return fields=_this.el.find(".t-field"),i=$.inArray(field.get(0),fields),nextField=$(fields.get((i+1)%fields.length)),save(),enableEditModeForField[nextField.attr("data-name")](),!1;case 13:return save(),!1;case 27:return closeEdit(),updateField(field,!0),!1}if(!_this.isEditing[name])return++_this.editingCount,_this.isEditing[name]=!0,_this.updateInUse()})}}(this)),site.html(data.site.name),data.image.get()&&image.css({backgroundImage:"url('"+data.image.get()+"')"}),this.observe(data.image,function(mutation){return image.css({backgroundImage:"url('"+mutation.value+"')"})}),this.el.find(".n-close").click(function(_this){return function(){return _this.onClose()}}(this))},ProductAddedView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ProductOverlayView",[],function(){return{d:["View","views/ProductPreviewView"],c:function(){var ProductOverlayView;return ProductOverlayView=function(_super){__extends(ProductOverlayView,_super),ProductOverlayView.prototype.type="ProductOverlay",ProductOverlayView.clear=function(el){return el.parent().find("bdo.-agora.-agora-productBadge").remove()};function ProductOverlayView(contentScript,productData,imgEl,opts){var attachEl,badgeEl,cancelHide,count,down,el,extraOverlayElements,frameEl,hide,hideTimer,hovering,i,initiateHide,offsetParentEl,parent,parents,popup,position,positionEl,positionStyle,productPreviewView,show,up,updatePosition,_i,_len;opts==null&&(opts={}),ProductOverlayView.__super__.constructor.apply(this,arguments),imgEl=$(imgEl),positionEl=attachEl=null,opts.positionEl&&opts.attachEl?(positionEl=opts.positionEl,attachEl=opts.attachEl):(positionEl=imgEl,attachEl=imgEl.parent()),this.showPreview=!0,hovering=opts.hovering,extraOverlayElements=opts.extra,position=opts.position,positionStyle=null,badgeEl=null,productPreviewView=null,frameEl=null,offsetParentEl=null;if(attachEl.css("position")!=="static"||attachEl.get(0)===document.body)offsetParentEl=attachEl;else{parents=attachEl.parents(),i=0;while(i<parents.length){parent=$(parents.get(i));if(parent.css("position")!=="static"||parent.get(0)===document.body){offsetParentEl=parent;break}++i}}this.el=badgeEl=$('<bdo class="-agora -agora-productBadge" />'),badgeEl.click(function(_this){return function(){return popup.close(),popup.cancelOpen(),frameEl=util.openProductPreview(productData,_this),tracking.page("/ProductOveray/ProductPortal"),tracking.event("ProductOverlay","click"),!1}}(this)),Q(attachEl).data("overlay",this),Q(attachEl).append(badgeEl),badgeEl.css({position:"absolute"}),this.updatePosition=updatePosition=function(_this){return function(){var left,margin,top;margin=positionEl.width()*.05,left=positionEl.offset().left-offsetParentEl.offset().left,top=positionEl.offset().top-offsetParentEl.offset().top,position==="topRight"&&badgeEl.css({left:left+positionEl.width()-badgeEl.width()-margin,top:top+margin});if(position==="topLeft")return badgeEl.css({left:left+margin,top:top+margin})}}(this),badgeEl.css({opacity:0}),updatePosition(),this.test=function(_this){return function(){return badgeEl.parents("body").length||(_this.destruct(),!1),!0}}(this),this.showBadge=function(_this){return function(){if(!_this.test())return;if(!_this.showing)return updatePosition(),badgeEl.stop().css({opacity:0}).animate({opacity:1},200),_this.showing=!0}}(this),this.hideBadge=function(_this){return function(){if(!_this.test())return;return _this.showing=!1,badgeEl.stop().animate({opacity:0},200,function(){})}}(this),count=0,up=function(_this){return function(){return count||show(),++count}}(this),down=function(_this){return function(){if(count>0){--count;if(!count)return hide()}}}(this),hovering&&count++,hovering&&(this.showBadge(),this.active=!0),hideTimer=null,initiateHide=function(_this){return function(){return clearTimeout(hideTimer),hideTimer=setTimeout(hide,10)}}(this),cancelHide=function(_this){return function(){return clearTimeout(hideTimer)}}(this),hide=function(_this){return function(){_this.active=!1;if(!_this._alwaysShow)return _this.hideBadge()}}(this),show=function(_this){return function(){return _this.showBadge(),_this.active=!0}}(this),Q(attachEl).mouseenter(up),Q(attachEl).mouseleave(down),this.onDestruct=function(){return attachEl.unbind("mouseenter",up).unbind("mouseleave",down),this.el.remove(),attachEl.removeData("overlay")};if(extraOverlayElements)for(_i=0,_len=extraOverlayElements.length;_i<_len;_i++)el=extraOverlayElements[_i],Q(el).mouseenter(up).mouseleave(down);popup=util.popupTrigger2(this.el,{delay:500,createPopup:function(_this){return function(cb,close,addEl){var productPopupView;return!Agora.settings.showPreview.get()||!_this.showPreview?!1:(productPopupView=_this.createView("ProductPopupView",{unconstrainedPictureHeight:!0}),productPopupView.represent(_this.args,function(){var frame;return frame=Frame.frameAbove(_this.el,productPopupView.el,{type:"balloon",position:_this.el.offset().top-$(window).scrollTop()<$(window).height()/3?"below":"above",onClose:function(){return productPopupView.destruct(),productPopupView=null}}),productPopupView.close=close,productPopupView.sizeChanged=function(){return frame.update()},productPopupView.addEl=addEl,frame.el.mouseenter(cancelHide),up(),tracking.event("popup","appear","ProductPopup"),tracking.page(""+_this.path()+"/"+productPopupView.pathElement()),cb(frame.el)}),null)}}(this),onClose:function(_this){return function(el,animate){var _ref;return(_ref=el.data("frame"))!=null&&typeof _ref.close=="function"&&_ref.close(animate),down()}}(this)})}return ProductOverlayView.prototype.autoFixPosition=function(){return setInterval(function(_this){return function(){return _this.updatePosition()}}(this),1e3)},ProductOverlayView.prototype.alwaysShow=function(alwaysShow){if(alwaysShow!==this._alwaysShow){this._alwaysShow=alwaysShow;if(alwaysShow){if(!this.showing)return this.showBadge()}else if(!this.active)return this.hideBadge()}},ProductOverlayView.prototype.addAlwaysShow=function(reason){this.alwaysShowReasons==null&&(this.alwaysShowReasons={}),this.alwaysShowReasons[reason]=!0;if(_.keys(this.alwaysShowReasons).length)return this.alwaysShow(!0)},ProductOverlayView.prototype.removeAlwaysShow=function(reason){this.alwaysShowReasons==null&&(this.alwaysShowReasons={}),delete this.alwaysShowReasons[reason];if(!_.keys(this.alwaysShowReasons).length)return this.alwaysShow(!1)},ProductOverlayView.prototype.onData=function(data){var lastArgument,lastEmotion,onProp,updateForLastArgument,updateForLastFeeling;return onProp=function(prop,func){return func(prop.get()),prop.observe(function(mutation){return func(prop.get(),mutation)})},onProp(data.bagged,function(_this){return function(bagged){return bagged?(_this.el.addClass("added"),_this.addAlwaysShow("added")):(_this.el.removeClass("added"),_this.removeAlwaysShow("added"))}}(this)),onProp(data.status,function(_this){return function(status){return status===2?_this.el.addClass("error"):_this.el.removeClass("error")}}(this)),lastEmotion=null,updateForLastFeeling=function(_this){return function(){var emotionClass;return lastEmotion&&_this.el.removeClass(lastEmotion),data.lastFeeling.get()?(emotionClass=util.emotionClass(data.lastFeeling.get().positive,data.lastFeeling.get().negative),_this.el.addClass(emotionClass),lastEmotion=emotionClass,_this.addAlwaysShow("emotion")):(lastEmotion=null,_this.removeAlwaysShow("emotion"))}}(this),data.lastFeeling.observe(updateForLastFeeling),updateForLastFeeling(),lastArgument=null,updateForLastArgument=function(_this){return function(){var positionClass;return lastArgument&&_this.el.removeClass(lastArgument),data.lastArgument.get()?(positionClass=util.positionClass(data.lastArgument.get()["for"],data.lastArgument.get().against),_this.el.addClass(positionClass),lastArgument=positionClass,_this.addAlwaysShow("argument")):(lastArgument=null,_this.removeAlwaysShow("argument"))}}(this),data.lastArgument.observe(updateForLastArgument),updateForLastArgument()},ProductOverlayView.prototype.destruct=function(){return ProductOverlayView.__super__.destruct.apply(this,arguments),this.onDestruct()},ProductOverlayView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ProductPopupView",[],function(){return{d:["View","Frame","views/OffersView","views/DataView","views/AddFeelingView","views/AddArgumentView"],c:function(){var ProductPopupView;return ProductPopupView=function(_super){__extends(ProductPopupView,_super),ProductPopupView.prototype.type="ProductPopup";function ProductPopupView(contentScript,opts){this.opts=opts!=null?opts:{},ProductPopupView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="-agora v-productPopup"> <span class="p-picture"></span> <a href="#" class="p-title"></a> <a href="#" class="p-site"></a> <span class="ratingInfo"><span class="rating">'+util2.ratingHtml+'</span><span class="reviews">Loading...</span></span> <span class="price" /> <!--<a href="#" class="menu" />--> <ul class="subAdd"> <li class="feelings"><a href="#">Feelings</a></li> <li class="arguments"><a href="#">Pros and cons</a></li> <li class="attachments"><a href="#">Attached clips</a></li> </ul> <div class="productSidebar" /> </div>'),opts.unconstrainedPictureHeight&&(this.el.addClass("unconstrainedPictureHeight"),this.el.find(".p-picture").append("<img>")),this.productMenuView=this.createView("ProductMenu",this.el.find(".productSidebar"),{orientation:"horizontal",pinSidebar:function(_this){return function(){return _this.el.addClass("pinSidebar")}}(this),unpinSidebar:function(_this){return function(){return _this.el.removeClass("pinSidebar")}}(this),addEl:function(_this){return function(el){return typeof _this.addEl=="function"?_this.addEl(el):void 0}}(this)}),opts.pictureClickHandler?this.el.find(".p-picture").mouseup(opts.pictureClickHandler):this.el.find(".p-picture").mouseup(function(_this){return function(){return typeof _this.close=="function"&&_this.close(!1),util.openProductPreview(_this.args,_this),!1}}(this))}return ProductPopupView.prototype.showOffersDrawer=function(){var left,parentEl;return this.offersDrawerShown=!0,parentEl=this.el.parents(".-agora"),this.offersFrameEl?this.offersFrameEl.show():(this.offersFrameEl=Frame.wrapInFrame(this.offersView.el),this.offersFrameEl.removeClass("top"),this.offersFrameEl.appendTo(document.body)),this.offersFrameEl.css({position:"fixed",top:parentEl.get(0).offsetTop,margin:"11px 0 0 10px",zIndex:parentEl.css("zIndex")-1}),this.offersFrameEl.data("client").css({height:this.el.height()-20}),this.offersFrameEl.css({marginTop:(parentEl.height()-this.offersFrameEl.height())/2}),left=parentEl.get(0).offsetLeft+this.el.width(),left+this.offersFrameEl.width()<$(window).width()?(this.offersFrameEl.addClass("right").removeClass("left"),this.offersFrameEl.css({left:left-this.offersFrameEl.width()}).animate({left:left}),this.offserDrawerSide="right"):(this.offersFrameEl.removeClass("right").addClass("left"),left=parentEl.get(0).offsetLeft,this.offersFrameEl.css({left:parentEl.get(0).offsetLeft}).animate({left:left-this.offersFrameEl.width()}),this.offserDrawerSide="left")},ProductPopupView.prototype.closeOffersDrawer=function(){var left,parentEl;return parentEl=this.el.parents(".-agora"),this.offersDrawSide==="right"?(left=parentEl.get(0).offsetLeft+this.el.width(),this.offersFrameEl.animate({left:left-this.offersFrameEl.width()},function(_this){return function(){return _this.offersFrameEl.hide()}}(this))):(left=parentEl.get(0).offsetLeft,this.offersFrameEl.animate({left:left},function(_this){return function(){return _this.offersFrameEl.hide()}}(this))),this.offersDrawerShown=!1},ProductPopupView.prototype.onClose=function(){if(this.offersFrameEl)return this.offersFrameEl.animate({opacity:0},50,"linear",function(_this){return function(){return _this.offersFrameEl.remove(),delete _this.offersFrameEl}}(this))},ProductPopupView.prototype.mouseenter=function(cb){return this.mouseenterCb=cb},ProductPopupView.prototype.mouseleave=function(cb){return this.mouseleaveCb=cb},ProductPopupView.prototype.onRepresent=function(args){return this.createView("ProductPrice",this.el.find(".price")).represent(args,function(_this){return function(){return setTimeout(function(){return typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0},0)}}(this)),this.productMenuView.represent(args)},ProductPopupView.prototype.onData=function(data){var image,lastEmotion,mouseDowned,price,site,title,updateForImage,updateForLastFeeling;title=this.el.find(".p-title"),site=this.el.find(".p-site"),image=this.el.find(".p-picture"),price=this.el.find(".productOffer .price"),data.title.get()&&title.html(data.title.get()),this.observe(data.title,function(_this){return function(mutation){return title.html(mutation.value),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this)),data.rating&&data.ratingCount?(data.rating.get()&&util2.setRating(this.el.find(".ratingInfo .rating"),data.rating.get()),data.rating.observe(function(_this){return function(){return util2.setRating(_this.el.find(".ratingInfo .rating"),data.rating.get()),typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this)),this.valueInterface(this.el.find(".ratingInfo .reviews")).setDataSource(data.ratingCount)):this.el.find(".ratingInfo").remove(),title.attr({href:data.url}),site.html(data.site.name),site.attr({href:data.site.url}),updateForImage=this.opts.unconstrainedPictureHeight?function(_this){return function(){var height,img,updateForSize,updateMenuPos;updateForSize=function(){return image.css("height",img.height()),typeof _this.sizeChanged=="function"&&_this.sizeChanged(),updateMenuPos()},updateMenuPos=function(){return _this.el.find(".productSidebar").css({top:image.height()-_this.el.find(".productSidebar").height()+9})},img=image.find("img"),height=img.height(),clearInterval(_this.imageResizeTimerId),_this.imageResizeTimerId=setInterval(function(){return img.height()!==height&&(updateForSize(),clearInterval(_this.imageResizeTimerId)),height=img.height()},100),img.attr("src",data.image.get()).load(function(){return updateForSize(),clearInterval(_this.imageResizeTimerId)});if(img.height())return updateForSize()}}(this):function(_this){return function(){if(data.image.get())return image.css({backgroundImage:"url("+data.image.get()+")"})}}(this),updateForImage(),data.image.observe(updateForImage),this.el.append('<span class="feelingBadge"><span class="icon" /><span class="text">buffalo</span></span>'),lastEmotion=null,updateForLastFeeling=function(_this){return function(){var emotionClass;return lastEmotion&&_this.el.find(".feelingBadge").removeClass(lastEmotion),data.lastFeeling.get()?(_this.el.find(".feelingBadge").show(),_this.el.find(".feelingBadge .text").html(data.lastFeeling.get().thought),emotionClass=util.emotionClass(data.lastFeeling.get().positive,data.lastFeeling.get().negative),_this.el.find(".feelingBadge").addClass(emotionClass),lastEmotion=emotionClass):_this.el.find(".feelingBadge").hide()}}(this),data.lastFeeling.observe(updateForLastFeeling),updateForLastFeeling();if(data.selected)return mouseDowned=!1,this.el.append('<div class="actions"><!--<a href="#" class="dismiss" />--><input type="checkbox" class="chosen"></div>'),this.el.find(".chosen").prop("checked",data.selected.get()).mousedown(function(){return mouseDowned=!0}).mouseup(function(e){return mouseDowned||$(this).trigger("click"),e.stopPropagation(),mouseDowned=!1}).change(function(_this){return function(){return _this.callBackgroundMethod("setSelected",[_this.el.find(".chosen").prop("checked")])}}(this)).click(function(_this){return function(e){return _this.event("toggleChosen"),e.stopPropagation()}}(this)),this.observeObject(data.selected,function(_this){return function(){return _this.el.find(".chosen").prop("checked",data.selected.get())}}(this)),util.tooltip(this.el.find(".chosen"),"choose"),this.el.find(".dismiss").mouseup(function(_this){return function(){return _this.callBackgroundMethod("dismiss"),!1}}(this)).click(function(){return!1}),util.tooltip(this.el.find(".dismiss"),"dismiss"),typeof this.sizeChanged=="function"?this.sizeChanged():void 0},ProductPopupView.prototype.shown=function(){return this.productMenuView.shown(),this.event("open"),_tutorial("AccessProductPortalFromPopup",this.el.find(".p-picture"),"side")},ProductPopupView.prototype.destruct=function(){return ProductPopupView.__super__.destruct.apply(this,arguments),clearInterval(this.imageResizeTimerId)},ProductPopupView}(View)}}});var widgets,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};widgets=["AmazonFeatures","AmazonDetails","AmazonMostHelpfulReview","AmazonMostRecentReviews","AmazonQuotes","AmazonSizes","html","List","Details","Reviews"],define("client/views/ProductPreviewView",[],function(){var widget;return{d:function(){var _i,_len,_results;_results=[];for(_i=0,_len=widgets.length;_i<_len;_i++)widget=widgets[_i],_results.push("widgets/"+widget+"Widget");return _results}(),c:function(){var ProductPreviewView,withData;return withData=function(data,cb){return data.get()&&cb(data.get()),data.observe(function(){return cb(data.get())})},ProductPreviewView=function(_super){__extends(ProductPreviewView,_super);function ProductPreviewView(){return ProductPreviewView.__super__.constructor.apply(this,arguments)}return ProductPreviewView.prototype.flexibleLayout=!0,ProductPreviewView.prototype.type="ProductPreview",ProductPreviewView.prototype.init=function(opts){var actualSize,dragging,fit,imageFrameEl,imgEl,lastPos,productMenuView,scrollImage,scrollViewEl,setImageSize,update,zoomIn,zoomOut;return opts==null&&(opts={}),this["public"]=opts["public"],this.viewEl('<div class="-agora v-productPreview2 loading"> <div class="head"> <a href="#" class="title"><span class="title" /> <span class="continue">continue to product page</span></a> <span class="price" /> <span class="ratingInfo"> <span class="rating"> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> </span> <span class="reviews">Loading...</span> </div> <div class="content"> <div class="picture widget"> <span class="expand" /> <div class="current"> <div class="zoomLevel">Loading...</div> <div class="controls"> <span class="zoomIn">Zoom In</span> <span class="zoomOut">Zoom Out</span> <span class="actualSize">Actual Size</span> <span class="fit">Fit</span> </div> <span class="bg lowRes" /> <span class="bg mediumRes" /> <span class="bg hiRes" /> <div class="scrollView scroll vertical horizontal"> <img /> </div> </div> <div class="pictures scroll vertical"> </div> <div class="stylesWrapper scroll horizontal"> <div class="styles"> </div> </div> </div> <div class="widgets scroll vertical"> </div> <div class="productMenu white" /> </div> </div>'),productMenuView=this.createView("ProductMenu",this.el.find(".productMenu"),{"public":this["public"]}),this.alsoRepresent(productMenuView),this.el.find(".title").click(function(_this){return function(){return _this.event("continueToProduct")}}(this)),this.updateImage=update=function(_this){return function(){var frameSize;return frameSize={width:imageFrameEl.width(),height:imageFrameEl.height()},imgEl.css({marginLeft:Math.max(0,(frameSize.width-imgEl.width())/2),marginTop:Math.max(0,(frameSize.height-imgEl.height())/2)})}}(this),this.fitImage=!0,setImageSize=function(_this){return function(width,height){var frameSize,pos;return frameSize={width:imageFrameEl.width(),height:imageFrameEl.height()},pos={x:(scrollViewEl.scrollLeft()+frameSize.width/2)/imgEl.width(),y:(scrollViewEl.scrollTop()+frameSize.height/2)/imgEl.height()},imgEl.css({width:width,height:height}),scrollViewEl.scrollLeft(imgEl.width()*pos.x-frameSize.width/2),scrollViewEl.scrollTop(imgEl.height()*pos.y-frameSize.height/2),imgEl.css({marginLeft:Math.max(0,(frameSize.width-imgEl.width())/2),marginTop:Math.max(0,(frameSize.height-imgEl.height())/2)}),_this.fitImage=!1,_this.imageSize.height/_this.imageSize.width<frameSize.height/frameSize.width?width===frameSize.width&&(_this.fitImage=!0):height===frameSize.height&&(_this.fitImage=!0),_this.el.find(".picture .current .zoomLevel").html(Math.round(imgEl.width()/_this.imageSize.width*100)+"%"),update()}}(this),scrollImage=function(_this){return function(amount){return scrollViewEl.scrollLeft(scrollViewEl.scrollLeft()+amount.x),scrollViewEl.scrollTop(scrollViewEl.scrollTop()+amount.y)}}(this),zoomIn=function(_this){return function(){var frameSize,inc,newHeight,newWidth;return frameSize={width:imageFrameEl.width(),height:imageFrameEl.height()},newWidth=newHeight=null,_this.imageSize.height/_this.imageSize.width<frameSize.height/frameSize.width?(inc=(_this.imageSize.width-frameSize.width)/5,newWidth=Math.min(imgEl.width()+inc,_this.imageSize.width),newHeight=""):(inc=(_this.imageSize.height-frameSize.height)/5,newHeight=Math.min(imgEl.height()+inc,_this.imageSize.height),newWidth=""),setImageSize(newWidth,newHeight)}}(this),zoomOut=function(_this){return function(){var frameSize,inc,newHeight,newWidth;return frameSize={width:imageFrameEl.width(),height:imageFrameEl.height()},newWidth=newHeight="",_this.imageSize.height/_this.imageSize.width<frameSize.height/frameSize.width?(inc=(_this.imageSize.width-frameSize.width)/5,newWidth=Math.max(imgEl.width()-inc,frameSize.width)):(inc=(_this.imageSize.height-frameSize.height)/5,newHeight=Math.max(imgEl.height()-inc,frameSize.height)),setImageSize(newWidth,newHeight)}}(this),this.fit=fit=function(_this){return function(){var frameSize,height,width;return frameSize={width:imageFrameEl.width(),height:imageFrameEl.height()},width=height="",_this.imageSize.height/_this.imageSize.width<frameSize.height/frameSize.width?width=frameSize.width:height=frameSize.height,setImageSize(width,height)}}(this),actualSize=function(_this){return function(){return setImageSize("","")}}(this),imageFrameEl=this.el.find(".picture .current"),scrollViewEl=imageFrameEl.find(".scrollView"),imgEl=imageFrameEl.find("img"),this.imageSize=null,imgEl.hide().load(function(_this){return function(){return imgEl.show(),_this.el.find(".picture .current .bg").css("backgroundImage","none"),imgEl.css({width:"",height:""}),_this.imageSize={width:imgEl.width(),height:imgEl.height()},setTimeout(function(){return _this.el.find(".picture .current").removeClass("loading")},1e3),fit()}}(this)),dragging=!0,lastPos=null,scrollViewEl.mousedown(function(e){return dragging=!0,lastPos={x:e.clientX,y:e.clientY},$(window).bind("mousemove.draggingImage",function(_this){return function(e){var diff,pos;return pos={x:e.clientX,y:e.clientY},diff={x:pos.x-lastPos.x,y:pos.y-lastPos.y},scrollImage({x:-diff.x,y:-diff.y}),lastPos=pos}}(this)),$(window).one("mouseup",function(){return dragging=!1,$(window).unbind("mousemove.draggingImage")}),!1}),imageFrameEl.find(".controls").find(".fit").click(function(_this){return function(){return fit(),_this.event("picture/fit")}}(this)).end().find(".actualSize").click(function(_this){return function(){return actualSize(),_this.event("picture/actualSize")}}(this)).end().find(".zoomIn").click(function(_this){return function(){return zoomIn(),_this.event("picture/zoomIn")}}(this)).end().find(".zoomOut").click(function(_this){return function(){return zoomOut(),_this.event("picture/zoomOut")}}(this)).end(),$(window).bind("keypress.ProductPreviewView",function(_this){return function(e){switch(e.keyCode){case 40:return e.stopPropagation(),e.preventDefault(),!1;case 38:return e.stopPropagation(),e.preventDefault(),!1;case 37:return e.stopPropagation(),e.preventDefault(),!1;case 39:return e.preventDefault(),e.stopPropagation(),!1}}}(this)),$(window).bind("keydown.ProductPreviewView",function(_this){return function(e){var styles;switch(e.keyCode){case 40:return _this.setCurrentImage((_this.currentImage+1)%_this.images[_this.currentStyle].length,!0),e.stopPropagation(),e.preventDefault(),_this.event("nextPicture"),!1;case 38:return _this.setCurrentImage((_this.images[_this.currentStyle].length+_this.currentImage-1)%_this.images[_this.currentStyle].length,!0),e.stopPropagation(),e.preventDefault(),_this.event("previousPicture"),!1;case 37:return styles=_.keys(_this.images),_this.setCurrentStyle(styles[(styles.length+styles.indexOf(_this.currentStyle)-1)%styles.length],!0),e.stopPropagation(),e.preventDefault(),_this.event("previousStyle"),!1;case 39:return styles=_.keys(_this.images),_this.setCurrentStyle(styles[(styles.indexOf(_this.currentStyle)+1)%styles.length],!0),e.preventDefault(),e.stopPropagation(),_this.event("nextStyle"),!1;case 27:return _this.event("close","esc"),typeof _this.close=="function"&&_this.close(),!1}}}(this)),util.tooltip(this.el.find(".picture .controls .zoomIn"),"zoom in"),util.tooltip(this.el.find(".picture .controls .zoomOut"),"zoom out"),util.tooltip(this.el.find(".picture .controls .actualSize"),"actual size"),util.tooltip(this.el.find(".picture .controls .fit"),"fit"),this.el.find(".picture .expand").click(function(_this){return function(){return _this.el.toggleClass("fullPicture"),_this.updateLayout(),_this.event("toggleFullPicture")}}(this)),util.draggableImage({view:this,el:this.el.find(".picture .current img"),cancel:function(_this){return function(){return!_this.fitImage}}(this),productData:function(_this){return function(){return _this.args}}(this),image:function(_this){return function(){return _this.getCurrentImage()?_this.getCurrentImage().small:_this.defaultImage}}(this),onStart:function(_this){return function(){return _this.event("dragProduct")}}(this)})},ProductPreviewView.prototype.updateLayout=function(){return this.imageSize&&(this.fitImage?this.fit():this.updateImage()),this.updateStylesLayout()},ProductPreviewView.prototype.onRepresent=function(args){return this.createView("ProductPrice",this.el.find(".head .price")).represent(args)},ProductPreviewView.prototype.updateStylesLayout=function(){var contWidth,width;return contWidth=this.el.find(".stylesWrapper").width(),width=this.el.find(".styles").width(),this.el.find(".styles").css({marginLeft:Math.max(0,(contWidth-width)/2)})},ProductPreviewView.prototype.updateImages=function(){var i,image,_fn,_i,_len,_ref;this.images[this.currentStyle].length===1?this.el.find(".picture").addClass("singlePicture"):this.el.find(".picture").removeClass("singlePicture"),this.el.find(".picture .pictures").html(""),_ref=this.images[this.currentStyle],_fn=function(_this){return function(i){return _this.el.find(".picture .pictures").append($("<span />").css("backgroundImage","url('"+image.small+"')").click(function(){return _this.setCurrentImage(i),_this.event("selectPicture")}))}}(this);for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)image=_ref[i],_fn(i);return util.initScrollbar(this.el.find(".picture .pictures"))},ProductPreviewView.prototype.getCurrentImage=function(){return this.images[this.currentStyle][this.currentImage]},ProductPreviewView.prototype.setCurrentImage=function(image,scrollIntoView){var imgObj;scrollIntoView==null&&(scrollIntoView=!1),$(this.el.find(".picture .pictures span").get(this.currentImage)).removeClass("active"),this.currentImage=Math.min(image,this.images[this.currentStyle].length-1),imgObj=this.images[this.currentStyle][this.currentImage],this.el.find(".picture .current .bg.lowRes").css({backgroundImage:"url('"+imgObj.small+"')"}),this.el.find(".picture .current .bg.mediumRes").css({backgroundImage:"url('"+imgObj.medium+"')"}),this.el.find(".picture .current .bg.hiRes").css({backgroundImage:"url('"+imgObj.large+"')"}),this.el.find(".picture .current img").hide().attr("src",imgObj.full),this.el.find(".picture .current .zoomLevel").html("Loading..."),this.el.find(".picture .current").addClass("loading"),$(this.el.find(".picture .pictures span").get(this.currentImage)).addClass("active");if(scrollIntoView)return this.el.find(".picture .pictures .scrollWrapper").scrollTop(this.el.find(".picture .pictures span").get(this.currentImage).offsetTop-this.el.find(".picture .pictures").height()/2+this.el.find(".picture .pictures span:first-child").height()/2)},ProductPreviewView.prototype.setCurrentStyle=function(style,scrollIntoView){scrollIntoView==null&&(scrollIntoView=!1),this.el.find(".picture .styles").find(".active").removeClass("active").end().find("[stylename='"+style+"'").addClass("active"),this.currentStyle=style,this.updateImages(),this.setCurrentImage(this.currentImage,scrollIntoView);if(scrollIntoView&&this.el.find(".picture .styles").find("[stylename='"+style+"'").get(0))return this.el.find(".picture .stylesWrapper .scrollWrapper").scrollLeft(this.el.find(".picture .styles").find("[stylename='"+style+"'").get(0).offsetLeft-this.el.find(".picture .stylesWrapper").width()/2+this.el.find(".picture .styles span:first-child").width()/2)},ProductPreviewView.prototype.onData=function(data){var finishedLoading,loading,title;return title=this.el.find(".head .title"),data.title.get()&&title.find(".title").html(data.title.get()),this.observe(data.title,function(mutation){return title.find(".title").html(mutation.value)}),title.attr({href:data.url}),data.rating&&data.ratingCount?(withData(data.rating,function(_this){return function(rating){return util2.setRating(_this.el.find(".head .rating"),rating)}}(this)),this.valueInterface(this.el.find(".ratingInfo .reviews")).setDataSource(data.ratingCount)):this.el.find(".ratingInfo").remove(),loading=0,finishedLoading=function(_this){return function(){if(!--loading)return _this.el.removeClass("loading")}}(this),data.images?(loading++,withData(data.images,function(_this){return function(images){var styleImages,styleName,_fn,_ref;if((images!=null?images.images:void 0)&&_.keys(images.images).length){finishedLoading(),_this.images=images.images,_this.currentStyle=images.currentStyle,_this.currentImage=0;if(_.keys(images.images).length===1)_this.el.find(".picture").addClass("noStyles");else{_ref=images.images,_fn=function(styleName){return _this.el.find(".picture .styles").append($("<span stylename='"+styleName+"' />").css("backgroundImage","url('"+styleImages[0].small+"')").click(function(){return _this.setCurrentStyle(styleName),_this.event("selectStyle")}))};for(styleName in _ref)styleImages=_ref[styleName],_fn(styleName);util.initScrollbar(_this.el.find(".stylesWrapper"),{trapScrolling:!1})}return _this.updateStylesLayout(),_this.updateImages(),_this.setCurrentStyle(_this.currentStyle,!0)}return _this.el.addClass("noPictures"),_this.withData(data.image,function(image){return _this.el.find(".picture").css("backgroundImage","url("+image+")")})}}(this))):(this.el.addClass("noPictures"),this.withData(data.image,function(_this){return function(image){return _this.el.find(".picture").css("backgroundImage","url("+image+")")}}(this))),data.widgets?withData(data.widgets,function(_this){return function(widgets){var widgetData,widgetEl,_i,_len;if(widgets&&widgets.length){finishedLoading(),_this.el.removeClass("fullPicture").removeClass("widgetPanel");if(widgets==="none")_this.el.addClass("fullPicture");else{_this.el.addClass("widgetPanel");for(_i=0,_len=widgets.length;_i<_len;_i++){widgetData=widgets[_i];if(!__classes[""+widgetData.type+"Widget"])throw new Error("No widget "+widgetData.type);widget=new __classes[""+widgetData.type+"Widget"](widgetData.data),widgetEl=$('<div class="widget"><span class="title" /><div class="content" /></div>').find(".title").html(widget.title).end(),widgetEl.addClass("widget-"+widgetData.type),widgetEl.find(".content").append(widget.el),_this.el.find(".widgets").append(widgetEl),typeof widget.init=="function"&&widget.init()}}return util.initScrollbar(_this.el.find(".widgets"))}return _this.el.addClass("fullPicture")}}(this)):this.el.addClass("fullPicture")},ProductPreviewView.prototype.destruct=function(){return ProductPreviewView.__super__.destruct.apply(this,arguments),$(window).unbind(".ProductPreviewView")},ProductPreviewView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ProductPreviewView2",[],function(){return{d:["View","Frame","views/OffersView","views/AddFeelingView","views/AddArgumentView"],c:function(){var ProductPreviewView;return ProductPreviewView=function(_super){__extends(ProductPreviewView,_super),ProductPreviewView.prototype.type="ProductPreview",ProductPreviewView.prototype.flexibleLayout=!0;function ProductPreviewView(contentScript){this.contentScript=contentScript,ProductPreviewView.__super__.constructor.call(this,this.contentScript),this.el=$('<div class="-agora v-productPreview loading"> <a href="#" class="title"><span class="title" /> <span class="continue">continue to product page <span class="arrow">&rarr;</span></span></a> <span class="price" /> <ul class="pictures" /> <span class="picture lowRes" /> <span class="picture mediumRes" /> <a class="picture hiRes" /> <div class="stylesWrapper"><ul class="styles" /></div> <div class="productMenu white" /> </div>'),this.alsoRepresent(this.createView("ProductMenu",this.el.find(".productMenu"))),util.initDragging(this.el.find(".picture.hiRes"),{acceptsDrop:!1,affect:!1,context:"page",helper:function(event){return $('<div class="-agora -agora-productClip t-item dragging" style="position:absolute"> <span class="p-image"></span> <div class="g-productInfo"> <span class="p-title">loading...</span> <span class="p-site">loading...</span> <span class="p-price">loading...</span> </div> </div>')},start:function(_this){return function(event,ui){var clip,clipTimerId,height,image,item,itemState,marginLeft,marginTop,offsetX,offsetY,price,site,size,target,title,view,width;return _this.event("dragProduct"),target=$(event.currentTarget),width=target.width(),height=target.height(),image=ui.helper.find(".p-image"),image.css({backgroundImage:"url('"+(_this.image()?_this.image().small:_this.defaultImage)+"')",width:width,height:height}),title=ui.helper.find(".p-title"),site=ui.helper.find(".p-site"),price=ui.helper.find(".p-price"),view=new View(_this.contentScript),view.type="ProductClip",view.onData=function(data){return data.title.get()&&title.html(data.title.get()),view.observe(data.title,function(mutation){return title.html(mutation.value)}),data.site.get()&&site.html(data.site.get()),view.observe(data.site,function(mutation){return site.html(mutation.value)}),data.price.get()&&price.html(data.price.get()),view.observe(data.price,function(mutation){return price.html(mutation.value)})},ui.helper.data("dragging",{data:_this.args}),marginLeft=0,marginTop=0,offsetX=event.pageX-target.offset().left+marginLeft,offsetY=event.pageY-target.offset().top+marginTop,ui.helper.css({marginLeft:marginLeft,width:width,height:height,zIndex:999999}),ui.helper.find(".g-productInfo").css({opacity:0}),size={width:48,height:48},clip=function(){var curve,time;return time=200,curve=null,ui.helper.animate({marginLeft:offsetX-size.width*.9,marginTop:offsetY-size.height*.9,width:148,height:size.height},time,curve),image.animate({width:44,height:44},time,curve),setTimeout(function(){if(!itemState)return ui.helper.find(".g-productInfo").animate({opacity:1},time,curve)},time)},itemState=!1,item=function(){var time;return itemState=!0,time=300,image.animate({width:44,height:44},time),ui.helper.find(".g-productInfo").stop(!0).animate({opacity:0},time,function(){}),ui.helper.stop(!0).animate({width:size.width,height:size.height,marginLeft:offsetX-size.width/2,marginTop:offsetY-size.height/2},time)},view.represent(_this.args),ui.args.onDraggedOver=function(el){return el?(clearTimeout(clipTimerId),itemState||item(),ui.helper.addClass("adding")):ui.helper.removeClass("adding")},ui.args.stop=function(event,ui){return view.destruct(),ui.helper.animate({marginLeft:offsetX,marginTop:offsetY,width:10,height:10,opacity:0},100,"linear",function(){return ui.helper.remove()})},clipTimerId=setTimeout(clip,100)}}(this)}),$(document).bind("keydown.-agoraProductPreview",function(_this){return function(e){if(e.which===27)return _this.event("close","esc"),typeof _this.close=="function"&&_this.close(),$(document).unbind("keydown",arguments.callee)}}(this)),this.el.find(".title").click(function(_this){return function(){return _this.event("continueToProduct")}}(this))}return ProductPreviewView.prototype.onRepresent=function(args){return this.createView("ProductPrice",this.el.find(".price")).represent(args),this.product},ProductPreviewView.prototype.updateLayout=function(){var contWidth,width;return contWidth=this.el.find(".stylesWrapper").width(),width=this.el.find(".styles").width(),this.el.find(".styles").css({marginLeft:Math.max(0,(contWidth-width)/2)})},ProductPreviewView.prototype.setStyle=function(style){var i,image,_fn,_i,_len,_ref,_ref1;this.style=style;if(style&&this.images[style]){this.el.find(".pictures").html(""),_ref=this.images[style],_fn=function(_this){return function(i){return _this.el.find(".pictures").append($("<li style=\"background-image:url('"+image.small+"')\" />").click(function(){return _this.event("selectImage","click"),_this.setImage(i)}))}}(this);for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)image=_ref[i],_fn(i);return this.setImage((_ref1=this.imageIndex)!=null?_ref1:0),this.el.find(".styles .active").removeClass("active"),this.el.find('.styles [productstyle="'+style+'"]').addClass("active")}},ProductPreviewView.prototype.image=function(){var _ref,_ref1;return(_ref=this.images)!=null?(_ref1=_ref[this.style])!=null?_ref1[this.imageIndex]:void 0:void 0},ProductPreviewView.prototype.setImage=function(index){return index>=this.images[this.style].length&&(index=this.images[this.style].length-1),this.imageIndex=index,this.el.find(".picture.lowRes").css({backgroundImage:"url('"+this.images[this.style][index].small+"')"}),this.el.find(".picture.mediumRes").css({backgroundImage:"url('"+this.images[this.style][index].medium+"')"}),this.el.find(".picture.hiRes").css({backgroundImage:"url('"+this.images[this.style][index].large+"')"}),this.el.find(".pictures .active").removeClass("active"),this.el.find(".pictures li:nth-child("+(index+1)+")").addClass("active")},ProductPreviewView.prototype.onData=function(data){var imageEl,title,updateImages;return title=this.el.children(".title"),imageEl=this.el.find(".picture"),data.title.get()&&title.find(".title").html(data.title.get()),this.observe(data.title,function(mutation){return title.find(".title").html(mutation.value)}),title.attr({href:data.url}),this.el.find(".picture.hiRes").attr({href:data.url}),this.defaultImage=data.image.get(),data.image.get()&&imageEl.css({backgroundImage:"url('"+data.image.get()+"')"}),this.observe(data.image,function(_this){return function(mutation){return _this.defaultImage=mutation.value,imageEl.css({backgroundImage:"url('"+mutation.value+"')"})}}(this)),data.layout==="basic"?this.el.removeClass("loading"):(updateImages=function(_this){return function(){var images,style,_fn,_ref;_this.el.find(".styles").html("");if(data.styleInfo.get()){_this.el.removeClass("loading"),_this.images=data.styleInfo.get().images;if(_this.images&&!_.isEmpty(_this.images)){_this.el.removeClass("singlePicture"),_ref=_this.images,_fn=function(style){return _this.el.find(".styles").append($("<li productstyle='"+style+"' style=\"background-image:url('"+images[0].small+"')\" />").click(function(){return _this.event("selectStyle"),_this.setStyle(style)}))};for(style in _ref)images=_ref[style],_fn(style)}else _this.el.addClass("singlePicture");return _this.updateLayout(),_this.setStyle(data.styleInfo.get().currentStyle),util.scrollbar(_this.el.find(".stylesWrapper")),util.scrollbar(_this.el.find(".pictures"))}}}(this),updateImages(),data.styleInfo.observe(updateImages))},ProductPreviewView.prototype.shown=function(){return this.event("open")},ProductPreviewView.prototype.destruct=function(){return ProductPreviewView.__super__.destruct.apply(this,arguments),$(document).unbind(".-agoraProductPreview")},ProductPreviewView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ReviewsView",[],function(){return{d:["View","Frame"],c:function(){var ReviewsView;return ReviewsView=function(_super){__extends(ReviewsView,_super),ReviewsView.prototype.type="Reviews";function ReviewsView(contentScript){this.contentScript=contentScript,ReviewsView.__super__.constructor.call(this,this.contentScript),this.el=$('<div class="-agora v-reviews"> <div class="cont"> Loading reviews... </div> </div>'),util.trapScrolling(this.el.find(".cont"))}return ReviewsView.prototype.onData=function(data){return this.withData(data,function(_this){return function(data){var contEl,el,review,text,_i,_len,_ref,_ref1;contEl=_this.el.find(".cont"),contEl.html("");if(data.reviews.length||data.reviews.url){_ref=data.reviews;for(_i=0,_len=_ref.length;_i<_len;_i++)review=_ref[_i],el=$("<div class='review'> <a class='title' target='_blank' href='"+review.url+"'> <span class='rating rating"+review.rating+"'> <span /> <span /> <span /> <span /> <span /> </span> "+review.title+"</a> <div class='review'>"+review.review+"</div> <a href='"+review.url+"' target='_blank' class='readMore'>Read more</a> </div>"),el.find(".title").click(function(){return _this.event("goToReview")}),contEl.append(el);data.url&&(text=function(){if(data.count===void 0)return"Read all reviews";switch(data.count){case 0:return"No reviews";case 1:return"Read one review";default:return"Read all "+data.count+" reviews"}}(),contEl.append("<a class='allReviews' target='_blank' href='"+((_ref1=data.url)!=null?_ref1:"#")+"'>"+text+"</a>"),contEl.find(".allReviews").click(function(){return _this.event("goToAllReviews")}))}else contEl.html("No reviews");return typeof _this.sizeChanged=="function"?_this.sizeChanged():void 0}}(this))},ReviewsView.prototype.shown=function(){return this.event("open")},ReviewsView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/SharedWithYouView",[],function(){return{d:["View","util","icons"],c:function(){var SharedWithYouView;return SharedWithYouView=function(_super){__extends(SharedWithYouView,_super),SharedWithYouView.prototype.type="SharedWithYou";function SharedWithYouView(){SharedWithYouView.__super__.constructor.apply(this,arguments),this.viewEl('<div class="v-sharedWithYou t-dialog"> <h2>Shared With You</h2> <div class="content"> <ul class="objects"> <li class="object"> <span class="title" /> <span class="user" /> <input type="checkbox" class="inBelt" /> </li> </ul> </div> </div>')}return SharedWithYouView.prototype.onData=function(data){return this.listInterface(this.el.find(".objects"),".object",function(_this){return function(el,data,pos,onRemove){var view;return view=_this.createView(),onRemove(function(){return view.destruct()}),el.addClass(data.type),el.find(".user").html(data.userName),view.valueInterface(el.find(".title")).setDataSource(data.title),el.click(function(){return _this.callBackgroundMethod("click",[data.id])}),util.tooltip(el.find(".inBelt"),"show on belt"),el.find(".inBelt").click(function(e){return e.stopPropagation()}).change(function(){return _this.callBackgroundMethod("inBelt",[data.id,el.find(".inBelt").prop("checked")])}),view.withData(data.inBelt,function(inBelt){return el.find(".inBelt").prop("checked",inBelt)}),data.seen.get()&&el.addClass("seen"),el}}(this)).setDataSource(data.entries),this.callBackgroundMethod("seen")},SharedWithYouView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShareView",[],function(){return{d:["View","util","icons"],c:function(){var ShareView;return ShareView=function(_super){__extends(ShareView,_super),ShareView.prototype.type="Share";function ShareView(){var addEl,shareTitleEl,submit;ShareView.__super__.constructor.apply(this,arguments),this.viewEl('<div class="v-share t-dialog"> <h2>Invite Collaborators</h2> <div class="content"> <input type="text" class="title" placeholder="Title"> <textarea class="message" placeholder="Message"></textarea> <input type="text" class="add" placeholder="Add"> <input type="button" value="invite"> </div> </div>'),submit=function(_this){return function(){return _this.callBackgroundMethod("add",[shareTitleEl.val(),_this.el.find(".message").val(),addEl.val()]),addEl.val(""),_this.el.addClass("success"),setTimeout(function(){return typeof _this.close=="function"?_this.close():void 0},1500)}}(this),addEl=this.el.find(".add"),this.el.find("[type=button]").click(submit),addEl.keyup(function(_this){return function(e){if(e.keyCode===13)return submit()}}(this)),shareTitleEl=this.el.find(".title"),shareTitleEl.keyup(function(_this){return function(e){if(e.keyCode===13)return _this.callBackgroundMethod("update",[shareTitleEl.val(),_this.el.find(".message").val()]),typeof _this.close=="function"?_this.close():void 0}}(this))}return ShareView.prototype.onData=function(data){return this.el.find(".title").val(data.title),this.el.find(".message").val(data.message),this.withData(data.entries,function(_this){return function(entries){var entry,_i,_len,_results;_this.el.find(".users").html(""),_results=[];for(_i=0,_len=entries.length;_i<_len;_i++)entry=entries[_i],_results.push(function(entry){var el;return el=$("<li><span class='user'>"+entry.with_user_name+"</span> <a href='#' class='delete' /></li>"),_this.el.find(".users").append(el),el.find(".delete").click(function(){return _this.callBackgroundMethod("delete",[entry.id]),!1})}(entry));return _results}}(this))},ShareView}(View)}}}),define("client/views/ShoppingBarView/BarItem",[],function(){return{d:["util"],c:function(){var BarItem;return BarItem=function(){function BarItem(view,args){this.view=view,this.args=args!=null?args:{},this.el=view.el,this.elementType=view.elementType}return BarItem.prototype.supportsCreateBundle=function(){return!0},BarItem.prototype.callBackgroundMethod=function(name,args){return this.view.callBackgroundMethod(name,args)},BarItem.prototype.observeObject=function(obj,observer){return this.view.view.observeObject(obj,observer)},BarItem.prototype.widthChanged=function(){var _base;return typeof (_base=this.view.parent).childWidthChanged=="function"?_base.childWidthChanged(this.view):void 0},BarItem.prototype.width=function(){var width;return width=0,this.creatingBundle&&(width+=58),width},BarItem.prototype.init=function(data){var draggingData,orgDraggingData,_ref,_ref1;return this.el.html(this.html),this.el.addClass(this.elementType.toLowerCase()),this.onData(data.barItemData,data),draggingData=null,"draggingData"in this.args?this.args.draggingData&&(draggingData=(_ref=typeof this.draggingData==="function"?this.draggingData():void 0)!=null?_ref:{},_.extend(draggingData,this.args.draggingData),util.initDragging(this.el,draggingData)):draggingData=(_ref1=typeof this.draggingData==="function"?this.draggingData():void 0)!=null?_ref1:{},orgDraggingData=_.clone(draggingData),_.extend(draggingData,{context:"shoppingBar",type:this.elementType,start:function(_this){return function(e,opts){_this.el.addClass("dragging"),_this.view.shoppingBarView.startDrag();if(orgDraggingData.start)return orgDraggingData.start.apply(_this,arguments)}}(this),stop:function(_this){return function(){_this.el.removeClass("dragging"),_this.view.shoppingBarView.stopDrag();if(orgDraggingData.stop)return orgDraggingData.stop.apply(_this,arguments)}}(this),onDroppedOn:function(_this){return function(el,fromEl,dropAction){return _this.view.shoppingBarView.onDroppedOn(el,fromEl,_this.el,dropAction),el.remove(),orgDraggingData.onDroppedOn?orgDraggingData.onDroppedOn.apply(_this,arguments):!1}}(this),onGlobal:function(_this){return function(){return _this.view.noDestruct=!0,_this.view.separate()}}(this),onDropped:function(_this){return function(receivingEl){delete _this.view.noDestruct;if(!receivingEl)return _this.callBackgroundMethod("delete"),_this.view.destruct()}}(this),onDraggedOver:function(_this){return function(el){el?(_this.el.addClass("adding"),_this.el.removeClass("removing")):(_this.el.removeClass("adding"),_this.el.addClass("removing"));if(orgDraggingData.onDraggedOver)return orgDraggingData.onDraggedOver.apply(_this,arguments)}}(this),onHoldOver:function(_this){return function(el){if(el.data("dragging").action==="addData")return;_this.supportsCreateBundle()&&(_this.creatingBundle||(_this.el.addClass("createBundle"),_this.creatingBundle=!0,_this.el.append('<span class="bundleDrop addDrop" breaksimmutability="true" />'),_this.el.append('<span class="fakeGrip" />'),util.initDragging(_this.el.children(".bundleDrop"),{enabled:!1,onDroppedOn:function(el,fromEl){return _this.view.shoppingBarView.onDroppedOn(el,fromEl,_this.el,"createBundle"),el.remove(),!1}}),_this.widthChanged()));if(orgDraggingData.onHoldOver)return orgDraggingData.onHoldOver.apply(_this,arguments)}}(this),onDragOut:function(_this){return function(){_this.creatingBundle&&(_this.el.removeClass("createBundle"),_this.el.children(".bundleDrop").remove(),_this.el.children(".fakeGrip").remove(),_this.creatingBundle=!1,_this.widthChanged());if(orgDraggingData.onDragOut)return orgDraggingData.onDragOut.apply(_this,arguments)}}(this)}),util.initDragging(this.el,draggingData)},BarItem.prototype.destruct=function(){return this.el.unbind(),this.el.removeClass(this.elementType.toLowerCase()),this.el.html(""),util.terminateDragging(this.el)},BarItem.prototype.path=function(){return this.view.path()},BarItem}()}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/BarItemView",[],function(){return{d:["View","util","views/ProductPopupView","views/ShoppingBarView/ListBarItem","views/ShoppingBarView/SessionBarItem","views/ShoppingBarView/DecisionBarItem","views/ShoppingBarView/BundleBarItem","views/ShoppingBarView/ProductBarItem","views/ShoppingBarView/CompositeSlotBarItem","views/ShoppingBarView/CompositeBarItem","views/ShoppingBarView/PlaceholderBarItem","views/ShoppingBarView/SharedBeltBarItem","views/ShoppingBarView/BeltBarItem","views/ShoppingBarView/UnauthorizedBarItem"],c:function(){var BarItemView;return BarItemView=function(_super){__extends(BarItemView,_super),BarItemView.prototype.type="ShoppingBarView/BarItem";function BarItemView(contentScript,shoppingBarView,opts){var popupView;this.shoppingBarView=shoppingBarView,this.opts=opts!=null?opts:{},BarItemView.__super__.constructor.apply(this,arguments),this.el=this.viewEl('<div class="element t-item barItem"></div>'),popupView=null,this.selectMode=this.opts.selectMode}return BarItemView.prototype.childrenCount=function(){var _ref;return(_ref=this.barItem)!=null?typeof _ref.childrenCount=="function"?_ref.childrenCount():void 0:void 0},BarItemView.prototype.width=function(){var _ref,_ref1;return(_ref=(_ref1=this.barItem)!=null?typeof _ref1.width==="function"?_ref1.width():void 0:void 0)!=null?_ref:48},BarItemView.prototype.updateLayout=function(){var _ref;return(_ref=this.barItem)!=null?typeof _ref.updateLayout=="function"?_ref.updateLayout():void 0:void 0},BarItemView.prototype.processChild=function(view){var _base,_ref;return(_ref=this.barItem)!=null&&typeof _ref.processChild=="function"&&_ref.processChild(view.barItem),typeof (_base=this.parent).processChild=="function"?_base.processChild(view):void 0},BarItemView.prototype.childWidthChanged=function(view){var _base;return this.updateLayout(),typeof (_base=this.parent).childWidthChanged=="function"?_base.childWidthChanged(this):void 0},BarItemView.prototype.enableSelection=function(force){force==null&&(force=!1);if(!this.selectMode||!!force)return this.selectMode=!0,this.el.addClass("selectMode"),this.el.append($('<input type="checkbox" class="select">').click(function(_this){return function(e){return e.stopPropagation(),_this.selected=!_this.selected,!0}}(this)))},BarItemView.prototype.disableSelection=function(){if(this.selectMode)return delete this.selectMode,delete this.selected,this.el.find(".select").remove(),this.el.removeClass("selectMode")},BarItemView.prototype.update=function(data){var el,_base,_ref;this.barItem&&(this.clearViews(),this.barItem.destruct(),typeof (_base=this.parent).destructChild=="function"&&_base.destructChild(this)),this.el.mouseenter(function(_this){return function(){if(!_this.selectMode&&util.isMutable(_this.el))return _this.shoppingBarView.mouseEnteredBarItemView(_this)}}(this)).mouseleave(function(_this){return function(){if(!_this.selectMode&&util.isMutable(_this.el))return _this.shoppingBarView.mouseLeftBarItemView(_this)}}(this)),this.view=this.createView();if(data){data.type?this.elementType=data.type:this.elementType="Placeholder";if(!__classes[""+this.elementType+"BarItem"])throw"bar item close not present "+this.elementType;this.barItem=new __classes[""+this.elementType+"BarItem"](this,this.opts.barItemArgs),this.barItem.init(data),(_ref=this.parent)!=null&&typeof _ref.processChild=="function"&&_ref.processChild(this),data.selected&&(this.el.append('<input type="checkbox" class="chosen">'),this.el.find(".chosen").prop("checked",data.selected.get()).click(function(_this){return function(e){return tracking.event("ShoppingBar","toggleChosen"),e.stopPropagation(),_this.callBackgroundMethod("setSelected",[_this.el.find(".chosen").prop("checked")])}}(this)),this.view.observeObject(data.selected,function(_this){return function(){return _this.el.find(".chosen").prop("checked",data.selected.get())}}(this))),data.creator&&(el=$('<span class="userIndicator" />').css("background-color",data.creator.color),util.tooltip(el,function(){return data.creator.name.get()}),this.el.append(el)),typeof this.changedType=="function"&&this.changedType()}if(this.selectMode)return this.enableSelection(!0)},BarItemView.prototype.represent=function(){BarItemView.__super__.represent.apply(this,arguments);if(!this.loadNotify)return this.shoppingBarView.loadBarItem(this),this.loadNotify=!0},BarItemView.prototype.destruct=function(){var _base,_ref;if(!this.noDestruct)return(_ref=this.barItem)!=null&&_ref.destruct(),typeof (_base=this.parent).destructChild=="function"&&_base.destructChild(this),BarItemView.__super__.destruct.apply(this,arguments)},BarItemView.prototype.onData=function(data){return this.data=data,this.update(data.get()),data.observe(function(_this){return function(){return _this.update(data.get())}}(this)),this.shoppingBarView.barItemLoaded(this)},BarItemView.prototype.path=function(){return this.shoppingBarView.path()},BarItemView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/BeltBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame"],c:function(){var BeltBarItem;return BeltBarItem=function(_super){__extends(BeltBarItem,_super);function BeltBarItem(){return BeltBarItem.__super__.constructor.apply(this,arguments)}return BeltBarItem.prototype.html='<span class="preview mosaic"><span class="image" /></span> <span class="icon" /> <span class="count" /> <span class="shareIndicator" />',BeltBarItem.prototype.width=function(){return 48},BeltBarItem.prototype.init=function(){return BeltBarItem.__super__.init.apply(this,arguments),this.el.click(function(_this){return function(){return _this.callBackgroundMethod("click")}}(this))},BeltBarItem.prototype.onData=function(data,barItemData){var popup;return this.data=data,util.initMosaic(this.view,this.el.find(".preview"),".image",data.preview),this.view.withData(data.count,function(_this){return function(count){return count===0?_this.el.addClass("empty"):_this.el.removeClass("empty"),_this.el.find(".count").html(count)}}(this)),this.view.withData(data.shared,function(_this){return function(shared){return shared?_this.el.addClass("shared"):_this.el.removeClass("shared")}}(this)),barItemData.user&&this.el.find(".shareIndicator").css({backgroundColor:barItemData.user.color}),popup=util.popupTrigger2(this.el.find(".shareIndicator"),{delay:300,createPopup:function(_this){return function(cb,close,addEl){var collaborateView,frame;return window.suppressPopups?!1:(collaborateView=_this.view.createView("Collaborate"),_this.view.shoppingBarView.propOpen(collaborateView),collaborateView.addExtension=function(el){return addEl(el)},collaborateView.removeExtension=function(el){},frame=Frame.frameAbove(_this.el.find(".shareIndicator"),collaborateView.el,{type:"balloon",distance:20,onClose:function(){return collaborateView.destruct(),collaborateView=null}}),collaborateView.close=close,collaborateView.sizeChanged=function(){return frame.update()},collaborateView.addEl=addEl,collaborateView.shown(),collaborateView.represent(_this.view.args),cb(frame.el,null))}}(this),onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null?typeof _ref.close=="function"?_ref.close():void 0:void 0}})},BeltBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/BundleBarItem",[],function(){return{d:["View","util","views/ShoppingBarView/ListBarItem"],c:function(){var BundleBarItem;return BundleBarItem=function(_super){__extends(BundleBarItem,_super);function BundleBarItem(){return BundleBarItem.__super__.constructor.apply(this,arguments)}return BundleBarItem.prototype.type="Bundle",BundleBarItem.prototype.html='<span class="grip" />',BundleBarItem.prototype.init=function(){return BundleBarItem.__super__.init.apply(this,arguments),this.el.children(".grip").mouseenter(function(){if($(this).parent().hasClass("hover")&&util.isMutable($(this).parent()))return $(this).addClass("hover")}).mouseleave(function(){if(util.isMutable($(this).parent())&&!$(this).parent().hasClass("dragging"))return $(this).removeClass("hover")})},BundleBarItem}(ListBarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/CompositeBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","util","icons"],c:function(){var CompositeBarItem;return CompositeBarItem=function(_super){__extends(CompositeBarItem,_super);function CompositeBarItem(){return CompositeBarItem.__super__.constructor.apply(this,arguments)}return CompositeBarItem.prototype.width=function(){return CompositeBarItem.__super__.width.apply(this,arguments)+48},CompositeBarItem.prototype.onData=function(data){return this.el.addClass(data.type),icons.setIcon(this.el,data.type),this.el.click(function(_this){return function(){return _this.callBackgroundMethod("click")}}(this)),this.widthChanged()},CompositeBarItem.prototype.destruct=function(){return CompositeBarItem.__super__.destruct.apply(this,arguments),icons.clearIcon(this.el)},CompositeBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/CompositeSlotBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","util","icons"],c:function(){var CompositeSlotBarItem;return CompositeSlotBarItem=function(_super){__extends(CompositeSlotBarItem,_super);function CompositeSlotBarItem(){return CompositeSlotBarItem.__super__.constructor.apply(this,arguments)}return CompositeSlotBarItem.prototype.supportsCreateBundle=function(){return!1},CompositeSlotBarItem.prototype.width=function(){return CompositeSlotBarItem.__super__.width.apply(this,arguments)+(this.elementView?this.elementView.width():48)},CompositeSlotBarItem.prototype.onData=function(data){return this.observeObject(data.elementId,function(_this){return function(mutation){_this.elementView&&(_this.elementView.el.remove(),_this.elementView.detach(),_this.elementView.destruct(),delete _this.elementView);if(data.elementId.get())return _this.elementView=util.getBarItem({type:data.elementType.get(),id:data.elementId.get(),container:{type:"CompositeSlot",id:data.id}},_this.view,_this.view.shoppingBarView),_this.el.append(_this.elementView.el),_this.widthChanged()}}(this)),data.elementId.get()&&(this.elementView=util.getBarItem({type:data.elementType.get(),id:data.elementId.get(),container:{type:"CompositeSlot",id:data.id}},this.view,this.view.shoppingBarView),this.el.append(this.elementView.el)),this.el.addClass(data.type),icons.setIcon(this.el,data.type),this.widthChanged()},CompositeSlotBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/DecisionBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","util"],c:function(){var DecisionBarItem;return DecisionBarItem=function(_super){__extends(DecisionBarItem,_super);function DecisionBarItem(){return DecisionBarItem.__super__.constructor.apply(this,arguments)}return DecisionBarItem.prototype.html='<span class="preview"><span class="image" /><span class="icon" /></span> <span class="count" /> <span class="popupTrigger" /> <span class="shareIndicator" />',DecisionBarItem.prototype.draggingData=function(){return{immutableContents:!0,enabled:!0}},DecisionBarItem.prototype.onData=function(data,barItemData){var popup,updateForListSize;return this.listItem=new ListBarItem(this.view,!0),this.listItem.setup({state:"expanded",contents:data.selection}),this.view.withData(data.shared,function(_this){return function(shared){return shared?_this.el.addClass("shared"):_this.el.removeClass("shared")}}(this)),util.initMosaic(this.view,this.el.find(".preview"),".image",data.preview),function(_this){return function(){var updateIcon;return updateIcon=function(){var _ref;return icons.setIcon(_this.el.find(".preview .icon"),(_ref=data.icon.get())!=null?_ref:"list",{size:"small",itemClass:!1})},data.icon.observe(function(){return updateIcon()}),updateIcon()}}(this)(),updateForListSize=function(_this){return function(){return data.listSize.get()===0?_this.el.addClass("emptyList"):_this.el.removeClass("emptyList"),_this.el.find(".count").html(data.listSize.get())}}(this),data.listSize.observe(updateForListSize),updateForListSize(),this.el.find(".count").click(function(_this){return function(e){return _this.callBackgroundMethod("click"),e.stopPropagation()}}(this)),util.decisionPreview({anchorEl:function(_this){return function(){return data.selection.length()?_this.el.find(".count"):_this.el.find(".popupTrigger")}}(this),view:this.view,selection:data.selection,descriptor:data.descriptor,icon:data.icon,preview:data.preview,el:this.el}),this.el.click(function(_this){return function(){if(_this.el.hasClass("empty"))return _this.callBackgroundMethod("click")}}(this)),this.el.find(".count .selection").html(data.selectionSize.get()),data.selectionSize.observe(function(_this){return function(){return _this.el.find(".count .selection").html(data.selectionSize.get())}}(this)),barItemData.user&&this.el.find(".shareIndicator").css({backgroundColor:barItemData.user.color}),popup=util.popupTrigger2(this.el.find(".shareIndicator"),{delay:300,createPopup:function(_this){return function(cb,close,addEl){var collaborateView,frame;return window.suppressPopups?!1:(collaborateView=_this.view.createView("Collaborate"),_this.view.shoppingBarView.propOpen(collaborateView),collaborateView.addExtension=function(el){return console.debug("addExtension",el),addEl(el)},collaborateView.removeExtension=function(el){return console.debug("removeExtension",el)},frame=Frame.frameAbove(_this.el.find(".shareIndicator"),collaborateView.el,{type:"balloon",distance:20,onClose:function(){return collaborateView.destruct(),collaborateView=null}}),collaborateView.close=close,collaborateView.sizeChanged=function(){return frame.update()},collaborateView.addEl=addEl,collaborateView.shown(),collaborateView.represent(_this.view.args),cb(frame.el,null))}}(this),onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null?typeof _ref.close=="function"?_ref.close():void 0:void 0}})},DecisionBarItem.prototype.updateLayout=function(){return this.listItem.updateLayout()},DecisionBarItem.prototype.width=function(){return DecisionBarItem.__super__.width.apply(this,arguments)+this.listItem.width()},DecisionBarItem.prototype.destruct=function(){return DecisionBarItem.__super__.destruct.apply(this,arguments),this.listItem.destruct()},DecisionBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/ListBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","util"],c:function(){var ListBarItem;return ListBarItem=function(_super){__extends(ListBarItem,_super),ListBarItem.prototype.html="",ListBarItem.prototype.supportsCreateBundle=function(){return!1},ListBarItem.prototype.draggingData=function(){return{type:this.type,immutableContents:this.args.readOnly,onRippedOut:function(_this){return function(el){}}(this),onReorder:function(_this){return function(el,startIndex,endIndex){return tracking.event("ShoppingBar","reorder"),_this.callBackgroundMethod("reorder",[startIndex,endIndex])}}(this),onDragOver:function(_this){return function(){if(_this.state==="expanded"&&!_this.args.readOnly&&!_this.expanded)return _this.startedDrag=!0,_this.expand()}}(this),onDragOut:function(_this){return function(){if(_this.expanded)return _this.view.shoppingBarView.queueShrink(_this)}}(this)}};function ListBarItem(){ListBarItem.__super__.constructor.apply(this,arguments),this.args.readOnly||(this.startEdit=function(_this){return function(){return _this.expand()}}(this),this.stopEdit=function(_this){return function(){return _this.shrink()}}(this),this.view.shoppingBarView.addEditListener(this)),this.el.addClass("list")}return ListBarItem.prototype.childrenCount=function(){return this.el.children(".element").length},ListBarItem.prototype.items=function(){return this.el.children(".element")},ListBarItem.prototype.width=function(){var width;return ListBarItem.__super__.width.apply(this,arguments)+function(){if(!this.view.data)return 0;switch(this.state){case"expanded":return width=0,this.el.children(".element").each(function(){return width+=$(this).data("view").width()}),width=Math.max(0,width+(this.childrenCount()-1)*this.view.shoppingBarView.itemSpacing),width?(this.expanded&&(width+=58),width):48;case"collapsed":return 48}}.call(this)},ListBarItem.prototype.updateLayout=function(){var animateSpeed,itemSpacing,width,x,_ref;switch(this.state){case"expanded":x=0,_ref=this.view.shoppingBarView,itemSpacing=_ref.itemSpacing,animateSpeed=_ref.animateSpeed,this.el.children(".element").each(function(){return $(this).css({left:x}),x+=$(this).data("view").width()+itemSpacing}),width=Math.max(0,x-itemSpacing),this._width=width?width:48,width===0?(this.empty=!0,this.el.addClass("empty"),typeof this.onEmpty=="function"&&this.onEmpty()):(this.empty=!1,this.el.removeClass("empty"),typeof this.onNotEmpty=="function"&&this.onNotEmpty());break;case"collapsed":this._width=48}return this.el.css("width",this._width)},ListBarItem.prototype.shrink=function(){if(this.expanded)return this.expanded=!1,this.updateLayout(),this.widthChanged(),this.addDrop.remove(),this.el.removeClass("hasAddDrop")},ListBarItem.prototype.expand=function(){var el;if(!this.expanded)return this.expanded=!0,this.updateLayout(),this.widthChanged(),this.el.addClass("hasAddDrop"),el=$('<a href="#" class="addDrop"></a>').click(function(_this){return function(e){var dialogEl;return dialogEl=Frame.wrapInFrame('<a href="#" class="computer">Add Computer</a>'),dialogEl.find(".computer").click(function(){return _this.callBackgroundMethod("add",["computer"]),Frame.close(dialogEl),!1}),dialogEl.appendTo(document.body),Frame.fixFrameAboveAndCentered(el,dialogEl),e.stopPropagation(),!1}}(this)),util.initDragging(el,{enabled:!1,acceptsDrop:!1,onDragOver:function(_this){return function(){return _this.view.shoppingBarView.stopShrink()}}(this)}),this.addDrop=el,this.el.append(el)},ListBarItem.prototype.setup=function(data){var classesForLength,contents,prevLength,updateForLength,_base;return this.contentsView=this.view.view.createView(),this.state=data.state,this.el.addClass(this.state),this.state==="expanded"?(this.el.data("spacing",this.view.shoppingBarView.itemSpacing),this.el.append($('<div class="element" />')),contents=this.contentsView.listInterface(this.el,".element",function(_this){return function(el,data,pos,onRemove){var view;return view=util.getBarItem(data,_this.view,_this.view.shoppingBarView),_this.contentsView.trackView(view),onRemove(function(){return view.destruct()}),view.el}}(this)),contents.setDataSource(data.contents),contents.onInsert=function(_this){return function(){return _this.widthChanged(),_this.view.updateLayout()}}(this),contents.onDelete=function(_this){return function(el,del){return del(),_this.widthChanged(),_this.view.updateLayout()}}(this),contents.onMove=function(_this){return function(){return _this.view.updateLayout()}}(this)):this.state==="collapsed"&&(this.el.bind("click.list",function(_this){return function(){return _this.view.callBackgroundMethod("click")}}(this)),this.el.append($('<span class="image" />')),contents=this.view.view.listInterface(this.view.el,".image",function(_this){return function(el,data,pos,onRemove){return el.css("background-image","url("+data+")")}}(this)),contents.setDataSource(data.contents),prevLength=contents.length(),classesForLength={0:"empty",1:"oneItem",2:"twoItems",3:"threeItems",4:"fourItems"},updateForLength=function(_this){return function(){return _this.el.removeClass(classesForLength[prevLength]),_this.el.addClass(classesForLength[prevLength=contents.length()])}}(this),contents.onLengthChanged=updateForLength,updateForLength()),this.view.updateLayout(),typeof (_base=this.view.parent).childWidthChanged=="function"?_base.childWidthChanged(this):void 0},ListBarItem.prototype.onData=function(data){return this.setup(data.state.get()),this.observeObject(data.state,function(_this){return function(){return _this.clearState(),_this.setup(data.state.get())}}(this))},ListBarItem.prototype.clearState=function(){this.el.removeClass(this.state),this.contentsView.destruct();switch(this.state){case"collapsed":return this.el.find(".image").remove();case"expanded":return this.el.unbind(".list"),this.el.children(".element").remove()}},ListBarItem.prototype.destruct=function(){ListBarItem.__super__.destruct.apply(this,arguments),this.clearState();if(!this.args.readOnly)return this.view.shoppingBarView.removeEditListener(this)},ListBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/PlaceholderBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame","icons"],c:function(){var PlaceholderBarItem;return PlaceholderBarItem=function(_super){__extends(PlaceholderBarItem,_super);function PlaceholderBarItem(){return PlaceholderBarItem.__super__.constructor.apply(this,arguments)}return PlaceholderBarItem.prototype.width=function(){return PlaceholderBarItem.__super__.width.apply(this,arguments)+48},PlaceholderBarItem.prototype.onData=function(barItemData,data){return util.tooltip(this.el,data.descriptor.descriptor),this.widthChanged(),icons.setIcon(this.el,data.icon)},PlaceholderBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/ProductBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame"],c:function(){var ProductBarItem;return ProductBarItem=function(_super){__extends(ProductBarItem,_super);function ProductBarItem(){return ProductBarItem.__super__.constructor.apply(this,arguments)}return ProductBarItem.prototype.html='<span class="image" /><a />',ProductBarItem.prototype.width=function(){return ProductBarItem.__super__.width.apply(this,arguments)+48},ProductBarItem.prototype.init=function(){var popup;return ProductBarItem.__super__.init.apply(this,arguments),popup=util.popupTrigger2(this.el,{delay:300,createPopup:function(_this){return function(cb,close,addEl){var productPopupView;return _this.view.shoppingBarView.disableProductPopups||window.suppressPopups?!1:(productPopupView=_this.view.createView("ProductPopupView",{unconstrainedPictureHeight:!0}),_this.view.shoppingBarView.propOpen(productPopupView),productPopupView.barItem=_this,tracking.page(""+_this.path()+"/"+productPopupView.pathElement()),productPopupView.represent(_this.view.args,function(){var frame;return frame=Frame.frameAbove(_this.el,productPopupView.el,{type:"balloon",distance:20,onClose:function(){return productPopupView.destruct(),productPopupView=null}}),productPopupView.close=close,productPopupView.sizeChanged=function(){return frame.update()},productPopupView.addEl=addEl,productPopupView.shown(),cb(frame.el)}),null)}}(this),onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null?typeof _ref.close=="function"?_ref.close():void 0:void 0}}),this.el.mousedown(function(){return popup.close()})},ProductBarItem.prototype.onData=function(data,barItemViewData){var lastEmotion,updateForLastFeeling;return this.data=data,this.barItemViewData=barItemViewData,this.view.withData(data.image,function(_this){return function(image){return image?_this.el.find(".image").removeClass("loading").css({backgroundImage:"url('"+image+"')"}):_this.el.find(".image").addClass("loading").css({backgroundImage:"none"})}}(this)),this.view.withData(this.data.purchased,function(_this){return function(purchased){return purchased?_this.el.addClass("purchased"):_this.el.removeClass("purchased")}}(this)),this.el.css("cursor","pointer"),this.el.find("a").mousedown(function(){return $(this).attr("href",data.url)}),this.el.find("a").mouseup(function(){return setTimeout(function(_this){return function(){return $(_this).removeAttr("href")}}(this),500)}),this.el.find("a").mouseout(function(){return $(this).removeAttr("href")}),this.el.html(data.productSid),this.el.click(function(_this){return function(){return _this.callBackgroundMethod("click")}}(this)),this.el.append('<span class="feelingBadge noText"><span class="icon" /><span class="text"></span></span>'),lastEmotion=null,updateForLastFeeling=function(_this){return function(){var emotionClass;return lastEmotion&&_this.el.find(".feelingBadge").removeClass(lastEmotion),data.lastFeeling.get()?(_this.el.find(".feelingBadge").show(),_this.el.find(".feelingBadge .text").html(data.lastFeeling.get().thought),emotionClass=util.emotionClass(data.lastFeeling.get().positive,data.lastFeeling.get().negative),_this.el.find(".feelingBadge").addClass(emotionClass),lastEmotion=emotionClass):_this.el.find(".feelingBadge").hide()}}(this),data.lastFeeling.observe(updateForLastFeeling),updateForLastFeeling(),this.view.withData(data.status,function(_this){return function(status){return status===2?_this.el.addClass("error"):_this.el.removeClass("error")}}(this)),this.widthChanged()},ProductBarItem.prototype.destruct=function(){return ProductBarItem.__super__.destruct.apply(this,arguments),util.clearPopupTrigger(this.el),this.el.css("backgroundImage",""),this.el.css("cursor","")},ProductBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/SessionBarItem",[],function(){return{d:["View","util","views/ShoppingBarView/ListBarItem"],c:function(){var SessionBarItem;return SessionBarItem=function(_super){__extends(SessionBarItem,_super);function SessionBarItem(){return SessionBarItem.__super__.constructor.apply(this,arguments)}return SessionBarItem.prototype.type="Session",SessionBarItem.prototype.html='<div class="title"><span>Session</span> <div class="toggle"></div></div>',SessionBarItem.prototype.init=function(){var dialogOpened;return SessionBarItem.__super__.init.apply(this,arguments),dialogOpened=!1,this.el.children(".title").dblclick(function(_this){return function(){var close,frame,popupEl;if(dialogOpened)return;return popupEl=$("<form class='t-dialog renameSession'> <h2>Rename session</h2> <div class='content'> <input type='text' name='title' value='"+_this.data.title.get()+"'> <input type='button' class='button cancel' value='cancel'> <input type='submit' class='button' value='confirm'> </div> </form>"),close=function(){return dialogOpened=!1,frame.close()},popupEl.find(".cancel").click(close),popupEl.submit(function(){return _this.view.callBackgroundMethod("setTitle",popupEl.get(0).title.value),close(),!1}),frame=Frame.frameAbove(_this.el.children(".title"),popupEl,{type:"balloon",close:function(){return dialogOpened=!1}}),frame.el.css({marginTop:-8}),popupEl.get(0).title.focus(),popupEl.get(0).title.select(),dialogOpened=!0}}(this))},SessionBarItem.prototype.onData=function(data){return this.data=data,SessionBarItem.__super__.onData.apply(this,arguments),this.el.removeClass("t-item"),this.el.find(".title .toggle").click(function(_this){return function(){return _this.callBackgroundMethod("toggle"),!1}}(this)),this.view.valueInterface(this.el.find(".title span")).setDataSource(data.title),util.tooltip(this.el.find(".title .toggle"),function(_this){return function(){return _this.el.hasClass("expanded")?"collapse session":"expand session"}}(this),{distance:15})},SessionBarItem.prototype.updateLayout=function(){return SessionBarItem.__super__.updateLayout.apply(this,arguments),this._width<66?this.el.children(".title").css({minWidth:this._width}):this.el.children(".title").css({minWidth:""})},SessionBarItem}(ListBarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/SharedBeltBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame"],c:function(){var SharedBeltBarItem;return SharedBeltBarItem=function(_super){__extends(SharedBeltBarItem,_super);function SharedBeltBarItem(){return SharedBeltBarItem.__super__.constructor.apply(this,arguments)}return SharedBeltBarItem.prototype.html='<span class="preview mosaic"><span class="image" /></span><span class="shareIndicator" />',SharedBeltBarItem.prototype.width=function(){return 48},SharedBeltBarItem.prototype.init=function(){return SharedBeltBarItem.__super__.init.apply(this,arguments),this.el.click(function(_this){return function(){return _this.callBackgroundMethod("click")}}(this)),this.el.addClass("shared")},SharedBeltBarItem.prototype.destruct=function(){return SharedBeltBarItem.__super__.destruct.apply(this,arguments),this.el.removeClass("shared")},SharedBeltBarItem.prototype.onData=function(data,barItemData){var popup;return this.data=data,util.initMosaic(this.view,this.el.find(".preview"),".image",data.preview),barItemData.user&&this.el.find(".shareIndicator").css({backgroundColor:barItemData.user.color}),popup=util.popupTrigger2(this.el.find(".shareIndicator"),{delay:300,createPopup:function(_this){return function(cb,close,addEl){var collaborateView,frame;return window.suppressPopups?!1:(collaborateView=_this.view.createView("Collaborate"),_this.view.shoppingBarView.propOpen(collaborateView),collaborateView.addExtension=function(el){return addEl(el)},collaborateView.removeExtension=function(el){},frame=Frame.frameAbove(_this.el.find(".shareIndicator"),collaborateView.el,{type:"balloon",distance:20,onClose:function(){return collaborateView.destruct(),collaborateView=null}}),collaborateView.close=close,collaborateView.sizeChanged=function(){return frame.update()},collaborateView.addEl=addEl,collaborateView.shown(),collaborateView.represent(_this.view.args),cb(frame.el,null))}}(this),onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null?typeof _ref.close=="function"?_ref.close():void 0:void 0}})},SharedBeltBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView/UnauthorizedBarItem",[],function(){return{d:["views/ShoppingBarView/BarItem","views/ProductPopupView","util","Frame","icons"],c:function(){var UnauthorizedBarItem;return UnauthorizedBarItem=function(_super){__extends(UnauthorizedBarItem,_super);function UnauthorizedBarItem(){return UnauthorizedBarItem.__super__.constructor.apply(this,arguments)}return UnauthorizedBarItem.prototype.width=function(){return UnauthorizedBarItem.__super__.width.apply(this,arguments)+48},UnauthorizedBarItem.prototype.onData=function(barItemData,data){return this.data=data,this.el.addClass(data.objectType),this.widthChanged()},UnauthorizedBarItem.prototype.destruct=function(){return UnauthorizedBarItem.__super__.destruct.apply(this,arguments),this.el.removeClass(this.data.objectType)},UnauthorizedBarItem}(BarItem)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/ShoppingBarView",[],function(){return{d:["View","util","util2","views/ShoppingBarView/BarItemView","views/CompetitiveProcessView","views/ReviewsView","views/AddItemView","views/CouponsView","views/AddDescriptorView","views/AddDataView","views/compare/CompareView","views/ContactView","views/ShareView","views/SharedWithYouView","views/CollaborateView","views/ChatView","devAction","views/SocialShareView","views/BuyView"],c:function(){var ShoppingBarView;return ShoppingBarView=function(_super){__extends(ShoppingBarView,_super),ShoppingBarView.prototype.type="ShoppingBar";function ShoppingBarView(contentScript,opts){var bagsbyEl,chatFrame,chatOpen,collaborateFrame,collaborateOpen,collaborateView,contentWrapperEl,menu,updateForErrorState,updateForUserId;this.opts=opts!=null?opts:{},ShoppingBarView.__super__.constructor.apply(this,arguments),this.startTime=(new Date).getTime(),this.el=this.viewEl('<div class="-agora v-shoppingBar style1"> <div class="actions"> <span class="count" /> <a href="#" class="home" /> <a href="#" class="moveUp">Up</a> </div> <div class="contentWrapper"> <div class="content"> <div class="element" /> <!--<div class="add" />--> </div> </div> <a href="http://agora.sh/connect.html" target="_blank" class="signIn">Sign In to Agora</a> <span class="message" /> <span class="errorState">!</span> <div class="right"> <span class="collaborate" /> <span class="bagsby" /> </div> <span class="devAction"><span class="reloadDevAction" /><span class="devAction" /><span class="reloadStyles" /></span> <span class="needsReload">To continue to use Agora, please reload this page. Thank you!</span> </div>'),this.el.find(".devAction .reloadDevAction").click(function(){return devAction.reloadDevAction()}),this.el.find(".devAction .devAction").click(function(){return devAction.devAction()}),this.el.find(".devAction .reloadStyles").click(function(){return reloadStyles()}),this.itemSpacing=7,this.sessionSpacing=7,this.animateSpeed=0,this.pinCount=0,this.editListeners=[],this.el.find(".content").data({view:this,spacing:this.sessionSpacing}),this.el.find(".contentWrapper").data("view",this),util.initDragging(this.el.find(".contentWrapper"),{enabled:!1,root:!0,rootZIndex:1,acceptsDrop:!0,dragArea:!0,contentEl:this.el.find(".content"),onRippedOut:function(_this){return function(){}}(this),onReorder:function(_this){return function(el,startIndex,endIndex){return tracking.event("ShoppingBar","reorder"),_this.callBackgroundMethod("reorder",[startIndex,endIndex])}}(this),onDroppedOn:function(_this){return function(el,fromEl){return _this.onDroppedOn(el,fromEl,_this.el.find(".contentWrapper")),el.remove(),!1}}(this),data:"ShoppingBar"}),util.initDragging(this.el.find(".actions .moveUp"),{enabled:!1,root:!0,acceptsDrop:!0,dragArea:!0,onDroppedOn:function(_this){return function(el,fromEl){return _this.onDroppedOn(el,fromEl,"up")}}(this)}),this.contents=this.listInterface(this.el,".element",function(_this){return function(el,data,pos,onRemove){var view;return view=util.getBarItem(data,_this,_this,_this.selectMode),onRemove(function(){return view.destruct()}),view.el}}(this)),this.contents.onDelete=function(_this){return function(el,del){return del(),_this.updateLayout()}}(this),this.contents.onInsert=function(_this){return function(el){return _this.updateLayout()}}(this),this.contents.onMove=function(_this){return function(){return _this.updateLayout()}}(this),menu=function(_this){return function(anchorEl){return function(){var el,frame,update;return window.suppressShoppingBarMenu?!1:(_this.updateMenu=update=function(){_this.selectMode?(el.html('<div class="group"> <a href="#" class="wrap"><label>wrap</label></a> <a href="#" class="createBundle"><label>bundle</label></a> <a href="#" class="delete"><label>delete</label></a> </div> <div class="group"> <a href="#" class="cancel"><label>cancel select</label></a> </div>'),_this.atRoot?(el.find(".group:first").prepend('<a href="#" class="createSession"><label>create session</label></a>'),el.find(".createSession").click(function(){return _this.wrapSelection("session"),!1})):(el.find(".group:first").prepend('<a href="#" class="extract"><label>extract</label></a> <a href="#" class="split"><label>split</label></a>'),el.find(".extract").click(function(){return _this.extractSelection(),!1}),el.find(".split").click(function(){return _this.splitSelection(),!1})),el.find(".cancel").click(function(){return _this.event("cancelSelect"),_this.unpinMenu(),_this.disableSelection(),update(),frame.update(),!1}),el.find(".createBundle").click(function(){return _this.wrapSelection("bundle"),!1}),el.find(".wrap").click(function(){return _this.wrapSelection("decision"),!1}),el.find(".delete").click(function(){return _this.deleteSelection(),!1})):(el.html('<div class="group"> <a href="#" class="settings"><label>settings</label></a> <a href="#" class="contact"><label>contact</label></a> <a href="#" class="sharedWithYou"><span class="count" /><label>shared with you</label></a> </div> <div class="group actions"> <a href="#" class="collaborate"><label>collaborate</label></a> <a href="#" class="selectMode"><label>selection mode</label></a> </div>'),_this.data.unseenSharedObjectsCount.get()&&el.find(".sharedWithYou .count").addClass("nonzero").html(_this.data.unseenSharedObjectsCount.get()),_this.atRoot&&el.find(".group:first").append('<a href="http://agora.sh/supportedSites.html" target="_blank" class="supportedSites"><label>supported sites</label></a>').append('<a href="http://support.agora.sh/knowledgebase" target="_blank" class="manual"><label>manual</label></a>'),typeof _this.menuInjection=="function"&&_this.menuInjection(el),el.find(".sharedWithYou").click(function(){return tracking.page(""+_this.path()+"/SharedWithYou"),util.showDialog(function(){var view;return view=new SharedWithYouView(_this.contentScript),view.represent(),view}),!1}),el.find(".collaborate").click(function(){return tracking.page(""+_this.path()+"/Share"),util.showDialog(function(){var view;return view=new CollaborateView(_this.contentScript),view.represent(),view}),!1}),el.find(".contact").click(function(){return tracking.page(""+_this.path()+"/Contact"),util.showDialog(function(){var contactView;return contactView=new ContactView(_this.contentScript),contactView.represent(),contactView}),!1}),el.find(".settings").click(function(){return tracking.page(""+_this.path()+"/Settings"),util.showDialog(function(){var settingsView;return settingsView=new SettingsView(_this.contentScript),settingsView.represent(),settingsView}),!1}),el.find(".selectMode").click(function(){return _this.event("select"),_this.enableSelection(),update(),frame.update(),!1}));if(frame)return frame.update()},_this.menuEl=el=$('<div class="shoppingBarMenu"> </div>'),el.mouseenter(function(){return _this._mouseenter()}),el.mouseleave(function(){return _this._mouseleave()}),update(),frame=Frame.frameFixedAbove(anchorEl,el,{type:"balloon"}),frame.el.css({marginTop:-14}),frame.el)}}}(this),this.menus=[],this.menus.push(util.popupTrigger(this.el.find(".home"),{createPopup:menu(this.el.find(".home")),onClose:function(_this){return function(el){return el.data("frame").close(),_this.menuEl=null}}(this)})),this.el.find(".home").hide().click(!1),this.el.find(".moveUp").hide().click(function(_this){return function(){return _this.callBackgroundMethod("up"),!1}}(this)),this.menus.push(util.popupTrigger(this.el.find(".moveUp"),{createPopup:menu(this.el.find(".moveUp")),onClose:function(el){return el.data("frame").close()}})),this.el.find(".addData").click(function(_this){return function(){return util.showDialog(function(){var addDataView;return addDataView=_this.createView("AddData"),addDataView.shoppingBarView=_this,addDataView}),!1}}(this)),this.el.find(".content > .add").hide().click(function(_this){return function(){return util.showDialog(function(){var addItemView;return addItemView=_this.createView("AddDescriptor"),addItemView.represent(),addItemView.shoppingBarView=_this,addItemView})}}(this)),util.tooltip(this.el.find(".content > .add"),"add item",{distance:20}),util.initDragging(this.el.find(".content > .add"),{enabled:!1,dragArea:!0,acceptsDrop:!1}),this.el.find(".collectionsToggle").click(function(_this){return function(){return _this.state==="collections"?_this.callBackgroundMethod("exitCollections"):_this.callBackgroundMethod("enterCollections"),!1}}(this)),util.initDragging(this.el.find(".collectionsToggle"),{enabled:!1,dragArea:!0,holdDelay:200,onDroppedOn:function(_this){return function(el){return util.resolveDraggingData(el,function(data){return _this.callBackgroundMethod("addCollection",[data]),el.remove()})}}(this),onHoldOver:function(_this){return function(el){var onDropped;if(_this.state!=="collections")return onDropped=el.data("dragging").onDropped,el.data("dragging").onDropped=function(receivingEl){return setTimeout(function(){return _this.callBackgroundMethod("exitCollections")},500),typeof onDropped=="function"?onDropped(receivingEl):void 0},_this.callBackgroundMethod("enterCollections")}}(this)}),contentWrapperEl=this.el.find(".contentWrapper"),this.updateContentWrapperWidth=function(_this){return function(){var nextEl,prevEl,right,x;return x=10,prevEl=contentWrapperEl.prevAll(":visible").first(),prevEl.length&&(x=prevEl.position().left+prevEl.outerWidth(!0)),nextEl=contentWrapperEl.nextAll(":visible").first(),right=0,nextEl.length&&(right=_this.el.width()-nextEl.position().left),contentWrapperEl.css({left:x,width:"",right:right}),_this.state==="collections"&&_this.el.find(".collectionsArrow").css({left:contentWrapperEl.offset().left+contentWrapperEl.width()}),!0}}(this),$(window).resize(this.updateContentWrapperWidth),$(function(_this){return function(){return _this.updateContentWrapperWidth()}}(this)),window.shoppingBarView=this,updateForUserId=function(_this){return function(){return Agora.userId.get()?_this.el.removeClass("signedOut").addClass("signedIn"):_this.el.removeClass("signedIn").addClass("signedOut")}}(this),Agora.userId.observe(updateForUserId),updateForUserId(),this.el.find(".errorState").click(function(_this){return function(){return _this.contentScript.reloadExtension(),setTimeout(function(){return document.location.reload()},1e3),!1}}(this)),updateForErrorState=function(_this){return function(){return Agora.errorState.get()?(contentWrapperEl.css({right:50}),_this.el.find(".errorState").show(),util.tooltip(_this.el.find(".errorState"),"Error! Click to reload extension (some changes may be lost)")):(contentWrapperEl.css({right:0}),_this.el.find(".errorState").hide())}}(this),Agora.errorState.observe(updateForErrorState),updateForErrorState(),Agora.settings.hideBelt.get()?(this.displayMode="hidden",this.hide()):this.displayMode="always",Agora.settings.hideBelt.observe(function(_this){return function(){return Agora.settings.hideBelt.get()?(_this.displayMode="hidden",_this.pinCount=0,_this.hide()):(_this.shown||_this.show(),_this.displayMode="always")}}(this)),bagsbyEl=this.el.find(".right .bagsby"),this.chatView=this.createView("Chat",bagsbyEl),this.chatView.represent(),chatOpen=!1,chatFrame=null,bagsbyEl.click(function(_this){return function(){var frame;return chatOpen?chatFrame.close():(tracking.page(""+_this.path()+"/Chat"),chatFrame=frame=Frame.frameAbove(bagsbyEl,_this.chatView.el,{type:"balloon",close:!0,onClose:function(){return _this.chatView.onClose(),_this.chatView.el.detach(),chatOpen=!1,delete _this.chatView.sizeChanged}}),frame.el.css({marginLeft:-9,marginTop:-24}),_this.chatView.onDisplay(),chatOpen=!0,_this.chatView.close=function(){return frame.close()},_this.chatView.sizeChanged=function(){return frame.update()})}}(this)),collaborateFrame=null,collaborateOpen=!1,collaborateView=this.collaborateView=this.createView("Collaborate"),this.el.find(".right .collaborate").click(function(_this){return function(){var frame;return collaborateOpen?collaborateFrame.close():(tracking.page(""+_this.path()+"/Collaborate"),collaborateFrame=frame=Frame.frameAbove(_this.el.find(".right .collaborate"),collaborateView.el,{type:"balloon",close:!0,onClose:function(){return collaborateView.onClose(),collaborateView.el.detach(),collaborateOpen=!1,delete collaborateView.sizeChanged}}),frame.el.css({marginLeft:-9,marginTop:-24}),collaborateView.onDisplay(),collaborateOpen=!0,collaborateView.close=function(){return frame.close()},collaborateView.sizeChanged=function(){return frame.update()})}}(this))}return ShoppingBarView.prototype.closeMenu=function(){var close,_i,_len,_ref,_results;_ref=this.menus,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)close=_ref[_i].close,_results.push(close());return _results},ShoppingBarView.prototype.pinMenu=function(){var pin,_i,_len,_ref,_results;_ref=this.menus,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)pin=_ref[_i].pin,_results.push(pin());return _results},ShoppingBarView.prototype.unpinMenu=function(){var unpin,_i,_len,_ref,_results;_ref=this.menus,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)unpin=_ref[_i].unpin,_results.push(unpin());return _results},ShoppingBarView.prototype.shrinkQueue=[],ShoppingBarView.prototype.queueShrink=function(listBarItem){return this.shrinkQueue.push(listBarItem),this.stopShrink(),this.resumeShrink()},ShoppingBarView.prototype.stopShrink=function(){return clearTimeout(this.shrinkTimerId)},ShoppingBarView.prototype.resumeShrink=function(){return this.shrinkTimerId=setTimeout(function(_this){return function(){var listBarItem,_i,_len,_ref;_ref=_this.shrinkQueue;for(_i=0,_len=_ref.length;_i<_len;_i++)listBarItem=_ref[_i],listBarItem.state==="expanded"&&!listBarItem.args.readOnly&&listBarItem.startedDrag&&(listBarItem.startedDrag=!1,listBarItem.shrink());return _this.shrinkQueue=[]}}(this),50)},ShoppingBarView.prototype.barItemLoadCount=0,ShoppingBarView.prototype.loadBarItem=function(barItem){return++this.barItemLoadCount},ShoppingBarView.prototype.barItemLoaded=function(barItem){--this.barItemLoadCount;if(!this.barItemLoadCount)return this.el.find(".content").animate({opacity:1},100)},ShoppingBarView.prototype.hoverStack=[],ShoppingBarView.prototype.mouseEnteredBarItemView=function(barItemView){var deepest,deepestDepth,depth,item,_i,_j,_len,_len1,_ref,_ref1;barItemView.el.addClass("mouseentered"),_ref=this.hoverStack;for(_i=0,_len=_ref.length;_i<_len;_i++)item=_ref[_i],item.el.removeClass("hover");this.hoverStack.push(barItemView),deepest=deepestDepth=null,_ref1=this.hoverStack;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){item=_ref1[_j],depth=item.el.parents(".element").length;if(deepest===null||depth>deepestDepth)deepestDepth=depth,deepest=item}return deepest.el.addClass("hover")},ShoppingBarView.prototype.mouseLeftBarItemView=function(barItemView){var deepest,deepestDepth,depth,item,_i,_len,_ref;barItemView.el.removeClass("mouseentered"),barItemView.el.removeClass("hover"),$(this.hoverStack).find(".hover").removeClass("hover"),_.pull(this.hoverStack,barItemView),deepest=deepestDepth=null,_ref=this.hoverStack;for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i],depth=item.el.parents(".element").length;if(deepest===null||depth>deepestDepth)deepestDepth=depth,deepest=item}if(deepest)return deepest.el.addClass("hover")},ShoppingBarView.prototype.processChild=function(view){},ShoppingBarView.prototype.destructChild=function(view){},ShoppingBarView.prototype.addEditListener=function(listener){return this.editListeners.push(listener)},ShoppingBarView.prototype.startEdit=function(){var listener,_i,_len,_ref,_results;if(!this.editing){this.editing=!0,_ref=this.editListeners,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)listener=_ref[_i],_results.push(listener.startEdit());return _results}},ShoppingBarView.prototype.stopEdit=function(){var listener,_i,_len,_ref,_results;if(this.editing){this.editing=!1,_ref=this.editListeners,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)listener=_ref[_i],_results.push(listener.stopEdit());return _results}},ShoppingBarView.prototype.removeEditListener=function(listener){var index;index=this.editListeners.indexOf(listener);if(index!==-1)return this.editListeners.splice(index,1)},ShoppingBarView.prototype.pin=function(){!this.pinCount&&this.shown&&clearTimeout(this.hideTimerId),++this.pinCount;if(!this.shown)return this.show()},ShoppingBarView.prototype.unpin=function(){--this.pinCount;if(!this.pinCount&&this.shown)return this.hideTimerId=setTimeout(function(_this){return function(){return _this.hide()}}(this),1e3)},ShoppingBarView.prototype.startDrag=function(){return this.pin()},ShoppingBarView.prototype.stopDrag=function(){return this.unpin()},ShoppingBarView.prototype.hide=function(animate){animate==null&&(animate=!0);if(this.displayMode==="hidden"&&this.shown)return this.el.animate({opacity:0},function(_this){return function(){return _this.el.css({height:10,overflow:"hidden"})}}(this)),this.shown=!1},ShoppingBarView.prototype.show=function(){if(this.displayMode==="hidden"&&!this.shown)return this.el.stop(),this.el.css({height:"",overflow:""}),this.el.animate({opacity:1}),this.shown=!0},ShoppingBarView.prototype.onMouseenter=function(){return this.pin()},ShoppingBarView.prototype.onMouseleave=function(){return this.unpin()},ShoppingBarView.prototype.eachSelectable=function(cb){return this.el.find(".content").children(".element").each(function(){var v,view,_i,_len,_ref,_results;view=$(this).data("view");if(view.elementType==="Session"){_ref=view.views,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)v=_ref[_i],v.barItem?_results.push(cb(v)):_results.push(void 0);return _results}return cb(view)})},ShoppingBarView.prototype.enableSelection=function(){if(!this.selectMode)return this.pinMenu(),this.eachSelectable(function(view){return view.enableSelection()}),this.selectMode=!0},ShoppingBarView.prototype.disableSelection=function(){if(this.selectMode)return this.unpinMenu(),this.eachSelectable(function(view){return view.disableSelection()}),this.selectMode=!1,this.updateMenu()},ShoppingBarView.prototype.selected=function(){var selected;return selected=[],this.eachSelectable(function(view){if(view.selected)return selected.push(view.id)}),selected},ShoppingBarView.prototype.wrapSelection=function(type){return this.event("wrap"),this.callBackgroundMethod("wrap",[type,this.selected()]),this.disableSelection()},ShoppingBarView.prototype.deleteSelection=function(){return this.event("delete"),this.callBackgroundMethod("delete",[this.selected()]),this.disableSelection()},ShoppingBarView.prototype.extractSelection=function(){return this.event("extract"),this.callBackgroundMethod("extract",[this.selected()]),this.disableSelection()},ShoppingBarView.prototype.splitSelection=function(){return this.event("split"),this.callBackgroundMethod("split",[this.selected()]),this.disableSelection()},ShoppingBarView.prototype.updateLayout=function(){var animateSpeed,sessionSpacing,x;return x=0,sessionSpacing=this.el.find(".content").data("spacing"),animateSpeed=this.animateSpeed,this.el.find(".content").children(".element").each(function(){if(!$(this).data("view"))throw new Error("no view");return $(this).css({left:x,right:""}),x+=$(this).data("view").width()+sessionSpacing}),this.el.find(".content > .add").css({left:x,right:""}),this.state!=="collections"&&(x+=this.el.find(".content > .add").width()),this.el.find(".content").width(Math.max(0,x-this.sessionSpacing)),this.direction==="ltr"?this.el.find(".content").css({left:0,right:""}):this.direction==="rtl"&&this.el.find(".content").css({left:"",right:5}),this.animateSpeed=200,this.updateContentWrapperWidth()},ShoppingBarView.prototype.childWidthChanged=function(view){return this.updateLayout()},ShoppingBarView.prototype.onData=function(data){this.collaborateView.represent("ShoppingBar"),data.barContents&&this.withData(data.barContents,function(_this){return function(barContents){return _this.configure(barContents)}}(this)),this.withData(data.updaterStatus,function(_this){return function(updaterStatus,mutation){return mutation&&mutation.oldValue&&_this.el.removeClass(""+mutation.oldValue+"-status"),_this.el.addClass(""+updaterStatus+"-status")}}(this)),this.valueInterface(this.el.children(".message")).setDataSource(data.updaterMessage);if(data.unseenSharedObjectsCount)return this.withData(data.unseenSharedObjectsCount,function(_this){return function(count){return _this.menuEl&&(_this.menuEl.find(".sharedWithYou .count")[count?"addClass":"removeClass"]("nonzero"),_this.menuEl.find(".sharedWithYou .count").html(count)),_this.el.find(".actions .count")[count?"addClass":"removeClass"]("nonzero"),_this.el.find(".actions .count").html(count)}}(this))},ShoppingBarView.prototype.onDroppedOn=function(el,fromEl,toEl,dropAction){return this.lastDroppedOn=toEl,util.resolveDraggingData(el,function(_this){return function(data){var to;return to=toEl!=="up"?{view:toEl.data("view").id}:toEl,fromEl?(_this.event("move"),_this.callBackgroundMethod("move",[data,to,dropAction])):(_this.event("drop"),_this.callBackgroundMethod("drop",[data,to,dropAction]))}}(this))},ShoppingBarView.prototype.configure=function(data){this.disableSelection(),this.hoverStack=[],this.barItemLoadCount=0,this.productAddedPopup&&this.productAddedPopup.close();if(this.state){this.el.removeClass(this.state),delete this.menuInjection;switch(this.state){case"collections":this.el.find(".content > .add").show(),this.el.find(".collectionsArrow").remove(),null}}this.state=data.state;if(this.state){this.el.addClass(this.state);switch(this.state){case"Decision":this.menuInjection=function(_this){return function(el){return el.find(".group.actions").prepend($('<a href="#" class="workspace"><label>workspace</label></a>').click(function(){var compareTileView,frameEl;return compareTileView=new CompareView(_this.contentScript),compareTileView.shoppingBarView=_this,frameEl=Frame.wrapInFrame(compareTileView.el,{type:"fullscreen",scroll:!0,resize:function(width,height){return[width-100,height-100]},close:function(){return compareTileView.destruct()}}),compareTileView.close=function(){return Frame.close(frameEl)},frameEl.appendTo(document.body),Frame.show(frameEl),compareTileView.setContEl(frameEl.data("client")),compareTileView.backEl=compareTileView.contEl,compareTileView.el.css({margin:"20px auto 0"}),compareTileView.represent({decision:{id:data.args.decisionId}}),tracking.page(""+_this.path()+"/Compare"),_this.event("openWorkspace"),_this.closeMenu(),!1})),el.find(".group.actions").prepend($('<a href="#" class="share"><label>share</label></a>').click(function(){return tracking.page(""+_this.path()+"/SocialShare"),util.presentViewAsModalDialog("SocialShare",{id:data.args.decisionId},{waitUntilRepresented:!0}),!1}))}}(this);break;case"collections":this.el.find(".content > .add").hide(),this.el.append('<span class="collectionsArrow" />')}}return this.el.find(".contentWrapper").css({width:0}),this.el.find(".content").css({opacity:0}),this.direction=data.direction,data.contents&&(this.contents.setDataSource(data.contents),this.updateLayout(),this.barItemLoadCount===0&&this.el.find(".content").css({opacity:""})),data.moveUp?(this.atRoot=!1,this.el.find(".moveUp").show(),this.el.find(".home").hide()):(this.atRoot=!0,this.el.find(".moveUp").hide(),this.el.find(".home").show()),this.withData(data.shared,function(_this){return function(shared){return _this.el[shared?"addClass":"removeClass"]("shared"),_this.updateContentWrapperWidth()}}(this)),this.updateContentWrapperWidth()},ShoppingBarView.prototype.items=function(){return this.el.find(".content").children(".element")},ShoppingBarView.prototype.propOpen=function(view){return this.pin(),view.events.onDestruct.subscribe(function(_this){return function(){return _this.unpin()}}(this))},ShoppingBarView.prototype.methods={productAdded:function(id){return setTimeout(function(_this){return function(){var cancelClose,closing,closingTimerId,count,editPin,el,enter,initiateClose,leave,popup;el=_this.lastDroppedOn.data("view")===_this?_this.lastDroppedOn.data("view").items().last():_this.lastDroppedOn.data("view").elementType==="Session"||_this.lastDroppedOn.data("view").elementType==="Bundle"?_this.lastDroppedOn.data("view").barItem.items().last():_this.lastDroppedOn,_tutorial("Belt/RemoveItem",{positionEl:el,attachEl:$(document.body),position:"top"},{close:!0});if(!!window.suppressAddFeeling||!Agora.settings.autoFeelings.get()&&_this.opts.context!=="tutorial")return;_this.disableProductPopups=!0,editPin=!1,closing=!1,count=0,initiateClose=function(){return closing=!0,popup.initiateClose()},cancelClose=function(){return popup.cancelClose(),closing=!1},enter=function(){return++count,cancelClose()},leave=function(){return--count},closingTimerId=null,_this.productAddedPopup=popup=util.showPopup(el,{close:!1,createPopup:function(cb,close){var addFeelingView;return addFeelingView=_this.createView("AddFeelingView",{auto:!0}),_this.propOpen(addFeelingView),addFeelingView.el.find("input[name=feeling]").keyup(function(e){if(e.keyCode!==13)return editPin=!0,cancelClose();if(editPin)return editPin=!1}),addFeelingView.represent(id,function(){var frame;return frame=Frame.frameFixedAbove(el,addFeelingView.el,{type:"balloon",color:"dark",onClose:function(){return addFeelingView.destruct(),addFeelingView=null}}),frame.el.css({marginTop:-17}),addFeelingView.close=function(esc){return esc?popup.close():popup.initiateClose()},addFeelingView.sizeChanged=function(){return frame.update()},frame.el.mouseenter(enter).mouseleave(leave),cb(frame.el)}),null},onClose:function(el){var _ref;return(_ref=el.data("frame"))!=null&&typeof _ref.close=="function"&&_ref.close(),_this.lastDroppedOn.unbind("mouseleave",leave).unbind("mouseenter",enter),delete _this.disableProductPopups,delete _this.productAddedPopup,clearTimeout(closingTimerId)}});if(_this.opts.context!=="tutorial")return _this.lastDroppedOn.mouseleave(leave),_this.lastDroppedOn.mouseenter(enter),$(window).one("mousemove",function(){return closingTimerId=setInterval(function(){if(count<=0&&!editPin&&!closing)return initiateClose()},100)})}}(this),100)}},ShoppingBarView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/SocialShareView",[],function(){return{d:["View","util","icons"],c:function(){var SocialShareView;return SocialShareView=function(_super){__extends(SocialShareView,_super),SocialShareView.prototype.type="SocialShare";function SocialShareView(){SocialShareView.__super__.constructor.apply(this,arguments),this.viewEl('<div class="v-socialShare t-dialog"> <h2>Share Decision</h2> <div class="content"> <ul class="services"> <li class="twitter"></li> <li class="facebook"> <iframe></iframe> </li> <li class="googlePlus"></li> </ul> <input type="text" class="url"> <select class="access"> <option value="0">Private</option> <option value="1">Public (Unlisted)</option> <option value="2">Public (Listed)</option> </select> </div> </div>'),this.el.find(".url").focus(function(){return this.select()}),this.el.find(".url").mouseup(!1),this.el.find(".twitter").click(function(_this){return function(){if(_this.el.hasClass("private"))return;return tracking.event("SocialShare","Twitter"),window.open("https://twitter.com/share?url="+escape(_this.url),null,"menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=500,height=260")}}(this)),this.el.find(".googlePlus").click(function(_this){return function(){if(_this.el.hasClass("private"))return;return tracking.event("SocialShare","Google+"),window.open("https://plus.google.com/share?url="+_this.url,"","menubar=no,toolbar=no,resizable=yes,scrollbars=no,height=420,width=510")}}(this)),this.el.find(".access").change(function(_this){return function(){return _this.callBackgroundMethod("setAccess",_this.el.find(".access").val())}}(this)),util.styleSelect(this.el.find(".access"),{"class":"access",label:!1,autoSize:!1})}return SocialShareView.prototype.onData=function(data){return this.url=data.url,this.el.find(".facebook iframe").attr("src","//agora.sh/facebookShare.php?url="+this.url),data.owner&&(this.el.addClass("owner"),typeof this.sizeChanged=="function"&&this.sizeChanged()),this.el.find(".url").val(data.url),this.withData(data.access,function(_this){return function(access){return access===0?(_this.el.addClass("private"),_this.el.find(".url").prop("disabled",!0)):(_this.el.removeClass("private"),_this.el.find(".url").prop("disabled",!1)),_this.el.find(".access").prop("selectedIndex",access),_this.el.find(".access").trigger("change")}}(this))},SocialShareView}(View)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("client/views/WebAppView",[],function(){return function(){var WebAppView;return WebAppView=function(_super){__extends(WebAppView,_super);function WebAppView(){return WebAppView.__super__.constructor.apply(this,arguments)}return WebAppView.prototype.type="WebApp",WebAppView.prototype.onData=function(data){var compareView,resize,resizeTimerId;$('<div id="agoraCont" class="-agora" />').appendTo(document.body),resizeTimerId=null,resize=function(_this){return function(){return clearTimeout(resizeTimerId),resizeTimerId=setTimeout(function(){var width;return width=$(window).width(),$("#agoraCont").width(width),$("#agoraCont").triggerHandler("resize")},10),!0}}(this),$(window).resize(resize),resize();if(data.accessDenied)return $("#agoraCont").addClass("accessDenied");if(data.decisionId)return compareView=new CompareView(this.contentScript,$("#agoraCont"),$(document.body),!0),compareView.el.appendTo("#agoraCont"),compareView.represent({"public":!0,decision:{id:data.decisionId}})},WebAppView}(View)}}),define("client/widgets/AmazonDetailsWidget",[],function(){return function(){var AmazonDetailsWidget;return AmazonDetailsWidget=function(){AmazonDetailsWidget.prototype.title="Details",AmazonDetailsWidget.prototype.expands=!1;function AmazonDetailsWidget(data){var detail,name;this.el=$("<ul />");for(name in data)detail=data[name],this.el.append("<li><span class='name'>"+name+"</span>: <span class='value'>"+detail+"</span></li>")}return AmazonDetailsWidget}()}}),define("client/widgets/AmazonFeaturesWidget",[],function(){return function(){var AmazonFeatureWidget;return AmazonFeatureWidget=function(){AmazonFeatureWidget.prototype.title="Features",AmazonFeatureWidget.prototype.expands=!1;function AmazonFeatureWidget(data){var feature,_i,_len;this.el=$("<ul />");for(_i=0,_len=data.length;_i<_len;_i++)feature=data[_i],this.el.append("<li>"+feature+"</li>")}return AmazonFeatureWidget}()}}),define("client/widgets/AmazonMostHelpfulReviewWidget",[],function(){return function(){var AmazonMostHelpfulReviewWidget;return AmazonMostHelpfulReviewWidget=function(){AmazonMostHelpfulReviewWidget.prototype.title="Most Helpful Review",AmazonMostHelpfulReviewWidget.prototype.expands=!0;function AmazonMostHelpfulReviewWidget(data){var _ref,_ref1;this.el=$("<div> <div class='wrapper'> <a href='"+data.url+"' target='_blank' class='title'>"+data.title+"</a> <div class='rating'> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> </div> <div class='author'>"+((_ref=(_ref1=data.author)!=null?_ref1.name:void 0)!=null?_ref:data.author)+"</div> </div> <div class='review'>"+data.review+"</div> </div>"),util2.setRating(this.el.find(".rating"),data.rating)}return AmazonMostHelpfulReviewWidget.prototype.init=function(){this.el.find(".review").dotdotdot();if(!this.el.find(".review").triggerHandler("isTruncated"))return this.expands=!1},AmazonMostHelpfulReviewWidget}()}}),define("client/widgets/AmazonMostRecentReviewsWidget",[],function(){return function(){var AmazonMostRecentReviewsWidget;return AmazonMostRecentReviewsWidget=function(){AmazonMostRecentReviewsWidget.prototype.title="Most Recent Reviews",AmazonMostRecentReviewsWidget.prototype.expands=!0;function AmazonMostRecentReviewsWidget(data){var review,reviewEl,reviewI,_i,_len;this.el=$("<div />");for(reviewI=_i=0,_len=data.length;_i<_len;reviewI=++_i){review=data[reviewI];if(reviewI===3)break;reviewEl=$("<div class='recentReview'> <div class='wrapper'> <a href='"+review.url+"' target='_blank' class='title'>"+review.title+"</a> <div class='rating'> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> </div> <div class='author'>"+review.author+"</div> </div> <!--<div class='review'>"+review.review+"</div>--> </div>"),util2.setRating(reviewEl.find(".rating"),review.rating),this.el.append(reviewEl)}}return AmazonMostRecentReviewsWidget.prototype.init=function(){},AmazonMostRecentReviewsWidget}()}}),define("client/widgets/AmazonQuotesWidget",[],function(){return function(){var AmazonQuotes;return AmazonQuotes=function(){AmazonQuotes.prototype.title="Quotes",AmazonQuotes.prototype.expands=!0;function AmazonQuotes(data){var quote,quoteEl,_i,_len;this.el=$("<div />");for(_i=0,_len=data.length;_i<_len;_i++)quote=data[_i],quoteEl=$("<div class='quoteEntry'> <div class='wrapper'> <a href='"+quote.url+"' target='_blank' class='quote'>"+quote.quote+"</a> <div class='author'>"+quote.author+"</div> </div> </div>"),this.el.append(quoteEl)}return AmazonQuotes.prototype.init=function(){},AmazonQuotes}()}}),define("client/widgets/AmazonSizesWidget",[],function(){return function(){var AmazonSizesWidget;return AmazonSizesWidget=function(){AmazonSizesWidget.prototype.title="Sizes",AmazonSizesWidget.prototype.expands=!1;function AmazonSizesWidget(data){var size,_i,_len,_ref;this.el=$("<div> <ul class='sizes' /> </div>"),data.howItFits&&this.el.prepend("<span class='howItFits'>How it fits: <strong>"+data.howItFits+"</strong></span>"),_ref=data.sizes;for(_i=0,_len=_ref.length;_i<_len;_i++)size=_ref[_i],this.el.find(".sizes").append("<li>"+size+"</li>")}return AmazonSizesWidget}()}}),function(){define("client/widgets/AmazonSizeWidget",[],function(){return function(){var AmazonSizesWidget;return AmazonSizesWidget=function(){AmazonSizesWidget.prototype.title="Sizes",AmazonSizesWidget.prototype.expands=!1;function AmazonSizesWidget(data){this.el=$("<div>asdf</div>")}return AmazonSizesWidget}()}})}.call(this),define("client/widgets/DetailsWidget",[],function(){return function(){var DetailsWidget;return DetailsWidget=function(){DetailsWidget.prototype.expands=!1;function DetailsWidget(data){var detail,name,_ref;this.title=data.title,this.el=$("<ul />"),_ref=data.content;for(name in _ref)detail=_ref[name],this.el.append("<li><span class='name'>"+name+"</span>: <span class='value'>"+detail+"</span></li>")}return DetailsWidget}()}}),define("client/widgets/htmlWidget",[],function(){return function(){var htmlWidget;return htmlWidget=function(){htmlWidget.prototype.expands=!0;function htmlWidget(data){this.data=data,this.title=data.title,this.el=$("<div class='htmlContent'>"+data.content+"</div>"),data.maxHeight!=null&&this.el.css("max-height",data.maxHeight)}return htmlWidget.prototype.init=function(){if(this.data.maxHeight!=="none"){this.el.dotdotdot();if(!this.el.triggerHandler("isTruncated"))return this.expands=!1}},htmlWidget}()}}),define("client/widgets/ListWidget",[],function(){return function(){var ListWidget;return ListWidget=function(){function ListWidget(data){var item,_i,_len,_ref;this.title=data.title,this.el=$("<ul />"),_ref=data.content;for(_i=0,_len=_ref.length;_i<_len;_i++)item=_ref[_i],this.el.append("<li>"+item+"</li>")}return ListWidget}()}}),define("client/widgets/ReviewsWidget",[],function(){return function(){var ReviewsWidget;return ReviewsWidget=function(){ReviewsWidget.prototype.expands=!0;function ReviewsWidget(data){var review,reviewEl,reviewI,_i,_len,_ref,_ref1,_ref2,_ref3,_ref4;this.data=data,this.title=(_ref=data.title)!=null?_ref:"Reviews",this.el=$("<ul />"),_ref1=data.content;for(reviewI=_i=0,_len=_ref1.length;_i<_len;reviewI=++_i){review=_ref1[reviewI];if((_ref2=reviewI===data.count)!=null?_ref2:3)break;reviewEl=$("<li class='review'> <div class='wrapper'> <a href='"+review.url+"' target='_blank' class='title'>"+((_ref3=review.title)!=null?_ref3:"")+"</a> <div class='rating'> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> <div><div /></div> </div> <div class='author'>"+review.author+"</div> </div> <div class='review'>"+((_ref4=review.review)!=null?_ref4:review.content)+"</div> </div>"),review.review?data.maxHeight&&reviewEl.find("div.review").css("maxHeight",data.maxHeight):reviewEl.find("div.review").remove(),review.url||reviewEl.find(".title").removeAttr("href"),util2.setRating(reviewEl.find(".rating"),review.rating),this.el.append(reviewEl)}}return ReviewsWidget.prototype.init=function(){if(this.data.maxHeight)return this.el.find("div.review").dotdotdot()},ReviewsWidget}()}}),require(["client/BCSiteInjector","client/ContentScript","client/DataDrivenSiteInjector","client/Debug","client/devAction","client/Frame","client/Frame2","client/icons","client/Observable","client/SiteInjector","client/TipDialog","client/tracking","client/TutorialDialog","client/util","client/util2","client/View","client/views/AddArgumentView","client/views/AddDataView","client/views/AddDescriptorView","client/views/AddFeelingView","client/views/AddItemView","client/views/BuyView","client/views/ChatView","client/views/CollaborateView","client/views/compare/BundleTileItem","client/views/compare/CompareView","client/views/compare/DecisionTileItem","client/views/compare/ListTileItem","client/views/compare/ProductTileItem","client/views/compare/TileItem","client/views/compare/TileItemView","client/views/compare/UnauthorizedTileItem","client/views/CompetitiveProcessView","client/views/ContactView","client/views/CouponsView","client/views/DataView","client/views/DecisionPreviewView","client/views/EditDescriptorView","client/views/OffersView","client/views/ProductAddedView","client/views/ProductOverlayView","client/views/ProductPopupView","client/views/ProductPreviewView","client/views/ProductPreviewView2","client/views/ReviewsView","client/views/SharedWithYouView","client/views/ShareView","client/views/ShoppingBarView/BarItem","client/views/ShoppingBarView/BarItemView","client/views/ShoppingBarView/BeltBarItem","client/views/ShoppingBarView/BundleBarItem","client/views/ShoppingBarView/CompositeBarItem","client/views/ShoppingBarView/CompositeSlotBarItem","client/views/ShoppingBarView/DecisionBarItem","client/views/ShoppingBarView/ListBarItem","client/views/ShoppingBarView/PlaceholderBarItem","client/views/ShoppingBarView/ProductBarItem","client/views/ShoppingBarView/SessionBarItem","client/views/ShoppingBarView/SharedBeltBarItem","client/views/ShoppingBarView/UnauthorizedBarItem","client/views/ShoppingBarView","client/views/SocialShareView","client/views/WebAppView","client/widgets/AmazonDetailsWidget","client/widgets/AmazonFeaturesWidget","client/widgets/AmazonMostHelpfulReviewWidget","client/widgets/AmazonMostRecentReviewsWidget","client/widgets/AmazonQuotesWidget","client/widgets/AmazonSizesWidget","client/widgets/AmazonSizeWidget","client/widgets/DetailsWidget","client/widgets/htmlWidget","client/widgets/ListWidget","client/widgets/ReviewsWidget"]),define("../../client_all.js",function(){});