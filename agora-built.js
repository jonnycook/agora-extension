/**
 * @license
 * Lo-Dash 2.4.1 (Custom Build) lodash.com/license | Underscore.js 1.5.2 underscorejs.org/LICENSE
 * Build: `lodash modern -o ./dist/lodash.js`
 */

/**
 * @license RequireJS text 2.0.10 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

(function(){function n(n,t,e){e=(e||0)-1;for(var r=n?n.length:0;++e<r;)if(n[e]===t)return e;return-1}function t(t,e){var r=typeof e;if(t=t.l,"boolean"==r||null==e)return t[e]?0:-1;"number"!=r&&"string"!=r&&(r="object");var u="number"==r?e:m+e;return t=(t=t[r])&&t[u],"object"==r?t&&-1<n(t,e)?0:-1:t?0:-1}function e(n){var t=this.l,e=typeof n;if("boolean"==e||null==n)t[n]=!0;else{"number"!=e&&"string"!=e&&(e="object");var r="number"==e?n:m+n,t=t[e]||(t[e]={});"object"==e?(t[r]||(t[r]=[])).push(n):t[r]=!0}}function r(n){return n.charCodeAt(0)}function u(n,t){for(var e=n.m,r=t.m,u=-1,o=e.length;++u<o;){var i=e[u],a=r[u];if(i!==a){if(i>a||typeof i=="undefined")return 1;if(i<a||typeof a=="undefined")return-1}}return n.n-t.n}function o(n){var t=-1,r=n.length,u=n[0],o=n[r/2|0],i=n[r-1];if(u&&typeof u=="object"&&o&&typeof o=="object"&&i&&typeof i=="object")return!1;for(u=f(),u["false"]=u["null"]=u["true"]=u.undefined=!1,o=f(),o.k=n,o.l=u,o.push=e;++t<r;)o.push(n[t]);return o}function i(n){return"\\"+U[n]}function a(){return h.pop()||[]}function f(){return g.pop()||{k:null,l:null,m:null,"false":!1,n:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,"undefined":!1,o:null}}function l(n){n.length=0,h.length<_&&h.push(n)}function c(n){var t=n.l;t&&c(t),n.k=n.l=n.m=n.object=n.number=n.string=n.o=null,g.length<_&&g.push(n)}function p(n,t,e){t||(t=0),typeof e=="undefined"&&(e=n?n.length:0);var r=-1;e=e-t||0;for(var u=Array(0>e?0:e);++r<e;)u[r]=n[t+r];return u}function s(e){function h(n,t,e){if(!n||!V[typeof n])return n;t=t&&typeof e=="undefined"?t:tt(t,e,3);for(var r=-1,u=V[typeof n]&&Fe(n),o=u?u.length:0;++r<o&&(e=u[r],!1!==t(n[e],e,n)););return n}function g(n,t,e){var r;if(!n||!V[typeof n])return n;t=t&&typeof e=="undefined"?t:tt(t,e,3);for(r in n)if(!1===t(n[r],r,n))break;return n}function _(n,t,e){var r,u=n,o=u;if(!u)return o;for(var i=arguments,a=0,f=typeof e=="number"?2:i.length;++a<f;)if((u=i[a])&&V[typeof u])for(var l=-1,c=V[typeof u]&&Fe(u),p=c?c.length:0;++l<p;)r=c[l],"undefined"==typeof o[r]&&(o[r]=u[r]);return o}function U(n,t,e){var r,u=n,o=u;if(!u)return o;var i=arguments,a=0,f=typeof e=="number"?2:i.length;if(3<f&&"function"==typeof i[f-2])var l=tt(i[--f-1],i[f--],2);else 2<f&&"function"==typeof i[f-1]&&(l=i[--f]);for(;++a<f;)if((u=i[a])&&V[typeof u])for(var c=-1,p=V[typeof u]&&Fe(u),s=p?p.length:0;++c<s;)r=p[c],o[r]=l?l(o[r],u[r]):u[r];return o}function H(n){var t,e=[];if(!n||!V[typeof n])return e;for(t in n)me.call(n,t)&&e.push(t);return e}function J(n){return n&&typeof n=="object"&&!Te(n)&&me.call(n,"__wrapped__")?n:new Q(n)}function Q(n,t){this.__chain__=!!t,this.__wrapped__=n}function X(n){function t(){if(r){var n=p(r);be.apply(n,arguments)}if(this instanceof t){var o=nt(e.prototype),n=e.apply(o,n||arguments);return wt(n)?n:o}return e.apply(u,n||arguments)}var e=n[0],r=n[2],u=n[4];return $e(t,n),t}function Z(n,t,e,r,u){if(e){var o=e(n);if(typeof o!="undefined")return o}if(!wt(n))return n;var i=ce.call(n);if(!K[i])return n;var f=Ae[i];switch(i){case T:case F:return new f(+n);case W:case P:return new f(n);case z:return o=f(n.source,C.exec(n)),o.lastIndex=n.lastIndex,o}if(i=Te(n),t){var c=!r;r||(r=a()),u||(u=a());for(var s=r.length;s--;)if(r[s]==n)return u[s];o=i?f(n.length):{}}else o=i?p(n):U({},n);return i&&(me.call(n,"index")&&(o.index=n.index),me.call(n,"input")&&(o.input=n.input)),t?(r.push(n),u.push(o),(i?St:h)(n,function(n,i){o[i]=Z(n,t,e,r,u)}),c&&(l(r),l(u)),o):o}function nt(n){return wt(n)?ke(n):{}}function tt(n,t,e){if(typeof n!="function")return Ut;if(typeof t!="undefined"&&"prototype"in n){var r=n.__bindData__;if(typeof r=="undefined"&&(De.funcNames&&(r=!n.name),r=r||!De.funcDecomp,!r)){var u=ge.call(n);De.funcNames||(r=!O.test(u)),r||(r=E.test(u),$e(n,r))}if(!1===r||!0!==r&&1&r[1])return n;switch(e){case 1:return function(e){return n.call(t,e)};case 2:return function(e,r){return n.call(t,e,r)};case 3:return function(e,r,u){return n.call(t,e,r,u)};case 4:return function(e,r,u,o){return n.call(t,e,r,u,o)}}return Mt(n,t)}return n}function et(n){function t(){var n=f?i:this;if(u){var h=p(u);be.apply(h,arguments)}return(o||c)&&(h||(h=p(arguments)),o&&be.apply(h,o),c&&h.length<a)?(r|=16,et([e,s?r:-4&r,h,null,i,a])):(h||(h=arguments),l&&(e=n[v]),this instanceof t?(n=nt(e.prototype),h=e.apply(n,h),wt(h)?h:n):e.apply(n,h))}var e=n[0],r=n[1],u=n[2],o=n[3],i=n[4],a=n[5],f=1&r,l=2&r,c=4&r,s=8&r,v=e;return $e(t,n),t}function rt(e,r){var u=-1,i=st(),a=e?e.length:0,f=a>=b&&i===n,l=[];if(f){var p=o(r);p?(i=t,r=p):f=!1}for(;++u<a;)p=e[u],0>i(r,p)&&l.push(p);return f&&c(r),l}function ut(n,t,e,r){r=(r||0)-1;for(var u=n?n.length:0,o=[];++r<u;){var i=n[r];if(i&&typeof i=="object"&&typeof i.length=="number"&&(Te(i)||yt(i))){t||(i=ut(i,t,e));var a=-1,f=i.length,l=o.length;for(o.length+=f;++a<f;)o[l++]=i[a]}else e||o.push(i)}return o}function ot(n,t,e,r,u,o){if(e){var i=e(n,t);if(typeof i!="undefined")return!!i}if(n===t)return 0!==n||1/n==1/t;if(n===n&&!(n&&V[typeof n]||t&&V[typeof t]))return!1;if(null==n||null==t)return n===t;var f=ce.call(n),c=ce.call(t);if(f==D&&(f=q),c==D&&(c=q),f!=c)return!1;switch(f){case T:case F:return+n==+t;case W:return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case z:case P:return n==oe(t)}if(c=f==$,!c){var p=me.call(n,"__wrapped__"),s=me.call(t,"__wrapped__");if(p||s)return ot(p?n.__wrapped__:n,s?t.__wrapped__:t,e,r,u,o);if(f!=q)return!1;if(f=n.constructor,p=t.constructor,f!=p&&!(dt(f)&&f instanceof f&&dt(p)&&p instanceof p)&&"constructor"in n&&"constructor"in t)return!1}for(f=!u,u||(u=a()),o||(o=a()),p=u.length;p--;)if(u[p]==n)return o[p]==t;var v=0,i=!0;if(u.push(n),o.push(t),c){if(p=n.length,v=t.length,(i=v==p)||r)for(;v--;)if(c=p,s=t[v],r)for(;c--&&!(i=ot(n[c],s,e,r,u,o)););else if(!(i=ot(n[v],s,e,r,u,o)))break}else g(t,function(t,a,f){return me.call(f,a)?(v++,i=me.call(n,a)&&ot(n[a],t,e,r,u,o)):void 0}),i&&!r&&g(n,function(n,t,e){return me.call(e,t)?i=-1<--v:void 0});return u.pop(),o.pop(),f&&(l(u),l(o)),i}function it(n,t,e,r,u){(Te(t)?St:h)(t,function(t,o){var i,a,f=t,l=n[o];if(t&&((a=Te(t))||Pe(t))){for(f=r.length;f--;)if(i=r[f]==t){l=u[f];break}if(!i){var c;e&&(f=e(l,t),c=typeof f!="undefined")&&(l=f),c||(l=a?Te(l)?l:[]:Pe(l)?l:{}),r.push(t),u.push(l),c||it(l,t,e,r,u)}}else e&&(f=e(l,t),typeof f=="undefined"&&(f=t)),typeof f!="undefined"&&(l=f);n[o]=l})}function at(n,t){return n+he(Re()*(t-n+1))}function ft(e,r,u){var i=-1,f=st(),p=e?e.length:0,s=[],v=!r&&p>=b&&f===n,h=u||v?a():s;for(v&&(h=o(h),f=t);++i<p;){var g=e[i],y=u?u(g,i,e):g;(r?!i||h[h.length-1]!==y:0>f(h,y))&&((u||v)&&h.push(y),s.push(g))}return v?(l(h.k),c(h)):u&&l(h),s}function lt(n){return function(t,e,r){var u={};e=J.createCallback(e,r,3),r=-1;var o=t?t.length:0;if(typeof o=="number")for(;++r<o;){var i=t[r];n(u,i,e(i,r,t),t)}else h(t,function(t,r,o){n(u,t,e(t,r,o),o)});return u}}function ct(n,t,e,r,u,o){var i=1&t,a=4&t,f=16&t,l=32&t;if(!(2&t||dt(n)))throw new ie;f&&!e.length&&(t&=-17,f=e=!1),l&&!r.length&&(t&=-33,l=r=!1);var c=n&&n.__bindData__;return c&&!0!==c?(c=p(c),c[2]&&(c[2]=p(c[2])),c[3]&&(c[3]=p(c[3])),!i||1&c[1]||(c[4]=u),!i&&1&c[1]&&(t|=8),!a||4&c[1]||(c[5]=o),f&&be.apply(c[2]||(c[2]=[]),e),l&&we.apply(c[3]||(c[3]=[]),r),c[1]|=t,ct.apply(null,c)):(1==t||17===t?X:et)([n,t,e,r,u,o])}function pt(n){return Be[n]}function st(){var t=(t=J.indexOf)===Wt?n:t;return t}function vt(n){return typeof n=="function"&&pe.test(n)}function ht(n){var t,e;return n&&ce.call(n)==q&&(t=n.constructor,!dt(t)||t instanceof t)?(g(n,function(n,t){e=t}),typeof e=="undefined"||me.call(n,e)):!1}function gt(n){return We[n]}function yt(n){return n&&typeof n=="object"&&typeof n.length=="number"&&ce.call(n)==D||!1}function mt(n,t,e){var r=Fe(n),u=r.length;for(t=tt(t,e,3);u--&&(e=r[u],!1!==t(n[e],e,n)););return n}function bt(n){var t=[];return g(n,function(n,e){dt(n)&&t.push(e)}),t.sort()}function _t(n){for(var t=-1,e=Fe(n),r=e.length,u={};++t<r;){var o=e[t];u[n[o]]=o}return u}function dt(n){return typeof n=="function"}function wt(n){return!!n&&!!V[typeof n]}function jt(n){return typeof n=="number"||n&&typeof n=="object"&&ce.call(n)==W||!1}function kt(n){return typeof n=="string"||n&&typeof n=="object"&&ce.call(n)==P||!1}function xt(n){for(var t=-1,e=Fe(n),r=e.length,u=Xt(r);++t<r;)u[t]=n[e[t]];return u}function Ct(n,t,e){var r=-1,u=st(),o=n?n.length:0,i=!1;return e=(0>e?Ie(0,o+e):e)||0,Te(n)?i=-1<u(n,t,e):typeof o=="number"?i=-1<(kt(n)?n.indexOf(t,e):u(n,t,e)):h(n,function(n){return++r<e?void 0:!(i=n===t)}),i}function Ot(n,t,e){var r=!0;t=J.createCallback(t,e,3),e=-1;var u=n?n.length:0;if(typeof u=="number")for(;++e<u&&(r=!!t(n[e],e,n)););else h(n,function(n,e,u){return r=!!t(n,e,u)});return r}function Nt(n,t,e){var r=[];t=J.createCallback(t,e,3),e=-1;var u=n?n.length:0;if(typeof u=="number")for(;++e<u;){var o=n[e];t(o,e,n)&&r.push(o)}else h(n,function(n,e,u){t(n,e,u)&&r.push(n)});return r}function It(n,t,e){t=J.createCallback(t,e,3),e=-1;var r=n?n.length:0;if(typeof r!="number"){var u;return h(n,function(n,e,r){return t(n,e,r)?(u=n,!1):void 0}),u}for(;++e<r;){var o=n[e];if(t(o,e,n))return o}}function St(n,t,e){var r=-1,u=n?n.length:0;if(t=t&&typeof e=="undefined"?t:tt(t,e,3),typeof u=="number")for(;++r<u&&!1!==t(n[r],r,n););else h(n,t);return n}function Et(n,t,e){var r=n?n.length:0;if(t=t&&typeof e=="undefined"?t:tt(t,e,3),typeof r=="number")for(;r--&&!1!==t(n[r],r,n););else{var u=Fe(n),r=u.length;h(n,function(n,e,o){return e=u?u[--r]:--r,t(o[e],e,o)})}return n}function Rt(n,t,e){var r=-1,u=n?n.length:0;if(t=J.createCallback(t,e,3),typeof u=="number")for(var o=Xt(u);++r<u;)o[r]=t(n[r],r,n);else o=[],h(n,function(n,e,u){o[++r]=t(n,e,u)});return o}function At(n,t,e){var u=-1/0,o=u;if(typeof t!="function"&&e&&e[t]===n&&(t=null),null==t&&Te(n)){e=-1;for(var i=n.length;++e<i;){var a=n[e];a>o&&(o=a)}}else t=null==t&&kt(n)?r:J.createCallback(t,e,3),St(n,function(n,e,r){e=t(n,e,r),e>u&&(u=e,o=n)});return o}function Dt(n,t,e,r){if(!n)return e;var u=3>arguments.length;t=J.createCallback(t,r,4);var o=-1,i=n.length;if(typeof i=="number")for(u&&(e=n[++o]);++o<i;)e=t(e,n[o],o,n);else h(n,function(n,r,o){e=u?(u=!1,n):t(e,n,r,o)});return e}function $t(n,t,e,r){var u=3>arguments.length;return t=J.createCallback(t,r,4),Et(n,function(n,r,o){e=u?(u=!1,n):t(e,n,r,o)}),e}function Tt(n){var t=-1,e=n?n.length:0,r=Xt(typeof e=="number"?e:0);return St(n,function(n){var e=at(0,++t);r[t]=r[e],r[e]=n}),r}function Ft(n,t,e){var r;t=J.createCallback(t,e,3),e=-1;var u=n?n.length:0;if(typeof u=="number")for(;++e<u&&!(r=t(n[e],e,n)););else h(n,function(n,e,u){return!(r=t(n,e,u))});return!!r}function Bt(n,t,e){var r=0,u=n?n.length:0;if(typeof t!="number"&&null!=t){var o=-1;for(t=J.createCallback(t,e,3);++o<u&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[0]:v;return p(n,0,Se(Ie(0,r),u))}function Wt(t,e,r){if(typeof r=="number"){var u=t?t.length:0;r=0>r?Ie(0,u+r):r||0}else if(r)return r=zt(t,e),t[r]===e?r:-1;return n(t,e,r)}function qt(n,t,e){if(typeof t!="number"&&null!=t){var r=0,u=-1,o=n?n.length:0;for(t=J.createCallback(t,e,3);++u<o&&t(n[u],u,n);)r++}else r=null==t||e?1:Ie(0,t);return p(n,r)}function zt(n,t,e,r){var u=0,o=n?n.length:u;for(e=e?J.createCallback(e,r,1):Ut,t=e(t);u<o;)r=u+o>>>1,e(n[r])<t?u=r+1:o=r;return u}function Pt(n,t,e,r){return typeof t!="boolean"&&null!=t&&(r=e,e=typeof t!="function"&&r&&r[t]===n?null:t,t=!1),null!=e&&(e=J.createCallback(e,r,3)),ft(n,t,e)}function Kt(){for(var n=1<arguments.length?arguments:arguments[0],t=-1,e=n?At(Ve(n,"length")):0,r=Xt(0>e?0:e);++t<e;)r[t]=Ve(n,t);return r}function Lt(n,t){var e=-1,r=n?n.length:0,u={};for(t||!r||Te(n[0])||(t=[]);++e<r;){var o=n[e];t?u[o]=t[e]:o&&(u[o[0]]=o[1])}return u}function Mt(n,t){return 2<arguments.length?ct(n,17,p(arguments,2),null,t):ct(n,1,null,null,t)}function Vt(n,t,e){function r(){c&&ve(c),i=c=p=v,(g||h!==t)&&(s=Ue(),a=n.apply(l,o),c||i||(o=l=null))}function u(){var e=t-(Ue()-f);0<e?c=_e(u,e):(i&&ve(i),e=p,i=c=p=v,e&&(s=Ue(),a=n.apply(l,o),c||i||(o=l=null)))}var o,i,a,f,l,c,p,s=0,h=!1,g=!0;if(!dt(n))throw new ie;if(t=Ie(0,t)||0,!0===e)var y=!0,g=!1;else wt(e)&&(y=e.leading,h="maxWait"in e&&(Ie(t,e.maxWait)||0),g="trailing"in e?e.trailing:g);return function(){if(o=arguments,f=Ue(),l=this,p=g&&(c||!y),!1===h)var e=y&&!c;else{i||y||(s=f);var v=h-(f-s),m=0>=v;m?(i&&(i=ve(i)),s=f,a=n.apply(l,o)):i||(i=_e(r,v))}return m&&c?c=ve(c):c||t===h||(c=_e(u,t)),e&&(m=!0,a=n.apply(l,o)),!m||c||i||(o=l=null),a}}function Ut(n){return n}function Gt(n,t,e){var r=!0,u=t&&bt(t);t&&(e||u.length)||(null==e&&(e=t),o=Q,t=n,n=J,u=bt(t)),!1===e?r=!1:wt(e)&&"chain"in e&&(r=e.chain);var o=n,i=dt(o);St(u,function(e){var u=n[e]=t[e];i&&(o.prototype[e]=function(){var t=this.__chain__,e=this.__wrapped__,i=[e];if(be.apply(i,arguments),i=u.apply(n,i),r||t){if(e===i&&wt(i))return this;i=new o(i),i.__chain__=t}return i})})}function Ht(){}function Jt(n){return function(t){return t[n]}}function Qt(){return this.__wrapped__}e=e?Y.defaults(G.Object(),e,Y.pick(G,A)):G;var Xt=e.Array,Yt=e.Boolean,Zt=e.Date,ne=e.Function,te=e.Math,ee=e.Number,re=e.Object,ue=e.RegExp,oe=e.String,ie=e.TypeError,ae=[],fe=re.prototype,le=e._,ce=fe.toString,pe=ue("^"+oe(ce).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$"),se=te.ceil,ve=e.clearTimeout,he=te.floor,ge=ne.prototype.toString,ye=vt(ye=re.getPrototypeOf)&&ye,me=fe.hasOwnProperty,be=ae.push,_e=e.setTimeout,de=ae.splice,we=ae.unshift,je=function(){try{var n={},t=vt(t=re.defineProperty)&&t,e=t(n,n,n)&&t}catch(r){}return e}(),ke=vt(ke=re.create)&&ke,xe=vt(xe=Xt.isArray)&&xe,Ce=e.isFinite,Oe=e.isNaN,Ne=vt(Ne=re.keys)&&Ne,Ie=te.max,Se=te.min,Ee=e.parseInt,Re=te.random,Ae={};Ae[$]=Xt,Ae[T]=Yt,Ae[F]=Zt,Ae[B]=ne,Ae[q]=re,Ae[W]=ee,Ae[z]=ue,Ae[P]=oe,Q.prototype=J.prototype;var De=J.support={};De.funcDecomp=!vt(e.a)&&E.test(s),De.funcNames=typeof ne.name=="string",J.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:N,variable:"",imports:{_:J}},ke||(nt=function(){function n(){}return function(t){if(wt(t)){n.prototype=t;var r=new n;n.prototype=null}return r||e.Object()}}());var $e=je?function(n,t){M.value=t,je(n,"__bindData__",M)}:Ht,Te=xe||function(n){return n&&typeof n=="object"&&typeof n.length=="number"&&ce.call(n)==$||!1},Fe=Ne?function(n){return wt(n)?Ne(n):[]}:H,Be={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},We=_t(Be),qe=ue("("+Fe(We).join("|")+")","g"),ze=ue("["+Fe(Be).join("")+"]","g"),Pe=ye?function(n){if(!n||ce.call(n)!=q)return!1;var t=n.valueOf,e=vt(t)&&(e=ye(t))&&ye(e);return e?n==e||ye(n)==e:ht(n)}:ht,Ke=lt(function(n,t,e){me.call(n,e)?n[e]++:n[e]=1}),Le=lt(function(n,t,e){(me.call(n,e)?n[e]:n[e]=[]).push(t)}),Me=lt(function(n,t,e){n[e]=t}),Ve=Rt,Ue=vt(Ue=Zt.now)&&Ue||function(){return(new Zt).getTime()},Ge=8==Ee(d+"08")?Ee:function(n,t){return Ee(kt(n)?n.replace(I,""):n,t||0)};return J.after=function(n,t){if(!dt(t))throw new ie;return function(){return 1>--n?t.apply(this,arguments):void 0}},J.assign=U,J.at=function(n){for(var t=arguments,e=-1,r=ut(t,!0,!1,1),t=t[2]&&t[2][t[1]]===n?1:r.length,u=Xt(t);++e<t;)u[e]=n[r[e]];return u},J.bind=Mt,J.bindAll=function(n){for(var t=1<arguments.length?ut(arguments,!0,!1,1):bt(n),e=-1,r=t.length;++e<r;){var u=t[e];n[u]=ct(n[u],1,null,null,n)}return n},J.bindKey=function(n,t){return 2<arguments.length?ct(t,19,p(arguments,2),null,n):ct(t,3,null,null,n)},J.chain=function(n){return n=new Q(n),n.__chain__=!0,n},J.compact=function(n){for(var t=-1,e=n?n.length:0,r=[];++t<e;){var u=n[t];u&&r.push(u)}return r},J.compose=function(){for(var n=arguments,t=n.length;t--;)if(!dt(n[t]))throw new ie;return function(){for(var t=arguments,e=n.length;e--;)t=[n[e].apply(this,t)];return t[0]}},J.constant=function(n){return function(){return n}},J.countBy=Ke,J.create=function(n,t){var e=nt(n);return t?U(e,t):e},J.createCallback=function(n,t,e){var r=typeof n;if(null==n||"function"==r)return tt(n,t,e);if("object"!=r)return Jt(n);var u=Fe(n),o=u[0],i=n[o];return 1!=u.length||i!==i||wt(i)?function(t){for(var e=u.length,r=!1;e--&&(r=ot(t[u[e]],n[u[e]],null,!0)););return r}:function(n){return n=n[o],i===n&&(0!==i||1/i==1/n)}},J.curry=function(n,t){return t=typeof t=="number"?t:+t||n.length,ct(n,4,null,null,null,t)},J.debounce=Vt,J.defaults=_,J.defer=function(n){if(!dt(n))throw new ie;var t=p(arguments,1);return _e(function(){n.apply(v,t)},1)},J.delay=function(n,t){if(!dt(n))throw new ie;var e=p(arguments,2);return _e(function(){n.apply(v,e)},t)},J.difference=function(n){return rt(n,ut(arguments,!0,!0,1))},J.filter=Nt,J.flatten=function(n,t,e,r){return typeof t!="boolean"&&null!=t&&(r=e,e=typeof t!="function"&&r&&r[t]===n?null:t,t=!1),null!=e&&(n=Rt(n,e,r)),ut(n,t)},J.forEach=St,J.forEachRight=Et,J.forIn=g,J.forInRight=function(n,t,e){var r=[];g(n,function(n,t){r.push(t,n)});var u=r.length;for(t=tt(t,e,3);u--&&!1!==t(r[u--],r[u],n););return n},J.forOwn=h,J.forOwnRight=mt,J.functions=bt,J.groupBy=Le,J.indexBy=Me,J.initial=function(n,t,e){var r=0,u=n?n.length:0;if(typeof t!="number"&&null!=t){var o=u;for(t=J.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else r=null==t||e?1:t||r;return p(n,0,Se(Ie(0,u-r),u))},J.intersection=function(){for(var e=[],r=-1,u=arguments.length,i=a(),f=st(),p=f===n,s=a();++r<u;){var v=arguments[r];(Te(v)||yt(v))&&(e.push(v),i.push(p&&v.length>=b&&o(r?e[r]:s)))}var p=e[0],h=-1,g=p?p.length:0,y=[];n:for(;++h<g;){var m=i[0],v=p[h];if(0>(m?t(m,v):f(s,v))){for(r=u,(m||s).push(v);--r;)if(m=i[r],0>(m?t(m,v):f(e[r],v)))continue n;y.push(v)}}for(;u--;)(m=i[u])&&c(m);return l(i),l(s),y},J.invert=_t,J.invoke=function(n,t){var e=p(arguments,2),r=-1,u=typeof t=="function",o=n?n.length:0,i=Xt(typeof o=="number"?o:0);return St(n,function(n){i[++r]=(u?t:n[t]).apply(n,e)}),i},J.keys=Fe,J.map=Rt,J.mapValues=function(n,t,e){var r={};return t=J.createCallback(t,e,3),h(n,function(n,e,u){r[e]=t(n,e,u)}),r},J.max=At,J.memoize=function(n,t){function e(){var r=e.cache,u=t?t.apply(this,arguments):m+arguments[0];return me.call(r,u)?r[u]:r[u]=n.apply(this,arguments)}if(!dt(n))throw new ie;return e.cache={},e},J.merge=function(n){var t=arguments,e=2;if(!wt(n))return n;if("number"!=typeof t[2]&&(e=t.length),3<e&&"function"==typeof t[e-2])var r=tt(t[--e-1],t[e--],2);else 2<e&&"function"==typeof t[e-1]&&(r=t[--e]);for(var t=p(arguments,1,e),u=-1,o=a(),i=a();++u<e;)it(n,t[u],r,o,i);return l(o),l(i),n},J.min=function(n,t,e){var u=1/0,o=u;if(typeof t!="function"&&e&&e[t]===n&&(t=null),null==t&&Te(n)){e=-1;for(var i=n.length;++e<i;){var a=n[e];a<o&&(o=a)}}else t=null==t&&kt(n)?r:J.createCallback(t,e,3),St(n,function(n,e,r){e=t(n,e,r),e<u&&(u=e,o=n)});return o},J.omit=function(n,t,e){var r={};if(typeof t!="function"){var u=[];g(n,function(n,t){u.push(t)});for(var u=rt(u,ut(arguments,!0,!1,1)),o=-1,i=u.length;++o<i;){var a=u[o];r[a]=n[a]}}else t=J.createCallback(t,e,3),g(n,function(n,e,u){t(n,e,u)||(r[e]=n)});return r},J.once=function(n){var t,e;if(!dt(n))throw new ie;return function(){return t?e:(t=!0,e=n.apply(this,arguments),n=null,e)}},J.pairs=function(n){for(var t=-1,e=Fe(n),r=e.length,u=Xt(r);++t<r;){var o=e[t];u[t]=[o,n[o]]}return u},J.partial=function(n){return ct(n,16,p(arguments,1))},J.partialRight=function(n){return ct(n,32,null,p(arguments,1))},J.pick=function(n,t,e){var r={};if(typeof t!="function")for(var u=-1,o=ut(arguments,!0,!1,1),i=wt(n)?o.length:0;++u<i;){var a=o[u];a in n&&(r[a]=n[a])}else t=J.createCallback(t,e,3),g(n,function(n,e,u){t(n,e,u)&&(r[e]=n)});return r},J.pluck=Ve,J.property=Jt,J.pull=function(n){for(var t=arguments,e=0,r=t.length,u=n?n.length:0;++e<r;)for(var o=-1,i=t[e];++o<u;)n[o]===i&&(de.call(n,o--,1),u--);return n},J.range=function(n,t,e){n=+n||0,e=typeof e=="number"?e:+e||1,null==t&&(t=n,n=0);var r=-1;t=Ie(0,se((t-n)/(e||1)));for(var u=Xt(t);++r<t;)u[r]=n,n+=e;return u},J.reject=function(n,t,e){return t=J.createCallback(t,e,3),Nt(n,function(n,e,r){return!t(n,e,r)})},J.remove=function(n,t,e){var r=-1,u=n?n.length:0,o=[];for(t=J.createCallback(t,e,3);++r<u;)e=n[r],t(e,r,n)&&(o.push(e),de.call(n,r--,1),u--);return o},J.rest=qt,J.shuffle=Tt,J.sortBy=function(n,t,e){var r=-1,o=Te(t),i=n?n.length:0,p=Xt(typeof i=="number"?i:0);for(o||(t=J.createCallback(t,e,3)),St(n,function(n,e,u){var i=p[++r]=f();o?i.m=Rt(t,function(t){return n[t]}):(i.m=a())[0]=t(n,e,u),i.n=r,i.o=n}),i=p.length,p.sort(u);i--;)n=p[i],p[i]=n.o,o||l(n.m),c(n);return p},J.tap=function(n,t){return t(n),n},J.throttle=function(n,t,e){var r=!0,u=!0;if(!dt(n))throw new ie;return!1===e?r=!1:wt(e)&&(r="leading"in e?e.leading:r,u="trailing"in e?e.trailing:u),L.leading=r,L.maxWait=t,L.trailing=u,Vt(n,t,L)},J.times=function(n,t,e){n=-1<(n=+n)?n:0;var r=-1,u=Xt(n);for(t=tt(t,e,1);++r<n;)u[r]=t(r);return u},J.toArray=function(n){return n&&typeof n.length=="number"?p(n):xt(n)},J.transform=function(n,t,e,r){var u=Te(n);if(null==e)if(u)e=[];else{var o=n&&n.constructor;e=nt(o&&o.prototype)}return t&&(t=J.createCallback(t,r,4),(u?St:h)(n,function(n,r,u){return t(e,n,r,u)})),e},J.union=function(){return ft(ut(arguments,!0,!0))},J.uniq=Pt,J.values=xt,J.where=Nt,J.without=function(n){return rt(n,p(arguments,1))},J.wrap=function(n,t){return ct(t,16,[n])},J.xor=function(){for(var n=-1,t=arguments.length;++n<t;){var e=arguments[n];if(Te(e)||yt(e))var r=r?ft(rt(r,e).concat(rt(e,r))):e}return r||[]},J.zip=Kt,J.zipObject=Lt,J.collect=Rt,J.drop=qt,J.each=St,J.eachRight=Et,J.extend=U,J.methods=bt,J.object=Lt,J.select=Nt,J.tail=qt,J.unique=Pt,J.unzip=Kt,Gt(J),J.clone=function(n,t,e,r){return typeof t!="boolean"&&null!=t&&(r=e,e=t,t=!1),Z(n,t,typeof e=="function"&&tt(e,r,1))},J.cloneDeep=function(n,t,e){return Z(n,!0,typeof t=="function"&&tt(t,e,1))},J.contains=Ct,J.escape=function(n){return null==n?"":oe(n).replace(ze,pt)},J.every=Ot,J.find=It,J.findIndex=function(n,t,e){var r=-1,u=n?n.length:0;for(t=J.createCallback(t,e,3);++r<u;)if(t(n[r],r,n))return r;return-1},J.findKey=function(n,t,e){var r;return t=J.createCallback(t,e,3),h(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},J.findLast=function(n,t,e){var r;return t=J.createCallback(t,e,3),Et(n,function(n,e,u){return t(n,e,u)?(r=n,!1):void 0}),r},J.findLastIndex=function(n,t,e){var r=n?n.length:0;for(t=J.createCallback(t,e,3);r--;)if(t(n[r],r,n))return r;return-1},J.findLastKey=function(n,t,e){var r;return t=J.createCallback(t,e,3),mt(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},J.has=function(n,t){return n?me.call(n,t):!1},J.identity=Ut,J.indexOf=Wt,J.isArguments=yt,J.isArray=Te,J.isBoolean=function(n){return!0===n||!1===n||n&&typeof n=="object"&&ce.call(n)==T||!1},J.isDate=function(n){return n&&typeof n=="object"&&ce.call(n)==F||!1},J.isElement=function(n){return n&&1===n.nodeType||!1},J.isEmpty=function(n){var t=!0;if(!n)return t;var e=ce.call(n),r=n.length;return e==$||e==P||e==D||e==q&&typeof r=="number"&&dt(n.splice)?!r:(h(n,function(){return t=!1}),t)},J.isEqual=function(n,t,e,r){return ot(n,t,typeof e=="function"&&tt(e,r,2))},J.isFinite=function(n){return Ce(n)&&!Oe(parseFloat(n))},J.isFunction=dt,J.isNaN=function(n){return jt(n)&&n!=+n},J.isNull=function(n){return null===n},J.isNumber=jt,J.isObject=wt,J.isPlainObject=Pe,J.isRegExp=function(n){return n&&typeof n=="object"&&ce.call(n)==z||!1},J.isString=kt,J.isUndefined=function(n){return typeof n=="undefined"},J.lastIndexOf=function(n,t,e){var r=n?n.length:0;for(typeof e=="number"&&(r=(0>e?Ie(0,r+e):Se(e,r-1))+1);r--;)if(n[r]===t)return r;return-1},J.mixin=Gt,J.noConflict=function(){return e._=le,this},J.noop=Ht,J.now=Ue,J.parseInt=Ge,J.random=function(n,t,e){var r=null==n,u=null==t;return null==e&&(typeof n=="boolean"&&u?(e=n,n=1):u||typeof t!="boolean"||(e=t,u=!0)),r&&u&&(t=1),n=+n||0,u?(t=n,n=0):t=+t||0,e||n%1||t%1?(e=Re(),Se(n+e*(t-n+parseFloat("1e-"+((e+"").length-1))),t)):at(n,t)},J.reduce=Dt,J.reduceRight=$t,J.result=function(n,t){if(n){var e=n[t];return dt(e)?n[t]():e}},J.runInContext=s,J.size=function(n){var t=n?n.length:0;return typeof t=="number"?t:Fe(n).length},J.some=Ft,J.sortedIndex=zt,J.template=function(n,t,e){var r=J.templateSettings;n=oe(n||""),e=_({},e,r);var u,o=_({},e.imports,r.imports),r=Fe(o),o=xt(o),a=0,f=e.interpolate||S,l="__p+='",f=ue((e.escape||S).source+"|"+f.source+"|"+(f===N?x:S).source+"|"+(e.evaluate||S).source+"|$","g");n.replace(f,function(t,e,r,o,f,c){return r||(r=o),l+=n.slice(a,c).replace(R,i),e&&(l+="'+__e("+e+")+'"),f&&(u=!0,l+="';"+f+";\n__p+='"),r&&(l+="'+((__t=("+r+"))==null?'':__t)+'"),a=c+t.length,t}),l+="';",f=e=e.variable,f||(e="obj",l="with("+e+"){"+l+"}"),l=(u?l.replace(w,""):l).replace(j,"$1").replace(k,"$1;"),l="function("+e+"){"+(f?"":e+"||("+e+"={});")+"var __t,__p='',__e=_.escape"+(u?",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}":";")+l+"return __p}";try{var c=ne(r,"return "+l).apply(v,o)}catch(p){throw p.source=l,p}return t?c(t):(c.source=l,c)},J.unescape=function(n){return null==n?"":oe(n).replace(qe,gt)},J.uniqueId=function(n){var t=++y;return oe(null==n?"":n)+t},J.all=Ot,J.any=Ft,J.detect=It,J.findWhere=It,J.foldl=Dt,J.foldr=$t,J.include=Ct,J.inject=Dt,Gt(function(){var n={};return h(J,function(t,e){J.prototype[e]||(n[e]=t)}),n}(),!1),J.first=Bt,J.last=function(n,t,e){var r=0,u=n?n.length:0;if(typeof t!="number"&&null!=t){var o=u;for(t=J.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[u-1]:v;return p(n,Ie(0,u-r))},J.sample=function(n,t,e){return n&&typeof n.length!="number"&&(n=xt(n)),null==t||e?n?n[at(0,n.length-1)]:v:(n=Tt(n),n.length=Se(Ie(0,t),n.length),n)},J.take=Bt,J.head=Bt,h(J,function(n,t){var e="sample"!==t;J.prototype[t]||(J.prototype[t]=function(t,r){var u=this.__chain__,o=n(this.__wrapped__,t,r);return u||null!=t&&(!r||e&&typeof t=="function")?new Q(o,u):o})}),J.VERSION="2.4.1",J.prototype.chain=function(){return this.__chain__=!0,this},J.prototype.toString=function(){return oe(this.__wrapped__)},J.prototype.value=Qt,J.prototype.valueOf=Qt,St(["join","pop","shift"],function(n){var t=ae[n];J.prototype[n]=function(){var n=this.__chain__,e=t.apply(this.__wrapped__,arguments);return n?new Q(e,n):e}}),St(["push","reverse","sort","unshift"],function(n){var t=ae[n];J.prototype[n]=function(){return t.apply(this.__wrapped__,arguments),this}}),St(["concat","slice","splice"],function(n){var t=ae[n];J.prototype[n]=function(){return new Q(t.apply(this.__wrapped__,arguments),this.__chain__)}}),J}var v,h=[],g=[],y=0,m=+(new Date)+"",b=75,_=40,d=" 	\f ﻿\n\r\u2028\u2029 ᠎             　",w=/\b__p\+='';/g,j=/\b(__p\+=)''\+/g,k=/(__e\(.*?\)|\b__t\))\+'';/g,x=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,C=/\w*$/,O=/^\s*function[ \n\r\t]+\w/,N=/<%=([\s\S]+?)%>/g,I=RegExp("^["+d+"]*0+(?=.$)"),S=/($^)/,E=/\bthis\b/,R=/['\n\r\t\u2028\u2029\\]/g,A="Array Boolean Date Function Math Number Object RegExp String _ attachEvent clearTimeout isFinite isNaN parseInt setTimeout".split(" "),D="[object Arguments]",$="[object Array]",T="[object Boolean]",F="[object Date]",B="[object Function]",W="[object Number]",q="[object Object]",z="[object RegExp]",P="[object String]",K={};K[B]=!1,K[D]=K[$]=K[T]=K[F]=K[W]=K[q]=K[z]=K[P]=!0;var L={leading:!1,maxWait:0,trailing:!1},M={configurable:!1,enumerable:!1,value:null,writable:!1},V={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},U={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},G=V[typeof window]&&window||this,H=V[typeof exports]&&exports&&!exports.nodeType&&exports,J=V[typeof module]&&module&&!module.nodeType&&module,Q=J&&J.exports===H&&H,X=V[typeof global]&&global;!X||X.global!==X&&X.window!==X||(G=X);var Y=s();typeof define=="function"&&typeof define.amd=="object"&&define.amd?(G._=Y,define("underscore",[],function(){return Y})):H&&J?Q?(J.exports=Y)._=Y:H._=Y:G._=Y}).call(this),define("Debug",["underscore"],function(_){var Debug;return Debug=function(){function Debug(){}return Debug.stackTrace=function(){var trace;return trace=Error().stack,trace=trace.split("at ").slice(3),_.map(trace,function(line){var matches;matches=line.match(/(.*?) \(((?:[<>A-z0-9_\/.:\-])*):([^:]*):([^:]*)\)\s*/);if(matches)return{"function":matches[1],file:matches[2],line:matches[3],col:matches[4],l:line};matches=line.match(/((?:[<>A-z0-9_\/.:\-])*):([^:]*):([^:]*)/);if(matches)return{"function":null,file:matches[1],line:matches[2],col:matches[3],l:line}})},Debug.log=function(){var args,caller,func,i,ignoreList,item,list,matched,pattern,trace,_i,_j,_k,_len,_len1,_len2,_ref;ignoreList=[["ConnectView"],["_callObservers"],["triggerContentScriptEvent"],["CreateView"],["DeleteView"],[/^Deleting view/]];for(_i=0,_len=ignoreList.length;_i<_len;_i++){list=ignoreList[_i],matched=!0;for(i=_j=0,_len1=list.length;_j<_len1;i=++_j){item=list[i],typeof item=="string"?arguments[i]!==item&&(matched=!1):item.exec(arguments[i])||(matched=!1);if(!matched)break}if(matched)return}trace=this.stackTrace(),args=Array.prototype.slice.call(arguments,0,arguments.length),caller=trace[1],func=caller["function"];if(func){_ref=["^Update","^Table"];for(_k=0,_len2=_ref.length;_k<_len2;_k++){pattern=_ref[_k];if(func.match(pattern))return}}return args.push(""+caller.file+":"+caller.line+":"+caller.col),func&&args.unshift("["+func+"]"),console.log.apply(console,args)},Debug.error=function(){var args,caller,func,i,ignoreList,item,list,matched,trace,_i,_j,_len,_len1;ignoreList=[["_callObservers"],["update"],["adding"]];for(_i=0,_len=ignoreList.length;_i<_len;_i++){list=ignoreList[_i],matched=!0;for(i=_j=0,_len1=list.length;_j<_len1;i=++_j){item=list[i],typeof item=="string"?arguments[i]!==item&&(matched=!1):item.exec(arguments[i])||(matched=!1);if(!matched)break}if(matched)return}return trace=this.stackTrace(),args=Array.prototype.slice.call(arguments,0,arguments.length),caller=trace[1],func=caller["function"],args.push(""+caller.file+":"+caller.line+":"+caller.col),func&&args.unshift("["+func+"]"),console.error.apply(console,args)},Debug}()}),define("client/ContentScript",[],function(){return function(){var ContentScript;return ContentScript=function(){function ContentScript(){this.listeners={},this.eventMap={},this.onRequest(function(_this){return function(request){var l,listener,_i,_len,_results;if(request.eventName){_this.eventMap[request.eventName]?Debug.log("ReceivedRequest",request.eventName,_this.eventMap[request.eventName],request.args):Debug.log("ReceivedRequest",request.eventName,request.args);if(l=_this.listeners[request.eventName]){_results=[];for(_i=0,_len=l.length;_i<_len;_i++)listener=l[_i],_results.push(listener(request.args));return _results}}}}(this))}return ContentScript.prototype.mapEvent=function(event,obj){return this.eventMap[event]=obj},ContentScript.prototype.listen=function(eventName,listener,tag){return this.eventMap[eventName],this.listeners[eventName]?this.listeners[eventName].push(listener):(this.listeners[eventName]=[listener],this.sendRequest({request:"listen",eventName:eventName,version:this.version},function(_this){return function(response){if(response==="oldVersion")return siteInjector.onOldVersion()}}(this)))},ContentScript.prototype.stopListening=function(eventName,listener,tag){var i,l;this.eventMap[eventName];if(l=this.listeners[eventName]){i=l.indexOf(listener),i!==-1&&l.splice(i,1);if(!l.length)return this.sendRequest({request:"stopListening",eventName:eventName,version:this.version},function(_this){return function(response){if(response==="oldVersion")return siteInjector.onOldVersion()}}(this)),delete this.listeners[eventName]}},ContentScript.prototype.reloadExtension=function(){return this.triggerBackgroundEvent("reloadExtension")},ContentScript.prototype.triggerBackgroundEvent=function(eventName,args,cb){return this.sendRequest({request:"BackgroundMessage",messageName:eventName,args:args,version:this.version},function(_this){return function(response){return response==="oldVersion"?siteInjector.onOldVersion():typeof cb=="function"?cb(response):void 0}}(this))},ContentScript.prototype.querySelector=function(selector){return document.querySelector(selector)},ContentScript.prototype.querySelectorAll=function(selector){return document.querySelectorAll(selector)},ContentScript.prototype.createElement=function(tag){return document.createElement(tag)},ContentScript.prototype.safeQuerySelector=function(selector){var el;el=this.querySelector(selector);if(el)return el;throw new Error(""+selector+" no found")},ContentScript.prototype.selfQuerySelectorAll=function(selector){var els;els=this.querySelectorAll;if(els.length)return els;throw new Error(""+selector+" not found")},ContentScript}()}});var __slice=[].slice;define("client/SiteInjector",[],function(){return{d:["View","views/ProductOverlayView","Frame","util"],c:function(){var ChangeCapsule,SiteInjector,showingModal,textMap;return showingModal=!1,textMap={AccessWorkspace:"Click on the preview to access the Workspace for this Decision.",AccessProductPortalFromWorkspace:"Click on the product's image to access the Product Portal.",AccessProductPortalFromPopup:"Click on the product's image to access the Product Portal.",Workspace:"The Workspace is an open-ended product comparison environment. It displays the product considerations of a Decision in a fullscreen view. Press the ESC key or click the close button at the top right to exit.","Workspace/Dismiss":"Click the X to dismiss a product you’re considering off to the side. Click a dismissed product to return it.",Select:"Click the checkmark to select the item as one you have chosen among your considerations. The Decision will then be represented by that — as well as any other item you have selected — on the Belt and in the Workspace.","Workspace/ReturnToParent":"You can return to the main Decision by click this thumbnail.","Belt/RemoveItem":"To remove a product from the Belt, simply drag it off.",AddFeeling:"You can record the feelings and thoughts you have about the products you are shopping for. Type a thought or feeling and press enter, or just press ESC to close this dialog and continue on to the next step.",AddData:"You can paste links to blogs, videos, or other websites that have information related to the product and hit enter to add the attached content feed.",AccessEditDescriptor:"Edit your decision.",EditDescriptor:"Describe what you're shopping for."},window._tutorial=function(type,el,args){el==null&&(el=null),args==null&&(args=null);if(showingModal||window.tutorialInProgress)return;return contentScript.triggerBackgroundEvent("tutorialCheck",type,function(showTutorial){var cb,close,closed;if(showTutorial)return close=null,closed=!1,cb=null,args?_.isFunction(args)?(cb=args,args={}):cb=args.cb:args={},el||(args.close=!0),typeof cb=="function"&&cb(function(delay){return delay==null&&(delay=!0),close?close(delay):closed=!0}),setTimeout(function(){var attachEl,connectorEl,currentPosition,distance,elPos,offsetParent,offsetParentPos,pos,position,positionEl,setPosition,text,tipEl;if(closed||showingModal)return;return text=textMap[showTutorial],tipEl=$("<div class='-agora tip'>"+text+"</div>"),tipEl.css({position:"absolute",width:200,opacity:0}),args.close&&(tipEl.addClass("hasClose"),tipEl.append($('<span class="close" />').click(function(){return close(!1),showingModal=!1})),util.tooltip(tipEl.find(".close"),"close")),close=function(delay){return delay==null&&(delay=!0),delay?setTimeout(function(){return close(!1)},300):tipEl.fadeOut(function(){return tipEl.remove()})},el?(position="right",_.isArray(el)&&(_.isArray(type)?el=el[type.indexOf(showTutorial)]:el=el[0]),attachEl=positionEl=null,el.attachEl&&el.positionEl?(attachEl=el.attachEl,positionEl=el.positionEl,el.position&&(position=el.position)):(attachEl=el.parent(),positionEl=el),tipEl.append('<div class="connector" />'),attachEl.append(tipEl),offsetParent=util.positioned(attachEl),offsetParentPos=offsetParent.offset(),elPos=positionEl.offset(),pos={left:elPos.left-offsetParentPos.left,top:elPos.top-offsetParentPos.top},distance=20,currentPosition=null,setPosition=function(position){currentPosition=position;if(position==="right")return tipEl.css({left:pos.left+positionEl.width()+distance,top:pos.top+positionEl.outerHeight()/2-tipEl.outerHeight()/2}),tipEl.offset().left+tipEl.width()<=$(window).width();if(position==="left")return tipEl.css({left:pos.left-tipEl.outerWidth()-distance,top:pos.top+positionEl.outerHeight()/2-tipEl.outerHeight()/2}),tipEl.offset().left>=0;if(position==="top")return tipEl.css({top:pos.top-tipEl.outerHeight()-distance,left:pos.left+positionEl.outerWidth()/2-tipEl.outerWidth()/2}),tipEl.offset().left>=0;if(position==="bottom")return tipEl.css({top:pos.top+positionEl.outerHeight()+distance,left:pos.left+positionEl.outerWidth()/2-tipEl.outerWidth()/2}),tipEl.offset().left>=0},setPosition(position)||(position==="right"?setPosition("left"):position==="top"&&setPosition("bottom")),tipEl.addClass(currentPosition),connectorEl=tipEl.find(".connector"),currentPosition==="left"||currentPosition==="right"?connectorEl.css({top:Math.max(0,Math.min(tipEl.height(),elPos.top-tipEl.offset().top+positionEl.outerHeight()/2-connectorEl.height()/2))}):(currentPosition==="top"||currentPosition==="bottom")&&connectorEl.css({left:Math.max(0,Math.min(tipEl.width(),elPos.left-tipEl.offset().left+positionEl.outerWidth()/2-connectorEl.width()/2))})):(showingModal=!0,tipEl.addClass("modal"),tipEl.appendTo(document.body),tipEl.css({left:$(window).width()/2-tipEl.outerWidth()/2,top:$(window).height()/2-tipEl.outerHeight()/2+$(window).scrollTop()})),tipEl.animate({opacity:1}),setTimeout(function(){return contentScript.triggerBackgroundEvent("tutorialSeen",showTutorial)},500)},50)})},ChangeCapsule=function(){var addChange,changes,func;return changes=[],addChange=function(){var args,type;return type=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],changes.push({type:type,args:args})},func=function(){var args,jq,obj;return args=1<=arguments.length?__slice.call(arguments,0):[],jq=$.apply(null,args),obj={jq:jq,addClass:function(className){return addChange("$.addClass",jq,className),jq.addClass(className),obj},attr:function(name,value){return addChange("$.attr",jq,name,value),jq.attr(name,value),obj},css:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange("$.css",jq,args),jq.css.apply(jq,args),obj},data:function(name,value){return addChange("$.data",jq,name,value),jq.data(name,value),obj},append:function(el){return addChange("$.append",jq,el),jq.append(el),obj},appendTo:function(el){return addChange("$.appendTo",jq,el),jq.appendTo(el),obj},load:function(func){return addChange("$.load",jq,func),jq.load(func),obj},resize:function(func){return addChange("$.resize",jq,func),jq.resize(func),obj},blur:function(func){return addChange("$.blur",jq,func),jq.blur(func),obj},focus:function(func){return addChange("$.focus",jq,func),jq.focus(func),obj},delegate:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange.apply(null,["$.delegate",jq].concat(__slice.call(args))),jq.delegate.apply(jq,args),obj},bind:function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],addChange.apply(null,["$.bind",jq].concat(__slice.call(args))),jq.bind.apply(jq,args),obj},hide:function(){return addChange("$.hide",jq),jq.hide(),obj},disableSelection:function(){return addChange("$.disableSelection",jq),jq.disableSelection(),obj},mouseenter:function(func){return addChange("$.mouseenter",jq,func),jq.mouseenter(func),obj},mouseleave:function(func){return addChange("$.mouseleave",jq,func),jq.mouseleave(func),obj}}},_.extend(func,{setTimeout:function(func,time){var id;return id=setTimeout(func,time),addChange("setTimeout",id),id},setInterval:function(func,time){var id;return id=setInterval(func,time),addChange("setInterval",id),id},undo:function(){var args,i,type,_i,_ref,_ref1,_results;_results=[];for(i=_i=_ref=changes.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i){_ref1=changes[i],type=_ref1.type,args=_ref1.args;switch(type){case"setTimeout":_results.push(clearTimeout(args[0]));break;case"setInterval":_results.push(clearInterval(args[0]));break;case"$.addClass":_results.push(args[0].removeClass(args[1]));break;case"$.attr":_results.push(args[0].removeAttr(args[1]));break;case"$.data":_results.push(args[0].data(args[1],null));break;case"$.append":_results.push($(args[1]).remove());break;case"$.appendTo":_results.push(args[0].remove());break;case"$.load":_results.push(args[0].unbind("load",args[1]));break;case"$.blur":_results.push(args[0].unbind("blur",args[1]));break;case"$.focus":_results.push(args[0].unbind("focus",args[1]));break;case"$.delegate":_results.push(args[0].undelegate(args[1],args[2],args[3]));break;case"$.bind":_results.push(args[0].unbind(args[1],args[2]));break;case"$.hide":_results.push(args[0].show());break;case"$.disableSelection":_results.push(args[0].enableSelection());break;case"$.mouseenter":_results.push(args[0].unbind("mouseenter",args[1]));break;case"$.mouseleave":_results.push(args[0].unbind("mouseleave",args[1]));break;default:_results.push(void 0)}}return _results}}),func},SiteInjector=function(){SiteInjector.prototype.onOldVersion=function(){if(!this.alertedOldVersion)return this.alertedOldVersion=!0,this.shoppingBarView.el.addClass("reload")};function SiteInjector(contentScript,continueTutorial,siteName){this.contentScript=contentScript,this.continueTutorial=continueTutorial,this.siteName=siteName,window.Q=this.c=ChangeCapsule()}return SiteInjector.prototype.waitFor=function(query,cb){var interval,queryString;return interval=0,typeof query=="string"&&(queryString=query,query=function(_this){return function(){return _this.contentScript.querySelector(queryString)}}(this)),this.c.setTimeout(function(_this){return function(){var r;return r=null,(r=query())?cb(r):_this.c.setTimeout(arguments.callee,interval)}}(this),interval)},SiteInjector.prototype.run=function(){return!0},SiteInjector.prototype.initPage=function(cb){var initTimer;return initTimer=this.c.setInterval(function(_this){return function(){var callWhen,callWhenNot,doTutorial,stepStartTime,tutorialDialog,tutorialSteps;if(document.body){Agora.dev&&Q("body").addClass("-agora-dev"),clearInterval(initTimer),cb(),callWhen=function(el,cb){var timerId;return timerId=setInterval(function(){if($(el).length)return cb(),clearInterval(timerId)},50)},callWhenNot=function(el,cb){var timerId;return timerId=setInterval(function(){if(!$(el).length)return cb(),clearInterval(timerId)},50)};if(_this.continueTutorial)return window.tutorialInProgress=!0,window.suppressPopups=!0,tutorialSteps=[function(next){return _this.waitFor(function(){var el;el=$(".-agora.v-shoppingBar .actions .moveUp");if(el.length)return el.offset().top>$(window).height()/2},function(){return _this.c.setTimeout(function(){return tutorialDialog.show($(".v-shoppingBar .actions"),{orientation:"above"},{text:"Now click this back arrow to navigate back out of the Decision to the main level of the Belt where you can create new Decisions or add more products to your existing ones.",audio:"http://files.agora.sh/tutorialaudio/12_01.mp3"}),$(".v-shoppingBar .moveUp").one("click",function(){return setTimeout(next,1e3)})},0)})},function(next){return window.suppressShoppingBarMenu=!1,tutorialDialog.show($(".-agora.v-shoppingBar .actions"),{orientation:"above"},{text:"Now let's quickly learn how collaborative shopping works. First, hover over the <b>Belt Menu</b>.",audio:"http://files.agora.sh/tutorialaudio/13_01.mp3"}),callWhen(".-agora .shoppingBarMenu",next)},function(next){return tutorialDialog.show($(".-agora .shoppingBarMenu .sharedWithYou"),{orientation:"right"},{text:"And click the <b>Shared With You</b> icon.",audio:"http://files.agora.sh/tutorialaudio/14_01.mp3"}),callWhen(".-agora .v-sharedWithYou",next)},function(next){return tutorialDialog.show($(".-agora .v-sharedWithYou"),{orientation:"right"},{text:"<p>This menu lists all the things that have been shared with you. If there are items in the list, you can click the checkmarks to add them to your belt.</p> <p>Click the close button at the top right of the window to continue.</p>",audio:"http://files.agora.sh/tutorialaudio/15_01.mp3"}),callWhenNot(".-agora .v-sharedWithYou",next)},function(next){return tutorialDialog.show($(".-agora.v-shoppingBar .decision"),{orientation:"above"},{text:"Next, click this <b>Decision</b>.",audio:"http://files.agora.sh/tutorialaudio/16_01.mp3"}),callWhen(".-agora.v-shoppingBar.Decision",next)},function(next){return tutorialDialog.show($(".-agora.v-shoppingBar .actions .moveUp"),{orientation:"above"},{text:"Now hover over the <b>back button</b>.",audio:"http://files.agora.sh/tutorialaudio/17_01.mp3"}),callWhen(".-agora .shoppingBarMenu",next)},function(next){return tutorialDialog.show($(".-agora .shoppingBarMenu .collaborate"),{orientation:"right"},{text:"And click the <b>Collaborate</b> icon.",audio:"http://files.agora.sh/tutorialaudio/18_01.mp3"}),callWhen(".-agora .v-collaborate",next)},function(next){var id;return tutorialDialog.show($(".-agora .v-collaborate"),{orientation:"right"},{text:"<p>This window allows you to see the collaborators and activity happening in the Decision. If you’re the owner you can invite or remove collaborators.</p> <p>Invite someone to help you shop or hit the close button at the top left.</p>",audio:"http://files.agora.sh/tutorialaudio/19_01.mp3"}),id=callWhenNot(".-agora .v-collaborate",next),callWhen(".-agora .v-share",function(){return callWhenNot(".-agora .v-share",function(){return clearInterval(id),next()})})},function(next){return tutorialDialog.show({left:$(window).width()/2,top:$(window).height()/4,pointer:!1,width:400},"below",{text:'<p>Congratulations! You\'ve finished the tour. You should now have a basic idea of what Agora is all about.</p> <ul> <li>To learn more, check out our <a target="_blank" href="http://agora.sh/manual.html">user manual</a>.</li> <li>Use Agora on any of our <a target="_blank" href="http://agora.sh/supportedSites.html">supported sites</a>.</li> <li>If you have any questions or comments, you may <a target="_blank" href="http://agora.sh/contact.html">contact us</a>.</li> </ul> <p>Thanks for using Agora, and happy shopping!</p> <a class="virtualHighFive">Virtual High Five!</a>',audio:"http://files.agora.sh/tutorialaudio/20_01.mp3"},function(){return tutorialDialog.frameEl.find(".virtualHighFive").click(function(){return next(),tutorialDialog.close()})}),_this.contentScript.triggerBackgroundEvent("tutorialFinished"),delete window.tutorialInProgress,delete window.suppressPopups}],stepStartTime=null,doTutorial=function(i){i>0&&(console.debug("time",i+11,(new Date).getTime()-stepStartTime),tracking.time("Tutorial","Step"+(i+11),(new Date).getTime()-stepStartTime));if(tutorialSteps[i])return this.contentScript.triggerBackgroundEvent("tutorialStep",i+12),stepStartTime=(new Date).getTime(),console.debug(i+12),tutorialSteps[i](function(){return doTutorial(i+1)})},tutorialDialog=new TutorialDialog(20,12),window.suppressShoppingBarMenu=!0,$(function(){return doTutorial(0)})}}}(this),200)},SiteInjector.prototype.startContentClipping=function(){return $("body").removeClass("-agora-disabled"),util.showDialog(function(_this){return function(){var addDataView;return addDataView=new AddDataView(_this.contentScript,{type:"drag",url:document.location.href,title:document.title}),addDataView.shoppingBarView=_this,addDataView}}(this))},SiteInjector.prototype.toggle=function(){return $("body").toggleClass("-agora-disabled")},SiteInjector.prototype.clearProductEl=function(el){return el=$(el),util.terminateDragging(el),el.data("agora")&&(el.data("agora").overlayView&&el.data("agora").overlayView.destruct(),el.removeData("agora")),el.removeAttr("agora")},SiteInjector.prototype.initProductEl=function(el,productData,opts){return opts==null&&(opts={}),this.products(el,productData,opts)},SiteInjector.prototype.removeOverlay=function(attachEl){var _ref;return(_ref=attachEl.data("overlay"))!=null&&typeof _ref.destruct=="function"&&_ref.destruct(),attachEl.removeAttr("agora")},SiteInjector.prototype.attachOverlay=function(opts){var productOverlay,_ref;if(opts.attachEl.attr("agora"))return;return"siteName"in opts.productData||(opts.productData.siteName=this.siteName),Q(opts.attachEl).attr("agora",!0),productOverlay=new ProductOverlayView(contentScript,opts.productData,null,{attachEl:opts.attachEl,positionEl:opts.positionEl,hovering:opts.hovering,position:(_ref=opts.position)!=null?_ref:"topRight"}),opts.overlayZIndex!=null&&productOverlay.el.css("zIndex",opts.overlayZIndex),productOverlay.represent(opts.productData),typeof this.initOverlay=="function"&&this.initOverlay(productOverlay),typeof opts.init=="function"?opts.init(productOverlay):void 0},SiteInjector.prototype.products=function(selector,productData,opts){var a,config,contentScript,el,productOverlay,variant,_ref;opts==null&&(opts={}),variant=null,productData.variant&&(variant=productData.variant,delete productData.variant),el=$(selector);if(el.attr("agora")){if(!!el.data("agora"))return;el.parents("a").removeAttr("agora"),ProductOverlayView.clear(el)}opts.image==null&&(opts.image=!0),opts.overlay==null&&(opts.overlay=!0),"siteName"in productData||(productData.siteName=this.siteName),Q(el).attr("productSid",productData.productSid),contentScript=this.contentScript,config=this.config,Q(el).data("agora",{opts:opts}),Q(el).attr("agora",!0);if(opts.overlay&&(config!=null?config.productBadges:void 0)!==!1){a=el.parents("a");if(a.length===0||!a.attr("agora"))a.length&&Q(a).attr("agora",!0),productOverlay=new ProductOverlayView(contentScript,_.clone(productData),el.get(0),{hovering:opts.hovering,extra:opts.extraOverlayElements,position:(_ref=opts.overlayPosition)!=null?_ref:"topRight"}),opts.overlayZIndex!=null&&productOverlay.el.css("zIndex",opts.overlayZIndex),productOverlay.represent(_.clone(productData)),typeof this.initOverlay=="function"&&this.initOverlay(productOverlay),typeof opts.initOverlay=="function"&&opts.initOverlay(productOverlay),el.data("agora").overlayView=productOverlay}if(opts.image)return util.initDragging(el,{acceptsDrop:!1,affect:!1,context:"page",helper:function(event){return $('<div class="-agora -agora-productClip t-item dragging" style="position:absolute"> <span class="p-image"></span> <div class="g-productInfo"> <span class="p-title">loading...</span> <span class="p-site">loading...</span> <span class="p-price">loading...</span> </div> </div>')},start:function(_this){return function(event,ui){var clip,clipTimerId,image,item,itemState,marginLeft,marginTop,offsetX,offsetY,payload,payloadCb,price,sendPayload,site,size,target,title,view;return shoppingBarView.startDrag(),tracking.event("Site","dragProduct",opts.area),target=$(event.currentTarget),target.css({opacity:.25}),image=ui.helper.find(".p-image"),image.css({backgroundImage:"url('"+target.attr("src")+"')",width:target.width(),height:target.height()}),title=ui.helper.find(".p-title"),site=ui.helper.find(".p-site"),price=ui.helper.find(".p-price"),view=new View(_this.contentScript),view.type="ProductClip",view.onData=function(data){return data.title.get()&&title.html(data.title.get()),view.observe(data.title,function(mutation){return title.html(mutation.value)}),data.site.get()&&site.html(data.site.get()),view.observe(data.site,function(mutation){return site.html(mutation.value)}),data.price.get()&&price.html(data.price.get()),view.observe(data.price,function(mutation){return price.html(mutation.value)})},sendPayload=null,payload=null,payloadCb=function(cb){return payload?cb(payload):sendPayload=cb},ui.helper.data("dragging").data=payloadCb,marginLeft=marginTop=0,offsetX=event.pageX-target.offset().left+marginLeft,offsetY=event.pageY-target.offset().top+marginTop,ui.helper.css({marginLeft:marginLeft,width:target.width(),height:target.height(),zIndex:999999}),ui.helper.find(".g-productInfo").css({opacity:0}),size={width:48,height:48},clip=function(){var curve,time;return time=200,curve=null,ui.helper.animate({marginLeft:offsetX-size.width*.9,marginTop:offsetY-size.height*.9,width:148,height:size.height},time,curve),image.animate({width:44,height:44},time,curve),setTimeout(function(){if(!itemState)return ui.helper.find(".g-productInfo").animate({opacity:1},time,curve)},time)},itemState=!1,item=function(){var time;return itemState=!0,time=300,image.animate({width:44,height:44},time),ui.helper.find(".g-productInfo").stop(!0).animate({opacity:0},time,function(){}),ui.helper.stop(!0).animate({width:size.width,height:size.height,marginLeft:offsetX-size.width/2,marginTop:offsetY-size.height/2},time)},productData.elementType="Product",_.isFunction(variant)?productData.variant=variant():variant!=null&&(productData.variant=variant),productData.variant&&console.debug("variant: %s",productData.variant),sendPayload?sendPayload(productData):payload=productData,view.represent(productData),ui.args.onDraggedOver=function(el){return el?(clearTimeout(clipTimerId),itemState||item(),ui.helper.addClass("adding")):ui.helper.removeClass("adding")},ui.args.stop=function(event,ui){return shoppingBarView.stopDrag(),view.destruct(),target.animate({opacity:1},"linear"),ui.helper.animate({marginLeft:offsetX,marginTop:offsetY,width:10,height:10,opacity:0},100,"linear",function(){return ui.helper.remove()})},clipTimerId=setTimeout(clip,100)}}(this)})},SiteInjector}()}}}),define("siteConfig",{Amazon:{hasProductClass:!0,slug:"amazon",hosts:["www.amazon.com"],scraper:!0,currency:"dollar",icon:"http://www.amazon.com/favicon.ico",productUrl:function(sid){return"http://www.amazon.com/gp/product/"+sid},query:function(product){return{sku:product.get("productSid")}}},AmericanApparel:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"americanapparel",hosts:["store.americanapparel.net"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://i.americanapparel.net/static/atg/1.22.0/media/favicons/favicon_blue.ico",twoTap:!0},Asos:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"asos",hosts:["us.asos.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.asos.com/favicon.ico",twoTap:!0},BarnesAndNoble:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"barnesandnoble",hosts:["www.barnesandnoble.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.barnesandnoble.com/favicon.ico"},BestBuy:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"bestbuy",hosts:["www.bestbuy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.bestbuy.com/favicon.ico"},Bloomingdales:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"bloomingdales",hosts:["www1.bloomingdales.com","www.bloomingdales.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.bloomingdales.com/favicon.ico",twoTap:!0},ColdwaterCreek:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"coldwatercreek",hosts:["www.coldwatercreek.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.coldwatercreek.com/favicon.ico"},Costco:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"costco",hosts:["www.costco.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.costco.com/favicon.ico"},Dev:{hasProductClass:!0,hosts:["agoraext.local","baggg.it","agora.local","ext.agora.dev"],productUrl:function(sid){return"#"+sid}},Diapers:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"diapers",hosts:["www.diapers.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.diapers.com/favicon.ico"},Ebay:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"ebay",hosts:["www.ebay.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.ebay.com/favicon.ico",productUrl:function(sid){return""}},Etsy:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"etsy",hosts:["www.etsy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.etsy.com/favicon.ico",productUrl:function(sid){return"http://www.etsy.com/listing/"+sid}},Express:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"express",hosts:["www.express.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.express.com/favicon.ico"},Fab:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"fab",hosts:["fab.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://fab.com/favicon.ico"},Fancy:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"fancy",hosts:["fancy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://fancy.com/favicon.ico"},FashionBug:{excludedFeatures:["offers","deals","reviews"],hasProductClass:!1,slug:"fashionbug",hosts:["www.fashionbug.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.fashionbug.com/favicon.ico"},Forever21:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"forever21",hosts:["www.forever21.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.foreve21.com/favicon.ico",twoTap:!0},FreePeople:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"freepeople",hosts:["www.freepeople.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.freepeople.com/favicon.ico",twoTap:!0},Gap:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"gap",hosts:["www.gap.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.gap.com/favicon.ico",productUrl:function(sid){return""}},General:{slug:"general",currency:"embedded",scraper:!0,enabled:"check",offersPane:!1},HM:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"hm",hosts:["www.hm.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.hm.com/favicon.ico"},HomeDepot:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"homedepot",hosts:["www.homedepot.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.homedepot.com/favicon.ico",productUrl:function(sid){return""}},JCPenney:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"jcpenney",hosts:["www.jcpenney.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.jcpenney.com/favicon.ico",productUrl:function(sid){return""}},JCrew:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"jcrew",hosts:["www.jcrew.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.jcrew.com/favicon.ico",twoTap:!0},KateSpade:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"katespade",hosts:["www.katespade.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.katespade.com/favicon.ico",twoTap:!0},Kmart:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"macys",hosts:["www.kmart.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.kmart.com/favicon.ico",productUrl:function(sid){return""}},Kohls:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"kohls",hosts:["www.kohls.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.kohls.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},LLBean:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"llbean",hosts:["www.llbean.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.llbean.com/favicon.ico"},LandsEnd:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"landsend",hosts:["www.landsend.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.landsend.com/favicon.ico"},LuLus:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"lulus",hosts:["www.lulus.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://cdn.lulus.com/images/icons/favicon.ico",twoTap:!0},Macys:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"macys",hosts:["www.macys.com","www1.macys.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.macys.com/favicon.ico",productUrl:function(sid){return""}},MakeMeChic:{excludedFeatures:["offers","deals","reviews"],hasProductClass:!0,slug:"makemechic",hosts:["www.makemechic.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.makemechic.com/favicon.ico"},ModCloth:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"modcloth",hosts:["www.modcloth.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.modcloth.com/favicon.ico",twoTap:!0},NastyGal:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"nastygal",hosts:["www.nastygal.com","nastygal.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://assets.nastygal.com/assets/current/images/favicon/favicon-32.png",twoTap:!0},Newegg:{excludedFeatures:["offers","deals","reviews","rating"],hasMore:!1,slug:"newegg",hosts:["www.newegg.com"],currency:"dollar",scraper:!0,icon:"http://www.newegg.com/favicon.ico",productUrl:function(sid){},query:function(product){var details,model,more,name,section,value,_ref;more=product.get("more"),model=null,_ref=more.details;for(section in _ref){details=_ref[section];for(name in details){value=details[name];if(name==="Model"){model=value;break}}if(model)break}return{sku:product.get("productSid"),brand:product.get("more").brand.name,model:model}}},Nordstrom:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"nordstrom",hosts:["shop.nordstrom.com","www.nordstrom.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.nordstrom.com/favicon.ico",twoTap:!0},Overstock:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"overstock",hosts:["www.overstock.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.overstock.com/favicon.ico",productUrl:function(sid){return""}},QVC:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"qvc",hosts:["www.qvc.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.qvc.com/favicon.ico"},Rakuten:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"rakuten",hosts:["www.rakuten.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.rakuten.com/favicon.ico"},Rei:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"rei",hosts:["www.rei.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.rei.com/favicon.ico"},RentTheRunway:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"renttherunway",hosts:["www.renttherunway.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.renttherunway.com/favicon.ico"},SamsClub:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"samsclub",hosts:["www.samsclub.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.samsclub.com/favicon.ico"},Sears:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"sears",hosts:["www.sears.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.sears.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},Singer22:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"singer22",hosts:["www.singer22.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.singer22.com/favicon.ico"},SixPM:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"6pm",hosts:["www.6pm.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.6pm.com/favicon.ico"},Soap:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"soap",hosts:["www.soap.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.soap.com/favicon.ico"},Target:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"target",hosts:["www.target.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.target.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},TheLimited:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"thelimited",hosts:["www.thelimited.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.thelimited.com/favicon.ico",twoTap:!0},ToysRUs:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"toysrus",hosts:["www.toysrus.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.toysrus.com/favicon.ico"},Tutorial:{hosts:["tutorial.agora"]},Uniqlo:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"uniqlo",hosts:["www.uniqlo.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.uniqlo.com/favicon.ico"},VictoriasSecret:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"victoriassecret",hosts:["www.victoriassecret.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.victoriassecret.com/favicon.ico"},Walgreens:{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"walgreens",hosts:["www.walgreens.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.walgreens.com/favicon.ico"},Webapp:{hosts:["webapp.agora","webapp.agora.dev","66.228.54.96","agora.sh/view/"],productUrl:function(sid){return"#"+sid}},WetSeal:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"wetseal",hosts:["www.wetseal.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.wetseal.com/favicon.ico",twoTap:!0},WomanWithin:{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"womanwithin",hosts:["www.womanwithin.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.womanwithin.com/favicon.ico"},Zappos:{excludedFeatures:["deals","offers"],hasProductClass:!0,slug:"zappos",hosts:["www.zappos.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.zappos.com/favicon.ico",productUrl:function(sid){var colorId,productId,_ref;return _ref=sid.split("-"),productId=_ref[0],colorId=_ref[1],colorId?"http://www.zappos.com/viewProduct.do?productId="+productId+"&colorId="+colorId:"http://www.zappos.com/viewProduct.do?productId="+productId},query:function(product){return{brand:product.get("more").brand.name,title:product.get("more").name}}}});var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("Site",["underscore","siteConfig"],function(_,siteConfig){var Site;return Site=function(){Site.productClasses={},Site.sites={},Site.siteForUrl=function(url){var config,name,part,_i,_len,_ref,_ref1;url=(_ref=url.match("^https?://(.*)$"))!=null?_ref[1]:void 0;if(url)for(name in siteConfig){config=siteConfig[name];if(config.hosts){_ref1=config.hosts;for(_i=0,_len=_ref1.length;_i<_len;_i++){part=_ref1[_i];if(url.substr(0,part.length)===part)return this.site(name,part)}}}return null},Site.site=function(name,host){var config,matches;if(matches=name.match(/^General\/(.*)$/))return new Site("General",siteConfig.General,matches[1]);if(this.sites[""+name+";"+host])return this.sites[""+name+";"+host];config=siteConfig[name];if(config)return this.sites[""+name+";"+host]=new Site(name,config,host);throw new Error("No site '"+name+"'")},Site.productSid=function(background,url,cb){var site;return site=this.siteForUrl(url),site.productSid(background,url,cb)},Site.siteById=function(id){var host,name,site,_ref;return site=this.site(id),site||(_ref=id.split("/"),name=_ref[0],host=_ref[1],site=this.site(name,host)),site},Site.id=0;function Site(name,config,host){var allFeatures;this.name=name,this.config=config,this.host=host,this.nid=Site.id++,this.hosts=config.hosts,this.icon=config.icon,this.url="http://agora.sh/site.php?name="+this.name,allFeatures=["offers","reviews","rating"],this.features=config.excludedFeatures?_.difference(allFeatures,config.excludedFeatures):allFeatures,this._productScraper={}}return Site.prototype.hasFeature=function(feature){return __indexOf.call(this.features,feature)>=0},Site.prototype.id=function(){return this.name==="General"?""+this.name+"/"+this.host:this.name},Site.prototype.getSiteInjector=function(background,cb){var siteInjectorName;return siteInjectorName=""+this.name+"SiteInjector",background.require(["sites/"+this.name+"/"+siteInjectorName],function(_this){return function(siteInjector){return cb(siteInjector,_this)}}(this))},Site.prototype.getSiteScraper=function(background,cb){var siteScraperName;return siteScraperName=""+this.name+"SiteScraper",background.require(["sites/"+this.name+"/"+siteScraperName],function(siteScraper){return cb(siteScraper)})},Site.prototype.productScraperClass=function(background,cb){var productScraperName;return productScraperName=""+this.name+"ProductScraper",background.require(["sites/"+this.name+"/"+productScraperName],function(productScraper){return cb(productScraper)})},Site.prototype.productSid=function(background,url,cb,retrievalId){return this.productScraperClass(background,function(_this){return function(productScraper){return productScraper.productSid(background,url,cb,retrievalId)}}(this))},Site.prototype.productScraper=function(background,productSid,cb){var _ref,_ref1;return((_ref=this._productScraper)!=null?_ref[productSid]:void 0)?cb((_ref1=this._productScraper)!=null?_ref1[productSid]:void 0):(this.cbs==null&&(this.cbs={}),this.cbs[productSid]?this.cbs[productSid].push(cb):(this.cbs[productSid]=[cb],this.productScraperClass(background,function(_this){return function(productScraper){var scraper,_i,_len,_ref2;_this._productScraper[productSid]=scraper=new productScraper(_this,productSid,background),_ref2=_this.cbs[productSid];for(_i=0,_len=_ref2.length;_i<_len;_i++)cb=_ref2[_i],cb(scraper);return delete _this.cbs[productSid]}}(this))))},Site.prototype.productUrl=function(sid){return this.config.productUrl(sid)},Site.prototype.product=function(background,product,cb){var productClassName,siteProduct;return this.config.hasProductClass?Site.productClasses[this.name]?(siteProduct=new Site.productClasses[this.name](product),siteProduct.site=this,cb(siteProduct)):(productClassName=""+this.name+"Product",background.require(["sites/"+this.name+"/"+productClassName],function(_this){return function(productClass){return Site.productClasses[_this.name]=productClass,siteProduct=new productClass(product),siteProduct.site=_this,cb(siteProduct)}}(this))):cb()},Site}()}),define("clientInterface/IArray",["underscore"],function(_){var IArray;return IArray=function(){function IArray(){this._array=[],this.length=0}return IArray.prototype.get=function(pos){return this._array[pos]},IArray.prototype.setArray=function(array){var el,i,_i,_len,_results;while(this.length)this["delete"]();_results=[];for(i=_i=0,_len=array.length;_i<_len;i=++_i)el=array[i],_results.push(this.insert(el,i));return _results},IArray.prototype["delete"]=function(pos){return this._array.splice(pos,1),--this.length},IArray.prototype.insert=function(el,pos){return pos===0?this._array.unshift(el):pos===this._array.length?this._array.push(el):this._array.splice(pos,0,el),++this.length},IArray.prototype.push=function(el){return this._array.insert(el,this._array.length)},IArray.prototype.each=function(cb){return _.each(this._array,cb)},IArray.prototype.forEach=function(cb){return this.each(cb)},IArray.prototype.move=function(from,to){var el;if(from!==to)return el=this._array.splice(from,1)[0],this._array.splice(to,0,el)},IArray}()}),define("clientInterface/ClientObject",["underscore","./IArray"],function(_,IArray){var ClientObject;return ClientObject=function(){ClientObject._nextId=1,ClientObject._registry={},ClientObject.nextId=function(){return this._nextId++},ClientObject.serialize=function(obj){var key,newArray,newObject,value;if(_.isArray(obj))return newArray=[],_.each(obj,function(_this){return function(el){return newArray.push(_this.serialize(el))}}(this)),newArray;if(_.isObject(obj)){if(obj instanceof ClientObject)return obj.serialize();if(obj instanceof IArray)return this.serialize(obj._array);newObject={};for(key in obj)value=obj[key],newObject[key]=this.serialize(value);return newObject}return obj};function ClientObject(agora,_owner){this.agora=agora,this._owner=_owner,this._id=ClientObject.nextId(),ClientObject._registry[this._id]=this}return ClientObject.prototype.radioSilence=function(block){return this._radioSilence=!0,block(),this._radioSilence=!1},ClientObject.prototype._triggerEvent=function(event,args){if(!this._radioSilence)return this.agora.background.triggerContentScriptEvent("ClientObjectEvent:"+this._id,_.extend({event:event},this._name?_.extend({name:this._name},args):args),this.debug)},ClientObject.prototype._triggerMutationEvent=function(type,args){return this._triggerEvent("mutation",_.extend({type:type},args))},ClientObject.prototype.disconnectClient=function(){return this._triggerEvent("disconnection")},ClientObject.prototype.serialize=function(){var obj;return obj={_id:this._id},this._name&&(obj._name=this._name),obj},ClientObject.prototype.destruct=function(){return ClientObject._registry[this._id]=!1,this.disconnectClient()},ClientObject}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("clientInterface/ClientArray",["underscore","./ClientObject","./IArray"],function(_,ClientObject,IArray){var ClientArray;return ClientArray=function(_super){__extends(ClientArray,_super);function ClientArray(){ClientArray.__super__.constructor.apply(this,arguments),this._array=new IArray}return ClientArray.prototype.get=function(pos){return this._array.get(pos)},ClientArray.prototype.setArray=function(array){return this._array.setArray(array),this._triggerMutationEvent("setArray",{array:ClientObject.serialize(this._array)})},ClientArray.prototype["delete"]=function(pos){return this._array["delete"](pos),this._triggerMutationEvent("deletion",{position:pos})},ClientArray.prototype.insert=function(el,pos){return this._array.insert(el,pos),this._triggerMutationEvent("insertion",{value:ClientObject.serialize(el),position:pos})},ClientArray.prototype.move=function(from,to){return this._array.move(from,to),this._triggerMutationEvent("movement",{from:from,to:to})},ClientArray.prototype.push=function(el){return this.insert(el,this._array.length)},ClientArray.prototype.serialize=function(){var obj;return obj=ClientArray.__super__.serialize.apply(this,arguments),_.extend(obj,{__class__:"ClientArray",_array:ClientObject.serialize(this._array)})},ClientArray}(ClientObject)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("clientInterface/ClientValue",["./ClientObject"],function(ClientObject){var ClientValue;return ClientValue=function(_super){__extends(ClientValue,_super);function ClientValue(agora,owner,_value){this._value=_value,ClientValue.__super__.constructor.apply(this,arguments)}return ClientValue.prototype.get=function(){return this._value},ClientValue.prototype.set=function(value,timestamp){timestamp==null&&(timestamp=!1);if(typeof value=="object"||value!==this._value||timestamp)return this._triggerMutationEvent("assignment",{oldValue:ClientObject.serialize(this._value),value:ClientObject.serialize(value),timestamp:timestamp}),this._value=value},ClientValue.prototype.trigger=function(){return this._triggerMutationEvent("assignment",{oldValue:ClientObject.serialize(this._value),value:ClientObject.serialize(this._value)})},ClientValue.prototype.serialize=function(){var obj;return obj=ClientValue.__super__.serialize.apply(this,arguments),_.extend(obj,{__class__:"ClientValue",_scalar:ClientObject.serialize(this._value)})},ClientValue}(ClientObject)}),define("model/ObservableObject",["underscore","Debug"],function(_,Debug){var ObservableObject;return ObservableObject=function(){function ObservableObject(){}return ObservableObject.prototype.clearObservers=function(){return this.observers=[],this.tags=[]},ObservableObject.prototype.observeWithTag=function(tag,observer){return this.observe(observer,tag)},ObservableObject.prototype.observe=function(observer,tag){var observers;tag==null&&(tag=null);if(!observer)throw new Error("bad!");return observers=this.observers,observers||(this.observers=observers=[],this.tags=[]),observers.push(observer),this.tags.push({tag:tag})},ObservableObject.radioSilence=function(block){return this._radioSilence=!0,block(),this._radioSilence=!1},ObservableObject.pause=function(){return this.paused=!0,this.queue=[]},ObservableObject.resume=function(){var obj,observable,observers,_i,_len,_ref,_ref1;this.paused=!1,_ref=this.queue;for(_i=0,_len=_ref.length;_i<_len;_i++)_ref1=_ref[_i],observable=_ref1.observable,observers=_ref1.observers,obj=_ref1.obj,this._call(observable,observers,obj);return delete this.queue},ObservableObject._call=function(observable,observers,obj){var observer,_i,_len,_results;_results=[];for(_i=0,_len=observers.length;_i<_len;_i++)observer=observers[_i],_results.push(observer(obj));return _results},ObservableObject.prototype.stopObservingWithTag=function(tag){var index;if(this.observers){index=this.tags.indexOf(tag);if(index!==-1)return this.observers.splice(index,1),this.tags.splice(index,1)}},ObservableObject.prototype.stopObserving=function(observer){var index;if(this.observers){index=this.observers.indexOf(observer);if(index!==-1)return this.observers.splice(index,1),this.tags.splice(index,1)}},ObservableObject.prototype._callObservers=function(obj){if(this.observers)return ObservableObject.paused?ObservableObject.queue.push({observable:this,observers:_.clone(this.observers),obj:obj}):ObservableObject._call(this,_.clone(this.observers),obj)},ObservableObject.prototype._fireMutation=function(type,mutationInfo){if(!ObservableObject._radioSilence)return this._callObservers(_.extend({type:type},mutationInfo))},ObservableObject.prototype.clear=function(){return this.clearObservers()},ObservableObject}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/ObservableValue",["./ObservableObject","underscore"],function(ObservableObject,_){var ObservableValue;return ObservableValue=function(_super){__extends(ObservableValue,_super);function ObservableValue(_value,_reassignIdentical){this._value=_value,this._reassignIdentical=_reassignIdentical!=null?_reassignIdentical:!1}return ObservableValue.prototype.test=function(value){return this._reassignIdentical?!0:this._type==="object"?!_.isEqual(value,this._value):value!==this._value},ObservableValue.prototype.set=function(value,timestamp){var oldValue;if(this.test(value))return oldValue=this._value,this._value=value,this._fireMutation("set",{value:value,oldValue:oldValue,timestamp:timestamp})},ObservableValue.prototype.get=function(){return this._value},ObservableValue.prototype["with"]=function(cb){return this._value!==null?cb(this._value):this.observe(function(_this){return function(){if(_this._value!==null)return cb(_this._value),_this.stopObserving(arguments.callee)}}(this))},ObservableValue}(ObservableObject)}),define("ObjectWrapper",["model/ObservableValue"],function(ObservableValue){var ObjectWrapper;return ObjectWrapper=function(){ObjectWrapper.create=function(storeId,object,defaults){return new ObjectWrapper(storeId,object,defaults)},ObjectWrapper.prototype.getObject=function(){if(this.object==="@")return agora.modelManager.getInstance("User","G"+this.storeId)},ObjectWrapper.prototype.field=function(name){return this.fields[name]},ObjectWrapper.prototype.get=function(name){var id,table,_ref;if(name==="id"){if(this.object==="@")return"G"+this.storeId;if(this.object==="/")throw new Error;return _ref=this.object.split("."),table=_ref[0],id=_ref[1],"G"+id}return this.fields[name].get()},ObjectWrapper.prototype.saneId=function(){return parseInt(this.get("id").substr(1))};function ObjectWrapper(storeId,object,values){var name,value,_ref;this.storeId=storeId,this.object=object,this.values=values,this.empty=!0,this.fields={},_ref=this.values;for(name in _ref)value=_ref[name],this.fields[name]=new ObservableValue(value);this.whenObject=agora.updater.transport.whenObject(this.storeId,[this.object],function(_this){return function(){var field,_ref1,_results;_this.empty=!1,_this.obj=_this.getObject(),_ref1=_this.fields,_results=[];for(name in _ref1)field=_ref1[name],_results.push(field.set(_this.obj.get(name)));return _results}}(this),function(_this){return function(){var field,_ref1,_results;_this.empty=!0,_ref1=_this.fields,_results=[];for(name in _ref1)field=_ref1[name],_results.push(field.set(_this.values[name]));return _results}}(this))}return ObjectWrapper.prototype.destruct=function(){return agora.updater.transport.unregisterWhenObject(this.whenObject)},ObjectWrapper}()});var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("util",["Site","underscore","ObjectWrapper"],function(Site,_,ObjectWrapper){var util;return util={syncArrays:function(ctx,a,b,mapping){var setRemoveCallback;return setRemoveCallback=function(cb,position){return b.__removeCallback==null&&(b.__removeCallback=[]),b.__removeCallback[position]=cb},a.each(function(el,i){return b.push(mapping(el,function(cb){return setRemoveCallback(cb,i)},i))}),b.__syncedTo=a,ctx.observe(a,b.__syncObserver=function(mutation){var _name,_ref;if(mutation.type==="insertion")return b.insert(mapping(mutation.value,function(cb){return setRemoveCallback(cb,mutation.position)},mutation.position),mutation.position);if(mutation.type==="deletion")return(_ref=b.__removeCallback)!=null&&typeof _ref[_name=mutation.position]=="function"&&_ref[_name](),b["delete"](mutation.position);if(mutation.type==="movement")return b.move(mutation.from,mutation.to)})},unsyncArrays:function(a,b){return a.stopObserving(b.__syncObserver),delete b.__syncObserver},unsync:function(array){return this.unsyncArrays(array.__syncedTo,array)},reorder:function(list,fromIndex,toIndex){var i,instance,_i,_j,_ref,_ref1;instance=list.get(fromIndex);if(toIndex>fromIndex)for(i=_i=_ref=fromIndex+1;_ref<=toIndex?_i<=toIndex:_i>=toIndex;i=_ref<=toIndex?++_i:--_i)list.get(i).set("index",i-1);else if(fromIndex>toIndex)for(i=_j=_ref1=fromIndex-1;_ref1<=toIndex?_j<=toIndex:_j>=toIndex;i=_ref1<=toIndex?++_j:--_j)list.get(i).set("index",i+1);return instance.set("index",toIndex)},addElement:function(obj,element){return obj.get("contents").add(util.resolveObject(element))},resolveObject:function(element){return _.isFunction(element.getObj)?element.getObj():element.obj?element.obj:element.modelName.match(/Element$/)?element.get("element"):element},feelingEmotionString:function(feeling){var emotion,i,_i,_j,_ref,_ref1;emotion="";for(i=_i=0,_ref=feeling.get("positive");0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)emotion+="+";for(i=_j=0,_ref1=feeling.get("negative");0<=_ref1?_j<_ref1:_j>_ref1;i=0<=_ref1?++_j:--_j)emotion+="-";return emotion},listPreview:function(ctx,list){var clientList,getContents,reset;return clientList=ctx.clientArray(),getContents=function(_this){return function(){var contents,obj,sources,stack,state,_ref;stack=[{list:list,pos:0}],contents=[],sources=[list];while(stack.length&&contents.length<4){state=stack[stack.length-1];if(state.list.length()===state.pos){stack.pop();continue}obj=state.list.get(state.pos++).get("element");for(;;){(_ref=obj.modelName)==="Product"||_ref==="ProductVariant"?(contents.push(obj.getDisplayValue("image")),sources.push(obj.field("image"))):obj.modelName==="Decision"?(stack.push({list:obj.get("selection"),pos:0}),sources.push(obj.get("selection"))):obj.modelName==="Bundle"&&(stack.push({list:obj.get("elements"),pos:0}),sources.push(obj.get("elements")));break}}return[contents,sources]}}(this),reset=function(_this){return function(){var contents,source,sources,_i,_len,_ref;ctx.clear(),_ref=getContents(),contents=_ref[0],sources=_ref[1];for(_i=0,_len=sources.length;_i<_len;_i++)source=sources[_i],ctx.observe(source,function(mutation){return reset()});return clientList.setArray(contents)}}(this),reset(),clientList},dismissDecisionElement:function(decision,element){return decision.get("dismissed").add(element)},lastFeeling:function(ctx,product,lastFeelingCv){var updateLastFeeling;return lastFeelingCv==null&&(lastFeelingCv=null),lastFeelingCv==null&&(lastFeelingCv=ctx.clientValue()),updateLastFeeling=function(_this){return function(){var emotion,feelings,lastFeeling;return feelings=product.get("feelings"),lastFeeling=feelings.length()?feelings.get(feelings.length()-1):void 0,lastFeeling?(emotion=util.feelingEmotionString(lastFeeling),lastFeelingCv.set({thought:lastFeeling.get("thought"),positive:lastFeeling.get("positive"),negative:lastFeeling.get("negative")})):lastFeelingCv.set(null)}}(this),updateLastFeeling(),ctx.observe(product.get("feelings"),updateLastFeeling),lastFeelingCv},lastArgument:function(ctx,product,lastArgumentCv){var updateLastArgument;return lastArgumentCv==null&&(lastArgumentCv=ctx.clientValue()),updateLastArgument=function(_this){return function(){var arguments_,lastArgument;return arguments_=product.get("arguments"),lastArgument=arguments_.length()?arguments_.get(arguments_.length()-1):void 0,lastArgument?lastArgumentCv.set({thought:lastArgument.get("thought"),"for":lastArgument.get("for"),against:lastArgument.get("against")}):lastArgumentCv.set(null)}}(this),updateLastArgument(),ctx.observe(product.get("arguments"),updateLastArgument),lastArgumentCv},feelings:function(parentCtx,obj){return parentCtx.clientArray(obj.get("feelings"),function(_this){return function(feeling,onRemove){var ctx,emotion;return ctx=parentCtx.context(),onRemove(function(){return ctx.destruct()}),emotion=util.feelingEmotionString(feeling),{id:feeling.get("id"),negative:ctx.clientValue(feeling.field("negative")),positive:ctx.clientValue(feeling.field("positive")),thought:ctx.clientValue(feeling.field("thought"))}}}(this))},arguments:function(parentCtx,obj){return parentCtx.clientArray(obj.get("arguments"),function(_this){return function(argument,onRemove){var ctx;return ctx=parentCtx.context(),onRemove(function(){return ctx.destruct()}),{id:argument.get("id"),"for":ctx.clientValue(argument.field("for")),against:ctx.clientValue(argument.field("against")),thought:ctx.clientValue(argument.field("thought"))}}}(this))},resolveProducts:function(obj,p){var id,objs;return p==null&&(p=!1),obj.isA("Product")?[obj]:obj.isA("Bundle")?(objs=[],id=obj.get("id"),obj.get("elements").each(function(el){return objs=objs.concat(util.resolveProducts(el.get("element"),id))}),objs):obj.isA("Decision")?(objs=[],obj.get("selection").each(function(el){return objs=objs.concat(util.resolveProducts(el.get("element")))}),objs):[]},observeContents:function(ctx,elements,cb){var observeElement,observeObj;return observeElement=function(el){return ctx.observe(el.get("element"),function(){return observeObj(el.get("element")),cb()}),observeObj(el.get("element"))},observeObj=function(obj){var els;if(obj.isA("Bundle")||obj.isA("Decision"))return els=obj.isA("Decision")?obj.get("selection"):obj.get("elements"),util.observeContents(ctx,els,cb)},ctx.observe(elements,function(mutation){return mutation.type==="insertion"&&observeElement(mutation.value),cb()}),elements.each(function(el){return observeElement(el)})},numberWithCommas:function(x){var parts;if(x!=null)return parts=x.toString().split("."),parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),parts.join(".")},stripHtml:function(html,tags,baseUrl){return tags==null&&(tags=null),baseUrl==null&&(baseUrl=null),_.isString(html)?(tags==null&&(tags=["h1","h2","h3","h4","p","small","b","small","a","br","em","ul","li"]),html.replace(/<\s*(\/?)\s*(\w*)([^>]*)>/g,function(match,slash,tag,attrs){var field,matches,newAttrs,value;return tag=tag.toLowerCase(),__indexOf.call(tags,tag)>=0?slash?"</"+tag+">":(newAttrs={},tag==="a"?(matches=attrs.match(/href\s*=\s*"([^"]*)"/),matches&&(newAttrs.href=util.url(matches[1],baseUrl),newAttrs.target="_blank")):tag==="img"&&(matches=attrs.match(/src\s*=\s*"([^"]*)"/),matches&&(newAttrs.src=matches[1],newAttrs.width=100)),newAttrs=function(){var _results;_results=[];for(field in newAttrs)value=newAttrs[field],_results.push(""+field+'="'+value+'"');return _results}().join(" "),newAttrs.length&&(newAttrs=" "+newAttrs),"<"+tag+newAttrs+">"):""}).trim()):html},colorForUser:function(baseUser,coloredUser){var colorId,colorPair,colorPairs,coloredUserId,colors,currentColors,userId,_i,_len,_ref;coloredUserId=typeof coloredUser=="number"||typeof coloredUser=="string"?parseInt(coloredUser):coloredUser.saneId();if(baseUser.saneId()===coloredUserId)return"#FFFFFF";colors=["#AC8AB2","#25BA26","#C3230C","#DD49DA","#6B5825","#3FC0A4","#D73A76","#8987D6","#EDCD28","#7D3B83","#026A5D","#8A2519","#4DA7C7","#B6B12E","#4F4F77","#426A2D","#8BAA39","#F4A720","#75AD6F","#DD625E","#A15ED9","#D87D9B","#6B98D5","#C8907D","#DE7C19"],currentColors=baseUser.get("user_colors");if(currentColors){colorPairs=currentColors.split(" ");for(_i=0,_len=colorPairs.length;_i<_len;_i++){colorPair=colorPairs[_i],_ref=colorPair.split(":"),userId=_ref[0],colorId=_ref[1];if(userId==coloredUserId)return colors[colorId]}return colorPairs.length===colors.length?"#000000":(colorId=colorPairs.length,baseUser.set("user_colors",""+baseUser.get("user_colors")+" "+coloredUserId+":"+colorId),colors[colorId])}return baseUser.set("user_colors",""+coloredUserId+":0"),colors[0]},ucfirst:function(string){return string.toLowerCase().replace(/(\b)(\w)/g,function(match,leading,letter){return""+leading+letter.toUpperCase()})},find:function(list,predicate){return _.isPlainObject(predicate)?list.find(function(instance){var name,value;for(name in predicate){value=predicate[name];if(instance.get(name)!==value)return!1}return!0}):list.find(predicate)},userWrapper:function(userId){return window._userWrappers==null&&(window._userWrappers={}),_userWrappers[userId]||(_userWrappers[userId]=ObjectWrapper.create(userId,"@",{name:"User "+userId})),_userWrappers[userId]},findAll:function(list,predicate){return _.isPlainObject(predicate)?list.findAll(function(instance){var name,value;for(name in predicate){value=predicate[name];if(instance.get(name)!==value)return!1}return!0}):list.findAll(predicate)},filteredArray:function(ctx,subject,output,test,reversed){var add;return reversed==null&&(reversed=!1),add=reversed?function(obj){return output.unshift(obj)}:function(obj){return output.push(obj)},subject.each(function(_this){return function(record){if(test(record))return add(record)}}(this)),ctx.observeObject(subject,function(_this){return function(mutation){if(mutation.type==="insertion"){if(test(mutation.value))return add(mutation.value)}else if(mutation.type==="deletion"&&test(mutation.value))return output.remove(mutation.value)}}(this))},url:function(url,baseUrl){var part,_ref;baseUrl==null&&(baseUrl=null);if(url)return part=(_ref=url.match(/^https?:\/\/(.*)$/))!=null?_ref[1]:void 0,part?"http://agora.sh/url/"+part:baseUrl&&url[0]==="/"?util.url(baseUrl+url):url},mapObjects:function(array,map){if(array)return _.map(array,function(_this){return function(el){var mapping,newEl,p;newEl=_.clone(el);for(p in map)mapping=map[p],_.isFunction(mapping)?newEl[p]=mapping(el):newEl[p]=el[mapping];return newEl}}(this))},shoppingBar:{pushRootState:function(user){var belt;return belt=user.get("belts").get(0),shoppingBarView.pushState({state:"root",shareObject:function(){return"belts."+belt.saneId()},shared:function(){return belt.field("shared")},isShared:function(){return belt.get("shared")},contents:function(_this){return function(){return belt.get("elements")}}(this),contentMap:function(_this){return function(el){return{elementType:"BeltElement",elementId:el.get("id")}}}(this),ripped:function(view){return _activity("remove",belt,util.resolveObject(view.element)),view.element["delete"]()},dropped:function(_this){return function(element){var obj;return obj=util.resolveObject(element),_activity("add",belt,obj),belt.get("contents").add(obj)}}(this)})},pushBeltState:function(belt){return shoppingBarView.pushState({state:"root",shareObject:function(){return"belts."+belt.saneId()},shared:function(){return belt.field("shared")},isShared:function(){return belt.get("shared")},contents:function(_this){return function(){return belt.get("elements")}}(this),contentMap:function(_this){return function(el){return{elementType:"BeltElement",elementId:el.get("id")}}}(this),ripped:function(view){return _activity("remove",belt,util.resolveObject(view.element)),view.element["delete"]()},dropped:function(_this){return function(element){var obj;return obj=util.resolveObject(element),_activity("add",belt,obj),belt.get("contents").add(obj)}}(this)})},pushDecisionState:function(decision){return shoppingBarView.pushState({shareObject:function(){return"decisions."+decision.record.saneId()},shared:function(){return decision.field("shared")},isShared:function(){return decision.get("shared")},dropped:function(_this){return function(element){var obj;return obj=util.resolveObject(element),_activity("add",decision,obj),decision.get("list").get("contents").add(obj)}}(this),ripped:function(_this){return function(view){return view.element["delete"]()}}(this),contents:function(_this){return function(){return decision.get("list").get("elements")}}(this),contentMap:function(_this){return function(el){return{elementType:"ListElement",elementId:el.get("id"),decisionId:decision.get("id")}}}(this),state:"Decision",args:{decisionId:decision.get("id")}})}}}});var __slice=[].slice;define("View",["underscore","clientInterface/ClientObject","clientInterface/ClientArray","clientInterface/ClientValue","util"],function(_,ClientObject,ClientArray,ClientValue,util){var ClientView,Context,View;return ClientView=function(){function ClientView(agora,id){var parent;this.agora=agora,this.id=id,parent=View.clientViews[this.id].parent,parent&&(this.parent=View.clientViews[parent].view)}return ClientView.prototype.callMethod=function(name,args){return this.agora.background.triggerContentScriptEvent("ViewMethod:"+this.id,{name:name,params:args})},ClientView}(),Context=function(){function Context(parent){this.parent=parent,this.observerObjectPairs=[],this.contexts=[],this.clientObjects=[]}return Context.prototype.addClientObject=function(clientObject){return this.clientObjects.push(clientObject),clientObject},Context.prototype.onContextDestruct=function(context){var index;index=this.contexts.indexOf(context);if(index!==-1){this.contexts.splice(index,1);if(context.name)return delete this.namedContexts[name]}},Context.prototype.context=function(name){var ctx;return name==null&&(name=null),name?(this.namedContexts==null&&(this.namedContexts={}),this.namedContexts[name]||(this.namedContexts[name]=this.context(),this.namedContexts[name].name=name),this.namedContexts[name]):(ctx=new Context(this),ctx.view=this.view,this.contexts.push(ctx),ctx)},Context.prototype.observe=function(object,observer){return object.observe(observer,this),this.observerObjectPairs.push({object:object,observer:observer})},Context.prototype.observeObject=function(object,observer){return this.observe(object,observer)},Context.prototype.stopObserving=function(object){var i,_i,_ref,_results;_results=[];for(i=_i=_ref=this.observerObjectPairs.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i)this.observerObjectPairs[i].object===object?(this.observerObjectPairs[i].object.stopObserving(this.observerObjectPairs[i].observer),_results.push(this.observerObjectPairs.splice(i,1))):_results.push(void 0);return _results},Context.prototype.clear=function(){var clientObject,ctx,object,observer,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_ref3;_ref=this.contexts;for(_i=0,_len=_ref.length;_i<_len;_i++)ctx=_ref[_i],ctx.parent=null,ctx.destruct();this.contexts=[],_ref1=this.clientObjects;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)clientObject=_ref1[_j],clientObject.destruct();this.clientObjects=[],_ref2=this.observerObjectPairs;for(_k=0,_len2=_ref2.length;_k<_len2;_k++)_ref3=_ref2[_k],object=_ref3.object,observer=_ref3.observer,object.stopObserving(observer);return this.observerObjectPairs=[]},Context.prototype.destruct=function(){var _ref;return(_ref=this.parent)!=null&&typeof _ref.onContextDestruct=="function"&&_ref.onContextDestruct(this),typeof this.onDestruct=="function"&&this.onDestruct(),this.clear()},Context.prototype.clientArray=function(array,func){var ca;return ca=new ClientArray(this.view.agora,this),this.addClientObject(ca),View.clientObjects[ca._id]=ca,arguments.length===2&&util.syncArrays(this,array,ca,function(_this){return function(obj,onRemove){var ctx,getCtx,otherOnRemove;return ctx=null,getCtx=function(){return ctx!=null?ctx:ctx=_this.context()},otherOnRemove=null,onRemove(function(){return ctx!=null?ctx.destruct():void 0}),func(obj,function(func){return otherOnRemove=func},getCtx)}}(this)),ca},Context.prototype.clientValue=function(){var cv,map,obj,_ref;return cv=null,arguments.length>=1?((_ref=arguments[0])!=null?_ref.observe:void 0)?(obj=arguments[0],typeof arguments[1]=="function"?(map=arguments[1],cv=new ClientValue(this.view.agora,this,map(obj.get())),this.observe(obj,function(_this){return function(){return cv.set(map(obj.get()))}}(this))):(cv=new ClientValue(this.view.agora,this,obj.get()),this.observe(obj,function(_this){return function(){return cv.set(obj.get())}}(this)))):cv=new ClientValue(this.view.agora,this,arguments[0]):cv=new ClientValue(this.view.agora,this),this.addClientObject(cv),View.clientObjects[cv._id]=cv,cv},Context.prototype.bind=function(cv,obj,map){return map==null&&(map=null),map?(cv.set(map(obj.get())),this.observe(obj,function(_this){return function(){return cv.set(map(obj.get()))}}(this))):(cv.set(obj.get()),this.observe(obj,function(_this){return function(){return cv.set(obj.get())}}(this)))},Context.prototype.clientValueNamed=function(name,value){var clientValue;return clientValue=this.clientValue.apply(this,Array.prototype.slice.call(arguments,1)),clientValue._name=name,clientValue},Context.prototype.clientArrayNamed=function(name){var clientArray;return clientArray=this.clientArray.apply(this,Array.prototype.slice.call(arguments,1)),clientArray._name=name,clientArray},Context}(),View=function(){View.nextViewId=1,View.views={},View.clientViews={},View.clientObjects={},View.clientIdsByTab={},View.ClientObject=ClientObject,View.clear=function(){return this.nextViewId=1,this.views={},this.clientViews={},this.clientObjects={}},View.createClientView=function(tabId,type){var id,_base;return id=this.nextViewId++,this.clientViews[id]={viewName:type},(_base=this.clientIdsByTab)[tabId]==null&&(_base[tabId]=[]),this.clientIdsByTab[tabId].push(id),id},View.connect=function(agora,clientViewId,args,cb){var viewName;return viewName=this.clientViews[clientViewId].viewName,this.get(agora,viewName,args,function(_this){return function(view){if(_this.clientViews[clientViewId])return _this.clientViews[clientViewId].id=view.id,_this.clientViews[clientViewId].view=view,view.addClientView(clientViewId),view.getData(function(data){return cb(_this.serializeObject(data))});throw Debug.error("no clientView "+clientViewId),new Error("no clientView "+clientViewId)}}(this))},View.deleteClientViewsInTab=function(tabId){var clientId,clientViews,_i,_len;clientViews=this.clientIdsByTab[tabId];if(clientViews)for(_i=0,_len=clientViews.length;_i<_len;_i++)clientId=clientViews[_i],this.remove(clientId);return delete this.clientIdsByTab[tabId]},View.remove=function(clientViewId){var _base;if(this.clientViews[clientViewId])return this.clientViews[clientViewId].view&&(this.clientViews[clientViewId].view.removeClientView(clientViewId),typeof (_base=this.clientViews[clientViewId].view).onClientDisconnect=="function"&&_base.onClientDisconnect(clientViewId)),delete this.clientViews[clientViewId]},View.getViewClass=function(viewName,cb){return this.agora.background.require(["views/"+viewName+"View"],function(viewClass){return viewClass.agora=this.agora,cb(viewClass)})},View.get=function(agora,viewName,args,cb){return this.getViewClass(viewName,function(_this){return function(viewClass){var doGet,view;return view=null,doGet=function(args){var id,_ref;return viewClass.id?id=viewClass.id(args):id=null,(view=(_ref=_this.views[viewName])!=null?_ref[id]:void 0)||(view=new viewClass(viewName,id,agora,args),_this.views[viewName]?_this.views[viewName][id]=view:(_this.views[viewName]={},_this.views[viewName][id]=view)),view.whenReady(function(){return cb(view)})},viewClass.filter?viewClass.filter(agora,args,doGet):doGet(args)}}(this))},View.getWithClientId=function(clientViewId,cb){var id,view,viewName,_ref;return _ref=this.clientViews[clientViewId],id=_ref.id,viewName=_ref.viewName,view=this.views[viewName][id],cb(view)},View.callMethod=function(clientViewId,methodName,args,timestamp){var id,view,viewName,_ref;return _ref=this.clientViews[clientViewId],id=_ref.id,viewName=_ref.viewName,Debug.log("callMethod",viewName,clientViewId,methodName,args),view=this.views[viewName][id],view.callMethod(clientViewId,methodName,args,timestamp)},View.serializeObject=function(obj){return ClientObject.serialize(obj)},View.getClientObjects=function(ids){var clientObject,id,response,_i,_len;response={};for(_i=0,_len=ids.length;_i<_len;_i++)id=ids[_i],clientObject=ClientObject._registry[id],clientObject===!1?console.log("%s has been deleted",id):response[id]=clientObject.serialize();return response};function View(name,id,agora,args){this.name=name,this.id=id,this.agora=agora,this.args=args,this.background=this.agora.background,this.ctx=this.context(),this.init?this.init(args):this.initAsync&&(this.waiting=!0,this.initAsync(args,function(_this){return function(){var cb,_i,_len,_ref,_results;_this.waiting=!1;if(_this.readyCbs){_ref=_this.readyCbs,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],_results.push(cb());return _results}}}(this)))}return View.prototype.destruct=function(){var ctx,_i,_len,_ref;if(!this.destructed){if(this.contexts){_ref=this.contexts;for(_i=0,_len=_ref.length;_i<_len;_i++)ctx=_ref[_i],ctx.destruct()}return delete View.views[this.name][this.id],_.isEmpty(View.views[this.name])&&delete View.views[this.name],this.destructed=!0}},View.prototype.context=function(){var context;return this.contexts==null&&(this.contexts=[]),context=new Context,context.view=this,this.contexts.push(context),context},View.prototype.clientArray=function(ctx,array,func){return ctx.clientArray(array,func)},View.prototype.clientValue=function(value,func){return this.ctx.clientValue(value,func)},View.prototype.clientValueNamed=function(name,value,func){return this.ctx.clientValueNamed(name,value,func)},View.prototype.clientArrayNamed=function(name){return this.ctx.clientArrayNamed.apply(this.ctx,arguments)},View.prototype.getData=function(cb){return cb(this.data)},View.prototype.observeObject=function(observable,observer){return this.ctx.observe(observable,observer)},View.prototype.stopObservingObject=function(observable){return this.ctx.stopObserving(observable)},View.prototype.addClientView=function(id){return this.clientViews==null&&(this.clientViews=[]),this.clientViews.push(id)},View.prototype.removeClientView=function(id){_.pull(this.clientViews,id);if(!this.clientViews.length)return this.destruct()},View.prototype.whenReady=function(cb){return this.waiting?(this.readyCbs==null&&(this.readyCbs=[]),this.readyCbs.push(cb)):cb()},View.prototype.hasMethod=function(name){var _ref;return(_ref=this.methods)!=null?_ref[name]:void 0},View.prototype.method=function(name){return this.methods[name]},View.prototype.callMethod=function(clientViewId,name,args,timestamp,cb){var view;if(this.hasMethod(name))return view=new ClientView(this.agora,clientViewId),view.methodTimestamp=timestamp,this.clientView=view,this.method(name).apply(this,[view].concat(args)),delete this.clientView;throw console.debug("View '"+this.name+"' has no method '"+name+"'"),new Error("View '"+this.name+"' has no method '"+name+"'")},View.prototype.resolveObject=function(input,cb){var element,obj;return input?input.modelName&&input.instanceId?cb(this.agora.modelManager.getInstance(input.modelName,input.instanceId)):input.elementType&&input.elementId?(element=this.agora.modelManager.getInstance(input.elementType,input.elementId),obj=element.get("element"),cb(obj,element)):this.agora.product(input,cb):cb()},View.prototype.resolveElements=function(){var args,cb,count,datum,decision,elementData,elements,i,list,results,_i,_len;args=1<=arguments.length?__slice.call(arguments,0):[],cb=elements=null,typeof args[args.length-1]=="function"?(cb=args[args.length-1],elements=args.slice(0,args.length-1)):elements=args,results=[],count=0;for(i=_i=0,_len=elements.length;_i<_len;i=++_i){elementData=elements[i];if(typeof elementData=="number")results[i]=this.agora.modelManager.instance("Product",elementData);else if(elementData.action==="new")switch(elementData.type){case"computer":results[i]=this.agora.modelManager.getModel("Composite").createWithType("computer");break;case"decision":list=this.agora.modelManager.getModel("List").create(),decision=this.agora.modelManager.getModel("Decision").create(),decision.set("list_id",list.get("id")),results[i]=decision;break;case"list":results[i]=this.agora.modelManager.getModel("List").create({collapsed:!0});break;case"bundle":results[i]=this.agora.modelManager.getModel("Bundle").create();break;case"session":results[i]=this.agora.modelManager.getModel("Session").create();break;case"descriptor":results[i]=this.agora.modelManager.getModel("Descriptor").create({descriptor:elementData.descriptor})}else elementData.action==="addData"?(datum=this.agora.modelManager.getModel("Datum").create(elementData.data),results[i]=datum):(elementData.elementType==="Product"&&elementData.elementId==null||elementData.siteName&&elementData.productSid)&&cb?(count++,function(_this){return function(i){return _this.agora.modelManager.getModel("Product").get(elementData,function(product){var j,_j,_ref;if(elementData.variant){for(j=_j=0,_ref=product.get("variants").length();0<=_ref?_j<_ref:_j>_ref;j=0<=_ref?++_j:--_j)if(_.isEqual(elementData.variant,product.get("variants").get(j).get("variant"))){results[i]=product.get("variants").get(j);break}results[i]||(results[i]=this.agora.modelManager.getModel("ProductVariant").create({product_id:product.get("id"),variant:elementData.variant}))}else results[i]=product;if(!(--count||i<elements.length-1))return cb.apply(window,results),cb=null})}}(this)(i)):elementData.view?results[i]=this.agora.View.clientViews[elementData.view].view:elementData.elementType&&elementData.elementId&&(results[i]=this.agora.modelManager.getInstance(elementData.elementType,elementData.elementId))}return cb&&(count||cb.apply(window,results)),results},View}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/ObservableArray",["./ObservableObject","underscore"],function(ObservableObject,_){var ObservableArray;return ObservableArray=function(_super){__extends(ObservableArray,_super);function ObservableArray(_array){this._array=_array,this._array==null&&(this._array=[])}return ObservableArray.prototype.get=function(index){if(index<0)return this.get(index+this._array.length);if(index>=this._array.length)throw new Error("index out of bounds: "+index);return this._array[index]},ObservableArray.prototype.insert=function(position,value){if(!value)throw new Error("false value");return this._array.splice(position,0,value),this._fireMutation("insertion",{position:position,value:value,length:this._array.length})},ObservableArray.prototype["delete"]=function(position,tag){var value;if(position>=this._array.length)throw new Error(""+position+" out of range");value=this._array[position];if(!value)throw console.debug(this._array),new Error(""+position);return this._array.splice(position,1),this._fireMutation("deletion",{position:position,value:value,length:this._array.length,tag:tag})},ObservableArray.prototype.remove=function(el,tag){var index;return index=this.indexOf(el),index!==-1?this["delete"](index,tag):console.log(el,"not in array",this)},ObservableArray.prototype.deleteIf=function(predicate){var deleteQueue,i,_i,_len,_results;deleteQueue=[],this.each(function(_this){return function(value,i){if(predicate(value))return deleteQueue.unshift(i)}}(this)),_results=[];for(_i=0,_len=deleteQueue.length;_i<_len;_i++)i=deleteQueue[_i],_results.push(this["delete"](i));return _results},ObservableArray.prototype.push=function(value){return this.insert(this._array.length,value)},ObservableArray.prototype.unshift=function(value){return this.insert(0,value)},ObservableArray.prototype.append=function(array){var value,_i,_len,_results;_results=[];for(_i=0,_len=array.length;_i<_len;_i++)value=array[_i],_results.push(this.push(value));return _results},ObservableArray.prototype.each=function(iterator){return _.each(this._array,iterator)},ObservableArray.prototype.indexOf=function(el,start){return this._array.indexOf(el,start)},ObservableArray.prototype.find=function(predicate){var value,_i,_len,_ref;_ref=this._array;for(_i=0,_len=_ref.length;_i<_len;_i++){value=_ref[_i];if(predicate(value))return value}},ObservableArray.prototype.findAll=function(predicate){var value,values,_i,_len,_ref;values=[],_ref=this._array;for(_i=0,_len=_ref.length;_i<_len;_i++)value=_ref[_i],predicate(value)&&values.push(value);return values},ObservableArray.prototype.length=function(){return this._array.length},ObservableArray.prototype.move=function(from,to){var el;if(from!==to){el=this._array.splice(from,1)[0];if(!el)throw new Error("poop");return this._array.splice(to,0,el),this._fireMutation("movement",{from:from,to:to})}},ObservableArray.prototype.sort=function(comp){return this._array.sort(comp)},ObservableArray.prototype.clear=function(){return ObservableArray.__super__.clear.apply(this,arguments),this._array=[]},ObservableArray}(ObservableObject)}),define("model/auxiliary/maintainOrder2",["underscore"],function(_){var sort;return sort=function(array,args){var a,action,actions,compare,findBetween,from,get,i,length,move,orderedRanges,originalPosition,r,range,rangeA,rangeB,ranges,shouldMove,sortedRanges,to,_i,_j,_k,_l,_len,_len1,_len2,_m,_ref,_ref1,_results;move=args.move,compare=args.compare,get=args.get,length=args.length,findBetween=function(a,b,skips){var i,_i,_ref;skips==null&&(skips=[]);for(i=_i=0,_ref=length(array);0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){if(i===a||i===b)continue;if(compare(get(array,i),get(array,a))>0&&compare(get(array,i),get(array,b))<0)return!0}return!1},ranges=[],rangeA=0,rangeB=0,range=[];for(i=_i=0,_ref=length(array)-1;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)range.push(get(array,i)),compare(get(array,i),get(array,i+1))>0||findBetween(i,i+1)?(ranges.push({a:rangeA,b:rangeB,range:range,aValue:get(array,rangeA),bValue:get(array,rangeB)}),range=[],rangeA=rangeB=i+1):rangeB++;range.push(get(array,length(array)-1)),ranges.push({a:rangeA,b:rangeB,range:range,aValue:get(array,rangeA),bValue:get(array,rangeB)}),orderedRanges=ranges.slice(0,ranges.length).sort(function(a,b){return a.range.length-b.range.length}),sortedRanges=ranges.slice(0,ranges.length),actions=[];for(_j=0,_len=orderedRanges.length;_j<_len;_j++){r=orderedRanges[_j],originalPosition=0,from=0;for(i=_k=0,_len1=sortedRanges.length;_k<_len1;i=++_k){range=sortedRanges[i];if(range===r){originalPosition=i,sortedRanges.splice(i,1);break}from+=range.range.length}to=0;for(i=_l=0,_ref1=sortedRanges.length;0<=_ref1?_l<=_ref1:_l>=_ref1;i=0<=_ref1?++_l:--_l){shouldMove=!1,i===sortedRanges.length?shouldMove=!0:compare(r.bValue,sortedRanges[i].aValue)<=0&&(shouldMove=!0);if(shouldMove){originalPosition!==i&&actions.push({from:from,to:to,length:r.range.length}),sortedRanges.splice(i,0,r);break}to+=sortedRanges[i].range.length}}_results=[];for(_m=0,_len2=actions.length;_m<_len2;_m++)action=actions[_m],a=0,_results.push(function(){var _n,_ref2,_ref3,_results1;_results1=[];for(i=_n=_ref2=action.from,_ref3=action.from+action.length;_ref2<=_ref3?_n<_ref3:_n>_ref3;i=_ref2<=_ref3?++_n:--_n)from=i,to=action.to+i-action.from,_results1.push(move(array,from,to));return _results1}());return _results},function(list,orderBy){var maintainOrder,startedTimer,stopFuncs;return startedTimer=!1,maintainOrder=function(instance){var compare,order;return compare=function(_this){return function(a,b){var result;return a.get(orderBy.field)<b.get(orderBy.field)?result=-1:a.get(orderBy.field)>b.get(orderBy.field)?result=1:result=0,orderBy.direction==="desc"&&(result*=-1),result}}(this),list.sort(compare),order=function(){if(startedTimer)return;return startedTimer=!0,setTimeout(function(){return startedTimer=!1,sort(list,{length:function(array){return array.length()},compare:function(_this){return function(a,b){var result;return a.get(orderBy.field)<b.get(orderBy.field)?result=-1:a.get(orderBy.field)>b.get(orderBy.field)?result=1:result=0,orderBy.direction==="desc"&&(result*=-1),result}}(this),move:function(array,from,to){return array.move(from,to)},get:function(array,i){return array.get(i)}})},0)},instance.field(orderBy.field).observe(order),function(){return instance.field(orderBy.field).stopObserving(order)}},stopFuncs=[],list.observe(function(mutation){var a,i,instance,stop,_i,_len,_results;instance=mutation.value,mutation.type==="insertion"&&(instance.get(orderBy.field)===null&&instance.set(orderBy.field,list.length()),stop=maintainOrder(mutation.value),stopFuncs.push({obj:mutation.value,func:stop}));if(mutation.type==="deletion"){_results=[];for(i=_i=0,_len=stopFuncs.length;_i<_len;i=++_i){a=stopFuncs[i];if(a.obj===mutation.value){a.func(),stopFuncs.splice(i,1);break}_results.push(void 0)}return _results}})}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/Relationship",["./ObservableObject"],function(ObservableObject){var Relationship;return Relationship=function(_super){__extends(Relationship,_super);function Relationship(){return Relationship.__super__.constructor.apply(this,arguments)}return Relationship.prototype.observeObject=function(object,observer){var _observer;return object.observe(_observer=function(_this){return function(mutation){return _this._instance.model.manager.relationshipsPaused?_this._instance.model.manager.mutations.push({observer:observer,mutation:mutation}):observer(mutation)}}(this),this),this.observedObjects==null&&(this.observedObjects=[]),this.observedObjects.push({object:object,observer:_observer})},Relationship.prototype.stopObservingObjects=function(){var object,observer,_i,_len,_ref,_ref1;if(this.observedObjects){_ref=this.observedObjects;for(_i=0,_len=_ref.length;_i<_len;_i++)_ref1=_ref[_i],observer=_ref1.observer,object=_ref1.object,object.stopObserving(observer);return delete this.observedObjects}},Relationship.prototype.destruct=function(){return this.stopObservingObjects(),typeof this.onDestruct=="function"?this.onDestruct():void 0},Relationship}(ObservableObject)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/HasManyRelationship",["./ObservableArray","./auxiliary/maintainOrder2","./Relationship","util"],function(ObservableArray,maintainOrder,Relationship,util){var HasManyRelationship,ModelInstanceWrapper;return ModelInstanceWrapper=function(){function ModelInstanceWrapper(_rel,_joint){var getModel;this._rel=_rel,this._joint=_joint,getModel=function(_this){return function(record){return typeof _this._rel._model=="function"?_this._rel._instance.model.manager.getModel(_this._rel._model(record)):_this._rel._model}}(this),this._update=function(_this){return function(){var method,_fn,_i,_j,_len,_len1,_ref,_ref1;if(_this._instance){_this._instance.stopObservingWithTag(_this);if(_this._instance.instanceMethods){_ref=_this._instance.instanceMethods;for(_i=0,_len=_ref.length;_i<_len;_i++)method=_ref[_i],delete _this[method]}}_this._instance=getModel(_this._joint).withId(_this._joint.get(_this._rel._relKey)),_this._instance.observeWithTag(_this,function(mutation){return _this._rel._remove(_this)});if(_this._instance.instanceMethods){_ref1=_this._instance.instanceMethods,_fn=function(method){return _this[method]=function(){return _this._instance[method].apply(_this._instance,arguments)}};for(_j=0,_len1=_ref1.length;_j<_len1;_j++)method=_ref1[_j],_fn(method)}return _this.model=_this._instance.model,_this.modelName=_this.model.name,_this.record=_this._instance.record}}(this),this._rel.observeObject(this._joint.field(this._rel._relKey),this._update),this._update()}return ModelInstanceWrapper.prototype.get=function(propertyName){return this._joint.field(propertyName)?this._joint.get(propertyName):this._instance.get(propertyName)},ModelInstanceWrapper.prototype._get=function(propertyName){return this._instance._get(propertyName)},ModelInstanceWrapper.prototype.set=function(propertyName,value){return this._joint.field(propertyName)?this._joint.set(propertyName,value):this._instance.set(propertyName,value)},ModelInstanceWrapper.prototype.field=function(propertyName){return this._joint.field(propertyName)?this._joint.field(propertyName):this._instance.field(propertyName)},ModelInstanceWrapper.prototype["delete"]=function(){return this._instance["delete"]()},ModelInstanceWrapper.prototype.tableName=function(){return this._instance.tableName()},ModelInstanceWrapper.prototype.saneId=function(){return this._instance.saneId()},ModelInstanceWrapper.prototype.equals=function(instance){return this._instance.equals(instance)},ModelInstanceWrapper.prototype.isA=function(modelName){return this._instance.isA(modelName)},ModelInstanceWrapper.prototype["with"]=function(){var _ref;return(_ref=this._instance)["with"].apply(_ref,arguments)},ModelInstanceWrapper.prototype.retrieve=function(){var _ref;return(_ref=this._instance).retrieve.apply(_ref,arguments)},ModelInstanceWrapper.prototype.saneId=function(){return this._instance.saneId()},ModelInstanceWrapper}(),HasManyRelationship=function(_super){__extends(HasManyRelationship,_super),HasManyRelationship.prototype._recordDataKey=function(record){return""+record.table.name+"."+record.get("id")},HasManyRelationship.prototype._getRecordData=function(record,required){var data,key;required==null&&(required=!1),key=this._recordDataKey(record),data=this._recordData[key];if(!data&&required)throw Debug.error("no record data for "+key),new Error("no record data for "+key);return data},HasManyRelationship.prototype._setRecordData=function(record,data){var key;return key=this._recordDataKey(record),this._recordData[key]=data},HasManyRelationship.prototype._deleteRecordData=function(record){return delete this._recordData[this._recordDataKey(record)]};function HasManyRelationship(_instance,_args,_relName){var foreignKey,getModel,initRecord,onRecord,relKey,remove,testRelation,through;this._instance=_instance,this._args=_args,this._relName=_relName,Relationship.nextId==null&&(Relationship.nextId=1),this.id=Relationship.nextId++,foreignKey=_args.foreignKey,relKey=_args.relKey,through=_args.through,this._model=_args.model,getModel=function(_this){return function(record){return typeof _this._model=="function"?_this._instance.model.manager.getModel(_this._model(record)):_this._model}}(this);if(through){this._table=this._instance.model.manager.db.table(through);if(!this._table)throw new Error("NO TABLE")}else{this._table=this._model._table,relKey="id";if(!this._table)throw console.log(this._model),new Error("NO TABLE")}this._relKey=relKey,this._table||console.log(this._relName),this._list=new ObservableArray,this._args.orderBy&&maintainOrder(this._list,this._args.orderBy),this._list.name="HasManyRelationship::"+this._model.name+"."+_relName,this._list.observe(function(_this){return function(mutation){return _this._callObservers(mutation)}}(this)),this._recordData={},testRelation=function(_this){return function(record,filter){var l,r,t;filter==null&&(filter=!0),l=_this._instance.get("id"),r=record.get(foreignKey),t=l==r;if(!t)return!1;if(filter){if(through&&_this._args.throughFilter&&!_this._args.throughFilter(record))return!1;if(_this._args.filter&&!_this._args.filter(record))return!1}return!0}}(this),remove=function(_this){return function(record){var i,modelName,recordData,relId,_i,_ref,_ref1;relId=record.get(relKey),modelName=getModel(record).name,_this._list.deleteIf(function(relInstance){return relInstance.get("id")==relId&&relInstance.modelName==modelName}),recordData=_this._getRecordData(record,!0),_this._args.onRemove&&_this._args.onRemove.call(_this,recordData.instance);if(_this._args.orderBy&&_this.length())for(i=_i=_ref=Math.min(record.get(_this._args.orderBy),_this.length()-1),_ref1=_this.length();_ref<=_ref1?_i<_ref1:_i>_ref1;i=_ref<=_ref1?++_i:--_i)_this.get(i).set(_this._args.orderBy,i);return typeof recordData.onRemove=="function"&&recordData.onRemove(),_this._deleteRecordData(record)}}(this),initRecord=function(_this){return function(record){var field,_i,_len,_ref;_ref=record.fields();for(_i=0,_len=_ref.length;_i<_len;_i++)field=_ref[_i],field.observe(function(){if(!_this._getRecordData(record))return onRecord(record);if(!testRelation(record))return remove(record)});return onRecord(record)}}(this),onRecord=function(_this){return function(record){var instance,relId;if(testRelation(record)){relId=record.get(relKey),instance=null,through?instance=new ModelInstanceWrapper(_this,record):instance=_this._model.withId(relId);if(!instance)throw new Error("null instance");_this._setRecordData(record,{instance:instance}),_this._args.onBeforeAdd&&_this._args.onBeforeAdd.call(_this,instance),_this._list.push(instance);if(_this._args.onAfterAdd)return _this._args.onAfterAdd.call(_this,instance)}}}(this),this._table.records.each(initRecord),this.observeObject(this._table.records,function(_this){return function(mutation){if(mutation.type==="insertion")return initRecord(mutation.value);if(mutation.type==="deletion"&&_this._getRecordData(mutation.value))return remove(mutation.value)}}(this)),_args["for"]&&(this.init=function(_this){return function(){var onRelInst,path,rel;return path=_args["for"].path.split("."),rel=_this._instance.get(path[0]).get(path[1]),_this["for"]=onRelInst=function(relInst){var args,inst;return inst=_this.find(function(inst){return inst.get(_args["for"].key)===relInst.get("id")}),inst||(args={},args[_args["for"].key]=relInst.get("id"),inst=_this._model.create(args),_this._add(inst)),inst},rel.each(onRelInst),_this.observeObject(rel,function(mutation){var inst;if(mutation.type==="insertion")return onRelInst(mutation.value);if(mutation.type==="deletion"){inst=_this.find(function(inst){return inst.get(_args["for"].key)===mutation.value.get("id")});if(inst)return _this.remove(inst)}})}}(this))}return HasManyRelationship.prototype.get=function(position){return this._list.get(position)},HasManyRelationship.prototype._add=function(instance,fields){var defaults,name,record,value;if(!this.contains(instance)){if(this._args.through){record={},record[this._args.foreignKey]=this._instance.get("id"),record[this._args.relKey]=instance.get("id"),defaults={},this._args.defaultValues&&(typeof this._args.defaultValues=="function"?defaults=this._args.defaultValues(instance):defaults=this._args.defaultValues);for(name in defaults)value=defaults[name],record[name]=value;if(fields)for(name in fields)value=fields[name],record[name]=value;return this._table.addRecord(record)}return instance.set(this._args.foreignKey,this._instance.get("id"))}},HasManyRelationship.prototype._remove=function(instance){return this._args.through?this._table["delete"](function(_this){return function(record){return record.get(_this._args.foreignKey)===_this._instance.get("id")&&record.get(_this._args.relKey)===instance.get("id")}}(this)):instance.set(this._args.foreignKey,null)},HasManyRelationship.prototype.add=function(instance,fields){return this._args.add?this._args.add.call(this,instance,fields):this._add(instance,fields)},HasManyRelationship.prototype.remove=function(instance){return this._args.remove?this._args.remove.call(this,instance):this._remove(instance)},HasManyRelationship.prototype.removeAt=function(index){return this.remove(this.get(index))},HasManyRelationship.prototype.removeAll=function(){if(this._args.through)return this._table["delete"](function(_this){return function(record){return record.get(_this._args.foreignKey)===_this._instance.get("id")}}(this))},HasManyRelationship.prototype.each=function(){return this._list.each.apply(this._list,arguments)},HasManyRelationship.prototype.forEach=function(){return this.each.apply(this,arguments)},HasManyRelationship.prototype.contains=function(instance){return!!this.find(function(inst){return inst.modelName===instance.modelName&&inst.get("id")===instance.get("id")})},HasManyRelationship.prototype.length=function(){return this._list.length()},HasManyRelationship.prototype.move=function(from,to){return this._list.move(from,to)},HasManyRelationship.prototype.find=function(predicate){return util.find(this._list,predicate)},HasManyRelationship.prototype.findAll=function(predicate){return util.findAll(this._list,predicate)},HasManyRelationship.prototype.instanceForInstance=function(instance){return this._args.through?this._list.find(function(inst){return inst.equals(instance)}):this._getRecordData(instance.record,!0).instance},HasManyRelationship}(Relationship)}),define("model/auxiliary/maintainOrder",[],function(){var maintainOrder;return maintainOrder=function(orderBy,instance,list){var compare,order,ordering;return compare=function(_this){return function(a,b){var result;return a.get(orderBy.field)<b.get(orderBy.field)?result=-1:a.get(orderBy.field)>b.get(orderBy.field)?result=1:result=0,orderBy.direction==="desc"&&(result*=-1),result}}(this),list.sort(compare),ordering=!1,order=function(){var i,index,result,to,_i,_j,_ref,_ref1;if(ordering)return;ordering=!0,index=list.indexOf(instance),to=null;for(i=_i=0,_ref=list.length()-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){if(instance===list.get(i))continue;result=compare(instance,list.get(i));if(result<0){to=index>i?i:i-1;break}if(result===0)return}to===null&&(to=list.length()-1),list.move(index,to);for(i=_j=0,_ref1=list.length()-1;0<=_ref1?_j<=_ref1:_j>=_ref1;i=0<=_ref1?++_j:--_j)list.get(i).set(orderBy.field,i);return ordering=!1},instance.field(orderBy.field).observe(order),function(){return instance.field(orderBy.field).stopObserving(order)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/HasOneRelationship",["./ObservableArray","./auxiliary/maintainOrder","./Relationship"],function(ObservableArray,maintainOrder,Relationship){var HasOneRelationship;return HasOneRelationship=function(_super){__extends(HasOneRelationship,_super),HasOneRelationship.prototype.get=function(propertyName){var _ref;return(_ref=this._relInstance)!=null?_ref.get(propertyName):void 0},HasOneRelationship.prototype._get=function(propertyName){var _ref;return(_ref=this._relInstance)!=null?_ref._get(propertyName):void 0},HasOneRelationship.prototype.set=function(propertyName,value){var _ref;return(_ref=this._relInstance)!=null?_ref.set(propertyName,value):void 0},HasOneRelationship.prototype.field=function(propertyName){var _ref;return(_ref=this._relInstance)!=null?_ref.field(propertyName):void 0},HasOneRelationship.prototype["delete"]=function(){var _ref;return(_ref=this._relInstance)!=null?_ref["delete"]():void 0},HasOneRelationship.prototype.tableName=function(){var _ref;return(_ref=this._relInstance)!=null?_ref.tableName():void 0},HasOneRelationship.prototype.saneId=function(){return this._relInstance.saneId()},HasOneRelationship.prototype.equals=function(instance){return this._relInstance.equals(instance)},HasOneRelationship.prototype.isA=function(modelName){return this._relInstance.isA(modelName)},HasOneRelationship.prototype.isNull=function(){return!this._relInstance},HasOneRelationship.prototype["with"]=function(){var _ref;return(_ref=this._relInstance)["with"].apply(_ref,arguments)},HasOneRelationship.prototype.retrieve=function(){var _ref;return(_ref=this._relInstance).retrieve.apply(_ref,arguments)};function HasOneRelationship(_instance,_args,_relName){var model,updateRelInstance;this._instance=_instance,this._args=_args,this._relName=_relName;if(!this._args.relKey)throw new Error("no relKey");model=function(_this){return function(){var name;if(typeof _this._args.model!="function")return _this._args.model;name=_this._args.model(_this._instance);if(name)return _this._instance.model.manager.getModel(name)}}(this),updateRelInstance=function(_this){return function(){var id,method,_fn,_i,_j,_len,_len1,_ref,_ref1;if(_this._relInstance&&_this._relInstance.instanceMethods){_ref=_this._relInstance.instanceMethods;for(_i=0,_len=_ref.length;_i<_len;_i++)method=_ref[_i],delete _this[method]}id=_this._instance.get(_this._args.relKey);if(id){_this._relInstance=model().withId(id),_this.model=model(),_this.modelName=_this.model.name,_this.record=_this._relInstance.record;if(_this._relInstance.instanceMethods){_ref1=_this._relInstance.instanceMethods,_fn=function(method){return _this[method]=function(){return _this._relInstance[method].apply(_this._relInstance,arguments)}};for(_j=0,_len1=_ref1.length;_j<_len1;_j++)method=_ref1[_j],_fn(method)}}else _this._relInstance=null,_this.model=_this.record=null;return _this._fireMutation("changed")}}(this),updateRelInstance(),this.observeObject(this._instance.field(this._args.relKey),updateRelInstance),this.onDestruct=function(){return this._instance.field(this._args.relKey).stopObserving(updateRelInstance)}}return HasOneRelationship}(Relationship)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;define("model/ModelInstance",["./HasManyRelationship","./HasOneRelationship","./ObservableObject"],function(HasManyRelationship,HasOneRelationship,ObservableObject){var ModelInstance;return ModelInstance=function(_super){__extends(ModelInstance,_super),ModelInstance.prototype._createRelationship=function(constructor,relName){if(typeof constructor=="function")return constructor(this);typeof constructor.model=="string"&&(constructor.model=this.model.manager.getModel(constructor.model));switch(constructor.type){case"hasMany":return new HasManyRelationship(this,constructor,relName);case"hasOne":return new HasOneRelationship(this,constructor,relName)}},ModelInstance.prototype._createRelationships=function(){var relArgs,relName,relationships,_results;this._relationships={};if(relationships=this.model.relationships){_results=[];for(relName in relationships)relArgs=relationships[relName],_results.push(this._relationships[relName]=this._createRelationship(relArgs,relName));return _results}},ModelInstance.prototype._initRelationships=function(){var rel,relName,_ref,_results;_ref=this._relationships,_results=[];for(relName in _ref)rel=_ref[relName],_results.push(typeof rel.init=="function"?rel.init():void 0);return _results},ModelInstance.prototype.saneId=function(){return this.record.saneId()},ModelInstance.prototype.createRelationships=function(shouldCreateRelationships){if(this.model.manager.relationshipsPaused)return this.model.manager.relationshipsQueue.push(this);if(shouldCreateRelationships)return this._createRelationships(),this._initRelationships()};function ModelInstance(model,record){this.model=model,this.record=record,this.modelName=this.model.name,this.retrieving={}}return ModelInstance.prototype._get=function(propertyName){return this.record.get(propertyName)},ModelInstance.prototype.get=function(propertyName){var prop,rel,_ref,_ref1;return(rel=(_ref=this._relationships)!=null?_ref[propertyName]:void 0)?rel:(prop=(_ref1=this.model.properties)!=null?_ref1[propertyName]:void 0)?prop.call(this):this._get(propertyName)},ModelInstance.prototype.set=function(propertyName,value,timestamp){return this.record.set(propertyName,value,timestamp)},ModelInstance.prototype.field=function(name){return this.record.field(name)},ModelInstance.prototype["delete"]=function(){return this.model["delete"](this)},ModelInstance.prototype.tableName=function(){return this.record.tableName()},ModelInstance.prototype.equals=function(instance){return this.model===instance.model&&this.get("id")===instance.get("id")},ModelInstance.prototype.isA=function(modelName){return modelName===this.modelName},ModelInstance.prototype.retrieve=function(field,cb,force){cb==null&&(cb=null),force==null&&(force=!1);if(this.get(field)===null||force){if(!this.retrieving[field])return this.retrieving[field]=[],cb&&this.retrieving[field].push(cb),this.retrievers[field].call(this,function(_this){return function(value){var _i,_len,_ref;_this.set(field,value);if(_this.retrieving[field]){_ref=_this.retrieving[field];for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],cb(value)}return delete _this.retrieving[field]}}(this));if(cb)return this.retrieving[field].push(cb)}else if(cb)return cb(this.get(field))},ModelInstance.prototype["with"]=function(){var cb,count,done,field,fields,i,values,_i,_j,_len,_results;fields=2<=arguments.length?__slice.call(arguments,0,_i=arguments.length-1):(_i=0,[]),cb=arguments[_i++],values=[],done=function(){if(!--count)return cb.apply(null,values)},count=fields.length,_results=[];for(i=_j=0,_len=fields.length;_j<_len;i=++_j)field=fields[i],_results.push(function(_this){return function(field,i){return _this.retrieving[field]?_this.retrieving[field].push(function(value){return values[i]=value,done()}):_this.get(field)===null?_this.retrieve(field,function(value){return values[i]=value,done()}):(values[i]=_this.get(field),done())}}(this)(field,i));return _results},ModelInstance}(ObservableObject)});var __slice=[].slice;define("model/Event",["underscore"],function(_){var Event;return Event=function(){function Event(){}return Event.prototype.subscribe=function(subscriber){return this.subscribers==null&&(this.subscribers=[]),this.subscribers.push(subscriber)},Event.prototype.unsubscribe=function(subscriber){if(this.subscribers)return _.pull(this.subscribers,subscriber)},Event.prototype.fire=function(){var args,subscriber,_i,_len,_ref,_results;args=1<=arguments.length?__slice.call(arguments,0):[];if(this.subscribers){_ref=this.subscribers,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)subscriber=_ref[_i],_results.push(subscriber.apply(null,args));return _results}},Event}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/Model",["./ModelInstance","./ObservableArray","./Event","./auxiliary/maintainOrder2"],function(ModelInstanceBase,ObservableArray,Event,maintainOrder){var Model;return Model=function(){function Model(manager,name,background,args){var ModelInstance,method,table,_ref;this.manager=manager,this.name=name,this.background=background,this.relationships=args.relationships,this.properties=args.properties,this._byId={},this._list=new ObservableArray,this._list.name="Model::"+this.name,this._table=table=this.manager.db.table(args.table),this._args=args,this._fault=args.fault;if(!table)throw new Error("NO TABLE");this._args.orderBy&&maintainOrder(this._list,this._args.orderBy),table.records.each(function(_this){return function(record){return _this._addFromRecord(record,!1)}}(this)),table.records.observe(function(_this){return function(mutation){if(!_this._ignoringTableMutations){if(mutation.type==="insertion")return _this._addFromRecord(mutation.value);if(mutation.type==="deletion")return _this._remove(mutation.value)}}}(this)),this.ModelInstance=ModelInstance=function(_super){__extends(ModelInstance,_super);function ModelInstance(){return ModelInstance.__super__.constructor.apply(this,arguments)}return ModelInstance}(ModelInstanceBase);if(args.instanceMethods){_ref=args.instanceMethods;for(name in _ref)method=_ref[name],this.ModelInstance.prototype[name]=method}this.events={onCreate:new Event,onRemove:new Event}}return Model.prototype._initRelationships=function(){return this._list.each(function(instance){return instance._createRelationships()})},Model.prototype._addFromRecord=function(record,createRelationships){var instance,_ref;return createRelationships==null&&(createRelationships=!0),this._byId[record.get("id")]?this._byId[record.get("id")]:(instance=new this.ModelInstance(this,record,!1),this._byId[instance.get("id")]=instance,this._args.onBeforeAdd&&this._args.onBeforeAdd.call(this,instance),this._list.push(instance),instance.createRelationships(createRelationships),(_ref=this._args.onAfterAdd)!=null&&_ref.call(this,instance),setTimeout(function(_this){return function(){if(instance._relationships)return _this.events.onCreate.fire(instance,_this)}}(this),0),instance)},Model.prototype._remove=function(record){var i,instance,name,rel,_i,_ref,_ref1,_ref2,_results;this._list.deleteIf(function(_this){return function(model){return model.get("id")==record.get("id")}}(this)),instance=this._byId[record.get("id")],_ref=instance._relationships;for(name in _ref)rel=_ref[name],rel.destruct();instance._fireMutation("deleted"),delete this._byId[record.get("id")],this._args.onRemove&&this._args.onRemove.call(this,instance),this.events.onRemove.fire(instance,this);if(this._args.orderBy&&this._list.length()){_results=[];for(i=_i=_ref1=Math.min(record.get(this._args.orderBy),this._list.length()-1),_ref2=this._list.length();_ref1<=_ref2?_i<_ref2:_i>_ref2;i=_ref1<=_ref2?++_i:--_i)_results.push(this._list.get(i).set(this._args.orderBy,i));return _results}},Model.prototype.withId=function(id,throwError){var instance;throwError==null&&(throwError=!0);if(!!this._byId[id])return this._byId[id];if(this._fault)return this._table._addRecord({},id),instance=this._byId[id],this.manager.events.onFault.fire(instance),instance;if(throwError)throw new Error("Model "+this.name+" does not have instance with id "+id)},Model.prototype._ignoreTableMutations=function(block){var ret;return this._ignoringTableMutations=!0,ret=block(),this._ignoringTableMutations=!1,ret},Model.find=function(list,predicate){return _.isPlainObject(predicate)?list.find(function(instance){var name,value;for(name in predicate){value=predicate[name];if(instance.get(name)!==value)return!1}return!0}):list.find(predicate)},Model.findAll=function(list,predicate){return _.isPlainObject(predicate)?list.findAll(function(instance){var name,value;for(name in predicate){value=predicate[name];if(instance.get(name)!==value)return!1}return!0}):list.findAll(predicate)},Model.prototype.find=function(predicate){return Model.find(this._list,predicate)},Model.prototype.findAll=function(predicate){return Model.findAll(this._list,predicate)},Model.prototype.add=function(data){var record;return data==null&&(data={}),record=this._table.addRecord(data),this._byId[record.get("id")]},Model.prototype.create=function(data){return data==null&&(data={}),this.add(data)},Model.prototype.all=function(){return this._list},Model.prototype["delete"]=function(instance){var rel,relName,_ref,_results;if(instance.model===this){this._table["delete"](function(_this){return function(record){return record.id==instance.get("id")}}(this)),_ref=instance._relationships,_results=[];for(relName in _ref)rel=_ref[relName],typeof rel.removeAll=="function"&&rel.removeAll(),_results.push(rel.destruct());return _results}throw new Error("incorrect instance model")},Model.prototype.clear=function(){return this._byId={},this._list.clear()},Model}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("models/Product",["model/Model","Site","model/ModelInstance","util"],function(Model,Site,ModelInstance,util){var Product,ProductInstance,ProductRetriever;return ProductRetriever=function(){ProductRetriever.cache={},ProductRetriever.get=function(Product,input){var key,retriever;return key=null,typeof input=="number"||typeof input=="string"?key=input:input.productSid?key=""+input.siteName+"/"+input.productSid:input.productUrl?key=input.productUrl:key=""+input.pageUrl+"|"+input.linkUrl,retriever=this.cache[key],retriever||(retriever=this.cache[key]=new ProductRetriever(Product,input)),retriever};function ProductRetriever(Product,input){this.Product=Product,this.input=input,this.subscribers=[],this.input.productSid?this.product=Product.find({siteName:this.input.siteName,productSid:this.input.productSid}):this.input.retrievalId&&(this.product=Product.find({retrievalId:this.input.retrievalId}))}return ProductRetriever.prototype._retrieve=function(method){return this.retrieving=!0,method(function(_this){return function(product){var subscriber,_i,_len,_ref;_this.product=product;if(_this.subscribers.length){_ref=_this.subscribers;for(_i=0,_len=_ref.length;_i<_len;_i++)subscriber=_ref[_i],subscriber(product);delete _this.subscribers}return _this.retrieving=!1}}(this))},ProductRetriever.prototype.withProduct=function(cb,create){create==null&&(create=!0);if(this.product)return cb(this.product);this.subscribers.push(cb);if(create&&!this.retrieving)return typeof this.input=="number"||typeof this.input=="string"?this._retrieve(function(_this){return function(cb){var product;return product=_this.Product.withId(_this.input),_this.Product.update(product),cb(product)}}(this)):this.input.productSid?this._retrieve(function(_this){return function(cb){return cb(_this.Product.getBySid(_this.input.siteName,_this.input.productSid,_this.input))}}(this)):this.input.retrievalId?this._retrieve(function(_this){return function(cb){var product;return product=_this.Product.find(function(p){return p.get("retrievalId")===_this.input.retrievalId}),product?cb(product):_this.Product.getFromUrl(_this.input.productUrl,_this.input,cb,_this.input.retrievalId)}}(this)):this.input.productUrl?this._retrieve(function(_this){return function(cb){return _this.Product.getFromUrl(_this.input.productUrl,_this.input,cb)}}(this)):this._retrieve(function(_this){return function(cb){return _this.Product.explorativeGet(_this.input.linkUrl,_this.input.pageUrl,_this.input,cb)}}(this));if(!this.retrieving)return cb(null)},ProductRetriever}(),ProductInstance=function(_super){__extends(ProductInstance,_super);function ProductInstance(){return ProductInstance.__super__.constructor.apply(this,arguments)}return ProductInstance.prototype.instanceMethods=["update","displayValue","getDisplayValue","site","interface"],ProductInstance.prototype.site=function(){return Site.site(this.get("siteName"))},ProductInstance.prototype["interface"]=function(cb){return this.model.siteProduct(this,cb)},ProductInstance.prototype.getDisplayValue=function(property){var value;value=this.get(property);if(value===this.model.errorMap[property])switch(property){case"ratingCount":return"error";case"image":return agora.background.getResourceUrl("resources/images/agorabelt-512.png");default:return"(error)"}else switch(property){case"price":return this.get("displayPrice");case"ratingCount":return util.numberWithCommas(value);default:return value}},ProductInstance.prototype.displayValue=function(property){return function(_this){return function(value){return _this.getDisplayValue(property)}}(this)},ProductInstance.prototype.update=function(){return this.model.update(this)},ProductInstance.prototype.retrievers={more:function(cb){var site;return site=Site.site(this._get("siteName")),site.productScraper(this.model.background,this.get("productSid"),function(_this){return function(scraper){return scraper.scrapeProperty("more",function(value,error){return error?cb({}):cb(value)})}}(this))},reviews:function(cb){var site;return site=Site.site(this._get("siteName")),site.productScraper(this.model.background,this.get("productSid"),function(_this){return function(scraper){return scraper.canScrapeProperty("reviews")?scraper.scrapeProperty("reviews",cb):cb()}}(this))},offers:function(cb){var getOffers,site;return site=Site.site(this._get("siteName")),site.config.query?(getOffers=function(_this){return function(){var query;return query=site.config.query(_this),query.site=_this._get("siteName"),_this.model.background.httpRequest(""+_this.model.background.apiRoot+"products.php",{data:query,cb:function(response){return cb(response.products===""?null:response.products)}})}}(this),!site.config.hasMore||this.get("more")?getOffers():this.field("more").observe(function(_this){return function(mutation){if(mutation.value)return _this.field("more").stopObserving(arguments.callee),getOffers()}}(this))):(console.debug("no offers"),cb())}},ProductInstance}(ModelInstance),Product=function(_super){__extends(Product,_super),Product.prototype.errorMap={title:"AGORA_ERROR",image:"AGORA_ERROR",price:"AGORA_ERROR",rating:-1,ratingCount:999999999};function Product(){Product.__super__.constructor.apply(this,arguments),this.ModelInstance=ProductInstance}return Product.prototype.init=function(){return this._list.observe(function(_this){return function(mutation){var instance;if(mutation.type==="insertion"){instance=mutation.value;if(!instance.get("image"))return instance.update()}}}(this))},Product.prototype.update=function(product){var site;if(!env.core)return site=Site.site(product.get("siteName")),site.productScraper(this.background,product.get("productSid"),function(_this){return function(scraper){var allProperties,count,errors,properties,property,version,_i,_j,_len,_len1,_results;version=scraper.versionString(),allProperties=["title","price","image"],__indexOf.call(site.features,"rating")>=0&&(allProperties=allProperties.concat(["rating","ratingCount"])),properties=[];if(product.get("scraper_version")!==version)properties=allProperties;else for(_i=0,_len=allProperties.length;_i<_len;_i++)property=allProperties[_i],product._get(property)==null&&properties.push(property);product.retrieve("more"),Product.node||(__indexOf.call(site.features,"reviews")>=0&&product.retrieve("reviews"),__indexOf.call(site.features,"offers")>=0&&product.retrieve("offers"));if(properties.length){product.set("last_scraped_at",parseInt((new Date).getTime()/1e3)),product.set("scraper_version",version),count=properties.length,errors=0,product.set("status",1),_results=[];for(_j=0,_len1=properties.length;_j<_len1;_j++)property=properties[_j],_results.push(function(property){return scraper.scrapeProperty(property,function(value,error){error?(++errors,product.set(property,_this.errorMap[property])):product.set(property,value);if(!--count)return errors?product.set("status",2):product.set("status",3)})}(property));return _results}}}(this))},Product.prototype.getBySid=function(siteName,productSid,context){var product,site;return console.log(""+siteName+" "+productSid),product=this.find(function(_this){return function(p){return p._get("siteName")===siteName&&p._get("productSid")===productSid}}(this)),site=Site.site(siteName),product||(product=this.add({siteName:siteName,productSid:productSid,image:context!=null?context.image:void 0,retrievalId:context!=null?context.retrievalId:void 0,status:0})),this.update(product),product},Product.prototype.getFromUrl=function(url,context,cb,retrievalId){var site;return site=Site.siteForUrl(url),site.productSid(this.background,url,function(_this){return function(productSid){if(productSid)return cb(_this.getBySid(site.name,productSid,context));throw new Error("failed to get sid from "+url)}}(this),retrievalId)},Product.prototype.explorativeGet=function(linkUrl,pageUrl,context,cb){return linkUrl?this.background.httpRequest(linkUrl,{cb:function(_this){return function(response,extra){return extra.header("Content-Type").match(/^text\/html/)?_this.getFromUrl(linkUrl,context,cb):_this.getFromUrl(pageUrl,context,cb)}}(this)}):this.getFromUrl(pageUrl,context,cb)},Product.prototype.scraper=function(input,cb){return this.resolveInput(input,function(_this){return function(input){var site;return site=Site.site(input.siteName),site.productScraper(_this.background,input.productSid,cb)}}(this))},Product.prototype.resolveInput=function(input,cb){var site;if(input.siteName&&input.productSid)return cb(input);if(input.productUrl)return site=Site.siteForUrl(input.productUrl),site.productSid(this.background,input.productUrl,function(_this){return function(productSid){return cb({siteName:site.name,productSid:productSid})}}(this));throw new Error("invalid input")},Product.prototype.get=function(input,cb,create){var retriever;return create==null&&(create=!0),retriever=ProductRetriever.get(this,input),retriever.withProduct(cb,create)},Product.prototype.siteProduct=function(product,cb){var site;return site=Site.site(product.get("siteName")),site.product(this.background,product,cb)},Product.prototype.images=function(product,cb){return this.siteProduct(product,function(siteProduct){return siteProduct?siteProduct.images(cb):cb()})},Product}(Model)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;define("models/ProductVariant",["model/Model","Site","model/ModelInstance","model/ObservableValue"],function(Model,Site,ModelInstance,ObservableValue){var ProductVariant,ProductVariantInstance;return ProductVariantInstance=function(_super){__extends(ProductVariantInstance,_super);function ProductVariantInstance(){return ProductVariantInstance.__super__.constructor.apply(this,arguments)}return ProductVariantInstance.prototype.instanceMethods=["update","displayValue","getDisplayValue"],ProductVariantInstance.prototype._product=function(){var _ref;return(_ref=this._relationships)!=null?_ref.product:void 0},ProductVariantInstance.prototype.displayValue=function(property){return property==="image"?function(_this){return function(){return _this.field("image").get()}}(this):this._product().displayValue(property)},ProductVariantInstance.prototype.getDisplayValue=function(property){return property==="image"?this.field("image").get():this._product().getDisplayValue(property)},ProductVariantInstance.prototype.retrieve=function(){var args,_ref;return args=1<=arguments.length?__slice.call(arguments,0):[],(_ref=this._product()).retrieve.apply(_ref,args)},ProductVariantInstance.prototype.update=function(){return this._product().update()},ProductVariantInstance.prototype._get=function(field){return field==="id"||field==="product_id"||field==="feelings"||field==="data"||field==="variant"?ProductVariantInstance.__super__._get.apply(this,arguments):this._product()._get(field)},ProductVariantInstance.prototype.get=function(field){return field==="id"||field==="product_id"||field==="feelings"||field==="data"||field==="variant"?ProductVariantInstance.__super__.get.apply(this,arguments):field==="image"?this.field("image").get():this._product().get(field)},ProductVariantInstance.prototype.field=function(name){return name==="id"||name==="product_id"||name==="feelings"||name==="data"||name==="variant"?ProductVariantInstance.__super__.field.apply(this,arguments):name==="image"?(this._image||(this._image=new ObservableValue,this._product().model.siteProduct(this._product(),function(_this){return function(siteProduct){if(siteProduct)return siteProduct.variantImage(_this.get("variant"),function(image){return image?_this._image.set(image):_this._image.set(_this._product().getDisplayValue("image"))})}}(this))),this._image):this._product().field(name)},ProductVariantInstance.prototype.set=function(field,value){if(field!=="product_id")throw new Error("variants are read only");return ProductVariantInstance.__super__.set.apply(this,arguments)},ProductVariantInstance.prototype.isA=function(type){return type==="Product"||type==="ProductVariant"},ProductVariantInstance}(ModelInstance),ProductVariant=function(_super){__extends(ProductVariant,_super);function ProductVariant(){ProductVariant.__super__.constructor.apply(this,arguments),this.ModelInstance=ProductVariantInstance}return ProductVariant}(Model)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("models/Composite",["model/Model","Site"],function(Model,Site){var Composite;return Composite=function(_super){__extends(Composite,_super);function Composite(){return Composite.__super__.constructor.apply(this,arguments)}return Composite.prototype.createWithType=function(type){var composite,slot,slotType,slots,systems,_i,_len;composite=this.create({type:type}),systems={computer:["harddrive","monitor","cpu","ram","motherboard","graphicsCard","powerSupply","keyboard","mouse","soundcard","cooling","speakers"]},slots=systems[type];for(_i=0,_len=slots.length;_i<_len;_i++)slotType=slots[_i],slot=this.manager.getModel("CompositeSlot").create({type:slotType,composite_id:composite.get("id")});return composite},Composite}(Model)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("model/Record",["./ObservableObject","./ObservableValue","underscore"],function(ObservableObject,ObservableValue,_){var Record;return Record=function(_super){__extends(Record,_super);function Record(id,_values,_mappings,table){var name,value;this.id=id,this._values=_values,this._mappings=_mappings,this.table=table,typeof this.id=="string"&&this.id[0]!=="G"&&(this.id=parseInt(this.id)),this.table.canBeExternal&&this.table.db.externalStoreId?this.storeId=this.table.db.externalStoreId:this.storeId=this.table.db.storeId,this._fields={},this._tableName=this.table.name,this._sources={};for(name in _values)value=_values[name],this._values[name]=this._mappings[name]&&value!==null?this._mappings[name](value):value,this._createField(name);this._updateStoreIdFromOwner()}return Record.prototype._addSource=function(source,accumulate){var key;return accumulate==null&&(accumulate=!0),key=""+source.storeId+"."+source.object,this._sources[key]&&accumulate?this._sources[key]++:this._sources[key]=1},Record.prototype._removeSource=function(source){var key;key=""+source.storeId+"."+source.object;if(this._sources[key]&&!--this._sources[key])return delete this._sources[key]},Record.prototype._updateContentsStoreId=function(){var contained,record,_i,_len,_results;contained=this.contained(),_results=[];for(_i=0,_len=contained.length;_i<_len;_i++)record=contained[_i],_results.push(record.storeId=this.storeId);return _results},Record.prototype._updateStoreIdFromOwner=function(){var contained,owner,record,_i,_len,_results;owner=this.owner();if(owner){this.storeId=owner.storeId,contained=this.contained(),_results=[];for(_i=0,_len=contained.length;_i<_len;_i++)record=contained[_i],_results.push(record.storeId=this.storeId);return _results}},Record.prototype._createField=function(name){var field,rel,_i,_len,_ref,_ref1,_ref2,_results;this._fields[name]=field=new ObservableValue(this._values[name],(_ref=this.table.schema.opts)!=null?(_ref1=_ref[name])!=null?_ref1.reassignIdentical:void 0:void 0);if(this.table.graphRels){_ref2=this.table.graphRels,_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){rel=_ref2[_i];if(rel.owns&&rel.field===name){field.observe(function(_this){return function(){return _this._updateContentsStoreId()}}(this));break}if(rel.owner&&rel.field===name){field.observe(function(_this){return function(){return _this._updateStoreIdFromOwner()}}(this));break}_results.push(void 0)}return _results}},Record.prototype.set=function(key,value,timestamp){return key==="store_id"?this.storeId=value:(this._values[key]=this._mappings[key]&&value!==null?this._mappings[key](value):value,this._fields[key]?this._fields[key].set(this._values[key],timestamp):this._createField(key))},Record.prototype.get=function(key){var _ref;switch(key){case"id":return this.id;case"store_id":return this.storeId;default:return(_ref=this._fields[key])!=null?_ref.get():void 0}},Record.prototype.field=function(key){return this._fields[key]},Record.prototype.fields=function(){return _.values(this._fields)},Record.prototype.serialize=function(){return this._values},Record.prototype.globalId=function(){var _ref,_ref1;return(_ref=(_ref1=this.table.db.localToGlobalMapping[this.table.name])!=null?_ref1[this.id]:void 0)!=null?_ref:this.id},Record.prototype.hasGlobal=function(){var _ref;return(this.id+"")[0]==="G"||((_ref=this.table.db.localToGlobalMapping[this.table.name])!=null?_ref[this.id]:void 0)!=null},Record.prototype.tableName=function(){return this.table.name},Record.prototype.saneId=function(){var id;id=this.globalId()+"";if(id[0]==="G")return parseInt(id.substr(1));if(env.localTest)return this.get("id");throw console.log(this),new Error(id)},Record.prototype["delete"]=function(){return this.table["delete"](function(_this){return function(record){return record.get("id")===_this.get("id")}}(this))},Record.prototype.contained=function(recursive){var contained,record,records,rel,table,_i,_j,_len,_len1,_ref;recursive==null&&(recursive=!0),contained=[];if(this.table.graphRels){_ref=this.table.graphRels;for(_i=0,_len=_ref.length;_i<_len;_i++){rel=_ref[_i];if(rel.owns)if(!rel.foreignKey)table=_.isFunction(rel.table)?rel.table(this):rel.table,record=this.table.db.table(table).byId(this.get(rel.field)),record&&(_.isFunction(rel.owns)?rel.owns(record)&&(contained.push(record),recursive&&(contained=contained.concat(record.contained()))):(contained.push(record),contained=contained.concat(record.contained())));else{records=this.table.db.table(rel.table).select(function(_this){return function(record){return record.get(rel.field)===_this.get("id")}}(this));for(_j=0,_len1=records.length;_j<_len1;_j++)record=records[_j],contained.push(record),recursive&&(contained=contained.concat(record.contained()))}}}return contained},Record.prototype.owner=function(){var record,records,rel,table,_i,_len,_ref;if(this.table.graphRels){_ref=this.table.graphRels;for(_i=0,_len=_ref.length;_i<_len;_i++){rel=_ref[_i];if(rel.owner)if(!rel.foreignKey){table=_.isFunction(rel.table)?rel.table(this):rel.table,record=this.table.db.table(table).byId(this.get(rel.field));if(record)return record}else{rel.filter?records=this.table.db.table(rel.table).select(function(_this){return function(record){return record.get(rel.field)===_this.get("id")&&rel.filter(_this,record)}}(this)):records=this.table.db.table(rel.table).select(function(_this){return function(record){return record.get(rel.field)===_this.get("id")}}(this));if(records[0])return records[0]}}}},Record}(ObservableObject)});var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("model/Table",["./ObservableArray","./ObservableObject","./Record","underscore","util"],function(ObservableArray,ObservableObject,Record,_,util){var Table;return Table=function(){function Table(name,args){var contents,field,fieldName,r,record,referent,rel,rels,type,value,_base,_base1,_base2,_base3,_base4,_base5,_base6,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;this.name=name,args&&(this.schema=args.schema,contents=args.contents),this.records=new ObservableArray,this.records.name="Table::"+this.name;if(contents)for(_i=0,_len=contents.length;_i<_len;_i++)record=contents[_i],this.addRecord(record);this.mappings={},this.rid=1,this._recordsByRid={},this.schema==null&&(this.schema={}),(_base=this.schema).fields==null&&(_base.fields=[]),(_base1=this.schema).types==null&&(_base1.types={}),(_base2=this.schema).defaultValues==null&&(_base2.defaultValues={}),this.records.observe(function(_this){return function(mutation){if(mutation.type==="deletion")return delete _this._recordsByRid[mutation.value.get("id")]}}(this));if(args!=null?args.graph:void 0){this.onGraph=!0,this.graphRoot=args.graph.root,this.graphRels=rels=[],_ref=args.graph;for(name in _ref){rel=_ref[name],_.isArray(rel)||(rel=[rel]);for(_j=0,_len1=rel.length;_j<_len1;_j++)r=rel[_j],r.table?rels.push({table:r.table,owns:r.owns,owner:r.owner,field:name,filter:r.filter}):r.field&&rels.push({foreignKey:!0,field:r.field,table:name,owns:r.owns,owner:r.owner,filter:r.filter})}}else this.onGraph=args!=null?args.onGraph:void 0;this.canBeExternal=(_ref1=args!=null?(_ref2=args.graph)!=null?_ref2.canBeExternal:void 0:void 0)!=null?_ref1:!0;if(this.schema){(_base3=this.schema).fields==null&&(_base3.fields=[]);if(this.schema.referents){_ref3=this.schema.referents;for(field in _ref3)referent=_ref3[field],((_ref4=this.schema)!=null?(_ref5=_ref4.types)!=null?_ref5[field]:void 0:void 0)||((_base4=this.schema).types==null&&(_base4.types={}),this.schema.types[field]="id")}this.schema.autoIncrement&&((_base5=this.schema).types==null&&(_base5.types={}),this.schema.types[this.schema.autoIncrement]="int");if(this.schema.defaultValues){_ref6=this.schema.defaultValues;for(fieldName in _ref6){value=_ref6[fieldName],__indexOf.call(this.schema.fields,fieldName)<0&&this.schema.fields.push(fieldName);if(!this.schema.types||!(fieldName in this.schema.types))(_base6=this.schema).types==null&&(_base6.types={}),this.schema.types[fieldName]=function(){if(_.isBoolean(value))return"bool";if(_.isString(value))return"string";if(_.isNumber(value))return value%1===0?"int":"float";throw new Error("invalid default value")}()}}if(this.schema.types){_ref7=this.schema.types;for(fieldName in _ref7){type=_ref7[fieldName],__indexOf.call(this.schema.fields,fieldName)<0&&this.schema.fields.push(fieldName);switch(type){case"object":this.mappings[fieldName]=function(value){return _.isString(value)?JSON.parse(value):value};break;case"datetime":this.mappings[fieldName]=function(value){return _.isString(value)?Date.parse(value):value};break;case"bool":this.mappings[fieldName]=function(value){if(_.isBoolean(value))return value;if(_.isString(value))return value==="true"?!0:value==="false"?!1:!!parseInt(value);if(_.isNumber)return!!value};break;case"int":this.mappings[fieldName]=function(value){return _.isString(value)&&(value=value.replace(/,/g,"")),parseInt(value)};break;case"float":this.mappings[fieldName]=function(value){return parseFloat(value)};break;case"id":this.mappings[fieldName]=function(value){return typeof value=="string"&&value[0]==="G"?value:parseInt(value)}}}}}}return Table.prototype.clear=function(){return this["delete"](function(){return 1}),this._recordsByRid={}},Table.prototype.executeChanges=function(changes,source){var key,record,recordChanges,referentTable,rid,value,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_results;_results=[];for(rid in changes){recordChanges=changes[rid],rid=(_ref=(_ref1=this.db.globalToLocalMapping)!=null?(_ref2=_ref1[this.name])!=null?_ref2[rid]:void 0:void 0)!=null?_ref:rid;if(recordChanges==="deleted")_results.push(this.records.deleteIf(function(record){return record.id==rid}));else{for(key in recordChanges){value=recordChanges[key];if(referentTable=(_ref3=this.schema)!=null?(_ref4=_ref3.referents)!=null?_ref4[key]:void 0:void 0)_.isFunction(referentTable)&&(referentTable=referentTable(recordChanges)),recordChanges[key]=(_ref5=(_ref6=this.db.globalToLocalMapping[referentTable])!=null?_ref6[value]:void 0)!=null?_ref5:value}record=this._recordsByRid[rid],record?_results.push(function(){var _results1;_results1=[];for(key in recordChanges)value=recordChanges[key],record.get(key)!==value?_results1.push(record.set(key,value)):_results1.push(void 0);return _results1}()):_results.push(this._addRecord(recordChanges,rid))}}return _results},Table.prototype.serialize=function(){var table;return table={rid:this.rid,records:{}},this.records.each(function(record){return table.records[record.id]=record.serialize()}),table},Table.prototype._nextAutoIncrement=function(){return this._autoIncrement?++this._autoIncrement:this._autoIncrement=1},Table.prototype._addRecord=function(data,rid){var field,record,type,_i,_len,_ref,_ref1;if(this.schema){if(this.schema.fields){_ref=this.schema.fields;for(_i=0,_len=_ref.length;_i<_len;_i++)field=_ref[_i],field in data||(data[field]=null)}if(this.schema.types){_ref1=this.schema.types;for(field in _ref1)type=_ref1[field],field in data||(data[field]=null)}}return record=new Record(rid,data,this.mappings,this),this.records.push(record),this._recordsByRid[record.id]=record,record},Table.prototype.addRecord=function(data){var field,fieldName,value,_i,_len,_ref,_ref1;if(this.schema){if(this.schema.autoIncrement)if(!data[this.schema.autoIncrement])data[this.schema.autoIncrement]=this._nextAutoIncrement();else{data[this.schema.autoIncrement]=parseInt(data[this.schema.autoIncrement]);if(this._autoIncrement<data[this.schema.autoIncrement]||!this._autoIncrement)this._autoIncrement=data[this.schema.autoIncrement]}if(this.schema.defaultValues){_ref=this.schema.defaultValues;for(fieldName in _ref)value=_ref[fieldName],fieldName in data||(data[fieldName]=value)}if(this.schema.fields){_ref1=this.schema.fields;for(_i=0,_len=_ref1.length;_i<_len;_i++)field=_ref1[_i],field in data||(data[field]=null)}}return this._addRecord(data,this.rid++)},Table.prototype.insert=function(data){return this.addRecord(data)},Table.prototype.select=function(query){var results;return results=[],this.records.each(function(_this){return function(record){if(query(record))return results.push(record)}}(this)),results},Table.prototype.selectFirst=function(query){return util.find(this.records,query)},Table.prototype["delete"]=function(predicate){return this.records.deleteIf(function(record){return predicate(record)})},Table.prototype.observe=function(observer){var observeField,observeRecord;return observeField=function(record,field){return record.field(field).observe(function(mutation){return observer({type:"update",record:record,field:field})})},observeRecord=function(_this){return function(record){var field,_i,_len,_ref,_results;if(record.table.schema.fields){_ref=record.table.schema.fields,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)field=_ref[_i],_results.push(observeField(record,field));return _results}}}(this),this.records.each(observeRecord),this.records.observe(function(mutation){if(mutation.type==="insertion")return observer({type:"insertion",record:mutation.value}),observeRecord(mutation.value);if(mutation.type==="deletion")return observer({type:"deletion",record:mutation.value})})},Table.prototype.byId=function(id){return this._recordsByRid[id]},Table.prototype.byGlobalId=function(id){var _ref,_ref1,_ref2;return this.byId((_ref=(_ref1=this.db.globalToLocalMapping)!=null?(_ref2=_ref1[this.name])!=null?_ref2[id]:void 0:void 0)!=null?_ref:id)},Table.prototype.bySaneId=function(id){return this.byGlobalId("G"+id)},Table}()}),define("model/Database",["./Event","./Table"],function(Event,Table){var Database;return Database=function(){function Database(){this.tables={},this.localToGlobalMapping={},this.globalToLocalMapping={},this.events={onBeforeExecuteChanges:new Event,onAfterExecuteChanges:new Event}}return Database.prototype.addTable=function(){var table;return typeof arguments[0]=="string"?this.addTable(new Table(arguments[0],arguments[1])):(table=arguments[0],table.db=this,this.tables[table.name]=table)},Database.prototype.table=function(name){var table;table=this.tables[name];if(!table)throw new Error("table `"+name+"` not found");return table},Database.prototype.addMapping=function(mapping){var globalId,localId,map,table,_base,_base1,_results;_results=[];for(table in mapping)map=mapping[table],(_base=this.localToGlobalMapping)[table]==null&&(_base[table]={}),(_base1=this.globalToLocalMapping)[table]==null&&(_base1[table]={}),_results.push(function(){var _results1;_results1=[];for(localId in map)globalId=map[localId],this.localToGlobalMapping[table][localId]=globalId,_results1.push(this.globalToLocalMapping[table][globalId]=localId);return _results1}.call(this));return _results},Database.prototype.executeChanges=function(allChanges,source){var changes,name;this.events.onBeforeExecuteChanges.fire();for(name in allChanges)changes=allChanges[name],this.table(name).executeChanges(changes,source);return this.events.onAfterExecuteChanges.fire()},Database.prototype.clear=function(){var name,table,_ref,_results;this.localToGlobalMapping={},this.globalToLocalMapping={},_ref=this.tables,_results=[];for(name in _ref)table=_ref[name],_results.push(table.clear());return _results},Database.prototype.data=function(){var name,records,table,tables,_ref;tables={},_ref=this.tables;for(name in _ref)table=_ref[name],records={},table.records.each(function(record){return records[record.get("id")]=record._values}),tables[name]=records;return tables},Database.prototype.setData=function(data){var id,maxId,name,record,table;for(name in data){table=data[name],maxId=0;for(id in table)record=table[id],id=parseInt(id),id>maxId&&(maxId=id);this.tables[name].rid=maxId+1}return this.executeChanges(data)},Database}()}),define("model/ModelManager",["./Model","./Event"],function(Model,Event){var ModelManager;return ModelManager=function(){function ModelManager(db,background){this.db=db,this.background=background,this._models={},this.db.events.onBeforeExecuteChanges.subscribe(function(_this){return function(){return _this.pauseRelationships()}}(this)),this.db.events.onAfterExecuteChanges.subscribe(function(_this){return function(){return _this.resumeRelationships()}}(this)),this.events={onFault:new Event},this._modelsByTable={}}return ModelManager.prototype.pauseRelationships=function(){return this.relationshipsPaused=!0,this.relationshipsQueue=[],this.mutations=[]},ModelManager.prototype.resumeRelationships=function(){var instance,mutation,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3;this.relationshipsPaused=!1,_ref=this.relationshipsQueue;for(_i=0,_len=_ref.length;_i<_len;_i++)instance=_ref[_i],instance._createRelationships();_ref1=this.relationshipsQueue;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)instance=_ref1[_j],instance._initRelationships();_ref2=this.mutations;for(_k=0,_len2=_ref2.length;_k<_len2;_k++)mutation=_ref2[_k],mutation.observer(mutation.mutation);_ref3=this.relationshipsQueue;for(_l=0,_len3=_ref3.length;_l<_len3;_l++)instance=_ref3[_l],instance.model.events.onCreate.fire(instance,instance.model);return delete this.relationshipsQueue,delete this.mutations},ModelManager.prototype.clear=function(){var model,name,_i,_len,_ref,_results;_ref=this._models,_results=[];for(model=_i=0,_len=_ref.length;_i<_len;model=++_i)name=_ref[model],_results.push(model.clear());return _results},ModelManager.prototype.model=function(name){return this.getModel(name)},ModelManager.prototype.instanceForRecord=function(record){var model;if(record)return model=this._modelsByTable[record.table.name],model.withId(record.get("id"))},ModelManager.prototype.getModel=function(name){var model;model=this._models[name];if(model)return model;throw new Error("no model '"+name+"'")},ModelManager.prototype.instance=function(model,id){return this.getInstance(model,id)},ModelManager.prototype.getInstance=function(model,id,throwError){return throwError==null&&(throwError=!0),this.getModel(model).withId(id,throwError)},ModelManager.prototype.addModel=function(modelName,modelDef){var _ref;return this._modelsByTable[modelDef.table]=this._models[modelName]=new((_ref=modelDef["class"])!=null?_ref:Model)(this,modelName,this.background,modelDef)},ModelManager.prototype.initModels=function(){var model,modelName,_ref,_results;_ref=this._models,_results=[];for(modelName in _ref)model=_ref[modelName],_results.push(model._initRelationships());return _results},ModelManager.prototype.defineModels=function(definitions){var modelDef,modelName;if(definitions)for(modelName in definitions)modelDef=definitions[modelName],this.addModel(modelName,modelDef);return this.initModels()},ModelManager}()}),define("models/init",["models/Product","models/ProductVariant","models/Composite","model/Table","model/Database","model/ModelManager","Site","model/ObservableArray","model/auxiliary/maintainOrder","model/HasManyRelationship","util"],function(Product,ProductVariant,Composite,Table,Database,ModelManager,Site,ObservableArray,maintainOrder,HasManyRelationship,util){return function(background){var addElementType,db,forProducts,isObjectInShoppingBar,isProductInShoppingBar,map,modelManager;return map=function(record){switch(record.element_type){case"Product":return"products";case"ProductVariant":return"product_variants";case"Decision":return"decisions";case"Composite":return"composites";case"Bundle":return"bundles";case"Session":return"sessions";case"List":return"lists";case"Descriptor":return"descriptors";case"ObjectReference":return"object_references"}},db=new Database,db.schema=1,modelManager=new ModelManager(db,background),addElementType=function(args){var fields,graph,lc,model,parentKey,parentTable,referents,relationships,table,types,_ref;return args.hasParent==null&&(args.hasParent=!0),table=parentKey=parentTable=model=null,args["for"]&&(lc=args["for"].toLowerCase(),table=""+lc+"_elements",args.hasParent&&(parentKey=""+lc+"_id"),parentTable=""+lc+"s",model=""+args["for"]+"Element"),args.table&&(table=args.table),args.parentKey&&(parentKey=args.parentKey),args.parentTable&&(parentTable=args.parentTable),args.model&&(model=args.model),types={element_id:"id",element_type:"string",index:"int",creator_id:"id"},args.hasParent&&(types[parentKey]="id"),args.types&&_.extend(types,args.types),referents={element_id:map},args.hasParent&&(referents[parentKey]=parentTable),fields=[],args.hasParent&&fields.push(parentKey),graph={element_id:{table:function(record){return map(record._values)},owns:function(record){var _ref;return(_ref=record.table.name)!=="products"&&_ref!=="product_variants"}}},args.graph&&_.extend(graph,args.graph),args.hasParent&&(graph[parentKey]={table:parentTable,owner:!0}),db.addTable(table,{schema:{fields:fields,types:types,referents:referents,opts:{element_id:{reassignIdentical:!0},element_type:{reassignIdentical:!0}}},graph:graph}),relationships={element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}},args.hasParent&&(relationships.parent={type:"hasOne",relKey:parentKey,model:(_ref=args.parentModel)!=null?_ref:args["for"]}),modelManager.addModel(model,{orderBy:args.orderBy,table:table,relationships:relationships})},db.addTable("users",{schema:{types:{tutorial_step:"int",user_colors:"string",tutorials:"string"},defaultValues:{tutorial_step:0}},onGraph:!0}),db.addTable("collaborators",{schema:{types:{object:"string",object_user_id:"id",user_id:"id",active:"bool"},defaultValues:{active:!1}}}),db.addTable("products",{schema:{fields:["image","title","price","reviews","sem3_id","coupons"],local:["sem3_id","coupons","inShoppingBar"],types:{inShoppingBar:"object",more:"object",offers:"object",offer:"object",retrievalId:"string",rating:"float",ratingCount:"int",last_scraped_at:"int",scraper_version:"string",status:"int",price:"string"},defaultValues:{purchased:!1},opts:{more:{reassignIdentical:!0}}},graph:{canBeExternal:!1}}),db.addTable("product_variants",{schema:{types:{variant:"object"},referents:{product_id:"products"},defaultValues:{schema_version:0}},graph:{canBeExternal:!1}}),db.addTable("site_settings",{schema:{fields:["site","enabled"],types:{enabled:"int"}}}),db.addTable("bundles",{graph:{root_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},bundle_elements:[{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},{field:"bundle_id",owns:!0}],list_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},session_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},belt_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}}}}),db.addTable("competitive_lists"),db.addTable("lists",{schema:{types:{descriptor:"object"},defaultValues:{collapsed:!1}},graph:{list_elements:{field:"list_id",owns:!0},decisions:{field:"list_id",owner:!0}}}),db.addTable("belts",{schema:{types:{title:"string",shared:"bool"},referents:{user_id:"users"}},graph:{belt_elements:{field:"belt_id",owns:!0}}}),db.addTable("composites"),db.addTable("composite_slots",{schema:{types:{index:"int",composite_id:"id",element_id:"id",element_type:"string"},referents:{element_id:map,composite_id:"composites"},opts:{element_id:{reassignIdentical:!0}}}}),db.addTable("sessions",{schema:{types:{title:"string"},defaultValues:{collapsed:!1}},graph:{session_elements:{field:"session_id",owns:!0},root_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},belt_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}}}}),db.addTable("decisions",{schema:{referents:{list_id:"lists"},types:{display_options:"object",share_title:"string",share_message:"string",shared:"bool",access:"int"},defaultValues:{access:0},opts:{display_options:{reassignIdentical:!0}}},graph:{list_id:{table:"lists",owns:!0},decision_elements:{field:"decision_id",owns:!0},root_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},bundle_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},list_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},session_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},belt_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}}}}),db.addTable("object_references",{schema:{types:{object_user_id:"id",object:"string"}},graph:{root_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},bundle_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},list_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},session_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}},belt_elements:{field:"element_id",owner:!0,filter:function(record,otherRecord){return map(otherRecord._values)===record.table.name}}}}),db.addTable("decision_elements",{schema:{types:{row:"int"},defaultValues:{row:0,selected:!1,dismissed:!1},referents:{decision_id:"decisions",list_element_id:"list_elements"}},graph:{decision_id:{table:"decisions",owner:!0}}}),db.addTable("data",{schema:{types:{type:"string",url:"string",title:"string",text:"string",comment:"string",element_type:"string"},referents:{element_id:map}}}),db.addTable("feelings",{schema:{types:{positive:"int",negative:"int",thought:"string",element_type:"string",timestamp:"datetime"},referents:{element_id:map}},graph:{onGraph:!0}}),db.addTable("arguments",{schema:{types:{"for":"int",against:"int",thought:"string",element_type:"string",timestamp:"datetime"},referents:{element_id:map}}}),db.addTable("descriptors",{schema:{types:{descriptor:"object",element_type:"string"},referents:{element_id:map},opts:{element_id:{reassignIdentical:!0}}}}),db.addTable("shared_objects",{schema:{types:{object:"string",title:"string",user_id:"id",with_user_id:"id",user_name:"string",with_user_name:"string",seen:"bool"}}}),db.addTable("activity",{schema:{types:{user_id:"id",generator_id:"id",timestamp:"int",type:"string",object_type:"string",object_id:"id",args:"object"}}}),addElementType({"for":"Root",parentKey:"user_id",parentTable:"users",parentModel:"User"}),addElementType({"for":"Collection",hasParent:!1,orderBy:{field:"index",direction:"asc"}}),addElementType({"for":"Session"}),addElementType({"for":"Composite"}),addElementType({"for":"Bundle"}),addElementType({"for":"CompetitiveList",table:"competitive_list_elements",parentKey:"competitive_list_id",parentTable:"competitive_lists"}),addElementType({"for":"List"}),addElementType({"for":"Belt"}),modelManager.defineModels({User:{table:"users",relationships:{belts:{type:"hasMany",model:"Belt",foreignKey:"user_id"},rootElements:{type:"hasMany",model:"RootElement",foreignKey:"user_id",orderBy:{field:"index",direction:"asc"}},sharedWithMe:{type:"hasMany",model:"SharedObject",foreignKey:"with_user_id"},unseenSharedWithMe:{type:"hasMany",model:"SharedObject",foreignKey:"with_user_id",filter:function(instance){return!instance.get("seen")}}}},CompetitiveList:{table:"competitive_lists",relationships:{elements:{type:"hasMany",model:"CompetitiveListElement",foreignKey:"competitive_list_id",orderBy:{field:"index",direction:"asc"}},contents:{type:"hasMany",through:"competitive_list_elements",foreignKey:"competitive_list_id",relKey:"element_id",orderBy:{field:"index",direction:"asc"},model:function(record){return record.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}}}}},Belt:{table:"belts",relationships:{elements:{type:"hasMany",model:"BeltElement",foreignKey:"belt_id",orderBy:{field:"index",direction:"asc"}},contents:{type:"hasMany",through:"belt_elements",foreignKey:"belt_id",relKey:"element_id",orderBy:{field:"index",direction:"asc"},model:function(record){return record.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}}}}},List:{table:"lists",relationships:{elements:{type:"hasMany",model:"ListElement",foreignKey:"list_id",orderBy:{field:"index",direction:"asc"}},contents:{type:"hasMany",through:"list_elements",foreignKey:"list_id",relKey:"element_id",orderBy:{field:"index",direction:"asc"},model:function(record){return record.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}}}}},Decision:{table:"decisions",relationships:{list:{type:"hasOne",relKey:"list_id",model:"List"},listElements:{type:"hasMany",through:"decision_elements",model:"ListElement",foreignKey:"decision_id",relKey:"list_element_id"},elements:{type:"hasMany",foreignKey:"decision_id",model:"DecisionElement","for":{path:"list.elements",key:"list_element_id"}},selection:{type:"hasMany",through:"decision_elements",throughFilter:function(record){return record.get("selected")},model:"ListElement",foreignKey:"decision_id",relKey:"list_element_id",remove:function(instance){return this._instance.get("listElements").instanceForInstance(instance).set("selected",!1)},add:function(instance){return this._instance.get("listElements").add(instance),this._instance.get("listElements").instanceForInstance(instance).set("selected",!0)}},dismissed:{type:"hasMany",through:"decision_elements",throughFilter:function(record){return record.get("dismissed")},model:"ListElement",foreignKey:"decision_id",relKey:"list_element_id",remove:function(instance){return this._instance.get("listElements").instanceForInstance(instance).set("dismissed",!1)},add:function(instance){return this._instance.get("listElements").add(instance),this._instance.get("listElements").instanceForInstance(instance).set("dismissed",!0)}},considering:{type:"hasMany",through:"decision_elements",throughFilter:function(record){return!record.get("dismissed")},model:"ListElement",foreignKey:"decision_id",relKey:"list_element_id",remove:function(instance){return this._instance.get("listElements").instanceForInstance(instance).set("dismissed",!0)},add:function(instance){return this._instance.get("listElements").add(instance),this._instance.get("listElements").instanceForInstance(instance).set("dismissed",!1)}}}},DecisionElement:{table:"decision_elements",relationships:{element:{type:"hasOne",model:"ListElement",relKey:"list_element_id"},decision:{type:"hasOne",model:"Decision",relKey:"decision_id"}}},Bundle:{table:"bundles",relationships:{elements:{type:"hasMany",model:"BundleElement",foreignKey:"bundle_id",orderBy:{field:"index",direction:"asc"}},contents:{type:"hasMany",through:"bundle_elements",relKey:"element_id",foreignKey:"bundle_id",model:function(record){return record.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}},orderBy:{field:"index",direction:"asc"}}}},Descriptor:{table:"descriptors",relationships:{element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}}},ObjectReference:{table:"object_references"},CompositeSlot:{table:"composite_slots",relationships:{element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}}},Composite:{"class":Composite,table:"composites",relationships:{slots:{type:"hasMany",foreignKey:"composite_id",model:"CompositeSlot",orderBy:{field:"index",direction:"asc"}},additionalContents:{type:"hasMany",through:"composite_elements",foreignKey:"composite_id",relKey:"element_id",model:function(instance){return instance.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}},orderBy:{field:"index",direction:"asc"}},additionalElements:{type:"hasMany",foreignKey:"composite_id",model:"CompositeElement",orderBy:{field:"index",direction:"asc"}},contents:function(instance){var list,onInstance,rel,_i,_len,_ref;list=new ObservableArray,onInstance=function(inst){return inst.set("index",list.length()),list.push(inst),maintainOrder({field:"index",direction:"asc"},inst,list)},_ref=["slots","additionalElements"];for(_i=0,_len=_ref.length;_i<_len;_i++)rel=_ref[_i],instance.get(rel).each(onInstance),instance.get(rel).observe(function(mutationInfo){var i,_j,_ref1,_ref2,_results;if(mutationInfo.type==="insertion")return onInstance(mutationInfo.value);if(mutationInfo.type==="deletion"){list.remove(mutationInfo.value);if(list.length()>1){_results=[];for(i=_j=_ref1=Math.min(instance.get("index"),list.length()-1),_ref2=list.length();_ref1<=_ref2?_j<_ref2:_j>_ref2;i=_ref1<=_ref2?++_j:--_j)_results.push(list.get(i).set("index",i));return _results}}});return{add:function(inst){return inst.model.name==="CompositeSlot"?instance.get("slots").add(inst):instance.get("additionalElements").add(inst)},remove:function(inst){return inst.model.name==="CompositeSlot"?instance.get("slots").remove(inst):instance.get("additionalElements").remove(inst)},instanceForInstance:function(inst){return inst.model.name==="CompositeSlot"?instance.get("slots").instanceForInstance(inst):instance.get("additionalElements").instanceForInstance(inst)},observe:function(){return list.observe.apply(list,arguments)},stopObserving:function(){return list.stopObserving.apply(list,arguments)},each:function(){return list.each.apply(list,arguments)},get:function(){return list.get.apply(list,arguments)}}}}},Session:{table:"sessions",relationships:{elements:{type:"hasMany",model:"SessionElement",foreignKey:"session_id",orderBy:{field:"index",direction:"asc"}},contents:{type:"hasMany",through:"session_elements",foreignKey:"session_id",relKey:"element_id",orderBy:{field:"index",direction:"asc"},model:function(record){return record.get("element_type")},defaultValues:function(instance){return{element_type:instance.model.name}}}}},Product:{"class":Product,table:"products",properties:{url:function(){return"http://agora.sh/product/"+this._get("siteName")+"/"+this.get("productSid")},currency:function(){return this._get("currency")?this._get("currency"):Site.site(this._get("siteName")).config.currency},displayPrice:function(){var currencySymbolMap;return this.get("price")===this.model.errorMap.price?"(error)":this.get("currency")==="embedded"?this.get("price")===""?"(none)":this.get("price"):this.get("price")!=null&&this.get("currency")?(currencySymbolMap={dollar:"$",euro:"EUR "},""+currencySymbolMap[this.get("currency")]+this.get("price")):this.get("price")},displayUserPrice:function(){var currencySymbolMap,price;if(this.get("currency")==="embedded")return this.get("userPrice")===""?"(none)":this.get("userPrice");if(this.get("offer"))return currencySymbolMap={dollar:"$",euro:"EUR "},price=parseFloat(this.get("offer").price).toFixed(2),price=util.numberWithCommas(price),""+currencySymbolMap[this.get("currency")]+price},siteUrl:function(){return this._get("siteName")==="General"?this._get("productSid").split("/").slice(0,3).join("/"):Site.site(this._get("siteName")).url},siteName:function(){var name;return this._get("siteName")==="General"?(name=this._get("productSid").split("/")[2],/^www\./.exec(name)&&(name=name.substr(4)),name):this._get("siteName")}},relationships:{data:{type:"hasMany",model:"Datum",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="Product"}},feelings:{type:"hasMany",model:"Feeling",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="Product"}},arguments:{type:"hasMany",model:"Argument",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="Product"}},lists:{type:"hasMany",through:"list_elements",model:"List",relKey:"list_id",foreignKey:"element_id",throughFilter:function(record){return record.get("element_type")==="Product"}},bundles:{type:"hasMany",through:"bundle_elements",model:"Bundle",relKey:"bundle_id",foreignKey:"element_id",throughFilter:function(record){return record.get("element_type")==="Product"}},variants:{type:"hasMany",model:"ProductVariant",foreignKey:"product_id"},root:{type:"hasMany",model:"RootElement",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="Product"}}}},ProductVariant:{"class":ProductVariant,table:"product_variants",relationships:{product:{type:"hasOne",relKey:"product_id",model:"Product"},data:{type:"hasMany",model:"Datum",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="ProductVariant"}},feelings:{type:"hasMany",model:"Feeling",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="ProductVariant"}},arguments:{type:"hasMany",model:"Argument",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="ProductVariant"}},lists:{type:"hasMany",through:"list_elements",model:"List",relKey:"list_id",foreignKey:"element_id",throughFilter:function(record){return record.get("element_type")==="ProductVariant"}},bundles:{type:"hasMany",through:"bundle_elements",model:"Bundle",relKey:"bundle_id",foreignKey:"element_id",throughFilter:function(record){return record.get("element_type")==="ProductVariant"}},root:{type:"hasMany",model:"RootElement",foreignKey:"element_id",filter:function(record){return record.get("element_type")==="ProductVariant"}}}},Datum:{table:"data",relationships:{element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}}},Feeling:{table:"feelings",relationships:{element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}}},Argument:{table:"arguments",relationships:{element:{type:"hasOne",relKey:"element_id",model:function(instance){return instance.get("element_type")}}}},SharedObject:{table:"shared_objects"}}),isObjectInShoppingBar=function(obj){var beltElement,beltElements,bundleElement,bundleElements,decision,listElement,listElements,response,_i,_j,_k,_len,_len1,_len2;if(beltElements=modelManager.getModel("BeltElement").findAll({element_type:obj.modelName,element_id:obj.get("id")}))if(beltElements.length){response={};for(_i=0,_len=beltElements.length;_i<_len;_i++)beltElement=beltElements[_i],response[beltElement.get("parent").get("user_id")]=!0;return response}listElements=modelManager.getModel("ListElement").findAll({element_type:obj.modelName,element_id:obj.get("id")});for(_j=0,_len1=listElements.length;_j<_len1;_j++){listElement=listElements[_j],decision=modelManager.getModel("Decision").find({list_id:listElement.get("list_id")});if(decision)if(response=isObjectInShoppingBar(decision))return response}bundleElements=modelManager.getModel("BundleElement").findAll({element_type:obj.modelName,element_id:obj.get("id")});for(_k=0,_len2=bundleElements.length;_k<_len2;_k++){bundleElement=bundleElements[_k];if(response=isObjectInShoppingBar(bundleElement.get("parent")))return response}return!1},isProductInShoppingBar=function(product){var beltElement,beltElements,bundle,decision,i,list,response,_i,_j,_k,_l,_len,_ref,_ref1,_ref2;if(beltElements=modelManager.getModel("BeltElement").findAll({element_type:"Product",element_id:product.get("id")}))if(beltElements.length){response={};for(_i=0,_len=beltElements.length;_i<_len;_i++)beltElement=beltElements[_i],response[beltElement.get("parent").get("user_id")]=!0;return response}for(i=_j=0,_ref=product.get("lists").length();0<=_ref?_j<_ref:_j>_ref;i=0<=_ref?++_j:--_j){list=product.get("lists").get(i),decision=modelManager.getModel("Decision").find({list_id:list.get("id")});if(decision)if(response=isObjectInShoppingBar(decision))return response}for(i=_k=0,_ref1=product.get("bundles").length();0<=_ref1?_k<_ref1:_k>_ref1;i=0<=_ref1?++_k:--_k){bundle=product.get("bundles").get(i);if(response=isObjectInShoppingBar(bundle))return response}for(i=_l=0,_ref2=product.get("variants").length();0<=_ref2?_l<_ref2:_l>_ref2;i=0<=_ref2?++_l:--_l)if(response=isObjectInShoppingBar(product.get("variants").get(i)))return response;return!1},forProducts=function(element,cb){if(element.get("element_type")==="Product")return cb(element.get("element"));if(element.get("element_type")==="ProductVariant")return cb(modelManager.getModel("Product").withId(element.get("element").get("product_id")));if(element.get("element_type")==="Decision")return element.get("element").get("list").get("elements").each(function(element){return forProducts(element,cb)});if(element.get("element_type")==="Bundle")return element.get("element").get("elements").each(function(element){return forProducts(element,cb)})},modelManager.getModel("ListElement").events.onCreate.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),modelManager.getModel("ListElement").events.onRemove.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),modelManager.getModel("BundleElement").events.onCreate.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),modelManager.getModel("BundleElement").events.onRemove.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),modelManager.getModel("BeltElement").events.onCreate.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),modelManager.getModel("BeltElement").events.onRemove.subscribe(function(instance){return forProducts(instance,function(product){return product.set("inShoppingBar",isProductInShoppingBar(product))})}),{db:db,modelManager:modelManager}}}),define("CommandExecuter",[],function(){var CommandExecuter;return CommandExecuter=function(){function CommandExecuter(background){this.background=background}return CommandExecuter.prototype.returnResult=function(command,result){return this.background.httpRequest(""+this.background.apiRoot+"returnCommand.php",{method:"post",data:{commandId:command.id,result:JSON.stringify(result)}})},CommandExecuter.prototype.executeCommands=function(commands){var commandEntry,_i,_len,_results;_results=[];for(_i=0,_len=commands.length;_i<_len;_i++)commandEntry=commands[_i],_results.push(function(_this){return function(commandEntry){var command;command=JSON.parse(commandEntry.command);if(command.command==="scrapeProduct")return agora.Site.site(command.arguments[0]).productScraper(agora.background,command.arguments[1],function(scraper){var props;return props=["title","price","image","rating","ratingCount","more","reviews"],scraper.scrape(props,function(properties){return _this.returnResult(commandEntry,properties)})});if(command.command==="getPage")return _this.background.httpRequest(command.arguments[0],{cb:function(response){return _this.returnResult(commandEntry,response)}});if(command.command==="updateScrapers")return agora.updateScrapers(function(result){return _this.returnResult(commandEntry,result)});if(command.command==="getVersion")return _this.returnResult(commandEntry,chrome.runtime.getManifest().version);if(command.command==="reloadExtension")return chrome.runtime.reload();if(command.commmand==="getData")return _this.returnResult(commandEntry,agora.db.data())}}(this)(commandEntry));return _results},CommandExecuter}()});var __slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("Updater2",["underscore","model/ModelInstance","CommandExecuter","model/ObservableValue","model/Event"],function(_,ModelInstance,CommandExecuter,ObservableValue,Event){var MessageStream,Updater,UpdaterTransport,WebSocketTransport,parse;return parse=function(_this){return function(json,cb){var e;cb==null&&(cb=null);if(cb)try{return cb(!0,JSON.parse(json))}catch(_error){return cb(!1,json)}else try{return JSON.parse(json)}catch(_error){e=_error}}}(this),UpdaterTransport=function(){function UpdaterTransport(updater){this.updater=updater}return UpdaterTransport}(),MessageStream=function(){function MessageStream(){this.queue=[],this.number=0}return MessageStream.prototype.clearMessageQueue=function(){return this.queue=[]},MessageStream.prototype._sendMessage=function(type,params){var code;return _.isFunction(params[params.length-1])&&(this.cb=params[params.length-1],params=params.slice(0,-1)),this.working=!0,this.type=type,code=this.messageTypes[type].code,this.currentNumber=this.number++,this.ws.send(""+code+this.currentNumber+"	"+params.join("	")),this.timerId=setTimeout(function(_this){return function(){return agora.background.error("MessageStreamError","timeout",_this.type),_this.interupted()}}(this),15e3)},MessageStream.prototype.sendMessage=function(){var params,type;return type=arguments[0],params=2<=arguments.length?__slice.call(arguments,1):[],this.working?this.queue.push({type:type,params:params}):this._sendMessage(type,params)},MessageStream.prototype.interupted=function(){var cb,done,next,_base;if(this.type){cb=this.cb,delete this.cb,done=function(_this){return function(r){if(cb)return cb(r)}}(this),typeof (_base=this.messageTypes[this.type]).interupted=="function"&&_base.interupted(done),delete this.type,delete this.currentNumber,this.working=!1;if(this.queue.length)return next=this.queue.shift(),this._sendMessage(next.type,next.params)}},MessageStream.prototype.receivedResponse=function(response){var cb,done,next,number,responseParams,_ref;clearTimeout(this.timerId),responseParams=response.split("	"),number=responseParams[0],responseParams=responseParams.slice(1);if(number==this.currentNumber){cb=this.cb,delete this.cb,done=function(_this){return function(r){if(cb)return cb(r,response)}}(this),(_ref=this.messageTypes[this.type]).responseHandler.apply(_ref,[done].concat(__slice.call(responseParams))),this.working=!1,delete this.type;if(this.queue.length)return next=this.queue.shift(),this._sendMessage(next.type,next.params)}},MessageStream}(),WebSocketTransport=function(_super){__extends(WebSocketTransport,_super),WebSocketTransport.prototype.polling=!1;function WebSocketTransport(){WebSocketTransport.__super__.constructor.apply(this,arguments),this.workQueue=[],this.subscriptions={},this.messageStream=new MessageStream,this.messageStream.messageTypes={init:{code:"i",responseHandler:function(_this){return function(done,gatewayServerId,changes){return _this.updater.setGatewayForStore(gatewayServerId,_this.userId),parse(changes,function(success,changes){return success?_this.sync(changes,_this.userId,"*",function(){return done(!0)}):done(!1)})}}(this),interupted:function(done){return done(!1)}},update:{code:"u",responseHandler:function(_this){return function(done,response){return response!=="error"&&response!=="not allowed"?(_this.changesConfirmed(),parse(response,function(success,response){return success?(response.mapping!=null&&_this.updater.db.addMapping(response.mapping),_this.updateToken=response.updateToken,done(!0)):done(!1,response)})):done(!1,response)}}(this),interupted:function(done){return done(!1)}},subscribe:{code:"s",responseHandler:function(_this){return function(done,gatewayServerId,storeId,object,changes){return changes==="not allowed"?done(!1):(_this.updater.setGatewayForStore(gatewayServerId,storeId),parse(changes,function(success,changes){return success?_this.sync(changes,storeId,object,function(){var _base,_base1;return(_base=_this.subscriptions)[storeId]==null&&(_base[storeId]={}),(_base1=_this.subscriptions[storeId])[object]==null&&(_base1[object]={}),_this.subscriptions[storeId][object].retrieved=!0,done(!0)}):done(!1)}))}}(this)},retrieve:{code:"r",responseHandler:function(_this){return function(){var changes,done,i,parts,_i,_ref;done=arguments[0],parts=2<=arguments.length?__slice.call(arguments,1):[],changes={};for(i=_i=0,_ref=parts.length/2;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)_.merge(changes,parse(parts[i*2+1]));return done(changes)}}(this)},message:{code:"m",responseHandler:function(done){return done()}}},this.updater.db.tables.shared_objects.observe(function(_this){return function(mutation){var obj,storeId,_i,_len,_ref,_results;mutation.type==="deletion"&&(storeId=mutation.record.get("user_id").substr(1),_this.unsubscribe(storeId,mutation.record.get("object")),_this.updater.db.tables.shared_objects.selectFirst({user_id:mutation.record.get("user_id")})||_this.unsubscribe(storeId,"@"));if(_this._whenObjects){_ref=_this._whenObjects,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)obj=_ref[_i],_results.push(_this.testWhenObject(obj));return _results}}}(this))}return WebSocketTransport.prototype.changesSent=function(changes){return this.sentChanges=changes},WebSocketTransport.prototype.changesConfirmed=function(){return delete this.sentChanges},WebSocketTransport.prototype.testWhenObject=function(obj){var count,object,start,_i,_len,_ref;_ref=obj.objects;for(_i=0,_len=_ref.length;_i<_len;_i++){object=_ref[_i];if(!this.isPermitted(obj.storeId,object)){console.log("not permitted",obj.storeId,object),obj.state?(obj.state===2&&obj.unavailable(),obj.state=0):obj.initial||(obj.initial=!0,obj.unavailable());return}}if(!obj.state)return obj.state=1,count=0,start=function(_this){return function(succeeded){return succeeded?count===obj.objects.length?(obj.available(),obj.state=2):_this.subscribe(obj.storeId,obj.objects[count++],start):(obj.state=0,obj.unavailable())}}(this),start(!0)},WebSocketTransport.prototype.reset=function(){return this._whenObjects=[],delete this.sentChanges,this.working=!1},WebSocketTransport.prototype.whenObject=function(storeId,objects,available,unavailable){var obj;return this._whenObjects==null&&(this._whenObjects=[]),obj={storeId:storeId,objects:objects,available:available,unavailable:unavailable},this._whenObjects.push(obj),this.testWhenObject(obj),obj},WebSocketTransport.prototype.unregisterWhenObject=function(obj){if(this._whenObjects)return _.pull(this._whenObjects,obj)},WebSocketTransport.prototype.isPermitted=function(storeId,object){var collaborator;return storeId==this.userId?!0:object==="@"?this.updater.db.tables.shared_objects.selectFirst({user_id:"G"+storeId})||this.updater.db.tables.shared_objects.selectFirst({with_user_id:"G"+storeId})?!0:(collaborator=this.updater.db.tables.collaborators.selectFirst({user_id:storeId}))?""+collaborator.get("object_user_id")+" "+collaborator.get("object"):!1:this.updater.db.tables.shared_objects.selectFirst({user_id:"G"+storeId,object:object})?!0:!1},WebSocketTransport.prototype.subscribed=function(storeId,object){var _ref;return(_ref=this.subscriptions[storeId])!=null?_ref[object]:void 0},WebSocketTransport.prototype._getContents=function(record){var child,contents,_i,_len,_ref;contents=[],_ref=record.contained(!1);for(_i=0,_len=_ref.length;_i<_len;_i++)child=_ref[_i],this.subscriptions[child.storeId][""+child.table.name+"."+child.saneId()]||(contents.push(child),contents=contents.concat(this._getContents(child)));return contents},WebSocketTransport.prototype.unsubscribe=function(storeId,object){var contents,onUnsubscribeCb,onUnsubscribeCbs,r,record,_i,_j,_len,_len1,_ref;if((_ref=this.subscriptions[storeId])!=null?_ref[object]:void 0){onUnsubscribeCbs=this.subscriptions[storeId][object].onUnsubscribe;if(onUnsubscribeCbs)for(_i=0,_len=onUnsubscribeCbs.length;_i<_len;_i++)onUnsubscribeCb=onUnsubscribeCbs[_i],onUnsubscribeCb();delete this.subscriptions[storeId][object],record=agora.getObject(storeId,object);if(record){this.updater.disabled=!0,contents=[],object==="/"?contents=this._getContents(record):object==="@"?record["delete"]():record.owner()||(contents=this._getContents(record),record["delete"]());for(_j=0,_len1=contents.length;_j<_len1;_j++)r=contents[_j],r["delete"]()}return this.updater.disabled=!1}},WebSocketTransport.prototype.renewSubscriptions=function(storeId){var key,object,__,___,_ref,_ref1,_results,_results1;storeId==null&&(storeId=null);if(storeId){_ref=this.subscriptions[storeId],_results=[];for(object in _ref)__=_ref[object],key=this.isPermitted(storeId,object),key?_results.push(function(_this){return function(object){return _this.work("subscribe",function(){var params,_ref1;return params=_.isBoolean(key)?[storeId,object]:[storeId,object,key],(_ref1=_this.messageStream).sendMessage.apply(_ref1,["subscribe"].concat(__slice.call(params),[function(){return _this.doneWorking()}]))})}}(this)(object)):_results.push(void 0);return _results}_ref1=this.subscriptions,_results1=[];for(storeId in _ref1)___=_ref1[storeId],_results1.push(this.renewSubscriptions(storeId));return _results1},WebSocketTransport.prototype.subscribe=function(storeId,object,cb,onUnsubscribe){var key,s,_base;onUnsubscribe==null&&(onUnsubscribe=null),key=null;if(storeId==this.userId){cb(!0);return}if(!(key=this.isPermitted(storeId,object)))return;return(_base=this.subscriptions)[storeId]==null&&(_base[storeId]={}),this.subscriptions[storeId][object]?(s=this.subscriptions[storeId][object],onUnsubscribe&&s.onUnsubscribe.push(onUnsubscribe),s.retrieved?cb(!0):(s.cbs==null&&(s.cbs=[]),s.cbs.push(cb))):(this.subscriptions[storeId][object]={retrieved:!1,cbs:[cb],onUnsubscribe:onUnsubscribe?[onUnsubscribe]:[]},this.work("subscribe",function(_this){return function(){var params,_ref;return params=_.isBoolean(key)?[storeId,object]:[storeId,object,key],(_ref=_this.messageStream).sendMessage.apply(_ref,["subscribe"].concat(__slice.call(params),[function(r){var _i,_j,_len,_len1,_ref,_ref1;_this.doneWorking();if(!r){if(_this.subscriptions[storeId][object].cbs){_ref=_this.subscriptions[storeId][object].cbs;for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],cb(!1);return delete _this.subscriptions[storeId][object].cbs}}else if(_this.subscriptions[storeId][object].cbs){_ref1=_this.subscriptions[storeId][object].cbs;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)cb=_ref1[_j],cb(!0);return delete _this.subscriptions[storeId][object].cbs}}]))}}(this)))},WebSocketTransport.prototype.checkToRetrieve=function(changes,externalStoreId){var id,map,needsToRetrieve,record,storeId,t,table,toRetrieve,_base,_base1,_i,_j,_len,_len1,_ref,_ref1,_ref10,_ref11,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;toRetrieve={},needsToRetrieve=!1,map={Product:"products",ProductVariant:"product_variants",Decision:"decisions",Bundle:"bundles"},_ref=["root_elements","list_elements","bundle_elements","belt_elements"];for(_i=0,_len=_ref.length;_i<_len;_i++){table=_ref[_i];if(changes[table]){_ref1=changes[table];for(id in _ref1){record=_ref1[id];if(t=map[record.element_type]){if(changes!=null?(_ref2=changes[t])!=null?_ref2[record.element_id]:void 0:void 0)continue;id=(_ref3=(_ref4=this.updater.db.globalToLocalMapping)!=null?(_ref5=_ref4[t])!=null?_ref5[record.element_id]:void 0:void 0)!=null?_ref3:record.element_id,this.updater.db.table(t).byId(id)||(storeId=null,this.updater.db.table(t).canBeExternal?storeId=externalStoreId:storeId=this.updater.db.storeId,toRetrieve[storeId]==null&&(toRetrieve[storeId]={}),(_base=toRetrieve[storeId])[t]==null&&(_base[t]=[]),toRetrieve[storeId][t].push(record.element_id),needsToRetrieve=!0)}}}}_ref6=["product_variants"];for(_j=0,_len1=_ref6.length;_j<_len1;_j++){table=_ref6[_j];if(changes[table]){_ref7=changes[table];for(id in _ref7){record=_ref7[id],t="products";if(changes!=null?(_ref8=changes[t])!=null?_ref8[record.product_id]:void 0:void 0)continue;id=(_ref9=(_ref10=this.updater.db.globalToLocalMapping)!=null?(_ref11=_ref10[t])!=null?_ref11[record.product_id]:void 0:void 0)!=null?_ref9:record.product_id,this.updater.db.table(t).byId(id)||(storeId=null,this.updater.db.table(t).canBeExternal?storeId=externalStoreId:storeId=this.updater.db.storeId,toRetrieve[storeId]==null&&(toRetrieve[storeId]={}),(_base1=toRetrieve[storeId])[t]==null&&(_base1[t]=[]),toRetrieve[storeId][t].push(record.product_id),needsToRetrieve=!0)}}}if(needsToRetrieve)return toRetrieve},WebSocketTransport.prototype.executeChanges=function(changes,storeId,cb){var allChanges,checkChanges,doExecuteChanges;return cb==null&&(cb=null),doExecuteChanges=function(_this){return function(){return _this.updater.disabled=!0,_this.updater.db.externalStoreId=storeId,_this.updater.db.executeChanges(allChanges),_this.updater.disabled=!1,delete _this.updater.db.externalStoreId,typeof cb=="function"?cb():void 0}}(this),allChanges={},checkChanges=function(_this){return function(changes){var parts,stuffToRetrieve,theStoreId,toRetrieve,_ref;_.merge(allChanges,changes),toRetrieve=_this.checkToRetrieve(changes,storeId);if(toRetrieve){parts=[];for(theStoreId in toRetrieve)stuffToRetrieve=toRetrieve[theStoreId],parts.push(theStoreId),parts.push(JSON.stringify(stuffToRetrieve));return(_ref=_this.messageStream).sendMessage.apply(_ref,["retrieve"].concat(__slice.call(parts),[checkChanges]))}return doExecuteChanges()}}(this),checkChanges(changes)},WebSocketTransport.prototype.sync=function(data,storeId,object,cb){var contained,containedRecord,id,name,record,table,toDelete,_i,_j,_len,_len1,_ref,_ref1,_ref2;cb==null&&(cb=null),this.updater.disabled=!0;if(object==="*"){_ref=this.updater.db.tables;for(name in _ref){table=_ref[name];if(name==="products"||name==="product_variants")continue;toDelete=[],table.records.each(function(_this){return function(record){if(data[name]&&storeId==record.storeId&&!data[name][record.globalId()])return toDelete.push(record.globalId())}}(this));for(_i=0,_len=toDelete.length;_i<_len;_i++)id=toDelete[_i],table.byGlobalId(id)["delete"]()}}else if(object!=="@"){_ref1=object.split("."),table=_ref1[0],id=_ref1[1],record=this.updater.db.table(table).bySaneId(id);if(record){contained=record.contained();for(_j=0,_len1=contained.length;_j<_len1;_j++)containedRecord=contained[_j],(data!=null?(_ref2=data[containedRecord.table.name])!=null?_ref2[containedRecord.globalId()]:void 0:void 0)||containedRecord["delete"]()}}return this.updater.disabled=!1,this.executeChanges(data,storeId,cb)},WebSocketTransport.prototype.userChanged=function(){return console.log("user changed"),this.clientId=this.updater.clientId=null,this.ws&&(this.ws.close(),delete this.ws),this.registerClient(function(_this){return function(response){console.log(response);if(response)return _this.createWebSocket()}}(this))},WebSocketTransport.prototype.doInit=function(cb){var init;return init=function(_this){return function(){return _this.sendNextChanges(),_this.work("init",function(){return _this.messageStream.sendMessage("init",_this.clientId,_this.userId,function(success){return _this.doneWorking(),success?(typeof cb=="function"&&cb(!0),_this.renewSubscriptions(),_this.sendNextChanges()):typeof cb=="function"?cb(!1):void 0})})}}(this),this.workingChanges?this.work("sendPreviousChanges",function(_this){return function(){return _this.sendChanges(_this.workingChanges,function(){return _this.doneWorking(),init()})}}(this)):init()},WebSocketTransport.prototype.createWebSocket=function(onInit){return console.debug("creating websocket..."),this.ws=new WebSocket("ws://"+this.server),this.messageStream.ws=this.ws,this.ws.onclose=function(_this){return function(){console.debug("socket close"),_this.open=!1,_this.working=!1,_this.clearWorkQueue(),_this.messageStream.clearMessageQueue(),!_this.started&&!_this.inited&&(_this.inited=!0,_this.updater.status.set("down"),_this.updater.message.set("Agora is down for the moment. Please be patient! Thank you. :)"),typeof onInit=="function"&&onInit(!1),agora.onInit(!1));if(_this.clientId)return setTimeout(function(){return _this.createWebSocket(onInit)},1e3)}}(this),this.ws.onmessage=function(_this){return function(message){var changes,storeId,type,_ref;message=message.data,console.debug("message:",message),type=message[0],message=message.substr(1);switch(type){case".":return _this.started?(_this.updater.setGatewayAvailable(message,!0),parseInt(message)===_this.updater.gatewayForStore(_this.userId)?_this.doInit():(_this.renewSubscriptions(message),_this.sendNextChanges())):_this.updater.reset();case",":return _this.updater.setGatewayAvailable(message,!1),_this.messageStream.interupted();case"<":return _this.messageStream.receivedResponse(message);case"u":return _ref=message.split("	"),storeId=_ref[0],changes=_ref[1],parse(changes,function(success,changes){return success?_this.work("update",function(){return _this.executeChanges(changes,storeId,function(){return _this.doneWorking()})}):agora.background.error("UpdaterError","invalidUpdateMessage",changes)})}}}(this),this.ws.onopen=function(_this){return function(){return _this.updater.status.set("online"),_this.updater.message.set(""),_this.open=!0,_this.doInit(function(success){if(success){if(!!_this.started)return agora.onInit(!0);_this.started=!0;if(!_this.inited)return _this.inited=!0,typeof onInit=="function"?onInit(!0):void 0}else{_this.updater.status.set("down"),_this.updater.message.set("Agora is down for the moment. Please be patient! Thank you. :)");if(!_this.inited)return _this.inited=!0,typeof onInit=="function"&&onInit(!1),agora.onInit(!1)}})}}(this),this.ws},WebSocketTransport.prototype.registerClient=function(cb){return console.debug("registering client"),this.updater.background.httpRequest(this.updater.background.apiRoot+"ws/registerClient.php",{data:{extVersion:this.updater.background.version,instanceId:this.updater.background.instanceId},dataType:"json",cb:function(_this){return function(response){if(response==="not signed in")return _this.server=_this.updater.clientId=_this.clientId=null,_this.updater.setUser(0),_this.userId=0,tracking.enabled=!1,cb(null);if(response.status==="success")return _this.updateToken=response.updateToken,_this.updater.clientId=_this.clientId=response.clientId,_this.userId=parseInt(response.userId),_this.server=response.updaterServer,_this.updater.setUser(_this.userId),tracking.enabled=!!parseInt(response.track),typeof cb=="function"?cb(response):void 0}}(this)})},WebSocketTransport.prototype.init=function(onInit){return this.registerClient(function(_this){return function(response){return response===null?(_this.started=!0,typeof onInit=="function"?onInit():void 0):_this.createWebSocket(onInit)}}(this))},WebSocketTransport.prototype.clearWorkQueue=function(){return this.workQueue=[]},WebSocketTransport.prototype.work=function(){var args,cb;return args=1<=arguments.length?__slice.call(arguments,0):[],this.working?this.workQueue.push(args):(cb=_.isString(args[0])?(this.name=args[0],args[1]):args[0],this.working=!0,console.log("working",this.name),cb())},WebSocketTransport.prototype.doneWorking=function(){var args,cb;console.log("done working",this.name),delete this.name,this.working=!1;if(this.workQueue.length)return args=this.workQueue.shift(),cb=_.isString(args[0])?(this.name=args[0],args[1]):args[0],cb();if(this.changes)return this.changes=!1,this.sendNextChanges()},WebSocketTransport.prototype.sendNextChanges=function(){var changes,f;changes=this.updater.nextChanges();if(changes)return f=function(_this){return function(currentChanges){return _this.sendChanges(currentChanges,function(success){var nextChanges;return success?(nextChanges=_this.updater.nextChanges(),nextChanges?f(nextChanges):_this.doneWorking()):_this.doneWorking()})}}(this),this.work("sendChanges",function(){return f(changes)})},WebSocketTransport.prototype.sendChanges=function(changes,cb){var storeId,theseChanges;return console.log(changes),this.workingChanges=changes,storeId=_.keys(changes)[0],theseChanges=this.updater.convertIds(changes[storeId]),this.messageStream.sendMessage("update",this.updateToken,storeId,JSON.stringify(theseChanges),function(_this){return function(success,message){return success?(delete _this.workingChanges,cb(!0)):cb(!1,message)}}(this))},WebSocketTransport.prototype.hasChanges=function(){return this.open?this.working?this.changes=!0:(clearTimeout(this.updaterTimerId),this.updaterTimerId=setTimeout(function(_this){return function(){return _this.sendNextChanges()}}(this),200)):this.changes=!0},WebSocketTransport}(UpdaterTransport),Updater=function(){Updater.prototype.test=function(data){var fieldName,globalId,id,localId,localRecord,record,records,remoteValue,table,tableName,value,values,_ref,_ref1,_ref2,_ref3,_ref4,_results;for(tableName in data){records=data[tableName];for(id in records){record=records[id],localId=(_ref=(_ref1=this.db.globalToLocalMapping)!=null?(_ref2=_ref1[tableName])!=null?_ref2[id]:void 0:void 0)!=null?_ref:id,values=this.db.tables[tableName]._recordsByRid[localId]._values;if(values){localRecord=this.prepare(tableName,values);for(fieldName in localRecord){value=localRecord[fieldName];if(fieldName==="more"||fieldName==="offers"||fieldName==="timestamp")continue;if(__indexOf.call((_ref3=this.db.tables[tableName].schema.local)!=null?_ref3:[],fieldName)>=0)continue;value!=record[fieldName]&&console.debug(""+tableName+" "+localId+"|"+id+" "+fieldName+" `"+value+"` `"+record[fieldName]+"`")}}else console.debug(""+tableName+" "+localId+"|"+id+" "+fieldName)}}_ref4=this.db.tables,_results=[];for(tableName in _ref4)table=_ref4[tableName],_results.push(function(){var _ref5,_results1;_ref5=table._recordsByRid,_results1=[];for(id in _ref5)record=_ref5[id]._values,globalId=this.convertId(tableName,id),localRecord=this.prepare(tableName,record),_results1.push(function(){var _results2;_results2=[];for(fieldName in localRecord)value=localRecord[fieldName],!data[tableName][globalId]||(remoteValue=response.allData[tableName][globalId][fieldName],remoteValue!=value?_results2.push(console.debug(""+tableName+" "+globalId+"|"+id+" "+fieldName+" "+value+" "+remoteValue)):_results2.push(void 0));return _results2}());return _results1}.call(this));return _results};function Updater(background,db,userIdValue,errorState){var _ref;this.background=background,this.db=db,this.userIdValue=userIdValue,this.errorState=errorState,this.tables={},this.deleted=[],this.userId=(_ref=this.userIdValue.get())!=null?_ref:0,this.updateInterval=2e3,this.autoUpdate=!0,this.history={},this.changes=!1,this.userIdCookieValue=null,this.status=new ObservableValue,this.message=new ObservableValue,this.transport=new WebSocketTransport(this),this.gateways={},this.gatewayByStore={},this.commandExecuter=new CommandExecuter(this.background)}return Updater.prototype.isStoreAvailable=function(storeId){return this.gateways[this.gatewayByStore[storeId]].available},Updater.prototype.gatewayForStore=function(storeId){return this.gatewayByStore[storeId]},Updater.prototype.setGatewayForStore=function(gatewayServerId,storeId){var _base;return(_base=this.gateways)[gatewayServerId]==null&&(_base[gatewayServerId]={available:!0,stores:[]}),this.gateways[gatewayServerId].stores.push(parseInt(storeId)),this.gatewayByStore[storeId]=parseInt(gatewayServerId)},Updater.prototype.setGatewayAvailable=function(gatewayServerId,available){var _base;return(_base=this.gateways)[gatewayServerId]==null&&(_base[gatewayServerId]={}),this.gateways[gatewayServerId].available=available},Updater.prototype.cookiePolling=function(){var cookieUrl;return cookieUrl=env.cookieDomain?"http://"+env.cookieDomain:this.background.apiRoot,this.background.getCookie(cookieUrl,"userId",function(_this){return function(cookie){return _this.userIdCookieValue=cookie!=null?cookie.value:void 0,_this.background.setInterval(function(){return _this.background.getCookie(cookieUrl,"userId",function(cookie){if((cookie!=null?cookie.value:void 0)!==_this.userIdCookieValue)return _this.userIdCookieValue=cookie!=null?cookie.value:void 0,_this.transport.userChanged()})},1e3)}}(this))},Updater.prototype.init=function(cb){return this.transport.init(function(_this){return function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],_this.cookiePolling(),cb.apply(null,args)}}(this))},Updater.prototype.isDisabled=function(){return this.disabled||!this.userId},Updater.prototype.setUser=function(userId){userId=parseInt(userId);if(userId!==this.userId)return console.debug("new user",this.userId,userId),this.db.localToGlobalMapping={},this.db.globalToLocalMapping={},this.db.storeId=userId,this.disabled=!0,this.db.clear(),this.disabled=!1,this.background.userId=this.userId=userId,this.userIdValue.set(this.userId)},Updater.prototype.isLocalId=function(id){return(id+"")[0]!=="G"},Updater.prototype.hasGlobalId=function(table,id){var _ref,_ref1;return this.isLocalId(id)?((_ref=this.db.localToGlobalMapping)!=null?(_ref1=_ref[table])!=null?_ref1[id]:void 0:void 0)!=null:!0},Updater.prototype.convertId=function(table,id){var _ref,_ref1,_ref2;return this.isLocalId(id)?(_ref=(_ref1=this.db.localToGlobalMapping)!=null?(_ref2=_ref1[table])!=null?_ref2[id]:void 0:void 0)!=null?_ref:id:id},Updater.prototype.prepare=function(table,record){var field,referentTable,value,values,_ref,_ref1;values={};for(field in record){value=record[field];if(referentTable=(_ref=this.db.tables[table].schema)!=null?(_ref1=_ref.referents)!=null?_ref1[field]:void 0:void 0)_.isFunction(referentTable)&&(referentTable=referentTable(record)),value=this.convertId(referentTable,value);if(value instanceof Date)value="0000-00-00 00:00:00";else if(_.isPlainObject(value)||_.isArray(value))value=JSON.stringify(value);values[field]=value}return values},Updater.prototype.forceUpdate=function(){return this.background.clearTimeout(this.timerId),this.update()},Updater.prototype.nextChanges=function(){var changes,data,i,id,info,record,records,selectedStoreId,storeId,storeIds,table,tables,toDelete,values,_base,_base1,_i,_j,_k,_len,_len1,_len2,_name,_name1,_ref,_ref1,_ref2,_ref3;data={},toDelete=[],_ref=this.tables;for(table in _ref){records=_ref[table];for(id in records){record=records[id],storeId=(_ref1=this.db.table(table).byId(id))!=null?_ref1.storeId:void 0;if(!storeId||!this.isStoreAvailable(storeId))continue;data[storeId]==null&&(data[storeId]={}),(_base=data[storeId])[table]==null&&(_base[table]={}),values=this.prepare(table,record);if(table==="products"&&!values.siteName&&!values.productSid&&!this.hasGlobalId(table,id))throw new Error("BAD");data[storeId][table][id]=values}}_ref2=this.deleted;for(i=_i=0,_len=_ref2.length;_i<_len;i=++_i){info=_ref2[i];if(!this.isStoreAvailable(info.storeId))continue;data[_name=info.storeId]==null&&(data[_name]={}),(_base1=data[info.storeId])[_name1=info.table]==null&&(_base1[_name1]={}),data[info.storeId][info.table][info.id]="deleted"}if(!_.isEmpty(data)){selectedStoreId=null,storeIds=_.keys(data),data[this.userId]?selectedStoreId=this.userId:selectedStoreId=storeIds[0];for(_j=0,_len1=storeIds.length;_j<_len1;_j++)storeId=storeIds[_j],storeId!=selectedStoreId&&delete data[storeId];for(storeId in data){tables=data[storeId];for(table in tables){records=tables[table];for(id in records){changes=records[id];if(changes==="deleted"){_ref3=this.deleted;for(i=_k=0,_len2=_ref3.length;_k<_len2;i=++_k){info=_ref3[i];if(info.table===table&&info.id==id){this.deleted.splice(i,1);break}}}else delete this.tables[table][id],_.isEmpty(this.tables[table])&&delete this.tables[table]}}}return data}},Updater.prototype.convertIds=function(changes){var id,newChanges,record,records,table;newChanges={};for(table in changes){records=changes[table],newChanges[table]={};for(id in records)record=records[id],newChanges[table][this.convertId(table,id)]=record}return newChanges},Updater.prototype.clearChanges=function(changes){return this.prevTables=this.tables,this.tables={},this.deleted=[],this.changes=!1},Updater.prototype.clearStorage=function(){return this.background.removeStorage(["updaterChanges","localToGlobalMapping","globalToLocalMapping"])},Updater.prototype.addUpdate=function(record,field){var _base,_base1,_name,_name1;if(this.isDisabled()||record.table.schema.local&&__indexOf.call(record.table.schema.local,field)>=0)return;return(_base=this.tables)[_name=record.table.name]==null&&(_base[_name]={}),(_base1=this.tables[record.table.name])[_name1=record.id]==null&&(_base1[_name1]={}),this.tables[record.table.name][record.id][field]=record.get(field),this.changes=!0,this.transport.hasChanges()},Updater.prototype.addInsertion=function(record){var name,value,values,_base,_name,_ref;values=null;if(record.table.schema.local){values={},_ref=record._values;for(name in _ref)value=_ref[name],__indexOf.call(record.table.schema.local,name)<0&&(values[name]=value)}else values=_.clone(record._values);if(this.isDisabled())return;return(_base=this.tables)[_name=record.table.name]==null&&(_base[_name]={}),this.tables[record.table.name][record.id]=values,this.changes=!0,this.transport.hasChanges()},Updater.prototype.addDeletion=function(record){if(this.isDisabled())return;return record.hasGlobal()?this.deleted.push({table:record.table.name,id:record.id,storeId:record.storeId}):this.tables[record.table.name]&&delete this.tables[record.table.name][record.id],this.changes=!0,this.transport.hasChanges()},Updater.prototype.reset=function(){agora.signalReload(),chrome.runtime.reload();return},Updater.prototype.subscribe=function(storeId,object,cb,onUnsubscribe){return onUnsubscribe==null&&(onUnsubscribe=null),this.transport.subscribe(storeId,object,cb,onUnsubscribe)},Updater}()}),define("Public",[],function(){var Public;return Public=function(){function Public(){}return Public.prototype.route=function(obj){var garbledId,hash,i,id,_i,_ref;if(obj.isA("Decision")){hash=md5(obj.saneId()+"salty apple sauce"),id=obj.saneId()+"",garbledId="";for(i=_i=0,_ref=id.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)garbledId+=id[i]+hash[i];return""+env.base+"/decisions/"+garbledId}},Public.prototype.get=function(type,id,cb){var record;return record=this.agora.db.table(type).bySaneId(id),record?typeof cb=="function"?cb(!0):void 0:this.agora.background.httpRequest(this.agora.background.apiRoot+"public/data.php",{data:{type:type,id:id},dataType:"json",cb:function(_this){return function(response){return response==="accessDenied"||response==="invalidId"?cb(!1):_this.agora.updater.transport.executeChanges(response.data,0,function(){return cb(!0,response.id)})}}(this)})},Public}()}),define("Formatter",[],function(){var Formatter;return Formatter=function(){function Formatter(){}return Formatter.price=function(price){var parts;if(price)return price+="",parts=price.split("."),parts.length===1?price+=".00":parts[1].length===1&&(price+="0"),"$"+price},Formatter}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("views/ProductPriceView",["View","Site","Formatter","util"],function(View,Site,Formatter,util){var ProductPriceView;return ProductPriceView=function(_super){__extends(ProductPriceView,_super);function ProductPriceView(){return ProductPriceView.__super__.constructor.apply(this,arguments)}return ProductPriceView.nextId=0,ProductPriceView.id=function(args){return++this.nextId},ProductPriceView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product){var currentPrice,offerData,site,update;return _this.product=product,site=Site.site(product._get("siteName")),offerData={},offerData.alternative=_this.ctx.clientValue(),offerData.current=_this.ctx.clientValue(),currentPrice=null,update=null,__indexOf.call(site.features,"offers")>=0?(product.retrieve("offers"),update=function(){return product.get("offer")?(currentPrice=product.get("offer").price,offerData.current.set({price:product.get("displayUserPrice"),siteName:product.get("offer").site,siteIcon:product.get("offer").url.match("(^https?://[^/]*)")[0]+"/favicon.ico",url:util.url(product.get("offer").url),clear:!0})):(currentPrice=product.get("price"),offerData.current.set({price:product.get("displayPrice"),siteName:site.name,siteIcon:site.icon,url:product.get("url")})),product.field("offers")["with"](function(_this){return function(offers){var icon,match;return(offers!=null?offers["new"]:void 0)&&parseFloat(offers["new"][0].price)!==parseFloat(currentPrice)?(match=offers["new"][0].url.match("(^https?://[^/]*)"),match||console.log(offers["new"][0].url),icon=match?match[0]+"/favicon.ico":null,offerData.alternative.set({cheaper:!0,price:"$"+util.numberWithCommas(parseFloat(offers["new"][0].price).toFixed(2)),siteName:offers["new"][0].site,siteIcon:icon,url:util.url(offers["new"][0].url)})):(offerData.current.get().cheaper=!0,offerData.current.trigger(),offerData.alternative.set(null))}}(this))}):update=function(){return currentPrice=product.get("price"),offerData.current.set({price:product.get("displayPrice"),siteName:site.name,siteIcon:site.icon,url:product.get("url"),cheaper:!0})},update(),__indexOf.call(site.features,"offers")>=0&&_this.ctx.observe(product.field("offer"),update),_this.ctx.observe(product.field("price"),update),_this.data=offerData,done()}}(this))},ProductPriceView.prototype.methods={chooseAlternative:function(view){return this.product.field("offers")["with"](function(_this){return function(offers){return _this.product.set("offer",{url:util.url(offers["new"][0].url),site:offers["new"][0].site,price:offers["new"][0].price})}}(this))},clear:function(){return this.product.set("offer",null)}},ProductPriceView.client=function(){return ProductPriceView=function(_super1){__extends(ProductPriceView,_super1);function ProductPriceView(){return ProductPriceView.__super__.constructor.apply(this,arguments)}return ProductPriceView.prototype.type="ProductPrice",ProductPriceView.prototype.init=function(el){return this.useEl(el),this.el.addClass("v-productPrice"),this.el.html('<span class="current offer"><a target="_blank" class="icon" /> <span class="price" /> <span class="clear" /></span>'),this.el.find(".clear").click(function(_this){return function(){return _this.event("clear"),_this.callBackgroundMethod("clear")}}(this))},ProductPriceView.prototype.onData=function(data){var offers,updateAlternative,updateCurrent;return offers=data,updateCurrent=function(_this){return function(){var current;return current=offers.current.get(),util.tooltip(_this.el.find(".current .icon").css("backgroundImage","url("+current.siteIcon+")"),current.siteName),_this.el.find(".current .price").html(current.price),_this.el.find(".current .icon").attr("href",current.url),current.cheaper?_this.el.find(".current").addClass("cheaper"):_this.el.find(".current").removeClass("cheaper"),current.clear?_this.el.find(".current .clear").css({display:""}):_this.el.find(".current .clear").css({display:"none"})}}(this),updateAlternative=function(_this){return function(){var alternative;alternative=offers.alternative.get(),_this.el.find(".alternative").remove();if(alternative)return _this.el.append('<span class="alternative offer"><a target="_blank" class="icon" /><span class="price" /></span>'),alternative.cheaper&&_this.el.find(".alternative").addClass("cheaper"),util.tooltip(_this.el.find(".alternative .icon").css("backgroundImage","url("+alternative.siteIcon+")"),alternative.siteName),_this.el.find(".alternative .price").html(alternative.price),_this.el.find(".alternative .icon").attr("href",alternative.url),_this.el.find(".alternative .price").click(function(){return _this.event("chooseAlternative"),_this.callBackgroundMethod("chooseAlternative")})}}(this),updateCurrent(),offers.current.observe(updateCurrent),updateAlternative(),offers.alternative.observe(updateAlternative)},ProductPriceView}(View)},ProductPriceView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductMenuView",["View","Site","Formatter","util"],function(View,Site,Formatter,util){var ProductMenuView;return ProductMenuView=function(_super){__extends(ProductMenuView,_super);function ProductMenuView(){return ProductMenuView.__super__.constructor.apply(this,arguments)}return ProductMenuView.nextId=0,ProductMenuView.id=function(args){return++this.nextId},ProductMenuView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product){var site;return _this.product=product,site=Site.site(product._get("siteName")),_this.data={features:site.features,lastFeeling:util.lastFeeling(_this.ctx,product),lastArgument:util.lastArgument(_this.ctx,product)},done()}}(this))},ProductMenuView.client=function(){return ProductMenuView=function(_super1){__extends(ProductMenuView,_super1);function ProductMenuView(){return ProductMenuView.__super__.constructor.apply(this,arguments)}return ProductMenuView.prototype.type="ProductMenu",ProductMenuView.prototype.init=function(el,opts){var html,makePopup,num;return opts==null&&(opts={}),this["public"]=opts["public"],this.el=el,html='<div class="item priceComparison"><a href="#">See more prices</a></div> <div class="item coupons"><a href="#">See coupons and deals</a></div> <div class="item reviews"><a href="#">Reviews</a></div>',this["public"]||(html+='<div class="item feelings"><a href="#">Feelings</a></div> <!--<div class="item arguments"><a href="#">Arguments</a></div>--> <div class="item attachments"><a href="#">Clipped content</a></div>'),this.el.html(html),this.el.addClass("v-productMenu"),this.orientation=opts.orientation,opts.orientation==="horizontal"&&this.el.addClass("horizontal"),el=this.el,makePopup=opts.orientation==="horizontal"?(num=0,function(_this){return function(triggerEl,viewName,popupOpts){return popupOpts==null&&(popupOpts={}),util.popupTrigger(triggerEl,{createPopup:function(cb,close){var view;return view=_this.createView(viewName),view.represent(_this.args,function(){var frame,position,updateFrame;return view.close=function(esc){if(esc)return funcs.unpin(),close()},position=triggerEl.offset().top-$(window).scrollTop()<$(window).height()/3?"below":"above",updateFrame=function(){var adjust,height,pos;adjust=util.isFixed(triggerEl)?$(window).scrollTop():0;if(position==="above"){if(frame.el.offset().top<$(window).scrollTop())return pos=frame.el.offset().top+frame.el.height(),height=pos-($(window).scrollTop()+40),frame.el.find(".cont").css({height:height}),frame.el.css({top:pos-frame.el.height()-adjust})}else if(position==="below"&&frame.el.offset().top+frame.el.height()>$(window).scrollTop()+$(window).height())return height=$(window).scrollTop()+$(window).height()-frame.el.offset().top-40,frame.el.find(".cont").css({height:height})},frame=Frame.frameAbove(triggerEl,view.el,{type:"balloon",color:"dark",position:position,onClose:function(){return view.destruct(),view=null}}),view.close=close,updateFrame(),view.sizeChanged=function(){return frame.update(),updateFrame()},typeof opts.addEl=="function"&&opts.addEl(frame.el),cb(frame.el),tracking.page(view.path()),view.shown()}),typeof opts.pinSidebar=="function"&&opts.pinSidebar(),triggerEl.addClass("active"),num++,null},onClose:function(el){var _ref;return--num||typeof opts.unpinSidebar=="function"&&opts.unpinSidebar(),(_ref=el.data("frame"))!=null&&typeof _ref.close=="function"&&_ref.close(),triggerEl.removeClass("active")}})}}(this)):(num=0,function(_this){return function(triggerEl,viewName,popupOpts){return popupOpts==null&&(popupOpts={}),util.popoutTrigger(triggerEl,{side:"left",anchor:popupOpts.anchor,el:function(cb,funcs){var view;return++num,view=_this.createView(viewName),view.represent(_this.args,function(){var close,updatePos,_ref;return view.close=function(esc){if(esc)return funcs.unpin(),--num,num||typeof opts.unpinSidebar=="function"&&opts.unpinSidebar(),close()},tracking.page(view.path()),view.shown(),_ref=cb(view.el,function(){return view.destruct()}),updatePos=_ref[0],close=_ref[1],view.sizeChanged=updatePos})}})}}(this)),makePopup(this.el.find(".priceComparison"),"OffersView",{anchor:"top"}),makePopup(this.el.find(".coupons"),"CouponsView",{anchor:"top"}),makePopup(this.el.find(".reviews"),"ReviewsView",{anchor:"top"}),makePopup(this.el.find(".feelings"),"AddFeelingView"),makePopup(this.el.find(".arguments"),"AddArgumentView"),makePopup(this.el.find(".attachments"),"DataView")},ProductMenuView.prototype.shown=function(){return setTimeout(function(_this){return function(){var el,margin,size,w,_i,_len,_ref,_results;size=_this.el.width()/_this.el.find(".item").length;if(_this.orientation==="horizontal"){w=0,_ref=_this.el.find(".item"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],margin=(size-$(el).width())/2,w+=margin*2+$(el).width(),_results.push($(el).css({marginLeft:margin,marginRight:margin}));return _results}}}(this),0)},ProductMenuView.prototype.onData=function(data){var lastArgument,lastEmotion,updateForLastArgument,updateForLastFeeling;return _.contains(data.features,"offers")||this.el.find(".priceComparison").remove(),_.contains(data.features,"deals")||this.el.find(".coupons").remove(),_.contains(data.features,"reviews")||this.el.find(".reviews").remove(),setTimeout(function(_this){return function(){var el,margin,size,w,_i,_len,_ref,_results;size=_this.el.width()/_this.el.find(".item").length;if(_this.orientation==="horizontal"){w=0,_ref=_this.el.find(".item"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],margin=(size-$(el).width())/2,w+=margin*2+$(el).width(),_results.push($(el).css({marginLeft:margin,marginRight:margin}));return _results}}}(this),0),lastEmotion=null,updateForLastFeeling=function(_this){return function(){var emotionClass;return lastEmotion&&_this.el.find(".feelings").removeClass(lastEmotion),data.lastFeeling.get()?(emotionClass=util.emotionClass(data.lastFeeling.get().positive,data.lastFeeling.get().negative),_this.el.find(".feelings").addClass(emotionClass),lastEmotion=emotionClass):lastEmotion=null}}(this),data.lastFeeling.observe(updateForLastFeeling),updateForLastFeeling(),lastArgument=null,updateForLastArgument=function(_this){return function(){var positionClass;return lastArgument&&_this.el.find(".arguments").removeClass(lastArgument),data.lastArgument.get()?(positionClass=util.positionClass(data.lastArgument.get()["for"],data.lastArgument.get().against),_this.el.find(".arguments").addClass(positionClass),lastArgument=positionClass):lastArgument=null}}(this),data.lastArgument.observe(updateForLastArgument),updateForLastArgument()},ProductMenuView}(View)},ProductMenuView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/SettingsView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var SettingsView;return SettingsView=function(_super){__extends(SettingsView,_super);function SettingsView(){return SettingsView.__super__.constructor.apply(this,arguments)}return SettingsView.nextId=0,SettingsView.id=function(args){return++this.nextId},SettingsView.prototype.initAsync=function(args,done){return this.background.getStorage(["options"],function(_this){return function(data){var _ref,_ref1,_ref2,_ref3,_ref4,_ref5;return _this.data={hideBelt:(_ref=(_ref1=data.options)!=null?_ref1.hideBelt:void 0)!=null?_ref:!1,autoFeelings:(_ref2=(_ref3=data.options)!=null?_ref3.autoFeelings:void 0)!=null?_ref2:!1,showPreview:(_ref4=(_ref5=data.options)!=null?_ref5.showPreview:void 0)!=null?_ref4:!1},done()}}(this))},SettingsView.client=function(){return SettingsView=function(_super1){__extends(SettingsView,_super1);function SettingsView(){return SettingsView.__super__.constructor.apply(this,arguments)}return SettingsView.prototype.type="Settings",SettingsView.prototype.booleanSettings=["hideBelt","autoFeelings","showPreview"],SettingsView.prototype.init=function(){var name,_i,_len,_ref,_results;this.viewEl('<div class="v-settings t-dialog"> <h2>Settings</h2> <div class="content"> <form> <div class="field"><input type="checkbox" name="hideBelt"> <label>Hide Belt</label></div> <div class="field"><input type="checkbox" name="autoFeelings"> <label>Auto Feelings</label></div> <div class="field"><input type="checkbox" name="showPreview"> <label>Show Preview</label></div> <!--<input type="Submit">--> </form> </div> </div>'),_ref=this.booleanSettings,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)name=_ref[_i],_results.push(function(_this){return function(name){return _this.el.find("[name="+name+"]").change(function(){return _this.callBackgroundMethod("update",[name,_this.el.find("[name="+name+"]").prop("checked")])})}}(this)(name));return _results},SettingsView.prototype.onData=function(data){var name,_i,_len,_ref,_results;_ref=this.booleanSettings,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)name=_ref[_i],data[name]?_results.push(this.el.find("[name="+name+"]").prop("checked",!0)):_results.push(void 0);return _results},SettingsView}(View)},SettingsView.prototype.methods={submit:function(view,subject,message){return this.agora.background.httpRequest(""+this.agora.background.apiRoot+"contact.php",{method:"post",data:{subject:subject,message:message}})},update:function(view,prop,value){var options;return options={},options[prop]=value,this.agora.setOptions(options)}},SettingsView}(View)}),define("CodeManager",[],function(){var CodeManager;return CodeManager=function(){function CodeManager(agora){this.agora=agora}return CodeManager.prototype.reload=function(module){var className;return className=null,module.module&&(className=module.className,module=module.module),agora.background.httpRequest("build/lib/client/"+module+".js",{cb:function(_this){return function(response){var tab,_i,_len,_ref,_results;_ref=_this.agora.tabs,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)tab=_ref[_i],_results.push(chrome.tabs.sendMessage(tab,{action:"updateCode",module:module,className:className,code:response}));return _results}}(this)})},CodeManager}()}),define("Chat",["model/ObservableArray","model/ObservableValue"],function(ObservableArray,ObservableValue){var Chat;return Chat=function(){function Chat(agora){this.background=agora.background,this.messageQueue=[],this.messages=new ObservableArray,this.updateInterval=1e4,this.online=new ObservableValue,this.writingReply=new ObservableValue,this.writingReply._type="object"}return Chat.prototype.readMessages=function(){if(this.lastRead!==this.last)return this.lastRead=this.last,this.lastReadChanged=!0},Chat.prototype.sendMessage=function(message){return this.messageQueue.push(message),this.update()},Chat.prototype.setPendingMessage=function(pendingMessage){this.pendingMessage=pendingMessage},Chat.prototype.update=function(){var args;return args={last:this.last,messages:this.messageQueue,pendingMessage:this.pendingMessage},this.lastReadChanged&&(args.lastRead=this.lastRead,this.lastReadChanged=!1),this.background.clearTimeout(this.updateTimerId),this.background.httpRequest("http://messages.agora.sh/updateChat.php",{method:"post",dataType:"json",data:args,cb:function(_this){return function(response){return _this.last=response.last!==null?parseInt(response.last):null,"lastRead"in response&&(_this.lastRead=parseInt(response.lastRead),_this.lastRead!==_this.last&&(_this.newMessages=!0)),response.messages&&_this.messages.append(response.messages),_this.updateInterval=response.updateInterval,_this.updateTimerId=_this.background.setTimeout(function(){return _this.update()},_this.updateInterval),_this.online.set(response.online),_this.writingReply.set(response.writingReply)}}(this),error:function(_this){return function(){return _this.updateTimerId=_this.background.setTimeout(function(){return _this.update()},_this.updateInterval)}}(this)}),this.messageQueue=[]},Chat.prototype.init=function(){return this.update()},Chat}()});var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};define("Agora",["underscore","Debug","client/ContentScript","client/SiteInjector","Site","siteConfig","View","clientInterface/ClientValue","models/init","model/Event","Updater2","Public","views/ProductPriceView","views/ProductMenuView","views/SettingsView","CodeManager","Chat"],function(_,Debug,ContentScript,SiteInjector,Site,siteConfig,View,ClientValue,initModels,Event,Updater,Public,ProductPriceView,ProductMenuView,SettingsView,CodeManager,Chat){var Agora;return Agora=function(){function Agora(background,opts){var autoUpdate,createView,createViewQueue,db,lastUpdated,modelManager,onLoaded,scrapersTime,settingName,settings,tutorialCheck,updateScrapers,updateScrapersCbs,updateScrapersId,updater,updatingScrapers,user,_i,_len,_ref,_ref1;this.background=background,opts==null&&(opts={}),opts.client==null&&(opts.client=!0),_ref=initModels(this.background),db=_ref.db,modelManager=_ref.modelManager,this.db=db,this.modelManager=modelManager,window.Debug=Debug,this["public"]=new Public,this["public"].agora=this,this.background.loadVersion=this.loadVersion=(new Date).getTime(),this.events={onUserChanged:new Event},lastUpdated=null,autoUpdate=opts.autoUpdate,opts.localTest=(_ref1=env.localTest)!=null?_ref1:opts.localTest,this.View=View,View.agora=this,Site.agora=this,_.extend(this.modelManager.getModel("Product"),{background:background,agora:this}),this.Site=Site,this.siteSettings=new ClientValue(this,{},"siteSettings"),this.userId=new ClientValue(this,{},0),this.errorState=new ClientValue(this),settings=["hideBelt","autoFeelings","showPreview"],this.settings={};for(_i=0,_len=settings.length;_i<_len;_i++)settingName=settings[_i],this.settings[settingName]=new ClientValue(this);this.codeManager=new CodeManager(this),env.core||(this.chat=new Chat(this),this.chat.init()),scrapersTime=null,env.core||(updatingScrapers=!1,updateScrapersId=null,updateScrapersCbs=[],this.updateScrapers=updateScrapers=function(_this){return function(cb){cb==null&&(cb=null),cb&&updateScrapersCbs.push(cb);if(updatingScrapers){console.debug("already updating scrapers");return}return background.clearTimeout(updateScrapersId),updatingScrapers=!0,background.httpRequest("http://ext.agora.sh/getScrapers.php",{data:{timestamps:!0,version:chrome.runtime.getManifest().version,time:scrapersTime!=null?scrapersTime:void 0},dataType:"json",cb:function(response){var i,newScraper,scraper,toRemove,_j,_k,_l,_len1,_len2,_len3,_m,_ref2,_ref3,_ref4;background.declarativeScrapers,toRemove=[],_ref2=response.scrapers;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){newScraper=_ref2[_j],_ref3=background.declarativeScrapers;for(i=_k=0,_len2=_ref3.length;_k<_len2;i=++_k)scraper=_ref3[i],scraper.name===newScraper.name&&scraper.site===newScraper.site&&toRemove.push(i)}if(toRemove.length)for(i=_l=_ref4=toRemove.length-1;_ref4<=0?_l<=0:_l>=0;i=_ref4<=0?++_l:--_l)background.declarativeScrapers.splice(toRemove[i],1);background.declarativeScrapers=background.declarativeScrapers.concat(response.scrapers),scrapersTime=response.time,updatingScrapers=!1,updateScrapersId=background.setTimeout(updateScrapers,3e4);for(_m=0,_len3=updateScrapersCbs.length;_m<_len3;_m++)cb=updateScrapersCbs[_m],cb(!0);return updateScrapersCbs=[]},error:function(){return updateScrapersId=background.setTimeout(updateScrapers,3e4)}})}}(this)),onLoaded=function(_this){return function(success){var doOnLoaded;return console.debug("loaded"),doOnLoaded=function(){var args,config,name,observeField,observeRecord,siteName,siteSettings,table,_j,_len1,_ref2;_this.modelManager.getModel("Product").init();if(!env.core){updateScrapers(),observeField=function(record,field){return record.field(field).observe(function(mutation){return updater.addUpdate(record,field)})},observeRecord=function(record){var field,_j,_len1,_ref2,_results;if(record.table.schema.fields){_ref2=record.table.schema.fields,_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++)field=_ref2[_j],_results.push(observeField(record,field));return _results}},_ref2=db.tables;for(name in _ref2)table=_ref2[name],table.records.each(observeRecord),table.records.observe(function(mutation){if(mutation.type==="insertion")return updater.addInsertion(mutation.value),observeRecord(mutation.value);if(mutation.type==="deletion")return updater.addDeletion(mutation.value)})}siteSettings={};for(siteName in siteConfig){config=siteConfig[siteName];if(!("enabled"in config)||config.enabled===!0)siteSettings[siteName]={enabled:!0}}db.tables.site_settings.records.each(function(record){return siteSettings[record.get("site")]={enabled:record.get("enabled")}}),_this.siteSettings.set(siteSettings),_this.background.getStorage(["options"],function(data){var setting,_j,_len1,_results;if(data.options){_results=[];for(_j=0,_len1=settings.length;_j<_len1;_j++)setting=settings[_j],_results.push(_this.settings[setting].set(data.options[setting]));return _results}}),db.tables.site_settings.observe(function(mutation){switch(mutation.type){case"deletion":delete _this.siteSettings.get()[mutation.record.get("site")];break;case"insertion":_this.siteSettings.get()[mutation.record.get("site")]={};break;case"update":_this.siteSettings.get()[mutation.record.get("site")][mutation.field]=mutation.record.get(mutation.field)}return _this.siteSettings.set(_this.siteSettings.get())}),_this.updater.userId&&success&&(_this.user=_this.modelManager.getModel("User").withId("G"+_this.updater.userId,!1));for(_j=0,_len1=createViewQueue.length;_j<_len1;_j++)args=createViewQueue[_j],createView.apply(null,args);return delete createViewQueue,_this.loaded=!0,typeof opts.onLoaded=="function"?opts.onLoaded(_this):void 0},env.core?doOnLoaded():background.httpRequest("http://ext.agora.sh/getScrapers.php",{data:{timestamps:!0,version:chrome.runtime.getManifest().version},dataType:"json",cb:function(response){return background.declarativeScrapers=response.scrapers,scrapersTime=response.time,doOnLoaded()}})}}(this),createView=function(_this){return function(source,args,sendResponse){var id;return id=View.createClientView(source.tabId,args.type),sendResponse({id:id})}}(this),createViewQueue=[],this.updater=updater=new Updater(background,db,this.userId,this.errorState),autoUpdate||(this.updater.autoUpdate=!1),opts.localTest||opts.core?(this.loaded=!0,typeof opts.initDb=="function"&&opts.initDb(this),user=db.tables.users.insert({}),this.user=modelManager.getInstance("User",user.get("id")),db.tables.belts.insert({user_id:user.get("id")}),this.userId.set(user.get("id")),onLoaded()):autoUpdate?(this.loaded=!1,updater.init(onLoaded)):(this.loaded=!0,onLoaded()),opts.client&&(this.background.listen("CreateView",function(_this){return function(source,args,sendResponse){return _this.loaded?createView.apply(_this,arguments):(createViewQueue.push(arguments),!0)}}(this)),this.background.listen("CallViewBackgroundMethod",function(source,args,sendResponse){return View.callMethod(args.id,args.methodName,args.args,args.timestamp,sendResponse),!1}),this.background.listen("ConnectView",function(_this){return function(source,args,sendResponse){return View.connect(_this,args.id,args.args,function(data){return sendResponse({data:data})}),!0}}(this)),this.background.listen("DeleteView",function(_this){return function(source,args){return View.remove(args.id),!1}}(this)),this.background.listen("GetClientObjects",function(source,ids,sendResponse){return sendResponse(View.getClientObjects(ids))}),this.background.listen("tracking",function(_this){return function(source,args){return env.core||(args.type==="event"?tracking.event.apply(tracking,args.args):args.type==="page"?tracking.page(args.path,args.params,args.title):args.type==="time"&&tracking.time.apply(tracking,args.args)),!1}}(this)),this.background.listen("tutorialFinished",function(_this){return function(){return _this.tutorial("end"),!1}}(this)),this.background.listen("tutorialStep",function(_this){return function(source,step){return _this.tutorial("step",step),!1}}(this)),this.background.listen("reloadExtension",function(_this){return function(){return chrome.runtime.reload(),!1}}(this)),tutorialCheck=function(_this){return function(tutorial){return _this.user.get("tutorials")?__indexOf.call(_this.user.get("tutorials").split(" "),tutorial)>=0?!1:!0:!0}}(this),this.background.listen("tutorialCheck",function(_this){return function(source,tutorial,sendResponse){var t,_j,_len1;if(env.core)return sendResponse(!1);if(_.isArray(tutorial))for(_j=0,_len1=tutorial.length;_j<_len1;_j++){t=tutorial[_j];if(tutorialCheck(t)){sendResponse(t);return}}else if(tutorialCheck(tutorial)){sendResponse(tutorial);return}return sendResponse(!1)}}(this)),this.background.listen("tutorialSeen",function(_this){return function(source,tutorial,sendResponse){if(!_this.user.get("tutorials"))return _this.user.set("tutorials",tutorial);if(!(__indexOf.call(_this.user.get("tutorials").split(" "),tutorial)>=0))return _this.user.set("tutorials",""+_this.user.get("tutorials")+" "+tutorial)}}(this)))}return Agora.prototype._load=function(classes,cb,classDefs){var classFactory,className,deps,factory;classDefs==null&&(classDefs=[]),deps=[];for(className in classes)classFactory=classes[className],typeof classFactory=="string"?deps.push(classFactory):(typeof classFactory=="function"?factory=classFactory:(classFactory.d&&(deps=_.union(deps,classFactory.d)),factory=classFactory.c),classDefs.unshift({name:className,body:factory.toString()}));return deps.length?this.background.require(_.map(deps,function(className){return"client/"+className}),function(_this){return function(){var c,i,index,_i,_ref;c={};for(i=_i=0,_ref=deps.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)className=deps[i],(index=className.lastIndexOf("/"))!==-1&&(className=className.substr(index+1)),classFactory=arguments[i],c[className]=classFactory;return _this._load(c,cb,classDefs)}}(this)):cb(classDefs)},Agora.prototype._compileContentScript=function(classDefs,site){var body,classCode,classVars,name,setting,settingName,settingsStr,_i,_len,_ref,_ref1;classVars=classDefs.join("\n"),classCode="var __classes = {};\n";for(_i=0,_len=classDefs.length;_i<_len;_i++)_ref=classDefs[_i],name=_ref.name,body=_ref.body,classCode+="window."+name+" = __classes."+name+" = ("+body+")();\n";settingsStr="",_ref1=this.settings;for(settingName in _ref1)setting=_ref1[settingName],settingsStr+=""+settingName+": new ClientValue({ _id: "+setting._id+", _scalar: "+JSON.stringify(setting.get())+", contentScript: contentScript }),";return"(function() {\n	/* content script */\n	\n	function run() {\n		var env = "+JSON.stringify(env)+";\n		// CoffeScript system methods\n		var __hasProp = Object.prototype.hasOwnProperty,\n			__extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; },\n			__slice = [].slice;\n\n		"+classCode+"\n		window.__classes = __classes;\n\n		var contentScript = window.contentScript = new SpecificContentScript;\n		contentScript.version = "+this.version+";\n\n		var Agora = window.Agora = {\n			siteSettings: new ClientValue({\n				_id: "+this.siteSettings._id+",\n				contentScript: contentScript,\n				_scalar:"+JSON.stringify(this.siteSettings.get())+"\n			}),\n			settings: {\n				"+settingsStr+"\n			},\n			userId: new ClientValue({\n				_id: "+this.userId._id+",\n				contentScript: contentScript,\n				_scalar:"+JSON.stringify(this.userId.get())+"\n			}),\n			errorState: new ClientValue({\n				_id: "+this.errorState._id+",\n				contentScript: contentScript,\n				_scalar:"+JSON.stringify(this.errorState.get())+"\n			}),\n			dev:"+env.dev+"\n		};\n\n		var siteInjector;\n\n		window.doSiteInjection = function() {\n			siteInjector = window.siteInjector = new window.SpecificSiteInjector(contentScript, "+this.continueTutorial+", '"+site.name+"');\n\n			siteInjector.run();\n		}\n\n		doSiteInjection()\n\n		if (window.onAgoraInit) {\n			window.onAgoraInit();\n		}\n	}\n	return run();\n})()"},Agora.prototype.setAutoShowForSite=function(site,value){var record;return record=this.db.tables.site_settings.select(function(record){return record.get("site")===site})[0],record||(record=this.db.tables.site_settings.addRecord({site:site})),record.set("enabled",value)},Agora.prototype.toggleAutoShow=function(site){return this.enabledForSite(site,function(_this){return function(enabled){return _this.setAutoShowForSite(site,enabled?0:1)}}(this))},Agora.prototype.enabledForUrl=function(url,cb){var site;return site=Site.siteForUrl(url),site?this.enabledForSite(site.id(),cb):!1},Agora.prototype._setSiteEnabled=function(siteID,enabled){var _base;return this._sitesEnabledCache==null&&(this._sitesEnabledCache={}),enabled?this._sitesEnabledCache[siteID]=!0:delete this._sitesEnabledCache[siteID],(_base=this.siteSettings.get())[siteID]==null&&(_base[siteID]={}),this.siteSettings.get()[siteID].enabled=enabled,this.siteSettings.set(this.siteSettings.get())},Agora.prototype.enabledForSite=function(siteID,cb){var record,site;record=this.db.tables.site_settings.select(function(record){return record.get("site")===siteID})[0];if(record)return cb(record.get("enabled"));site=Site.siteById(siteID);if(site.config.enabled!=="check")return cb(!0);if(this._sitesEnabledCache&&siteID in this._sitesEnabledCache)return cb(!0);if(!env.dev)return this.background.httpRequest(this.background.apiRoot+"merchantCheck.php",{data:{host:site.host},cb:function(_this){return function(response){return response==="1"?(_this._setSiteEnabled(siteID,!0),cb(!0)):cb(!1)}}(this),error:function(){return cb(!1)}})},Agora.prototype._getContentScript=function(siteInjector,site,cb){var classes,libsScript,mainScript,styleScript,tick;return mainScript=styleScript=libsScript=null,tick=function(_this){return function(){if(mainScript&&styleScript&&libsScript)return cb(""+libsScript+"\n"+styleScript+"\n"+mainScript)}}(this),this.background.getStyles(function(_this){return function(styles){return styles=styles.replace(/"/g,'\\"').replace(/\n/g,"\\n"),styleScript="$('head').append(\"<style id='agoraStylesheet' type='text/css'>"+styles+'</style>");',tick()}}(this)),classes={SpecificSiteInjector:siteInjector,SiteInjector:SiteInjector,Debug:"Debug",tracking:"tracking",TutorialDialog:"TutorialDialog",ShoppingBarView:"views/ShoppingBarView",ProductPriceView:ProductPriceView.client,ProductMenuView:ProductMenuView.client,SettingsView:SettingsView.client,SpecificContentScript:this.background.contentScript(),ContentScript:ContentScript},this._load(classes,function(_this){return function(classDefs){return mainScript=_this._compileContentScript(classDefs,site),tick()}}(this)),this.background.httpRequest(this.background.clientLibsPath(),{method:"get",cb:function(response){return libsScript=response,tick()}})},Agora.prototype.getContentScript=function(url,cb){return this.getSiteInjector(url,function(_this){return function(siteInjector,site){return siteInjector?_this._getContentScript(siteInjector,site,cb):(console.log("no site injector for "+url),cb(""))}}(this))},Agora.prototype.getSiteInjector=function(url,cb){var site;return site=Site.siteForUrl(url),site?site.getSiteInjector(this.background,cb):cb(null)},Agora.prototype.getSiteScraper=function(url,cb){var site;return site=Site.siteForUrl(url),site?site.getSiteScraper(this.background,function(_this){return function(scraperClass){var scraper;return scraper=new scraperClass(_this.background),cb(scraper)}}(this)):cb(null)},Agora.prototype.product=function(input,cb,create){return create==null&&(create=!0),this.modelManager.getModel("Product").get(input,cb,create)},Agora.prototype.tutorial=function(state){var time;state==="continue"?this.continueTutorial=!0:delete this.continueTutorial;if(state==="start")return this.tutorialStartTime=(new Date).getTime();if(state==="end")return time=(new Date).getTime()-this.tutorialStartTime,delete this.tutorialStartTime,tracking.time("Tutorial","TotalTime",time);if(state==="step"&&this.user.get("tutorial_step")<arguments[1])return this.user.set("tutorial_step",arguments[1])},Agora.prototype.setOptions=function(options){return this.background.getStorage(["options"],function(_this){return function(data){var prevOptions,prop,value,_ref;prevOptions=(_ref=data.options)!=null?_ref:{};for(prop in options)value=options[prop],prevOptions[prop]=value,_this.settings[prop].set(value);return _this.background.setStorage({options:prevOptions})}}(this))},Agora.prototype.addTab=function(tabId){return this.tabs||(this.tabs=[]),this.tabs.push(tabId),this.background.contentScriptListen("ClientObjectEvent:"+this.userId._id,tabId),this.background.contentScriptListen("ClientObjectEvent:"+this.errorState._id,tabId),this.background.contentScriptListen("ClientObjectEvent:"+this.siteSettings._id,tabId)},Agora.prototype.removeTab=function(tabId){return _.pull(this.tabs,tabId),View.deleteClientViewsInTab(tabId)},Agora.prototype.signalReload=function(){var tab,_i,_len,_ref,_results;console.log(this.tabs);if(this.tabs){_ref=this.tabs,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)tab=_ref[_i],_results.push(chrome.tabs.sendMessage(tab,"needsReload"));return _results}},Agora.prototype.reset=function(){return console.debug("reset"),this.background.loadVersion=this.loadVersion=(new Date).getTime(),this.signalReload(),this.View.clear(),this.background.reset()},Agora.prototype.onInit=function(success){var _ref;console.log(success);if(!this.updater.userId)return delete this.user;if(success){this.user=this.modelManager.getModel("User").withId("G"+this.updater.userId);if((_ref=this.View.views.ShoppingBar)!=null?_ref["null"]:void 0)return this.View.views.ShoppingBar["null"].setUser(this.user),this.View.views.Collaborate.ShoppingBar.update()}},Agora.prototype.getObject=function(storeId,object){var id,table,_ref;return object==="@"?this.db.tables.users.byId("G"+storeId):object==="/"?this.db.tables.users.byId("G"+storeId):(_ref=object.split("."),table=_ref[0],id=_ref[1],this.db.table(table).byId("G"+storeId))},Agora}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/AddArgumentView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var AddArgumentsView;return AddArgumentsView=function(_super){__extends(AddArgumentsView,_super);function AddArgumentsView(){return AddArgumentsView.__super__.constructor.apply(this,arguments)}return AddArgumentsView.nextId=0,AddArgumentsView.id=function(args){return++this.nextId},AddArgumentsView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(obj,element){return _this.obj=obj,_this.element=element,_this.data=util.arguments(_this.ctx,obj),done()}}(this))},AddArgumentsView.prototype.methods={add:function(view,pro,against,thought){return this.agora.modelManager.getModel("Argument").create({element_type:this.obj.modelName,element_id:this.obj.get("id"),thought:thought,"for":pro,against:against,timestamp:new Date})},"delete":function(view,id){return this.agora.modelManager.getInstance("Argument",id)["delete"]()}},AddArgumentsView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/AddDataView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var AddDataView;return AddDataView=function(_super){__extends(AddDataView,_super);function AddDataView(){return AddDataView.__super__.constructor.apply(this,arguments)}return AddDataView.nextId=0,AddDataView.id=function(args){return++this.nextId},AddDataView.prototype.initAsync=function(args,done){return this.resolveObject(args.object,function(_this){return function(obj){return _this.obj=obj,args.url?args.url.match(/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/)?_this.agora.background.httpRequest(args.url,{cb:function(responseText,response){var contentType,matches,title;return contentType=response.header("Content-Type"),contentType.match(/^text\/html/)?(matches=responseText.match(/<title>([^<]*)<\/title>/i),title=matches?matches[1].trim():void 0,_this.data={type:"url",title:title}):contentType.match(/^image\//)&&(_this.data={type:"image"}),done()},error:function(){return done()}}):_this.data={}:done()}}(this))},AddDataView.prototype.methods={add:function(view,data){return data.element_type=this.obj.modelName,data.element_id=this.obj.get("id"),this.agora.modelManager.getModel("Datum").create(data)}},AddDataView}(View)}),define("text",["module"],function(module){var text,fs,Cc,Ci,xpcIsWindows,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation=typeof location!="undefined"&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||undefined),buildMap={},masterConfig=module.config&&module.config()||{};text={version:"2.0.10",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var modName,ext,temp,strip=!1,index=name.indexOf("."),isRelative=name.indexOf("./")===0||name.indexOf("../")===0;return index!==-1&&(!isRelative||index>1)?(modName=name.substring(0,index),ext=name.substring(index+1,name.length)):modName=name,temp=ext||modName,index=temp.indexOf("!"),index!==-1&&(strip=temp.substring(index+1)==="strip",temp=temp.substring(0,index),ext?ext=temp:modName=temp),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var uProtocol,uHostName,uPort,match=text.xdRegExp.exec(url);return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],(!uProtocol||uProtocol===protocol)&&(!uHostName||uHostName.toLowerCase()===hostname.toLowerCase())&&(!uPort&&!uHostName||uPort===port)):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config.isBuild&&!config.inlineText){onLoad();return}masterConfig.isBuild=config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+(parsed.ext?"."+parsed.ext:""),url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;if(url.indexOf("empty:")===0){onLoad();return}!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})},write:function(pluginName,moduleName,write,config){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),extPart=parsed.ext?"."+parsed.ext:"",nonStripName=parsed.moduleName+extPart,fileName=req.toUrl(parsed.moduleName+extPart)+".js";text.load(nonStripName,req,function(value){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}};if(masterConfig.env==="node"||!masterConfig.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"])fs=require.nodeRequire("fs"),text.get=function(url,callback,errback){try{var file=fs.readFileSync(url,"utf8");file.indexOf("﻿")===0&&(file=file.substring(1)),callback(file)}catch(e){errback(e)}};else if(masterConfig.env==="xhr"||!masterConfig.env&&text.createXhr())text.get=function(url,callback,errback,headers){var xhr=text.createXhr(),header;xhr.open("GET",url,!0);if(headers)for(header in headers)headers.hasOwnProperty(header)&&xhr.setRequestHeader(header.toLowerCase(),headers[header]);masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(evt){var status,err;xhr.readyState===4&&(status=xhr.status,status>399&&status<600?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback(err)):callback(xhr.responseText),masterConfig.onXhrComplete&&masterConfig.onXhrComplete(xhr,url))},xhr.send(null)};else if(masterConfig.env==="rhino"||!masterConfig.env&&typeof Packages!="undefined"&&typeof java!="undefined")text.get=function(url,callback){var stringBuffer,line,encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),content="";try{stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&line.charAt(0)===65279&&(line=line.substring(1)),line!==null&&stringBuffer.append(line);while((line=input.readLine())!==null)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)};else if(masterConfig.env==="xpconnect"||!masterConfig.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)Cc=Components.classes,Ci=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),xpcIsWindows="@mozilla.org/windows-registry-key;1"in Cc,text.get=function(url,callback){var inStream,convertStream,fileObj,readData={};xpcIsWindows&&(url=url.replace(/\//g,"\\")),fileObj=new FileUtils.File(url);try{inStream=Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream),inStream.init(fileObj,1,0,!1),convertStream=Cc["@mozilla.org/intl/converter-input-stream;1"].createInstance(Ci.nsIConverterInputStream),convertStream.init(inStream,"utf-8",inStream.available(),Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),convertStream.readString(inStream.available(),readData),convertStream.close(),inStream.close(),callback(readData.value)}catch(e){throw new Error((fileObj&&fileObj.path||"")+": "+e)}};return text}),define("text!taxonomySrc",[],function(){return"artifact\n	Brand\n\ngarment (clothes, clothing) : artifact\n	Wash Instructions\n	Materials\n	Color\n	Size\n	Gender\n	Origin\n	\nundergarment : garment\n\nshoe : garment\n\nbrassier (bra) : undergarment\n	Neckline\n	Closure\n	Underbust Band\n	Straps\n	\ntrouser (pant) : garment\n	Waistband\n	Closure\n	Hand Pockets\n	Back Pockets\n	Fit\n	Cuff\n\nbaby toy : artifact\n	@icon babyToy\n\ncomputer hardware : artifact\n	Model\n\nvideo card : computer hardware\n	# Chipset\n	Core Clock\n	Boost Clock\n	GPU\n	\n	Memory\n		Effective Memory Clock\n		Memory Size\n		Memory Type\n	Interface\n\ncpu : computer hardware\n	Series\n	Socket Type\n	Core\n	Number of Cores\n	Number of Threads\n	Clock Speed\n	Turbo Clock Speed\n	L2 Cache\n	L3 Cache\n	Manufacturing Tech\n	DMI\n	Thermal Design Power\n"}),define("taxonomy",["underscore","text!taxonomySrc"],function(_,taxonomySrc){var canonicalTypeName,currentItem,line,lines,matches,nameMap,obj,plural,special,synonym,taxonomy,type,_i,_j,_len,_len1,_ref;lines=taxonomySrc.split(/\n/),taxonomy={},currentItem=null;for(_i=0,_len=lines.length;_i<_len;_i++){line=lines[_i];if(line.trim()==="")continue;if(line[0]==="	"){line=line.trim();if(line[0]==="#")continue;line[0]==="@"?(special=line.match(/^@(.*)\s/)[1],special==="icon"&&(taxonomy[currentItem].icon=line.match(/^@icon (.*)$/)[1])):taxonomy[currentItem].properties.push(line)}else matches=line.match(/^(.*?)(?: \((.*?)\))?(?: : (.*?))?$/),currentItem=matches[1],taxonomy[currentItem]={properties:[]},matches[2]&&(taxonomy[currentItem].synonyms=matches[2].split(", ")),matches[3]&&(taxonomy[currentItem].isA=matches[3])}nameMap={},plural=function(word){return word.match(/ly$/)?word.substr(0,word.length-1)+"ies":word.match(/s$/)?word+"es":word+"s"};for(type in taxonomy){obj=taxonomy[type],nameMap[type]=type,nameMap[plural(type)]=type;if(obj.synonyms){_ref=obj.synonyms;for(_j=0,_len1=_ref.length;_j<_len1;_j++)synonym=_ref[_j],nameMap[synonym]=type,nameMap[plural(synonym)]=type}}return canonicalTypeName=function(typeName){return typeName&&(typeName=typeName.toLowerCase()),nameMap[typeName]},{properties:function(typeName){var prop,properties,_k,_len2,_ref1,_results;typeName=canonicalTypeName(typeName);if(!taxonomy[typeName])return[];properties=[];while(typeName)type=taxonomy[typeName],type.properties&&(properties=properties.concat(function(){var _k,_len2,_ref1,_results;_ref1=type.properties,_results=[];for(_k=0,_len2=_ref1.length;_k<_len2;_k++)prop=_ref1[_k],_results.push([typeName,prop]);return _results}())),typeName=type.isA;properties.sort(function(a,b){return a[1]>b[1]?1:a[1]<b[1]?-1:0}),_results=[];for(_k=0,_len2=properties.length;_k<_len2;_k++)_ref1=properties[_k],typeName=_ref1[0],prop=_ref1[1],_results.push(""+typeName+"."+prop);return _results},icon:function(typeName){var _ref1;return(_ref1=taxonomy[canonicalTypeName(typeName)])!=null?_ref1.icon:void 0}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/AddDescriptorView",["View","Site","Formatter","util","underscore","taxonomy"],function(View,Site,Formatter,util,_,taxonomy){var AddDescriptorView;return AddDescriptorView=function(_super){__extends(AddDescriptorView,_super);function AddDescriptorView(){return AddDescriptorView.__super__.constructor.apply(this,arguments)}return AddDescriptorView.prototype.init=function(){return this.data=this.clientValue()},AddDescriptorView.prototype.methods={parse:function(view,descriptor){return this.agora.background.httpRequest(""+this.agora.background.apiRoot+"parse.php",{data:{descriptor:descriptor},cb:function(_this){return function(response){return _this.data.set({descriptor:response,icon:taxonomy.icon(response.product.type)})}}(this)})}},AddDescriptorView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/AddFeelingView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var AddFeelingView;return AddFeelingView=function(_super){__extends(AddFeelingView,_super);function AddFeelingView(){return AddFeelingView.__super__.constructor.apply(this,arguments)}return AddFeelingView.nextId=0,AddFeelingView.id=function(args){return++this.nextId},AddFeelingView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(obj){return _this.obj=obj,_this.data=util.feelings(_this.ctx,obj),done()}}(this))},AddFeelingView.prototype.methods={add:function(view,positive,negative,thought){return this.agora.modelManager.getModel("Feeling").create({element_type:this.obj.modelName,element_id:this.obj.get("id"),thought:thought,positive:positive,negative:negative,timestamp:new Date})},"delete":function(view,id){return this.agora.modelManager.getInstance("Feeling",id)["delete"]()}},AddFeelingView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/AddItemView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var AddItemView;return AddItemView=function(_super){__extends(AddItemView,_super);function AddItemView(){return AddItemView.__super__.constructor.apply(this,arguments)}return AddItemView.prototype.init=function(){},AddItemView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/BuyView",["View","util"],function(View,util){var BuyView;return BuyView=function(_super){__extends(BuyView,_super);function BuyView(){return BuyView.__super__.constructor.apply(this,arguments)}return BuyView.nextId=1,BuyView.id=function(){return this.nextId++},BuyView.prototype.init=function(args){var listElementIds,otherProducts,product,products,twoTapProducts,view,_i,_len;args.id?this.decision=this.agora.modelManager.getInstance("Decision",args.id):args.viewId&&(view=this.agora.View.clientViews[args.viewId].view,view.name==="compare/Compare"&&(this.decision=view.currentDecision())),products=[],listElementIds=[],this.decision.get("selection").each(function(_this){return function(element){return listElementIds.push(element.saneId()),products=products.concat(util.resolveProducts(element.get("element")))}}(this)),twoTapProducts=[],otherProducts=[];for(_i=0,_len=products.length;_i<_len;_i++)product=products[_i],product.set("purchased",!0),product.site().config.twoTap?twoTapProducts.push(""+product.get("siteName")+"/"+product.get("productSid")):otherProducts.push(""+product.get("siteName")+"/"+product.get("productSid"));return twoTapProducts.length?this.data={url:"http://ext.agora.sh/checkout.php?"+("decision="+this.decision.saneId()+"&")+("products="+otherProducts.join(",")+"&")+("twoTapProducts="+twoTapProducts.join(",")+"&")+("listElements="+listElementIds.join(",")+"&")+("clientId="+this.agora.updater.clientId)}:(this.data={},this.agora.background.httpRequest("http://ext.agora.sh/checkout.php?"+("decision="+this.decision.saneId()+"&")+("products="+otherProducts.join(",")+"&")+("listElements="+listElementIds.join(",")+"&")+("clientId="+this.agora.updater.clientId)))},BuyView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ChatView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var ChatView;return ChatView=function(_super){__extends(ChatView,_super);function ChatView(){return ChatView.__super__.constructor.apply(this,arguments)}return ChatView.prototype.newMessage=function(){return this.background.clearTimeout(this.notifyNewMessageTimerId),this.background.clearTimeout(this.notifyNewUnreadMessagesTimerId),this.newMessages++,this.notifyNewMessageTimerId=this.background.setTimeout(function(_this){return function(){return _this.data.newMessages.set(_this.newMessages),_this.background.clearTimeout(_this.notifyNewUnreadMessagesTimerId),_this.notifyNewUnreadMessagesTimerId=_this.background.setTimeout(function(){return _this.data.newUnreadMessages.set(_this.newMessages)},50)}}(this),50)},ChatView.prototype.init=function(){var messages;return this.newMessages=this.agora.chat.newMessages?1:0,this.agora.chat.messages.observe(function(_this){return function(mutation){if(mutation.type==="insertion")return _this.newMessage()}}(this)),messages=this.clientArray(this.ctx,this.agora.chat.messages,function(obj){return obj}),this.data={newMessages:this.clientValue(this.newMessages),newUnreadMessages:this.clientValue(this.newMessages),messages:messages,online:this.clientValue(this.agora.chat.online),writingReply:this.clientValue(this.agora.chat.writingReply)}},ChatView.prototype.methods={readNewMessages:function(){return this.newMessages=0,this.data.newMessages.set(this.newMessages),this.data.newUnreadMessages.set(this.newMessages),this.background.clearTimeout(this.notifyNewUnreadMessagesTimerId),this.agora.chat.readMessages()},sendMessage:function(view,message){return this.agora.chat.sendMessage(message)},writingMessage:function(view,message){return this.agora.chat.setPendingMessage(message)}},ChatView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/CollaborateView",["View","Site","Formatter","util","underscore","model/ObservableArray","model/ObservableValue"],function(View,Site,Formatter,util,_,ObservableArray,ObservableValue){var CollaborateView,filteredArray;return filteredArray=function(ctx,subject,output,test,reversed){var add;return reversed==null&&(reversed=!1),add=reversed?function(obj){return output.unshift(obj)}:function(obj){return output.push(obj)},subject.each(function(_this){return function(record){if(test(record))return add(record)}}(this)),ctx.observeObject(subject,function(_this){return function(mutation){if(mutation.type==="insertion"){if(test(mutation.value))return add(mutation.value)}else if(mutation.type==="deletion"&&test(mutation.value))return output.remove(mutation.value)}}(this))},CollaborateView=function(_super){__extends(CollaborateView,_super);function CollaborateView(){return CollaborateView.__super__.constructor.apply(this,arguments)}return CollaborateView.nextId=0,CollaborateView.id=function(args){return args==="ShoppingBar"?args:++this.nextId},CollaborateView.prototype.doInit=function(obj){var getObject,id,nameMap,object,objectData,objectText,table,userId,_nameMap,_next,_ref,_ref1;if(!this.agora.user)return;getObject=function(_this){return function(modelName,id){var model,_ref,_ref1,_ref2;return model=_this.agora.modelManager.getModel(modelName),id=(_ref=(_ref1=_this.agora.db.globalToLocalMapping)!=null?(_ref2=_ref1[model._table.name])!=null?_ref2[id]:void 0:void 0)!=null?_ref:id,model.withId(id,!1)}}(this),this.obj=obj,this.stateCtx.clear(),userId=null,object=null,this.object=_.isString(obj)?(_ref=obj.split("."),table=_ref[0],id=_ref[1],_ref,object=this.agora.modelManager.instanceForRecord(this.agora.db.table(table).bySaneId(id)),object?(userId=parseInt(object.record.storeId),obj):void 0):obj.isA("Decision")?(object=obj,userId=parseInt(obj.record.storeId),"decisions."+obj.record.globalId().substr(1)):obj.isA("Belt")?(object=obj,userId=parseInt(obj.record.storeId),"belts."+obj.record.globalId().substr(1)):obj.isA("ObjectReference")?(userId=obj.get("object_user_id"),obj.get("object")==="/"?object=this.agora.modelManager.getInstance("User","G"+userId):(_ref1=obj.get("object").split("."),table=_ref1[0],id=_ref1[1],_ref1,object=this.agora.modelManager.instanceForRecord(this.agora.db.table(table).bySaneId(id))),obj.get("object")):void 0;if(!this.object)return;return this.collaborators=new ObservableArray,filteredArray(this.stateCtx,this.agora.db.tables.collaborators.records,this.collaborators,function(_this){return function(record){return record.get("object_user_id")==userId&&record.get("object")===_this.object}}(this)),_nameMap={},_next={},nameMap=function(model,id){var key;return key=""+model+"."+id,_nameMap[key]?_nameMap[key]:(_next[model]==null&&(_next[model]=0),_nameMap[key]=""+model+" "+String.fromCharCode(65+_next[model]++))},this.activity=new ObservableArray,filteredArray(this.stateCtx,this.agora.db.tables.activity.records,this.activity,function(_this){return function(record){var curObj,parent;curObj=getObject(record.get("object_type"),record.get("object_id"));while(curObj){if(curObj.isA(object.modelName)&&curObj.get("id")===object.get("id"))return!0;parent=curObj.record.owner();if(!parent)return!1;curObj=agora.modelManager.instanceForRecord(parent)}return!1}}(this),!0),objectText=function(_this){return function(inObject){}}(this),objectData=function(inObject){var model,text;text=null,model=null,id=null;if(_.isString(inObject.model)){obj=getObject(inObject.model,inObject.id);if(obj)return objectData(obj);text=nameMap(inObject.model,inObject.id)}else model=inObject.modelName,id=inObject.get("id"),inObject.isA("Product")?text=inObject.get("title")?inObject.get("title").substr(0,10)+"...":nameMap(inObject.modelName,inObject.get("id")):inObject.isA("Decision")&&inObject.equals(object)&&inObject.get("share_title")?text=inObject.get("share_title"):inObject.isA("Belt")&&inObject.equals(object)&&inObject.get("title")?text=inObject.get("title"):text=nameMap(inObject.modelName,inObject.get("id"));return{text:text,model:model,id:id}},this.data.set({owner:this.agora.user.get("id")==="G"+userId,collaborators:this.clientArray(this.stateCtx,this.collaborators,function(_this){return function(obj,onRemove,ctx){var abbreviation,updateAbbreviation,userWrapper;return obj.get("pending")?{name:obj.get("email"),pending:!0,id:obj.get("invitation")}:(userWrapper=util.userWrapper(obj.get("user_id")),ctx().onDestruct=function(){return userWrapper.destruct()},abbreviation=ctx().clientValue(),updateAbbreviation=function(){return userWrapper.empty?abbreviation.set(obj.get("user_id")):abbreviation.set(userWrapper.get("name")[0])},updateAbbreviation(),ctx().observe(userWrapper.field("name"),updateAbbreviation),{name:ctx().clientValue(userWrapper.field("name")),owner:obj.get("user_id")==userId,id:obj.get("user_id"),abbreviation:abbreviation,color:util.colorForUser(_this.agora.user,userWrapper)})}}(this)),activity:this.clientArray(this.stateCtx,this.activity,function(_this){return function(entry,onRemove,ctx){var arg,date,i,images,num,numberForPreview,pertainingObject,product,text,user,userString,_i;pertainingObject=getObject(entry.get("object_type"),entry.get("object_id")),user=_this.agora.modelManager.getInstance("User",entry.get("generator_id"),!1),userString=user?user.get("name"):"User "+(entry.get("generator_id")[0]==="G"?entry.get("generator_id").substr(1):entry.get("generator_id")),images=[],numberForPreview=entry.get("type")==="convert"?-1:0,num=entry.get("args").length+numberForPreview;for(i=_i=0;0<=num?_i<num:_i>num;i=0<=num?++_i:--_i)arg=entry.get("args")[i],arg.model==="Product"?(product=getObject(arg.model,arg.id),product&&images.push(ctx().clientValue(product.field("image")))):arg.model==="Decision"?images.push("decision"):arg.model==="Belt"?images.push("belt"):arg.model==="Bundle"&&images.push("bundle");return text=function(){switch(entry.get("type")){case"add":return[objectData(entry.get("args")[0]),"was added to",objectData(pertainingObject)];case"remove":return[objectData(entry.get("args")[0]),"was removed from",objectData(pertainingObject)];case"decision.select":return[objectData(entry.get("args")[0]),"was selected in",objectData(pertainingObject)];case"decision.deselect":return[objectData(entry.get("args")[0]),"was deselected in",objectData(pertainingObject)];case"convert":return[objectData(entry.get("args")[0]),"and",objectData(entry.get("args")[1]),"was converted to",objectData(entry.get("args")[2]),"in",objectData(pertainingObject)];case"decision.setDescriptor":return[objectData(pertainingObject),"was edited"];default:return["Something was done"]}}(),userString&&(id=entry.get("generator_id")[0]==="G"?entry.get("generator_id").substr(1):entry.get("generator_id"),text=text.concat(["by",{text:userString,type:"user",color:util.colorForUser(_this.agora.user,id)}])),date=new Date(entry.get("timestamp")*1e3),{type:entry.get("type"),text:text,images:images.slice(0,4),timestamp:date.toLocaleString()}}}(this))})},CollaborateView.prototype.initAsync=function(args,done){var init;return this.args=args,this.data=this.clientValue(),this.stateCtx=this.context(),init=function(_this){return function(obj){return _this.doInit(obj),done()}}(this),args?args==="ShoppingBar"?(this.agora.View.views.ShoppingBar["null"].shareObject.get()&&init(this.agora.View.views.ShoppingBar["null"].shareObject.get().object),this.agora.View.views.ShoppingBar["null"].shareObject.observe(function(_this){return function(mutation){if(_this.obj!==mutation.value.object)return init(mutation.value.object)}}(this))):this.resolveObject(args,function(_this){return function(obj){return init(obj)}}(this)):init(this.agora.View.views.ShoppingBar["null"].currentState().shareObject())},CollaborateView.prototype.update=function(){return this.doInit(this.agora.View.views.ShoppingBar["null"].shareObject.get().object)},CollaborateView.prototype.methods={"delete":function(view,id){var params,shareObject;return shareObject=this.agora.db.tables.shared_objects.selectFirst({object:this.object,with_user_id:"G"+id}),params={id:shareObject.globalId().substr(1)},this.agora.updater.transport.messageStream.sendMessage("message",this.agora.user.saneId(),"share/delete",JSON.stringify(params))},deletePending:function(view,id){var params;return params={invitation:id},this.agora.updater.transport.messageStream.sendMessage("message",this.agora.user.saneId(),"share/delete",JSON.stringify(params))}},CollaborateView}(View)}),define("views/compare/TileItem",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var TileItem;return TileItem=function(){function TileItem(){}return TileItem.prototype.getData=function(cb){return cb(this.data)},TileItem.prototype.observe=function(object,observer){if(object)return this.ctx.observe(object,observer)},TileItem}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/ListTileItem",["View","Site","Formatter","util","underscore","./TileItem"],function(View,Site,Formatter,util,_,TileItem){var ListTileItem;return ListTileItem=function(_super){__extends(ListTileItem,_super);function ListTileItem(){return ListTileItem.__super__.constructor.apply(this,arguments)}return ListTileItem.prototype.type="List",ListTileItem.prototype.init=function(){var barItemData,updateData,_ref;return this.contentsCtx=this.ctx.context(),barItemData=(_ref=typeof this.barItemData==="function"?this.barItemData():void 0)!=null?_ref:{},barItemData.state=this.view.clientValue(),updateData=function(_this){return function(){var data;return data=_this.obj.get("collapsed")?{state:"collapsed",contents:_this.collapsedContents()}:{state:"expanded",contents:_this.expandedContents()},barItemData.state.set(data)}}(this),updateData(),this.data={type:this.type,barItemData:barItemData},this.observe(this.obj.field("collapsed"),function(_this){return function(){return _this.contentsCtx.clear(),updateData()}}(this))},ListTileItem.prototype.dropped=function(obj){return util.addElement(this.obj,obj),null},ListTileItem.prototype.ripped=function(view){return view.element["delete"]()},ListTileItem.prototype.expandedContents=function(){var contents;return contents=this.view.clientArrayNamed(""+this.obj.modelName+".contents"),util.syncArrays(this.contentsCtx,this.obj.get("elements"),contents,function(_this){return function(element,onRemove,i){return{elementType:element.modelName,elementId:element.get("id"),compareViewId:_this.view.compareView.id}}}(this)),contents},ListTileItem.prototype.collapsedContents=function(){var clientContents,getContents,reset;return getContents=function(_this){return function(){var contents,ctx,obj,sources,stack,state;stack=[{list:_this.obj.get("elements"),pos:0}],contents=[],sources=[_this.obj.get("elements")];while(stack.length&&contents.length<4){state=stack[stack.length-1];if(state.list.length()===state.pos){stack.pop();continue}obj=state.list.get(state.pos++).get("element");for(;;){obj.modelName==="Product"?(contents.push(obj.get("image")),sources.push(obj.field("image"))):obj.modelName==="Decision"?(stack.push({list:obj.get("selection"),pos:0}),sources.push(obj.get("selection"))):obj.modelName==="Bundle"&&(stack.push({list:obj.get("elements"),pos:0}),sources.push(obj.get("elements")));break}}return ctx=_this.view.context(),[contents,sources]}}(this),clientContents=this.view.clientArrayNamed(""+this.obj.modelName+".contents"),reset=function(_this){return function(){var contents,source,sources,_i,_len,_ref;_this.contentsCtx.clear(),_ref=getContents(),contents=_ref[0],sources=_ref[1];for(_i=0,_len=sources.length;_i<_len;_i++)source=sources[_i],_this.contentsCtx.observe(source,function(mutation){return reset()});return clientContents.setArray(contents)}}(this),reset(),clientContents},ListTileItem.prototype.methods={toggle:function(view){return this.obj.get("collapsed")?this.obj.set("collapsed",!1):this.obj.set("collapsed",!0)},click:function(){return shoppingBarView.pushState({dropped:function(_this){return function(obj){return util.addElement(_this.obj,obj)}}(this),ripped:function(_this){return function(view){return view.element["delete"]()}}(this),contents:function(_this){return function(){return _this.obj.get("elements")}}(this),contentMap:function(_this){return function(el){return{elementType:"ListElement",elementId:el.get("id")}}}(this)})}},ListTileItem}(TileItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/BundleTileItem",["View","Site","Formatter","util","underscore","./ListTileItem"],function(View,Site,Formatter,util,_,ListTileItem){var BundleTileItem;return BundleTileItem=function(_super){__extends(BundleTileItem,_super);function BundleTileItem(){return BundleTileItem.__super__.constructor.apply(this,arguments)}return BundleTileItem.prototype.type="Bundle",BundleTileItem}(ListTileItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/CompareView",["View","Site","Formatter","util","underscore","taxonomy","model/ObservableValue"],function(View,Site,Formatter,util,_,taxonomy,ObservableValue){var CompareView;return CompareView=function(_super){__extends(CompareView,_super);function CompareView(){return CompareView.__super__.constructor.apply(this,arguments)}return CompareView.nextId=1,CompareView.id=function(args){return this.nextId++},CompareView.prototype.currentDecision=function(){var i,_i,_ref;for(i=_i=_ref=this.path.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i)if(this.path[i].state==="Decision")return this.path[i].obj},CompareView.prototype.initAsync=function(args,done){var init;return this.path=[],this.ctx=this.context(),this.data=this.clientValue(),this["public"]=args["public"],init=function(_this){return function(){return _this.pushState({state:"Decision",dropped:function(element){return _this.decision.get("list").get("contents").add(util.resolveObject(element))},ripped:function(view){return view.element["delete"]()},contents:function(){return _this["public"]?_this.decision.get("listElements"):_this.decision.get("considering")},contentMap:function(el){return{elementType:"ListElement",elementId:el.get("id"),decisionId:_this.decision.get("id")}},args:{decisionId:_this.decision.get("id")},breadcrumb:_this.decision,obj:_this.decision}),done()}}(this),args.decision.id?(this.decision=this.agora.modelManager.getInstance("Decision",args.decision.id),init()):this.resolveObject(args.decision,function(_this){return function(decision){return _this.decision=decision,init()}}(this))},CompareView.prototype.currentState=function(){return this.path[this.path.length-1]},CompareView.prototype.initState=function(state){var breadcrumb,breadcrumbs,clientContents,data,decision,updateDescriptor,updateIcon,updateProperties,_i,_len,_ref;this.stateCtx==null&&(this.stateCtx=this.context()),this.stateCtx.clear(),this["public"]?this.displayOptions=new ObservableValue({displayComponents:["title","price","rating"]},!0):this.displayOptions=this.currentState().obj.field("display_options"),breadcrumbs=[],_ref=this.path;for(_i=0,_len=_ref.length;_i<_len;_i++)breadcrumb=_ref[_i].breadcrumb,breadcrumbs.push(breadcrumb.modelName==="Decision"?util.listPreview(this.stateCtx.context(),breadcrumb.get("list").get("elements")):breadcrumb.modelName==="Product"?this.stateCtx.clientValue(breadcrumb.field("image")):void 0);if(state.state==="Decision")return clientContents=this.stateCtx.clientArray(state.contents(),function(_this){return function(el){return _.merge(state.contentMap(el),{compareViewId:_this.id})}}(this)),this.displaying&&util.unsync(this.displaying),this.displaying=clientContents,data={contents:clientContents,state:state.state,args:state.args,breadcrumbs:breadcrumbs},state.obj.modelName==="Decision"&&(decision=state.obj,data.dismissalList=this.stateCtx.clientArray(decision.get("dismissed"),function(_this){return function(el,onRemove){var ctx,obj;obj=el.get("element");if(obj.modelName==="Product")return obj.get("image");if(obj.modelName==="Decision")return ctx=_this.stateCtx.context(),onRemove(function(){return ctx.destruct()}),util.listPreview(ctx,obj.get("selection"));if(obj.modelName==="Bundle")return ctx=_this.stateCtx.context(),onRemove(function(){return ctx.destruct()}),util.listPreview(ctx,obj.get("elements"))}}(this)),data.properties=this.stateCtx.clientValue(),updateProperties=function(_this){return function(){var Product,count,descriptorProduct,displayOptions,done,product,products,prop,properties,propertyCounts,propertyPaths,_j,_k,_len1,_len2,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_results;products=[],state.contents().each(function(el){var product,_j,_len1,_ref1,_results;_ref1=util.resolveProducts(el.get("element")),_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++)product=_ref1[_j],_results.push(products.push(product));return _results}),_this.stateCtx.context("properties").destruct(),properties=[],displayOptions=(_ref1=_this.displayOptions.get())!=null?_ref1:{displayComponents:[]},_ref2=[{label:"Title",path:"title",count:products.length},{label:"Rating",path:"rating"},{label:"Price",path:"price",count:products.length},{label:"Feelings",path:"feelings",count:products.length}];for(_j=0,_len1=_ref2.length;_j<_len1;_j++)prop=_ref2[_j],properties.push({path:prop.path,label:prop.label,count:prop.count,selected:_this.stateCtx.context("properties").clientValue(displayOptions.displayComponents.indexOf(prop.path)!==-1)});data.properties.set(properties),descriptorProduct=(_ref3=(_ref4=decision.get("list").get("descriptor"))!=null?(_ref5=_ref4.product)!=null?_ref5.type:void 0:void 0)!=null?_ref3:(_ref6=decision.get("list").get("descriptor"))!=null?_ref6.product:void 0,done=function(){return setTimeout(function(){var propertyPath,_k,_len2,_ref7;properties[1].count=propertyCounts.rating;for(_k=0,_len2=propertyPaths.length;_k<_len2;_k++)propertyPath=propertyPaths[_k],properties.push({path:propertyPath,label:propertyPath.split(".")[1],selected:_this.stateCtx.context("properties").clientValue(displayOptions.displayComponents.indexOf(propertyPath)!==-1),count:(_ref7=propertyCounts[propertyPath])!=null?_ref7:0});return data.properties.set(properties)},1e3)},propertyPaths=descriptorProduct?taxonomy.properties(descriptorProduct):[],propertyCounts={rating:0},count=products.length,Product=_this.agora.modelManager.getModel("Product"),_results=[];for(_k=0,_len2=products.length;_k<_len2;_k++)product=products[_k],_results.push(Product.siteProduct(product,function(siteProduct){if(siteProduct){siteProduct.site.hasFeature("rating")&&propertyCounts.rating++;if(descriptorProduct)return siteProduct.usedProperties(descriptorProduct,function(usedProperties){var property,_l,_len3;for(_l=0,_len3=usedProperties.length;_l<_len3;_l++)property=usedProperties[_l],propertyCounts[property]==null&&(propertyCounts[property]=0),++propertyCounts[property];if(!--count)return done()});if(!--count)return done()}else if(!--count)return done()}));return _results}}(this),updateProperties(),util.observeContents(this.stateCtx,decision.get("considering"),updateProperties),data.descriptor=this.stateCtx.clientValue(),updateDescriptor=function(_this){return function(){var descriptor,_ref1;return descriptor=(_ref1=decision.get("list").get("descriptor"))!=null?_ref1.descriptor:void 0,data.descriptor.set(descriptor!=null?descriptor:"")}}(this),updateDescriptor(),data.icon=this.stateCtx.clientValue(),updateIcon=function(_this){return function(){var _ref1,_ref2;return data.icon.set(taxonomy.icon((_ref1=decision.get("list").get("descriptor"))!=null?(_ref2=_ref1.product)!=null?_ref2.type:void 0:void 0))}}(this),updateIcon(),this.stateCtx.observe(decision.get("list").field("descriptor"),function(){return updateDescriptor(),updateProperties(),updateIcon()})),this.data.set(data);if(state.state==="Product")return this.data.set({state:state.state,breadcrumbs:breadcrumbs,productId:state.obj.get("id")})},CompareView.prototype.pushState=function(state){return!state.state&&this.state&&(state.state=this.state),this.path.push(state),this.initState(state)},CompareView.prototype.popState=function(){return this.path.pop(),this.initState(this.currentState())},CompareView.prototype.ripped=function(data){return this.currentState().ripped(data)},CompareView.prototype.dropped=function(data){return this.currentState().dropped(data)},CompareView.prototype.methods={up:function(view){return this.popState()},move:function(view,elementData,toData,dropAction){var elementView,toView;return toView=this.agora.View.clientViews[toData.view].view,elementView=this.agora.View.clientViews[elementData.view].view,elementView["delete"](),toView.dropped(elementView,dropAction)},drop:function(view,elementData,onData,dropAction){return this.resolveElements(elementData,onData,function(element,onView){return onView.dropped(element,dropAction)})},reorder:function(view,fromIndex,toIndex){return util.reorder(this.currentState().contents(),fromIndex,toIndex)},remove:function(view,elementData,fromData){var elementView,fromView;return fromView=this.agora.View.clientViews[fromData.view].view,elementView=this.agora.View.clientViews[elementData.view].view,fromView.ripped(elementView)},split:function(view,selection){var cont,decision,element,obj,rootEl,viewId,_i,_len;cont=this.agora.modelManager.getModel("List").create(),decision=this.agora.modelManager.getModel("Decision").create({list_id:cont.get("id")});for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,cont.get("contents").add(view.obj),element=view.element,view.element["delete"]();return this.path.length===1?(obj=decision,rootEl=this.agora.modelManager.getModel("RootElement").create({element_type:obj.modelName,element_id:obj.get("id")})):this.path[this.path.length-2].dropped(decision)},extract:function(view,selection){var parent,viewId,_i,_len,_results;parent=this.path.length===1?shoppingBarView:this.path[this.path.length-2],_results=[];for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,parent.dropped(view.obj),_results.push(view.element["delete"]());return _results},wrap:function(view,type,selection){var cont,element,obj,parent,viewId,_i,_len;cont=obj=null,type==="decision"?(cont=this.agora.modelManager.getModel("List").create(),obj=this.agora.modelManager.getModel("Decision").create({list_id:cont.get("id")})):obj=cont=function(){switch(type){case"bundle":return this.agora.modelManager.getModel("Bundle").create();case"session":return this.agora.modelManager.getModel("Session").create({title:"New Session"})}}.call(this),parent=type==="session"?null:!1;for(_i=0,_len=selection.length;_i<_len;_i++){viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,cont.get("contents").add(view.obj),element=view.element;if(parent===!1||parent!==null)element.modelName==="RootElement"?parent=null:parent?element.get("parent").equals(parent)||(parent=null):parent=element.get("parent");view.element["delete"]()}return parent===null?this.dropped(obj):parent.get("contents").add(obj)},"delete":function(view,selection){var viewId,_i,_len,_results;_results=[];for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],_results.push(this.agora.View.clientViews[viewId].view.element["delete"]());return _results},gotoRoot:function(){return this.path=[this.path[0]],this.initState(this.path[0])},gotoPath:function(view,index){return this.path=this.path.slice(0,index+1),this.initState(this.path[index])},restore:function(view,index){var decision;return decision=this.currentState().obj,decision.get("considering").add(decision.get("dismissed").get(index))},removeDismissed:function(view,index){var decision;return decision=this.currentState().obj,decision.get("dismissed").get(index)["delete"]()},clearDismissalList:function(){return this.currentState().breadcrumb.get("dismissalList").get("contents").removeAll()},openProduct:function(view,productData){return this.resolveObject(productData,function(_this){return function(product){return _this.pushState({state:"Product",breadcrumb:product,obj:product})}}(this))},setProperty:function(view,name,selected){var displayOptions,_ref;return displayOptions=(_ref=this.displayOptions.get())!=null?_ref:{displayComponents:[]},selected?displayOptions.displayComponents.indexOf(name)===-1&&displayOptions.displayComponents.push(name):_.pull(displayOptions.displayComponents,name),this.displayOptions.set(displayOptions)}},CompareView}(View)}),define("views/items/Item",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var Item;return Item=function(){function Item(){}return Item.prototype.getData=function(cb){return cb(this.data)},Item.prototype.observe=function(object,observer){if(object)return this.ctx.observe(object,observer)},Item}()});var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/items/DecisionItem",["View","Site","Formatter","util","underscore","./Item","taxonomy"],function(View,Site,Formatter,util,_,Item,taxonomy){var DecisionItem;return DecisionItem=function(_super){__extends(DecisionItem,_super);function DecisionItem(){return this.dropped=__bind(this.dropped,this),DecisionItem.__super__.constructor.apply(this,arguments)}return DecisionItem.prototype.selectionObj=function(obj){return obj},DecisionItem.prototype.init=function(done){var descriptor,listSize,selection,selectionSize,updateListSize,updateSelectionSize;return listSize=this.itemView.clientValueNamed("listSize"),updateListSize=function(_this){return function(){return listSize.set(_this.obj.get("list").get("contents").length())}}(this),this.observe(this.obj.get("list").get("contents"),updateListSize),updateListSize(),selectionSize=this.itemView.clientValueNamed("selectionSize"),updateSelectionSize=function(_this){return function(){return selectionSize.set(_this.obj.get("selection").length())}}(this),this.observe(this.obj.get("selection"),updateSelectionSize),updateSelectionSize(),selection=this.itemView.clientArrayNamed(""+this.obj.modelName+".selection"),util.syncArrays(this.ctx,this.obj.get("selection"),selection,function(_this){return function(element,onRemove,i){return _this.selectionObj({elementType:element.modelName,elementId:element.get("id")})}}(this)),descriptor=this.obj.get("list").field("descriptor"),this.data={type:"Decision",barItemData:{listSize:listSize,selectionSize:selectionSize,selection:selection,preview:util.listPreview(this.ctx.context(),this.obj.get("list").get("elements")),descriptor:this.itemView.clientValue(descriptor),icon:this.itemView.clientValue(descriptor,function(){var _ref,_ref1;return taxonomy.icon((_ref=descriptor.get())!=null?(_ref1=_ref.product)!=null?_ref1.type:void 0:void 0)}),shared:this.ctx.clientValue(this.obj.field("shared"))}}},DecisionItem.prototype.dropped=function(element,dropAction){var obj;return obj=util.resolveObject(element),this.obj.get("list").get("contents").add(obj),_activity("add",this.obj,obj),null},DecisionItem.prototype.methods={click:function(){return this.onClick()}},DecisionItem}(Item)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/DecisionTileItem",["View","Site","Formatter","util","underscore","views/items/DecisionItem","taxonomy"],function(View,Site,Formatter,util,_,DecisionItem,taxonomy){var DecisionTileItem;return DecisionTileItem=function(_super){__extends(DecisionTileItem,_super);function DecisionTileItem(){return DecisionTileItem.__super__.constructor.apply(this,arguments)}return DecisionTileItem.prototype.selectionObj=function(obj){return obj.compareViewId=this.view.compareView.id,obj},DecisionTileItem.prototype.onClick=function(){return this.view.compareView.pushState({dropped:function(_this){return function(element){return _this.obj.get("list").get("contents").add(util.resolveObject(element))}}(this),ripped:function(_this){return function(view){return view.element["delete"]()}}(this),contents:function(_this){return function(){return _this.obj.get("considering")}}(this),contentMap:function(_this){return function(el){return{elementType:"ListElement",elementId:el.get("id"),decisionId:_this.obj.get("id")}}}(this),state:"Decision",args:{decisionId:this.obj.get("id")},breadcrumb:this.obj,obj:this.obj})},DecisionTileItem}(DecisionItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/ProductTileItem",["View","Site","Formatter","util","underscore","./TileItem"],function(View,Site,Formatter,util,_,TileItem){var ProductTileItem;return ProductTileItem=function(_super){__extends(ProductTileItem,_super);function ProductTileItem(){return ProductTileItem.__super__.constructor.apply(this,arguments)}return ProductTileItem.prototype.init=function(){var decision,product,updateProperties;return product=this.obj,this.properties=this.ctx.clientArray(),this.propertiesCtx=this.ctx.context(),decision=this.view.compareView.currentState().obj,updateProperties=function(_this){return function(){var Product;return Product=_this.view.agora.modelManager.getModel("Product"),Product.siteProduct(product,function(siteProduct){var cv,displayOptions,properties,property,_i,_len,_ref,_ref1;properties=[],_this.propertiesCtx.clear(),displayOptions=(_ref=_this.view.compareView.displayOptions.get())!=null?_ref:{displayComponents:[]},_ref1=displayOptions.displayComponents;for(_i=0,_len=_ref1.length;_i<_len;_i++)property=_ref1[_i],properties.push({property:property,value:function(){switch(property){case"price":return product.get("id");case"rating":if(siteProduct.site.hasFeature("rating"))return{rating:this.propertiesCtx.clientValue(product.field("rating"),product.displayValue("rating")),ratingCount:this.propertiesCtx.clientValue(product.field("ratingCount"),product.displayValue("ratingCount"))};break;case"title":return this.propertiesCtx.clientValue(product.field("title"),product.displayValue("title"));case"feelings":return util.feelings(this.propertiesCtx,product);case"arguments":return util.arguments(this.propertiesCtx,product);default:if(siteProduct)return cv=this.propertiesCtx.clientValue(),siteProduct.property(property,function(value){return cv.set(value)}),cv}}.call(_this)});return _this.properties.setArray(properties)})}}(this),updateProperties(),this.ctx.observe(this.view.compareView.displayOptions,updateProperties),this.data={type:"Product",barItemData:{id:product.get("id"),url:product.get("url"),sid:product.get("productSid"),site:{name:product.get("siteName"),url:product.get("siteUrl")},lastFeeling:util.lastFeeling(this.ctx,product),lastArgument:util.lastArgument(this.ctx,product),image:this.view.clientValueNamed("ProductBarItem.image",product.field("image"),product.displayValue("image")),properties:this.properties}}},ProductTileItem.prototype.dropped=function(obj,dropAction){var decision,list;return tracking.event("Compare","createDecision"),obj=util.resolveObject(obj),list=this.view.agora.modelManager.getModel("List").create(),list.get("contents").add(this.obj),list.get("contents").add(obj),this.view.descriptor&&list.set("descriptor",this.view.descriptor.get("descriptor")),decision=this.view.agora.modelManager.getModel("Decision").create({list_id:list.get("id")}),_activity("convert",this.view.element,this.obj,obj,decision),decision},ProductTileItem.prototype.methods={click:function(){return this.view.compareView.pushState({state:"Product",breadcrumb:this.obj,obj:this.obj})}},ProductTileItem}(TileItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ItemView",["View","Site","Formatter","util","underscore","taxonomy"],function(View,Site,Formatter,util,_,taxonomy){var ItemView;return ItemView=function(_super){__extends(ItemView,_super);function ItemView(){return ItemView.__super__.constructor.apply(this,arguments)}return ItemView.prototype.dropped=function(obj,dropAction){var bundle,newObj;if(this.obj){if(obj.modelName==="Datum")return tracking.event("ShoppingBar","addData"),obj.set("element_type",this.obj.modelName),obj.set("element_id",this.obj.get("id"));if(obj.modelName==="Descriptor")return this.descriptor?(this.descriptor.set("descriptor",obj.get("descriptor")),obj["delete"]()):this.obj.modelName==="Decision"?(this.obj.get("list").set("descriptor",obj.get("descriptor")),obj["delete"]()):(obj.set("element_type",this.obj.modelName),obj.set("element_id",this.obj.get("id")),this.element.set("element_type",obj.modelName),this.element.set("element_id",obj.get("id")));newObj=null,dropAction==="createBundle"?(tracking.event("ShoppingBar","createBundle"),bundle=this.agora.modelManager.getModel("Bundle").create(),obj=util.resolveObject(obj),bundle.get("contents").add(this.obj),bundle.get("contents").add(obj),_activity("convert",this.element,this.obj,obj,bundle),newObj=bundle):this.descriptor&&this.obj.isNull()?(this.descriptor.set("element_type",obj.modelName),this.descriptor.set("element_id",obj.get("id"))):this.item.dropped&&(newObj=this.item.dropped(obj,dropAction));if(newObj){if(this.descriptor)return this.descriptor.set("element_type",newObj.modelName),this.descriptor.set("element_id",newObj.get("id"));if(this.element)return this.element.set("element_type",newObj.modelName),this.element.set("element_id",newObj.get("id"));if(this.slot)return this.slot.set("element_type",newObj.modelName),this.slot.set("element_id",newObj.get("id"))}}else if(this.itemType)return this.item.dropped(obj,dropAction)},ItemView.prototype.initAsync=function(args,done){var creatorId,selected,update,updateSelected,userWrapper;return this.data=this.clientValue(),this.itemCtx=this.context(),this.element=this.agora.modelManager.getModel(this.args.elementType).withId(this.args.elementId),this.additionalData={},this.element.observe(function(_this){return function(mutation){if(mutation.type==="deleted")return _this.destruct()}}(this)),update=function(_this){return function(cb){var id,object,table,_ref;return _this.descriptor&&_this.stopObservingObject(_this.descriptor.get("element")),delete _this.objectReference,delete _this.getObj,delete _this.descriptor,delete _this.itemType,_this.obj=_this.element.get("element"),_this.obj.modelName==="Descriptor"?(_this.descriptor=_this.obj,_this.obj=_this.obj.get("element"),_this.observeObject(_this.descriptor.get("element"),update)):_this.obj.modelName==="ObjectReference"&&(_this.objectReference=_this.obj,_this.obj=null,_this.getObj=function(){return this.objectReference},object=_this.objectReference.get("object"),_this.additionalData.user={color:util.colorForUser(_this.agora.user,_this.objectReference.get("object_user_id"))},_this["public"]?(_this.itemType="Unauthorized",object==="/"?_this.additionalData.objectType="Belt":(_ref=object.split("."),table=_ref[0],id=_ref[1],table==="decisions"?_this.additionalData.objectType="Decision":table==="belts"&&(_this.additionalData.objectType="Belt"))):_this.agora.updater.transport.whenObject(_this.objectReference.get("object_user_id"),["@",object],function(){var _ref1;delete _this.itemType;if(object==="/")return _this.itemType="SharedBelt",setTimeout(function(){return _this.updateItem()},200);_ref1=object.split("."),table=_ref1[0],id=_ref1[1];if(table==="decisions")return _this.obj=_this.agora.modelManager.getInstance("Decision","G"+id),setTimeout(function(){return _this.updateItem()},200);if(table==="belts")return _this.obj=_this.agora.modelManager.getInstance("Belt","G"+id),setTimeout(function(){return _this.updateItem()},200)},function(){var _ref1;return _this.obj=null,_this.itemType="Unauthorized",object==="/"?_this.additionalData.objectType="Belt":(_ref1=object.split("."),table=_ref1[0],id=_ref1[1],table==="decisions"?_this.additionalData.objectType="Decision":table==="belts"&&(_this.additionalData.objectType="Belt")),setTimeout(function(){return _this.updateItem()},200)})),_this.updateItem(cb)}}(this),this["public"]||this.element.get("creator_id")&&this.element.get("creator_id")!==this.agora.user.get("id")&&(creatorId=this.element.get("creator_id").substr(1),userWrapper=util.userWrapper(creatorId),this.additionalData.creator={color:util.colorForUser(this.agora.user,creatorId),name:this.clientValue(userWrapper.field("name"))}),this.element.modelName==="ListElement"&&args.decisionId&&(selected=this.clientValueNamed("selected"),_.merge(this.additionalData,{selected:selected,decisionId:args.decisionId}),this.decision=this.agora.modelManager.getInstance("Decision",args.decisionId),updateSelected=function(_this){return function(){return selected.set(_this.decision.get("selection").contains(_this.element))}}(this),updateSelected(),this.decision.get("selection").observe(updateSelected)),this.observeObject(this.element.get("element"),update),update(done)},ItemView.prototype.updateItem=function(cb){return cb==null&&(cb=null),this.initItem(function(_this){return function(){var data,_ref,_ref1;return _this.obj?_this.descriptor&&_this.obj.isNull()?(data={descriptor:_this.descriptor.get("descriptor"),icon:taxonomy.icon((_ref=_this.descriptor.get("descriptor"))!=null?(_ref1=_ref.product)!=null?_ref1.type:void 0:void 0)},_this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0):_this.item.getData(function(data){return _this.descriptor&&(data.descriptor=_this.descriptor.get("descriptor")),data.id=_this.obj.get("id"),_this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0}):_this.itemType?_this.item.getData(function(data){return _this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0}):(_this.data.set(null),typeof cb=="function"?cb():void 0)}}(this))},ItemView.prototype.initItem=function(cb){var type,_ref;return this.itemCtx.clear(),this.obj||this.itemType?this.descriptor&&(!this.obj||this.obj.isNull())?(delete this.item,cb()):(type=(_ref=this.itemType)!=null?_ref:this.obj.model.name==="ProductVariant"?"Product":this.obj.model.name,this.getItem(type,this.obj,function(_this){return function(item){return _this.item=item,cb()}}(this))):cb()},ItemView.prototype.getItem=function(type,obj,cb){return this.agora.background.require([this.itemClass(type)],function(_this){return function(klass){var item;return item=new klass,item.itemView=item.view=_this,item.obj=obj,item.ctx=_this.itemCtx,typeof item.init=="function"&&item.init(),item.initAsync?item.initAsync(function(){return cb(item)}):cb(item)}}(this))},ItemView.prototype.hasMethod=function(name){var _ref,_ref1;return this.methods[name]||((_ref=this.item)!=null?(_ref1=_ref.methods)!=null?_ref1[name]:void 0:void 0)},ItemView.prototype.method=function(name){return this.methods[name]?this.methods[name]:this.item.methods[name]},ItemView.prototype["delete"]=function(){var obj;return this.slot?(this.slot.set("element_type",null),this.slot.set("element_id",null)):(_activity("remove",this.element,this.element.get("element")),obj=this.element.get("element"),this.element["delete"]())},ItemView.prototype.methods={"delete":function(){return this["delete"]()},click:function(view){var _ref,_ref1,_ref2;return(_ref=this.item)!=null?(_ref1=_ref.methods)!=null?(_ref2=_ref1.click)!=null?_ref2.call(this.item,view):void 0:void 0:void 0},reorder:function(view,fromIndex,toIndex){return util.reorder(this.obj.get("contents"),fromIndex,toIndex)},add:function(view,type){var composite;return composite=this.agora.modelManager.getModel("Composite").createWithType(type),this.obj.get("contents").add(composite)},setSelected:function(view,selected){if(this.decision)return selected?(this.decision.get("selection").add(this.element),_activity("decision.select",this.decision,this.element.get("element"))):(this.decision.get("selection").remove(this.element),_activity("decision.deselect",this.decision,this.element.get("element")))}},ItemView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/TileItemView",["View","Site","Formatter","util","underscore","taxonomy","views/ItemView"],function(View,Site,Formatter,util,_,taxonomy,ItemView){var TileItemView;return TileItemView=function(_super){__extends(TileItemView,_super);function TileItemView(){return TileItemView.__super__.constructor.apply(this,arguments)}return TileItemView.nextId=1,TileItemView.id=function(args){return this.nextId++},TileItemView.prototype.itemClass=function(type){return"views/compare/"+type+"TileItem"},TileItemView.prototype.initAsync=function(args,done){return this.compareView=this.agora.View.views["compare/Compare"][args.compareViewId],this["public"]=this.compareView,TileItemView.__super__.initAsync.apply(this,arguments)},TileItemView.prototype.methods={"delete":function(){return this["delete"]()},click:function(view){var _ref,_ref1,_ref2;return(_ref=this.item)!=null?(_ref1=_ref.methods)!=null?(_ref2=_ref1.click)!=null?_ref2.call(this.item,view):void 0:void 0:void 0},reorder:function(view,fromIndex,toIndex){return util.reorder(this.obj.get("contents"),fromIndex,toIndex)},add:function(view,type){var composite;return composite=this.agora.modelManager.getModel("Composite").createWithType(type),this.obj.get("contents").add(composite)},setSelected:function(view,selected){if(this.decision)return selected?(this.decision.get("selection").add(this.element),_activity("decision.select",this.decision,this.element.get("element"))):(this.decision.get("selection").remove(this.element),_activity("decision.deselect",this.decision,this.element.get("element")))},dismiss:function(){if(this.decision)return util.dismissDecisionElement(this.decision,this.element)},deleteFeeling:function(view,id){return this.agora.modelManager.getInstance("Feeling",id)["delete"]()},deleteArgument:function(view,id){return this.agora.modelManager.getInstance("Argument",id)["delete"]()}},TileItemView}(ItemView)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/compare/UnauthorizedTileItem",["View","Site","Formatter","util","underscore","./TileItem"],function(View,Site,Formatter,util,_,TileItem){var UnauthorizedTileItem;return UnauthorizedTileItem=function(_super){__extends(UnauthorizedTileItem,_super);function UnauthorizedTileItem(){return UnauthorizedTileItem.__super__.constructor.apply(this,arguments)}return UnauthorizedTileItem.prototype.init=function(){return this.data={type:"Unauthorized",barItemData:{}}},UnauthorizedTileItem}(TileItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/CompetitiveProcessView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var CompetitiveProcessView;return CompetitiveProcessView=function(_super){__extends(CompetitiveProcessView,_super);function CompetitiveProcessView(){return CompetitiveProcessView.__super__.constructor.apply(this,arguments)}return CompetitiveProcessView.id=function(args){return args.decisionId},CompetitiveProcessView.prototype.init=function(){var clientContents;return this.obj=this.agora.modelManager.getInstance("Decision",this.args.decisionId),clientContents=this.ctx.clientArray(this.obj.get("competitiveList").get("elements"),function(_this){return function(el){var element;return element=_this.obj.get("elements").get(el),{row:_this.clientValue(element.field("row")),barItem:{elementType:"CompetitiveListElement",elementId:el.get("id"),decisionId:_this.obj.get("id")}}}}(this)),this.data=clientContents},CompetitiveProcessView.prototype.methods={setRow:function(view,itemViewId,row){var element;return element=this.agora.View.clientViews[itemViewId].view.element,this.obj.get("elements")["for"](element).set("row",row)}},CompetitiveProcessView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ContactView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var ContactView;return ContactView=function(_super){__extends(ContactView,_super);function ContactView(){return ContactView.__super__.constructor.apply(this,arguments)}return ContactView.nextId=0,ContactView.id=function(args){return++this.nextId},ContactView.prototype.methods={submit:function(view,subject,message){return this.agora.background.httpRequest(""+this.agora.background.apiRoot+"contact.php",{method:"post",data:{subject:subject,message:message}})}},ContactView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/CouponsView",["View","Site","Formatter"],function(View,Site,Formatter){var CouponsView;return CouponsView=function(_super){__extends(CouponsView,_super);function CouponsView(){return CouponsView.__super__.constructor.apply(this,arguments)}return CouponsView.nextId=0,CouponsView.id=function(args){return++this.nextId},CouponsView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product){return _this.product=product,_this.data=_this.clientValue(product.field("coupons")),done()}}(this))},CouponsView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/DataView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var DataView;return DataView=function(_super){__extends(DataView,_super);function DataView(){return DataView.__super__.constructor.apply(this,arguments)}return DataView.nextId=0,DataView.id=function(args){return++this.nextId},DataView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(obj){return _this.data=_this.ctx.clientArray(obj.get("data"),function(datum,onRemove){var ctx;return ctx=_this.context(),onRemove(function(){return ctx.destruct()}),{id:datum.get("id"),type:ctx.clientValue(datum.field("type")),url:ctx.clientValue(datum.field("url")),title:ctx.clientValue(datum.field("title")),text:ctx.clientValue(datum.field("text")),comment:ctx.clientValue(datum.field("comment"))}}),done()}}(this))},DataView.prototype.methods={"delete":function(view,id){return this.agora.modelManager.getInstance("Datum",id)["delete"]()}},DataView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/DecisionPreviewView",["View","Site","Formatter","util","underscore","taxonomy"],function(View,Site,Formatter,util,_,taxonomy){var DecisionPreviewView;return DecisionPreviewView=function(_super){__extends(DecisionPreviewView,_super);function DecisionPreviewView(){return DecisionPreviewView.__super__.constructor.apply(this,arguments)}return DecisionPreviewView.nextId=0,DecisionPreviewView.id=function(args){return++this.nextId},DecisionPreviewView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(decision){var descriptor,listSize,selection,selectionSize,updateListSize,updateSelectionSize;return _this.decision=decision,listSize=_this.clientValueNamed("listSize"),updateListSize=function(){return listSize.set(decision.get("list").get("contents").length())},_this.observeObject(decision.get("list").get("contents"),updateListSize),updateListSize(),selectionSize=_this.clientValueNamed("selectionSize"),updateSelectionSize=function(){return selectionSize.set(decision.get("selection").length())},_this.observeObject(decision.get("selection"),updateSelectionSize),updateSelectionSize(),selection=_this.clientArrayNamed(""+decision.modelName+".selection"),util.syncArrays(_this.ctx,decision.get("selection"),selection,function(element,onRemove,i){return{elementType:element.modelName,elementId:element.get("id")}}),descriptor=decision.get("list").field("descriptor"),_this.data={listSize:listSize,selectionSize:selectionSize,selection:selection,preview:util.listPreview(_this.ctx.context(),decision.get("list").get("elements")),descriptor:_this.clientValue(descriptor),icon:_this.clientValue(descriptor,function(){var _ref,_ref1;return taxonomy.icon((_ref=descriptor.get())!=null?(_ref1=_ref.product)!=null?_ref1.type:void 0:void 0)}),shared:_this.ctx.clientValue(decision.field("shared"))},done()}}(this))},DecisionPreviewView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/EditDescriptorView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var EditDescriptorView;return EditDescriptorView=function(_super){__extends(EditDescriptorView,_super);function EditDescriptorView(){return EditDescriptorView.__super__.constructor.apply(this,arguments)}return EditDescriptorView.nextId=0,EditDescriptorView.id=function(args){return++this.nextId},EditDescriptorView.prototype.initAsync=function(args,done){var init;return init=function(_this){return function(){var descriptor,_ref;return descriptor=(_ref=_this.decision.get("list").get("descriptor"))!=null?_ref:{},descriptor.version=0,_this.data=_this.clientValue(descriptor),_this.version=0,_this.parsing=0,done()}}(this),_.isPlainObject(args)?this.resolveObject(args,function(_this){return function(decision){return _this.decision=decision,init()}}(this)):(this.decision=this.agora.modelManager.getInstance("Decision",this.args),init())},EditDescriptorView.prototype.methods={parse:function(view,descriptor,update){return this.descriptor=descriptor,this.parsing++,this.agora.background.httpRequest(""+this.agora.background.apiRoot+"parse.php",{data:{descriptor:descriptor},cb:function(_this){return function(response){return--_this.parsing,_this.shouldUpdate||update?(response.descriptor=_this.descriptor,_this.decision.get("list").set("descriptor",response),_activity("decision.setDescriptor",_this.decision,response)):(_this.lastDescriptor=response,response.version=_this.version++,_this.data.set(response))}}(this)})},updateDescriptor:function(view,descriptor){return descriptor.version===this.version&&!this.parsing?(delete descriptor.version,this.decision.get("list").set("descriptor",descriptor),_activity("decision.setDescriptor",this.decision,descriptor)):this.parsing?this.shouldUpdate=!0:(delete this.lastDescriptor.version,this.lastDescriptor.descriptor=this.descriptor,this.decision.get("list").set("descriptor",this.lastDescriptor),_activity("decision.setDescriptor",this.decision,this.lastDescriptor))}},EditDescriptorView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/OffersView",["View","Site","Formatter"],function(View,Site,Formatter){var OffersView;return OffersView=function(_super){__extends(OffersView,_super);function OffersView(){return OffersView.__super__.constructor.apply(this,arguments)}return OffersView.nextId=0,OffersView.id=function(args){return++this.nextId},OffersView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product){var offers,selectedOffer,updateOffers,updateSelectedOffer;return _this.product=product,product.retrieve("offers"),updateOffers=function(){var cheapest,condition,heading,i,o,offer,productOffers,theseOffers,viewOffers,_i,_j,_len,_len1,_ref,_ref1;if(product.get("offers")){productOffers=product.get("offers"),viewOffers=[],_ref=["new","used","refurbished"];for(_i=0,_len=_ref.length;_i<_len;_i++){condition=_ref[_i];if(productOffers[condition]){theseOffers=productOffers[condition],cheapest=theseOffers[0],heading=condition.substr(0,1).toUpperCase()+condition.substr(1),heading+=" ("+Formatter.price(cheapest.price)+")",o={heading:heading,offers:[]};for(i=_j=0,_len1=theseOffers.length;_j<_len1;i=++_j)offer=theseOffers[i],o.offers.push({id:""+condition+"."+i,data:offer,price:Formatter.price(offer.price),site:offer.site,url:offer.url,title:offer.title,image:offer!=null?(_ref1=offer.images)!=null?_ref1[0]:void 0:void 0,api:offer.api});viewOffers.push(o)}}return offers.set(viewOffers),updateSelectedOffer()}},updateSelectedOffer=function(){var condition,i,offer,productOffers,theseOffers,_i,_j,_len,_len1,_ref;if(product.get("offers")&&product.get("offer")){productOffers=product.get("offers"),_ref=["new","used","refurbished"];for(_i=0,_len=_ref.length;_i<_len;_i++){condition=_ref[_i];if(productOffers[condition]){theseOffers=productOffers[condition];for(i=_j=0,_len1=theseOffers.length;_j<_len1;i=++_j){offer=theseOffers[i];if(offer.url===product.get("offer").url&&offer.price===product.get("offer").price){selectedOffer.set(""+condition+"."+i);return}}}}}return selectedOffer.set(null)},offers=_this.clientValue(),selectedOffer=_this.clientValue(),product.field("offers").observe(updateOffers),updateOffers(),product.field("offer").observe(updateSelectedOffer),_this.data={offers:offers,selectedOffer:selectedOffer},done()}}(this))},OffersView.prototype.methods={setOffer:function(view,offer){return this.product.set("offer",{site:offer.site,url:offer.url,price:offer.price})}},OffersView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductAddedView",["View","Site","Formatter"],function(View,Site,Formatter){var ProductAddedView;return ProductAddedView=function(_super){__extends(ProductAddedView,_super);function ProductAddedView(){return ProductAddedView.__super__.constructor.apply(this,arguments)}return ProductAddedView.id=function(productId){return"Product#"+productId},ProductAddedView.prototype.init=function(productId){var Product,displayPrice,image,price,product,title;return Product=this.agora.modelManager.getModel("Product"),this.product=product=Product.withId(productId),title=this.clientValue(product.get("title")),product.field("title").observe(function(mutation){return title.set(mutation.value)}),price=this.clientValue(product.get("price")),product.field("price").observe(function(mutation){return price.set(mutation.value)}),displayPrice=this.clientValue(product.get("displayPrice")),product.field("price").observe(function(mutation){return displayPrice.set(product.get("displayPrice"))}),image=this.clientValue(product.get("image")),product.field("image").observe(function(mutation){return image.set(mutation.value)}),this.data={title:title,site:{name:product.get("siteName"),url:product.get("siteUrl")},price:price,displayPrice:displayPrice,image:image,url:product.get("url")}},ProductAddedView.prototype.getData=function(cb){return cb(View.serializeObject(this.data))},ProductAddedView.prototype.methods={set:function(view,args){var property,value,_results;_results=[];for(property in args)value=args[property],_results.push(this.product.set(property,value));return _results}},ProductAddedView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductClipView",["View","Formatter"],function(View,Formatter){var ProductClipView;return ProductClipView=function(_super){__extends(ProductClipView,_super);function ProductClipView(){return ProductClipView.__super__.constructor.apply(this,arguments)}return ProductClipView.nextId=1,ProductClipView.id=function(args){return this.nextId++},ProductClipView.prototype.initAsync=function(args,done){var __;return __=function(_this){return function(product){return _this.data={title:_this.clientValueNamed("ProductClipView.title",product.field("title"),product.displayValue("title")),site:_this.clientValueNamed("ProductClipView.site",product.field("siteName")),price:_this.clientValueNamed("ProductClipView.price",product.field("price"),product.displayValue("price"))},done()}}(this),args.elementType&&args.elementId?__(this.agora.modelManager.getInstance(args.elementType,args.elementId).get("element")):this.agora.product(args,__)},ProductClipView.prototype.getData=function(cb){return cb(this.data)},ProductClipView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductOverlayView",["View","Formatter","util"],function(View,Formatter,util){var ProductOverlayView;return ProductOverlayView=function(_super){__extends(ProductOverlayView,_super);function ProductOverlayView(){return ProductOverlayView.__super__.constructor.apply(this,arguments)}return ProductOverlayView.id=function(args){return JSON.stringify(args)},ProductOverlayView.prototype.init=function(args){var inShoppingBar,lastArgument,lastFeeling,status;return inShoppingBar=this.clientValue(),lastFeeling=this.clientValue(),lastArgument=this.clientValue(),status=this.clientValue(),this.data={bagged:inShoppingBar,lastFeeling:lastFeeling,lastArgument:lastArgument,status:status},this.agora.product(args,function(_this){return function(product){var updateInShoppingBar;if(product)return updateInShoppingBar=function(){var obj;return obj=product.get("inShoppingBar"),obj?_this.agora.user&&obj[_this.agora.user.get("id")]?inShoppingBar.set(!0):inShoppingBar.set(!1):inShoppingBar.set(!1)},_this.observeObject(product.field("inShoppingBar"),updateInShoppingBar),updateInShoppingBar(),_this.ctx.bind(status,product.field("status")),util.lastFeeling(_this.ctx,product,lastFeeling),util.lastArgument(_this.ctx,product,lastArgument)}}(this),!1)},ProductOverlayView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductPopupView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var ProductPopupView;return ProductPopupView=function(_super){__extends(ProductPopupView,_super);function ProductPopupView(){return ProductPopupView.__super__.constructor.apply(this,arguments)}return ProductPopupView.nextId=0,ProductPopupView.id=function(args){return++this.nextId},ProductPopupView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product,element){var selected,site,updateSelected;return _this.product=product,_this.element=element,_this.product&&(_this.product.update(),site=Site.site(product._get("siteName")),_this.data={title:_this.clientValue(product.field("title"),product.displayValue("title")),site:{name:product.get("siteName"),url:product.get("siteUrl"),icon:site.icon},price:_this.clientValue(product.field("price"),product.displayValue("price")),image:_this.clientValue(product.field("image"),product.displayValue("image")),url:product.get("url"),lastFeeling:util.lastFeeling(_this.ctx,product),lastArgument:util.lastArgument(_this.ctx,product)},site.hasFeature("rating")&&_.extend(_this.data,{rating:_this.clientValue(product.field("rating"),product.displayValue("rating")),ratingCount:_this.clientValue(product.field("ratingCount"),product.displayValue("ratingCount"))}),args.decisionId&&(selected=_this.clientValueNamed("selected"),_this.decision=_this.agora.modelManager.getInstance("Decision",args.decisionId),updateSelected=function(){return selected.set(_this.decision.get("selection").contains(_this.element))},updateSelected(),_this.decision.get("selection").observe(updateSelected),_this.data.selected=selected)),done()}}(this))},ProductPopupView.prototype.methods={remove:function(){var Bag,Product,bag,product;return Bag=this.agora.modelManager.getModel("Bag"),Product=this.agora.modelManager.getModel("Product"),bag=Bag.withId(this.args.bagId),product=Product.getBySid(this.args.siteName,this.args.productSid),this.agora.removeFromBag(product,bag)},setSelected:function(view,selected){if(this.decision)return selected?(_activity("decision.select",this.decision,this.element.get("element")),this.decision.get("selection").add(this.element)):(this.decision.get("selection").remove(this.element),_activity("decision.deselect",this.decision,this.element.get("element")))},dismiss:function(){if(this.decision)return util.dismissDecisionElement(this.decision,this.element)}},ProductPopupView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ProductPreviewView",["View","underscore","util"],function(View,_,util){var ProductPreviewView;return ProductPreviewView=function(_super){__extends(ProductPreviewView,_super);function ProductPreviewView(){return ProductPreviewView.__super__.constructor.apply(this,arguments)}return ProductPreviewView.nextId=0,ProductPreviewView.id=function(){return++this.nextId},ProductPreviewView.prototype.initAsync=function(args,done){return this.data={},this.resolveObject(args,function(_this){return function(product){return product.update(),_.extend(_this.data,{url:product.get("url"),title:_this.clientValue(product.field("title"),product.displayValue("title")),image:_this.clientValue(product.field("image"),product.displayValue("image"))}),product["interface"](function(siteProduct){var images,widgetsCv;return siteProduct&&(images=_this.clientValue(),widgetsCv=_this.clientValue(),siteProduct.images(function(imgs,currentStyle){return imgs?(currentStyle||(currentStyle=_.keys(imgs)[0]),images.set({images:imgs,currentStyle:currentStyle})):images.set(null)}),siteProduct.widgets?siteProduct.widgets(function(widgets){return widgetsCv.set(widgets)}):widgetsCv.set("none"),_.extend(_this.data,{images:images,widgets:widgetsCv}),siteProduct.site.hasFeature("rating")&&_.extend(_this.data,{rating:_this.clientValue(product.field("rating"),product.displayValue("rating")),ratingCount:_this.clientValue(product.field("ratingCount"),product.displayValue("ratingCount"))})),done()})}}(this))},ProductPreviewView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ReviewsView",["View","Site","Formatter","util"],function(View,Site,Formatter,util){var ReviewsView;return ReviewsView=function(_super){__extends(ReviewsView,_super);function ReviewsView(){return ReviewsView.__super__.constructor.apply(this,arguments)}return ReviewsView.nextId=0,ReviewsView.id=function(args){return++this.nextId},ReviewsView.prototype.initAsync=function(args,done){return this.resolveObject(args,function(_this){return function(product){return _this.product=product,_this.data=_this.clientValue(),product["interface"](function(productIface){var updateData;return updateData=function(){return productIface.reviews(function(data){var review,reviewContent,reviews,_i,_len,_ref,_ref1,_ref2;reviews=[];if(data&&data.reviews){_ref=data.reviews;for(_i=0,_len=_ref.length;_i<_len;_i++)review=_ref[_i],reviewContent=util.stripHtml((_ref1=review.review)!=null?_ref1:review.content,[]),reviewContent.length>200&&(reviewContent=reviewContent.substr(0,200)+"..."),reviews.push({url:review.url?util.url(review.url):product.get("url"),rating:parseInt(review.rating),title:(_ref2=review.title)!=null?_ref2:"",review:reviewContent})}return _this.data.set({reviews:reviews,url:data.url?util.url(data.url):product.get("url"),count:data.count})})},product.field("reviews").observe(updateData),updateData(),done()})}}(this))},ReviewsView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/SharedWithYouView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var SharedWithYouView;return SharedWithYouView=function(_super){__extends(SharedWithYouView,_super);function SharedWithYouView(){return SharedWithYouView.__super__.constructor.apply(this,arguments)}return SharedWithYouView.nextId=0,SharedWithYouView.id=function(args){return++this.nextId},SharedWithYouView.prototype.udpateEntries=function(){var entries;return entries=[],this.agora.db.tables.shared_objects.records.each(function(_this){return function(record){if(record.get("with_user_id")===_this.agora.user.get("id"))return entries.push(_.extend(_.clone(record._values),{id:record.get("id")}))}}(this)),this.entries.set(entries)},SharedWithYouView.prototype.isInBelt=function(value,sharedObject){var ObjectReference,objectReference,objectReferences,rootElements,_i,_len;ObjectReference=this.agora.modelManager.getModel("ObjectReference"),objectReferences=ObjectReference.findAll({object_user_id:parseInt(sharedObject.get("user_id").substr(1)),object:sharedObject.get("object")});for(_i=0,_len=objectReferences.length;_i<_len;_i++){objectReference=objectReferences[_i],rootElements=this.agora.user.get("belts").get(0).get("elements").findAll({element_type:"ObjectReference",element_id:objectReference.get("id")});if(rootElements.length){value.set(!0);return}}return value.set(!1)},SharedWithYouView.prototype.init=function(args){return this.object=this.agora.View.views.ShoppingBar["null"].currentState().shareObject(),this.entries=this.clientValue(),this.udpateEntries(),this.data={entries:this.clientArray(this.ctx,this.agora.user.get("sharedWithMe"),function(_this){return function(obj,onRemove,ctx){var inBelt,table,type,_ref;return inBelt=_this.clientValue(!1),_this.isInBelt(inBelt,obj),type=obj.get("object")==="/"?"Belt":(_ref=obj.get("object").split("."),table=_ref[0],_ref,table==="decisions"?"Decision":table==="belts"?"Belt":void 0),{title:obj.get("object")==="/"?ctx().clientValue("Belt"):ctx().clientValue(obj.field("title")),userName:obj.get("user_name"),seen:ctx().clientValue(obj.field("seen")),inBelt:inBelt,id:obj.get("id"),type:type}}}(this)),status:this.clientValue()},this.observeObject(this.agora.db.tables.shared_objects.records,function(_this){return function(){return _this.udpateEntries()}}(this))},SharedWithYouView.prototype.methods={seen:function(){return this.agora.user.get("sharedWithMe").each(function(_this){return function(instance){return instance.set("seen",!0)}}(this))},inBelt:function(view,id,inBelt){var ObjectReference,objectReference,objectReferences,rootElement,rootElements,sharedObject,_i,_len,_results;sharedObject=this.agora.db.tables.shared_objects.byId(id);if(inBelt)return objectReference=this.agora.modelManager.getModel("ObjectReference").create({object_user_id:sharedObject.get("user_id").substr(1),object:sharedObject.get("object")}),this.agora.modelManager.getModel("BeltElement").create({belt_id:this.agora.user.get("belts").get(0).get("id"),element_type:"ObjectReference",element_id:objectReference.get("id")});ObjectReference=this.agora.modelManager.getModel("ObjectReference"),objectReferences=ObjectReference.findAll({object_user_id:parseInt(sharedObject.get("user_id").substr(1)),object:sharedObject.get("object")}),_results=[];for(_i=0,_len=objectReferences.length;_i<_len;_i++)objectReference=objectReferences[_i],rootElements=this.agora.user.get("belts").get(0).get("elements").findAll({element_type:"ObjectReference",element_id:objectReference.get("id")}),_results.push(function(){var _j,_len1,_results1;_results1=[];for(_j=0,_len1=rootElements.length;_j<_len1;_j++)rootElement=rootElements[_j],_results1.push(rootElement["delete"]());return _results1}());return _results},click:function(view,id){var object,sharedObject,storeId;return sharedObject=this.agora.db.tables.shared_objects.byId(id),object=sharedObject.get("object"),storeId=sharedObject.get("user_id").substr(1),this.agora.updater.subscribe(storeId,"@",function(_this){return function(){return _this.agora.updater.subscribe(storeId,object,function(){var decision,parts,user;if(object==="/")return user=agora.modelManager.getInstance("User",sharedObject.get("user_id")),util.shoppingBar.pushRootState(user);parts=object.split(".");if(parts[0]==="decisions")return decision=_this.agora.modelManager.getInstance("Decision","G"+parts[1]),util.shoppingBar.pushDecisionState(decision);if(parts[0]==="belts")return decision=_this.agora.modelManager.getInstance("Belt","G"+parts[1]),util.shoppingBar.pushBeltState(decision)})}}(this))}},SharedWithYouView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShareView",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var ShareView;return ShareView=function(_super){__extends(ShareView,_super);function ShareView(){return ShareView.__super__.constructor.apply(this,arguments)}return ShareView.nextId=0,ShareView.id=function(args){return++this.nextId},ShareView.prototype.udpateEntries=function(){var entries;return entries=[],this.agora.db.tables.shared_objects.records.each(function(_this){return function(record){if(record.get("user_id")===_this.agora.user.get("id")&&record.get("object")===_this.object)return entries.push(_.extend(_.clone(record._values),{id:record.globalId()}))}}(this)),this.entries.set(entries)},ShareView.prototype.initAsync=function(args,done){var getObject,init;return getObject=function(_this){return function(tableName,id){var table,_ref,_ref1,_ref2;return table=_this.agora.db.table(tableName),id=(_ref=(_ref1=_this.agora.db.globalToLocalMapping)!=null?(_ref2=_ref1[tableName])!=null?_ref2[id]:void 0:void 0)!=null?_ref:id,table.byId(id)}}(this),init=function(_this){return function(){var belt,decision,id,message,table,title,_ref;return _this.entries=_this.clientValue(),title="",_this.object!=="/"&&(_ref=_this.object.split("."),table=_ref[0],id=_ref[1],table==="decisions"?(decision=getObject("decisions","G"+id),title=decision.get("share_title"),message=decision.get("share_message")):table==="belts"&&(belt=getObject("belts","G"+id),title=belt.get("title"),message="")),_this.udpateEntries(),_this.data={entries:_this.entries,status:_this.clientValue(),title:title,message:message},_this.observeObject(_this.agora.db.tables.shared_objects.records,function(){return _this.udpateEntries()}),done()}}(this),args&&args!=="ShoppingBar"?this.resolveObject(args,function(_this){return function(obj){var userId;return userId=null,_this.object=obj.isA("Decision")?"decisions."+obj.record.globalId().substr(1):obj.isA("Belt")?"belts."+obj.record.globalId().substr(1):obj.isA("ObjectReference")?obj.get("object"):void 0,init()}}(this)):(this.object=this.agora.View.views.ShoppingBar["null"].currentState().shareObject(),init())},ShareView.prototype.methods={update:function(view,title,message){var params;return params={object:this.object,title:title,message:message},this.agora.updater.transport.messageStream.sendMessage("message",this.agora.user.saneId(),"share/update",JSON.stringify(params))},add:function(view,title,message,email){var params;return tracking.event("Collaboration","add"),params={"with":email,object:this.object,title:title,message:message},this.agora.updater.transport.messageStream.sendMessage("message",this.agora.user.saneId(),"share/create",JSON.stringify(params))},"delete":function(view,id){var params;return tracking.event("Collaboration","remove"),params={id:id.substr(1)},this.agora.updater.transport.messageStream.sendMessage("message",this.agora.user.saneId(),"share/delete",JSON.stringify(params))}},ShareView}(View)}),define("views/ShoppingBarView/BarItem",["View","Site","Formatter","util","underscore"],function(View,Site,Formatter,util,_){var BarItem;return BarItem=function(){function BarItem(){}return BarItem.prototype.getData=function(cb){return cb(this.data)},BarItem.prototype.observe=function(object,observer){if(object)return this.ctx.observe(object,observer)},BarItem}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/BarItemView",["View","Site","Formatter","util","underscore","taxonomy","views/ItemView"],function(View,Site,Formatter,util,_,taxonomy,ItemView){var BarItemView;return BarItemView=function(_super){__extends(BarItemView,_super);function BarItemView(){return BarItemView.__super__.constructor.apply(this,arguments)}return BarItemView.nextId=1,BarItemView.id=function(args){var id;return args.container?"#c.{args.container.type}."+args.container.id+"."+args.type+"."+args.id:args.type&&args.id?""+args.type+"."+args.id:args.elementType&&args.elementId?(id=""+args.elementType+"."+args.elementId,args.decisionId&&(id+="."+args.decisionId),id):this.nextId++},BarItemView.prototype.itemClass=function(type){return"views/ShoppingBarView/"+type+"BarItem"},BarItemView}(ItemView)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/BarItemView1",["View","Site","Formatter","util","underscore","taxonomy"],function(View,Site,Formatter,util,_,taxonomy){var BarItemView;return BarItemView=function(_super){__extends(BarItemView,_super);function BarItemView(){return BarItemView.__super__.constructor.apply(this,arguments)}return BarItemView.nextId=1,BarItemView.id=function(args){var id;return args.container?"#c.{args.container.type}."+args.container.id+"."+args.type+"."+args.id:args.type&&args.id?""+args.type+"."+args.id:args.elementType&&args.elementId?(id=""+args.elementType+"."+args.elementId,args.decisionId&&(id+="."+args.decisionId),id):this.nextId++},BarItemView.prototype.dropped=function(obj,dropAction){var bundle,newObj;if(this.obj){if(obj.modelName==="Datum")return tracking.event("ShoppingBar","addData"),obj.set("element_type",this.obj.modelName),obj.set("element_id",this.obj.get("id"));if(obj.modelName==="Descriptor")return this.descriptor?(this.descriptor.set("descriptor",obj.get("descriptor")),obj["delete"]()):this.obj.modelName==="Decision"?(this.obj.get("list").set("descriptor",obj.get("descriptor")),obj["delete"]()):(obj.set("element_type",this.obj.modelName),obj.set("element_id",this.obj.get("id")),this.element.set("element_type",obj.modelName),this.element.set("element_id",obj.get("id")));newObj=null,dropAction==="createBundle"?(tracking.event("ShoppingBar","createBundle"),bundle=this.agora.modelManager.getModel("Bundle").create(),obj=util.resolveObject(obj),bundle.get("contents").add(this.obj),bundle.get("contents").add(obj),_activity("convert",this.element,this.obj,obj,bundle),newObj=bundle):this.descriptor&&this.obj.isNull()?(this.descriptor.set("element_type",obj.modelName),this.descriptor.set("element_id",obj.get("id"))):this.barItem.dropped&&(newObj=this.barItem.dropped(obj,dropAction));if(newObj){if(this.descriptor)return this.descriptor.set("element_type",newObj.modelName),this.descriptor.set("element_id",newObj.get("id"));if(this.element)return this.element.set("element_type",newObj.modelName),this.element.set("element_id",newObj.get("id"));if(this.slot)return this.slot.set("element_type",newObj.modelName),this.slot.set("element_id",newObj.get("id"))}}else if(this.barItemType)return this.barItem.dropped(obj,dropAction)},BarItemView.prototype.onClientDisconnect=function(){return this.destruct()},BarItemView.prototype.initAsync=function(args,done){var creatorId,selected,update,updateSelected,userWrapper;return this.data=this.clientValueNamed("BarItemView.data"),this.barItemCtx=this.context(),this.element=this.agora.modelManager.getModel(this.args.elementType).withId(this.args.elementId),this.additionalData={},update=function(_this){return function(cb){var object;return _this.descriptor&&_this.stopObservingObject(_this.descriptor.get("element")),delete _this.objectReference,delete _this.getObj,delete _this.descriptor,delete _this.barItemType,_this.obj=_this.element.get("element"),_this.obj.modelName==="Descriptor"?(_this.descriptor=_this.obj,_this.obj=_this.obj.get("element"),_this.observeObject(_this.descriptor.get("element"),update)):_this.obj.modelName==="ObjectReference"&&(_this.objectReference=_this.obj,_this.obj=null,_this.getObj=function(){return this.objectReference},object=_this.objectReference.get("object"),_this.additionalData.user={color:util.colorForUser(_this.agora.user,_this.objectReference.get("object_user_id"))},_this.agora.updater.transport.whenObject(_this.objectReference.get("object_user_id"),["@",object],function(){var id,table,_ref;delete _this.barItemType;if(object==="/")return _this.barItemType="SharedBelt",setTimeout(function(){return _this.updateBarItem()},200);_ref=object.split("."),table=_ref[0],id=_ref[1];if(table==="decisions")return _this.obj=_this.agora.modelManager.getInstance("Decision","G"+id),setTimeout(function(){return _this.updateBarItem()},200);if(table==="belts")return _this.obj=_this.agora.modelManager.getInstance("Belt","G"+id),setTimeout(function(){return _this.updateBarItem()},200)},function(){var id,table,_ref;return _this.obj=null,_this.barItemType="Unauthorized",object==="/"?_this.additionalData.objectType="Belt":(_ref=object.split("."),table=_ref[0],id=_ref[1],table==="decisions"?_this.additionalData.objectType="Decision":table==="belts"&&(_this.additionalData.objectType="Belt")),setTimeout(function(){return _this.updateBarItem()},200)})),_this.updateBarItem(cb)}}(this),this.element.get("creator_id")&&this.element.get("creator_id")!==this.agora.user.get("id")&&(creatorId=this.element.get("creator_id").substr(1),userWrapper=util.userWrapper(creatorId),this.additionalData.creator={color:util.colorForUser(this.agora.user,creatorId),name:this.clientValue(userWrapper.field("name"))}),this.element.modelName==="ListElement"&&args.decisionId&&(selected=this.clientValueNamed("selected"),_.merge(this.additionalData,{selected:selected,decisionId:args.decisionId}),this.decision=this.agora.modelManager.getInstance("Decision",args.decisionId),updateSelected=function(_this){return function(){return selected.set(_this.decision.get("selection").contains(_this.element))}}(this),updateSelected(),this.decision.get("selection").observe(updateSelected)),this.observeObject(this.element.get("element"),update),update(done)},BarItemView.prototype.updateBarItem=function(cb){return cb==null&&(cb=null),this.initBarItem(function(_this){return function(){var data,_ref,_ref1;return _this.obj?_this.descriptor&&_this.obj.isNull()?(data={descriptor:_this.descriptor.get("descriptor"),icon:taxonomy.icon((_ref=_this.descriptor.get("descriptor"))!=null?(_ref1=_ref.product)!=null?_ref1.type:void 0:void 0)},_this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0):_this.barItem.getData(function(data){return _this.descriptor&&(data.descriptor=_this.descriptor.get("descriptor")),data.id=_this.obj.get("id"),_this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0}):_this.barItemType?_this.barItem.getData(function(data){return _this.additionalData&&_.extend(data,_this.additionalData),_this.data.set(data),typeof cb=="function"?cb():void 0}):(_this.data.set(null),typeof cb=="function"?cb():void 0)}}(this))},BarItemView.prototype.initBarItem=function(cb){var type,_ref;return this.barItemCtx.clear(),this.obj||this.barItemType?this.descriptor&&(!this.obj||this.obj.isNull())?(delete this.barItem,cb()):(type=(_ref=this.barItemType)!=null?_ref:this.obj.model.name==="ProductVariant"?"Product":this.obj.model.name,this.getBarItem(type,this.obj,function(_this){return function(barItem){return _this.barItem=barItem,cb()}}(this))):cb()},BarItemView.prototype.getBarItem=function(type,obj,cb){return this.agora.background.require(["views/ShoppingBarView/"+type+"BarItem"],function(_this){return function(klass){var barItem;return barItem=new klass,barItem.barItemView=_this,barItem.obj=obj,barItem.ctx=_this.barItemCtx,typeof barItem.init=="function"&&barItem.init(),barItem.initAsync?barItem.initAsync(function(){return cb(barItem)}):cb(barItem)}}(this))},BarItemView.prototype.hasMethod=function(name){var _ref,_ref1;return this.methods[name]||((_ref=this.barItem)!=null?(_ref1=_ref.methods)!=null?_ref1[name]:void 0:void 0)},BarItemView.prototype.method=function(name){return this.methods[name]?this.methods[name]:this.barItem.methods[name]},BarItemView.prototype["delete"]=function(){var obj,_ref;if(this.slot)return this.slot.set("element_type",null),this.slot.set("element_id",null);_activity("remove",this.element,this.element.get("element")),obj=this.element.get("element"),this.element["delete"]();if((_ref=obj.modelName)==="ObjectReference")return obj["delete"]()},BarItemView.prototype.methods={"delete":function(){return this["delete"]()},click:function(view){var _ref,_ref1,_ref2;return(_ref=this.barItem)!=null?(_ref1=_ref.methods)!=null?(_ref2=_ref1.click)!=null?_ref2.call(this.barItem,view):void 0:void 0:void 0},reorder:function(view,fromIndex,toIndex){return util.reorder(this.obj.get("contents"),fromIndex,toIndex)},add:function(view,type){var composite;return composite=this.agora.modelManager.getModel("Composite").createWithType(type),this.obj.get("contents").add(composite)},setSelected:function(view,selected){if(this.decision)return selected?(this.decision.get("selection").add(this.element),_activity("decision.select",this.decision,this.element.get("element"))):(this.decision.get("selection").remove(this.element),_activity("decision.deselect",this.decision,this.element.get("element")))}},BarItemView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/BeltBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var BeltBarItem;return BeltBarItem=function(_super){__extends(BeltBarItem,_super);function BeltBarItem(){return BeltBarItem.__super__.constructor.apply(this,arguments)}return BeltBarItem.prototype.init=function(){var count,updateCount;return count=this.itemView.clientValue(),updateCount=function(_this){return function(){return count.set(_this.obj.get("elements").length())}}(this),this.observe(this.obj.get("elements"),updateCount),updateCount(),this.data={type:"Belt",barItemData:{shared:this.ctx.clientValue(this.obj.field("shared")),preview:util.listPreview(this.ctx,this.obj.get("elements")),count:count}}},BeltBarItem.prototype.dropped=function(obj){return obj=util.resolveObject(obj),this.obj.get("contents").add(obj),_activity("add",this.obj,obj)},BeltBarItem.prototype.methods={click:function(){return util.shoppingBar.pushBeltState(this.obj)}},BeltBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/ListBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var ListBarItem;return ListBarItem=function(_super){__extends(ListBarItem,_super);function ListBarItem(){return ListBarItem.__super__.constructor.apply(this,arguments)}return ListBarItem.prototype.type="List",ListBarItem.prototype.init=function(){var itemData,updateData,_ref;return this.contentsCtx=this.ctx.context(),itemData=(_ref=typeof this.itemData==="function"?this.itemData():void 0)!=null?_ref:{},itemData.state=this.itemView.clientValue(),updateData=function(_this){return function(){var data;return data=_this.obj.get("collapsed")?{state:"collapsed",contents:_this.collapsedContents()}:{state:"expanded",contents:_this.expandedContents()},itemData.state.set(data)}}(this),updateData(),this.data={type:this.type,barItemData:itemData},this.observe(this.obj.field("collapsed"),function(_this){return function(){return _this.contentsCtx.clear(),updateData()}}(this))},ListBarItem.prototype.dropped=function(obj){return util.addElement(this.obj,obj),null},ListBarItem.prototype.ripped=function(view){return view.element["delete"]()},ListBarItem.prototype.expandedContents=function(){var contents;return contents=this.itemView.clientArrayNamed(""+this.obj.modelName+".contents"),util.syncArrays(this.contentsCtx,this.obj.get("elements"),contents,function(_this){return function(element,onRemove,i){return{elementType:element.modelName,elementId:element.get("id")}}}(this)),contents},ListBarItem.prototype.collapsedContents=function(){var clientContents,getContents,reset;return getContents=function(_this){return function(){var contents,ctx,obj,sources,stack,state;stack=[{list:_this.obj.get("elements"),pos:0}],contents=[],sources=[_this.obj.get("elements")];while(stack.length&&contents.length<4){state=stack[stack.length-1];if(state.list.length()===state.pos){stack.pop();continue}obj=state.list.get(state.pos++).get("element");for(;;){obj.modelName==="Product"?(contents.push(obj.get("image")),sources.push(obj.field("image"))):obj.modelName==="Decision"?(stack.push({list:obj.get("selection"),pos:0}),sources.push(obj.get("selection"))):obj.modelName==="Bundle"&&(stack.push({list:obj.get("elements"),pos:0}),sources.push(obj.get("elements")));break}}return ctx=_this.itemView.context(),[contents,sources]}}(this),clientContents=this.itemView.clientArrayNamed(""+this.obj.modelName+".contents"),reset=function(_this){return function(){var contents,source,sources,_i,_len,_ref;_this.contentsCtx.clear(),_ref=getContents(),contents=_ref[0],sources=_ref[1];for(_i=0,_len=sources.length;_i<_len;_i++)source=sources[_i],_this.contentsCtx.observe(source,function(mutation){return reset()});return clientContents.setArray(contents)}}(this),reset(),clientContents},ListBarItem.prototype.methods={toggle:function(view){return this.obj.get("collapsed")?this.obj.set("collapsed",!1):this.obj.set("collapsed",!0)},click:function(){return shoppingBarView.pushState({dropped:function(_this){return function(obj){return util.addElement(_this.obj,obj)}}(this),ripped:function(_this){return function(view){return view.element["delete"]()}}(this),contents:function(_this){return function(){return _this.obj.get("elements")}}(this),contentMap:function(_this){return function(el){return{elementType:"ListElement",elementId:el.get("id")}}}(this)})}},ListBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/BundleBarItem",["View","Site","Formatter","util","underscore","./ListBarItem"],function(View,Site,Formatter,util,_,ListBarItem){var BundleBarItem;return BundleBarItem=function(_super){__extends(BundleBarItem,_super);function BundleBarItem(){return BundleBarItem.__super__.constructor.apply(this,arguments)}return BundleBarItem.prototype.type="Bundle",BundleBarItem}(ListBarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/CompositeBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var CompositeBarItem;return CompositeBarItem=function(_super){__extends(CompositeBarItem,_super);function CompositeBarItem(){return CompositeBarItem.__super__.constructor.apply(this,arguments)}return CompositeBarItem.prototype.init=function(){var composite;return composite=this.obj,this.data={type:"Composite",barItemData:{type:composite.get("type")}}},CompositeBarItem.prototype.dropped=function(obj){return obj=util.resolveObject(obj),this.obj.get("additionalContents").add(obj),null},CompositeBarItem.prototype.methods={click:function(){return shoppingBarView.pushState({dropped:function(_this){return function(obj){return obj=util.resolveObject(obj),_this.obj.get("additionalContents").add(obj)}}(this),ripped:function(_this){return function(view){return _this.obj.get("additionalElements").remove(view.element)}}(this),contents:function(_this){return function(){return _this.obj.get("contents")}}(this),contentMap:function(el){return el.modelName==="CompositeSlot"?{type:"CompositeSlot",id:el.get("id")}:{elementType:"CompositeElement",elementId:el.get("id")}}})}},CompositeBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/CompositeSlotBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var CompositeSlotBarItem;return CompositeSlotBarItem=function(_super){__extends(CompositeSlotBarItem,_super);function CompositeSlotBarItem(){return CompositeSlotBarItem.__super__.constructor.apply(this,arguments)}return CompositeSlotBarItem.id=function(args){return args.id},CompositeSlotBarItem.prototype.init=function(id){var slot;return slot=this.obj,this.data={type:"CompositeSlot",barItemData:{type:slot.get("type"),id:this.obj.get("id"),elementType:this.ctx.clientValue(slot.field("element_type")),elementId:this.ctx.clientValue(slot.field("element_id"))}}},CompositeSlotBarItem.prototype.dropped=function(element){var obj;return obj=util.resolveObject(element),this.obj.set("element_type",obj.modelName),this.obj.set("element_id",obj.get("id")),null},CompositeSlotBarItem.prototype.ripped=function(element){return this.obj.set("element_type",null),this.obj.set("element_id",null)},CompositeSlotBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/DecisionBarItem",["View","Site","Formatter","util","underscore","views/items/DecisionItem","taxonomy"],function(View,Site,Formatter,util,_,DecisionItem,taxonomy){var DecisionBarItem;return DecisionBarItem=function(_super){__extends(DecisionBarItem,_super);function DecisionBarItem(){return DecisionBarItem.__super__.constructor.apply(this,arguments)}return DecisionBarItem.prototype.onClick=function(){return util.shoppingBar.pushDecisionState(this.obj)},DecisionBarItem}(DecisionItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/ProductBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var ProductBarItem;return ProductBarItem=function(_super){__extends(ProductBarItem,_super);function ProductBarItem(){return ProductBarItem.__super__.constructor.apply(this,arguments)}return ProductBarItem.prototype.init=function(){var product;return product=this.obj,this.data={type:"Product",barItemData:{id:product.get("id"),title:this.ctx.clientValueNamed("ProductBarItem.title",product.field("title"),product.displayValue("title")),site:{name:product.get("siteName"),url:product.get("siteUrl")},price:this.ctx.clientValueNamed("ProductBarItem.price",product.field("price"),product.displayValue("price")),image:this.ctx.clientValueNamed("ProductBarItem.image",product.field("image"),product.displayValue("image")),url:product.get("url"),sid:product.get("productSid"),lastFeeling:util.lastFeeling(this.ctx,product),status:this.ctx.clientValue(product.field("status")),purchased:this.ctx.clientValue(product.field("purchased"))}}},ProductBarItem.prototype.dropped=function(obj){var decision,list;return tracking.event("ShoppingBar","createDecision"),obj=util.resolveObject(obj),list=this.itemView.agora.modelManager.getModel("List").create(),list.get("contents").add(this.obj),list.get("contents").add(obj),this.itemView.descriptor&&list.set("descriptor",this.itemView.descriptor.get("descriptor")),decision=this.itemView.agora.modelManager.getModel("Decision").create({list_id:list.get("id")}),_activity("convert",this.itemView.element,this.obj,obj,decision),decision},ProductBarItem.prototype.methods={click:function(){}},ProductBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/SessionBarItem",["View","Site","Formatter","util","underscore","./ListBarItem"],function(View,Site,Formatter,util,_,ListBarItem){var SessionBarItem;return SessionBarItem=function(_super){__extends(SessionBarItem,_super);function SessionBarItem(){return SessionBarItem.__super__.constructor.apply(this,arguments)}return SessionBarItem.prototype.type="Session",SessionBarItem.prototype.itemData=function(){return{title:this.itemView.clientValue(this.obj.field("title"))}},SessionBarItem.prototype.methods={setTitle:function(view,title){return this.obj.set("title",title)},toggle:function(view){return this.obj.get("collapsed")?this.obj.set("collapsed",!1):this.obj.set("collapsed",!0)}},SessionBarItem}(ListBarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/SharedBeltBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var SharedBeltBarItem;return SharedBeltBarItem=function(_super){__extends(SharedBeltBarItem,_super);function SharedBeltBarItem(){return SharedBeltBarItem.__super__.constructor.apply(this,arguments)}return SharedBeltBarItem.prototype.init=function(){var userId;return userId=this.itemView.objectReference.get("object_user_id"),this.user=this.itemView.agora.modelManager.getInstance("User","G"+userId),this.data={type:"SharedBelt",barItemData:{preview:util.listPreview(this.ctx,this.user.get("rootElements"))}}},SharedBeltBarItem.prototype.dropped=function(obj){var rootEl;return obj=util.resolveObject(obj),rootEl=this.itemView.agora.modelManager.getModel("RootElement").create({user_id:this.user.get("id"),element_type:obj.modelName,element_id:obj.get("id")}),_activity("add",this.user,obj)},SharedBeltBarItem.prototype.methods={click:function(){return util.shoppingBar.pushRootState(this.user)}},SharedBeltBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView/UnauthorizedBarItem",["View","Site","Formatter","util","underscore","./BarItem"],function(View,Site,Formatter,util,_,BarItem){var UnauthorizedBarItem;return UnauthorizedBarItem=function(_super){__extends(UnauthorizedBarItem,_super);function UnauthorizedBarItem(){return UnauthorizedBarItem.__super__.constructor.apply(this,arguments)}return UnauthorizedBarItem.prototype.init=function(){return this.data={type:"Unauthorized",barItemData:{}}},UnauthorizedBarItem}(BarItem)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/ShoppingBarView",["View","Site","Formatter","util","underscore","model/ObservableValue"],function(View,Site,Formatter,util,_,ObservableValue){var ShoppingBarView;return ShoppingBarView=function(_super){__extends(ShoppingBarView,_super);function ShoppingBarView(){window.shoppingBarView=this,ShoppingBarView.__super__.constructor.apply(this,arguments)}return ShoppingBarView.prototype.setUser=function(user){this.unseenSharedObjectsCount&&this.unseenSharedObjectsCount.destruct(),this.user=user;if(user)return this.unseenSharedObjectsCount=this.clientValue(this.agora.user.get("unseenSharedWithMe").length()),this.agora.user.get("unseenSharedWithMe").observe(function(_this){return function(mutation){return _this.unseenSharedObjectsCount.set(mutation.length)}}(this)),this.clearState(),util.shoppingBar.pushRootState(this.user)},ShoppingBarView.prototype.init=function(){return this.shareObject=new ObservableValue,this.path=[],this.ctx=this.context(),this.data={},this.updaterStatus=this.clientValue(this.agora.updater.status),this.updaterMessage=this.clientValue(this.agora.updater.message),this.barContentsData=this.clientValue(),this.isShared=this.ctx.clientValue(this.shareObject,function(value){return value&&value.isShared}),this.setUser(this.agora.user),this.data={updaterStatus:this.updaterStatus,updaterMessage:this.updaterMessage,barContents:this.barContentsData,unseenSharedObjectsCount:this.unseenSharedObjectsCount}},ShoppingBarView.prototype.currentState=function(){return this.path[this.path.length-1]},ShoppingBarView.prototype.updateShareObject=function(){var i,isShared,object,shareObject,_i,_ref;object=null;for(i=_i=_ref=this.path.length-1;_ref<=0?_i<=0:_i>=0;i=_ref<=0?++_i:--_i)if(this.path[i].isShared()){object=this.path[i].shareObject();break}isShared=null,object?isShared=!0:(isShared=!1,object=this.currentState().shareObject()),shareObject={isShared:isShared,object:object};if(!_.isEqual(this.shareObject.get(),shareObject))return this.shareObject.set(shareObject)},ShoppingBarView.prototype.initState=function(state){var clientContents,_ref,_ref1;return this.stateCtx&&this.stateCtx.destruct(),this.stateCtx=this.ctx.context(),clientContents=this.clientArray(this.stateCtx,state.contents(),state.contentMap),this.updateShareObject(),this.displaying&&util.unsync(this.displaying),this.displaying=clientContents,this.barContentsData.set({moveUp:(_ref=state.moveUp)!=null?_ref:this.path.length>1,contents:clientContents,state:state.state,args:state.args,direction:(_ref1=state.direction)!=null?_ref1:"ltr",shared:this.isShared})},ShoppingBarView.prototype.pushState=function(state){return!state.state&&this.state&&(state.state=this.state),state.shared().observeWithTag(state,function(_this){return function(){return _this.updateShareObject()}}(this)),this.path.push(state),this.initState(state)},ShoppingBarView.prototype.popState=function(){return this.currentState().shared().stopObservingWithTag(this.currentState()),this.path.pop(),this.initState(this.currentState())},ShoppingBarView.prototype.clearState=function(){return this.path=[]},ShoppingBarView.prototype.ripped=function(data){return this.currentState().ripped(data)},ShoppingBarView.prototype.dropped=function(data){return this.currentState().dropped(data)},ShoppingBarView.prototype.methods={up:function(view){return this.popState()},move:function(view,elementData,toData,dropAction){var elementView,toView;return elementView=this.agora.View.clientViews[elementData.view].view,elementView["delete"](),toData==="up"?this.path[this.path.length-2].dropped(elementView,dropAction):(toView=this.agora.View.clientViews[toData.view].view,toView.dropped(elementView,dropAction))},drop:function(view,elementData,onData,dropAction){return onData==="up"?this.resolveElements(elementData,function(_this){return function(element){_this.path[_this.path.length-2].dropped(element,dropAction);if(element.isA("Product")||element.isA("ProductVariant"))return view.callMethod("productAdded",[{modelName:element.modelName,instanceId:element.get("id")}])}}(this)):this.resolveElements(elementData,onData,function(_this){return function(element,onView){onView.dropped(element,dropAction);if(element.isA("Product")||element.isA("ProductVariant"))return view.callMethod("productAdded",[{modelName:element.modelName,instanceId:element.get("id")}])}}(this))},reorder:function(view,fromIndex,toIndex){return util.reorder(this.currentState().contents(),fromIndex,toIndex)},remove:function(view,elementData,fromData){var elementView,fromView;return fromView=this.agora.View.clientViews[fromData.view].view,elementView=this.agora.View.clientViews[elementData.view].view,fromView.ripped(elementView)},web:function(){var obj;return obj=this.agora.modelManager.instance("Decision",this.currentState().args.decisionId),chrome.tabs.create({url:"http://agora.sh/Agora/webapp.php?decisionId="+obj.record.globalId()})},wrap:function(view,type,selection){var cont,element,obj,parent,viewId,_i,_len;cont=obj=null,type==="decision"?(cont=this.agora.modelManager.getModel("List").create(),obj=this.agora.modelManager.getModel("Decision").create({list_id:cont.get("id")})):obj=cont=function(){switch(type){case"bundle":return this.agora.modelManager.getModel("Bundle").create();case"session":return this.agora.modelManager.getModel("Session").create({title:"New Session"})}}.call(this),parent=type==="session"?null:!1;for(_i=0,_len=selection.length;_i<_len;_i++){viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,cont.get("contents").add(view.obj),element=view.element;if(parent===!1||parent!==null)element.modelName==="RootElement"?parent=null:parent?element.get("parent").equals(parent)||(parent=null):parent=element.get("parent");view.element["delete"]()}return parent===null?this.dropped(obj):parent.get("contents").add(obj)},"delete":function(view,selection){var viewId,_i,_len,_results;_results=[];for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],_results.push(this.agora.View.clientViews[viewId].view.element["delete"]());return _results},extract:function(view,selection){var viewId,_i,_len,_results;if(this.path.length>1){_results=[];for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,this.path[this.path.length-2].dropped(view.obj),_results.push(view.element["delete"]());return _results}},split:function(view,selection){var cont,decision,viewId,_i,_len;if(this.path.length>1){cont=this.agora.modelManager.getModel("List").create(),decision=this.agora.modelManager.getModel("Decision").create({list_id:cont.get("id")});for(_i=0,_len=selection.length;_i<_len;_i++)viewId=selection[_i],view=this.agora.View.clientViews[viewId].view,cont.get("contents").add(view.obj),view.element["delete"]();return this.path[this.path.length-2].dropped(decision)}}},ShoppingBarView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/SocialShareView",["View"],function(View){var SocialShareView;return SocialShareView=function(_super){__extends(SocialShareView,_super);function SocialShareView(){return SocialShareView.__super__.constructor.apply(this,arguments)}return SocialShareView.nextId=1,SocialShareView.id=function(){return this.nextId++},SocialShareView.prototype.init=function(args){var view;return args.id?this.decision=this.agora.modelManager.getInstance("Decision",args.id):args.viewId&&(view=this.agora.View.clientViews[args.viewId].view,view.name==="compare/Compare"&&(this.decision=view.currentDecision())),this.data={access:this.clientValue(this.decision.field("access")),url:this.agora["public"].route(this.decision),owner:this.decision.record.storeId===this.agora.user.saneId()}},SocialShareView.prototype.methods={setAccess:function(view,access){return this.decision.set("access",access)}},SocialShareView}(View)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("views/WebAppView",["View"],function(View){var WebAppView;return WebAppView=function(_super){__extends(WebAppView,_super);function WebAppView(){return WebAppView.__super__.constructor.apply(this,arguments)}return WebAppView.id=function(args){return args},WebAppView.prototype.initAsync=function(args,done){var parts,path;return this.data={},args?(path=args,parts=path.split("/"),parts[0]==="decisions"?this.agora["public"].get("decisions",parts[1],function(_this){return function(success,id){return success?_this.data.decisionId="G"+id:_this.data.accessDenied=!0,done()}}(this)):done()):done()},WebAppView}(View)}),define("scraping/SiteProduct",["taxonomy","util","underscore"],function(taxonomy,util,_){var SiteProduct;return SiteProduct=function(){function SiteProduct(product){this.product=product}return SiteProduct.prototype.properties=function(properties,cb){},SiteProduct.prototype.usedProperties=function(type,cb){var count,properties,property,usedProperties,_i,_len,_results;properties=taxonomy.properties(type),count=properties.length;if(count){usedProperties=[],_results=[];for(_i=0,_len=properties.length;_i<_len;_i++)property=properties[_i],_results.push(function(_this){return function(property){return _this.property(property,function(value){value!==void 0&&usedProperties.push(property);if(!--count)return cb(usedProperties)})}}(this)(property));return _results}return cb([])},SiteProduct.prototype.property=function(path,cb){var func,parts,_ref,_ref1;return parts=path.split("."),func=(_ref=this.types)!=null?(_ref1=_ref[parts[0]])!=null?_ref1[parts[1]]:void 0:void 0,func?func.call(this,cb):cb()},SiteProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(reviews){return cb({reviews:reviews!=null?reviews:[]})})},SiteProduct.prototype.genWidgets=function(obj,widgetDefs){var dataType,name,o,parts,prop,type,value,widget,widgetDef,widgets,_ref;widgets=[];for(prop in widgetDefs){widgetDef=widgetDefs[prop],value=function(){var _i,_len;if(widgetDef.obj)return widgetDef.obj;parts=prop.split("."),o=obj;for(_i=0,_len=parts.length;_i<_len;_i++)name=parts[_i],o=o[name];return o}();if(value==null)continue;dataType=_.isString(value)?"string":_.isArray(value)?"array":_.isPlainObject(value)?"object":void 0,type=function(){if(prop==="reviews")return"Reviews";switch(dataType){case"string":return"html";case"array":return"List";case"object":return"Details"}}();if(type==="Reviews"&&value.length===0)continue;_.isString(widgetDef)&&(widgetDef={title:widgetDef,type:type}),widget={type:(_ref=widgetDef.type)!=null?_ref:type,data:{title:widgetDef.title}},widget.type==="html"?(widgetDef.stripHtml==null&&(widgetDef.stripHtml=!0),widget.data.maxHeight=widgetDef.maxHeight!=null?widgetDef.maxHeight:"none"):widget.type==="Reviews"&&(widgetDef.maxHeight!=null&&(widget.data.maxHeight=widgetDef.maxHeight),widgetDef.count!=null&&(widget.data.count=widgetDef.count)),widget.type==="html"&&widgetDef.stripHtml?widget.data.content=util.stripHtml(value,null,this.baseUrl):(widget.type==="Reviews"?value=_.map(value,function(_this){return function(review){var mapping,newReview,p,_ref1;newReview=_.clone(review),newReview.url=util.url(newReview.url);if(widgetDef.map){_ref1=widgetDef.map;for(p in _ref1)mapping=_ref1[p],_.isFunction(mapping)?newReview[p]=mapping(review):newReview[p]=review[mapping]}return newReview.review=util.stripHtml(newReview.review,null,_this.baseUrl),newReview}}(this)):(widget.type==="List"&&(value=_.map(value,function(_this){return function(v){return util.stripHtml(v,null,_this.baseUrl)}}(this))),widgetDef.map&&(dataType==="array"?value=_.map(value,widgetDef.map):dataType==="string"&&(_.isString(widgetDef.map)?value=value[widgetDef.map]:value=widgetDef.map(value)))),widget.data.content=value),widgets.push(widget)}return widgets},SiteProduct}()}),define("ext/AmazonProductWidgets",["util"],function(util){return function(cb){return this.product["with"]("more",function(_this){return function(more){var description,quote,quotes,review,reviews,tags,widgets,_i,_j,_len,_len1,_ref,_ref1,_ref10,_ref11,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;widgets=[],more.description&&(tags=["h1","h2","h3","h4","p","small","b","small","a","br","em"],description=util.stripHtml(more.description),widgets.push({type:"html",data:{title:"Description",content:description}})),more.features&&more.features.length&&widgets.push({type:"AmazonFeatures",data:more.features}),more.sizes&&more.sizes.length&&widgets.push({type:"AmazonSizes",data:{sizes:more.sizes,howItFits:more.howItFits}});if((_ref=more.reviews)!=null?(_ref1=_ref.mostHelpful)!=null?_ref1[0]:void 0:void 0)review=more!=null?(_ref2=more.reviews)!=null?(_ref3=_ref2.mostHelpful)!=null?_ref3[0]:void 0:void 0:void 0,widgets.push({type:"AmazonMostHelpfulReview",data:{rating:review.rating,author:review.author,review:util.stripHtml(review.review),title:review.title,url:util.url(review.url)}});if((_ref4=more.reviews)!=null?(_ref5=_ref4.quotes)!=null?_ref5.length:void 0:void 0){quotes=[],_ref7=(_ref6=more.reviews)!=null?_ref6.quotes:void 0;for(_i=0,_len=_ref7.length;_i<_len;_i++)quote=_ref7[_i],quotes.push({author:quote.author,quote:util.stripHtml(quote.quote),url:util.url(quote.url)});widgets.push({type:"AmazonQuotes",data:quotes})}if((_ref8=more.reviews)!=null?(_ref9=_ref8.mostRecent)!=null?_ref9.length:void 0:void 0){reviews=[],_ref11=(_ref10=more.reviews)!=null?_ref10.mostRecent:void 0;for(_j=0,_len1=_ref11.length;_j<_len1;_j++)review=_ref11[_j],reviews.push({rating:review.rating,title:review.title,author:review.author,review:util.stripHtml(review.review),url:util.url(review.url)});widgets.push({type:"AmazonMostRecentReviews",data:reviews})}return more.details&&widgets.push({type:"AmazonDetails",data:more.details}),cb(widgets)}}(this))}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Amazon/AmazonProduct",["scraping/SiteProduct","ext/AmazonProductWidgets"],function(SiteProduct,AmazonProductWidgets){var AmazonProduct;return AmazonProduct=function(_super){__extends(AmazonProduct,_super);function AmazonProduct(){return AmazonProduct.__super__.constructor.apply(this,arguments)}return AmazonProduct.prototype.matchFeature=function(cb,predicate){return this.product["with"]("more",function(_this){return function(more){var feature,value,_i,_len,_ref;if(more.features){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i],value=predicate(feature);if(value){cb(value);return}}}return cb()}}(this))},AmazonProduct.prototype.widgets=AmazonProductWidgets,AmazonProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_i,_len,_ref,_ref1;images={},_ref=more.images;for(color in _ref){colorImages=_ref[color],images[color]=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],images[color].push({small:image.large.match("^(.*?).jpg$")[1]+"._SL100_.jpg",medium:image.large,large:(_ref1=image.hiRes)!=null?_ref1:image.large,larger:image.hiRes?image.hiRes.replace(/(\.[^.]*)(\.jpg)$/,"._SL1000_$2"):image.large,full:image.hiRes?image.hiRes.replace(/(\.[^.]*)(\.jpg)$/,"$2"):image.large})}return cb(images,more.currentStyle)}}(this))},AmazonProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",cb)},AmazonProduct.prototype.type=function(cb){var map;return map={"Nursing & Maternity Bras":"brassiere"},this.product["with"]("more",function(_this){return function(more){return cb(map[more.category[more.category.length-1]])}}(this))},AmazonProduct.prototype.types={garment:{"Wash Instructions":function(cb){return this.product["with"]("more",function(_this){return function(more){var feature,_i,_len,_ref;if(more.features){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i];if(feature.toLowerCase().match("wash")||feature.toLowerCase().match("dry clean")){cb(feature);return}}}return cb(void 0)}}(this))},Origin:function(cb){return this.product["with"]("more",function(_this){return function(more){var feature,_i,_len,_ref,_ref1;if(more.features){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i];if(feature.toLowerCase().match("china|made in|imported")){cb(feature);return}}}return cb((_ref1=more.details)!=null?_ref1.Origin:void 0)}}(this))},Materials:function(cb){return this.product["with"]("more",function(_this){return function(more){var highest,highestIndex,i,item,matches,materialSample,_i,_len,_ref;materialSample="polyester|cotton|polyamide|elastane|nylon|spandex|rayon|Lycra&reg;|spandex|viscose|recycled|polyester|linen|Tactel&reg;|nylon|acrylic|down|feather|polyurethane|cashmere|corduroy|denim|angora|wool|satin|taffeta|leather|twill|acetate|lycra|lyocell|tweed|canvas|ripstop|sheepskin|silk|velvet|chiffon|jersey|suede|velour|vinyl|tricot|fleece|modal|microfiber|mesh",highest=0,highestIndex=-1;if(more.features){_ref=more.features;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)item=_ref[i],matches=item.toLowerCase().match(materialSample,"g"),matches&&matches.length>highest&&(highestIndex=i,highest=matches.index);return highestIndex!==-1?cb(more.features[highestIndex]):cb(void 0)}return cb(void 0)}}(this))}},trousers:{Closure:function(cb){return this.product["with"]("more",function(_this){return function(more){var feature,_i,_len,_ref;if(more.features){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i];if(feature.toLowerCase().match("closure")){cb(feature);return}}}return cb()}}(this))}},brassiere:{Closure:function(cb){return this.product["with"]("more",function(_this){return function(more){var feature,_i,_len,_ref;if(more.feature){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i];if(feature.toLowerCase().match("closure")){cb(feature);return}}}return cb()}}(this))},Straps:function(cb){return this.product["with"]("more",function(_this){return function(more){var feature,_i,_len,_ref;if(more.features){_ref=more.features;for(_i=0,_len=_ref.length;_i<_len;_i++){feature=_ref[_i];if(feature.toLowerCase().match("straps")){cb(feature);return}}}return cb()}}(this))}},"video card":{"Core Clock":function(cb){return this.matchFeature(cb,function(feature){var _ref;return(_ref=feature.match(/^Core Clock: (.*)$/))!=null?_ref[1]:void 0})},"Boost Clock":function(cb){return this.matchFeature(cb,function(feature){var _ref;return(_ref=feature.match(/^Boost Clock: (.*)$/))!=null?_ref[1]:void 0})},GPU:function(cb){return this.matchFeature(cb,function(feature){var _ref;return(_ref=feature.match(/^Chipset: (.*)$/))!=null?_ref[1]:void 0})},Interface:function(cb){return this.matchFeature(cb,function(feature){if(feature.toLowerCase().match("pci express"))return feature})}}},AmazonProduct}(SiteProduct)}),define("scraping/PropertyScraper",["underscore"],function(_){var PropertyScraper;return PropertyScraper=function(){function PropertyScraper(productSid,site,args){var scraper,scraperConst,_i,_len;this.productSid=productSid,this.site=site;if(_.isArray(args)){this.scrapers=[];for(_i=0,_len=args.length;_i<_len;_i++)scraperConst=args[_i],scraper=function(func,args,ctor){ctor.prototype=func.prototype;var child=new ctor,result=func.apply(child,args);return Object(result)===result?result:child}(scraperConst["const"],scraperConst.args,function(){}),scraperConst.config&&scraper.config(scraperConst.config),scraper.scraper.propertyScraper=this,scraper.productSid=this.productSid,scraper.site=this.site,this.scrapers.push(scraper)}else this.resource=args.resource,scraperConst=args.scraper,this.formatter=args.formatter,this.scraper=function(func,args,ctor){ctor.prototype=func.prototype;var child=new ctor,result=func.apply(child,args);return Object(result)===result?result:child}(scraperConst["const"],scraperConst.args,function(){}),scraperConst.config&&this.scraper.config(scraperConst.config),this.scraper.propertyScraper=this,this.scraper.productSid=this.productSid,this.scraper.site=this.site}return PropertyScraper.prototype.scrape=function(cb){var doScrape,resourceFetcher;return this.scrapers?(doScrape=function(_this){return function(i){var resourceFetcher,scraper;return scraper=_this.scrapers[i],resourceFetcher=_this.productScraper.resource(scraper.resource),resourceFetcher.fetch(function(resource){var e;scraper.scraper.pushResource(resource);try{return scraper.scraper.scrape(function(value){return _this.value=value,scraper.formatter&&(value=scraper.formatter()),cb(value)})}catch(_error){return e=_error,i===_this.scrapers.length-1?(e.message+=" ("+_this.site.name+" "+_this.productSid+" "+_this.propertyName+")",_this.background.error("ScrapeError",_this.site.name,_this.productSid.toString(),_this.propertyName,e),cb(null,!0)):doScrape(i+1)}})}}(this),doScrape(0)):(resourceFetcher=this.productScraper.resource(this.resource),resourceFetcher.fetch(function(_this){return function(resource){var e;_this.scraper.pushResource(resource);try{return _this.scraper.scrape(function(value){return _this.value=value,_this.formatter&&(value=_this.formatter()),cb(value)})}catch(_error){return e=_error,e.message+=" ("+_this.site.name+" "+_this.productSid+" "+_this.propertyName+")",_this.background.error("ScrapeError",_this.site.name,_this.productSid.toString(),_this.propertyName,e),cb(null,!0)}}}(this)))},PropertyScraper}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/Resource",["underscore"],function(_){var Resource;return Resource=function(_super){__extends(Resource,_super);function Resource(value,url){this.value=value,this.url=url,String.call(this,this.value)}return Resource.prototype.safeMatch=function(pattern){var matches;matches=this.match(pattern);if(matches)return matches;throw new Error(""+pattern+" not found in "+this.url)},Resource.prototype.matchAll=function(pattern,group){var globalMatches,i,matches,r,regExp;pattern instanceof RegExp&&(pattern=pattern.source),r=[],globalMatches=this.match(new RegExp(pattern,"g"));if(globalMatches){regExp=new RegExp(pattern),i=0;while(i<globalMatches.length)matches=globalMatches[i].match(regExp),typeof group=="undefined"?r.push(matches):r.push(matches[group]),++i}return r},Resource.prototype.valueOf=function(){return this.value},Resource.prototype.toString=function(){return this.value},Resource.prototype.substr=function(){return new Resource(Resource.__super__.substr.apply(this,arguments))},Resource}(String)}),define("scraping/ResourceFetcher",["underscore","./Resource"],function(_,Resource){var ResourceFetcher;return ResourceFetcher=function(){ResourceFetcher.id=0;function ResourceFetcher(productSid,args){this.productSid=productSid,this.id=ResourceFetcher.id++,this.url=args.url,this.requires=args.requires}return ResourceFetcher.prototype.resetDeleteTimeout=function(){return clearTimeout(this.deleteTimeoutId),this.deleteTimeoutId=setTimeout(function(_this){return function(){return delete _this.cache}}(this),3e4)},ResourceFetcher.prototype.fetch=function(cb){var doFetch;if(this.cache)return this.resetDeleteTimeout(),cb(this.cache);if(this.fetching)return this.cbs.push(cb);if(this.url!=null)return this.cbs=[cb],this.fetching=!0,doFetch=function(_this){return function(url){return console.debug("fetching url "+url),_this.background.httpRequest(url,{method:"get",dataType:"text",cb:function(responseText,response){var resource,_i,_len,_ref;_this.fetching=!1;if(response.status===200||response.status==="success"){_this.cache=resource=new Resource(responseText,url),_ref=_this.cbs;for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],cb(resource);return delete _this.cbs,_this.resetDeleteTimeout()}throw delete _this.cbs,_this.fetching=!1,new Error(""+url+": http status "+response.status)},error:function(){var _i,_len,_ref;_this.fetching=!1,_ref=_this.cbs;for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],cb(null);return delete _this.cbs}})}}(this),this.requires?this.scraper.resource(this.requires).fetch(function(_this){return function(resource){return doFetch(_this.url(resource))}}(this)):doFetch(this.url());throw new Error("ResourceFetcher must have URL constructor")},ResourceFetcher}()}),define("scraping/ResourceScraper",[],function(){var ResourceScraper;return ResourceScraper=function(){function ResourceScraper(args){if(this===window)return{"const":args.callee,args:args,config:function(config){return{"const":args.callee,args:args,config:config}}}}return ResourceScraper.prototype.config=function(config){var name,value;for(name in config)value=config[name],this[name]=value;return this},ResourceScraper.prototype.pushResource=function(resource){return this.resource=resource},ResourceScraper}()}),define("scraping/DeclarativeScraper",[],function(){var DeclarativeScraper,Value;return Value=function(){function Value(name,value){this.name=name,this.value=value}return Value}(),DeclarativeScraper=function(){DeclarativeScraper.prototype.executeMatches=function(matches,subject){var i,match,values,_i,_len;values=[];if(matches)for(i=_i=0,_len=matches.length;_i<_len;i=++_i){match=matches[i];if(match.disabled)continue;values=values.concat(this.execute(match,subject,i))}return values},DeclarativeScraper.prototype.getPath=function(){var el,_i,_len,_ref,_results;_ref=this.path,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],_results.push({index:el.index,type:el.type});return _results},DeclarativeScraper.prototype.hasValue=function(obj,key){return obj&&key in obj&&obj[key]!==null&&obj[key]!==""},DeclarativeScraper.prototype.executeMatch=function(el,matches){var capture,group,r,values,_ref;values=[];if(el.captures){_ref=el.captures;for(group in _ref)capture=_ref[group],r=this.execute(capture,matches[parseInt(group)],group),r&&(values=values.concat(r))}return this.processValue(el,values,matches)},DeclarativeScraper.prototype.processValue=function(el,values,matches,tieredMatches,subject){var a,array,content,i,name,obj,part,parts,value,_i,_j,_k,_len,_len1,_len2;if(el.value){name=el.value.name,this.hasValue(el.value,"name")&&matches&&(name=name.replace(/\$(\d+):(\d+)/g,function(match,p1,p2){return tieredMatches[parseInt(p1)][parseInt(p2)]}),name=name.replace(/\$([a-z]*)(\d+)/g,function(match,flag,p1){var value;return value=matches[parseInt(p1)],flag==="lc"&&(value=value.toLowerCase()),value}));if(this.hasValue(el.value,"type")){if(el.value.type==="array"){array=[];for(_i=0,_len=values.length;_i<_len;_i++)value=values[_i],array.push(value.value);return[new Value(name,array)]}if(el.value.type==="object"){obj={};for(_j=0,_len1=values.length;_j<_len1;_j++){value=values[_j];if(!value.name)throw console.debug(el,values),new Error("ValueMustHaveName");a=obj,parts=value.name.split(".");for(i=_k=0,_len2=parts.length;_k<_len2;i=++_k)part=parts[i],i===parts.length-1?a[part]=value.value:(a[part]==null&&(a[part]={}),a=a[part])}return[new Value(name,obj)]}}else{if(this.hasValue(el.value,"content"))return content=el.value.content,matches&&(content=content.replace(/\$(\d+):(\d+)/g,function(match,p1,p2){return tieredMatches[parseInt(p1)][parseInt(p2)].replace(/"/g,'\\"')}),content=content.replace(/\$([a-z]*)(\d+)/g,function(match,flag,p1){return value=matches[parseInt(p1)].replace(/"/g,'\\"'),flag==="lc"&&(value=value.toLowerCase()),value})),[new Value(name,JSON.parse(content))];if(matches&&this.hasValue(el.value,"capture"))return[new Value(name,matches[el.value.capture])];if(this.hasValue(el.value,"name")){if(!values.length)return[new Value(name,subject)];values[0].name=name}}}return values},DeclarativeScraper.prototype.execute=function(el,subject,index){var capture,caseObj,e,globalMatch,globalMatches,group,i,match,matches,regExp,retVal,tieredMatches,value,values,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2;index==null&&(index=0),retVal=null;if(el.type||el.pattern){el.type==null&&(el.type="Match"),this.path.push({type:"match",index:index,el:el});switch(el.type){case"Match":regExp=new RegExp(el.pattern),matches=subject.match(regExp);if(matches){values=[];if(el.captures)try{_ref=el.captures;for(group in _ref)capture=_ref[group],values=values.concat(this.execute(capture,matches[parseInt(group)],group))}catch(_error){e=_error;if(!el.optional||e.message!=="FailedRequirement")throw e;retVal=[]}retVal=this.processValue(el,values,matches)}else{if(!el.optional)throw new Error("FailedRequirement");retVal=[]}break;case"MatchAll":regExp=new RegExp(el.pattern),globalMatches=subject.match(new RegExp(el.pattern,"g")),tieredMatches=[];if(globalMatches){values=[];try{for(i=_i=0,_len=globalMatches.length;_i<_len;i=++_i)globalMatch=globalMatches[i],matches=globalMatch.match(regExp),tieredMatches[i]=matches,values=values.concat(this.executeMatch({type:"Match",captures:el.match.captures,value:el.match.value},matches))}catch(_error){e=_error;if(!el.optional||e.message!=="FailedRequirement")throw e;retVal=[]}retVal=this.processValue(el,values,globalMatches,tieredMatches)}else{if(!el.optional)throw new Error("FailedRequirement");retVal=[]}break;case"Or":_ref1=el.matches;for(i=_j=0,_len1=_ref1.length;_j<_len1;i=++_j){match=_ref1[i];if(match.disabled)continue;try{value=this.execute(match,subject,i);if(value.length){retVal=this.processValue(el,value,null,null,subject);break}}catch(_error){e=_error;if(e.message!=="FailedRequirement")throw e;this.path.pop()}}if(!retVal){if(!el.optional)throw new Error("FailedRequirement");retVal=[]}break;case"Switch":value=null;try{_ref2=el.cases;for(i=_k=0,_len2=_ref2.length;_k<_len2;i=++_k){caseObj=_ref2[i];if(caseObj.disabled)continue;if(this.hasValue(caseObj,"pattern")&&subject.match(new RegExp(caseObj.pattern))||!this.hasValue(caseObj,"pattern")){value=this.processValue(caseObj,this.executeMatches(caseObj.matches,subject),null,null,subject);break}}}catch(_error){e=_error;if(!el.optional||e.message!=="FailedRequirement")throw e;retVal=[]}value=this.processValue(el,value,null,null,subject);if(value.length)retVal=value;else{if(!el.optional)throw new Error("FailedRequirement");retVal=[]}break;case"Count":regExp=new RegExp(el.pattern,"g"),matches=subject.match(regExp),matches?retVal=[new Value(null,matches.length)]:retVal=[]}}else this.path.push({type:"text",index:index}),values=this.executeMatches(el.matches,subject),retVal=this.processValue(el,values,null,null,subject);if(retVal===null)throw new Error("return is null");return this.path.pop(),retVal};function DeclarativeScraper(scraper){this.scraper=scraper,this.path=[]}return DeclarativeScraper.prototype.scrape=function(subject){return this.execute(this.scraper,subject)},DeclarativeScraper}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/resourceScrapers/DeclarativeResourceScraper",["underscore","../ResourceScraper","../DeclarativeScraper"],function(_,ResourceScraper,DeclarativeScraper){var DeclarativeResourceScraper;return DeclarativeResourceScraper=function(_super){__extends(DeclarativeResourceScraper,_super);function DeclarativeResourceScraper(name,property,map){this.name=name,this.property=property,this.map=map;if(this===window)return ResourceScraper(arguments)}return DeclarativeResourceScraper.prototype.scrape=function(cb){var e,result,scraper,scrapers,_i,_len,_ref;scrapers=this.propertyScraper.productScraper.background.declarativeScrapers;for(_i=0,_len=scrapers.length;_i<_len;_i++){scraper=scrapers[_i];if(scraper.site===this.site.name&&scraper.name===this.name){if(!scraper.properties[this.property]){cb();return}scraper=new DeclarativeScraper(scraper.properties[this.property]);try{result=(_ref=scraper.scrape(this.resource)[0])!=null?_ref.value:void 0,cb(this.map?this.map(result):result);return}catch(_error){throw e=_error,e.info={path:scraper.getPath()},e}}}throw new Error("failed to find scraper for "+this.site.name+" "+this.name)},DeclarativeResourceScraper}(ResourceScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/ProductScraper",["./PropertyScraper","./ResourceFetcher","./resourceScrapers/DeclarativeResourceScraper","underscore"],function(PropertyScraper,ResourceFetcher,DeclarativeResourceScraper,_){var ProductScraper,ProductSid;return ProductSid=function(_super){__extends(ProductSid,_super);function ProductSid(value){this.value=value,String.call(this,this.value)}return ProductSid.prototype.toString=function(){return this.value},ProductSid.prototype.valueOf=function(){return this.value},ProductSid}(String),ProductScraper=function(){ProductScraper.declarativeProductScraper=function(name,opts){var DeclarativeProductScraper,prop,properties,_i,_len,_ref,_ref1;properties={},_ref=["title","image","price","more","rating","ratingCount","reviews"];for(_i=0,_len=_ref.length;_i<_len;_i++)prop=_ref[_i],properties[prop]={resource:opts.resource,scraper:DeclarativeResourceScraper(name,prop,(_ref1=opts.mapping)!=null?_ref1[prop]:void 0)};return DeclarativeProductScraper=function(_super){__extends(DeclarativeProductScraper,_super);function DeclarativeProductScraper(){return DeclarativeProductScraper.__super__.constructor.apply(this,arguments)}return DeclarativeProductScraper.prototype.resources=opts.resources,DeclarativeProductScraper.prototype.parseSid=opts.parseSid,DeclarativeProductScraper.prototype.properties=properties,DeclarativeProductScraper}(ProductScraper)};function ProductScraper(site,productSid,background){var fetcher,properties,property,resource,resources,scraper;this.site=site,this.background=background,this.productSid=new ProductSid(productSid),this.parseSid&&_.extend(this.productSid,this.parseSid(productSid));if(this.resources){resources=this.resources,this.resources={};for(resource in resources)fetcher=resources[resource],this.resources[resource]=new ResourceFetcher(this.productSid,fetcher),this.resources[resource].site=this.site,this.resources[resource].background=this.background,this.resources[resource].scraper=this}if(this.properties){properties=this.properties,this.properties={};for(property in properties)scraper=properties[property],_.isFunction(scraper)?this.properties[property]={scrape:scraper,productSid:this.productSid}:(this.properties[property]=new PropertyScraper(this.productSid,this.site,scraper),this.properties[property].productScraper=this,this.properties[property].background=this.background,this.properties[property].propertyName=property)}}return ProductScraper.prototype.resource=function(resourceName){var resource;resource=this.resources[resourceName];if(resource)return resource;throw new Error("no resource '"+resourceName+"'")},ProductScraper.prototype.versionString=function(){var parts,scraper,_i,_len,_ref,_ref1;parts=[(_ref=this.version)!=null?_ref:0];if(this.background.declarativeScrapers){_ref1=this.background.declarativeScrapers;for(_i=0,_len=_ref1.length;_i<_len;_i++)scraper=_ref1[_i],scraper.site===this.site.name&&parts.push(scraper.timestamp)}return parts.join(";")},ProductScraper.prototype.propertyScraper=function(propertyName){return this.properties[propertyName]},ProductScraper.prototype.scrapeProperty=function(property,cb){var propertyScraper;return env.core?cb():(propertyScraper=this.propertyScraper(property),propertyScraper?propertyScraper.scrape(cb):cb())},ProductScraper.prototype.canScrapeProperty=function(property){return this.propertyScraper(property)},ProductScraper.prototype.scrape=function(properties,cb){var collectValue,num,prop,values,_i,_len,_results;values={},num=0,collectValue=function(_this){return function(prop,value){values[prop]=value;if(++num===properties.length)return cb(values)}}(this),_results=[];for(_i=0,_len=properties.length;_i<_len;_i++)prop=properties[_i],_results.push(function(_this){return function(prop){return _this.scrapeProperty(prop,function(value){return collectValue(prop,value)})}}(this)(prop));return _results},ProductScraper}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/resourceScrapers/PatternResourceScraper",["../ResourceScraper","underscore"],function(ResourceScraper,_){var PatternResourceScraper;return PatternResourceScraper=function(_super){__extends(PatternResourceScraper,_super);function PatternResourceScraper(pattern,match,_default){this.pattern=pattern,this.match=match,this["default"]=_default;if(this===window)return ResourceScraper(arguments)}return PatternResourceScraper.prototype.scrape=function(cb){var i,m,map,match,matches,pattern,_i,_len,_ref,_ref1,_ref2;map=(_ref=this.map)!=null?_ref:function(value){return value};if(_.isArray(this.pattern)){_ref1=this.pattern;for(i=_i=0,_len=_ref1.length;_i<_len;i=++_i){_ref2=_ref1[i],pattern=_ref2[0],match=_ref2[1],m=_ref2[2],matches=this.resource[i===this.pattern.length-1?"safeMatch":"match"](pattern);if(matches){cb((m!=null?m:map)(matches[match]));return}}return cb(null)}return matches=this.resource[this["default"]!=null?"match":"safeMatch"](this.pattern),matches?cb(map(matches[this.match])):this["default"]!=null?cb(this["default"]):cb(null)},PatternResourceScraper}(ResourceScraper)}),define("BlockRunner",["underscore"],function(_){var BlockRunner;return BlockRunner=function(){function BlockRunner(code){this.code=code,this.ref=0}return BlockRunner.prototype.onDone=function(cb){return this._onDone==null&&(this._onDone=[]),this._onDone.unshift(cb)},BlockRunner.prototype.done=function(result){return this.result=result,this.release()},BlockRunner.prototype.retain=function(){return++this.ref},BlockRunner.prototype.release=function(){var cb,_i,_len,_ref;if(this.ref===0)throw new Error("ref is already 0");--this.ref;if(this.ref===0){if(this._onDone){_ref=this._onDone;for(_i=0,_len=_ref.length;_i<_len;_i++)cb=_ref[_i],cb(this.result)}return this.calledDone=!0}},BlockRunner.prototype["try"]=function(blockMap){var blocks,i,names,nextBlock;return names=_.keys(blockMap),blocks=_.values(blockMap),i=0,this.retain(),nextBlock=function(_this){return function(){var b,block;return block=blocks[i],block?(++i,b=_this.spawnBlock(block,names[i-1]),b.resultMap=function(result){return result===!0?!0:result===null?null:!1},b.onDone(function(result){return result===!1?nextBlock():_this.release()}),b.exec()):_this.release()}}(this),nextBlock()},BlockRunner.prototype.eachSerially=function(blockMap){var blocks,i,names,nextBlock;return names=_.keys(blockMap),blocks=_.values(blockMap),i=0,this.retain(),nextBlock=function(_this){return function(){var b,block;return block=blocks[i],block?(++i,b=_this.spawnBlock(block,names[i-1]),b.onDone(function(){return nextBlock()}),b.exec()):_this.release()}}(this),nextBlock()},BlockRunner.prototype.spawnBlock=function(code,name){var b,block;return name==null&&(name=""),this.retain(),this.children=!0,b=function(){},b.prototype=this,this.root?b.prototype=this.root:b.prototype=this,block=new b(code),block.parent=this,block.name=name,block.code=code,block.root=b.prototype,block.children=0,block.ref=0,block._onDone=[],block.result=null,this.path?block.path=this.path.concat([name]):block.path=[name],block.onDone(function(_this){return function(){return _this.release()}}(this)),block},BlockRunner.prototype.execBlock=function(code){var block;return block=this.spawnBlock(code),block.exec()},BlockRunner.prototype.exec=function(_done){_done&&this.onDone(_done),this.retain(),this.result=this.code(),this.resultMap&&(this.result=this.resultMap(this.result));if(this.result!==null||this.children)return this.release()},BlockRunner}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/resourceScrapers/ScriptedResourceScraper",["underscore","../ResourceScraper","BlockRunner","../DeclarativeScraper"],function(_,ResourceScraper,BlockRunner,DeclarativeScraper){var ScriptedResourceScraper;return ScriptedResourceScraper=function(_super){__extends(ScriptedResourceScraper,_super);function ScriptedResourceScraper(script){this.script=script;if(this===window)return ResourceScraper(arguments)}return ScriptedResourceScraper.prototype.value=function(arg){return _.isUndefined(arg)?this.vCont.value:typeof arg=="object"&&!_.isArray(arg)?(typeof this.vCont.value!="object"&&(this.vCont.value={}),_.extend(this.vCont.value,arg)):this.vCont.value=arg},ScriptedResourceScraper.prototype.scrape=function(cb){var A,a;return this.vCont={},A=function(){},A.prototype=this,a=new A,_.extend(a,BlockRunner.prototype),BlockRunner.call(a,this.script),a.onDone(function(_this){return function(){return cb(_this.vCont.value)}}(this)),a.exec()},ScriptedResourceScraper.prototype.get=function(url,cb){return this.propertyScraper.productScraper.background.httpRequest(url,{method:"get",dataType:"text",cb:function(_this){return function(responseText,response){if(response.status===200||response.status==="success")return cb.call(_this,responseText);throw new Error(""+url+": http status "+response.status)}}(this)})},ScriptedResourceScraper.prototype.post=function(url,data,cb){return this.propertyScraper.productScraper.background.httpRequest(url,{method:"post",dataType:"text",data:data,cb:function(_this){return function(responseText,response){if(response.status===200||response.status==="success")return cb.call(_this,responseText);throw new Error(""+url+": http status "+response.status)}}(this)})},ScriptedResourceScraper.prototype.matchAll=function(string,pattern,group){var match,matches,_i,_j,_len,_len1,_results,_results1;group==null&&(group=!1),matches=string.match(new RegExp(_.isString(pattern)?pattern:pattern.source,"g"));if(matches){if(group===!1){_results=[];for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],_results.push(match.match(pattern));return _results}_results1=[];for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],_results1.push(match.match(pattern)[group]);return _results1}return[]},ScriptedResourceScraper.prototype.getResource=function(resourceName,cb){var resourceFetcher;return resourceFetcher=this.propertyScraper.productScraper.resource(resourceName),resourceFetcher.fetch(function(_this){return function(resource){return cb.call(_this,resource)}}(this))},ScriptedResourceScraper.prototype.declarativeScraper=function(name,property,subject){var e,result,scraper,scrapers,_i,_len,_ref;property==null&&(property=this.propertyScraper.propertyName),subject==null&&(subject=null),scrapers=this.propertyScraper.productScraper.background.declarativeScrapers;for(_i=0,_len=scrapers.length;_i<_len;_i++){scraper=scrapers[_i];if(scraper.site===this.site.name&&scraper.name===name){if(!scraper.properties[property])return null;scraper=new DeclarativeScraper(scraper.properties[property]);try{return result=(_ref=scraper.scrape(subject!=null?subject:this.resource)[0])!=null?_ref.value:void 0,this.map?this.map(result):result}catch(_error){throw e=_error,e.info={path:scraper.getPath()},e}}}throw new Error("failed to find scraper for "+this.site.name+" "+this.name)},ScriptedResourceScraper}(ResourceScraper)}),define("ext/AmazonProductScraper",["scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper"],function(PatternResourceScraper,DeclarativeResourceScraper){return{more:function(switches,more){var matches,_ref;more.reviews=this.declarativeScraper("scraper","reviews"),more.sizes=this.resource.matchAll(/<option value="[^"]*" class="dropdownAvailable" data-a-css-class="dropdownAvailable" id="native_size_name_\d+" data-a-id="size_name_\d+" data-a-html-content="([^"]*)">/,1),more.howItFits=(_ref=this.resource.match(/<span class="a-size-small">How it fits:<span class="a-text-bold"> ([^<]*)/))!=null?_ref[1]:void 0;if(switches.description&&!more.description){matches=this.resource.match(/<div class="productDescriptionWrapper">\s*([\S\s]*?)<div class="emptyClear">/);if(matches)return more.description=matches[1].trim()}}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Amazon/AmazonProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore","ext/AmazonProductScraper"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,DeclarativeResourceScraper,_,AmazonProductScraperExt){var AmazonProductScraper;return AmazonProductScraper=function(_super){__extends(AmazonProductScraper,_super);function AmazonProductScraper(){return AmazonProductScraper.__super__.constructor.apply(this,arguments)}return AmazonProductScraper.productSid=function(url,cb){},AmazonProductScraper.testProducts=["B00C66C950","B00EIRFYS4","B00GK9HH4C"],AmazonProductScraper.testing={skipTest:["more.reviews"]},AmazonProductScraper.prototype.version=5,AmazonProductScraper.prototype.resources={offerListing:{url:function(){return"http://www.amazon.com/gp/offer-listing/"+this.productSid+"/ref=olp_sort_p?ie=UTF8&shipPromoFilter=0&sort=price&me=&seller=&condition=new"}},offerListingPricePlusShipping:{url:function(){return"http://www.amazon.com/gp/offer-listing/"+this.productSid+"/ref=olp_sort_p?ie=UTF8&shipPromoFilter=0&sort=sip&me=&seller=&condition=new"}},productPage:{url:function(){return"http://www.amazon.com/gp/product/"+this.productSid+"/?psc=1"}}},AmazonProductScraper.prototype.properties={rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},title:{resource:"offerListing",scraper:ScriptedResourceScraper(function(){return this["try"]({1:function(){var matches;return matches=this.resource.match(/<span id="btAsinTitle">([^<]*)<\/span>/),matches?(this.value(matches[1]),!0):!1},2:function(){var matches;return matches=this.resource.match(/<h1 class="producttitle\s*">\s*([\s\S]*?)\s*?<\/h1>/),matches?(this.value(matches[1]),!0):!1},3:function(){var matches;return matches=this.resource.match(/<h1 class='a-spacing-none'>\s*([^<]*?)<\h1/),matches?(this.value(matches[1].trim().replace(/\s+/g," ")),!0):!1},4:function(){var matches;return matches=this.resource.match(/New offers for\s*<\/span>\s*<\/div>\s*(.*?)<\/h1>/),matches?(this.value(matches[1].trim().replace(/\s+/g," ")),!0):!1}})})},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){return this["try"]({buyNewPrice:function(){var matches;return matches=this.resource.match(/<span class="bb_price">\s*\$([^<])\s*</),matches?(this.value(matches[1]),!0):!1},priceLarge:function(){var matches;return matches=this.resource.match(/class="priceLarge">\$([^<]*)</),matches?(this.value(matches[1]),!0):!1},wirelessPriceFromPrice:function(){var matches;return matches=this.resource.match(/id="wirelessPriceFromPrice"[^>]*>\$([^<]*)</),matches?(this.value(matches[1]),!0):!1},1:function(){var matches;return matches=this.resource.match('<span class="a-color-price a-size-large">\\$([^<]*)</span>'),matches?(this.value(matches[1]),!0):!1},2:function(){var matches;return matches=this.resource.match('<span id="priceblock_ourprice" class="a-size-medium a-color-price">\\$([^<]*)</span>'),matches?(this.value(matches[1]),!0):!1},3:function(){var matches;return matches=this.resource.match('<span class="a-size-medium a-color-price offer-price a-text-normal">\\$([^<]*)</span>'),matches?(this.value(matches[1]),!0):!1},4:function(){var matches;return matches=this.resource.match('<span id="current-price" style="display: inline">&#36;([^<]*)</span>'),matches?(this.value(matches[1]),!0):!1},5:function(){var matches;return matches=this.resource.match(/<span id="priceblock_saleprice" class="a-size-medium a-color-price">\$([^<]*)<\/span>/),matches?(this.value(matches[1]),!0):!1},6:function(){var matches;return matches=this.resource.safeMatch(/<span id="actualPriceValue"><b class="priceLarge">\$([^<]*)<\/b>/),matches?(this.value(matches[1]),!0):!1}})})},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){return this["try"]({1:function(){var image,matches;return matches=this.resource.match(/thumb_0_inner[\S\s]*?(http:\/\/ecx.images-amazon.com\/.*?\.jpg)/),matches?(image=matches[1],image=image.substr(0,image.length-5)+"0_.jpg",this.value(image),!0):!1},2:function(){var matches;return matches=this.resource.match('<img.*?(http[^"]+)" id="prodImage"'),matches?(this.value(matches[1]),!0):!1},3:function(){var matches;return matches=this.resource.match('id="main-image" src="http([^"]*)"'),matches?(this.value("http"+matches[1]),!0):!1},4:function(){var matches;return matches=this.resource.match('src="([^"]+)"\\s*id="original-main-image"'),matches?(this.value(matches[1]),!0):!1},5:function(){var matches;return matches=this.resource.match('var imageHashMain = \\["([^"]*)"'),matches?(this.value(matches[1]),!0):!1},6:function(){var image,matches;return matches=this.resource.match('src="([^"]+)" id="prodImage"'),matches?(image=matches[1],image=image.replace(/\d+(_\.\w+)^/,"300$1"),this.value(image),!0):!1},7:function(){var image,matches;return matches=this.resource.match("class=\"imgTagWrapper\">\\s*<img src='([^']*)"),matches?(image=matches[1],this.value(image),!0):!1},8:function(){var image,matches;return matches=this.resource.match('<img alt="" src="[^"]*" data-old-hires="([^"]+)"'),matches?(image=matches[1].replace(/^(http:\/\/ecx\.images-amazon\.com\/images\/.\/[^.]*\._)[^_]*(_\.jpg)$/,"$1UX500$2"),this.value(image),!0):!1},9:function(){var image,matches;return matches=this.resource.match(/data-a-dynamic-image="\{&quot;([^&]*)/),matches?(image=matches[1],this.value(image),!0):!1},10:function(){var image,matches;return matches=this.resource.match('<img id="imgBlkFront" src="(http://ecx.images-amazon.com/images/I/[^.]*)'),matches?(image=matches[1]+".jpg",this.value(image),!0):!1},11:function(){var image,matches;return matches=this.resource.match(/<div id="imgTagWrapperId" class="imgTagWrapper">\s*<img alt="" src="([^"]*)/),matches?(image=matches[1]+".jpg",this.value(image),!0):!1},12:function(){var image,matches;return matches=this.resource.match(/<td id="fbt_x_img">\s*<img src="(http:\/\/ecx\.images-amazon\.com\/images\/I\/[^.]*)/),matches?(image=matches[1]+".jpg",this.value(image),!0):!1}})})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var detailMatches,features,match,matches,more,selectedVarations,switches,variationsMatch,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3;switches={images:!0,features:!0,details:!0,description:!0,category:!0},more={},switches.images&&(matches=this.resource.match(/data\["colorImages"\] = ([^;]*);/),matches?matches[1]==="{}"?(matches=this.resource.match(/var data = \{\s*'colorImages': \{ 'initial': ([\S\s]*?)\},\s*'colorToAsin':/),more.images={initial:JSON.parse(matches[1])},more.currentStyle="initial"):(more.images=JSON.parse(matches[1]),more.currentStyle=this.resource.safeMatch("data\\[\"landingAsinColor\"\\] = '([^']*)'")[1]):(matches=this.resource.match(/var def = colorImages \? colorImages\[data\.defaultColor\] : \[\];\s*colorImages = ([^;]*);/),matches&&(more.images=JSON.parse(matches[1]),more.currentStyle=(_ref=this.resource.match(/selected_variations\["color_name"\]='([^']*)';/))!=null?_ref[1]:void 0)),more.currentStyle||(variationsMatch=(_ref1=this.resource.match(/<table class="variations"([\S\s]*?)<\/table>/))!=null?_ref1[1]:void 0,variationsMatch&&(selectedVarations=this.matchAll(variationsMatch,/<div id=\S* class="variationSelected">\s*<b class="variationDefault">[^<]*<\/b>\s*<b class="variationLabel">([^<]*)<\/b>/,1),more.currentStyle=selectedVarations.join(" "))));if(switches.features){matches=(_ref2=this.resource.match(/<div id="feature-bullets"[^>]*>([\S\s]*?)<\/div>\s*<\/div>/))!=null?_ref2[1]:void 0;if(matches){matches=this.matchAll(matches,/<li><span[^>]*>([\S\s]*?)<\/span>/),features=[];for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],features.push(match[1]);more.features=features}}if(switches.details){matches=this.resource.match(/<div id="detailBullets_feature_div">([\S\s]*?)<\/ul>/);if(matches){matches=this.matchAll(matches[1],/<li><span class="a-list-item">([\S\s]*?)<\/span><\/li>/),more.details={};for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],detailMatches=match[1].safeMatch(/<span class="a-text-bold">([^:]*):\s*<\/span>\s*<span>([\S\s]*?)<\/span>/),more.details[detailMatches[1]]=detailMatches[2]}}return switches.description&&(more.description=(_ref3=this.resource.match(/<div id="productDescription" class="a-section a-spacing-small">\s*([\S\s]*?)\s*<\/div>/))!=null?_ref3[1]:void 0),switches.category&&(matches=this.resource.match(/<h2 class="a-spacing-mini">Look for Similar Items by Category<\/h2>\s*<p>([\S\s]*?)<\/p>/),matches&&(matches=this.matchAll(matches[1],/<a class="a-link-normal" href="[^"]*">([^<]*)<\/a>/),more.category=_.map(matches,function(o){return o[1]}))),AmazonProductScraperExt.more.call(this,switches,more),this.value(more)})},reviews:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var amazonVerifiedPurchase,authorName,authorUrl,badgeMatch,badgeMatches,badges,commentsCount,commentsUrl,count,helpfulCount,helpfulTotal,matches,rating,review,reviewMatch,reviewMatches,reviews,reviewsUrl,time,title,url,__,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref10,_ref11,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;reviews=[],reviewsUrl=null,count=0,matches=this.resource.match(/<div id='revMHRL' class='mb30'>([\S\s]*?)<div id="revF" style="margin: 0 0 30px 25px;">/);if(matches){reviewMatches=this.matchAll(matches[1],/<div id="rev-[^-]*-[^>]*>([\S\s]*?)<\/div>  <\/div><\/div>/);for(_i=0,_len=reviewMatches.length;_i<_len;_i++){_ref=reviewMatches[_i],__=_ref[0],reviewMatch=_ref[1],rating=parseInt(reviewMatch.match(/<span>(.*?) out of 5 stars<\/span>/)[1]),time=reviewMatch.match(/<span class="inlineblock txtsmall">([^<]*)/)[1],_ref1=reviewMatch.match(/<a href="([^"]*)" class="txtlarge gl3 gr4 reviewTitle valignMiddle"><strong>([^<]*)/),__=_ref1[0],url=_ref1[1],title=_ref1[2],review=reviewMatch.match(/<div class="drkgry">\s*([\S\s]*?)<\/div>/)[1].trim(),review=review.replace("display:none",""),_ref2=reviewMatch.match(/<a href="([^"]*?)" class="noTextDecoration">(?:(\d+) )?Comments?<\/a>/),__=_ref2[0],commentsUrl=_ref2[1],commentsCount=_ref2[2],_ref4=(_ref3=reviewMatch.match(/<div class="gry txtsmall hlp">(\d+) of (\d+) people found the following review helpful<\/div>/))!=null?_ref3:[],__=_ref4[0],helpfulCount=_ref4[1],helpfulTotal=_ref4[2],amazonVerifiedPurchase=reviewMatch.match(/<span class="orange strong avp">Amazon Verified Purchase<\/span>/)?!0:!1,_ref5=reviewMatch.match(/<span class="gry">By<\/span>\s*<a href="([^"]*)" class="noTextDecoration">([^<]*)/),__=_ref5[0],authorUrl=_ref5[1],authorName=_ref5[2],badgeMatches=this.matchAll(reviewMatch,/<span class='c7yBadge[^']*'>([^<]*)<\/span>/),badges=[];for(_j=0,_len1=badgeMatches.length;_j<_len1;_j++)badgeMatch=badgeMatches[_j],badges.push(badgeMatch[1]);reviews.push({rating:rating,url:url,title:title,time:time,review:review,author:{url:"http://www.amazon.com"+authorUrl,name:authorName,badges:badges},helpfulCount:helpfulCount,helpfulTotal:helpfulTotal,amazonVerifiedPurchase:amazonVerifiedPurchase,comments:{url:commentsUrl,count:commentsCount!=null?commentsCount:0}})}_ref6=this.resource.match(/<a id="seeAllReviewsUrl" href="([^"]*)" class="txtlarge noTextDecoration">\s*<strong>\s*See all ([\d,]+) customer reviews \(newest first\)/),__=_ref6[0],reviewsUrl=_ref6[1],count=_ref6[2]}else{matches=this.resource.match(/<div id="revMHRL" class="a-section">([\S\s]*?)<div id="revF" class="a-section">/);if(matches){reviewMatches=this.matchAll(matches[1],/<div id="rev-[^-]*-[^>]*>([\S\s]*?)Was this review helpful to you?/);for(_k=0,_len2=reviewMatches.length;_k<_len2;_k++)_ref7=reviewMatches[_k],__=_ref7[0],reviewMatch=_ref7[1],rating=parseInt(reviewMatch.match(/title="(.*?) out of 5 stars"/)[1]),matches=reviewMatch.match(/<span class="a-color-secondary"> on ([^<]*)/),time=matches?matches[1]:reviewMatch.match(/<\/span>\s*on\s*([^<]*)<\/span>/)[1],_ref8=reviewMatch.match(/<a class="a-link-normal a-text-normal a-color-base" href="([^"]*)"><span class="a-size-base a-text-bold">([^<]*)/),__=_ref8[0],url=_ref8[1],title=_ref8[2],review=reviewMatch.match(/<div class="a-section">([\S\s]*?)<\/div>/)[1].trim(),_ref9=reviewMatch.match(/<a class="a-link-normal comment-link" title="(\d*)" href="([^"]*)">/),__=_ref9[0],commentsCount=_ref9[1],commentsUrl=_ref9[2],_ref11=(_ref10=reviewMatch.match(/<span class="a-size-small a-color-secondary">(\d*) of (\d*) people found the following review helpful<\/span>/))!=null?_ref10:[],__=_ref11[0],helpfulCount=_ref11[1],helpfulTotal=_ref11[2],amazonVerifiedPurchase=reviewMatch.match(/<span class="a-size-mini a-color-state a-text-bold">\s*Amazon Verified Purchase\s*<\/span>/)?!0:!1,authorUrl=authorName=null,matches=reviewMatch.match(/<span class="a-color-secondary">\s*By\s*<\/span>\s*<a href="([^"]*)" class="noTextDecoration">([^<]*)<\/a>/),matches?(__=matches[0],authorUrl=matches[1],authorName=matches[2]):authorName="A Customer",reviews.push({rating:rating,url:url,title:title,time:time,review:review,author:{url:authorUrl?"http://www.amazon.com"+authorUrl:void 0,name:authorName},helpfulCount:helpfulCount,helpfulTotal:helpfulTotal,amazonVerifiedPurchase:amazonVerifiedPurchase,comments:{url:commentsUrl,count:commentsCount!=null?commentsCount:0}});matches=this.resource.match(/<a href="([^"]*)">([\d,]*) customer reviews<\/a>/),matches?(reviewsUrl=matches[1],count=matches[2]):(matches=this.resource.match(/<a class="a-link-emphasis a-text-bold" href="([^"]*)">\s*See all ([\d,]*) customer reviews \(newest first\)\s*<\/a>/),matches?(reviewsUrl=matches[1],count=matches[2]):(matches=this.resource.match(/<a class="a-link-emphasis a-nowrap" href="([^"]*)">See the customer review<\/a>/),matches?(count=1,reviewsUrl=matches[1]):(matches=this.resource.match(/<a class="a-link-emphasis a-nowrap" href="([^"]*)">See both customer reviews \(newest first\)<\/a>/),matches&&(count=2,reviewsUrl=matches[1]))))}}return this.value({reviews:reviews,url:reviewsUrl,count:count})})}},AmazonProductScraper}(ProductScraper)}),define("sites/Amazon/AmazonSite",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Amazon/AmazonSiteInjector",[],function(){return{d:["BCSiteInjector"],c:function(){var AmazonSiteInjector,matchProductSid;return matchProductSid=function(url){var matches,productSid;matches=(new RegExp("(?:/gp/product/|/dp/)([^/]*)")).exec(url);if(matches){productSid=matches[1];if(productSid==="B004LLIKVU")return;return productSid}},AmazonSiteInjector=function(_super){__extends(AmazonSiteInjector,_super);function AmazonSiteInjector(){return AmazonSiteInjector.__super__.constructor.apply(this,arguments)}return AmazonSiteInjector.prototype.siteName="Amazon",AmazonSiteInjector.prototype.pages=function(){return{"http://www.amazon.com/((.*?/)?dp/|gp/product/)":{drag:"#prodImageCell img, .main-image-inner-wrapper img, img#main-image, #imgTagWrapperId img, #imgBlkFront, #fbt_x_img img, #main-image-container .imgTagWrapper img",elHook:".buyingDetailsGrid > tbody",init:function(){function onVariationChange(){var prevASIN=Client.productID,id=setInterval(function(){var asin=Client.site.productID();(!t$("#addToCartButton")||$("#addToCartButton").style.cursor=="not-allowed")&&!t$(".dpSprite.s_seeAllBuying")?(clearInterval(id),Client.clearProduct()):(Client.productID&&Client.clearProduct(!0),asin!=prevASIN&&(Client.productInit(),clearInterval(id)))},100)}var variations=t$$(".variations .swatchOuter");for(var i=0;i<variations.length;++i){var variation=variations[i];variation.addEventListener("click",function(){if(this.firstChild.nextSibling.className=="swatchSelect")return;onVariationChange()},!0)}variations=t$$(".twister_dropdown");for(var i=0;i<variations.length;++i){var variation=variations[i];variation.addEventListener("change",function(){onVariationChange()},!0)}variations.length==0?Client.productInit():Client.clearProduct()},productID:function(){var func=function(){if(t$("#buyBoxAudible"))return;try{return t$("#swftext").href.match(/contentID=(.*?)&/)[1]}catch(e){try{return t$("#swfText").href.match(/contentID=(.*?)&/)[1]}catch(e){throw e}}http:return t$(".variationSelected")&&!jQuery(".variations .swatchOuter:visible").length&&!t$(".twister_dropdown")?$(".amazonLikeButton").id.split("_")[1]:$("#ASIN").value;var alt=t$("#cdPostBoxForm [name=originInstanceID]");return alt?alt.value:$("#ASIN").value},productID=func();return console.debug("ProductID:",productID),productID}}}},AmazonSiteInjector.prototype.initOverlay=function(overlayView){return overlayView.el.css("z-index",999999)},AmazonSiteInjector.prototype.onInitPage=function(){var initProduct,initProducts,loadRecomendations,loader;return $("#page-footer, body").css({paddingBottom:74}),$.fn.disableSelection=function(){return this.css("user-select","none"),this.css("-moz-user-select","none"),this.css("-webkit-user-select","none")},$.fn.enableSelection=function(){return this.css("user-select",""),this.css("-moz-user-select",""),this.css("-webkit-user-select","")},$("body").delegate("#magnifierLens","mouseover",function(_this){return function(){var down,event;return $("#magnifierLens").unbind(".agora"),down=!1,event=null,$("#magnifierLens").bind("mousedown.agora",function(e){return down=!0,$("html").disableSelection(),event=e,!0}).bind("mouseup.agora",function(){return down=!1}).bind("mousemove.agora",function(){var el,selector,_i,_len,_ref;if(down){down=!1,selector="#main-image, #landingImage, #prodImageCell img, .main-image-inner-wrapper img, img#main-image, #imgTagWrapperId img, #imgBlkFront, #fbt_x_img img, #main-image-container .imgTagWrapper img",_ref=$(selector);for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],_this.clearProductEl(el);return selector=selector.split(", ").map(function(str){return str+":visible"}).join(", "),_this.products($(selector),{siteName:_this.siteName,productSid:_this.Client.site.productID()},{area:"main"}),setTimeout(function(){return $("#magnifierLens").remove(),$("#zoomWindow").hide(),$(selector).trigger(event),$("html").one("mouseup",function(){return $("html").enableSelection()})},100)}})}}(this)),$("body").delegate(":not(.-agora) a img:not([agora])","mouseover",function(){var productSid;productSid=matchProductSid($(this).parents("a").attr("href"));if(productSid)return initProduct(this,productSid,!0)}),initProduct=function(_this){return function(el,sid,mousedover){var extraOverlayElements;return el=$(el),extraOverlayElements=null,el.parent().hasClass("imageBox")&&(extraOverlayElements=el.parents("a")),_this.initProductEl(el,{siteName:_this.siteName,productSid:sid},{hovering:mousedover,extraOverlayElements:extraOverlayElements,area:"listing"})}}(this),window.initProducts=initProducts=function(){return $(':not(.-agora) a img[src^="http://ecx.images-amazon.com/images/I/"]').each(function(){var a,productSid;a=$(this).parents("a:first"),productSid=matchProductSid(a.attr("href"));if(productSid)return initProduct($(this),productSid,!1)})},window.clearProducts=function(_this){return function(){var el,_i,_len,_ref,_results;_ref=$('a img[src^="http://ecx.images-amazon.com/images/I/"]'),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],matchProductSid($(el).parents("a:first").attr("href"))?_results.push(_this.clearProductEl(el)):_results.push(void 0);return _results}}(this),loadRecomendations=function(){var intervalId;return intervalId=setInterval(function(){if(!$("#rhf .rhf_loading_outer").length)return clearTimeout(intervalId),initProducts()},500)},$("body").delegate("#rvisColumn .rhf-RVIs a img","mousedown",function(){return setTimeout(loadRecomendations,100)}),loader=function(opts){var load,timerId;return timerId=null,load=function(el){var asins,contEl,count,func,startOverLink;return clearTimeout(timerId),contEl=$(el).parents(""+opts.container+":first"),asins=[],count=0,contEl.find(""+opts.slide+" > div:first-child").each(function(i){return asins[i]=$(this).attr("data-asin"),++count}),startOverLink=$(this).hasClass(opts.startOver),func=function(){contEl.find(opts.slide).each(function(i){var asin;if($(this).hasClass(opts.empty))return;asin=$(this).children("div:first-child").attr("data-asin");if(asins[i]!==asin)return asins[i]=asin,--count});if(count<=0)return startOverLink||clearTimeout(timerId),console.log(asins),initProducts()},startOverLink?setTimeout(func,500):timerId=setInterval(func,100)},$("body").delegate(""+opts.nav+", "+opts.container+" "+opts.startOver,"mousedown",function(){return load(this)})},loader({container:".a-carousel-container",slide:".a-carousel-card",nav:".a-carousel-container .a-carousel-goto-nextpage .a-button-inner, .a-carousel-container .a-carousel-goto-prevpage .a-button-inner",startOver:".a-carousel-restart",empty:"a-carousel-card-empty"}),loader({container:".shoveler",slide:".shoveler-content ul li",nav:".shoveler span.s_shvlNext, .shoveler .next-button a, .shoveler span.s_shvlBack",startOver:"a.start-over-link",empty:"shoveler-progress"}),setInterval(initProducts,2e3),$(function(){var loadOtherId,updateSearchResults;return loadRecomendations(),initProducts(),$("body").load(initProducts),loadOtherId=setInterval(function(){if(!$("#rhf_container .rhf_loading_outer").length)return clearTimeout(loadOtherId),initProducts()},500),$("body").delegate(".s9ShovelerBackBookendButton, .s9ShovelerNextBookendButton","mousedown",function(){return setTimeout(initProducts,500)}),updateSearchResults=function(){var timerId;return $("#btfResults").append('<div id="agoraTester" />'),timerId=setInterval(function(){if(!$("#agoraTester").length)return clearTimeout(timerId),initProducts()},500)},$("body").delegate("#sort","change",updateSearchResults),$("body").delegate("#pagn a, #refinements a, #kindOfSort_content a, #breadCrumb a, #relatedSearches a","mousedown",updateSearchResults),$(".nav-searchbar-inner.nav-prime-menu").submit(updateSearchResults)})},AmazonSiteInjector}(BCSiteInjector)}}}),{hasProductClass:!0,slug:"amazon",hosts:["www.amazon.com"],scraper:!0,currency:"dollar",icon:"http://www.amazon.com/favicon.ico",productUrl:function(sid){return"http://www.amazon.com/gp/product/"+sid},query:function(product){return{sku:product.get("productSid")}}},define("sites/Amazon/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/AmericanApparel/AmericanApparelProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var AmericanApparelProduct;return AmericanApparelProduct=function(_super){__extends(AmericanApparelProduct,_super);function AmericanApparelProduct(){return AmericanApparelProduct.__super__.constructor.apply(this,arguments)}return AmericanApparelProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,image,otherImages,_i,_len,_ref;otherImages=function(){var _i,_len,_ref,_results;_ref=more.images,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],_results.push({small:image.replace(/(_\d{2})/,"$1t"),medium:image,large:image,larger:image,full:image});return _results}(),_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],images[color.name]=[{small:color.image.replace(/(_\d{2})/,"$1t"),medium:color.image,large:color.image,larger:color.image,full:color.image}].concat(otherImages);return cb(images,more.color)}}(this))},AmericanApparelProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(reviews){return cb({reviews:reviews!=null?reviews:[]})})},AmericanApparelProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",details:"Details",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews}}),cb(widgets)}}(this))},AmericanApparelProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("scraping/resourceScrapers/JsonResourceScraper",["../ResourceScraper","underscore"],function(ResourceScraper,_){var JsonResourceScraper;return JsonResourceScraper=function(_super){__extends(JsonResourceScraper,_super);function JsonResourceScraper(map){this.map=map;if(this===window)return ResourceScraper(arguments)}return JsonResourceScraper.prototype.scrape=function(cb){var obj;return obj={matchAll:function(string,pattern,group){var match,matches,_i,_j,_len,_len1,_results,_results1;group==null&&(group=!1),matches=string.match(new RegExp(_.isString(pattern)?pattern:pattern.source,"g"));if(matches){if(group===!1){_results=[];for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],_results.push(match.match(pattern));return _results}_results1=[];for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],_results1.push(match.match(pattern)[group]);return _results1}return[]}},cb(this.map.call(obj,JSON.parse(this.resource)))},JsonResourceScraper}(ResourceScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/AmericanApparel/AmericanApparelProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var AmericanApparelProductScraper;return AmericanApparelProductScraper=function(_super){__extends(AmericanApparelProductScraper,_super);function AmericanApparelProductScraper(){return AmericanApparelProductScraper.__super__.constructor.apply(this,arguments)}return AmericanApparelProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},AmericanApparelProductScraper.prototype.resources={productPage:{url:function(){return"http://store.americanapparel.net/product/index.jsp?productId="+this.productSid.id+"&c="+this.productSid.color}},reviewData:{url:function(){return"http://i.americanapparel.net/storefront/ratingsreviews/Reviews.aspx?r=1&s="+this.productSid.id}}},AmericanApparelProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,match,more,name,obj,size,url;return more=this.declarativeScraper("scraper","more"),match=/<input type="hidden" value="([^"]*)" id="skuVarData"\/>/.exec(this.resource)[1],obj=JSON.parse(match.replace(/&quot;/g,'"')),more.colors=function(){var _ref,_results;_ref=obj.colors,_results=[];for(name in _ref)color=_ref[name],_results.push({name:name,image:color.hoverImage});return _results}(),more.sizes=function(){var _i,_len,_ref,_results;_ref=obj.sizes,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)size=_ref[_i],_results.push(size.value);return _results}(),url=this.resource.match(/AA\.productImgsUrl = "([^"]*)";/)[1],this.execBlock(function(){return this.get(url,function(response){var image;return more.images=function(){var _i,_len,_ref,_results;_ref=JSON.parse(response),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],_results.push("http://i.americanapparel.net"+image[1]);return _results}(),this.value(more),this.done(!0)}),null}),this.value(more)})},reviews:{resource:"reviewData",scraper:DeclarativeResourceScraper("reviews","reviews")}},AmericanApparelProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/AmericanApparel/AmericanApparelSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var AmericanApparelSiteInjector;return AmericanApparelSiteInjector=function(_super){__extends(AmericanApparelSiteInjector,_super);function AmericanApparelSiteInjector(){return AmericanApparelSiteInjector.__super__.constructor.apply(this,arguments)}return AmericanApparelSiteInjector.prototype.productListing={mode:2,image:'a:not(#zoom1) img[src^="http://s7d9.scene7.com/is/image/AmericanApparel/"]',overlay:".product .slashes",overlayImage:function(overlay){return overlay.parent().find('img[src^="http://s7d9.scene7.com/is/image/AmericanApparel/"]')},each:function(img){return console.log(img)},productSid:function(href,a,img){var matches;matches=/^http:\/\/s7d9\.scene7\.com\/is\/image\/AmericanApparel\/([^_]*)_(.*?)(?:\?|$)/.exec(img.attr("src"));if(matches)return""+matches[1]+"-"+matches[2]}},AmericanApparelSiteInjector.prototype.productPage={test:function(){return $("#product_img").length},productSid:function(){var matches;return matches=/^http:\/\/s7d9\.scene7\.com\/is\/image\/AmericanApparel\/([^_]*)_(.*?)(?:\?|$)/.exec($("#product_img").attr("src")),""+matches[1]+"-"+matches[2]},imgEl:"#product_img",overlayEl:".mousetrap"},AmericanApparelSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"americanapparel",hosts:["store.americanapparel.net"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://i.americanapparel.net/static/atg/1.22.0/media/favicons/favicon_blue.ico",twoTap:!0},define("sites/AmericanApparel/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Asos/AsosProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var AsosProduct;return AsosProduct=function(_super){__extends(AsosProduct,_super);function AsosProduct(){return AsosProduct.__super__.constructor.apply(this,arguments)}return AsosProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,images,otherImages;return more.color?(otherImages=_.map(more.images,function(image){return{small:image.small,medium:image.medium,large:image.large,larger:image.large,full:image.large}}),images=_.mapValues(more.colorImages,function(image){return[{small:image.small,medium:image.xlarge,large:image.xlarge,larger:image.xlarge,full:image.xxlarge}].concat(otherImages)}),cb(images,more.color.toLowerCase().replace(/\s+/g,""))):(image=more.colorImages[_.keys(more.colorImages)[0]],images=[{small:image.small,medium:image.xlarge,large:image.xlarge,larger:image.xlarge,full:image.xxlarge}].concat(_.map(more.images,function(image){return{small:image.small,medium:image.medium,large:image.large,larger:image.large,full:image.large}})),cb({"":images},""))}}(this))},AsosProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:{title:"Description",maxHeight:"none"},aboutMe:"About Me",lookAfterMe:"Look After Me",sizes:"Sizes"}),cb(widgets)}}(this))},AsosProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Asos/AsosProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var AsosProductScraper;return AsosProductScraper=function(_super){__extends(AsosProductScraper,_super);function AsosProductScraper(){return AsosProductScraper.__super__.constructor.apply(this,arguments)}return AsosProductScraper.prototype.resources={productPage:{url:function(){return"http://us.asos.com/pgeproduct.aspx?iid="+this.productSid}}},AsosProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,_ref;return color=(_ref=this.resource.match(/var preSelectedColour = '([^']*)';/))!=null?_ref[1]:void 0,color?(color=color.replace(/\s+/g,"").toLowerCase(),this.value(this.resource.match("http://images.asos-media.com/inv/media/\\d*/\\d*/\\d*/\\d*/\\d*/"+color+"/image1xl.jpg")[0])):this.value(this.resource.match(/<meta name="og:image" content="([^"]*)"\/>/)[1])})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var more;return more=this.declarativeScraper("scraper","more"),this.value(more)})}},AsosProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Asos/AsosSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var AsosSiteInjector;return AsosSiteInjector=function(_super){__extends(AsosSiteInjector,_super);function AsosSiteInjector(){return AsosSiteInjector.__super__.constructor.apply(this,arguments)}return AsosSiteInjector.prototype.productListing={image:'a img[src^="http://images.asos-media.com/inv/media/"]',productSid:function(href,a,img){var matches;return matches=/^http:\/\/images\.asos-media\.com\/inv\/media\/\d*\/\d*\/\d*\/\d*\/(\d*)/.exec(img.attr("src")),matches!=null?matches[1]:void 0}},AsosSiteInjector.prototype.productPage={mode:2,test:function(){return $('meta[name="og:type"]').attr("content")==="product"},productSid:function(){var color,colorSelect;return colorSelect=$("#ctl00_ContentMainPage_ctlSeparateProduct_drpdwnColour"),colorSelect.prop("disabled")||colorSelect.val()==="-1"?document.location.href.match(/(?:\?|&)iid=(\d*)/)[1]:(color=colorSelect.val(),$("#dataDictionary").html().match('"\\d*'+color+'":\\{"Sku":".*?(\\d+)"\\}')[1])},image:"#productImages img",attach:"#productImages",position:"#ctl00_ContentMainPage_imgMainImage"},AsosSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"asos",hosts:["us.asos.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.asos.com/favicon.ico",twoTap:!0},define("sites/Asos/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BarnesAndNoble/BarnesAndNobleProduct",["scraping/SiteProduct"],function(SiteProduct){var BarnesAndNobleProduct;return BarnesAndNobleProduct=function(_super){__extends(BarnesAndNobleProduct,_super);function BarnesAndNobleProduct(){return BarnesAndNobleProduct.__super__.constructor.apply(this,arguments)}return BarnesAndNobleProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,images,_i,_len,_ref;images=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],images.push({small:image.small,medium:image.medium,large:image.medium,larger:image.large,full:image.large});return cb({"":images},"")}}(this))},BarnesAndNobleProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BarnesAndNoble/BarnesAndNobleProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var BarnesAndNobleProductScraper;return BarnesAndNobleProductScraper=function(_super){__extends(BarnesAndNobleProductScraper,_super);function BarnesAndNobleProductScraper(){return BarnesAndNobleProductScraper.__super__.constructor.apply(this,arguments)}return BarnesAndNobleProductScraper.testProducts=["1113003734"],BarnesAndNobleProductScraper.prototype.resources={productPage:{url:function(){return"http://www.barnesandnoble.com/w/-/"+this.productSid}}},BarnesAndNobleProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<div class="[^"]*" itemprop="price" data-bntrack="[^"]*" data-bntrack-event="[^"]*">\$([^<]*)/),1],[new RegExp(/<span class="bb-price">\s*\$(\S*)/),1],[new RegExp(/<span class="mp-from">from<\/span>\s*\$(\S*)/),1],[new RegExp(/<em class="bb-title-format">NOOK Book<\/em> <span class="bb-title-info">\(eBook\)<\/span>\s*<\/div>\s*<div class="bb-pricing pricing-break-early" itemprop="offers" itemscope itemtype="http:\/\/schema.org\/Offer">\s*<div class="[^"]*" itemprop="price" data-bntrack="[^"]*" data-bntrack-event="[^"]*">\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var author,authorMatches,authorNames,bio,bioMatch,bioMatches,content,count,detailMatches,details,editorialReviews,erMatches,from,image,imageMatch,imageMatches,images,isbn,item,match,matches,name,overviewMatches,specifications,switches,title,url,value,_i,_j,_k,_l,_len,_len1,_len2,_len3;switches={images:!0,overview:!0,details:!0,isbn:!0,author:!0,rating:!0,ratingCount:!0,editorialReviews:!0,originalPrice:!0,shipping:!1},value={},switches.overview&&(matches=this.resource.match(/<div id="product-commentary-overview-2"([\S\s]*?)<\/section>/),overviewMatches=matches[1].match(/<div class="simple-html"([\S\s]*?)<\/div>/),value.overview=overviewMatches[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));if(switches.details){details={},matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),detailMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g);for(_i=0,_len=detailMatches.length;_i<_len;_i++)match=detailMatches[_i],title=match.match(/<span>([\S\s]*?)<\/span>/)[1],title=title.match(/([^:]*)/)[1],content=match.match(/<\/span>([\S\s]*?)<\/li>/)[1],details[title]=content.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ");value.details=details}switches.isbn&&(matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),isbn=matches[1].match(/<span>ISBN-13:<\/span>([\S\s]*?)<\/li>/),value.isbn=isbn[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));if(switches.author){author={},authorNames={},matches=this.resource.match(/<ul class="contributors([\S\s]*?)<\/ul>/),authorMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g),count=0;for(_j=0,_len1=authorMatches.length;_j<_len1;_j++)item=authorMatches[_j],count>0&&(name=item.match(/<li([\S\s]*?)<\/li>/)[1],name=name.match(/<a([\S\s]*?)<\/a>/)[1],name=name.match(/>([\S\s]*)/)[1],url=item.match(/<li([\S\s]*?)<\/li>/)[1],authorNames[name]=url.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ")),count++;author.names=authorNames,bioMatch=this.resource.match(/<div class="basic-info([\S\s]*?)<\/section>/),bioMatches=bioMatch[1].match(/<div class="content([\S\s]*?)<\/div>/),bio=bioMatches[1].match(/>([\S\s]+)/),author.bio=bio[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),imageMatch=this.resource.match(/<div id="product-commentary-meet-the-author-1"([\S\s]*?)<\/section>/),imageMatch&&(image=imageMatch[1].safeMatch(/src="([^"]+)/)[1],author.authorImage=image),value.author=author}switches.rating&&(matches=this.resource.match(/"customerAvgStarRating" : ([\S\s]*?),/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/"customerRatingCount" : ([\S\s]*?),/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){matches=this.resource.match(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/);if(matches){editorialReviews={},erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_k=0,_len2=erMatches.length;_k<_len2;_k++)match=erMatches[_k],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),editorialReviews[from]=content;value.editorialReviews=editorialReviews}}switches.originalPrice&&(matches=this.resource.match(/"listPrice" : ([\S\s]*?),/),matches&&(value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<div id="product-image-smaller-1-viewer"([\S\s]*?)<div id="product-promos-aside-1"/),imageMatches=matches[1].match(/data-bn-src-url="([^"]+)/g);for(_l=0,_len3=imageMatches.length;_l<_len3;_l++)match=imageMatches[_l],image=match.match(/data-bn-src-url="([^"]+)/),images.push(image[1]);value.images=images}return switches.specifications&&(specifications={},this.execBlock(function(){return this.getResource("specificationsTab",function(resource){var desc,specMatches,_len4,_m;matches=resource.safeMatch(/<tbody>([\S\s]*?)<\/tbody>/),specMatches=matches[1].match(/<tr>([\S\s]*?)<\/tr>/g);for(_m=0,_len4=specMatches.length;_m<_len4;_m++)match=specMatches[_m],name=match.match(/<th[^>]*>([\S\s]*?)<\/th>/)[1],details=match.match(/<td>([\S\s]*?)<\/td>/)[1],desc=match.match(/<td>([\S\s]*?)<\/td>/g)[1],desc=desc.match(/<td>([\S\s]*?)<\/td>/)[1],specifications[name]={details:details,desc:desc};return value.specifications=specifications,this.value(value),this.done(!0)}),null})),this.value(value)})}},BarnesAndNobleProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BarnesAndNoble/BarnesAndNobleSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var BarnesAndNobleSiteInjector;return BarnesAndNobleSiteInjector=function(_super){__extends(BarnesAndNobleSiteInjector,_super);function BarnesAndNobleSiteInjector(){return BarnesAndNobleSiteInjector.__super__.constructor.apply(this,arguments)}return BarnesAndNobleSiteInjector.prototype.productListing={imgSelector:'a[href^="http://www.barnesandnoble.com/w/"] img',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.barnesandnoble\.com\/w\/.*?\/([^?]+)/))!=null?_ref[1]:void 0,name}},BarnesAndNobleSiteInjector.prototype.productPage={test:function(){return $("#product-image-smaller-1").length},productSid:function(){return document.location.href.match(/^http:\/\/www\.barnesandnoble\.com\/w\/.*?\/([^?]+)/)[1]},imgEl:"#product-image-smaller-1 div img",waitFor:"#product-image-smaller-1 div img"},BarnesAndNobleSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"barnesandnoble",hosts:["www.barnesandnoble.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.barnesandnoble.com/favicon.ico"},define("sites/BarnesAndNoble/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BestBuy/BestBuyProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var BestBuyProduct;return BestBuyProduct=function(_super){__extends(BestBuyProduct,_super);function BestBuyProduct(){return BestBuyProduct.__super__.constructor.apply(this,arguments)}return BestBuyProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var height,image,largeH,largeW,mediumH,mediumW,name,orig,otherImages,size,smallH,smallW,width,_ref,_ref1;otherImages=[],_ref=more.images;for(name in _ref)image=_ref[name],orig=image,image=image.match(/^(.*?);/)[1],size=orig.match(/;(.*)/)[1],_ref1=size.split(";"),height=_ref1[0],width=_ref1[1],height=height.match(/^canvasHeight=(.*)/)[1],width=width.match(/^canvasWidth=(.*)/)[1],smallH=Math.floor(height/6),mediumH=Math.floor(height/4),largeH=Math.floor(height/2),smallW=Math.floor(width/6),mediumW=Math.floor(width/4),largeW=Math.floor(width/2),otherImages.push({small:image+(";canvasHeight="+smallH+";canvasWidth="+smallW),medium:orig,large:orig,larger:orig,full:image});return cb({"":otherImages},"")}}(this))},BestBuyProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BestBuy/BestBuyProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,_){var BestBuyProductScraper;return BestBuyProductScraper=function(_super){__extends(BestBuyProductScraper,_super);function BestBuyProductScraper(){return BestBuyProductScraper.__super__.constructor.apply(this,arguments)}return BestBuyProductScraper.prototype.parseSid=function(sid){var id,sku,_ref;return _ref=sid.split("-"),sku=_ref[0],id=_ref[1],{sku:sku,id:id}},BestBuyProductScraper.prototype.resources={productPage:{url:function(){return"http://www.bestbuy.com/site/asdf/"+this.productSid.sku+".p?id="+this.productSid.id+"&skuId="+this.productSid.sku}},specificationsTab:{url:function(){var skuId;return skuId=this.productSid.split("-")[1],"http://www.bestbuy.com/site/asdf/"+this.productSid.sku+".p;template=_specificationsTab"}}},BestBuyProductScraper.prototype.properties={pageType:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var type;return type=this.resource.match(/<div class="[^"]*bbtabs[^"]*">([\S\s]*?)<\/div>/)})},title:{resource:"productPage",scraper:PatternResourceScraper(/<div id="sku-title" itemprop="name">\s*<h1>([^<]*)<\/h1>/,1)},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var _ref,_ref1;return this.value((_ref=(_ref1=this.resource.match(/<div class="item-price"><span class="denominator">[\S\s]*?<\/span>([^<]*)<\/div>/))!=null?_ref1[1]:void 0)!=null?_ref:!1)})},image:{resource:"productPage",scraper:PatternResourceScraper(/<meta property="og:image" content="([^"]*)/,1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var altText,check,desc,featureMatches,features,height,imageMatches,images,include,includeMatches,included,match,matches,specifications,switches,title,url,value,width,_i,_j,_k,_len,_len1,_len2;switches={specifications:!0,images:!0,rating:!0,ratingCount:!0,originalPrice:!0,features:!0,model:!0,shipping:!0,included:!0},value={};if(switches.included){included=[],matches=this.resource.match(/<div id="included-items">([\S\s]*?)<\/div>/);if(matches){includeMatches=matches[1].match(/<li>([\S\s]*?)<\/li>/g);for(_i=0,_len=includeMatches.length;_i<_len;_i++)match=includeMatches[_i],include=match.match(/<li>([\S\s]*?)<\/li>/),included.push(include[1]);value.included=included}}switches.shipping&&((matches=this.resource.match(/<span class="free-shipping-sub-message">([\S\s]*?)<\/span>/))?matches[1]==="on orders $25 and up"?value.shipping="25andup":value.shipping="other":value.shipping="free"),switches.model&&(matches=this.resource.match(/<span id="model-value" itemprop="model">([\S\s]*?)<\/span>/),matches&&(value.model=matches[1]));if(switches.features){features={},matches=this.resource.match(/<div id="features">([\S\s]*?)<div id="carousel-wrap"/);if(matches){featureMatches=matches[1].match(/<div class="feature">([\S\s]*?)<\/div>/g);for(_j=0,_len1=featureMatches.length;_j<_len1;_j++)match=featureMatches[_j],match.match(/<h4>([\S\s]*?)<\/h4>/)&&(title=match.match(/<h4>([\S\s]*?)<\/h4>/)[1],desc=match.match(/<p>([\S\s]*?)<\/p>/)[1],features[title]=desc);value.features=features}}switches.originalPrice&&(matches=this.resource.match(/<div class="regular-price">Regular Price[\S\s]*?\$([\S\s]*?)<\/div>/),matches&&(value.originalPrice=matches[1])),switches.rating&&(matches=this.resource.match(/<span class="average-score" itemprop="ratingValue">([\S\s]*?)<\/span>/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/<a href="#" class="tab-link" data-tab-link="reviews">\(([\S\s]*?) customer review/),matches&&(value.reviewCount=matches[1]));if(switches.images){images={},matches=this.resource.match(/data-gallery-images=[\s]*"([^"]*)/);if(matches){imageMatches=matches[1].match(/\{([^\}]*)\}/g);if(imageMatches){for(_k=0,_len2=imageMatches.length;_k<_len2;_k++)match=imageMatches[_k],check=match.match(/&quot;altText&quot;:&quot;([\S\s]*?)&quot;,/),check&&(altText=match.match(/&quot;altText&quot;:&quot;([\S\s]*?)&quot;,/)[1],height=match.match(/&quot;height&quot;:([\S\s]*?),/),width=match.match(/&quot;width&quot;:([\S\s]*?),/),url=match.match(/&quot;path&quot;:&quot;([\S\s]*?)&quot;,/),url="http://pisces.bbystatic.com/image2/"+url[1]+";canvasHeight="+height[1]+";canvasWidth="+width[1],images[altText]=url);check||(images.main=this.resource.match(/<meta property="og:image" content="([^"]*)/)[1]),value.images=images}}}return switches.specifications&&(specifications={},this.execBlock(function(){return this.getResource("specificationsTab",function(resource){var details,name,specMatches,_l,_len3;matches=resource.match(/<tbody>([\S\s]*?)<\/tbody>/),specMatches=matches[1].match(/<tr>([\S\s]*?)<\/tr>/g);for(_l=0,_len3=specMatches.length;_l<_len3;_l++)match=specMatches[_l],name=match.match(/<th[^>]*>([\S\s]*?)<\/th>/)[1],details=match.match(/<td>([\S\s]*?)<\/td>/)[1],desc=match.match(/<td>([\S\s]*?)<\/td>/g)[1],desc=desc.match(/<td>([\S\s]*?)<\/td>/)[1],specifications[name]={details:details,desc:desc};return value.specifications=specifications,this.value(value),this.done(!0)}),null})),this.value(value)})}},BestBuyProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/BestBuy/BestBuySiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var BestBuySiteInjector;return BestBuySiteInjector=function(_super){__extends(BestBuySiteInjector,_super);function BestBuySiteInjector(){return BestBuySiteInjector.__super__.constructor.apply(this,arguments)}return BestBuySiteInjector.prototype.productListing={imgSelector:'a img[src^="http://images.bestbuy.com/BestBuy_US/images/products/"]',productSid:function(href,a,img){var id,matches;return matches=href.match(/^http:\/\/www\.bestbuy\.com\/site\/.*?\/([^\.]+)\.p\?id=([^\&]+)/),id=matches[1]+"-"+matches[2]}},BestBuySiteInjector.prototype.productPage={test:function(){return $("#product-media-content").length},productSid:function(){var id,matches;return matches=document.location.href.match(/^http:\/\/www\.bestbuy\.com\/site\/.*?\/([^\.]+)\.p\?id=([^\&]+)/),id=matches[1]+"-"+matches[2]},imgEl:".image-gallery-main-slide a img",waitFor:".image-gallery-main-slide a img"},BestBuySiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"bestbuy",hosts:["www.bestbuy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.bestbuy.com/favicon.ico"},define("sites/BestBuy/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Bloomingdales/BloomingdalesProduct",["scraping/SiteProduct","util","underscore"],function(SiteProduct,util,_){var BloomingdalesProduct;return BloomingdalesProduct=function(_super){__extends(BloomingdalesProduct,_super);function BloomingdalesProduct(){return BloomingdalesProduct.__super__.constructor.apply(this,arguments)}return BloomingdalesProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],images[color]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push({small:"http://images.bloomingdales.com/is/image/BLM/products/"+image+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg",medium:"http://images.bloomingdales.com/is/image/BLM/products/"+image+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg",large:"http://images.bloomingdales.com/is/image/BLM/products/"+image+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg",larger:"http://images.bloomingdales.com/is/image/BLM/products/"+image+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg",full:"http://images.bloomingdales.com/is/image/BLM/products/"+image+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg"});return _results}();return cb(images,more.color)}}(this))},BloomingdalesProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(reviews){return cb({reviews:reviews!=null?reviews:[]})})},BloomingdalesProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",details:"Details",sizes:"Sizes",colors:"Colors",reviews:{obj:reviews}}),cb(widgets)}}(this))},BloomingdalesProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Bloomingdales/BloomingdalesProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","util","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,util,_){var BloomingdalesProductScraper;return BloomingdalesProductScraper=function(_super){__extends(BloomingdalesProductScraper,_super);function BloomingdalesProductScraper(){return BloomingdalesProductScraper.__super__.constructor.apply(this,arguments)}return BloomingdalesProductScraper.prototype.version=3,BloomingdalesProductScraper.prototype.parseSid=function(sid){var id,variant,_ref;return _ref=sid.split("-"),id=_ref[0],variant=_ref[1],{id:id,variant:variant}},BloomingdalesProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www1.bloomingdales.com/shop/product/?ID="+this.productSid.id,this.productSid.variant&&(url+="&upc_ID="+this.productSid.variant),url}},reviewData:{url:function(){return"http://bloomingdales.ugc.bazaarvoice.com/7130aa/"+this.productSid.id+"/reviews.djs?format=embeddedhtml"}}},BloomingdalesProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,matches,primaryImages,regExp;return color=this.productSid.variant?(regExp=new RegExp('"upcID": '+this.productSid.variant+', "inStoreEligible": [^,]*, "color": "([^"]*)"'),regExp.exec(this.resource)[1]):/BLOOMIES.pdp.primaryColor = "([^"]*)";/.exec(this.resource)[1],matches=/BLOOMIES.pdp.primaryImages\[\d*\] = (\{[\S\s]*?\})/.exec(this.resource),primaryImages=JSON.parse(matches[1].replace(/'/g,'"')),this.value("http://images.bloomingdales.com/is/image/BLM/products/"+primaryImages[color]+"?wid=325&qlt=90,0&layer=comp&op_sharpen=0&resMode=sharp2&op_usm=0.7,1.0,0.5,0&fmt=jpeg")})},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var additionalImages,color,image,images,matches,more,primaryImages,regExp;more=this.declarativeScraper("scraper","more"),matches=/BLOOMIES.pdp.primaryImages\[\d*\] = (\{[\S\s]*?\})/.exec(this.resource),primaryImages=JSON.parse(matches[1].replace(/'/g,'"')),matches=/BLOOMIES.pdp.additionalImages\[\d*\] = (\{[\S\s]*?\})/.exec(this.resource),additionalImages=JSON.parse(matches[1].replace(/'/g,'"')),images={};for(color in primaryImages)image=primaryImages[color],images[color]=[image].concat(additionalImages[color].split(","));return more.images=images,this.productSid.variant?(regExp=new RegExp('"upcID": '+this.productSid.variant+', "inStoreEligible": [^,]*, "color": "([^"]*)"'),more.color=regExp.exec(this.resource)[1]):more.color=/BLOOMIES.pdp.primaryColor = "([^"]*)";/.exec(this.resource)[1],this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/write a review<\\\/a>/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/write a review<\\\/a>/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},BloomingdalesProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Bloomingdales/BloomingdalesSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var BloomingdalesSiteInjector;return BloomingdalesSiteInjector=function(_super){__extends(BloomingdalesSiteInjector,_super);function BloomingdalesSiteInjector(){return BloomingdalesSiteInjector.__super__.constructor.apply(this,arguments)}return BloomingdalesSiteInjector.prototype.productListing={mode:2,image:'a img[src^="http://images.bloomingdales.com/is/image/BLM/"]',position:function(el){var parent;return parent=el.parents(".productImages"),parent.length?parent:el},overlayZIndex:999,productSid:function(href,a,img){var matches;matches=href.match(/[?&]ID=(.*?)(?:$|&|#)/);if(matches)return matches[1]}},BloomingdalesSiteInjector.prototype.productPage={mode:2,initPage:function(){var sku,skus,_i,_len,_results;skus=JSON.parse($("body").html().match(/BLOOMIES.pdp.upcmap\["\d*"\] = (\[[^\]]*\])/)[1]),this.map={},this.colorMap={},_results=[];for(_i=0,_len=skus.length;_i<_len;_i++)sku=skus[_i],this.colorMap[sku.color]||(this.colorMap[sku.color]=sku.upcID),_results.push(this.map[""+sku.color+"."+sku.size]=sku.upcID);return _results},productSid:function(){var color,id,size;return id=document.location.href.match(/[?&]ID=(.*?)(?:$|&|#)/)[1],color=$("#colorHeadersDiv .pdpColorDesc").html().trim(),size=$(".pdp_member_size .pdpSizeDesc").html().trim(),id+"-"+this.colorMap[color]},image:"#productImage",attach:"#pdpContainer"},BloomingdalesSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"bloomingdales",hosts:["www1.bloomingdales.com","www.bloomingdales.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.bloomingdales.com/favicon.ico",twoTap:!0},define("sites/Bloomingdales/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ColdwaterCreek/ColdwaterCreekProduct",["scraping/SiteProduct"],function(SiteProduct){var ColdwaterCreekProduct;return ColdwaterCreekProduct=function(_super){__extends(ColdwaterCreekProduct,_super);function ColdwaterCreekProduct(){return ColdwaterCreekProduct.__super__.constructor.apply(this,arguments)}return ColdwaterCreekProduct.prototype.images=function(cb){var imageSizes;return imageSizes=function(image){var fullImage,mediumImage;return mediumImage=image.replace("36x45","422x528"),fullImage=image.replace("36x45","960x1200"),{small:mediumImage,medium:fullImage,large:fullImage,larger:fullImage,full:fullImage}},this.product["with"]("more",function(_this){return function(more){var color,colorImages,firstImage,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],firstImage=colorImages[0].replace(/(\/[A-Z0-9]*_[A-Z0-9]*)_([A-Z0-9]*)/,"$1_S"),images[color]=[imageSizes(firstImage)].concat(function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push(imageSizes(image));return _results}());return cb(images,more.color)}}(this))},ColdwaterCreekProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",materials:"Materials",colors:{title:"Colors",map:function(color){return color.name}},reviews:{obj:reviews}}),cb(widgets)}}(this))},ColdwaterCreekProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ColdwaterCreek/ColdwaterCreekProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var ColdwaterCreekProductScraper;return ColdwaterCreekProductScraper=function(_super){__extends(ColdwaterCreekProductScraper,_super);function ColdwaterCreekProductScraper(){return ColdwaterCreekProductScraper.__super__.constructor.apply(this,arguments)}return ColdwaterCreekProductScraper.prototype.parseSid=function(sid){var color,ensemble,id,_ref;return _ref=sid.split("-"),id=_ref[0],ensemble=_ref[1],color=_ref[2],{id:id,ensemble:ensemble,color:color}},ColdwaterCreekProductScraper.prototype.resources={productPage:{url:function(){var _ref;return"http://www.coldwatercreek.com/product-detail/"+this.productSid.id+"/"+this.productSid.ensemble+"/-.aspx?colorid="+((_ref=this.productSid.color)!=null?_ref:"")}}},ColdwaterCreekProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},reviews:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","reviews")},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var dep;return dep=/tracking\.product\.department = escape\('([^']*)'\)/.exec(this.resource)[1],this.value("http://cdn.coldwatercreek.com/fx/Products/360x450/"+dep+"_"+this.productSid.color+"_S.JPG")})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var more;return more=this.declarativeScraper("scraper","more"),more.color=this.productSid.color,this.value(more)})}},ColdwaterCreekProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ColdwaterCreek/ColdwaterCreekSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var ColdwaterCreekSiteInjector;return ColdwaterCreekSiteInjector=function(_super){__extends(ColdwaterCreekSiteInjector,_super);function ColdwaterCreekSiteInjector(){return ColdwaterCreekSiteInjector.__super__.constructor.apply(this,arguments)}return ColdwaterCreekSiteInjector.prototype.productListing={mode:2,image:'a img[src^="http://cdn.coldwatercreek.com/fx/"]',productSid:function(href,a,img){var color,matches,_ref;matches=/(?:http:\/\/www\.coldwatercreek\.com)?\/product-detail\/([^\/]*)\/([^\/]*)/.exec(href);if(matches){color=(_ref=/http:\/\/cdn\.coldwatercreek\.com\/fx\/products\/[^\/]*\/[^_]*_([^_]*)_[^.]*\.jpg/i.exec(img.attr("src")))!=null?_ref[1]:void 0;if(color)return""+matches[1]+"-"+matches[2]+"-"+color}}},ColdwaterCreekSiteInjector.prototype.productPage={mode:2,test:function(){return $("#pdpLargeMainImg").length},productSid:function(){var color,matches;return matches=/(?:http:\/\/www\.coldwatercreek\.com)?\/product-detail\/([^\/]*)\/([^\/]*)/.exec(document.location.href),color=$("#pdpLargeMainImg").attr("src").match(/http:\/\/cdn\.coldwatercreek\.com\/fx\/products\/[^\/]*\/[^_]*_([^_]*)_[^.]*\.jpg/i)[1],""+matches[1]+"-"+matches[2]+"-"+color},image:"#pdpLargeMainImg",overlay:".mousetrap",attach:"#PgContent"},ColdwaterCreekSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"coldwatercreek",hosts:["www.coldwatercreek.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.coldwatercreek.com/favicon.ico"},define("sites/ColdwaterCreek/config",function(){}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"costco",hosts:["www.costco.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.costco.com/favicon.ico"},define("sites/Costco/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Costco/CostcoProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var CostcoProduct;return CostcoProduct=function(_super){__extends(CostcoProduct,_super);function CostcoProduct(){return CostcoProduct.__super__.constructor.apply(this,arguments)}return CostcoProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,otherImages,urlFirst,urlLast,_i,_len,_ref;otherImages=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],urlFirst="http://images.costco.com/image/media/",urlLast=image.match(/-(.*)/)[1],otherImages.push({small:urlFirst+"150-"+urlLast,medium:urlFirst+"300-"+urlLast,large:urlFirst+"500-"+urlLast,larger:urlFirst+"500-"+urlLast,full:urlFirst+"500-"+urlLast});return cb({"":otherImages},"")}}(this))},CostcoProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{features:"Features",details:"Details",specifications:"Specifications"}),cb(widgets)}}(this))},CostcoProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Costco/CostcoProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var CostcoProductScraper;return CostcoProductScraper=function(_super){__extends(CostcoProductScraper,_super);function CostcoProductScraper(){return CostcoProductScraper.__super__.constructor.apply(this,arguments)}return CostcoProductScraper.testProducts=["11625662"],CostcoProductScraper.prototype.resources={productPage:{url:function(){return"http://www.costco.com/-.product."+this.productSid+".html"}}},CostcoProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(/<title>([^<]*)/,1)},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var match,matches,max,min,multiprice,multipriceMatches,price,prices,_i,_len;matches=this.resource.match(/<input type="hidden" name="price"[\s]*value="\$([^"]*)/);if(matches[1]!=="0.00")return this.value(matches[1]);multiprice=this.resource.match(/<head>([\S\s]*?)<\/head>/),multipriceMatches=multiprice[1].match(/"price" : process\("([^"]+)/g),prices=[];for(_i=0,_len=multipriceMatches.length;_i<_len;_i++)match=multipriceMatches[_i],price=match.match(/"price" : process\("([^"]+)/),prices.push(parseFloat(atob(price[1])));return max=Math.max.apply(Math,prices),min=Math.min.apply(Math,prices),this.value(min+" - $"+max)})},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<img id="Image1" src="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var content,images,match,matches,price,specMatches,specifications,switches,title,value,xmtUrl,_i,_len;switches={images:!0,features:!0,details:!0,specifications:!0,shipping:!0,rating:!0,ratingCount:!0,originalPrice:!0},value={},switches.rating&&(matches=this.resource.match(/<meta itemprop="ratingValue" content="([^"]+)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/<meta itemprop="reviewCount" content="([^"]+)/),matches&&(value.reviewCount=matches[1])),switches.features&&(matches=this.resource.match(/<div class="features">([\S\s]*?)<\/div>/),value.features=matches[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ")),switches.details&&(matches=this.resource.match(/<div id="product-tab1"([\S\s]*?)<div id="product-tab2"/),value.details='<div id="product-tab1"'+matches[1]),switches.images&&(images=[],xmtUrl=this.resource.match(/src="(http:\/\/images\.costco\.com\/image\/media\/[\S\s]*?\.xmt)"/)[1],this.execBlock(function(){return this.get(xmtUrl,function(response){var match,num,_i,_len;matches=response.match(/image: '([^']*)/g);for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],num=match.match(/image: '([^']*)/),images.push("http://images.costco.com/image/media/350-"+num[1]+".jpg");return this.done(!0),this.value(value)}),null}),value.images=images);if(switches.specifications){specifications={},matches=this.resource.match(/<div id="product-tab2"([\S\s]*?)<div id="product-tab3"/),specMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g);for(_i=0,_len=specMatches.length;_i<_len;_i++)match=specMatches[_i],title=match.match(/<span class="bold">([\S\s]*?):<\/span>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),content=match.match(/<\/span>([\S\s]*?)<\/li>/)[1].replace(/^<br\/>+|<br\/>+$/gm,"").replace(/\n\r/g," ").replace(/^\s+|\s+$/gm,""),specifications[title]=content;value.specifications=specifications}return switches.shipping&&(matches=this.resource.match(/<div id="product-tab3"([\S\s]*?)<div id="product-tab4"/),value.shipping='<div id="product-tab3"'+matches[1]),switches.originalPrice&&(matches=this.resource.match(/<div class="online-price">([\S\s]*?)<\/div>/),matches&&(price=matches[1].match(/<span class="currency">\$([\S\s]*?)<\/span>/),value.originalPrice=price[1])),this.value(value)})}},CostcoProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Costco/CostcoSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var CostcoSiteInjector;return CostcoSiteInjector=function(_super){__extends(CostcoSiteInjector,_super);function CostcoSiteInjector(){return CostcoSiteInjector.__super__.constructor.apply(this,arguments)}return CostcoSiteInjector.prototype.productListing={imgSelector:'a:not([href="#"]) img[src^="http://images.costco.com/image/media/"]',productSid:function(href,a,img){var match,name,sid,_ref,_ref1;return name=(_ref=href.match(/^http:\/\/www\.costco\.com\/[^\.]*?\.product\.([^\.]+)/))!=null?_ref[1]:void 0,sid=name,sid||(href=unescape(href),match=(_ref1=/(http:\/\/www\.costco.com\/.*?)(?:&|$)/.exec(href))!=null?_ref1[1]:void 0,match&&(sid=match)),sid}},CostcoSiteInjector.prototype.productPage={mode:2,test:function(){return $("#large_images").length},productSid:function(){return document.location.href.match(/^http:\/\/www\.costco\.com\/[^\.]*?\.product\.([^\.]+)/)[1]},image:"#large_images li img",attach:".gallery_box.thumbnail-viewer"},CostcoSiteInjector}(DataDrivenSiteInjector)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/CVS/CVSProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var CVSProductScraper;return CVSProductScraper=function(_super){__extends(CVSProductScraper,_super);function CVSProductScraper(){return CVSProductScraper.__super__.constructor.apply(this,arguments)}return CVSProductScraper.testProducts=["681325"],CVSProductScraper.prototype.resources={productPage:{url:function(){return"http://www.cvs.com/shop/product-detail/-?skuId="+this.productSid}}},CVSProductScraper.prototype.properties={title:{resource:"productPage",scraper:new PatternResourceScraper(new RegExp(/<h1 class="prodName">([^<]*)/),1)},price:{resource:"productPage",scraper:new PatternResourceScraper([[new RegExp(/data-salePrice="\$([^"]*)/),1],[new RegExp(/<span itemprop="price">[\s]+\$([^<]*)/),1]])},image:{resource:"productPage",scraper:new PatternResourceScraper(new RegExp(/<img itemprop="image" src="([^"]*)/),1)},more:{resource:"productPage",scraper:new ScriptedResourceScraper(function(){var col,content,match,matches,overview,overviewMatches,price,specMatches,specs,switches,text,title,value,_i,_j,_len,_len1;switches={overview:!1,rating:!1,reviewCount:!1,originalPrice:!0},value={};if(switches.overview){overview=[],matches=this.resource.match(/<div class="productIngredients" id="prodDesc"([\S\s]*?)<\/div>/),overviewMatches=matches[1].match(/<p([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p([\S\s]*?)<\/p>/),overview.push(text[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));specs={},specMatches=matches[1].match(/<li([^<]+)/g);if(specMatches){for(_j=0,_len1=specMatches.length;_j<_len1;_j++)match=specMatches[_j],col=match.match(/(:)/),col?(title=match.match(/<li>([^:]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),content=match.match(/:([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),specs[title]=content):(title=match.match(/<li>([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),specs[title]=null);overview.push(specs)}value.overview=overview}return switches.originalPrice&&(matches=this.resource.match(/<div class="priceStrike">([\S\s]*?)<\/div>/),matches&&(price=matches[1],value.originalPrice=price.match(/\$([\S\s]*)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),this.value(value)})}},CVSProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/CVS/CVSSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var CVSSiteInjector;return CVSSiteInjector=function(_super){__extends(CVSSiteInjector,_super);function CVSSiteInjector(){return CVSSiteInjector.__super__.constructor.apply(this,arguments)}return CVSSiteInjector.prototype.siteName="CVS",CVSSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.cvs\.com\/shop\/product-detail\/.*?\?skuId=([^&]+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($(".productImgGallery").length)return currentSid=function(){return/^http:\/\/www\.cvs\.com\/shop\/product-detail\/.*?\?skuId=([^&]+)/.exec(document.location.href)[1]},_this.waitFor(".productImage img",function(){return _this.initProductEl($(".productImage img"),{productSid:currentSid()})})})}}(this))},CVSSiteInjector}(SiteInjector)}}}),{hasProductClass:!0,hosts:["agoraext.local","baggg.it","agora.local","ext.agora.dev"],productUrl:function(sid){return"#"+sid}},define("sites/Dev/config",function(){}),define("sites/Dev/DevProduct",[],function(){var DevProduct;return DevProduct=function(){function DevProduct(product){this.product=product}return DevProduct.prototype.previewLayout="generic",DevProduct.prototype.images=function(cb){var i;return cb({color:function(){var _i,_results;_results=[];for(i=_i=0;_i<=10;i=++_i)_results.push(this.product.get("image"));return _results}.call(this)})},DevProduct}()}),define("sites/Dev/DevProductScraper",[],function(){var DevProductScraper;return DevProductScraper=function(){function DevProductScraper(site,productSid,background){var properties;this.site=site,this.productSid=productSid,this.background=background,properties=this.properties,this.properties={},this.product=DevProductScraper.products[this.productSid],["image","title","price"].forEach(function(_this){return function(name){return _this.properties[name]={scrape:function(cb){return cb(this.product[name])},productSid:productSid,product:_this.product}}}(this))}return DevProductScraper.products={SID1:{image:"http://agoraext.dev/resources/dev/519sTkNOmIL._AA300_.jpg",title:"PlayStation 3 This name is really long so that I can see it wrap",price:"$199.00"},SID2:{image:"http://agoraext.dev/resources/dev/416WlFamYGL._AA300_.jpg",title:"PlayStation 3 Controller",price:"$199.00"},SID3:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Metal Gear Solid",price:"$199.00"},SID4:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 4",price:"$199.00"},SID5:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 5",price:"$199.00"},SID6:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 6",price:"$199.00"},SID7:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 7",price:"$199.00"},SID8:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 8",price:"$199.00"},SID9:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 9",price:"$199.00"},SID10:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 10",price:"$199.00"},SID11:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 11",price:"$199.00"},SID12:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 12",price:"$199.00"},SID13:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 13",price:"$199.00"},SID14:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 14",price:"$199.00"}},DevProductScraper}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Dev/DevSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView","views/compare/CompareView"],c:function(){var DevSiteInjector;return DevSiteInjector=function(_super){__extends(DevSiteInjector,_super);function DevSiteInjector(){return DevSiteInjector.__super__.constructor.apply(this,arguments)}return DevSiteInjector.prototype.siteName="Dev",DevSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var shoppingBarView;return $("#products li").each(function(i,el){var sid;return sid="SID"+(i+1),_this.products($(el).find("img"),{siteName:_this.siteName,productSid:sid})}),shoppingBarView=new ShoppingBarView(_this.contentScript),shoppingBarView.el.appendTo(document.body),shoppingBarView.represent()}}(this))},DevSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"diapers",hosts:["www.diapers.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.diapers.com/favicon.ico"},define("sites/Diapers/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Diapers/DiapersProduct",["scraping/SiteProduct"],function(SiteProduct){var DiapersProduct;return DiapersProduct=function(_super){__extends(DiapersProduct,_super);function DiapersProduct(){return DiapersProduct.__super__.constructor.apply(this,arguments)}return DiapersProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=[],cb({"":images},"")}}(this))},DiapersProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Diapers/DiapersProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var DiapersProductScraper;return DiapersProductScraper=function(_super){__extends(DiapersProductScraper,_super);function DiapersProductScraper(){return DiapersProductScraper.__super__.constructor.apply(this,arguments)}return DiapersProductScraper.prototype.resources={productPage:{url:function(){return"http://www.diapers.com/p/--"+this.productSid}},reviewPage:{url:function(){var str;return str=this.productSid+"","http://www.diapers.com/amazon_reviews/"+str.substr(0,2)+"/"+str.substr(2,2)+"/"+str.substr(4)+"/mosthelpful_Default.html"}}},DiapersProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},more:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","more")},reviews:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var obj,reviews;return reviews=this.declarativeScraper("scraper","reviews"),obj={reviews:reviews},this.execBlock(function(){return this.getResource("reviewPage",function(resource){return obj.amazonReviews=this.declarativeScraper("amazonReviews","reviews",resource),this.value(obj),this.done(!0)}),null}),this.value(obj)})}},DiapersProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Diapers/DiapersSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var DiapersSiteInjector;return DiapersSiteInjector=function(_super){__extends(DiapersSiteInjector,_super);function DiapersSiteInjector(){return DiapersSiteInjector.__super__.constructor.apply(this,arguments)}return DiapersSiteInjector.prototype.parseUrl=function(url){var _ref;return(_ref=/^http:\/\/www\.diapers\.com\/p\/.*-(\d*)$/.exec(url))!=null?_ref[1]:void 0},DiapersSiteInjector.prototype.productListing={mode:2,image:'a[href^="/p/"] img:not(#pdpMainImageImg)'},DiapersSiteInjector.prototype.productPage={imgEl:"#pdpMainImageImg",overlayEl:".MagicZoomPup"},DiapersSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"ebay",hosts:["www.ebay.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.ebay.com/favicon.ico",productUrl:function(sid){return""}},define("sites/Ebay/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Ebay/EbayProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var EbayProductScraper;return EbayProductScraper=function(_super){__extends(EbayProductScraper,_super);function EbayProductScraper(){return EbayProductScraper.__super__.constructor.apply(this,arguments)}return EbayProductScraper.testProducts=[],EbayProductScraper.prototype.resources={productPage:{url:function(){return"http://www.ebay.com/itm/-/"+this.productSid}}},EbayProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta\s+property="og:title"\s+content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<span\s+class="notranslate"\s+id="prcIsum"\s+itemprop="price"\s+style="[^"]*">US \$([^<]*)/),1],[new RegExp(/<span class="notranslate" id="prcIsum_bidPrice" itemprop="price">US \$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<img id="icImg" class="[^"]*" itemprop="image" src="([^"]*)/),1)}},EbayProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Ebay/EbaySiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var EbaySiteInjector;return EbaySiteInjector=function(_super){__extends(EbaySiteInjector,_super);function EbaySiteInjector(){return EbaySiteInjector.__super__.constructor.apply(this,arguments)}return EbaySiteInjector.prototype.siteName="Ebay",EbaySiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts;_this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),window.initProducts=initProducts=function(){var a,href,img,matches,src,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],src=$(img).attr("src"),/^http:\/\/thumbs\d*.ebaystatic\.com/.exec(src)||/^http:\/\/i\.ebayimg\.com/.exec(src)?(a=$(img).parents("a"),href=a.prop("href"),matches=/http:\/\/www\.ebay\.com\/itm\/[^\/]+\/(\d+)/.exec(href),matches?_results.push(_this.initProductEl(img,{productSid:matches[1]})):(matches=/http:\/\/www\.ebay\.com\/itm\/ws\/eBayISAPI\.dll\?ViewItem&item=(\d+)/.exec(href),matches?_results.push(_this.initProductEl(img,{productSid:matches[1]})):_results.push(void 0))):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3);if($("#Body").attr("itemtype")==="http://schema.org/Product")return _this.waitFor("#icImg",function(el){return _this.initProductEl(el,{productSid:$("#vi-accrd-itm-det-hldr").text().match(/Item number:(\d+)/)[1]})})}}(this))},EbaySiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"etsy",hosts:["www.etsy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.etsy.com/favicon.ico",productUrl:function(sid){return"http://www.etsy.com/listing/"+sid}},define("sites/Etsy/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Etsy/EtsyProduct",["scraping/SiteProduct"],function(SiteProduct){var EtsyProduct;return EtsyProduct=function(_super){__extends(EtsyProduct,_super);function EtsyProduct(product){this.product=product}return EtsyProduct.prototype.previewLayout="generic",EtsyProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,images,_i,_len,_ref;images={},images[""]=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],images[""].push({small:image.largeUrl,medium:image.fullUrl,large:image.fullUrl,larger:image.fullUrl,full:image.fullUrl});return cb(images,"")}}(this))},EtsyProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return console.debug(more),widgets=_this.genWidgets(more,{options:"Options",description:"Description",materials:"Materials",tags:"Tags"}),cb(widgets)}}(this))},EtsyProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Etsy/EtsyProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,_){var EtsyProductScraper;return EtsyProductScraper=function(_super){__extends(EtsyProductScraper,_super);function EtsyProductScraper(){return EtsyProductScraper.__super__.constructor.apply(this,arguments)}return EtsyProductScraper.prototype.resources={productPage:{url:function(){return"http://www.etsy.com/listing/"+this.productSid}}},EtsyProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(/<span itemprop="name">([^<]*)<\/span>/,1)},price:{resource:"productPage",scraper:PatternResourceScraper(/<span class="currency-value">([^<]+)<\/span>/,1)},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var image,matches;return matches=this.resource.match(/<li id="image-0"([\S\s]*?)<\/li>/),image=matches[1].match(/src='([^']*)'/),this.value(image[1])})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var about,category,clean,combined,date,description,first,fullUrl,imageMatches,images,largeUrl,match,matches,materialMatches,materials,occasion,optionName,optionNameMatches,options,rowMatches,seller,shipping,single,style,switches,tag,tagMatches,tags,to,toMatches,value,vari,variationMatches,variations,who,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_m,_n;switches={images:!0,description:!0,about:!1,style:!1,occasion:!1,who:!1,tags:!0,materials:!0,date:!1,shipping:!1,seller:!1,options:!0,category:!1},value={};if(switches.images){images=[],matches=this.resource.match(/<div id="image-main">([\S\s]*?)<\/div>/),imageMatches=matches[1].match(/<li ([^>]*)>/g);for(_i=0,_len=imageMatches.length;_i<_len;_i++)match=imageMatches[_i],fullUrl=match.match(/data-full-image-href="([^"]*)"/)[1],largeUrl=match.match(/data-large-image-href="([^"]*)"/)[1],images.push({fullUrl:fullUrl,largeUrl:largeUrl});value.images=images}switches.description&&(description=this.resource.match(/<div id="description-text">([\S\s]*?)<\/div>/),value.description=description[1].replace(/\s+/g," ").replace(/^\s+|\s+$/g,"")),switches.about&&(about=this.resource.match(/<h3>About this item<\/h3>\s*<p>([\S\s]*?)<\/p>/),value.about=about[1].replace(/\s+/g," ").replace(/^\s+|\s+$/g,"")),switches.style&&(style=this.resource.match(/<h3>Style<\/h3>\s*<p>([\S\s]*?)<\/p>/),value.style=style[1]),switches.occasion&&(occasion=this.resource.match(/<h3>Occasion<\/h3>\s*<p>([\S\s]*?)<\/p>/),value.occasion=occasion[1]),switches.who&&(who=this.resource.match(/<h3>Who it\&\#8217\;s for<\/h3>\s*<p>([\S\s]*?)<\/p>/),value.who=who[1]);if(switches.tags){tags=[],matches=this.resource.match(/<div id="tags"([\S\s]*?)<\/div>/);if(matches){tagMatches=matches[1].match(/<a href="[^"]*">([^<]*)<\/a>/g);for(_j=0,_len1=tagMatches.length;_j<_len1;_j++)match=tagMatches[_j],tag=match.match(/<a href="[^"]*">([^<]*)<\/a>/)[1],tags.push(tag);value.tags=tags}}switches.materials&&(materials=[],matches=this.resource.match(/<div id="item-overview">([\S\s]*?)<\/div>/),materialMatches=matches[1].match(/<li>Materials: ([\S\s]*?)<\/li>/),materialMatches&&(materialMatches=materialMatches[1].match(/<span[^>]*>([\S\s]*?)<\/span>/),value.materials=materialMatches[1].split(", "))),switches.date&&(date=this.resource.match(/<li>Listed on ([\S\s]*?)<\/li>/),value.date=date[1]);if(switches.shipping){shipping={from:this.resource.match(/<li>Ships [\S\s]*? from ([^<]*)<\/li>/)[1]},shipping.rates={},matches=this.resource.match(/<div class="section" id="item-shipping">([\S\s]*?)<\/div>/),console.log(matches[1]),toMatches=matches[1].match(/<td class="ship-to">([^<]*)<\/td>\s*<td class="ship-cost">\s*<span class="currency-symbol">[^<]*<\/span><span class="currency-value">([^<]*)<\/span>\s*<span class="currency-code">[^<]*<\/span>\s*<\/td>\s*<td class="ship-with">\s*<span class="currency-symbol">[^<]*<\/span>\s*<span class="currency-value">([^<]*)<\/span>/g);for(_k=0,_len2=toMatches.length;_k<_len2;_k++)match=toMatches[_k],rowMatches=match.match(/<td class="ship-to">([^<]*)<\/td>\s*<td class="ship-cost">\s*<span class="currency-symbol">[^<]*<\/span><span class="currency-value">([^<]*)<\/span>\s*<span class="currency-code">[^<]*<\/span>\s*<\/td>\s*<td class="ship-with">\s*<span class="currency-symbol">[^<]*<\/span>\s*<span class="currency-value">([^<]*)<\/span>/),to=match.match(/<td class="ship-to">([^<]*)<\/td>/)[1].replace(/\s+/g," ").replace(/^\s+|\s+$/g,""),single=match.match(/<span class="currency-value">([^<]*)<\/span>/)[1],combined=rowMatches[3],shipping.rates[to]={single:single,combined:combined};value.shipping=shipping}switches.seller&&(seller=this.resource.match(/<input type="hidden" value="([^"]*)" name="shopname" \/>/),value.seller=seller[1]);if(switches.options){options={},matches=this.resource.match(/<div class="item-variation-options clear">([\S\s]*?)<div id="item-overview">/),optionNameMatches=matches[1].match(/<div class="item-variation-option clear">([\S\s]*?)<\/div>/g);for(_l=0,_len3=optionNameMatches.length;_l<_len3;_l++){match=optionNameMatches[_l],optionName=match.match(/<label class="[^"]*">([^<]*)<\/label>/),variationMatches=[],variations=match.match(/<option[\s]*value[^>]*>([^<]*)<\/option>/g);for(_m=0,_len4=variations.length;_m<_len4;_m++)vari=variations[_m],clean=vari.match(/<option[\s]*value[^>]*>([^<]*)<\/option>/)[1].trim(),variationMatches.push(clean);options[optionName[1]]=variationMatches}value.options=options,console.log(options.Size),console.log(options.Color)}if(switches.category){first=this.resource.match(/<ul id="breadcrumbs" class="clear">([\S\s]*?)<\/ul>/),matches=first[1].match(/<a href="[^"]*">([\S\s]*?)<\/a>/g);for(_n=0,_len5=matches.length;_n<_len5;_n++)match=matches[_n],category=match.match(/<a href="[^"]*">([\S\s]*?)<\/a>/);value.category=category[1]}return this.value(value)})}},EtsyProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Etsy/EtsySiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var EtsySiteInjector;return EtsySiteInjector=function(_super){__extends(EtsySiteInjector,_super);function EtsySiteInjector(){return EtsySiteInjector.__super__.constructor.apply(this,arguments)}return EtsySiteInjector.prototype.siteName="Etsy",EtsySiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var delayStartUpdateProducts,initProduct,initProducts,selector,startUpdateProducts,timerId,updateProducts;return _this.bottomBarView=new ShoppingBarView(_this.contentScript),_this.bottomBarView.el.appendTo(document.body),_this.bottomBarView.represent(),initProduct=function(el,url,mousedover){var matches;return matches=url.match("/listing/(\\d+)/"),_this.products(el,{siteName:_this.siteName,productSid:matches[1]},{hover:mousedover,overlayPosition:"topLeft"})},selector='a[href^="/listing/"] img, a[href^="http://www.etsy.com/listing/"] img',initProducts=function(){return $(selector).each(function(){if(!$(this).data("agora")&&!$(this).parents(".-agora").length)return initProduct(this,$(this).parents("a").attr("href"),!1)})},$(initProducts),document.location.href.match("/listing/(\\d+)/")&&initProduct('li[id="image-0"] img',document.location.href),timerId=null,updateProducts=function(){if($("div.listing-wrap").length)return initProducts(),clearInterval(timerId)},startUpdateProducts=function(){return timerId=setInterval(updateProducts,300)},startUpdateProducts(),delayStartUpdateProducts=function(){return setTimeout(startUpdateProducts,10)},$("body").delegate("#feed-new-nav a","mouseup",delayStartUpdateProducts),$("body").delegate("#feed-filters a","mouseup",delayStartUpdateProducts),$("body").delegate("#feed-filters input","mouseup",delayStartUpdateProducts),$("body").delegate(".pager a","mouseup",delayStartUpdateProducts),$('#feed-shop-location-search input[type="text"]').keyup(function(e){if(e.keyCode===13)return delayStartUpdateProducts()}),$("#price-filter").change(delayStartUpdateProducts),$("#ship_to").change(delayStartUpdateProducts),!0}}(this))},EtsySiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"express",hosts:["www.express.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.express.com/favicon.ico"},define("sites/Express/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Express/ExpressProduct",["scraping/SiteProduct","util","underscore"],function(SiteProduct,util,_){var ExpressProduct;return ExpressProduct=function(_super){__extends(ExpressProduct,_super);function ExpressProduct(){return ExpressProduct.__super__.constructor.apply(this,arguments)}return ExpressProduct.prototype.variantImage=function(variant,cb){return this.product["with"]("more",function(_this){return function(more){var _ref;return more?cb((_ref=more.images)!=null?_ref[variant.Color][0]:void 0):cb()}}(this))},ExpressProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],images[color]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}();return cb(images,more.color)}}(this))},ExpressProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",details:"Details",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews,map:{review:"content"}}}),cb(widgets)}}(this))},ExpressProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Express/ExpressProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","util","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,util,_){var ExpressProductScraper;return ExpressProductScraper=function(_super){__extends(ExpressProductScraper,_super);function ExpressProductScraper(){return ExpressProductScraper.__super__.constructor.apply(this,arguments)}return ExpressProductScraper.prototype.resources={productPage:{url:function(){return"http://www.express.com/catalog/product_detail.jsp?productId="+this.productSid+"&categoryId=cat1040005"}},reviewData:{url:function(){return"http://express.ugc.bazaarvoice.com/6549/"+this.productSid+"/reviews.djs?format=embeddedhtml"}}},ExpressProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var more;return more=this.declarativeScraper("scraper","more"),this.execBlock(function(){return this.post("http://www.express.com/catalog/gadgets/color_size_gadget.jsp",{productId:this.productSid.value,categoryId:"cat1040005"},function(response){var color,colorMatch,colorMatches,colors,images,_fn,_i,_j,_len,_len1,_ref,_ref1;more.color=(_ref=response.match(/<span class="selectedColor">([^<]*)/))!=null?_ref[1]:void 0,colors=[],colorMatches=this.matchAll(response,/<img class="cat-pro-swatch[^"]*" src="([^"]*)" width="51" height="34" alt="([^"]*)" \/>/);for(_i=0,_len=colorMatches.length;_i<_len;_i++)colorMatch=colorMatches[_i],colors.push({id:colorMatch[1].match(/([^\/]*)_s\?/)[1],name:colorMatch[2],swatch:"http:"+colorMatch[1]});more.colors=colors,more.sizes=this.matchAll(response,/<option class="availableSize" value="([^"]*)/,1),images={},more.images=images,_ref1=more.colors,_fn=function(_this){return function(color){return _this.execBlock(function(){return this.get("http://images.express.com/is/image/expressfashion/"+color.id+"?req=set,json",function(response){var obj;return obj=JSON.parse(response.match(/^s7jsonResponse\((.*?),""\);$/)[1]),images[color.name]=_.map(obj.set.item,function(i){return"http://images.express.com/is/image/"+i.i.n}),this.value(more),this.done(!0)}),null})}}(this);for(_j=0,_len1=_ref1.length;_j<_len1;_j++)color=_ref1[_j],_fn(color);return this.value(more),this.done()}),null}),this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/Be the first to<\\\/span>/,0,function(){return 0}],[/BVRRRatingOverall_Rating_Summary_1.*?alt=\\"([.\d]*) out of 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/Be the first to<\\\/span>/,0,function(){return 0}],[/Read all <span class=\\"BVRRNumber\\">([\d,]*)<\\\/span> review/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) out of 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},ExpressProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Express/ExpressSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var ExpressSiteInjector,parseUrl;return parseUrl=function(url){var _ref,_ref1,_ref2;return(_ref=(_ref1=url.match(/[?&]productId=(\d*)/))!=null?_ref1[1]:void 0)!=null?_ref:(_ref2=url.match(/\/pro\/(\d*)/))!=null?_ref2[1]:void 0},ExpressSiteInjector=function(_super){__extends(ExpressSiteInjector,_super);function ExpressSiteInjector(){return ExpressSiteInjector.__super__.constructor.apply(this,arguments)}return ExpressSiteInjector.prototype.productListing={image:'a img[src*="images.express.com/is/image/expressfashion/"]:not([src*=swatch])',productSid:function(href,a,img){return parseUrl(href)}},ExpressSiteInjector.prototype.productPage={mode:2,productSid:function(){return parseUrl(document.location.href)},image:'#flyout img[src^="http://images.express.com/is/image/expressfashion"]',attach:"#glo-body-content",position:"#flyout",overlay:"#flyout",hideOverlay:!1,zIndex:999,variant:function(){if($(".selectedColor").text())return{Color:$(".selectedColor").text()}}},ExpressSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"fab",hosts:["fab.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://fab.com/favicon.ico"},define("sites/Fab/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fab/FabProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var FabProduct;return FabProduct=function(_super){__extends(FabProduct,_super);function FabProduct(){return FabProduct.__super__.constructor.apply(this,arguments)}return FabProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,otherImages,urlFirst,urlLast,_i,_len,_ref;otherImages=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],urlFirst=image.match(/([^-]*)/)[1],urlLast=image.match(/([^-]*)-([^-]*)-(.*)/)[3],otherImages.push({small:urlFirst+"-70x70-"+urlLast,medium:urlFirst+"-90x90-"+urlLast,large:urlFirst+"-300x300-"+urlLast,larger:urlFirst+"-610x610-"+urlLast,full:urlFirst+"-original-"+urlLast});return cb({"":otherImages},"")}}(this))},FabProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{overview:"Overview",details:"Details"}),cb(widgets)}}(this))},FabProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fab/FabProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var FabProductScraper;return FabProductScraper=function(_super){__extends(FabProductScraper,_super);function FabProductScraper(){return FabProductScraper.__super__.constructor.apply(this,arguments)}return FabProductScraper.testProducts=["452728"],FabProductScraper.prototype.resources={productPage:{url:function(){return"http://fab.com/product/"+this.productSid}}},FabProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<h1 id="productTitle" itemprop="name">([^<]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<span[\s]+itemprop="price">[\s]*\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var author,authorBio,authorMatches,authorNames,bioMatch,bioMatches,content,count,details,entry,first,firstList,firstListMatches,image,imageMatches,images,item,last,match,matches,middle,name,newMatches,overview,overviewMatches,par,parMatches,paras,ratUrl,revs,secondList,secondListMatches,shipping,shippingMatches,switches,text,title,value,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_len6,_len7,_m,_n,_o,_p;switches={images:!0,overview:!0,details:!0,rating:!0,ratingCount:!0,originalPrice:!0,reviews:!1,shipping:!1},value={},switches.reviews&&(ratUrl="http://fab.com/product-review/get-top-reviews/"+this.productSid+"/",revs=[],this.execBlock(function(){return this.get(ratUrl,function(response){var reviews;return value.reviews=response,reviews=JSON.parse(response),this.done(!0),this.value(value)}),null}));if(switches.overview){overview=[],matches=this.resource.match(/itemprop="description">([\S\s]*?)<\/div>/),overviewMatches=matches[1].match(/<p>([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p>([\S\s]*?)<\/p>/),overview.push(text[1]);value.overview=overview}if(switches.details){details=[],matches=this.resource.match(/<div class="desc">([\S\s]*?)<\/div>/),parMatches=matches[1].match(/<p>([\S\s]*?)<\/p>/g);if(parMatches){paras=[];for(_j=0,_len1=parMatches.length;_j<_len1;_j++)match=parMatches[_j],par=match.match(/<p>([\S\s]*?)<\/p>/)[1],paras.push(par);details.push(paras)}firstListMatches=matches[1].match(/<li>([\S\s]*?)<\/li>/g);if(firstListMatches){firstList=[];for(_k=0,_len2=firstListMatches.length;_k<_len2;_k++)match=firstListMatches[_k],entry=match.match(/<li><span[^<]+>([\S\s]*?)<\/span>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br\/>+|<br\/>+$/gm,"").replace(/^<br \/>+|<br \/>+$/gm,""),firstList.push(entry);details.push(firstList)}newMatches=this.resource.match(/<ul class="tblList" id="tblListTgl">([\S\s]*?)<\/ul>/);if(newMatches){secondListMatches=newMatches[1].match(/<div class="productAttr">[^<]+<\/div>[\s]*?<div[^>]+>([^<]+)<\/div>/g),secondList={};for(_l=0,_len3=secondListMatches.length;_l<_len3;_l++)match=secondListMatches[_l],title=match.match(/<div class="productAttr">([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),content=match.match(/<div class="productAttr">[^<]+<\/div>[\s]*?<div[^>]+>([^<]+)<\/div>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br\/>+|<br\/>+$/gm,""),secondList[title]=content;details.push(secondList)}value.details=details}if(switches.author){author={},authorNames=[],matches=this.resource.match(/<ul class="contributors([\S\s]*?)<\/ul>/),authorMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g),count=0;for(_m=0,_len4=authorMatches.length;_m<_len4;_m++)item=authorMatches[_m],count>0&&(name=item.match(/<li([\S\s]*?)<\/li>/)[1],authorNames.push(name.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),count++;author.names=authorNames,authorBio=[],bioMatch=this.resource.match(/<div class="basic-info([\S\s]*?)<\/section>/),bioMatches=bioMatch[1].match(/<p>([\S\s]*?)<\/p>/g);for(_n=0,_len5=bioMatches.length;_n<_len5;_n++)match=bioMatches[_n],par=match.match(/<p>([\S\s]*?)<\/p>/)[1],authorBio.push(par);author.bio=authorBio,value.author=author}switches.rating&&(matches=this.resource.match(/<meta itemprop="rating" content="([^"]+)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/<meta itemprop="votes" content="([^"]+)/),matches&&(value.reviewCount=matches[1])),switches.originalPrice&&(matches=this.resource.match(/"original_price":"([\S\s]*?)",/),matches&&(value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<ul id="moreIndvProdImages"([\S\s]*?)<\/ul>/),imageMatches=matches[1].match(/src="([^"]+)/g);for(_o=0,_len6=imageMatches.length;_o<_len6;_o++)match=imageMatches[_o],image=match.match(/src="([^"]+)/),first=image[1].match(/\/\/(.*?)70x70/)[1],last=image[1].match(/70x70(.*)/)[1],middle="610x610",image=first+middle+last,images.push("http://"+image);value.images=images}if(switches.shipping){shipping={},matches=this.resource.match(/<ul class="tblList" id="shippingDetails"([\S\s]*?)<\/ul>/),shippingMatches=matches[1].match(/<label>[^<]+<\/label>[\s]*?<span[^>]+>([\S\s]*?)<\/span>/g);for(_p=0,_len7=shippingMatches.length;_p<_len7;_p++)match=shippingMatches[_p],title=match.match(/<label>([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),content=match.match(/<label>[^<]+<\/label>[\s]*?<span[^>]+>([\S\s]*?)<\/span>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br\/>+|<br\/>+$/gm,""),shipping[title]=content;value.shipping=shipping}return this.value(value)})}},FabProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fab/FabSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var FabSiteInjector;return FabSiteInjector=function(_super){__extends(FabSiteInjector,_super);function FabSiteInjector(){return FabSiteInjector.__super__.constructor.apply(this,arguments)}return FabSiteInjector.prototype.productListing={imgSelector:'a[href^="http://fab.com/product/"] img, a[href^="/product/"] img',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/fab\.com\/product\/.*-(\d*)/))!=null?_ref[1]:void 0,name}},FabSiteInjector.prototype.productPage={mode:2,test:function(){return $('meta[property="og:type"]').attr("content")==="fab_graph_dev:product"},productSid:function(){return document.location.href.match(/^http:\/\/fab\.com\/product\/.*-(\d*)/)[1]},image:".productPgMainImage",attach:"#productpgSliderWrap"},FabSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"fancy",hosts:["fancy.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://fancy.com/favicon.ico"},define("sites/Fancy/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fancy/FancyProduct",["scraping/SiteProduct"],function(SiteProduct){var FancyProduct;return FancyProduct=function(_super){__extends(FancyProduct,_super);function FancyProduct(product){this.product=product}return FancyProduct.prototype.previewLayout="generic",FancyProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,otherImages,urlFirst,urlLast,_i,_len,_ref;otherImages=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],urlFirst=image.match(/([\S\s]*?)commerce/)[1],urlLast=image.match(/commerce\/([\S\s]*?)\/(.*)/)[2],otherImages.push({small:urlFirst+"commerce/200/"+urlLast,medium:urlFirst+"commerce/310/"+urlLast,large:"http://resize-ec1.thefancy.com/resize/500/thefancy/commerce/original/"+urlLast,larger:"http://resize-ec1.thefancy.com/resize/700/thefancy/commerce/original/"+urlLast,full:urlFirst+"commerce/original/"+urlLast});return cb({"":otherImages},"")}}(this))},FancyProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return console.debug(more),widgets=_this.genWidgets(more,{description:"Description",select:"Options",reacts:"Reacts"}),cb(widgets)}}(this))},FancyProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fancy/FancyProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var FancyProductScraper;return FancyProductScraper=function(_super){__extends(FancyProductScraper,_super);function FancyProductScraper(){return FancyProductScraper.__super__.constructor.apply(this,arguments)}return FancyProductScraper.testProducts=["405991157672181989"],FancyProductScraper.prototype.resources={productPage:{url:function(){return"http://fancy.com/things/"+this.productSid}}},FancyProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="fancy:name" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<meta property="fancy:price" content="\$([^"]*)/),1],[new RegExp(/<span id="itemprice" style="display:none">\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var content,image,imageMatches,images,match,matches,name,num,overviewMatches,quantity,select,switches,value,_i,_j,_k,_len,_len1,_len2;switches={images:!0,description:!0,reacts:!0,select:!0,quantity:!0,shipping:!1},value={},switches.description&&(matches=this.resource.match(/<meta property="og:description" content="([^"]*)/),value.description=matches[1]);if(switches.select){select={},matches=this.resource.match(/<select name="option_id" id="option_id">([\S\s]*?)<\/select>/),overviewMatches=matches[1].match(/<option[^>]*>([^<]*)<\/option>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],name=match.match(/<option[^>]*>([^<]*)<\/option>/)[1],content=match.match(/value="([^"]*)/)[1],select[name]=content;value.select=select}if(switches.quantity){quantity={},matches=this.resource.match(/<select name="quantity" id="quantity">([\S\s]*?)<\/select>/),overviewMatches=matches[1].match(/<option[^>]*>([^<]*)<\/option>/g);for(_j=0,_len1=overviewMatches.length;_j<_len1;_j++)match=overviewMatches[_j],name=match.match(/<option[^>]*>([^<]*)<\/option>/)[1],content=match.match(/value="([^"]*)/)[1],quantity[name]=content;value.quantity=quantity}switches.reacts&&(matches=this.resource.match(/reacts="([^"]+)/),matches&&(num=parseInt(matches[1],10),value.reacts=num+1));if(switches.images){images=[],matches=this.resource.match(/<ul class="big">([\S\s]*?)<\/ul>/),imageMatches=matches[1].match(/background-image:url\(([^\)]+)/g);for(_k=0,_len2=imageMatches.length;_k<_len2;_k++)match=imageMatches[_k],image=match.match(/background-image:url\(([^\)]+)/),images.push(image[1]);value.images=images}return this.value(value)})}},FancyProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Fancy/FancySiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var FancySiteInjector;return FancySiteInjector=function(_super){__extends(FancySiteInjector,_super);function FancySiteInjector(){return FancySiteInjector.__super__.constructor.apply(this,arguments)}return FancySiteInjector.prototype.productListing={imgSelector:'a[href^="/things/"] span.back, a[href^="http://fancy.com/things/"] span.back',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/fancy\.com\/things\/([^&]+)/))!=null?_ref[1]:void 0,name}},FancySiteInjector.prototype.productPage={test:function(){return $("#quantity").length},productSid:function(){return document.location.href.match(/^http:\/\/fancy\.com\/things\/([^&]+)/)[1]},imgEl:".figure img"},FancySiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews"],hasProductClass:!1,slug:"fashionbug",hosts:["www.fashionbug.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.fashionbug.com/favicon.ico"},define("sites/FashionBug/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/FashionBug/FashionBugProduct",["scraping/SiteProduct"],function(SiteProduct){var FashionBugProduct;return FashionBugProduct=function(_super){__extends(FashionBugProduct,_super);function FashionBugProduct(){return FashionBugProduct.__super__.constructor.apply(this,arguments)}return FashionBugProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=[],cb({"":images},"")}}(this))},FashionBugProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/FashionBug/FashionBugSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var FashionBugSiteInjector;return FashionBugSiteInjector=function(_super){__extends(FashionBugSiteInjector,_super);function FashionBugSiteInjector(){return FashionBugSiteInjector.__super__.constructor.apply(this,arguments)}return FashionBugSiteInjector.prototype.productListing={imgSelector:"a img",productSid:function(href,a,img){}},FashionBugSiteInjector.prototype.productPage={test:function(){return!1},productSid:function(){return 0},imgEl:function(){return""},waitFor:""},FashionBugSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"forever21",hosts:["www.forever21.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.foreve21.com/favicon.ico",twoTap:!0},define("sites/Forever21/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Forever21/Forever21ProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var Forever21ProductScraper;return Forever21ProductScraper=function(_super){__extends(Forever21ProductScraper,_super);function Forever21ProductScraper(){return Forever21ProductScraper.__super__.constructor.apply(this,arguments)}return Forever21ProductScraper.testProducts=[135898,941783012],Forever21ProductScraper.test={title:["2000109887"],image:["2000109887"],price:{0:["2018732251"],1:["2000109887"]}},Forever21ProductScraper.prototype.resources={productPage:{url:function(){return"http://www.forever21.com/Product/Product.aspx?category=sweater&ProductID="+this.productSid}}},Forever21ProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(/<meta property="og:title" content="([^"]*)" \/>/,1)},price:{resource:"productPage",scraper:PatternResourceScraper([[/<span itemprop="price"><p class="was-now-price">Was:<s>[^<]*<\/s><br \/>Now:\$([^<]*)/,1],[/<p class="product-price">\$([^<]*)<\/p>/,1]])},image:{resource:"productPage",scraper:PatternResourceScraper(/<img id="ctl00_MainContent_productImage" class="[^"]*" title="[^"]*" src="([^"]*)/,1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var description,features,featuresMatch,key,modelInfo,modelInfoMatch,modelInfoPart,modelInfoParts,more,overview,sizeMatch,sizeMatches,value,_i,_len,_ref;overview=/<span id="product_overview" style="[^"]*" class="productFontColor">([\S\s]*)<\/span>/.exec(this.resource)[1],description=overview.match(/<p>([\S\s]*?)(?:DETAILS:)?<\/p>/)[1],featuresMatch=overview.match(/<ul>([\S\s]*)<\/ul>/)[1],features=this.matchAll(featuresMatch,/<li>\s*([\S\s]*?)\s*<\/l?i>/,1),modelInfoMatch=overview.match(/Model Info:&nbsp;([^<]*)/)[1],modelInfoParts=modelInfoMatch.split(" | "),modelInfo={};for(_i=0,_len=modelInfoParts.length;_i<_len;_i++)modelInfoPart=modelInfoParts[_i],_ref=modelInfoPart.split(": "),key=_ref[0],value=_ref[1],modelInfo[key]=value;return sizeMatch=/<select name="[^"]*" id="ctl00_MainContent_ddlSize" class="input" onchange="[^"]*" style="[^"]*">([\S\s]*?)<\/select>/.exec(this.resource)[1],sizeMatches=this.matchAll(sizeMatch,/<option value="[^"]+">([^<]*)/,1),more={description:description,features:features,modelInfo:modelInfo,sizes:sizeMatches},this.value(more)})}},Forever21ProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Forever21/Forever21SiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var Forever21SiteInjector;return Forever21SiteInjector=function(_super){__extends(Forever21SiteInjector,_super);function Forever21SiteInjector(){return Forever21SiteInjector.__super__.constructor.apply(this,arguments)}return Forever21SiteInjector.prototype.productListing={image:'a[href^=http://www.forever21.com/Product/Product.aspx"] img',productSid:function(href,a,img){var _ref;return(_ref=img.attr("src").match(/https:\/\/s7\.jcrew\.com\/is\/image\/jcrew\/([^_]*)_/))!=null?_ref[1]:void 0}},Forever21SiteInjector.prototype.productPage={test:function(){}},Forever21SiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"freepeople",hosts:["www.freepeople.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.freepeople.com/favicon.ico",twoTap:!0},define("sites/FreePeople/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/FreePeople/FreePeopleProduct",["scraping/SiteProduct","underscore","util"],function(SiteProduct,_,util){var FreePeopleProduct;return FreePeopleProduct=function(_super){__extends(FreePeopleProduct,_super);function FreePeopleProduct(){return FreePeopleProduct.__super__.constructor.apply(this,arguments)}return FreePeopleProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=_.mapValues(more.images,function(images){return _.map(images,function(image){return{small:image.detailSize,medium:image.detailSize,large:image.detailSize,larger:image.zoomSize,full:image.zoomSize}})}),cb(images,more.color)}}(this))},FreePeopleProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){return cb(_this.genWidgets(more,{description:"Description",sizingDescription:"Sizing",sizes:"Sizes",colors:{title:"Colors",map:"name"},reviews:{obj:reviews}}))}}(this))},FreePeopleProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/FreePeople/FreePeopleProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var FreePeopleProductScraper;return FreePeopleProductScraper=function(_super){__extends(FreePeopleProductScraper,_super);function FreePeopleProductScraper(){return FreePeopleProductScraper.__super__.constructor.apply(this,arguments)}return FreePeopleProductScraper.prototype.parseSid=function(sid){var color,id,name,_ref;return _ref=sid.split(":"),id=_ref[0],name=_ref[1],color=_ref[2],{id:id,name:name,color:color}},FreePeopleProductScraper.productSid=function(background,url,cb){return background.httpRequest(url,{cb:function(response){var id,name;return name=/<link rel="canonical" href="http:\/\/www\.freepeople\.com\/([^\/]*)\/"\/>/.exec(response)[1],id=response.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1],cb(""+id+":"+name)}})},FreePeopleProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.freepeople.com/"+this.productSid.name,this.productSid.color&&(url+="/_/productOptionIDs/"+this.productSid.color),url}},reviewData:{url:function(){return"http://freepeople.ugc.bazaarvoice.com/3393/"+this.productSid.id+"/reviews.djs?format=embeddedhtml"}}},FreePeopleProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var colorId,i,imageData,imageMap,imageMatches,images,img,imgs,match,matches,more,_base,_i,_len,_name,_name1,_ref;more=this.declarativeScraper("scraper","more"),matches=/var productImages = \$\.namespace\('WEBLINC.productImages'\);([\S\s]*?)<\/script>/.exec(this.resource)[1],imageMatches=this.matchAll(matches,/productImages\['[^']*'\]\["([^"]*)"\]\["([^"]*)"]\["(aliasName|altSize|zoomSize|detailSize)"\] = "([^"]*)";/),imageMap={};for(_i=0,_len=imageMatches.length;_i<_len;_i++)match=imageMatches[_i],imageMap[_name=match[1]]==null&&(imageMap[_name]={}),(_base=imageMap[match[1]])[_name1=match[2]]==null&&(_base[_name1]={}),imageMap[match[1]][match[2]][match[3]]=match[4];images={};for(colorId in imageMap){imageData=imageMap[colorId],imgs=[];for(i in imageData)img=imageData[i],imgs.push({altSize:img.altSize,detailSize:img.detailSize,zoomSize:img.zoomSize});images[((_ref=imageData["0"])!=null?_ref:imageData.a).aliasName]=imgs}return more.images=images,more.currentColor=/<dd class="alias" itemprop="color" data-integration="productDetail-colorAlias">([^<]*)/.exec(this.resource)[1],this.value(more)})},rating:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var id;return id=this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1],this.execBlock(function(){return this.get("http://freepeople.ugc.bazaarvoice.com/3393/"+id+"/reviews.djs?format=embeddedhtml",function(_this){return function(response){var _ref,_ref1;return _this.value((_ref=(_ref1=response.match(/title=\\"([\d.]*) out of 5\\"/))!=null?_ref1[1]:void 0)!=null?_ref:0),_this.done(!0)}}(this)),null})})},ratingCount:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var id;return id=this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1],this.execBlock(function(){return this.get("http://freepeople.ugc.bazaarvoice.com/3393/"+id+"/reviews.djs?format=embeddedhtml",function(_this){return function(response){var _ref,_ref1;return _this.value((_ref=(_ref1=response.match(/<span class=\\"BVRRNumber\\">(\d*)<\\\/span> product reviews/))!=null?_ref1[1]:void 0)!=null?_ref:0),_this.done(!0)}}(this)),null})})},reviews:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var id;return id=this.resource.match(/<meta name="apple-itunes-app" content="app-id=\d*,app-argument=.*?([^\/"]*)">/)[1],this.execBlock(function(){return this.get("http://freepeople.ugc.bazaarvoice.com/3393/"+id+"/reviews.djs?format=embeddedhtml",function(_this){return function(response){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=response.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=_this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=_this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=_this.matchAll(reviewsText,/title=\\"(\d+) out of 5\\"/,1),authorMatches=_this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=_this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),_this.value(reviews)):_this.values([]),_this.done(!0)}}(this)),null})})}},FreePeopleProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/FreePeople/FreePeopleSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var FreePeopleSiteInjector;return FreePeopleSiteInjector=function(_super){__extends(FreePeopleSiteInjector,_super);function FreePeopleSiteInjector(){return FreePeopleSiteInjector.__super__.constructor.apply(this,arguments)}return FreePeopleSiteInjector.prototype.productListing={mode:2,image:'a:not(.option):not([rel="hoverzoom"]):not([data-image]) img',productData:function(href,a,img){var matches;if(matches=/^http:\/\/images\d*\.freepeople\.com\/is\/image\/FreePeople\/([^_]*)/.exec(img.attr("src")))return{productUrl:href,retrievalId:matches[1]}}},FreePeopleSiteInjector.prototype.productPage={productSid:function(){var id,name,options,sid;return name=$('meta[property="og:url"]').attr("content").match(/^http:\/\/www\.freepeople\.com\/([^\/]*)\/$/)[1],id=$("form[name=productsDetailOptionsForm] input[name=productID]").val(),options=$('#productsDetailOptionsForm [name="productOptionIDs"]').val(),sid=""+id+":"+name,options&&(sid+=":"+options),sid},imgEl:'img[itemprop="image"]',overlayEl:".lens",overlayZIndex:9999},FreePeopleSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"gap",hosts:["www.gap.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.gap.com/favicon.ico",productUrl:function(sid){return""}},define("sites/Gap/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Gap/GapProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var GapProductScraper;return GapProductScraper=function(_super){__extends(GapProductScraper,_super);function GapProductScraper(){return GapProductScraper.__super__.constructor.apply(this,arguments)}return GapProductScraper.testProducts=[135898,941783012],GapProductScraper.prototype.resources={productPage:{url:function(){return"http://www.gap.com/browse/product.do?pid="+this.productSid}},productData:{url:function(){return"http://www.gap.com/browse/productData.do?pid="+this.productSid}}},GapProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<h1>\s*(.*?)\s*<\/h1>/),1)},price:{resource:"productData",scraper:PatternResourceScraper([[new RegExp(/<span class="priceDisplay">\$([^<]*)/),1],[new RegExp(/<span class="priceDisplay"><span class="priceDisplaySale">\$([^<]*)/),1]])},image:{resource:"productData",scraper:PatternResourceScraper(new RegExp(/"Main\^,\^([^|]*)/),1).config({map:function(value){if(value)return"http://www.gap.com"+value}})}},GapProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Gap/GapSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var GapSiteInjector;return GapSiteInjector=function(_super){__extends(GapSiteInjector,_super);function GapSiteInjector(){return GapSiteInjector.__super__.constructor.apply(this,arguments)}return GapSiteInjector.prototype.siteName="Gap",GapSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var currentSid,initProducts;_this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),window.initProducts=initProducts=function(){var a,href,img,matches,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),href=a.prop("href"),a.attr("href")[0]!=="#"&&/^http:\/\/www.gap.com\/browse\/product\.do/.exec(href)?(matches=/pid=(\d+)/.exec(href),matches?_results.push(_this.initProductEl(img,{productSid:matches[1]})):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3);if(/^http:\/\/www.gap.com\/browse\/product\.do/.exec(document.location.href))return currentSid=function(){return/pid=(\d+)/.exec(document.location.href)[1]},$("body").delegate("#dragLayer","mouseover",function(){var down,event;return $("#dragLayer").unbind(".agora"),down=!1,event=null,$("#dragLayer").bind("mousedown.agora",function(e){return down=!0,$("html").disableSelection(),e.preventDefault(),event=e,!0}).bind("mouseup.agora",function(){return down=!1,!0}).bind("mousemove.agora",function(e){var selector;if(down)return down=!1,selector="#product_image",setTimeout(function(){return $("#dragLayer").hide(),$(selector).trigger(event),$("html").one("mouseup",function(){return $("html").enableSelection(),$("#dragLayer").show()})},100)})}),_this.waitFor("#product_image",function(el){return _this.initProductEl(el,{productSid:currentSid()},{extraOverlayElements:$("#dragLayer"),initOverlay:function(overlay){return overlay.el.css("z-index",1e4)}})})}}(this))},GapSiteInjector}(SiteInjector)}}}),{slug:"general",currency:"embedded",scraper:!0,enabled:"check",offersPane:!1},define("sites/General/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/General/GeneralProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper){var GeneralProductScraper;return GeneralProductScraper=function(_super){__extends(GeneralProductScraper,_super);function GeneralProductScraper(){return GeneralProductScraper.__super__.constructor.apply(this,arguments)}return GeneralProductScraper.productSid=function(background,url,cb){return cb(url)},GeneralProductScraper.prototype.resources={page:{url:function(){return this.productSid}}},GeneralProductScraper.prototype.properties={title:{resource:"page",scraper:PatternResourceScraper(/<title>\s*([^<]*)<\/title>/i,1)},price:{resource:"page",scraper:PatternResourceScraper(/((?:\$|EUR )[0-9]+([.,][0-9]+)?)/,1,!0,"")}},GeneralProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/General/GeneralSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var GeneralSiteInjector;return GeneralSiteInjector=function(_super){__extends(GeneralSiteInjector,_super);function GeneralSiteInjector(){return GeneralSiteInjector.__super__.constructor.apply(this,arguments)}return GeneralSiteInjector.prototype.siteName="General",GeneralSiteInjector.prototype.config={productBadges:!1},GeneralSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProduct,shoppingBarView;return shoppingBarView=new ShoppingBarView(_this.contentScript),shoppingBarView.el.appendTo(document.body),shoppingBarView.represent(),initProduct=function(el,pageUrl,linkUrl,image){return _this.products(el,{siteName:_this.siteName,pageUrl:pageUrl,linkUrl:linkUrl,image:image})},$("body").delegate("img","mouseover",function(){var a,linkUrl;return!$(this).data("agora")&&!$(this).parents(".-agora").length&&(a=$(this).parents("a"),linkUrl=null,a.length&&a.prop("href")&&a.prop("href").match("^http")&&(linkUrl=a.prop("href")),initProduct($(this),document.location.href,linkUrl,$(this).prop("src"))),$(this).data("agora",!0)}),!0}}(this))},GeneralSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"hm",hosts:["www.hm.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.hm.com/favicon.ico"},define("sites/HM/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HM/HMProduct",["scraping/SiteProduct"],function(SiteProduct){var HMProduct;return HMProduct=function(_super){__extends(HMProduct,_super);function HMProduct(){return HMProduct.__super__.constructor.apply(this,arguments)}return HMProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],images[color]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}();return cb(images,more.color)}}(this))},HMProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:"Description",details:"Details",sizes:"Sizes",colors:{title:"Colors",map:function(color){return color.name}}}),cb(widgets)}}(this))},HMProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HM/HMProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var HMProductScraper;return HMProductScraper=function(_super){__extends(HMProductScraper,_super);function HMProductScraper(){return HMProductScraper.__super__.constructor.apply(this,arguments)}return HMProductScraper.prototype.parseSid=function(sid){var color,id,size,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],size=_ref[2],{id:id,color:color,size:size}},HMProductScraper.prototype.resources={productPage:{url:function(){return"http://www.hm.com/us/product/"+this.productSid.id+"?article="+this.productSid.id+"-"+this.productSid.color+"&variant="+this.productSid.size}}},HMProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var article,id,images,img,match,more,obj,_ref;more=this.declarativeScraper("scraper","more"),match=/hm.data.product = (\{[\S\s]*?\})\s*<\/script>/.exec(this.resource)[1],obj=JSON.parse(match),images={},_ref=obj.articles;for(id in _ref)article=_ref[id],images[article.description]=function(){var _i,_len,_ref1,_results;_ref1=article.images,_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++)img=_ref1[_i],_results.push("http://lp.hm.com/hmprod?set=key[source],value["+img.url+"]&set=key[rotate],value[0]&set=key[width],value[3692]&set=key[height],value[4317]&set=key[x],value[336]&set=key[y],value[263]&set=key[type],value[FASHION_FRONT]&hmver=0&call=url[file:/product/large]");return _results}();return more.images=images,this.value(more)})}},HMProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HM/HMSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var HMSiteInjector;return HMSiteInjector=function(_super){__extends(HMSiteInjector,_super);function HMSiteInjector(){return HMSiteInjector.__super__.constructor.apply(this,arguments)}return HMSiteInjector.prototype.productListing={mode:2,selectors:{'a[href^="http://www.hm.com/us/product/"] img':{productData:function(href,a,img){var matches;matches=href.match(/[?&]article=(.*?)(?:$|&)/);if(matches)return{productSid:matches[1]}}},'a[href^="http://www.hm.com/us/product/"] + .image':{image:function(el){return el.find("img:last")},anchor:function(el){return el.prev()},anchorProxy:!0,productData:function(href){var matches;matches=href.match(/[?&]article=(.*?)(?:$|&)/);if(matches)return{productSid:matches[1]}}}}},HMSiteInjector.prototype.productPage={mode:2,test:function(){return $('meta[property="og:type"]').attr("content")==="website"},productSid:function(){var matches;matches=document.location.href.match(/#article=(.*)/);if(matches)return matches[1];matches=document.location.href.match(/[?&]article=(.*?)(?:#|$|&)/);if(matches)return matches[1]},image:"#product-image-box > .zoom-pan > img",attach:"#content"},HMSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"homedepot",hosts:["www.homedepot.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.homedepot.com/favicon.ico",productUrl:function(sid){return""}},define("sites/HomeDepot/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HomeDepot/HomeDepotProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var HomeDepotProduct;return HomeDepotProduct=function(_super){__extends(HomeDepotProduct,_super);function HomeDepotProduct(){return HomeDepotProduct.__super__.constructor.apply(this,arguments)}return HomeDepotProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var name,otherImages,url,urlFirst,urlLast,_ref;otherImages=[],_ref=more.images;for(name in _ref)url=_ref[name],urlFirst=url,urlLast="",otherImages.push({small:urlFirst,medium:urlFirst+"300-"+urlLast,large:urlFirst+"500-"+urlLast,larger:urlFirst+"500-"+urlLast,full:urlFirst});return cb({"":otherImages},"")}}(this))},HomeDepotProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{features:"Features",details:"Details",specifications:"Specifications"}),cb(widgets)}}(this))},HomeDepotProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HomeDepot/HomeDepotProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var HomeDepotProductScraper;return HomeDepotProductScraper=function(_super){__extends(HomeDepotProductScraper,_super);function HomeDepotProductScraper(){return HomeDepotProductScraper.__super__.constructor.apply(this,arguments)}return HomeDepotProductScraper.testProducts=["204617362"],HomeDepotProductScraper.prototype.resources={productPage:{url:function(){return"http://www.homedepot.com/p/"+this.productSid}}},HomeDepotProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<span id="ajaxPrice" class="pReg" itemprop="price">\s*\$([^<]*)/),1)},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var alt,author,authorBio,authorMatches,authorNames,bioMatch,bioMatches,content,count,detailMatches,details,editorialReviews,erMatches,feature,features,from,full,image,imageMatches,images,isbn,item,match,matches,name,overview,overviewMatches,par,specMatches,specs,switches,text,title,value,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_len6,_len7,_m,_n,_o,_p;switches={images:!0,overview:!0,specifications:!0,rating:!0,ratingCount:!0,originalPrice:!0,shipping:!1},value={};if(switches.overview){overview=[],matches=this.resource.match(/<div class="main_description([\S\s]*?)<\/div>/),overviewMatches=matches[1].match(/<p[^>]+>([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p[^>]+>([\S\s]*?)<\/p>/),overview.push(text[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));features=[],specMatches=matches[1].match(/<li>([\S\s]*?)<\/li>/g);if(specMatches){for(_j=0,_len1=specMatches.length;_j<_len1;_j++)match=specMatches[_j],feature=match.match(/<li>([\S\s]*?)<\/li>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),features.push(feature);overview.push(features)}value.overview=overview}if(switches.specifications){matches=this.resource.match(/<div id="specifications"([\S\s]*?)<\/table>/),specs={},specMatches=matches[1].match(/<tr([\S\s]*?)<\/tr>|<tr([\S\s]*?)<\/tbody>/g);for(_k=0,_len2=specMatches.length;_k<_len2;_k++)match=specMatches[_k],full=match.match(/<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>([\S\s]*)<\/td>/),full?(title=match.match(/<td>([\S\s]*)<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),content=match.match(/<td>[\S\s]*<\/td>[\s]*<td>([\S\s]*)<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),specs[title]=content,title=match.match(/<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>([\S\s]*)<\/td>[\s]*<td>[\S\s]*<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),content=match.match(/<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>[\S\s]*<\/td>[\s]*<td>([\S\s]*)<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),specs[title]=content):(title=match.match(/<td>([\S\s]*)<\/td>[\s]*<td>[\S\s]*<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),content=match.match(/<td>[\S\s]*<\/td>[\s]*<td>([\S\s]*)<\/td>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^&nbsp;+|&nbsp;+$/gm,""),specs[title]=content);value.specifications=specs}if(switches.details){details=[],matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),detailMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g);for(_l=0,_len3=detailMatches.length;_l<_len3;_l++)match=detailMatches[_l],title=match.match(/<span>([\S\s]*?)<\/span>/)[1],content=match.match(/<\/span>([\S\s]*?)<\/li>/)[1],text=title+content,details.push(text.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));value.details=details}switches.isbn&&(matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),isbn=matches[1].match(/<span>ISBN-13:<\/span>([\S\s]*?)<\/li>/),value.isbn=isbn[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));if(switches.author){author={},authorNames=[],matches=this.resource.match(/<ul class="contributors([\S\s]*?)<\/ul>/),authorMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g),count=0;for(_m=0,_len4=authorMatches.length;_m<_len4;_m++)item=authorMatches[_m],count>0&&(name=item.match(/<li([\S\s]*?)<\/li>/)[1],authorNames.push(name.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),count++;author.names=authorNames,authorBio=[],bioMatch=this.resource.match(/<div class="basic-info([\S\s]*?)<\/section>/),bioMatches=bioMatch[1].match(/<p>([\S\s]*?)<\/p>/g);for(_n=0,_len5=bioMatches.length;_n<_len5;_n++)match=bioMatches[_n],par=match.match(/<p>([\S\s]*?)<\/p>/)[1],authorBio.push(par);author.bio=authorBio,value.author=author}switches.rating&&(matches=this.resource.match(/<meta itemprop="ratingValue" content="([^"]+)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/<meta itemprop="reviewCount" content="([^"]+)/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_o=0,_len6=erMatches.length;_o<_len6;_o++)match=erMatches[_o],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/<span id="ajaxPriceStrikeThru">[\s]*\$([^<]+)/),matches&&(value.originalPrice=matches[1]));if(switches.images){images={},matches=this.resource.match(/PRODUCT_INLINE_PLAYER_JSON([^<]+)/),imageMatches=matches[1].match(/"height":"1000","width":"1000","mediaUrl":"([^\{]+)/g);for(_p=0,_len7=imageMatches.length;_p<_len7;_p++)match=imageMatches[_p],image=match.match(/"height":"1000","width":"1000","mediaUrl":"([^"]+)/)[1],alt=match.match(/\}],"([^"]+)/),alt?images[alt[1]]=image:images.other=image;value.images=images}return this.value(value)})}},HomeDepotProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/HomeDepot/HomeDepotSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var HomeDepotSiteInjector;return HomeDepotSiteInjector=function(_super){__extends(HomeDepotSiteInjector,_super);function HomeDepotSiteInjector(){return HomeDepotSiteInjector.__super__.constructor.apply(this,arguments)}return HomeDepotSiteInjector.prototype.productListing={imgSelector:'a[href^="http://www.homedepot.com/p/"] img, a[href^="/p/"] img',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.homedepot\.com\/p\/[^\/]*\/(\d+)/))!=null?_ref[1]:void 0,name}},HomeDepotSiteInjector.prototype.productPage={test:function(){return $('meta[property="og:type"]').attr("content")},productSid:function(){return document.location.href.match(/^http:\/\/www\.homedepot\.com\/p\/[^\/]*\/(\d+)/)[1]},image:"#superPIP__productImage",attach:".product_mainimg",overlayEl:".zoomIt_area"},HomeDepotSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"jcpenney",hosts:["www.jcpenney.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.jcpenney.com/favicon.ico",productUrl:function(sid){return""}},define("sites/JCPenney/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCPenney/JCPenneyProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var JCPenneyProduct;return JCPenneyProduct=function(_super){__extends(JCPenneyProduct,_super);function JCPenneyProduct(){return JCPenneyProduct.__super__.constructor.apply(this,arguments)}return JCPenneyProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,image,images,imgs,longId,otherImages,shortId,_i,_j,_len,_len1,_ref,_ref1,_ref2;otherImages=[],_ref=more.images.pics;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],image=image.match(/^(.*?)\?/)[1],otherImages.push({small:image+"?scl=1&fmt=jpeg",medium:image+"?scl=1&fmt=jpeg",large:image+"?scl=1&fmt=jpeg",larger:image+"?scl=1&fmt=jpeg",full:image+"?scl=1&fmt=jpeg"});images={},_ref1=more.images.colorPics;for(color in _ref1)image=_ref1[color],imgs=[],image=image.match(/^(.*?)\?/)[1],imgs.push({small:image+"?scl=10&fmt=jpeg",medium:image+"?scl=6&fmt=jpeg",large:image+"?scl=3&fmt=jpeg",larger:image+"?scl=2&fmt=jpeg",full:image+"?scl=1&fmt=jpeg"}),imgs=imgs.concat(otherImages),images[color]=imgs;longId=_this.product.get("productSid").split("-")[1],shortId=null;if(longId){_ref2=more.colors;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){color=_ref2[_j];if(color.longId===longId){shortId=color.shortId;break}}}return cb(images,shortId)}}(this))},JCPenneyProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCPenney/JCPenneyProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var JCPenneyProductScraper;return JCPenneyProductScraper=function(_super){__extends(JCPenneyProductScraper,_super);function JCPenneyProductScraper(){return JCPenneyProductScraper.__super__.constructor.apply(this,arguments)}return JCPenneyProductScraper.testProducts=["204617362"],JCPenneyProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},JCPenneyProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.jcpenney.com/prod.jump?ppId="+this.productSid.id,this.productSid.color&&(url+="&selectedSKUId="+this.productSid.color),url}}},JCPenneyProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<span class='gallery_page_price[^>]+([\s\S]*?)<\/span>/),1],[new RegExp(/jcpPRODUCTPRESENTATIONSjcp = 'pp5003810419@\$(\S*)@1';/),1],[new RegExp(/<span class='[^']*' itemprop="price">\s*<a href="[^"]*" class="[^"]*" style='[^']*'>\s*\$(\S*)\s*sale/),1],[new RegExp(/<span class='[^']*' style="[^"]*" itemprop="price">\s*\$(\S*)\s*sale/),1],[new RegExp(/<span class='gallery_page_price flt_wdt comparisonPrice'[^>]*>\s*\$([\s\S]*?)\s*sale\s*<\/span>/),1,function(value){return value.split(/\s+/).join(" ")}]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var code,col,colorMatches,colors,content,image,imageMatches,images,liMatches,lists,match,matches,name,options,originalPrice,overview,overviewMatches,promo,rating,ratingID,ratingURL,reviewCount,size,sizeMatches,sizes,switches,text,title,ulMatch,ulMatches,value,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_m,_n;switches={images:!0,overview:!1,rating:!0,ratingCount:!0,originalPrice:!1,promo:!1,options:!1,shipping:!1},value={};if(switches.overview){overview=[],matches=this.resource.match(/<div id="longCopyCont"([\S\s]*?)<\/div>[\S\s]*?<\/div>/)[1]+this.resource.match(/<div id="longCopyCont"[\S\s]*?<\/div>([\S\s]*?)<\/div>/)[1],overviewMatches=matches.match(/<p([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p[^>]*>([\S\s]*?)<\/p>/),overview.push(text[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));lists={},ulMatches=matches.match(/<ul([\S\s]*?)<\/ul>/g);if(ulMatches){for(_j=0,_len1=ulMatches.length;_j<_len1;_j++){ulMatch=ulMatches[_j],liMatches=ulMatch.match(/<li([\S\s]*?)<\/li>/g);for(_k=0,_len2=liMatches.length;_k<_len2;_k++)match=liMatches[_k],col=match.match(/(:)/),col?(title=match.match(/<li>([^:]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),content=match.match(/:([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),lists[title]=content):(title=match.match(/<li>([^<]+)/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "),lists[title]=null)}overview.push(lists)}value.overview=overview}if(switches.options){options=[],matches=this.resource.match(/<div class="sku_detail">([\S\s]*?)<\/fieldset>/),sizeMatches=matches[1].match(/<li id="size"([\S\s]*?)<\/li>/g);if(sizeMatches){sizes={};for(_l=0,_len3=sizeMatches.length;_l<_len3;_l++)match=sizeMatches[_l],code=match.match(/<a id='([^']+)/)[1],size=match.match(/<a[^>]+>([\S\s]*?)<\/a>/)[1],sizes[size]=code;options.push(sizes)}colorMatches=matches[1].match(/<a class="swatch"([\S\s]*?)<\/a>/g);if(colorMatches){colors={};for(_m=0,_len4=colorMatches.length;_m<_len4;_m++)match=colorMatches[_m],code={},name=match.match(/alt="([^"]*)/)[1],code.image="http://s7d9.scene7.com/is/image/JCPenney/"+match.match(/onmouseover="updateRender\('([^']*)/)[1]+"?wid=500&hei=500&fmt=jpg&op_usm=.4,.8,0,0&resmode=sharp2",code.swatch=match.match(/src="([^"]*)/)[1],code.number=match.match(/<a class="swatch" href='([^']*)/)[1],colors[name]=code;options.push(colors)}value.options=options}switches.rating&&(rating=[],ratingID=this.resource.match(/reviewId:"([^"]*)/)[1],ratingURL="http://jcpenney.ugc.bazaarvoice.com/1573-en_us/"+ratingID+"/reviews.djs?format=embeddedhtml",this.execBlock(function(){return this.get(ratingURL,function(response){return match=response.match(/<span class=\\"BVRRNumber BVRRRatingNumber\\">([^<]*)/),match&&rating.push(match[1]),this.done(!0),this.value(value)}),null}),value.rating=rating),switches.reviewCount&&(reviewCount=[],ratingID=this.resource.match(/reviewId:"([^"]*)/)[1],ratingURL="http://jcpenney.ugc.bazaarvoice.com/1573-en_us/"+ratingID+"/reviews.djs?format=embeddedhtml",this.execBlock(function(){return this.get(ratingURL,function(response){return match=response.match(/<span class=\\"BVRRNumber\\">([^<]*)/),match&&reviewCount.push(match[1]),this.done(!0),this.value(value)}),null}),value.reviewCount=reviewCount),switches.promo&&(matches=this.resource.match(/<span id="promoDetails">([\S\s]*?)<\/span>/),matches&&(promo=this.resource.match(/<span >([\S\s]*?)<\/span>|<span >([\S\s]*?)<\/span>/),value.promo=promo[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),switches.originalPrice&&(matches=this.resource.match(/var priceType='Sale';/),matches&&(matches=this.resource.match(/<span class='pp_page_price([\S\s]*?)<\/span>/),originalPrice=matches[1].match(/\$([\S\s]*?)original/),value.originalPrice=originalPrice[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ")));if(switches.images){images=[],matches=this.resource.match(/var imageName = "([^"]*)/),imageMatches=matches[1].split(",");if(imageMatches){for(_n=0,_len5=imageMatches.length;_n<_len5;_n++)match=imageMatches[_n],image="http://s7d9.scene7.com/is/image/JCPenney/"+match+"?wid=500&hei=500&fmt=jpg&op_usm=.4,.8,0,0&resmode=sharp2",images.push(image);value.images=images}}return this.value(value)})}},JCPenneyProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCPenney/JCPenneySiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var JCPenneySiteInjector;return JCPenneySiteInjector=function(_super){__extends(JCPenneySiteInjector,_super);function JCPenneySiteInjector(){return JCPenneySiteInjector.__super__.constructor.apply(this,arguments)}return JCPenneySiteInjector.prototype.productListing={imgSelector:'a img[src^="http://s7d9.scene7.com/is/image/JCPenney/"]',productSid:function(href,a,img){var match,name,sid,_ref,_ref1;return name=(_ref=href.match(/^http:\/\/www\.jcpenney\.com\/.*?\/prod\.jump\?ppId=([a-z]*\d+)/))!=null?_ref[1]:void 0,sid=name,sid||(href=unescape(href),match=(_ref1=/(http:\/\/www\.jcpenney.com\/.*?)(?:&|$)/.exec(href))!=null?_ref1[1]:void 0,match&&(sid=match)),sid}},JCPenneySiteInjector.prototype.productPage={test:function(){return $('meta[name="keywords"]').attr("content")},productSid:function(){return document.location.href.match(/^http:\/\/www\.jcpenney\.com\/.*?\/prod\.jump\?ppId=([a-z]*\d+)/)[1]},imgEl:"#izView img",waitFor:"#izView img",overlayEl:"#myZoomView"},JCPenneySiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"jcrew",hosts:["www.jcrew.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.jcrew.com/favicon.ico",twoTap:!0},define("sites/JCrew/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCrew/JCrewProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var JCrewProduct;return JCrewProduct=function(_super){__extends(JCrewProduct,_super);function JCrewProduct(){return JCrewProduct.__super__.constructor.apply(this,arguments)}return JCrewProduct.prototype.variantImage=function(variant,cb){return this.product["with"]("more",function(_this){return function(more){var _ref;return more?cb((_ref=more.colorImages)!=null?_ref[variant.Color]:void 0):cb()}}(this))},JCrewProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images,otherImages;return more?(otherImages=_.map(more.images,function(image){return{small:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=10",medim:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=6",large:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=3",larger:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=2",full:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=1"}}),images=_.mapValues(more.colorImages,function(image){return[{small:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=10",medium:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=6",large:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=3",larger:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=2",full:image.match(/^([^?]*)/)[1]+"?fmt=jpeg&op_sharpen=0&resMode=sharp2&scl=1"}].concat(otherImages)}),cb(images,more.color)):cb()}}(this))},JCrewProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews}}),cb(widgets)}}(this))},JCrewProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCrew/JCrewProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var JCrewProductScraper;return JCrewProductScraper=function(_super){__extends(JCrewProductScraper,_super);function JCrewProductScraper(){return JCrewProductScraper.__super__.constructor.apply(this,arguments)}return JCrewProductScraper.prototype.version=2,JCrewProductScraper.prototype.resources={productPage:{url:function(){return"https://www.jcrew.com/browse/single_product_detail.jsp?prd_id="+this.productSid}},productDetails:{url:function(){return"https://www.jcrew.com/browse2/ajax/product_details_ajax.jsp?prodCode="+this.productSid+"&color_name="}},reviewData:{url:function(){return"https://jcrew.ugc.bazaarvoice.com/1706-en_us/"+this.productSid+"/reviews.djs?format=embeddedhtml"}}},JCrewProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var more;return more=this.declarativeScraper("scraper","more"),this.execBlock(function(){return this.getResource("productDetails",function(resource){var colorImages,colorMappings,colorMappingsMatch,colors,match,matches,sizes,_i,_j,_len,_len1,_ref;colorMappingsMatch=this.matchAll(resource,/"color":"([^"]*)","fullydomqty":false,"colordisplayname":"([^"]*)"/),colorMappings={};for(_i=0,_len=colorMappingsMatch.length;_i<_len;_i++)match=colorMappingsMatch[_i],colorMappings[match[1]]=match[2];more={},match=/<section id="color1" class="color-row last-row">([\S\s]*?)<\/section>/.exec(resource)[1],matches=this.matchAll(match,/<a id="([^"]*)">\s*<img data-imgurl="([^"]*)" src="([^"]*)" class="product-detail-images" data-productcode="[^"]*" data-index="" \/>/),colorImages={},colors=[];for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],colorImages[colorMappings[match[1]]]=match[2],colors.push({id:match[1],swatch:match[3],name:colorMappings[match[1]]});return match=/<section id="sizes" class="sizes">([\S\s]*?)<\/section>/.exec(resource)[1],sizes=this.matchAll(match,/<span>([^<]*)<\/span>/,1),more.colors=colors,more.colorImages=colorImages,more.sizes=sizes,more.color=(_ref=/<span class="color-name">\s*(.*?)\s*<\/span>/.exec(resource))!=null?_ref[1]:void 0,this.value(more),this.done(!0)}),null}),this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/NoReviewText\\">There are no reviews for this product/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/NoReviewText\\">There are no reviews for this product/,0,function(){return 0}],[/BVRRBuyAgainPrefix\\">Based on (\d*)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},JCrewProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/JCrew/JCrewSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var JCrewSiteInjector;return JCrewSiteInjector=function(_super){__extends(JCrewSiteInjector,_super);function JCrewSiteInjector(){return JCrewSiteInjector.__super__.constructor.apply(this,arguments)}return JCrewSiteInjector.prototype.productListing={image:'a img[src^="https://s7.jcrew.com/is/image/jcrew/"]:not(.product-detail-images):not(#pdpMainImg0)',productSid:function(href,a,img){var _ref;if(img.attr("src").indexOf("italicloader")===-1)return(_ref=img.attr("src").match(/https:\/\/s7\.jcrew\.com\/is\/image\/jcrew\/([^_]*)_/))!=null?_ref[1]:void 0}},JCrewSiteInjector.prototype.productPage={mode:2,productSid:function(){var _ref;return(_ref=$("#pdpMainImg0").attr("src").match(/https:\/\/s7\.jcrew\.com\/is\/image\/jcrew\/([^_]*)_/))!=null?_ref[1]:void 0},image:"#pdpMainImg0",position:"#pdpMainImg0",attach:"#product0",variant:function(){return{Color:$(".color-name").text().trim()}}},JCrewSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"katespade",hosts:["www.katespade.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.katespade.com/favicon.ico",twoTap:!0},define("sites/KateSpade/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/KateSpade/KateSpadeProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var KateSpadeProduct;return KateSpadeProduct=function(_super){__extends(KateSpadeProduct,_super);function KateSpadeProduct(){return KateSpadeProduct.__super__.constructor.apply(this,arguments)}return KateSpadeProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorId,colorName,images,img,imgs,name,parts,_i,_len,_ref,_ref1;images={},parts=_this.product.get("productSid").split("_"),colorId=parts[1],colorName=null,_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++){color=_ref[_i];if(color.id===colorId){colorName=color.name;break}}_ref1=more.images;for(name in _ref1)imgs=_ref1[name],images[name]=function(){var _j,_len1,_results;_results=[];for(_j=0,_len1=imgs.length;_j<_len1;_j++)img=imgs[_j],_results.push({small:img+"?op_sharpen=1&resMode=sharp2&id=kmVqf0&scl=10&fmt=jpg",medium:img+"?op_sharpen=1&resMode=sharp2&id=kmVqf0&scl=6&fmt=jpg",large:img+"?op_sharpen=1&resMode=sharp2&id=kmVqf0&scl=3&fmt=jpg",larger:img+"?op_sharpen=1&resMode=sharp2&id=kmVqf0&scl=2&fmt=jpg",full:img+"?op_sharpen=1&resMode=sharp2&id=kmVqf0&scl=1&fmt=jpg"});return _results}();return cb(images,colorName)}}(this))},KateSpadeProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes","details.details":"Details","details.features":"Features","details.material":"Material",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews}}),cb(widgets)}}(this))},KateSpadeProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/KateSpade/KateSpadeProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var KateSpadeProductScraper;return KateSpadeProductScraper=function(_super){__extends(KateSpadeProductScraper,_super);function KateSpadeProductScraper(){return KateSpadeProductScraper.__super__.constructor.apply(this,arguments)}return KateSpadeProductScraper.prototype.version=2,KateSpadeProductScraper.prototype.parseSid=function(sid){var color,size,sku,_ref;return _ref=sid.split("_"),sku=_ref[0],color=_ref[1],size=_ref[2],{sku:sku,color:color,size:size}},KateSpadeProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.katespade.com/-/"+this.productSid.sku+",en_US,pd.html?",this.productSid.color&&(url+="dwvar_"+this.productSid.sku+"_color="+this.productSid.color+"&"),this.productSid.size&&(url+="dwvar_"+this.productSid.sku+"_size="+this.productSid.size),url}},reviewData:{url:function(){return"http://katespade.ugc.bazaarvoice.com/5036-en_us/"+this.productSid.sku+"/reviews.djs?format=embeddedhtml"}}},KateSpadeProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var str;return this.productSid.color?(str=""+this.productSid.sku+"_"+this.productSid.color,this.value("http://a248.e.akamai.net/f/248/9086/10h/origin-d4.scene7.com/is/image/KateSpade/"+str+"?op_sharpen=0&resMode=sharp2&wid=467&fmt=jpg")):this.value(this.declarativeScraper("scraper","image"))})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,images,more,_fn,_i,_len,_ref;more=this.declarativeScraper("scraper","more"),images={},more.images=images,_ref=more.colors,_fn=function(_this){return function(color){return _this.execBlock(function(){return this.get("https://a248.e.akamai.net/f/248/9086/10h/origin-d4.scene7.com/is/image/KateSpade/"+this.productSid.sku+"_"+color.id+"_is?req=set,json,UTF-8",function(response){var obj;return obj=JSON.parse(response.match(/^s7jsonResponse\((.*?),""\);$/)[1]),images[color.name]=_.map(obj.set.item,function(i){return"https://a248.e.akamai.net/f/248/9086/10h/origin-d4.scene7.com/is/image/"+i.i.n}),this.value(more),this.done(!0)}),null})}}(this);for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],_fn(color);return this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},KateSpadeProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/KateSpade/KateSpadeSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var KateSpadeSiteInjector,parseImgSrc;return parseImgSrc=function(src){var matches;matches=src.match(/http:\/\/s7d4\.scene7\.com\/is\/image\/KateSpade\/([^_]*)_(\d*)/);if(!matches){matches=src.match(/http:\/\/a248\.e\.akamai\.net\/f\/248\/9086\/10h\/origin-d4\.scene7\.com\/is\/image\/KateSpade\/([^_]*)_(\d*)/);if(!matches)return null}return""+matches[1]+"_"+matches[2]},KateSpadeSiteInjector=function(_super){__extends(KateSpadeSiteInjector,_super);function KateSpadeSiteInjector(){return KateSpadeSiteInjector.__super__.constructor.apply(this,arguments)}return KateSpadeSiteInjector.prototype.productListing={container:".product-image",overlayZIndex:1,image:'a:not(.swatchanchor) img[src^="http://s7d4.scene7.com/is/image/KateSpade/"], a:not(.swatchanchor) img[src^="http://a248.e.akamai.net/f/248/9086/10h/origin-d4.scene7.com/is/image/KateSpade/"]',productSid:function(href,a,img){var matches;matches=img.attr("src").match(/http:\/\/s7d4\.scene7\.com\/is\/image\/KateSpade\/([^_]*)_(\d*)/);if(!matches){matches=img.attr("src").match(/http:\/\/a248\.e\.akamai\.net\/f\/248\/9086\/10h\/origin-d4\.scene7\.com\/is\/image\/KateSpade\/([^_]*)_(\d*)/);if(!matches)return null}return""+matches[1]+"_"+matches[2]}},KateSpadeSiteInjector.prototype.productPage={test:function(){return $('meta[property="og:type"]').attr("content")==="product"},productSid:function(){var color,id;return id=$(".product-primary-image img").attr("src").match(/\/KateSpade\/([^_]*)_/)[1],color=$("input[type=hidden][name=dwvar_"+id+"_color]").val(),""+id+"_"+color},imgEl:".product-primary-image img",waitFor:".product-primary-image img",overlayEl:".s7zoomview"},KateSpadeSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"macys",hosts:["www.kmart.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.kmart.com/favicon.ico",productUrl:function(sid){return""}},define("sites/Kmart/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Kmart/KmartProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var KmartProduct;return KmartProduct=function(_super){__extends(KmartProduct,_super);function KmartProduct(){return KmartProduct.__super__.constructor.apply(this,arguments)}return KmartProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,img,otherImages,url,_i,_len,_ref;otherImages=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++){image=_ref[_i];for(img in image)url=image[img],otherImages.push({small:url.primaryImg+"?hei=100&wid=100&op_sharpen=1",medium:url.primaryImg+"?hei=300&wid=300&op_sharpen=1",large:url.primaryImg+"?hei=500&wid=500&op_sharpen=1",larger:url.primaryImg+"?hei=1000&wid=1000&op_sharpen=1",full:url.primaryImg+"?op_sharpen=1"})}return cb({"":otherImages},"")}}(this))},KmartProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:"Description",specifications:"Specifications"}),cb(widgets)}}(this))},KmartProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Kmart/KmartProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var KmartProductScraper;return KmartProductScraper=function(_super){__extends(KmartProductScraper,_super);function KmartProductScraper(){return KmartProductScraper.__super__.constructor.apply(this,arguments)}return KmartProductScraper.testProducts=[],KmartProductScraper.prototype.resources={productPage:{url:function(){return"http://www.kmart.com/-/p-"+this.productSid}},productData:{type:"json",url:function(){return"http://www.kmart.com/content/pdp/config/products/v1/products/"+this.productSid+"?site=kmart"}},priceData:{type:"json",url:function(){var number;return number=this.productSid.value,number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),"http://www.kmart.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0"}}},KmartProductScraper.prototype.properties={title:{resource:"productData",scraper:JsonResourceScraper(function(data){return(""+data.brandName+" "+data.title).trim()})},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var number,price,priceUrl;return price="",number=this.productSid.value,console.debug("asdf"),console.debug(number),number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),priceUrl="http://www.kmart.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0",this.execBlock(function(){return this.get(priceUrl,function(response){var altPriceUrl,originalPrice;return originalPrice=JSON.parse(response),originalPrice["price-response"]["item-response"]["sell-price"].$&&(originalPrice["price-response"]["item-response"]["sell-price"].$!=="0.00"?price=originalPrice["price-response"]["item-response"]["sell-price"].$:(altPriceUrl="http://www.kmart.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber="+number+"P",this.execBlock(function(){return this.get(altPriceUrl,function(response){return originalPrice=response.match(/"prodDispPrice":"([^,]+|[^"]+)/),originalPrice&&(price=originalPrice[1]),this.value(price),this.done(!0)}),null}))),this.value(price),this.done(!0)}),null}),this.value(price)})},image:{resource:"productData",scraper:JsonResourceScraper(function(data){return data.data.product.assets.imgs[0].vals[0].src.indexOf("?")===-1?""+data.data.product.assets.imgs[0].vals[0].src+"?hei=623&wid=623&qlt=50,0&op_sharpen=1&op_usm=0.9,0.5,0,0":data.data.product.assets.imgs[0].vals[0].src})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var descUrl,description,imgUrl,number,priceUrl,ratUrl,revs,specs,switches,value;return switches={images:!0,description:!0,specifications:!0,rating:!0,ratingCount:!1,originalPrice:!1,reviews:!1,shipping:!1},value={},switches.images&&(imgUrl="http://www.kmart.com/content/pdp/config/products/v1/products/"+this.productSid+"?site=kmart",this.execBlock(function(){return this.get(imgUrl,function(response){var altPocket,color,colorName,entry,imageArr,images,pocket,theColor,variant,variantName,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_len6,_m,_n,_o,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;images=JSON.parse(response);if(images.data.product.variants){if(images.data.product.variants.definingAttrs){imageArr=[],_ref=images.data.product.variants.definingAttrs;for(_i=0,_len=_ref.length;_i<_len;_i++){pocket=_ref[_i];if(pocket.name==="Color"){_ref1=pocket.vals;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){color=_ref1[_j],variant={},variantName={},colorName=color.name,variant.primaryImg=color.primaryImg.attrs.src,variant.swatchImg=color.swatchImg.attrs.src,_ref2=images.product.variants.sku;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){altPocket=_ref2[_k],theColor=altPocket.name.match(/Color:([^,]*|$)/)[1];if(theColor===colorName&&altPocket.alternateImg){_ref3=altPocket.alternateImg;for(_l=0,_len3=_ref3.length;_l<_len3;_l++)entry=_ref3[_l],variant.altImg=entry.src}}variantName[colorName]=variant,imageArr.push(variantName)}}}value.images=imageArr}}else{imageArr=[],_ref4=images.data.product.assets.imgs;for(_m=0,_len4=_ref4.length;_m<_len4;_m++){pocket=_ref4[_m];if(pocket.type==="P"){_ref5=pocket.vals;for(_n=0,_len5=_ref5.length;_n<_len5;_n++)entry=_ref5[_n],variant={},variantName={},variant.primaryImg=entry.src,variantName.Main=variant,imageArr.push(variantName)}else if(pocket.type==="A"){_ref6=pocket.vals;for(_o=0,_len6=_ref6.length;_o<_len6;_o++)entry=_ref6[_o],variant={},variantName={},variant.primaryImg=entry.src,variantName.Other=variant,imageArr.push(variantName)}}value.images=imageArr}return this.done(!0),this.value(value)}),null})),switches.reviews&&(ratUrl="http://www.kmart.com/content/pdp/ratings/single/search/Kmart/"+this.productSid+"&targetType=product&limit=10000&offset=0",revs=[],this.execBlock(function(){return this.get(ratUrl,function(response){var author,entry,rat,revHash,reviews,_i,_j,_len,_len1,_ref,_ref1;reviews=JSON.parse(response);if(reviews.data.reviews){_ref=reviews.data.reviews;for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i],revHash={},author={},author.name=entry.author.screenName,author.url="http://www.kmart.com/shc/s/PublicProfileView?requestType=public_profile&langId=-1&storeId=10153&key="+entry.author.extUserId,revHash.author=author,revHash.kmartVerifiedPurchase=entry.author.isBuyer,revHash.title=entry.summary,revHash.review=entry.content;if(entry.attribute_rating){_ref1=entry.attribute_rating;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)rat=_ref1[_j],rat.attribute==="overall_rating"&&rat.attribute_type==="numeric"&&(revHash.rating=rat.value)}revHash.time=entry.published_date,revs.push(revHash)}value.reviews=revs}return this.done(!0),this.value(value)}),null})),switches.description&&(descUrl="http://www.kmart.com/content/pdp/config/products/v1/products/"+this.productSid+"?site=kmart",description=null,this.execBlock(function(){return this.get(descUrl,function(response){return description=JSON.parse(response),description.data.product.desc[0].type==="S"?description.data.product.desc[1].type==="L"?value.description=description.data.product.desc[0].val+description.data.product.desc[1].val:value.description=description.data.product.desc[0].val:description.data.product.seo.desc&&(value.description=description.data.product.seo.desc),this.done(!0),this.value(value)}),null})),switches.specifications&&(descUrl="http://www.kmart.com/content/pdp/config/products/v1/products/"+this.productSid+"?site=kmart",specs={},this.execBlock(function(){return this.get(descUrl,function(response){var entry,specHash,specifications,thing,_i,_j,_len,_len1,_ref,_ref1;specifications=JSON.parse(response);if(specifications.data.product.specs){_ref=specifications.data.product.specs;for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i],specHash={},_ref1=entry.attrs;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)thing=_ref1[_j],specHash[thing.name]=thing.val;specs[entry.grpName]=specHash}value.specifications=specs}return this.done(!0),this.value(value)}),null})),switches.rating&&(ratUrl="http://www.kmart.com/content/pdp/ratings/single/search/Kmart/"+this.productSid+"&targetType=product&limit=1&offset=0",this.execBlock(function(){return this.get(ratUrl,function(response){var rating;return rating=JSON.parse(response),rating.data.overall_rating&&(value.rating=rating.data.overall_rating),this.done(!0),this.value(value)}),null})),switches.ratingCount&&(ratUrl="http://www.kmart.com/content/pdp/ratings/single/search/Kmart/"+this.productSid+"&targetType=product&limit=1&offset=0",this.execBlock(function(){return this.get(ratUrl,function(response){var ratingCount;return ratingCount=JSON.parse(response),ratingCount.data.review_count&&(value.ratingCount=ratingCount.data.review_count),this.done(!0),this.value(value)}),null})),switches.originalPrice&&(number=this.productSid.value,number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),priceUrl="http://www.kmart.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0",this.execBlock(function(){return this.get(priceUrl,function(response){var altPriceUrl,originalPrice;return originalPrice=JSON.parse(response),originalPrice["price-response"]["item-response"]["regular-price"]&&(originalPrice["price-response"]["item-response"]["regular-price"]!=="0.00"?value.originalPrice=originalPrice["price-response"]["item-response"]["regular-price"]:(altPriceUrl="http://www.kmart.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber="+number+"P",this.execBlock(function(){return this.get(altPriceUrl,function(response){return originalPrice=response.match(/"prodRegPrice":([^,]+|[^"]+)/),originalPrice&&(value.originalPrice=originalPrice[1]),this.done(!0),this.value(value)}),null}))),this.done(!0),this.value(value)}),null})),this.value(value)})}},KmartProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Kmart/KmartSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var KmartSiteInjector;return KmartSiteInjector=function(_super){__extends(KmartSiteInjector,_super);function KmartSiteInjector(){return KmartSiteInjector.__super__.constructor.apply(this,arguments)}return KmartSiteInjector.prototype.productListing={imgSelector:'a img[src^="http://c.shld.net/rpx/"]',productSid:function(href,a,img){var match,name,sid,_ref,_ref1,_ref2;return name=(_ref=href.match(/^http:\/\/www\.kmart\.com\/[^\/]*\/p-([^?]*)/))!=null?_ref[1]:void 0,name||(name=(_ref1=href.match(/^http:\/\/www\.kmart\.com\/shc\/s\/p_.*?_.*?_([^_?]*)(?:\?|$)/))!=null?_ref1[1]:void 0),sid=name,sid||(href=unescape(href),match=(_ref2=/(www\.kmart\.com\/.*?)/.exec(href))!=null?_ref2[1]:void 0,match&&(sid=match)),sid}},KmartSiteInjector.prototype.productPage={test:function(){return $("body#product").length},productSid:function(){var sid,_ref,_ref1;return sid=(_ref=document.location.href.match(/^http:\/\/www\.kmart\.com\/shc\/s\/p_.*?_.*?_([^_?]*)(?:\?|$)/))!=null?_ref[1]:void 0,sid||(sid=(_ref1=document.location.href.match(/^http:\/\/www\.kmart\.com\/[^\/]*\/p-([^?]*)/))!=null?_ref1[1]:void 0),sid},imgEl:'div[data-id="product-image-main"] img',waitFor:'div[data-id="product-image-main"] img'},KmartSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"kohls",hosts:["www.kohls.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.kohls.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},define("sites/Kohls/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Kohls/KohlsProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var KohlsProductScraper;return KohlsProductScraper=function(_super){__extends(KohlsProductScraper,_super);function KohlsProductScraper(){return KohlsProductScraper.__super__.constructor.apply(this,arguments)}return KohlsProductScraper.testProducts=[],KohlsProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},KohlsProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.kohls.com/product/prd-"+this.productSid.id+"/.jsp",this.productSid.color&&(url+="?skuId="+this.productSid.color),url}}},KohlsProductScraper.prototype.resources={productPage:{url:function(){return"http://www.kohls.com/product/prd-"+this.productSid+"/.jsp"}}},KohlsProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<div class="sale">[\s]*Sale[\s]*\$([\S\s]*?)[\s]*<\/div>/),1],[new RegExp(/br_data.sale_price = "\$([^"]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var content,editorialReviews,erMatches,from,image,imageMatches,images,match,matches,options,overview,overviewMatches,rating,ratingURL,switches,text,title,value,_i,_j,_k,_len,_len1,_len2;switches={images:!0,description:!0,rating:!0,ratingCount:!0,originalPrice:!0,options:!0,shipping:!1},value={};if(switches.overview){overview=[],matches=this.resource.match(/<div id="product-commentary-overview-1"([\S\s]*?)<\/section>/),overviewMatches=matches[1].match(/<p([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p([\S\s]*?)<\/p>/),overview.push(text[1]);value.overview=overview}switches.description&&(matches=this.resource.match(/<div class="Bdescription">([\S\s]*?)<\/div>/),matches&&(value.description=matches[1])),switches.options&&(options=[],matches=this.resource.match(/var allVariants={([\S\s]*?)<\/script>/)),switches.rating&&(rating=[],ratingURL="http://kohls.ugc.bazaarvoice.com/9025/"+this.productSid+"/reviews.djs?format=embeddedhtml",this.execBlock(function(){return this.get(ratingURL,function(response){return match=response.match(/<span class=\\"BVRRNumber BVRRRatingNumber\\">([^<]*)/),match&&rating.push(match[1]),this.done(!0),this.value(value)}),null}),value.rating=rating),switches.reviewCount&&(matches=this.resource.match(/var numberOfReviews = "([^"]*)/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_j=0,_len1=erMatches.length;_j<_len1;_j++)match=erMatches[_j],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br \/>+|<br \/>+$/gm,""),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/br_data.price = "\$([^"]*)/),matches&&(value.originalPrice=matches[1]));if(switches.images){images={},matches=this.resource.match(/<div id="rightCarousel"([\S\s]*?)<\/div>/),imageMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g);for(_k=0,_len2=imageMatches.length;_k<_len2;_k++)match=imageMatches[_k],image=match.match(/rel="([^"]+)/),title=match.match(/title="([^"]+)/),images[title[1]]=image[1];value.images=images}return this.value(value)})}},KohlsProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Kohls/KohlsSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var KohlsSiteInjector;return KohlsSiteInjector=function(_super){__extends(KohlsSiteInjector,_super);function KohlsSiteInjector(){return KohlsSiteInjector.__super__.constructor.apply(this,arguments)}return KohlsSiteInjector.prototype.siteName="Kohls",KohlsSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProduct,initProducts;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),initProduct=function(el,sid){return _this.initProductEl(el,{productSid:sid},!1)},window.initProducts=initProducts=function(){var img,matches,src,_i,_len,_ref,_results;_ref=$('a img[src^="http://media.kohls.com.edgesuite.net/is/image/kohls/"]'),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],src=$(img).attr("src"),matches=/http:\/\/media\.kohls\.com\.edgesuite\.net\/is\/image\/kohls\/(\d+)/i.exec(src),matches?_results.push(initProduct(img,matches[1])):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3)}}(this))},KohlsSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"landsend",hosts:["www.landsend.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.landsend.com/favicon.ico"},define("sites/LandsEnd/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LandsEnd/LandsEndProduct",["scraping/SiteProduct","util","underscore"],function(SiteProduct,util,_){var LandsEndProduct;return LandsEndProduct=function(_super){__extends(LandsEndProduct,_super);function LandsEndProduct(){return LandsEndProduct.__super__.constructor.apply(this,arguments)}return LandsEndProduct.prototype.variantImage=function(variant,cb){return this.product["with"]("more",function(_this){return function(more){var color,_i,_len,_ref;_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++){color=_ref[_i];if(color.name===variant.Color){cb(more.images[color.id][0]);return}}return cb()}}(this))},LandsEndProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],images[color]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}();return cb(images)}}(this))},LandsEndProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var defs,name,values,widgets,_ref;defs={description:"Description",features:"Features",sizes:"Sizes"},_ref=more.properties;for(name in _ref)values=_ref[name],defs[name]={obj:values,title:name};return _.merge(defs,{colors:{title:"Colors",map:"name"},reviews:{obj:reviews,map:{review:"content"}}}),widgets=_this.genWidgets(more,defs),cb(widgets)}}(this))},LandsEndProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LandsEnd/LandsEndProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","util","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,util,_){var LandsEndProductScraper;return LandsEndProductScraper=function(_super){__extends(LandsEndProductScraper,_super);function LandsEndProductScraper(){return LandsEndProductScraper.__super__.constructor.apply(this,arguments)}return LandsEndProductScraper.prototype.version=1,LandsEndProductScraper.prototype.parseSid=function(sid){var id,style,_ref;return _ref=sid.split("-"),id=_ref[0],style=_ref[1],{id:id,style:style}},LandsEndProductScraper.productSid=function(background,url,cb,retrievalId){return background.httpRequest(url,{cb:function(response){var id,_ref;return id=(_ref=response.match(/<span id="mobileItemNumber_(\d*)">/))!=null?_ref[1]:void 0,id?cb(""+id+"-"+retrievalId):cb()}})},LandsEndProductScraper.prototype.resources={productPage:{url:function(){return"http://www.landsend.com/pp/StylePage-"+this.productSid.style+"_AL.html"}},reviewData:{url:function(){return"http://landsend.ugc.bazaarvoice.com/2008-en_us/"+this.productSid.id+"/reviews.djs?format=embeddedhtml"}}},LandsEndProductScraper.prototype.properties={title:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var regExp,style;return regExp=new RegExp("Style(\\d*).number = "+this.productSid.style),style=regExp.exec(this.resource)[1],regExp=new RegExp("Style"+style+'.longName = "([^"]*)";'),this.value(regExp.exec(this.resource)[1])})},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var matches;matches=/<span class='pp-was-price'>\$[^<]*<\/span>\s*<span>\s*NOW \$([^<]*)/.exec(this.resource);if(matches)return this.value(matches[1]);matches=/<p id="productPrice_\d*" class="pp-summary-price" >\s*<span>\$([^<]*)<\/span>\s*- \$([^<]*?)\s*<\/p>/.exec(this.resource);if(matches)return this.value(""+matches[1]+" - $"+matches[2]);matches=/<p id="productPrice_\d*" class="pp-summary-price"\s*>\s*\$([\d.]*)/.exec(this.resource);if(matches)return this.value(matches[1])})},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,colorMatch,colorMatches,colors,i,id,image,imageId,imageMap,imageMatch,imageMatches,images,mainImages,more,name,order,properties,propertyMatch,propertyMatches,valueMatches,__,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref,_ref1;more=this.declarativeScraper("scraper","more"),more.sizes=_.unique(this.matchAll(this.resource,/<a href="#" id="sizeId_\d*_\d*_([^"]*)/,1)),colorMatches=this.matchAll(this.resource,/<a id="colorId_\d*_\d*_([^"]*)"[^>]*>\s*<span>([^<]*)/),colors={};for(_i=0,_len=colorMatches.length;_i<_len;_i++)colorMatch=colorMatches[_i],colors[colorMatch[1]]=colorMatch[2];more.colors=function(){var _results;_results=[];for(id in colors)name=colors[id],_results.push({name:name,id:id});return _results}(),propertyMatches=this.matchAll(this.resource,/id="featureWrapper_([\S\s]*?)End of pp-sel/,1),properties={};for(_j=0,_len1=propertyMatches.length;_j<_len1;_j++)propertyMatch=propertyMatches[_j],name=propertyMatch.match(/<h3 class="pp-selector-label">\s*([^<]*)/)[1].trim(),properties[name]==null&&(properties[name]=[]),valueMatches=this.matchAll(propertyMatch,/<span class="pp-accessibility-text"><\/span>\s*([\S\s]*?)\s*<\/a>/,1),properties[name]=_.unique(properties[name].concat(valueMatches));mainImages=_.unique(this.matchAll(this.resource,/<img class="default" src="([^?]*)/,1)),order=[];for(i=_k=0,_len2=mainImages.length;_k<_len2;i=++_k)image=mainImages[i],order.push(image.match(/_([^_]*)_[^_]*$/)[1]);order=_.unique(order),imageMatches=_.unique(this.matchAll(this.resource,/ProductImage\d*\.fileName = "(\d*_[^_]*_[^_]*_([^"]*))"/,1)),imageMap={};for(_l=0,_len3=imageMatches.length;_l<_len3;_l++)imageMatch=imageMatches[_l],_ref=imageMatch.match(/_([^_]*)_([^_]*)$/),__=_ref[0],id=_ref[1],color=_ref[2],imageMap[color]==null&&(imageMap[color]={}),imageMap[color][id]=imageMatch;images={},_ref1=more.colors;for(_m=0,_len4=_ref1.length;_m<_len4;_m++)color=_ref1[_m],images[color.id]=function(){var _len5,_n,_results;_results=[];for(_n=0,_len5=order.length;_n<_len5;_n++)imageId=order[_n],_results.push("http://s7.landsend.com/is/image/LandsEnd/"+imageMap[color.id][imageId]);return _results}();return more.images=images,more.properties=properties,this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},LandsEndProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LandsEnd/LandsEndSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var LandsEndSiteInjector;return LandsEndSiteInjector=function(_super){__extends(LandsEndSiteInjector,_super);function LandsEndSiteInjector(){return LandsEndSiteInjector.__super__.constructor.apply(this,arguments)}return LandsEndSiteInjector.prototype.productListing={mode:2,selectors:{"[data-product-number][data-style-number]":{productData:function(href,a,img,el){return{productSid:""+el.attr("data-product-number")+"-"+el.attr("data-style-number")}},image:function(el){return el.find(".product-image")},anchor:function(el){return el.find(".product-image-link")}},'a img[src*="s7.landsend.com/is/image/LandsEnd/"]':{productData:function(href,a,img,el){var style,_ref;style=(_ref=img.attr("src").match(/\/s7\.landsend\.com\/is\/image\/LandsEnd\/(\d*)/))!=null?_ref[1]:void 0;if(style)return{productUrl:href,retrievalId:style}}}}},LandsEndSiteInjector.prototype.productPage={mode:2,productSid:function(){var id,style,_ref;return id=(_ref=$('h1[id^="mobileProductName_"]').attr("id").match(/mobileProductName_(\d*)/))!=null?_ref[1]:void 0,style=$("#itemNumber_"+id).text().match(/\d*/)[0],""+id+"-"+style},image:'.pp-image-viewer-column.fn-image-viewer-wrap.pp-product-image-column img[src^="http://s7.landsend.com/is/image/LandsEnd"]:visible',overlay:'.pp-image-viewer-column.fn-image-viewer-wrap.pp-product-image-column div[id^="mapImageSjElement"]',attach:"body",position:'div[id^="productImage_"]',variant:function(){return{Color:jQuery('span[id^="colorChoice_"]:visible').text()}}},LandsEndSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"llbean",hosts:["www.llbean.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.llbean.com/favicon.ico"},define("sites/LLBean/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LLBean/LLBeanProduct",["scraping/SiteProduct","util","underscore"],function(SiteProduct,util,_){var LLBeanProduct;return LLBeanProduct=function(_super){__extends(LLBeanProduct,_super);function LLBeanProduct(){return LLBeanProduct.__super__.constructor.apply(this,arguments)}return LLBeanProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,image,images,otherImages,_ref;otherImages=function(){var _i,_len,_ref,_results;_ref=more.images,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}(),images={},_ref=more.colorImages;for(color in _ref)image=_ref[color],images[color]=[{small:"http://cdni.llbean.com/is/image/"+image,medium:"http://cdni.llbean.com/is/image/"+image,large:"http://cdni.llbean.com/is/image/"+image,larger:"http://cdni.llbean.com/is/image/"+image,full:"http://cdni.llbean.com/is/image/"+image}].concat(otherImages);return cb(images)}}(this))},LLBeanProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var defs,name,values,widgets,_ref;defs={description:"Description",details:"Details",sizes:"Sizes"},_ref=more.properties;for(name in _ref)values=_ref[name],defs[name]={obj:values,title:name};return _.merge(defs,{colors:"Colors",reviews:{obj:reviews,map:{review:"content"}}}),widgets=_this.genWidgets(more,defs),cb(widgets)}}(this))},LLBeanProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LLBean/LLBeanProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","util","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,util,_){var LLBeanProductScraper;return LLBeanProductScraper=function(_super){__extends(LLBeanProductScraper,_super);function LLBeanProductScraper(){return LLBeanProductScraper.__super__.constructor.apply(this,arguments)}return LLBeanProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},LLBeanProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.llbean.com/llb/shop/"+this.productSid.id,this.productSid.color&&(url+="?attrValue_0="+this.productSid.color),url}},reviewData:{requires:"productPage",url:function(resource){var reviewId;return reviewId=resource.match(/"reviewId" : "([^"]*)"/)[1],"http://llbean.ugc.bazaarvoice.com/1138jspdp-en_us/"+reviewId+"/reviews.djs?format=embeddedhtml"}}},LLBeanProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var max,min,prices;return prices=this.matchAll(this.resource,/(?:toOrderItemPrice|toOrderItemSalePrice)[\S\s]*?\$([\d.]*)/,1),prices.length>1?(min=Math.min.apply(Math,prices),max=Math.max.apply(Math,prices),this.value(""+min+" - $"+max)):this.value(prices[0])})},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,colorMatch,colorMatches,colors,i,imageMatches,images,imgs,match,matches,more,name,obj,properties,values,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_ref;more=this.declarativeScraper("scraper","more"),matches=this.matchAll(this.resource,/"attributeArrays"[\S\s]*?"attributeDescriptions": \[[^\]]*\]/,0),properties={};for(_i=0,_len=matches.length;_i<_len;_i++){match=matches[_i],obj=JSON.parse("{"+match+"}"),_ref=obj.attributeArrays;for(i=_j=0,_len1=_ref.length;_j<_len1;i=++_j)values=_ref[i],name=obj.attributeDescriptions[i],properties[name]==null&&(properties[name]=[]),properties[name]=properties[name].concat(values)}for(name in properties)values=properties[name],properties[name]=_.unique(values);properties.Size&&(more.sizes=properties.Size,delete properties.Size),properties["Color/Style"]&&(more.colors=properties["Color/Style"],delete properties["Color/Style"]),more.properties=properties,colorMatches=this.matchAll(this.resource,/"colorNames":(\[[^\]]*\]),/,1),imageMatches=this.matchAll(this.resource,/"mainImagesZoomPath":(\[[^\]]*\]),/,1),images={};for(i=_k=0,_len2=colorMatches.length;_k<_len2;i=++_k){colorMatch=colorMatches[i],colors=JSON.parse(colorMatch),imgs=JSON.parse(imageMatches[i]);for(i=_l=0,_len3=colors.length;_l<_len3;i=++_l)color=colors[i],images[color]=imgs[i]}more.colorImages=images,images=[],matches=this.matchAll(this.resource,/name="([^"]*)"\s*src="([^"]*)"/);for(_m=0,_len4=matches.length;_m<_len4;_m++)match=matches[_m],match[1]!=="main"&&images.push("http:"+match[2]);return more.images=images,this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},LLBeanProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LLBean/LLBeanSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var LLBeanSiteInjector;return LLBeanSiteInjector=function(_super){__extends(LLBeanSiteInjector,_super);function LLBeanSiteInjector(){return LLBeanSiteInjector.__super__.constructor.apply(this,arguments)}return LLBeanSiteInjector.prototype.productListing={image:'a[href*="/llb/shop/"] img',productSid:function(href,a,img){var _ref;return(_ref=href.match(/\/llb\/shop\/(\d*)/))!=null?_ref[1]:void 0}},LLBeanSiteInjector.prototype.productPage={mode:2,productSid:function(){var color,id,_ref;return id=(_ref=document.location.href.match(/\/llb\/shop\/(\d*)/))!=null?_ref[1]:void 0,color=$(".pdSelectedSwatch:visible").find("img").attr("name"),color?""+id+"-"+color:id},image:'img[id^="foreImageSjElement"]',attach:"body",overlay:'div[id^="mapImageSjElement"]'},LLBeanSiteInjector}(DataDrivenSiteInjector)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Lowes/LowesProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var LowesProductScraper;return LowesProductScraper=function(_super){__extends(LowesProductScraper,_super);function LowesProductScraper(){return LowesProductScraper.__super__.constructor.apply(this,arguments)}return LowesProductScraper.testProducts=["6051381"],LowesProductScraper.prototype.resources={productPage:{url:function(){return"http://www.lowes.com/pd_"+this.productSid}}},LowesProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Lowes/LowesSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var LowesSiteInjector;return LowesSiteInjector=function(_super){__extends(LowesSiteInjector,_super);function LowesSiteInjector(){return LowesSiteInjector.__super__.constructor.apply(this,arguments)}return LowesSiteInjector.prototype.siteName="Lowes",LowesSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.walgreens\.com\/store\/c\/.*?\/ID=prod([^-]+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($("#viewL").length)return currentSid=function(){return/^http:\/\/www\.walgreens\.com\/store\/c\/.*?\/ID=prod([^-]+)/.exec(document.location.href)[1]},_this.waitFor("#viewL img",function(){return _this.initProductEl($("#viewL img"),{productSid:currentSid()})})})}}(this))},LowesSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"lulus",hosts:["www.lulus.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://cdn.lulus.com/images/icons/favicon.ico",twoTap:!0},define("sites/LuLus/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LuLus/LuLusProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var LuLuProduct;return LuLuProduct=function(_super){__extends(LuLuProduct,_super);function LuLuProduct(){return LuLuProduct.__super__.constructor.apply(this,arguments)}return LuLuProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,images,_i,_len,_ref;images=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],images.push({small:image,medium:image,large:image,larger:image,full:image.replace("small","xlarge")});return cb({"":images},"")}}(this))},LuLuProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(_this){return function(reviews){return cb({reviews:util.mapObjects(reviews,{rating:function(review){return review.rating/100*5}})})}}(this))},LuLuProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",reviews:{obj:reviews,map:{review:"content",rating:function(rating){return rating/100*5}}}}),cb(widgets)}}(this))},LuLuProduct}(SiteProduct)}),define("sites/LuLus/LulusProductScraper",["scraping/ProductScraper"],function(ProductScraper){return ProductScraper.declarativeProductScraper("scraper",{resources:{productPage:{url:function(){return"http://www.lulus.com/products/"+this.productSid+".html"}}},scraper:"scraper",resource:"productPage",mapping:{rating:function(rating){return rating/100*5}}})});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/LuLus/LulusSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var LulusSiteInjector;return LulusSiteInjector=function(_super){__extends(LulusSiteInjector,_super);function LulusSiteInjector(){return LulusSiteInjector.__super__.constructor.apply(this,arguments)}return LulusSiteInjector.prototype.productListing={mode:2,selectors:{"div.category div.category-image":{image:function(el){return el.find(".image img:first")},anchor:function(el){return el.find(".mousetrap .trap-link")},anchorProxy:!0,productData:function(href,a,img,el){var matches;matches=href.match("http://www\\.lulus\\.com/products.*?/([^./]*)\\.html");if(matches)return{productSid:matches!=null?matches[1]:void 0}}},'a img[src^="http://cdn.lulus.com/images/product/"], a img[src^="/images/product/"]':{productData:function(href,a,img){var matches;matches=href.match("http://www\\.lulus\\.com/products.*?/([^./]*)\\.html");if(matches)return{productSid:matches!=null?matches[1]:void 0}}}}},LulusSiteInjector.prototype.productPage={mode:2,test:function(){return document.location.href.match("http://www\\.lulus\\.com/products.*?/([^./]*)\\.html")},productSid:function(){return document.location.href.match("http://www\\.lulus\\.com/products.*?/([^./]*)\\.html")[1]},image:"#zoom1 img",overlay:".mousetrap",attach:"body",zIndex:9999},LulusSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"macys",hosts:["www.macys.com","www1.macys.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.macys.com/favicon.ico",productUrl:function(sid){return""}},define("sites/Macys/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Macys/MacysProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var MacysProductScraper;return MacysProductScraper=function(_super){__extends(MacysProductScraper,_super);function MacysProductScraper(){return MacysProductScraper.__super__.constructor.apply(this,arguments)}return MacysProductScraper.prototype.resources={productPage:{url:function(){return"http://www1.macys.com/shop/product/?ID="+this.productSid}}},MacysProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<h1 id="productTitle" class="productTitle" itemprop="name">([^<]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta itemprop="price" content="\$([^"]*)/),1)},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta xmlns:og="http:\/\/ogp\.me\/ns#" xmlns:fb="http:\/\/www\.facebook\.com\/2008\/fbml" property="og:image" content="([^"]*)/),1)}},MacysProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Macys/MacysSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var MacysSiteInjector;return MacysSiteInjector=function(_super){__extends(MacysSiteInjector,_super);function MacysSiteInjector(){return MacysSiteInjector.__super__.constructor.apply(this,arguments)}return MacysSiteInjector.prototype.siteName="Macys",MacysSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/[^.]*\.macys\.com\/shop\/product\/[^?]*\?ID=(\d*)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?_results.push(_this.initProductEl(img,{productSid:sid})):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($('meta[name="twitter:card"]').attr("value")==="Product")return currentSid=function(){return $('meta[itemprop="productID"]').attr("content")},_this.initProductEl($("#imageZoomer"),{productSid:currentSid()},{initOverlay:function(overlay){return overlay.addAlwaysShow("productPage"),overlay.autoFixPosition(),overlay.el.css("zIndex",1e5)}})})}}(this))},MacysSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews"],hasProductClass:!0,slug:"makemechic",hosts:["www.makemechic.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.makemechic.com/favicon.ico"},define("sites/MakeMeChic/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/MakeMeChic/MakeMeChicProduct",["scraping/SiteProduct"],function(SiteProduct){var MakeMeChicProduct;return MakeMeChicProduct=function(_super){__extends(MakeMeChicProduct,_super);function MakeMeChicProduct(){return MakeMeChicProduct.__super__.constructor.apply(this,arguments)}return MakeMeChicProduct.prototype.variantImage=function(variant,cb){return this.product["with"]("more",function(_this){return function(more){var _ref;return cb((_ref=more.images)!=null?_ref[variant.Color][0].small:void 0)}}(this))},MakeMeChicProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorImages,image,images,_ref;images={},_ref=more.images;for(color in _ref)colorImages=_ref[color],images[color]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colorImages.length;_i<_len;_i++)image=colorImages[_i],_results.push({small:image.small,medium:image.big,large:image.big,larger:image.big,full:image.big});return _results}();return cb(images,more.color)}}(this))},MakeMeChicProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",details:"Details",colors:{title:"Colors",map:function(color){return color.name}}}),cb(widgets)}}(this))},MakeMeChicProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/MakeMeChic/MakeMeChicProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var MakeMeChicProductScraper;return MakeMeChicProductScraper=function(_super){__extends(MakeMeChicProductScraper,_super);function MakeMeChicProductScraper(){return MakeMeChicProductScraper.__super__.constructor.apply(this,arguments)}return MakeMeChicProductScraper.prototype.parseSid=function(sid){return{name:sid}},MakeMeChicProductScraper.prototype.resources={productPage:{url:function(){return"http://www.makemechic.com/"+this.productSid.name+".html"}}},MakeMeChicProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,colorAbbreviation,colorId,imageUrl,images,match,more,obj,option,_fn,_i,_j,_len,_len1,_ref,_ref1,_ref2;more=this.declarativeScraper("scraper","more"),imageUrl=/<meta property="og:image" content="([^"]*)/.exec(this.resource)[1],colorAbbreviation=imageUrl.match(/\/\w+-([a-z]+)[^\/]*\.jpg$/)[1],colorId=(_ref=this.resource.match(new RegExp('<li class="color-swatch-85-(\\d*)\\s*">\\s*<span[^>]*>[^<]*</span>\\s*<img class="image-base" src="[^"]*/\\w+-'+colorAbbreviation+'.\\w+"')))!=null?_ref[1]:void 0;if(colorId){_ref1=more.colors;for(_i=0,_len=_ref1.length;_i<_len;_i++){color=_ref1[_i];if(color.id===colorId){more.color=color.name;break}}}match=/var spConfig = new Product.Config\((.*?)\);/.exec(this.resource)[1],obj=JSON.parse(match),images={},more.images=images,_ref2=obj.attributes[85].options,_fn=function(_this){return function(option){return _this.execBlock(function(){return this.post("http://www.makemechic.com/cloudzoom/ajax/images/",_.map(option.products,function(i){return"products[]="+i}).join("&"),function(response){var imgs;return imgs=JSON.parse(response),images[option.label]=_.map(imgs,function(img){return{small:img.small,big:img.big}}),this.value(more),this.done(!0)}),null})}}(this);for(_j=0,_len1=_ref2.length;_j<_len1;_j++)option=_ref2[_j],_fn(option);return this.value(more)})}},MakeMeChicProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/MakeMeChic/MakeMeChicSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var MakeMeChicSiteInjector;return MakeMeChicSiteInjector=function(_super){__extends(MakeMeChicSiteInjector,_super);function MakeMeChicSiteInjector(){return MakeMeChicSiteInjector.__super__.constructor.apply(this,arguments)}return MakeMeChicSiteInjector.prototype.productListing={image:'a img[src^="http://www.makemechic.com/media/catalog/product"]',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/([^\/]*?)\.html$/))!=null?_ref[1]:void 0,name}},MakeMeChicSiteInjector.prototype.productPage={mode:2,test:function(){return $('meta[property="og:type"]').attr("content")==="product"},productSid:function(){return document.location.href.match(/([^\/]*?)\.html$/)[1]},image:"#wrap img",overlay:".mousetrap",attach:"#image",variant:function(){var className,colorAbbreviation,colorId,colorName;return colorAbbreviation=$("#image img").attr("src").match(/\/\w+-([a-z]+)[^\/]*\.\w*$/)[1],className=$(".color-swatch-wrapper").find("img[src*='-"+colorAbbreviation+"']").parent().get(0).className,colorId=className.match(/color-swatch-\d*-(\d*)/)[1],colorName=$("#attribute85").find("option[value="+colorId+"]").html(),{Color:colorName}}},MakeMeChicSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"modcloth",hosts:["www.modcloth.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.modcloth.com/favicon.ico",twoTap:!0},define("sites/ModCloth/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ModCloth/ModClothProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var ModClothProduct;return ModClothProduct=function(_super){__extends(ModClothProduct,_super);function ModClothProduct(){return ModClothProduct.__super__.constructor.apply(this,arguments)}return ModClothProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=_.map(more.images,function(image){var _ref;return{small:image.pdp,medium:image.pdp,large:image.pdp,larger:image.pdp,full:(_ref=image.hiRes)!=null?_ref:image.pdp}}),cb({"":images},"")}}(this))},ModClothProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(_this){return function(reviews){return cb({reviews:util.mapObjects(reviews,{review:"comment"})})}}(this))},ModClothProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",details:"Details","details.features":"Features","details.material":"Material",reviews:{obj:reviews,map:{review:"comment",title:function(){return""}}}}),cb(widgets)}}(this))},ModClothProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ModCloth/ModClothProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var ModClothProductScraper;return ModClothProductScraper=function(_super){__extends(ModClothProductScraper,_super);function ModClothProductScraper(){return ModClothProductScraper.__super__.constructor.apply(this,arguments)}return ModClothProductScraper.prototype.parseSid=function(sid){var name,sku,_ref;return _ref=sid.split(":"),sku=_ref[0],name=_ref[1],{sku:sku,name:name}},ModClothProductScraper.prototype.resources={mainProductPage:{url:function(){return"http://www.modcloth.com/shop/-/"+this.productSid.name}},productPage:{url:function(){return"http://www.modcloth.com/storefront/products/"+this.productSid.sku+"/product_quickview"}},reviewsPage:{url:function(){return"http://www.modcloth.com/storefront/reviews/view_more/"+this.productSid.sku+"?place=0"}}},ModClothProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var more;return more=this.declarativeScraper("scraper","more"),this.execBlock(function(){return this.getResource("mainProductPage",function(resource){var images;return images=this.declarativeScraper("images","images",resource),more.images=images,this.value(more),this.done(!0)}),null}),this.value(more)})},rating:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var rating,_ref;rating=(_ref=this.resource.match(/<li class='current-rating' style='width:(\d*)px'>/))!=null?_ref[1]:void 0;if(rating!=null)return this.value(rating/20)})},reviews:{resource:"reviewsPage",scraper:ScriptedResourceScraper(function(){var author,comment,date,html,rating,reviewMatch,reviewMatches,reviews;return html=JSON.parse(this.resource).html,reviewMatches=this.matchAll(html,/<div class="review_wrapper user-review">([\S\s]*?<div class="review_datetime">[\S\s]*?<)/,1),reviews=function(){var _i,_len,_results;_results=[];for(_i=0,_len=reviewMatches.length;_i<_len;_i++)reviewMatch=reviewMatches[_i],comment=reviewMatch.match(/<div class="review_comment">\s*([\S\s]*?)\s*<\/div>/)[1],author=reviewMatch.match(/<div class="review_info_name">\s*([\S\s]*?)\s*</)[1],date=reviewMatch.match(/<div class="review_datetime">\s*([\S\s]*?)\s*</)[1],rating=reviewMatch.match(/<div class='is-(\d*)-star/)[1],_results.push({comment:comment,author:author,date:date,rating:rating});return _results}(),this.value(reviews)})}},ModClothProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ModCloth/ModClothSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var ModClothSiteInjector;return ModClothSiteInjector=function(_super){__extends(ModClothSiteInjector,_super);function ModClothSiteInjector(){return ModClothSiteInjector.__super__.constructor.apply(this,arguments)}return ModClothSiteInjector.prototype.productListing={image:'li[data-id] a img, a img[src^="http://productshots"]',productSid:function(href,a,img){var id,name,_ref,_ref1;if(a.parents("li[data-id]").length)return""+a.parents("li[data-id]").attr("data-id")+":"+href.match(/[^\/]*$/)[0];if(a.attr("data-analytics-ga")){id=(_ref=a.attr("data-analytics-ga").match(/\[%22.*?%22,%22.*?%22,%22\d*:(\d*)/))!=null?_ref[1]:void 0;if(id){name=(_ref1=href.match(/\/-?([^\/]*)$/))!=null?_ref1[1]:void 0;if(name)return""+id+":"+name.toLowerCase()}}}},ModClothSiteInjector.prototype.productPage={initPage:function(){return $("#image-container").after($('<div id="agora" />').css({zIndex:4,position:"absolute",top:0,left:0}))},mode:2,test:function(){return $('meta[property="og:type"]').attr("content")==="product"},productSid:function(){return""+$(".wishlist_btn_container").attr("data-product-id")+":"+document.location.href.match(/([^\/]*?)(?:\?|$)/)[1]},attach:"#agora",position:"#image-container",image:"#zoomable img"},ModClothSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"nastygal",hosts:["www.nastygal.com","nastygal.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://assets.nastygal.com/assets/current/images/favicon/favicon-32.png",twoTap:!0},define("sites/NastyGal/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/NastyGal/NastyGalProduct",["scraping/SiteProduct"],function(SiteProduct){var NastyGirlProduct;return NastyGirlProduct=function(_super){__extends(NastyGirlProduct,_super);function NastyGirlProduct(){return NastyGirlProduct.__super__.constructor.apply(this,arguments)}return NastyGirlProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=_.map(more.images,function(image){return{small:image,medium:image,large:image,larger:image,full:image}}),cb({"":images},"")}}(this))},NastyGirlProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:{title:"Description",maxHeight:"none"},sizes:"Sizes"}),cb(widgets)}}(this))},NastyGirlProduct}(SiteProduct)}),define("sites/NastyGal/NastyGalProductScraper",["scraping/ProductScraper"],function(ProductScraper){return ProductScraper.declarativeProductScraper("scraper",{parseSid:function(sid){var name,style,_ref;return _ref=sid.split(":"),style=_ref[0],name=_ref[1],{style:style,name:name}},resources:{productPage:{url:function(){return"http://www.nastygal.com/-/"+this.productSid.name.toLowerCase()}}},scraper:"scraper",resource:"productPage"})});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/NastyGal/NastyGalSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var NastyGirlSiteInjector;return NastyGirlSiteInjector=function(_super){__extends(NastyGirlSiteInjector,_super);function NastyGirlSiteInjector(){return NastyGirlSiteInjector.__super__.constructor.apply(this,arguments)}return NastyGirlSiteInjector.prototype.productListing={mode:2,image:"a img",positionA:!0,productSid:function(href,a,img){var matches,name,_ref;if(matches=img.attr("src").match(/(?:http:)?\/\/images\d*\.nastygal\.com\/resources\/nastygal\/images\/products\/processed\/(\d*)/)){name=(_ref=a.attr("href").match(/[^\/]*$/))!=null?_ref[0]:void 0;if(name)return""+matches[1]+":"+name}}},NastyGirlSiteInjector.prototype.productPage={mode:2,test:function(){return $('meta[property="og:type"]').attr("content")==="product"},productSid:function(){var name,style,_ref;return name=(_ref=document.location.href.match(/[^\/]*$/))!=null?_ref[0]:void 0,style=$(".product-style").text().match(/(\d*)$/)[1],""+style+":"+name},attach:".product-images",position:".product-images",image:"#product-images-carousel img"},NastyGirlSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasMore:!1,slug:"newegg",hosts:["www.newegg.com"],currency:"dollar",scraper:!0,icon:"http://www.newegg.com/favicon.ico",productUrl:function(sid){},query:function(product){var details,model,more,name,section,value,_ref;more=product.get("more"),model=null,_ref=more.details;for(section in _ref){details=_ref[section];for(name in details){value=details[name];if(name==="Model"){model=value;break}}if(model)break}return{sku:product.get("productSid"),brand:product.get("more").brand.name,model:model}}},define("sites/Newegg/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Newegg/NeweggProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,_){var NeweggProductScraper,matchAll,unescape;return matchAll=function(string,pattern){var match,matches,_i,_len,_results;matches=string.match(new RegExp(_.isString(pattern)?pattern:pattern.source,"g"));if(matches){_results=[];for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],_results.push(match.match(pattern));return _results}return[]},unescape=function(string){var from,map,to;map={"&#58;":":","&#47;":"/"};for(from in map)to=map[from],string=string.replace(new RegExp(from,"g"),to);return string},NeweggProductScraper=function(_super){__extends(NeweggProductScraper,_super);function NeweggProductScraper(){return NeweggProductScraper.__super__.constructor.apply(this,arguments)}return NeweggProductScraper.prototype.resources={productPage:{url:function(){return"http://www.newegg.com/Product/Product.aspx?Item="+this.productSid}},detailsPage:{url:function(){return"http://www.newegg.com/LandingPage/ItemInfo4ProductDetail2013.aspx?Item="+this.productSid+"&v2=2012"}},relationPage:{url:function(){return"http://content.newegg.com/Common/Ajax/RelationItemInfo.aspx?item="+this.productSid+"&type=Newegg&v2=2012"}}},NeweggProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/"imageTitle":"([^"]*)/),1)},price:{resource:"detailsPage",scraper:ScriptedResourceScraper(function(){var matches;return matches=this.resource.match(/"finalPrice":"([^"]*)"/),matches?this.value(matches[1]):(matches=this.resource.match(/<li class=\\"price-current \\" itemprop=\\"price\\" content=\\"([^\\]*)\\"/),this.value(matches[1]))})},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<img id="mainSlide[^"]*" onload="[^"]*" title="[^"]*" alt="[^"]*" src="([^"]*)/),1)}},NeweggProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Newegg/NeweggSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var NeweggSiteInjector;return NeweggSiteInjector=function(_super){__extends(NeweggSiteInjector,_super);function NeweggSiteInjector(){return NeweggSiteInjector.__super__.constructor.apply(this,arguments)}return NeweggSiteInjector.prototype.siteName="Newegg",NeweggSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.newegg\.com\/Product\/Product\.aspx\?Item=(.*)$/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?_results.push(_this.initProductEl(img,{productSid:sid},{initOverlay:function(overlay){return overlay.autoFixPosition()}})):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3)}}(this))},NeweggSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"nordstrom",hosts:["shop.nordstrom.com","www.nordstrom.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.nordstrom.com/favicon.ico",twoTap:!0},define("sites/Nordstrom/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Nordstrom/NordstromProduct",["scraping/SiteProduct","underscore","util"],function(SiteProduct,_,util){var NordstromProduct;return NordstromProduct=function(_super){__extends(NordstromProduct,_super);function NordstromProduct(){return NordstromProduct.__super__.constructor.apply(this,arguments)}return NordstromProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images,otherImages;return otherImages=_.map(more.images,function(image){return{small:image.replace(/mini/i,"thumbnail"),medium:image.replace(/mini/i,"large"),large:image.replace(/mini/i,"large"),larger:image.replace(/mini/i,"large"),full:image.replace(/mini/i,"zoom")}}),images=_.mapValues(more.colorImages,function(image){return[{small:image,medium:image.replace(/thumbnail/i,"large"),large:image.replace(/thumbnail/i,"large"),larger:image.replace(/thumbnail/i,"large"),full:image.replace(/thumbnail/i,"zoom")}].concat(otherImages)}),cb(images,more.color)}}(this))},NordstromProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",details:"Details",sizeInfo:"Size Info",sizes:"Sizes",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews,map:{review:"content"}}}),cb(widgets)}}(this))},NordstromProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Nordstrom/NordstromProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore","util"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_,util){var NordstromProductScraper;return NordstromProductScraper=function(_super){__extends(NordstromProductScraper,_super);function NordstromProductScraper(){return NordstromProductScraper.__super__.constructor.apply(this,arguments)}return NordstromProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},NordstromProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://shop.nordstrom.com/s/"+this.productSid.id,this.productSid.color&&(url+="?fashionColor="+this.productSid.color),url}},reviewData:{url:function(){return"http://nordstrom.ugc.bazaarvoice.com/4094redes/"+this.productSid.id+"/reviews.djs?format=embeddedhtml"}}},NordstromProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,colorImages,colorMap,match,matches,more,_i,_j,_len,_len1,_ref;more=this.declarativeScraper("scraper","more"),match=/window.PageParameters=(\{[\S\s]*?\});/.exec(this.resource)[1],colorMap={},_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],colorMap[color.id]=color.name;matches=_.unique(this.matchAll(match,/"colorId":"([^"]*)","thumbnail":"([^"]*)"/,0)),colorImages={};for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],match=match.match(/"colorId":"([^"]*)","thumbnail":"([^"]*)"/),colorMap[match[1]]&&(color=util.ucfirst(colorMap[match[1]]),colorImages[color]=match[2]);return more.colorImages=colorImages,this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/BVRRRatingSummaryLinkWriteFirstID/,0,function(){return 0}],[/alt=\\"([\d.]*) out of 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/BVRRRatingSummaryLinkWriteFirstID/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) out of 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},NordstromProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Nordstrom/NordstromSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var NordstromSiteInjector,parseUrl;return parseUrl=function(url){var _ref;return(_ref=url.match(/^http:\/\/shop\.nordstrom\.com\/s\/(?:[^\/]*\/)?(\d*)/i))!=null?_ref[1]:void 0},NordstromSiteInjector=function(_super){__extends(NordstromSiteInjector,_super);function NordstromSiteInjector(){return NordstromSiteInjector.__super__.constructor.apply(this,arguments)}return NordstromSiteInjector.prototype.productListing={mode:2,image:'a img[src^="http://g.nordstromimage.com/imagegallery/store/product/"]',productSid:function(href,a,img){var match,sid,_ref;return sid=parseUrl(href),sid||(href=unescape(href),match=(_ref=/(http:\/\/shop\.nordstrom\.com\/.*?)(?:&|$)/.exec(href))!=null?_ref[1]:void 0,match&&(sid=parseUrl(match))),sid}},NordstromSiteInjector.prototype.productPage={test:function(){return document.location.href.match(/^http:\/\/shop\.nordstrom\.com\/s\/(?:[^\/]*\/)?(\d*)/i)},productSid:function(){var color,id;return id=document.location.href.match(/^http:\/\/shop\.nordstrom\.com\/s\/(?:[^\/]*\/)?(\d*)/i)[1],$(".selector.color.narrow select").prop("selectedIndex")?(color=$(".selector.color.narrow select option:selected").text().trim(),""+id+"-"+color):id},imgEl:"#advancedImageViewer .fashion-photo-wrapper img",overlayEl:"#advancedImageViewer .dragImage"},NordstromSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"overstock",hosts:["www.overstock.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.overstock.com/favicon.ico",productUrl:function(sid){return""}},define("sites/Overstock/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Overstock/OverstockProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var OverstockProductScraper;return OverstockProductScraper=function(_super){__extends(OverstockProductScraper,_super);function OverstockProductScraper(){return OverstockProductScraper.__super__.constructor.apply(this,arguments)}return OverstockProductScraper.prototype.resources={productPage:{url:function(){return"http://www.overstock.com/"+this.productSid+"/product.html"}}},OverstockProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<div itemprop="name">\s*<h1>([^<]*)<\/h1>\s*<\/div>/),1)},price:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<span name="[^"]*" class="[^"]*"\s*itemprop="price"\s*>\s*\$(\S*)/),1)},image:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<div class="proImageCenter">\s*<img src="([^"]*)/),1],[new RegExp(/<img width="[^"]*" id="activeImage" src="([^"]*)/),1]])}},OverstockProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Overstock/OverstockSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var OverstockSiteInjector;return OverstockSiteInjector=function(_super){__extends(OverstockSiteInjector,_super);function OverstockSiteInjector(){return OverstockSiteInjector.__super__.constructor.apply(this,arguments)}return OverstockSiteInjector.prototype.siteName="Overstock",OverstockSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProduct,initProducts;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),initProduct=function(el,sid){return _this.initProductEl(el,{productSid:sid})},window.initProducts=initProducts=function(){var img,matches,src,_i,_len,_ref,_results;_ref=$('img[src^="http://ak1.ostkcdn.com/images/products/"]'),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],src=$(img).attr("src"),matches=/^http:\/\/ak1\.ostkcdn\.com\/images\/products\/(\d+)/.exec(src),matches?_results.push(initProduct(img,matches[1])):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3)}}(this))},OverstockSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"qvc",hosts:["www.qvc.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.qvc.com/favicon.ico"},define("sites/QVC/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/QVC/QVCProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var QVCProduct;return QVCProduct=function(_super){__extends(QVCProduct,_super);function QVCProduct(){return QVCProduct.__super__.constructor.apply(this,arguments)}return QVCProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,image,images,imgs,longId,otherImages,shortId,_i,_j,_len,_len1,_ref,_ref1,_ref2;otherImages=[],_ref=more.images.pics;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],image=image.match(/^(.*?)\?/)[1],otherImages.push({small:image+"?scl=1&fmt=jpeg",medium:image+"?scl=1&fmt=jpeg",large:image+"?scl=1&fmt=jpeg",larger:image+"?scl=1&fmt=jpeg",full:image+"?scl=1&fmt=jpeg"});images={},_ref1=more.images.colorPics;for(color in _ref1)image=_ref1[color],imgs=[],image=image.match(/^(.*?)\?/)[1],imgs.push({small:image+"?scl=10&fmt=jpeg",medium:image+"?scl=6&fmt=jpeg",large:image+"?scl=3&fmt=jpeg",larger:image+"?scl=2&fmt=jpeg",full:image+"?scl=1&fmt=jpeg"}),imgs=imgs.concat(otherImages),images[color]=imgs;longId=_this.product.get("productSid").split("-")[1],shortId=null;if(longId){_ref2=more.colors;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){color=_ref2[_j];if(color.longId===longId){shortId=color.shortId;break}}}return cb(images,shortId)}}(this))},QVCProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/QVC/QVCProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var QVCProductScraper;return QVCProductScraper=function(_super){__extends(QVCProductScraper,_super);function QVCProductScraper(){return QVCProductScraper.__super__.constructor.apply(this,arguments)}return QVCProductScraper.testProducts=["E249454"],QVCProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},QVCProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.qvc.com/.product."+this.productSid.id+".html",this.productSid.color&&(url+="?itemId="+this.productSid.color),url}}},QVCProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<p id="parProductDetailPrice">\$([\S\s]*?)<\/p>/),1]])},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var matches,shortId,url;return matches=this.resource.match(/var arrSizeValues = new Array([\S\s]*?)<\/script>/),shortId=matches[1].match(new RegExp(""+this.productSid.color+":[^:]*:[^:]*:([^:]*)","i"))[1].toLowerCase(),url="http://images.qvc.com/is/image/"+this.resource.match(/<meta property="og:image" content="http:\/\/images.qvc.com\/is\/image\/([^\.]*)/)[1]+"_"+shortId+".102?$uslarge$",this.value(url)})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var colorMatches,colorPics,id,imageMatches,images,match,matches,pic,pics,switches,value,_i,_j,_k,_len,_len1,_len2;switches={images:!0,description:!1,rating:!1,ratingCount:!1,originalPrice:!1,colors:!0,shipping:!1},value={};if(switches.colors){matches=this.resource.match(/var arrSizeValues = new Array([\S\s]*?)<\/script>/),colorMatches=this.matchAll(matches[1],/arrSizeValues\[.*?\]\[.*?\]="(.*?)"/,1),value.colors=[];for(_i=0,_len=colorMatches.length;_i<_len;_i++)match=colorMatches[_i],matches=match.match(/^([^:]*):[^:]*:[^:]*:([^:]*):[^:]*:([^:]*)$/),value.colors.push({longId:matches[1],shortId:matches[2],name:matches[3]})}switches.description&&(matches=this.resource.match(/<div id="divProductDetailDescriptionAreaDisplay1"([\S\s]*?)<div id="divProductDetailDescriptionAreaDisplay2"/),value.description="<div"+matches[1]),switches.rating&&(matches=this.resource.match(/var avgRating = '([^']*)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/var productReviews = '([^']*)/),matches&&(value.reviewCount=matches[1])),switches.originalPrice&&(matches=this.resource.match(/<span class="spanStrike">\$([\S\s]*?)<\/span>/),matches?value.originalPrice=matches[1]:(matches=this.resource.match(/product_price:\['([^']*)/),matches&&(value.originalPrice=matches[1])));if(switches.images){images={},colorMatches=this.resource.match(/colorImages\[[^\]]*\] = "([^"]*)/g);if(colorMatches){colorPics={};for(_j=0,_len1=colorMatches.length;_j<_len1;_j++)match=colorMatches[_j],pic=match.match(/colorImages\[[^\]]*\] = "([^"]*)/),id=match.match(new RegExp(""+this.productSid.id+"_([^.]*)","i")),colorPics[id[1]]=pic[1];images.colorPics=colorPics}imageMatches=this.resource.match(/viewImages\[[^\]]*\] = "([^"]*)/g);if(imageMatches){pics=[];for(_k=0,_len2=imageMatches.length;_k<_len2;_k++)match=imageMatches[_k],pic=match.match(/viewImages\[[^\]]*\] = "([^"]*)/),pics.push(pic[1]);images.pics=pics}value.images=images}return this.value(value)})}},QVCProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/QVC/QVCSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var QVCSiteInjector;return QVCSiteInjector=function(_super){__extends(QVCSiteInjector,_super);function QVCSiteInjector(){return QVCSiteInjector.__super__.constructor.apply(this,arguments)}return QVCSiteInjector.prototype.productListing={imgSelector:'a img[src^="http://images.qvc.com/is/image/"]',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.qvc\.com\/.*?\.product\.([^\.]+)/))!=null?_ref[1]:void 0,name}},QVCSiteInjector.prototype.productPage={initPage:function(){var globalMatches,match,matches,_i,_len,_results;this.colorMap={},matches=document.head.innerHTML.match(/var arrSizeValues = new Array([\S\s]*?)<\/script>/),globalMatches=matches[1].match(/arrSizeValues\[.*?\]\[.*?\]="(.*?)"/g),_results=[];for(_i=0,_len=globalMatches.length;_i<_len;_i++)match=globalMatches[_i],match=match.match(/arrSizeValues\[.*?\]\[.*?\]="(.*?)"/)[1],matches=match.match(/^([^:]*):[^:]*:[^:]*:([^:]*):[^:]*:([^:]*)$/),_results.push(this.colorMap[matches[3]]=matches[1]);return _results},test:function(){return $("#imageID").length},productSid:function(){var id;return id=document.location.href.match(/^http:\/\/www\.qvc\.com\/.*?\.product\.([^\.]+)/)[1],id+="-"+this.colorMap[$("#spanSelectedSizeColor").text().trim()],id},imgEl:"#imageID",waitFor:"#imageID"},QVCSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"rakuten",hosts:["www.rakuten.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.rakuten.com/favicon.ico"},define("sites/Rakuten/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Rakuten/RakutenProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var RakutenProductScraper;return RakutenProductScraper=function(_super){__extends(RakutenProductScraper,_super);function RakutenProductScraper(){return RakutenProductScraper.__super__.constructor.apply(this,arguments)}return RakutenProductScraper.testProducts=["263019782"],RakutenProductScraper.prototype.resources={productPage:{url:function(){return"http://www.rakuten.com/prod/-/"+this.productSid+".html"}},altProductPage:{url:function(){return"http://www.rakuten.com/pr/product.aspx?sku="+this.productSid}}},RakutenProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<span id="spanMainTotalPrice" class="pr-pricing-total-price" itemprop="price">\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var author,authorBio,authorMatches,authorNames,bioMatch,bioMatches,content,count,detailMatches,details,editorialReviews,erMatches,from,image,imageMatches,images,isbn,item,match,matches,name,overview,overviewMatches,par,switches,text,title,value,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_m,_n;switches={images:!1,overview:!1,details:!1,rating:!1,ratingCount:!1,originalPrice:!1,shipping:!1},value={};if(switches.overview){overview=[],matches=this.resource.match(/<div id="product-commentary-overview-1"([\S\s]*?)<\/section>/),overviewMatches=matches[1].match(/<p([\S\s]*?)<\/p>/g);for(_i=0,_len=overviewMatches.length;_i<_len;_i++)match=overviewMatches[_i],text=match.match(/<p([\S\s]*?)<\/p>/),overview.push(text[1]);value.overview=overview}if(switches.details){details=[],matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),detailMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g);for(_j=0,_len1=detailMatches.length;_j<_len1;_j++)match=detailMatches[_j],title=match.match(/<span>([\S\s]*?)<\/span>/)[1],content=match.match(/<\/span>([\S\s]*?)<\/li>/)[1],text=title+content,details.push(text.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));value.details=details}switches.isbn&&(matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),isbn=matches[1].match(/<span>ISBN-13:<\/span>([\S\s]*?)<\/li>/),value.isbn=isbn[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));if(switches.author){author={},authorNames=[],matches=this.resource.match(/<ul class="contributors([\S\s]*?)<\/ul>/),authorMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g),count=0;for(_k=0,_len2=authorMatches.length;_k<_len2;_k++)item=authorMatches[_k],count>0&&(name=item.match(/<li([\S\s]*?)<\/li>/)[1],authorNames.push(name.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),count++;author.names=authorNames,authorBio=[],bioMatch=this.resource.match(/<div class="basic-info([\S\s]*?)<\/section>/),bioMatches=bioMatch[1].match(/<p>([\S\s]*?)<\/p>/g);for(_l=0,_len3=bioMatches.length;_l<_len3;_l++)match=bioMatches[_l],par=match.match(/<p>([\S\s]*?)<\/p>/)[1],authorBio.push(par);author.bio=authorBio,value.author=author}switches.rating&&(matches=this.resource.match(/"customerAvgStarRating" : ([\S\s]*?),/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/"customerRatingCount" : ([\S\s]*?),/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_m=0,_len4=erMatches.length;_m<_len4;_m++)match=erMatches[_m],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br \/>+|<br \/>+$/gm,""),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/"listPrice" : ([\S\s]*?),/),matches&&(value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<div id="product-image-smaller-1-viewer"([\S\s]*?)<div id="product-promos-aside-1"/),imageMatches=matches[1].match(/data-bn-src-url="([^"]+)/g);for(_n=0,_len5=imageMatches.length;_n<_len5;_n++)match=imageMatches[_n],image=match.match(/data-bn-src-url="([^"]+)/),images.push(image[1]);value.images=images}return this.value(value)})}},RakutenProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Rakuten/RakutenSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var RakutenSiteInjector;return RakutenSiteInjector=function(_super){__extends(RakutenSiteInjector,_super);function RakutenSiteInjector(){return RakutenSiteInjector.__super__.constructor.apply(this,arguments)}return RakutenSiteInjector.prototype.siteName="Rakuten",RakutenSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.rakuten\.com\/prod\/.*?\/([^\.]+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($("#mainImgSection").length)return currentSid=function(){return/^http:\/\/www\.rakuten\.com\/prod\/.*?\/([^\.]+)/.exec(document.location.href)[1]},_this.waitFor(".items div",function(){return _this.initProductEl($(".items div"),{productSid:currentSid()})})})}}(this))},RakutenSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"rei",hosts:["www.rei.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.rei.com/favicon.ico"},define("sites/Rei/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Rei/ReiProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var ReiProductScraper;return ReiProductScraper=function(_super){__extends(ReiProductScraper,_super);function ReiProductScraper(){return ReiProductScraper.__super__.constructor.apply(this,arguments)}return ReiProductScraper.testProducts=["868539"],ReiProductScraper.prototype.resources={productPage:{url:function(){return"http://www.rei.com/product/"+this.productSid}}},ReiProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta name="name" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<li class="price" itemprop="price">[\s]*\$([^<]*)/),1],[new RegExp(/<li class="salePrice price" itemprop="price">[\s]*\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var content,editorialReviews,erMatches,from,image,imageMatches,images,match,matches,switches,value,_i,_j,_len,_len1;switches={images:!0,overview:!0,details:!0,specifications:!0,rating:!0,ratingCount:!0,originalPrice:!0,shipping:!1},value={},switches.overview&&(matches=this.resource.match(/<h2 class="primaryProductDescription">([\S\s]*?)<\/h2>/),value.overview=matches[1]),switches.details&&(matches=this.resource.match(/<div class="tabArea1">([\S\s]*?)<\/div>/),value.details=matches[1]),switches.specifications&&(matches=this.resource.match(/<table id="spec_table"([\S\s]*?)<\/table>/),value.specifications="<table"+matches[1]+"</table>"),switches.rating&&(matches=this.resource.match(/recommendation_ratings="([^"]+)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/recommendation_count="([^"]+)/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_i=0,_len=erMatches.length;_i<_len;_i++)match=erMatches[_i],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br \/>+|<br \/>+$/gm,""),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/class="originalPrice">([\S\s]*?)<\//),matches&&(matches=matches[1].match(/\$([\S\s]*)/),value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<div id="productCarousel"([\S\s]*?)<div id="area2"/),imageMatches=matches[1].match(/lgimg="([^"]+)/g);for(_j=0,_len1=imageMatches.length;_j<_len1;_j++)match=imageMatches[_j],image=match.match(/lgimg="([^"]+)/),images.push("http://www.rei.com"+image[1]);value.images=images}return this.value(value)})}},ReiProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Rei/ReiSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var ReiSiteInjector;return ReiSiteInjector=function(_super){__extends(ReiSiteInjector,_super);function ReiSiteInjector(){return ReiSiteInjector.__super__.constructor.apply(this,arguments)}return ReiSiteInjector.prototype.productListing={imgSelector:'a[href^="http://www.rei.com/product/"] img, a[href^="/product/"] img',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.rei\.com\/product\/([^\/]+)/))!=null?_ref[1]:void 0,name}},ReiSiteInjector.prototype.productPage={test:function(){return $("#prodImg").length},productSid:function(){return document.location.href.match(/^http:\/\/www\.rei\.com\/product\/([^\/]+)/)[1]},imgEl:"#featuredImg",overlayEl:"#zoomLoupe"},ReiSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"renttherunway",hosts:["www.renttherunway.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.renttherunway.com/favicon.ico"},define("sites/RentTheRunway/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/RentTheRunway/RentTheRunwayProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var RentTheRunwayProduct;return RentTheRunwayProduct=function(_super){__extends(RentTheRunwayProduct,_super);function RentTheRunwayProduct(){return RentTheRunwayProduct.__super__.constructor.apply(this,arguments)}return RentTheRunwayProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var file,image,images;return(more!=null?more.images:void 0)?(images=function(){var _i,_len,_ref,_results;_ref=more.images,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],file=/\/([^\/]*)$/.exec(image)[1],_results.push({small:"https://cdn.rtrcdn.com/sites/default/files/imagecache/acsr_small_image/product_images/"+file,medium:"https://cdn.rtrcdn.com/sites/default/files/product_images/"+file,large:"https://cdn.rtrcdn.com/sites/default/files/product_images/"+file,larger:"https://cdn.rtrcdn.com/sites/default/files/product_images/"+file,full:"https://cdn.rtrcdn.com/sites/default/files/product_images/"+file});return _results}(),cb({"":images},"")):cb()}}(this))},RentTheRunwayProduct.prototype.reviews=function(cb){return this.product["with"]("reviews",function(_this){return function(reveiws){return cb({reviews:util.mapObjects(reviews,{rating:function(review){return review.rating/10*5}})})}}(this))},RentTheRunwayProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{details:"Details",sizeInfo:"Size Info",sizes:"Sizes",styleNotes:"Style Notes",reviews:{obj:reviews,map:{rating:function(review){return review.rating/10*5}}}}),cb(widgets)}}(this))},RentTheRunwayProduct}(SiteProduct)}),define("sites/RentTheRunway/RentTheRunwayProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){return ProductScraper.declarativeProductScraper("scraper",{resources:{productPage:{url:function(){return"https://www.renttherunway.com/shop/designers/"+this.productSid}}},scraper:"scraper",resource:"productPage"})});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/RentTheRunway/RentTheRunwaySiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var RentTheRunwaySiteInjector;return RentTheRunwaySiteInjector=function(_super){__extends(RentTheRunwaySiteInjector,_super);function RentTheRunwaySiteInjector(){return RentTheRunwaySiteInjector.__super__.constructor.apply(this,arguments)}return RentTheRunwaySiteInjector.prototype.productListing={mode:2,image:'a[href^="/shop/designers/"]:not(.product-thumbnail) img',productSid:function(href,a,img){var _ref;return(_ref=href.match(/https:\/\/www\.renttherunway\.com\/shop\/designers\/([^\/]*\/.*)/))!=null?_ref[1]:void 0}},RentTheRunwaySiteInjector.prototype.productPage={mode:2,test:function(){return document.location.href.match(/https:\/\/www\.renttherunway\.com\/shop\/designers\/([^\/]*\/.*)/)},productSid:function(){return document.location.href.match(/https:\/\/www\.renttherunway\.com\/shop\/designers\/([^\/]*\/.*)/)[1]},image:".featured-image.cloudzoom:visible",overlay:".cloudzoom-zoom-inside",attach:"body"},RentTheRunwaySiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"samsclub",hosts:["www.samsclub.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.samsclub.com/favicon.ico"},define("sites/SamsClub/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/SamsClub/SamsClubProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var SamsClubProductScraper;return SamsClubProductScraper=function(_super){__extends(SamsClubProductScraper,_super);function SamsClubProductScraper(){return SamsClubProductScraper.__super__.constructor.apply(this,arguments)}return SamsClubProductScraper.testProducts=["11690047"],SamsClubProductScraper.prototype.resources={productPage:{url:function(){return"http://www.samsclub.com/sams/-/prod"+this.productSid+".ip"}}},SamsClubProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<span itemprop="name">([^<]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/'item_price':'([^']*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<div class="[^"]*" id='plImageHolder'>[\s]*<img src='([^\?]*)/),1).config({map:function(value){return""+value+"?$img_size_500x500$"}})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var content,editorialReviews,erMatches,from,imageMatches,images,jsonUrl,match,matches,rating,ratingURL,reviewCount,style,styleImages,styleNum,swatch,switches,value,_fn,_i,_j,_len,_len1;switches={images:!1,details:!1,rating:!1,ratingCount:!1,originalPrice:!1,shipping:!1},value={},switches.details&&(matches=this.resource.match(/<div class="[^"]*" id="tabItemDetails">([\S\s]*?)id="tabRatings"/),value.details="<div>"+matches[1]+"> </div>"),switches.rating&&(rating=[],ratingURL="http://samsclub.ugc.bazaarvoice.com/1337/prod"+this.productSid+"/reviews.djs?format=embeddedhtml",this.execBlock(function(){return this.get(ratingURL,function(response){var match;return match=response.match(/<span class=\\"BVRRNumber BVRRRatingNumber\\">([^<]*)/),match&&rating.push(match[1]),this.done(!0),this.value(value)}),null}),value.rating=rating),switches.reviewCount&&(reviewCount=[],ratingURL="http://samsclub.ugc.bazaarvoice.com/1337/prod"+this.productSid+"/reviews.djs?format=embeddedhtml",this.execBlock(function(){return this.get(ratingURL,function(response){var match;return match=response.match(/<span class=\\"BVRRNumber\\">([^<]*)/),match&&reviewCount.push(match[1]),this.done(!0),this.value(value)}),null}),value.reviewCount=reviewCount);if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_i=0,_len=erMatches.length;_i<_len;_i++)match=erMatches[_i],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br \/>+|<br \/>+$/gm,""),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/"listPrice" : ([\S\s]*?),/),matches&&(value.originalPrice=matches[1]));if(switches.images){images={},matches=this.resource.match(/<div class="variantSwatches([\S\s]*?)<div class="clearfix"/);if(matches){imageMatches=matches[1].match(/<a([\S\s]*?)<\/a>/g),_fn=function(_this){return function(jsonUrl,styleImages){return _this.execBlock(function(){return this.get(jsonUrl,function(response){var num,numMatch,numMatches,_k,_len2;numMatches=response.match(/\/([0-9A-Z_]*?);/g);for(_k=0,_len2=numMatches.length;_k<_len2;_k++)numMatch=numMatches[_k],num=numMatch.match(/\/([0-9A-Z_]*?);/)[1],styleImages.push("http://scene7.samsclub.com/is/image/samsclub/"+num+"?$img_size_380x380$");return this.done(!0),this.value(value)}),null})}}(this);for(_j=0,_len1=imageMatches.length;_j<_len1;_j++)match=imageMatches[_j],style=match.match(/data-value="([^"]+)/)[1],swatch=match.match(/src='([^']+)/)[1],styleNum=match.match(/http:\/\/scene7.samsclub.com\/is\/image\/samsclub\/([\S\s]*?)_S1/)[1],jsonUrl="http://scene7.samsclub.com/is/image/samsclub/"+styleNum+"?req=imageset,json&id=init",styleImages=[],_fn(jsonUrl,styleImages),styleImages.push(swatch),images[style]=styleImages}else styleNum=this.resource.match(/var imageList = '([\S\s]*?)';/)[1],jsonUrl="http://scene7.samsclub.com/is/image/samsclub/"+styleNum+"?req=imageset,json&id=init",styleImages=[],function(_this){return function(jsonUrl,styleImages){return _this.execBlock(function(){return this.get(jsonUrl,function(response){var num,numMatch,numMatches,_k,_len2;numMatches=response.match(/\/([0-9A-Z_]*?);/g);for(_k=0,_len2=numMatches.length;_k<_len2;_k++)numMatch=numMatches[_k],num=numMatch.match(/\/([0-9A-Z_]*?);/)[1],styleImages.push("http://scene7.samsclub.com/is/image/samsclub/"+num+"?$img_size_380x380$");return this.done(!0),this.value(value)}),null})}}(this)(jsonUrl,styleImages),images.main=styleImages;value.images=images}return this.value(value)})}},SamsClubProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/SamsClub/SamsClubSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var SamsClubSiteInjector;return SamsClubSiteInjector=function(_super){__extends(SamsClubSiteInjector,_super);function SamsClubSiteInjector(){return SamsClubSiteInjector.__super__.constructor.apply(this,arguments)}return SamsClubSiteInjector.prototype.siteName="SamsClub",SamsClubSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.samsclub\.com\/sams\/[^\/]*?\/prod([^\.]+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,match,sid,_i,_len,_ref,_ref1,_results;_ref=$("a:not(.BVRRSocialBookmarkingSharingLink) img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid||(href=unescape(href),match=(_ref1=/(http:\/\/www\.samsclub.com\/.*?)(?:&|$)/.exec(href))!=null?_ref1[1]:void 0,match&&(sid=parseSid(match))),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($("#plImageHolder").length)return currentSid=function(){return/^http:\/\/www\.samsclub\.com\/sams\/.*?\/prod([^\.]+)/.exec(document.location.href)[1]},_this.initProductEl($("#plImageHolder img"),{productSid:currentSid()})})}}(this))},SamsClubSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"sears",hosts:["www.sears.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.sears.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},define("sites/Sears/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Sears/SearsProduct",["scraping/SiteProduct","underscore"],function(SiteProduct,_){var SearsProduct;return SearsProduct=function(_super){__extends(SearsProduct,_super);function SearsProduct(){return SearsProduct.__super__.constructor.apply(this,arguments)}return SearsProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,img,otherImages,url,_i,_len,_ref;otherImages=[],_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++){image=_ref[_i];for(img in image)url=image[img],otherImages.push({small:url.primaryImg+"?hei=100&wid=100&op_sharpen=1",medium:url.primaryImg+"?hei=300&wid=300&op_sharpen=1",large:url.primaryImg+"?hei=500&wid=500&op_sharpen=1",larger:url.primaryImg+"?hei=1000&wid=1000&op_sharpen=1",full:url.primaryImg+"?op_sharpen=1"})}return cb({"":otherImages},"")}}(this))},SearsProduct.prototype.widgets=function(cb){return this.product["with"]("more",function(_this){return function(more){var widgets;return widgets=_this.genWidgets(more,{description:"Description",specifications:"Specifications"}),cb(widgets)}}(this))},SearsProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Sears/SearsProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var SearsProductScraper;return SearsProductScraper=function(_super){__extends(SearsProductScraper,_super);function SearsProductScraper(){return SearsProductScraper.__super__.constructor.apply(this,arguments)}return SearsProductScraper.testProducts=[],SearsProductScraper.prototype.resources={productPage:{url:function(){return"http://www.sears.com/-/p-"+this.productSid}},productData:{type:"json",url:function(){return"http://www.sears.com/content/pdp/config/products/Sears/"+this.productSid}},priceData:{type:"json",url:function(){var number;return number=this.productSid.value,number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),"http://www.sears.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0"}}},SearsProductScraper.prototype.properties={title:{resource:"productData",scraper:JsonResourceScraper(function(data){return(""+data.brandName+" "+data.title).trim()})},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var number,price,priceUrl;return price="",number=this.productSid.value,console.debug("asdf"),console.debug(number),number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),priceUrl="http://www.sears.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0",this.execBlock(function(){return this.get(priceUrl,function(response){var altPriceUrl,originalPrice;return console.debug(response),originalPrice=JSON.parse(response),originalPrice["price-response"]["item-response"]["sell-price"].$&&(originalPrice["price-response"]["item-response"]["sell-price"].$!=="0.00"?price=originalPrice["price-response"]["item-response"]["sell-price"].$:(altPriceUrl="http://www.sears.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber="+number+"P",this.execBlock(function(){return this.get(altPriceUrl,function(response){return originalPrice=response.match(/"prodDispPrice":"([^,]+|[^"]+)/),originalPrice&&(price=originalPrice[1]),this.value(price),this.done(!0)}),null}))),this.value(price),this.done(!0)}),null}),this.value(price)})},image:{resource:"productData",scraper:JsonResourceScraper(function(data){return data.images[0].url.indexOf("?")===-1?""+data.images[0].url+"?hei=623&wid=623&qlt=50,0&op_sharpen=1&op_usm=0.9,0.5,0,0":data.images[0].url})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var descUrl,description,imgUrl,number,priceUrl,ratUrl,revs,specs,switches,value;return switches={images:!0,description:!0,specifications:!0,rating:!0,ratingCount:!0,originalPrice:!0,reviews:!0,shipping:!0},value={},switches.images&&(imgUrl="http://www.sears.com/content/pdp/config/products/Sears/"+this.productSid,this.execBlock(function(){return this.get(imgUrl,function(response){var altPocket,color,colorName,entry,imageArr,images,pocket,theColor,variant,variantName,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_len6,_m,_n,_o,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;images=JSON.parse(response);if(images.product.variants.definingAttrs){imageArr=[],_ref=images.product.variants.definingAttrs;for(_i=0,_len=_ref.length;_i<_len;_i++){pocket=_ref[_i];if(pocket.name==="Color"){_ref1=pocket.vals;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){color=_ref1[_j],variant={},variantName={},colorName=color.name,variant.primaryImg=color.primaryImg.attrs.src,variant.swatchImg=color.swatchImg.attrs.src,_ref2=images.product.variants.sku;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){altPocket=_ref2[_k],theColor=altPocket.name.match(/Color:([^,]*|$)/)[1];if(theColor===colorName&&altPocket.alternateImg){_ref3=altPocket.alternateImg;for(_l=0,_len3=_ref3.length;_l<_len3;_l++)entry=_ref3[_l],variant.altImg=entry.src}}variantName[colorName]=variant,imageArr.push(variantName)}}}value.images=imageArr}else{imageArr=[],_ref4=images.product.assets.imgs;for(_m=0,_len4=_ref4.length;_m<_len4;_m++){pocket=_ref4[_m];if(pocket.type==="P"){_ref5=pocket.vals;for(_n=0,_len5=_ref5.length;_n<_len5;_n++)entry=_ref5[_n],variant={},variantName={},variant.primaryImg=entry.img.attrs.src,variantName.Main=variant,imageArr.push(variantName)}else if(pocket.type==="A"){_ref6=pocket.vals;for(_o=0,_len6=_ref6.length;_o<_len6;_o++)entry=_ref6[_o],variant={},variantName={},variant.primaryImg=entry.img.attrs.src,variantName.Other=variant,imageArr.push(variantName)}}value.images=imageArr}return this.done(!0),this.value(value)}),null})),switches.reviews&&(ratUrl="http://www.sears.com/content/pdp/ratings/single/search/Sears/"+this.productSid+"&targetType=product&limit=10000&offset=0",revs=[],this.execBlock(function(){return this.get(ratUrl,function(response){var author,entry,rat,revHash,reviews,_i,_j,_len,_len1,_ref,_ref1;reviews=JSON.parse(response);if(reviews.data.reviews){_ref=reviews.data.reviews;for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i],revHash={},author={},author.name=entry.author.screenName,author.url="http://www.sears.com/shc/s/PublicProfileView?requestType=public_profile&langId=-1&storeId=10153&key="+entry.author.extUserId,revHash.author=author,revHash.searsVerifiedPurchase=entry.author.isBuyer,revHash.title=entry.summary,revHash.review=entry.content;if(entry.attribute_rating){_ref1=entry.attribute_rating;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)rat=_ref1[_j],rat.attribute==="overall_rating"&&rat.attribute_type==="numeric"&&(revHash.rating=rat.value)}revHash.time=entry.published_date,revs.push(revHash)}value.reviews=revs}return this.done(!0),this.value(value)}),null})),switches.description&&(descUrl="http://www.sears.com/content/pdp/config/products/Sears/"+this.productSid,description=null,this.execBlock(function(){return this.get(descUrl,function(response){return description=JSON.parse(response),description.shortDesc&&description.longDesc?value.description=description.shortDesc+description.longDesc:!description.shortDesc&&description.longDesc?value.description=description.longDesc:description.shortDesc&&!description.longDesc&&(value.description=description.shortDesc),this.done(!0),this.value(value)}),null})),switches.specifications&&(descUrl="http://www.sears.com/content/pdp/config/products/Sears/"+this.productSid,specs={},this.execBlock(function(){return this.get(descUrl,function(response){var entry,specHash,specifications,thing,_i,_j,_len,_len1,_ref,_ref1;specifications=JSON.parse(response);if(specifications.specAttr){_ref=specifications.specAttr;for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i],specHash={},_ref1=entry.values;for(_j=0,_len1=_ref1.length;_j<_len1;_j++)thing=_ref1[_j],specHash[thing.name]=thing.value;specs[entry.group]=specHash}value.specifications=specs}return this.done(!0),this.value(value)}),null})),switches.rating&&(ratUrl="http://www.sears.com/content/pdp/ratings/single/search/Sears/"+this.productSid+"&targetType=product&limit=1&offset=0",this.execBlock(function(){return this.get(ratUrl,function(response){var rating;return rating=JSON.parse(response),rating.data.overall_rating&&(value.rating=rating.data.overall_rating),this.done(!0),this.value(value)}),null})),switches.ratingCount&&(ratUrl="http://www.sears.com/content/pdp/ratings/single/search/Sears/"+this.productSid+"&targetType=product&limit=1&offset=0",this.execBlock(function(){return this.get(ratUrl,function(response){var ratingCount;return ratingCount=JSON.parse(response),ratingCount.data.review_count&&(value.ratingCount=ratingCount.data.review_count),this.done(!0),this.value(value)}),null})),switches.originalPrice&&(number=this.productSid.value,number[number.length-1]==="P"&&(number=number.substr(0,number.length-1)),priceUrl="http://www.sears.com/content/pdp/products/pricing/"+number+"?variation=0&regionCode=0",this.execBlock(function(){return this.get(priceUrl,function(response){var altPriceUrl,originalPrice;return originalPrice=JSON.parse(response),originalPrice["price-response"]["item-response"]["regular-price"]&&(originalPrice["price-response"]["item-response"]["regular-price"]!=="0.00"?value.originalPrice=originalPrice["price-response"]["item-response"]["regular-price"]:(altPriceUrl="http://www.sears.com/shc/s/ItemSavestoryAjax?storeId=10153&prdType=VARIATION&prdBeanType=ProductBean&ajaxFlow=true&partNumber="+number+"P",this.execBlock(function(){return this.get(altPriceUrl,function(response){return originalPrice=response.match(/"prodRegPrice":([^,]+|[^"]+)/),originalPrice&&(value.originalPrice=originalPrice[1]),this.done(!0),this.value(value)}),null}))),this.done(!0),this.value(value)}),null})),this.value(value)})}},SearsProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Sears/SearsSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var SearsSiteInjector;return SearsSiteInjector=function(_super){__extends(SearsSiteInjector,_super);function SearsSiteInjector(){return SearsSiteInjector.__super__.constructor.apply(this,arguments)}return SearsSiteInjector.prototype.productListing={imgSelector:'a img[src^="http://c.shld.net/rpx/"]',productSid:function(href,a,img){var match,name,sid,_ref,_ref1,_ref2;return name=(_ref=href.match(/^http:\/\/www\.sears\.com\/[^\/]*\/p-([^?]*)/))!=null?_ref[1]:void 0,name||(name=(_ref1=href.match(/^http:\/\/www\.sears\.com\/shc\/s\/p_.*?_.*?_([^_?]*)(?:\?|$)/))!=null?_ref1[1]:void 0),sid=name,sid||(href=unescape(href),match=(_ref2=/(www\.sears\.com\/.*?)/.exec(href))!=null?_ref2[1]:void 0,match&&(sid=match)),sid}},SearsSiteInjector.prototype.productPage={test:function(){return $('meta[name="viewport"]').length},productSid:function(){var sid,_ref,_ref1;return sid=(_ref=document.location.href.match(/^http:\/\/www\.sears\.com\/shc\/s\/p_.*?_.*?_([^_?]*)(?:\?|$)/))!=null?_ref[1]:void 0,sid||(sid=(_ref1=document.location.href.match(/^http:\/\/www\.sears\.com\/[^\/]*\/p-([^?]*)/))!=null?_ref1[1]:void 0),sid},imgEl:'div[data-id="product-image-main"] img',waitFor:'div[data-id="product-image-main"] img'},SearsSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"singer22",hosts:["www.singer22.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.singer22.com/favicon.ico"},define("sites/Singer22/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Singer22/Singer22Product",["scraping/SiteProduct"],function(SiteProduct){var Singer22Product;return Singer22Product=function(_super){__extends(Singer22Product,_super);function Singer22Product(){return Singer22Product.__super__.constructor.apply(this,arguments)}return Singer22Product.prototype.variantImage=function(variant,cb){return this.product["with"]("more",function(_this){return function(more){var _ref;return more?cb((_ref=more.colorImages)!=null?_ref[variant.Color].main:void 0):cb()}}(this))},Singer22Product.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var image,images,_i,_len,_name,_ref;images={},_ref=more.images;for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],images[_name=image.color]==null&&(images[_name]=[]),images[image.color].push({small:image.full,medium:image.full,large:image.full,larger:image.full,full:image.full});return cb(images)}}(this))},Singer22Product.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",colors:"Colors"}),cb(widgets)}}(this))},Singer22Product}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Singer22/Singer22ProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var Singer22ProductScraper;return Singer22ProductScraper=function(_super){__extends(Singer22ProductScraper,_super);function Singer22ProductScraper(){return Singer22ProductScraper.__super__.constructor.apply(this,arguments)}return Singer22ProductScraper.prototype.parseSid=function(sid){return{}},Singer22ProductScraper.prototype.resources={productPage:{url:function(){return"http://www.singer22.com/"+this.productSid+".html"}}},Singer22ProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var match,more,obj;return more=this.declarativeScraper("scraper","more"),match=/var arrProductImages = (\{[\S\s]*?\}\})/.exec(this.resource)[1],obj=JSON.parse(match),more.colorImages=obj,this.value(more)})}},Singer22ProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Singer22/Singer22SiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var Singer22SiteInjector;return Singer22SiteInjector=function(_super){__extends(Singer22SiteInjector,_super);function Singer22SiteInjector(){return Singer22SiteInjector.__super__.constructor.apply(this,arguments)}return Singer22SiteInjector.prototype.productListing={init:function(){var parseUrl;if($("#category-rotator-category-container"))return parseUrl=function(url){var id,_ref,_ref1,_ref2;id=null,id||(id=(_ref=url.match(/http:\/\/cdn2\.singer22\.com\/static\/insets\/[^\/]*\/([^_]*)/))!=null?_ref[1]:void 0),id||(id=(_ref1=url.match(/^http:\/\/\d*\.images\.singer22\.com\/static\/(?:products|insets)\/[^\/]*\/([^.]*)/))!=null?_ref1[1]:void 0),id||(id=(_ref2=url.match(/^http:\/\/cdn2\.singer22\.com\/static\/(?:products|insets)\/[^\/]*\/([^.]*)/))!=null?_ref2[1]:void 0);if(id)return id.toLowerCase()},Q.setInterval(function(_this){return function(){var el,id,_i,_len,_ref,_results;_ref=$("#category-rotator-category-container img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],el=$(el),id=parseUrl(el.attr("src")),id?el.data("agora-productSid")!==id?(el.parent().css("position","relative"),el.parent().removeAttr("agora"),_this.removeOverlay(el.parent()),_this.attachOverlay({attachEl:el.parent(),positionEl:el,productData:{productSid:id}}),_this.clearProductEl(el),_this.initProductEl(el,{productSid:id},{overlay:!1}),_results.push(Q(el).data("agora-productSid",id))):_results.push(void 0):_results.push(void 0);return _results}}(this),500)},mode:2,selectors:{'a[href*="sku="] img':{overlayPosition:"topLeft",productData:function(href,a,img){var matches;matches=href.match(/[?&]sku=(.*?)(?:$|&|#)/);if(matches)return{productSid:matches[1]}}},".item.pinproduct":{image:function(el){return el.find(".rotator ul li:first img")},anchor:function(el){return el.find(".rotator .mask")},anchorProxy:!0,productData:function(href,a,img,el){var matches;href=el.find('[itemprop="url"]').attr("href"),matches=href.match(/[?&]sku=(.*?)(?:$|&|#)/);if(matches)return{productSid:matches[1]}},overlayPosition:"topLeft"}}},Singer22SiteInjector.prototype.productPage={mode:2,test:function(){return $('div#styleData[itemtype="http://schema.org/Product"]').length},productSid:function(){var matches;matches=document.location.href.match(/[?&]sku=(.*?)(?:$|&|#)/);if(matches)return matches[1]},variant:function(){if($("#productColors .productColorSelected").attr("title"))return{Color:$("#productColors .productColorSelected").attr("title")}},image:"#productMainThumb",attach:"#styleData",zIndex:999},Singer22SiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"6pm",hosts:["www.6pm.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.6pm.com/favicon.ico"},define("sites/SixPM/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/SixPM/SixPmProduct",["scraping/SiteProduct"],function(SiteProduct){var SixPMProduct;return SixPMProduct=function(_super){__extends(SixPMProduct,_super);function SixPMProduct(){return SixPMProduct.__super__.constructor.apply(this,arguments)}return SixPMProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var id,image,images,name,style,_ref,_ref1;images={},_ref=more.styles;for(id in _ref){style=_ref[id],images[id]=[],_ref1=style.images;for(name in _ref1)image=_ref1[name],image.MULTIVIEW&&images[id].push({small:image.MULTIVIEW,medium:image.MULTIVIEW,large:image["4x"],larger:image["4x"],full:image["4x"]})}return cb(images,more.currentStyle)}}(this))},SixPMProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{productDetails:"Description",sizes:"Sizes",colors:{title:"Colors",map:function(color){return color.name}}}),cb(widgets)}}(this))},SixPMProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/SixPM/SixPMProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var SixPMProductScraper;return SixPMProductScraper=function(_super){__extends(SixPMProductScraper,_super);function SixPMProductScraper(){return SixPMProductScraper.__super__.constructor.apply(this,arguments)}return SixPMProductScraper.productSid=function(background,url,cb){return background.httpRequest(url,{cb:function(response){var colorId,matches,sku;return matches=/<span id="sku" class="sku id">SKU: #(\d*)<\/span>/.exec(response),matches?(sku=matches[1],matches=/<input type="hidden" id="color" value="(\d+)" name="colorId" \/>/.exec(response),matches?colorId=matches[1]:(matches=/<select id="color" name="colorId" class="btn secondary">([\S\s]+)<\/select>/.exec(response),matches=/<option value="(\d+)" selected="selected">[^<]+<\/option>/.exec(matches[1]),colorId=matches[1]),cb(""+sku+"-"+colorId)):cb()}})},SixPMProductScraper.prototype.parseSid=function(sid){var color,id,_ref;return _ref=sid.split("-"),id=_ref[0],color=_ref[1],{id:id,color:color}},SixPMProductScraper.prototype.resources={productPage:{url:function(){return"http://www.6pm.com/viewProduct.do?productId="+this.productSid.id+"&colorId="+this.productSid.color}}},SixPMProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var colorId,colorName,colorToStyle,currentColorId,id,m,match,matches,more,style,styleId,styles,type,url,value,_base,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1;more=this.declarativeScraper("scraper","more"),value=more,styles={},colorToStyle={},currentColorId=(_ref=this.resource.match(/<option value="(\d*)" selected="selected">/))!=null?_ref[1]:void 0,currentColorId||(currentColorId=this.resource.match(/<input type="hidden" id="color" value="(\d*)" name="colorId/)[1]),matches=this.resource.match(/var styleIds = \{([^}]*)/),matches=matches[1].match(/'([^']*)':\s*(\d*)/g);for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],m=match.match(/'([^']*)':\s*(\d*)/),colorId=m[1],styleId=m[2],styles[styleId]={id:styleId,color:{id:colorId},images:{}},colorToStyle[colorId]=styleId;value.currentStyle=colorToStyle[currentColorId],matches=this.matchAll(this.resource,/<img src="([^"]*)" class="gae-click\*Product-Page\*PrImage\*Swatch" \/>/);for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],url=match[1],styleId=/http:\/\/[^.]*.zassets.com\/images\/[a-z]*\/\d\/.*?\/(\d*)-[a-z]-\w*\.jpg/.exec(url)[1],styles[styleId].thumbUrl=url;matches=this.resource.match(/var colorNames = \{([^}]*)/),matches=matches[1].match(/'([^']*)':"([^"]*)"/g);for(_k=0,_len2=matches.length;_k<_len2;_k++)match=matches[_k],m=match.match(/'([^']*)':"([^"]*)"/),colorId=m[1],colorName=m[2],styleId=colorToStyle[colorId],styles[styleId].color.name=colorName;matches=this.resource.match(/pImgs\[(\d+)\]\['([^']*)'\]\['([^']*)'\] = (?:'([^']*)'|\{ filename: '([^']*)', width: '\d*', height: '\d*' \};)/g);for(_l=0,_len3=matches.length;_l<_len3;_l++)match=matches[_l],m=match.match(/pImgs\[(\d+)\]\['([^']*)'\]\['([^']*)'\] = (?:'([^']*)'|\{ filename: '([^']*)', width: '\d*', height: '\d*' \};)/),style=m[1],type=m[2],id=m[3],url=(_ref1=m[4])!=null?_ref1:m[5],(_base=styles[style].images)[id]==null&&(_base[id]={}),styles[style].images[id][type]=url;return value.styles=styles,this.value(more)})}},SixPMProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/SixPM/SixPmSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var SixPMSiteInjector;return SixPMSiteInjector=function(_super){__extends(SixPMSiteInjector,_super);function SixPMSiteInjector(){return SixPMSiteInjector.__super__.constructor.apply(this,arguments)}return SixPMSiteInjector.prototype.productListing=function(){var initProduct,initProducts,selector,that;return initProduct=function(_this){return function(el,retrievalId,url,mousedover){return _this.initProductEl(el,{productUrl:url,retrievalId:retrievalId},{hovering:mousedover})}}(this),selector="a[rel=product] img, a.product img, .productReviews a img",that=this,window.initProducts=initProducts=function(){return $(selector).each(function(){var a,m,matches;matches=/http:\/\/(?:[^.]*.zassets.com|www\.6pm\.com)\/images\/[a-z]*\/\d\/.*?\/(\d*)-[a-z]-\w*\.jpg/.exec($(this).attr("src"));if(matches)return a=$(this).parents("a"),m=/http:\/\/www\.6pm\.com\/product\/(\d*)\/color\/(\d*)/.exec(a.prop("href")),m?that.initProductEl(this,{productSid:""+m[1]+"-"+m[2]}):initProduct(this,matches[1],a.prop("href"),!1)})},initProducts(),Q.setInterval(initProducts,2e3)},SixPMSiteInjector.prototype.productPage={productSid:function(){var color,sku;return color=$("#color").val(),sku=$("#sku").text().match(/^SKU: #(\d*)$/)[1],""+sku+"-"+color},imgEl:"#detailImage img"},SixPMSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"soap",hosts:["www.soap.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.soap.com/favicon.ico"},define("sites/Soap/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Soap/SoapProduct",["scraping/SiteProduct"],function(SiteProduct){var SoapProduct;return SoapProduct=function(_super){__extends(SoapProduct,_super);function SoapProduct(){return SoapProduct.__super__.constructor.apply(this,arguments)}return SoapProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var images;return images=[],cb({"":images},"")}}(this))},SoapProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Soap/SoapProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var SoapProductScraper;return SoapProductScraper=function(_super){__extends(SoapProductScraper,_super);function SoapProductScraper(){return SoapProductScraper.__super__.constructor.apply(this,arguments)}return SoapProductScraper.prototype.parseSid=function(sid){return{}},SoapProductScraper.prototype.resources={productPage:{url:function(){return"http://www.soap.com/p/product-"+this.productSid}},reviewPage:{url:function(){var str;return str=this.productSid+"","http://www.soap.com/amazon_reviews/"+str.substr(0,2)+"/"+str.substr(2,2)+"/"+str.substr(4)+"/mosthelpful_Default.html"}}},SoapProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},more:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","more")},reviews:{resource:"reviewPage",scraper:DeclarativeResourceScraper("reviews","reviews")}},SoapProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Soap/SoapSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var SoapSiteInjector;return SoapSiteInjector=function(_super){__extends(SoapSiteInjector,_super);function SoapSiteInjector(){return SoapSiteInjector.__super__.constructor.apply(this,arguments)}return SoapSiteInjector.prototype.parseUrl=function(url){var _ref;return(_ref=/^http:\/\/www\.soap\.com\/p\/.*-(\d*)$/.exec(url))!=null?_ref[1]:void 0},SoapSiteInjector.prototype.productListing={mode:2,image:'a[href^="/p/"] img:not(#pdpMainImageImg)'},SoapSiteInjector.prototype.productPage={imgEl:"#pdpMainImageImg",overlayEl:".MagicZoomPup"},SoapSiteInjector}(DataDrivenSiteInjector)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Staples/StaplesProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var StaplesProductScraper;return StaplesProductScraper=function(_super){__extends(StaplesProductScraper,_super);function StaplesProductScraper(){return StaplesProductScraper.__super__.constructor.apply(this,arguments)}return StaplesProductScraper.testProducts=["571863"],StaplesProductScraper.prototype.resources={productPage:{url:function(){return"http://www.staples.com//product_"+this.productSid}}},StaplesProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^|]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<product envfeeflag="0" comingsoonflag="0" price="([^"]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<img id="largeProductImage" src="([^"]*)/),1)}},StaplesProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Staples/StaplesSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var StaplesSiteInjector;return StaplesSiteInjector=function(_super){__extends(StaplesSiteInjector,_super);function StaplesSiteInjector(){return StaplesSiteInjector.__super__.constructor.apply(this,arguments)}return StaplesSiteInjector.prototype.siteName="Staples",StaplesSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.staples\.com\/.*?\/product_([^\?]+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,sid,_i,_len,_ref,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($("#largeProductImage").length)return currentSid=function(){return/^http:\/\/www\.staples\.com\/.*?\/product_([^\?]+)/.exec(document.location.href)[1]},_this.waitFor("#largeProductImage",function(){return _this.initProductEl($("#largeProductImage"),{productSid:currentSid()})})})}}(this))},StaplesSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"target",hosts:["www.target.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.target.com/favicon.ico",productUrl:function(sid){return"http://www.sears.com/-/p-"+sid}},define("sites/Target/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Target/TargetProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var TargetProductScraper;return TargetProductScraper=function(_super){__extends(TargetProductScraper,_super);function TargetProductScraper(){return TargetProductScraper.__super__.constructor.apply(this,arguments)}return TargetProductScraper.testProducts=[],TargetProductScraper.prototype.resources={productPage:{url:function(){return"http://www.target.com/p/-/A-"+this.productSid}}},TargetProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp('<span class="fn" itemprop="name">([^<]*)'),1)},price:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<span class="offerPrice" itemprop="price">\s*\$(\S*)/),1)},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<img itemprop="image" height="[^"]*" width="[^"]*" alt="[^"]*" src="([^"]*)/),1)}},TargetProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Target/TargetSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var TargetSiteInjector;return TargetSiteInjector=function(_super){__extends(TargetSiteInjector,_super);function TargetSiteInjector(){return TargetSiteInjector.__super__.constructor.apply(this,arguments)}return TargetSiteInjector.prototype.siteName="Target",TargetSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProduct,initProducts;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),initProduct=function(el,sid){return _this.initProductEl(el,{productSid:sid},!1)},window.initProducts=initProducts=function(){var img,matches,src,_i,_len,_ref,_results;_ref=$("img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],src=$(img).attr("src"),matches=/http:\/\/img\d+\.targetimg\d+\.com\/wcsstore\/TargetSAS\/\/?img\/p\/\d+\/\d+\/(\d+)(?:_\d+)?(?:_\d+x\d+)?\.jpg/i.exec(src),matches?_results.push(initProduct(img,matches[1])):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3)}}(this))},TargetSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"thelimited",hosts:["www.thelimited.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.thelimited.com/favicon.ico",twoTap:!0},define("sites/TheLimited/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/TheLimited/TheLimitedProduct",["scraping/SiteProduct"],function(SiteProduct){var TheLimitedProduct;return TheLimitedProduct=function(_super){__extends(TheLimitedProduct,_super);function TheLimitedProduct(){return TheLimitedProduct.__super__.constructor.apply(this,arguments)}return TheLimitedProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,i,images,num,_i,_len,_ref;images={},num=more.images[more.color].large.length,_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],images[color.name]=function(){var _j,_results;_results=[];for(i=_j=0;0<=num?_j<num:_j>num;i=0<=num?++_j:--_j)_results.push({small:more.images[color.name].small[i],medium:more.images[color.name].medium[i],large:more.images[color.name].large[i],larger:more.images[color.name].xlarge[i],full:more.images[color.name].xlarge[i]});return _results}();return cb(images,more.color)}}(this))},TheLimitedProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{salesDescription:"Description",sizes:"Sizes",longDescription:"Details",colors:{title:"Colors",map:function(color){return color.name}},reviews:{obj:reviews,map:{review:"content"}}}),cb(widgets)}}(this))},TheLimitedProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/TheLimited/TheLimitedProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var TheLimitedProductScraper;return TheLimitedProductScraper=function(_super){__extends(TheLimitedProductScraper,_super);function TheLimitedProductScraper(){return TheLimitedProductScraper.__super__.constructor.apply(this,arguments)}return TheLimitedProductScraper.prototype.parseSid=function(sid){var color,size,sku,_ref;return _ref=sid.split("-"),sku=_ref[0],color=_ref[1],size=_ref[2],{sku:sku,color:color,size:size}},TheLimitedProductScraper.prototype.resources={productPage:{url:function(){var _ref;return"http://www.thelimited.com/product/-/"+this.productSid.sku+".html?dwvar_"+this.productSid.sku+"_colorCode="+this.productSid.color+"&dwvar_"+this.productSid.sku+"_size="+((_ref=this.productSid.size)!=null?_ref:"")}},reviewData:{url:function(){return"http://thelimited.ugc.bazaarvoice.com/9023/"+this.productSid.sku+"/reviews.djs?format=embeddedhtml"}}},TheLimitedProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){return this.value(this.resource.match('\\"([^\\"]*?/medium/\\d*_'+this.productSid.color+"_1\\.jpg)")[1])})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,colors,colorsMatch,data,images,imgs,more,obj,_i,_j,_len,_len1,_ref;more=this.declarativeScraper("scraper","more"),data=/app.ProductCache = new app\.ProductController\(([\S\s]*?)\);/.exec(this.resource)[1],colorsMatch=data.match(/\{"id" : "colorCode", "name" : "Color",([\S\s]*?)\{"id" : "size", "name" : "Size",/)[1],colors=this.matchAll(colorsMatch,/\{"val" :"([^"]*)"([\S\s]*?\]\s*\}\s*\})/),images={};for(_i=0,_len=colors.length;_i<_len;_i++)color=colors[_i],imgs=[],data=color[2].match(/"images"\s*:\s*(\{[\S\s]*?\})\s*\}/)[1],obj=JSON.parse(data),images[color[1]]={swatch:obj.swatch.url,swatch2:obj.swatch2.url,small:_.map(obj.small,function(i){return i.url}),medium:_.map(obj.medium,function(i){return i.url}),large:_.map(obj.large,function(i){return i.url}),xlarge:_.map(obj.xlarge,function(i){return i.url})};more.images=images,_ref=more.colors;for(_j=0,_len1=_ref.length;_j<_len1;_j++)color=_ref[_j],parseInt(color.id)===parseInt(this.productSid.color)&&(more.color=color.name);return this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/BVRRRatingSummaryLinkWriteFirstID/,0,function(){return 0}],[/alt=\\"([\d.]*) out of 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/BVRRRatingSummaryLinkWriteFirstID/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) out of 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},TheLimitedProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/TheLimited/TheLimitedSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var TheLimitedSiteInjector;return TheLimitedSiteInjector=function(_super){__extends(TheLimitedSiteInjector,_super);function TheLimitedSiteInjector(){return TheLimitedSiteInjector.__super__.constructor.apply(this,arguments)}return TheLimitedSiteInjector.prototype.parseUrl=function(url){var color,id,size,_ref,_ref1,_ref2;return id=(_ref=/\/(\d+)[^\/]*?.html/.exec(url))!=null?_ref[1]:void 0,id?(color=(_ref1=/_colorCode=(\d*)/.exec(url))!=null?_ref1[1]:void 0,color?(size=(_ref2=/_size=(\w*)/.exec(url))!=null?_ref2[1]:void 0,size?""+id+"-"+color+"-"+size:""+id+"-"+color):id):null},TheLimitedSiteInjector.prototype.productListing={mode:2,image:"a:not(.swatchanchor) img"},TheLimitedSiteInjector.prototype.productPage={test:function(){return $("#printProductSetImages").length},productSid:function(){var color,id,parts,size,__,_ref;if($(".zoomPad > img").length)return _ref=/([^\/]*?)_(\d*)_\d*\.jpg/.exec($(".zoomPad > img").attr("src")),__=_ref[0],id=_ref[1],color=_ref[2],parts=[id,color],size=$(".swatches.size li.selected a").attr("rel"),size&&parts.push(size),parts.join("-")},imgEl:".zoomPad > img",overlayEl:".zoomPup"},TheLimitedSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"toysrus",hosts:["www.toysrus.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.toysrus.com/favicon.ico"},define("sites/ToysRUs/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ToysRUs/ToysRUsProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var ToysRUsProductScraper;return ToysRUsProductScraper=function(_super){__extends(ToysRUsProductScraper,_super);function ToysRUsProductScraper(){return ToysRUsProductScraper.__super__.constructor.apply(this,arguments)}return ToysRUsProductScraper.testProducts=["13018810"],ToysRUsProductScraper.prototype.resources={productPage:{url:function(){return"http://www.toysrus.com/product/index.jsp?productId="+this.productSid}}},ToysRUsProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<meta property="eb:saleprice" content="([^"]*)/),1],[new RegExp(/<meta property="eb:price" content="([^"]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<input name=enh_0 type=hidden value="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var altDescCheck,altDescUrl,altImageCheck,altImageUrl,description,image,imageMatches,images,mainDesc,match,matches,switches,value,_i,_len;switches={images:!0,description:!0,rating:!0,ratingCount:!0,originalPrice:!0,shipping:!1},value={},switches.description&&(description=[],mainDesc=this.resource.match(/<h3>Product Description<\/h3>([\S\s]*?)<div/),mainDesc&&description.push("<div>"+mainDesc[1]),altDescCheck=this.resource.match(/(http:\/\/content.webcollage.net\/toysrus\/smart-button)/),altDescCheck&&(altDescUrl="http://content.webcollage.net/toysrus/smart-button?ird=true&channel-product-id="+this.productSid,this.execBlock(function(){return this.get(altDescUrl,function(response){var matches;return matches=response.match(/html: "([\S\s]*?)};/),matches&&description.push(matches[1].replace(/\}+$/gm,"").replace(/\"+$/gm,"").replace(/\\"+/gm,'"').replace(/\\\/+/gm,"/")),this.done(!0),this.value(value)}),null})),value.description=description),switches.rating&&(matches=this.resource.match(/var POWERREVIEWS=([\S\s]*?)<\/script>/),matches&&(matches=matches[1].match(/,s:([^,]*)/),value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/var POWERREVIEWS=([\S\s]*?)<\/script>/),matches&&(matches=matches[1].match(/,rc:([^,]*)/),value.reviewCount=matches[1])),switches.originalPrice&&(matches=this.resource.match(/<meta property="eb:price" content="([^"]*)/),matches&&(value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<div class="altImages([\S\s]*?)<div id="leftSide">/);if(matches){imageMatches=matches[1].match(/href="javascript:swapImage\('([^']*)/g);if(imageMatches)for(_i=0,_len=imageMatches.length;_i<_len;_i++)match=imageMatches[_i],image=match.match(/href="javascript:swapImage\('([^']*)/),images.push("http://www.toysrus.com"+image[1])}altImageCheck=this.resource.match(/(http:\/\/content.webcollage.net\/toysrus\/smart-button)/),altImageCheck&&(altImageUrl="http://content.webcollage.net/toysrus/smart-button?ird=true&channel-product-id="+this.productSid,this.execBlock(function(){return this.get(altImageUrl,function(response){var _j,_len1;matches=response.match(/<div class=\\"wc-gallery-thumb\\"([\S\s]*?)<\\\/div>/g);if(matches)for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],image=match.match(/wcobj=\\"([\S\s]*?)\\"/)[1],images.push(image.replace(/\\"+/gm,'"').replace(/\\\/+/gm,"/"));return this.done(!0),this.value(value)}),null})),value.images=images}return this.value(value)})}},ToysRUsProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/ToysRUs/ToysRUsSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var ToysRUsSiteInjector;return ToysRUsSiteInjector=function(_super){__extends(ToysRUsSiteInjector,_super);function ToysRUsSiteInjector(){return ToysRUsSiteInjector.__super__.constructor.apply(this,arguments)}return ToysRUsSiteInjector.prototype.productListing={imgSelector:'a[href^="http://www.toysrus.com/product/"] img, a[href^="/product/"] img',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.toysrus\.com\/product\/index\.jsp\?productId=([^&]+)/))!=null?_ref[1]:void 0,name}},ToysRUsSiteInjector.prototype.productPage={test:function(){return $("#productView").length},productSid:function(){return document.location.href.match(/^http:\/\/www\.toysrus\.com\/product\/index\.jsp\?productId=([^&]+)/)[1]},imgEl:".flyoutZoomImg",waitFor:".flyoutZoomImg",overlayEl:"#marker"},ToysRUsSiteInjector}(DataDrivenSiteInjector)}}}),{hosts:["tutorial.agora"]},define("sites/Tutorial/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Tutorial/TutorialSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView","views/compare/CompareView"],c:function(){var TutorialSiteInjector;return TutorialSiteInjector=function(_super){__extends(TutorialSiteInjector,_super);function TutorialSiteInjector(){return TutorialSiteInjector.__super__.constructor.apply(this,arguments)}return TutorialSiteInjector.prototype.siteName="Tutorial",TutorialSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var callWhen,doTutorial,done,el,productSid,shoppingBarView,siteName,startTutorial,stepStartTime,tutorial,tutorialStep,tutorialSteps,tutorialStepsText,__,_i,_len,_ref,_ref1;shoppingBarView=new ShoppingBarView(_this.contentScript,{context:"tutorial"}),shoppingBarView.el.appendTo(document.body),shoppingBarView.represent(),window.suppressPopups=!0,window.tutorialInProgress=!0,done=!1,$(window).bind("beforeunload",function(){if(!done)return"You haven't finished the tour yet."}),tutorialStepsText={intro:{text:'<p>Welcome to Agora, a tool to improve your online shopping. Let\'s run through a brief tour of our main features.</p> <p><a href="#" class="button begin">Okay, let\'s begin.</a></p>',audio:"http://files.agora.sh/tutorialaudio/01_01.mp3"},productHover:{text:"First, move your mouse over this product image.",audio:"http://files.agora.sh/tutorialaudio/02_01.mp3"},enterPortal:{text:"Next, click the <b>Inspect button</b> that appears when you hover. It looks like an eye, and it will appear on the product images on all our supported sites.",audio:"http://files.agora.sh/tutorialaudio/03_01.mp3"},closePortal:{text:"<h2>Product Portal</h2> <p>Welcome to the <b>Product Portal</b>. You can access it from from any product on our growing list of supported sites by clicking the inspect button on product images.</p> <p>Take a look around at the features it provides and when you're done, close the portal by pressing the ESC key or clicking the close button at the top right.</p>",audio:"http://files.agora.sh/tutorialaudio/04_01.mp3"},dragProduct:{text:"Okay, let’s learn how to collect products that you may want to consider purchasing. Start by dragging this image...",audio:"http://files.agora.sh/tutorialaudio/05_01.mp3"},dropProduct:{text:"...and drop it down here on the <b>Belt</b>.",audio:"http://files.agora.sh/tutorialaudio/06_01.mp3"},addFeeling:{text:"<!--<h2>Thoughts and Feelings</h2>--> <p>You can record the feelings and thoughts you have about the products you are shopping for.</p> <p>Type a thought or feeling and <b>press enter</b>, or just <b>press ESC</b> to close this dialog and continue on to the next step.</p>",audio:"http://files.agora.sh/tutorialaudio/07_01.mp3"}},_ref=$("#products .product[data-product]");for(_i=0,_len=_ref.length;_i<_len;_i++)el=_ref[_i],_ref1=/([^\/]*)\/(.*)/.exec($(el).attr("data-product")),__=_ref1[0],siteName=_ref1[1],productSid=_ref1[2],_this.initProductEl($(el).find(".picture img"),{siteName:siteName,productSid:productSid},{initOverlay:function(overlay){return overlay.autoFixPosition(),overlay.showPreview=!1}});return callWhen=function(el,cb){var timerId;return timerId=setInterval(function(){if($(el).length)return cb(),clearInterval(timerId)},50)},tutorialSteps=[function(next){return tutorial.showCenter(400,tutorialStepsText.intro),tutorial.frameEl.find(".begin").click(function(_this){return function(){return next(),++tutorialStep,!1}}(this))},function(next){return tutorial.show($("#product1"),"left",tutorialStepsText.productHover),$("#product1").mouseover(function(_this){return function(){if(tutorialStep===1)return next(),++tutorialStep}}(this))},function(next){return tutorial.show($("#product1 img").data("agora").overlayView.el,"below",tutorialStepsText.enterPortal),$("#product1 img").data("agora").overlayView.el.click(function(_this){return function(){if(tutorialStep===2)return setTimeout(function(){return next()},500)}}(this))},function(next){var timerId;return tutorial.show({left:$(window).width()/2-300,top:$(window).height()/2-100,pointer:!1},"below",tutorialStepsText.closePortal),timerId=setInterval(function(_this){return function(){if(!$(".v-productPreview2").length)return clearInterval(timerId),setTimeout(function(){return next()},200)}}(this),100)},function(next){return tutorial.show($("#product1 img"),"right",tutorialStepsText.dragProduct),$("#product1 img").mousedown(function(_this){return function(){if(tutorialStep===2)return next()}}(this))},function(next){var timerId;return tutorial.show($(".v-shoppingBar"),"above",tutorialStepsText.dropProduct),++tutorialStep,timerId=setInterval(function(_this){return function(){if($(".v-addFeeling").length)return clearInterval(timerId),next()}}(this),100)},function(next){var timerId;return tutorial.show($(".v-addFeeling"),"above",tutorialStepsText.addFeeling),timerId=setInterval(function(_this){return function(){if(!$(".v-addFeeling").length)return window.suppressAddFeeling=!0,clearInterval(timerId),next()}}(this),100)},function(next){return tutorial.show($("#product2 img"),"below",{text:"Now start dragging this product image, but this time don't drop it directly onto the Belt.",audio:"http://files.agora.sh/tutorialaudio/08_01.mp3"}),$("#product2 img").one("mousedown",function(_this){return function(){return next()}}(this))},function(next){var timerId;return tutorial.show($(".v-shoppingBar .product"),"above",{text:"Instead, drop it down onto this product.",audio:"http://files.agora.sh/tutorialaudio/09_01.mp3"}),timerId=setInterval(function(_this){return function(){if($(".v-shoppingBar .decision").length)return clearInterval(timerId),next()}}(this),100)},function(next){var timerId;return tutorial.show($(".v-shoppingBar .decision"),"above",{text:'<p>You\'ve created a <b>Decision</b>. Decisions are used to store all the products you are considering for one particular purchase, and represents a single "buying decision."</p> <p>Now click the Decision to view the products you added to it.</b>',audio:"http://files.agora.sh/tutorialaudio/10_01.mp3"}),timerId=setInterval(function(_this){return function(){if($(".v-shoppingBar.Decision").length)return clearInterval(timerId),next()}}(this),100)},function(next){return callWhen(".v-shoppingBar .product:last",function(){return tutorial.show($(".v-shoppingBar .product:last"),"above",{text:"<p>You can think of the products on your Belt as special browser bookmarks just for shopping. All the products you add to it will be available to you any time you visit one of our supported sites. You'll also be able to add new products by dropping any product image you see on a supported site onto the Belt.</p> <p>Next, click this product to visit its retail page.</p>",audio:"http://files.agora.sh/tutorialaudio/11_01.mp3"}),done=!0,next(),chrome.extension?chrome.runtime.sendMessage("continueTutorial"):(chrome.runtime.sendMessage("jhlelmocecgfffgmpbkjjgkdjlpbjain","continueTutorial"),chrome.runtime.sendMessage("ejlcjafiokgjbepfhclmlmlkkjnjadej","continueTutorial"),chrome.runtime.sendMessage("eikmdfdlppngdbmdllhkmkchnkiiecea","continueTutorial"))})}],tutorialStep=0,tutorial=new TutorialDialog(20,1),stepStartTime=null,doTutorial=function(i){i>0&&(console.debug("time",i,(new Date).getTime()-stepStartTime),tracking.time("Tutorial","Step"+i,(new Date).getTime()-stepStartTime));if(tutorialSteps[i])return this.contentScript.triggerBackgroundEvent("tutorialStep",i+1),console.debug(i+1),stepStartTime=(new Date).getTime(),tutorialSteps[i](function(){return doTutorial(i+1)})},startTutorial=function(){return chrome.runtime.sendMessage("startTutorial"),doTutorial(0)},$(startTutorial)}}(this))},TutorialSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"uniqlo",hosts:["www.uniqlo.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.uniqlo.com/favicon.ico"},define("sites/Uniqlo/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Uniqlo/UniqloProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var UniqloProduct;return UniqloProduct=function(_super){__extends(UniqloProduct,_super);function UniqloProduct(){return UniqloProduct.__super__.constructor.apply(this,arguments)}return UniqloProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,colorName,currentColor,id,image,images,otherImages,_i,_j,_len,_len1,_ref,_ref1,_ref2;otherImages=function(){var _i,_len,_ref,_results;_ref=more.images,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}(),images={},_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],id=_this.product.get("productSid").split("-")[0],image="http://uniqlo.scene7.com/is/image/UNIQLO/goods_"+color.id+"_"+id,images[color.name]=[{small:image,medium:image,large:image,larger:image,full:image}].concat(otherImages);currentColor=(_ref1=_this.product.get("productSid").split("-"))!=null?_ref1[1]:void 0,colorName=null;if(currentColor){_ref2=more.colors;for(_j=0,_len1=_ref2.length;_j<_len1;_j++)color=_ref2[_j],currentColor===color.id&&(colorName=color.name)}return cb(images,colorName)}}(this))},UniqloProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",materials:"Details",sizes:"Sizes",colors:{title:"Colors",map:function(color){return""+color.id+" "+util.ucfirst(color.name)}},reviews:{obj:reviews,map:{review:"content"}}}),cb(widgets)}}(this))},UniqloProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Uniqlo/UniqloProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var UniqloProductScraper;return UniqloProductScraper=function(_super){__extends(UniqloProductScraper,_super);function UniqloProductScraper(){return UniqloProductScraper.__super__.constructor.apply(this,arguments)}return UniqloProductScraper.testProducts={"086831-22":{image:"http://uniqlo.scene7.com/is/image/UNIQLO/goods_22_086831?$pdp-medium$",rating:"5",ratingCount:"1",title:"WOMEN SUPIMA COTTON TANK TOP",price:"9.90",more:{description:"This tank top is made of soft Supima&reg; cotton in a shapely, feminine silhouette. Great for layering or wearing alone, this tank is available in a wide range of colors.",materials:["94% cotton, 6% spandex","Machine wash cold","Imported"],sizes:["XS","S","M","L","XL","XXL"]}},"075819-68":{image:"http://uniqlo.scene7.com/is/image/UNIQLO/goods_68_075819?$pdp-medium$",rating:0,ratingCount:0,title:"WOMEN COLOR RIB SLEEVELESS TOP",price:"5.90",more:{description:"This ribbed tank top offers a great fit in modern, minimalist style. Ideal for layering.",materials:["50% rayon, 50% cotton","Machine wash cold, gentle cycle","Imported"],sizes:["XS","S","M","L","XL"]}},"075481-09":{}},UniqloProductScraper.prototype.parseSid=function(sid){var parts,_ref,_ref1,_ref2;return parts=sid.split("-"),{id:parts[0],color:(_ref=parts[1])!=null?_ref:"00",size:(_ref1=parts[2])!=null?_ref1:"000",length:(_ref2=parts[0])!=null?_ref2:"000"}},UniqloProductScraper.prototype.resources={productData:{url:function(){return"http://www.uniqlo.com/us/store/gcx/getProductInfo.do?format=json&product_cd="+this.productSid.id}},reviewData:{url:function(){return"http://uniqloenus.ugc.bazaarvoice.com/5311-en_us/"+this.productSid.id+"/reviews.djs?format=embeddedhtml"}}},UniqloProductScraper.prototype.properties={title:{resource:"productData",scraper:JsonResourceScraper(function(data){return data.goods_name.trim()})},price:{resource:"productData",scraper:JsonResourceScraper(function(data){return data.first_price})},image:function(cb){return cb("http://uniqlo.scene7.com/is/image/UNIQLO/goods_"+this.productSid.color+"_"+this.productSid.id+"?$pdp-medium$")},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/alt=\\"(.*?) \/ 5\\"/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/Write the first review<\\\/a>/,0,function(){return 0}],[/<span class=\\"BVRRNumber\\">(\d+)/,1]])},more:{resource:"productData",scraper:JsonResourceScraper(function(data){var more;return more={},data.dtl_exp&&(more.description=data.dtl_exp.trim()),more.materials=this.matchAll(data.material_info,/<li>([\S\s]*?)<\/li>/,1),more.sizes=_.map(data.size_info_list,function(obj){return obj.size_nm}),data.goods_sub_image_list?more.images=_.map(data.goods_sub_image_list.split(";"),function(i){return"http://uniqlo.scene7.com/is/image/UNIQLO/goods_"+i}):more.images=[],more.colors=_.map(data.color_info_list,function(obj){return{name:obj.color_nm,id:obj.color_cd}}),more})},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/title=\\"(\d+) \/ 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},UniqloProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Uniqlo/UniqloSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var UniqloSiteInjector;return UniqloSiteInjector=function(_super){__extends(UniqloSiteInjector,_super);function UniqloSiteInjector(){return UniqloSiteInjector.__super__.constructor.apply(this,arguments)}return UniqloSiteInjector.prototype.productListing={image:'a img[src^="//uniqlo.scene7.com/is/image/UNIQLO/goods_"], a img[src^="http://uniqlo.scene7.com/is/image/UNIQLO/goods_"]',productSid:function(href,a,img){var matches;matches=/^(?:http:)?\/\/uniqlo\.scene7\.com\/is\/image\/UNIQLO\/goods_(\d+)_(\d+)/.exec(img.attr("src"));if(matches)return""+matches[2]+"-"+matches[1]}},UniqloSiteInjector.prototype.productPage={mode:2,image:".pdp-images img",attach:"body",test:function(){return $('meta[property="og:type"]').attr("content")==="og:product"},productSid:function(){var matches;return matches=$(".pdp-image-main-media [itemprop=image]").attr("src").match(/UNIQLO\/goods_(\d*)_(\d*)/),""+matches[2]+"-"+matches[1]}},UniqloSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!0,slug:"victoriassecret",hosts:["www.victoriassecret.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.victoriassecret.com/favicon.ico"},define("sites/VictoriasSecret/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/VictoriasSecret/VictoriasSecretProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var VictoriasSecretProductScraper;return VictoriasSecretProductScraper=function(_super){__extends(VictoriasSecretProductScraper,_super);function VictoriasSecretProductScraper(){return VictoriasSecretProductScraper.__super__.constructor.apply(this,arguments)}return VictoriasSecretProductScraper.testProducts=["165629"],VictoriasSecretProductScraper.prototype.resources={productPage:{url:function(){return"http://www.victoriassecret.com/panties/bikinis/-?ProductID="+this.productSid}}},VictoriasSecretProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content="([^"]*)/),1)},price:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var dash,dashMatches,firstMatches,match,matches,orMatch,orig,price,priceMatch,priceMatches,prices,special,_i,_j,_len,_len1;firstMatches=this.resource.match(/<div class="price">([\S\s]*?)<div class="more">/),matches=firstMatches[1].match(/<p>([\S\s]*)/),dashMatches=matches[1].match(/([\S\s]*?)<a/),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<\/p/)),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<div class="more"/)),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<br/)),dash=dashMatches[1].match(/(-)/),orig=matches[1].match(/(Sale)/),orMatch=matches[1].match(/( or )/);if(dash&&orig&&!orMatch){prices=[],priceMatches=matches[1].match(/Sale \$([^<]+)/g);for(_i=0,_len=priceMatches.length;_i<_len;_i++)match=priceMatches[_i],prices.push(match.match(/Sale \$([^<]+)/)[1]);price=prices[0]+" - $"+prices[1]}else if(dash&&orMatch&&!orig){prices=[],priceMatches=matches[1].match(/\$([^\.]+.\d\d)/g);for(_j=0,_len1=priceMatches.length;_j<_len1;_j++)match=priceMatches[_j],prices.push(match.match(/\$([^\.]+.\d\d)/)[1]);special=matches[1].match(/or([\S\s]*)<\//),special=special[1].match(/>([^<]+)/),price=prices[0]+" - $"+prices[1]+" or "+special[1]}else!dash&&orMatch&&!orig?(priceMatch=matches[1].match(/\$([^\.]+.\d\d)/),special=matches[1].match(/or([\S\s]*)<\//),special=special[1].match(/>([^<]+)/),price=priceMatch[1]+" or "+special[1]):orig&&!dash&&!orMatch?(priceMatches=matches[1].match(/Sale \$([^<]+)/),price=priceMatches[1]):!orig&&!dash&&!orMatch&&(priceMatches=matches[1].match(/\$([^<]+)/),price=priceMatches[1]);return this.value(price)})},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content="([^"]*)/),1)},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var colorMatches,colors,dash,dashMatches,firstMatches,image,images,match,matches,name,orMatch,orig,overviewMatch,pics,price,priceMatches,prices,swatch,switches,value,viewMatches,views,_i,_j,_k,_len,_len1,_len2;switches={images:!1,overview:!1,details:!1,originalPrice:!1,shipping:!1},value={},switches.overview&&(matches=this.resource.match(/<section class="description">([\S\s]*?)<\/section>/),overviewMatch=matches[1].match(/<div class="full[^>]*>([\S\s]*?)<\/div>/),value.overview=overviewMatch[1]),switches.details&&(matches=this.resource.match(/<span class="info-tooltip-display">([\S\s]*?)<\/span>/),value.details=matches[1]);if(switches.originalPrice){firstMatches=this.resource.match(/<div class="price">([\S\s]*?)<div class="more">/),matches=firstMatches[1].match(/<p>([\S\s]*)/),dashMatches=matches[1].match(/([\S\s]*?)<a/),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<\/p/)),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<div class="more"/)),dashMatches||(dashMatches=matches[1].match(/([\S\s]*?)<br/)),dash=dashMatches[1].match(/(-)/),orig=matches[1].match(/(Sale)/),orMatch=matches[1].match(/( or )/);if(dash&&orig&&!orMatch){prices=[],priceMatches=matches[1].match(/Orig\. \$([^<]+)/g);for(_i=0,_len=priceMatches.length;_i<_len;_i++)match=priceMatches[_i],prices.push(match.match(/Orig\. \$([^<]+)/)[1]);price=prices[0]+" - $"+prices[1]}else dash&&orMatch&&!orig?price=null:!dash&&orMatch&&!orig?price=null:orig&&!dash&&!orMatch?(priceMatches=matches[1].match(/Orig\. \$([^<]+)/),price=priceMatches[1]):!orig&&!dash&&!orMatch&&(price=null);value.originalPrice=price}if(switches.images){images={},views={},colors={},matches=this.resource.match(/<div class="product-image-group">([\S\s]*?)<ul class="pdp-info/),matches=matches[1].match(/<ul>([\S\s]*?)<\/ul>/),viewMatches=matches[1].match(/<img([\S\s]*?)<\/span>/g);for(_j=0,_len1=viewMatches.length;_j<_len1;_j++)match=viewMatches[_j],image=match.match(/src="([^"]*)/),image=image[1].replace(/63x84+/gm,"404x539"),name=match.match(/<span>([^<]*)/),views[name[1]]="http:"+image;images.views=views,matches=this.resource.match(/<section class="swatches([\S\s]*?)<\/section>/),colorMatches=matches[1].match(/<a([\S\s]*?)<\/a>/g);for(_k=0,_len2=colorMatches.length;_k<_len2;_k++)match=colorMatches[_k],pics={},image=match.match(/data-alt-image="([^"]*)/),image?image="http://dm.victoriassecret.com/product/404x539/"+image[1]+".jpg":image=null,pics.image=image,swatch=match.match(/src="([^"]*)/),pics.swatch="http:"+swatch[1],name=match.match(/<span[^>]*>([^<]*)<\/span>/),colors[name[1]]=pics;images.colors=colors,value.images=images}return this.value(value)})}},VictoriasSecretProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/VictoriasSecret/VictoriasSecretSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var VictoriasSecretSiteInjector;return VictoriasSecretSiteInjector=function(_super){__extends(VictoriasSecretSiteInjector,_super);function VictoriasSecretSiteInjector(){return VictoriasSecretSiteInjector.__super__.constructor.apply(this,arguments)}return VictoriasSecretSiteInjector.prototype.productListing={imgSelector:'a span img[src^="//dm.victoriassecret.com/product/"]',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/ProductID=([^&]+)/))!=null?_ref[1]:void 0,name}},VictoriasSecretSiteInjector.prototype.productPage={test:function(){return $("#mainView").length},productSid:function(){return document.location.href.match(/ProductID=([^&]+)/)[1]},imgEl:"#mainView",waitFor:"#mainView",overlayEl:"#zoom-lens .lens-container .lens-border span"},VictoriasSecretSiteInjector}(DataDrivenSiteInjector)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Vitacost/_SiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView"],c:function(){var JCPenneySiteInjector;return JCPenneySiteInjector=function(_super){__extends(JCPenneySiteInjector,_super);function JCPenneySiteInjector(){return JCPenneySiteInjector.__super__.constructor.apply(this,arguments)}return JCPenneySiteInjector.prototype.siteName="JCPenney",JCPenneySiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var initProducts,parseSid;return _this.shoppingBarView=new ShoppingBarView(_this.contentScript),_this.shoppingBarView.el.appendTo(document.body),_this.shoppingBarView.represent(),parseSid=function(href){var matches;matches=/^http:\/\/www\.jcpenney\.com\/.*?\/prod\.jump\?ppId=([a-z]*\d+)/.exec(href);if(matches)return matches[1]},window.initProducts=initProducts=function(){var a,href,img,match,sid,_i,_len,_ref,_ref1,_results;_ref=$("a img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],a=$(img).parents("a"),a.attr("href")&&a.attr("href")[0]!=="#"?(href=a.prop("href"),sid=parseSid(href),sid||(match=(_ref1=/(http:\/\/www\.jcpenney.com\/.*?)(?:&|$)/.exec(unescape(href)))!=null?_ref1[1]:void 0,match&&(sid=parseSid(match))),sid?(console.log(sid,href),_results.push(_this.initProductEl(img,{productSid:sid}))):_results.push(void 0)):_results.push(void 0);return _results},$(initProducts),$(window).load(initProducts),setInterval(initProducts,2e3),$(function(){var currentSid;if($("#izView").length)return currentSid=function(){return/[?&]ppId=(.*?)(?:&|$)/.exec(document.location.href)[1]},_this.waitFor("#izView img",function(){var img,_i,_len,_ref,_results;_ref=$("#izView img"),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)img=_ref[_i],_results.push(_this.initProductEl(img,{productSid:currentSid()}));return _results})})}}(this))},JCPenneySiteInjector}(SiteInjector)}}});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Vitacost/VitacostProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var VitacostProductScraper;return VitacostProductScraper=function(_super){__extends(VitacostProductScraper,_super);function VitacostProductScraper(){return VitacostProductScraper.__super__.constructor.apply(this,arguments)}return VitacostProductScraper.testProducts=[""],VitacostProductScraper.prototype.resources={productPage:{url:function(){return""+this.productSid}}},VitacostProductScraper}(ProductScraper)}),{excludedFeatures:["offers","deals","reviews","rating"],hasProductClass:!1,slug:"walgreens",hosts:["www.walgreens.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.walgreens.com/favicon.ico"},define("sites/Walgreens/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Walgreens/WalgreensProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,_){var WalgreensProductScraper;return WalgreensProductScraper=function(_super){__extends(WalgreensProductScraper,_super);function WalgreensProductScraper(){return WalgreensProductScraper.__super__.constructor.apply(this,arguments)}return WalgreensProductScraper.testProducts=["6051381"],WalgreensProductScraper.prototype.resources={productPage:{url:function(){return"http://www.walgreens.com/store/c/-/ID=prod"+this.productSid+"-product"}}},WalgreensProductScraper.prototype.properties={title:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:title" content='([^|]*)/),1)},price:{resource:"productPage",scraper:PatternResourceScraper([[new RegExp(/<span id="vpdSinglePrice">\$([^<]*)/),1],[new RegExp(/<b class="price sale" id='sale_amount' itemprop="price">\$([^<]*)/),1]])},image:{resource:"productPage",scraper:PatternResourceScraper(new RegExp(/<meta property="og:image" content='http:\/\/www\.walgreens\.com\/\/pics\.drugstore\.com\/prodimg\/([^\/]*)/),1).config({map:function(value){return"http://pics.drugstore.com/prodimg/"+value+"/500.jpg"}})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var altDescCheck,altDescUrl,author,authorBio,authorMatches,authorNames,bioMatch,bioMatches,content,count,description,editorialReviews,erMatches,from,image,imageMatches,images,ingredients,isbn,item,match,matches,name,overview,par,switches,uses,value,warnings,_i,_j,_k,_l,_len,_len1,_len2,_len3;switches={images:!1,overview:!1,description:!1,ingredients:!1,uses:!1,warnings:!1,rating:!1,ratingCount:!1,originalPrice:!1,shipping:!1},value={},switches.overview&&(overview=[],matches=this.resource.match(/<div class="vpd_overview[^>]*>([\S\s]*?)<\/div>/),value.overview=matches[1]),switches.description&&(description=[],altDescCheck=this.resource.match(/(<script type="text\/javascript" src="http:\/\/content.webcollage.net\/walgreens\/smart-button">)/),altDescCheck?(altDescUrl="http://content.webcollage.net/walgreens/smart-button?ird=true&channel-product-id=prod"+this.productSid,this.execBlock(function(){return this.get(altDescUrl,function(response){return matches=response.match(/html: "([\S\s]*?)};/),description.push(matches[1].replace(/\}+$/gm,"").replace(/\"+$/gm,"").replace(/\\"+/gm,'"').replace(/\\\/+/gm,"/")),this.done(!0),this.value(value)}),null}),value.description=description):(description.push("<div><div>"+this.resource.match(/<div class="description-list[^>]*>([\S\s]*?)<div id="uses-content"/)[1]),value.description=description)),switches.ingredients&&(ingredients=this.resource.match(/<div id="ingredients-content" class="tabContainer">([\S\s]*?)<\/noscript>/),ingredients&&(value.ingredients=ingredients[1])),switches.warnings&&(warnings=this.resource.match(/<div id="warnings-content" class="tabContainer">([\S\s]*?)<div id="tab-ingredients"/),warnings&&(value.warnings=warnings[1])),switches.uses&&(uses=this.resource.match(/<div id="uses-content" class="tabContainer">([\S\s]*?)<div id="shipping-content"/),uses&&(value.uses=uses[1])),switches.isbn&&(matches=this.resource.match(/<div class="product-details([\S\s]*?)<\/section>/),isbn=matches[1].match(/<span>ISBN-13:<\/span>([\S\s]*?)<\/li>/),value.isbn=isbn[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "));if(switches.author){author={},authorNames=[],matches=this.resource.match(/<ul class="contributors([\S\s]*?)<\/ul>/),authorMatches=matches[1].match(/<li([\S\s]*?)<\/li>/g),count=0;for(_i=0,_len=authorMatches.length;_i<_len;_i++)item=authorMatches[_i],count>0&&(name=item.match(/<li([\S\s]*?)<\/li>/)[1],authorNames.push(name.replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," "))),count++;author.names=authorNames,authorBio=[],bioMatch=this.resource.match(/<div class="basic-info([\S\s]*?)<\/section>/),bioMatches=bioMatch[1].match(/<p>([\S\s]*?)<\/p>/g);for(_j=0,_len1=bioMatches.length;_j<_len1;_j++)match=bioMatches[_j],par=match.match(/<p>([\S\s]*?)<\/p>/)[1],authorBio.push(par);author.bio=authorBio,value.author=author}switches.rating&&(matches=this.resource.match(/<span itemprop="ratingValue" style="display:none">([^<]*)/),matches&&(value.rating=matches[1])),switches.reviewCount&&(matches=this.resource.match(/<span itemprop="reviewCount" style="display:none">([^<]*)/),matches&&(value.reviewCount=matches[1]));if(switches.editorialReviews){editorialReviews={},matches=this.resource.safeMatch(/<h3>Editorial Reviews<\/h3>([\S\s]*?)<\/div>/),erMatches=matches[1].match(/<article class="simple-html">([\S\s]*?)<\/article>/g);for(_k=0,_len2=erMatches.length;_k<_len2;_k++)match=erMatches[_k],from=match.match(/<h5>([\S\s]*?)<\/h5>/)[1],content=match.match(/<\/h5>([\S\s]*?)<\/article>/)[1].replace(/^\s+|\s+$/gm,"").replace(/\n\r/g," ").replace(/^<br \/>+|<br \/>+$/gm,""),editorialReviews[from]=content;value.editorialReviews=editorialReviews}switches.originalPrice&&(matches=this.resource.match(/class="strike_thru[^>]+>\$([^<]+)/),matches&&(value.originalPrice=matches[1]));if(switches.images){images=[],matches=this.resource.match(/<div class="view_thumb_image"([\S\s]*?)<\/div>/),imageMatches=matches[1].match(/href="javascript:changeImage\('([^']+)/g);for(_l=0,_len3=imageMatches.length;_l<_len3;_l++)match=imageMatches[_l],image=match.match(/href="javascript:changeImage\('([^']+)/),images.push("http:"+image[1]);value.images=images}return this.value(value)})}},WalgreensProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Walgreens/WalgreensSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var WalgreensSiteInjector;return WalgreensSiteInjector=function(_super){__extends(WalgreensSiteInjector,_super);function WalgreensSiteInjector(){return WalgreensSiteInjector.__super__.constructor.apply(this,arguments)}return WalgreensSiteInjector.prototype.productListing={imgSelector:'a img[src^="//pics.drugstore.com/prodimg"]',productSid:function(href,a,img){var name,_ref;return name=(_ref=href.match(/^http:\/\/www\.walgreens\.com\/store\/c\/.*?\/ID=prod([^-]+)/))!=null?_ref[1]:void 0,name}},WalgreensSiteInjector.prototype.productPage={test:function(){return $("#mainContentStart").length},productSid:function(){return document.location.href.match(/^http:\/\/www\.walgreens\.com\/store\/c\/.*?\/ID=prod([^-]+)/)[1]},imgEl:"#viewL img",waitFor:"#viewL img"},WalgreensSiteInjector}(DataDrivenSiteInjector)}}}),{hosts:["webapp.agora","webapp.agora.dev","66.228.54.96","agora.sh/view/"],productUrl:function(sid){return"#"+sid}},define("sites/Webapp/config",function(){}),define("sites/Webapp/WebappProductScraper",[],function(){var AgoraProductScraper;return AgoraProductScraper=function(){function AgoraProductScraper(site,productSid,background){var properties;this.site=site,this.productSid=productSid,this.background=background,properties=this.properties,this.properties={},this.product=DevProductScraper.products[this.productSid],["image","title","price"].forEach(function(_this){return function(name){return _this.properties[name]={scrape:function(cb){return cb(this.product[name])},productSid:productSid,product:_this.product}}}(this))}return AgoraProductScraper.products={SID1:{image:"http://agoraext.dev/resources/dev/519sTkNOmIL._AA300_.jpg",title:"PlayStation 3 This name is really long so that I can see it wrap",price:"$199.00"},SID2:{image:"http://agoraext.dev/resources/dev/416WlFamYGL._AA300_.jpg",title:"PlayStation 3 Controller",price:"$199.00"},SID3:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Metal Gear Solid",price:"$199.00"},SID4:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 4",price:"$199.00"},SID5:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 5",price:"$199.00"},SID6:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 6",price:"$199.00"},SID7:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 7",price:"$199.00"},SID8:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 8",price:"$199.00"},SID9:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 9",price:"$199.00"},SID10:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 10",price:"$199.00"},SID11:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 11",price:"$199.00"},SID12:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 12",price:"$199.00"},SID13:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 13",price:"$199.00"},SID14:{image:"http://agoraext.dev/resources/dev/414SdVNOsuL._SL500_AA300_.jpg",title:"Product 14",price:"$199.00"}},AgoraProductScraper}()});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Webapp/WebappSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView","views/compare/CompareView","views/WebAppView"],c:function(){var WebAppSiteInjector;return WebAppSiteInjector=function(_super){__extends(WebAppSiteInjector,_super);function WebAppSiteInjector(){return WebAppSiteInjector.__super__.constructor.apply(this,arguments)}return WebAppSiteInjector.prototype.siteName="WebApp",WebAppSiteInjector.prototype.run=function(){return this.initPage(function(_this){return function(){var matches,params,shoppingBarView,webAppView;return env.core||(shoppingBarView=new ShoppingBarView(_this.contentScript),shoppingBarView.el.appendTo(document.body),shoppingBarView.represent()),params=JSON.parse($("html").attr("agoraparams")),matches=document.location.href.match(new RegExp("^"+params.base+"/(.*)$")),webAppView=new WebAppView(_this.contentScript),webAppView.represent(matches!=null?matches[1]:void 0)}}(this))},WebAppSiteInjector}(SiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"wetseal",hosts:["www.wetseal.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.wetseal.com/favicon.ico",twoTap:!0},define("sites/WetSeal/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WetSeal/WetSealProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var WetSealProduct;return WetSealProduct=function(_super){__extends(WetSealProduct,_super);function WetSealProduct(){return WetSealProduct.__super__.constructor.apply(this,arguments)}return WetSealProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var allImages,colorId,image,images,_ref;allImages={},_ref=more.images;for(colorId in _ref)images=_ref[colorId],allImages[colorId]=function(){var _i,_len,_results;_results=[];for(_i=0,_len=images.length;_i<_len;_i++)image=images[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}();return cb(allImages,_this.product.get("productSid").split("_")[1])}}(this))},WetSealProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",details:"Details",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews,map:{review:"content"}}}),cb(widgets)}}(this))},WetSealProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WetSeal/WetSealProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var WetSealProductScraper;return WetSealProductScraper=function(_super){__extends(WetSealProductScraper,_super);function WetSealProductScraper(){return WetSealProductScraper.__super__.constructor.apply(this,arguments)}return WetSealProductScraper.prototype.parseSid=function(sid){var color,size,sku,_ref;return _ref=sid.split("_"),sku=_ref[0],color=_ref[1],size=_ref[2],{sku:sku,color:color,size:size}},WetSealProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.wetseal.com/"+this.productSid.sku+".html?",this.productSid.color&&(url+="dwvar_"+this.productSid.sku+"_color="+this.productSid.color+"&"),this.productSid.size&&(url+="dwvar_"+this.productSid.sku+"_size="+this.productSid.size),url}},variationPage:{url:function(){return"http://www.wetseal.com/on/demandware.store/Sites-wetseal-Site/default/Product-Variation?pid="+this.productSid.sku+"&dwvar_"+this.productSid.sku+"_color="+this.productSid.color+"&format=ajax"}},reviewData:{url:function(){return"http://wetseal.ugc.bazaarvoice.com/9031-en_us/"+this.productSid.sku+"/reviews.djs?format=embeddedhtml"}}},WetSealProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image",function(value){return value.replace("&amp;","&")})},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,images,matches,more,_fn,_i,_len,_ref;more=this.declarativeScraper("scraper","more"),images={},more.images=images,matches=/<h2>Alternate Views<\/h2>\s*<ul>([\S\s]*?)<\/ul>/.exec(this.resource),images[this.productSid.color]=this.matchAll(this.resource,/lgimg='\{"url":"([^"]*)/,1),_ref=more.colors,_fn=function(_this){return function(color){return _this.execBlock(function(){return this.get("http://www.wetseal.com/on/demandware.store/Sites-wetseal-Site/default/Product-Variation?pid="+this.productSid.sku+"&dwvar_"+this.productSid.sku+"_color="+color.id+"&format=ajax",function(response){return matches=/<h2>Alternate Views<\/h2>\s*<ul>([\S\s]*?)<\/ul>/.exec(response),images[color.id]=this.matchAll(matches[1],/lgimg='\{"url":"([^"]*)/,1),this.value(more),this.done(!0)}),null})}}(this);for(_i=0,_len=_ref.length;_i<_len;_i++){color=_ref[_i];if(color.id==="")continue;_fn(color)}return this.value(more)})},rating:{resource:"reviewData",scraper:PatternResourceScraper([[/>Be the first to<\\\/span>/,0,function(){return 0}],[/<span class=\\"BVRRNumber BVRRRatingRangeNumber\\">(\d*)<\\\/span>/,1]])},ratingCount:{resource:"reviewData",scraper:PatternResourceScraper([[/>Be the first to<\\\/span>/,0,function(){return 0}],[/<span class=\\"BVRRCount BVRRNonZeroCount\\">Read <span class=\\"BVRRNumber\\">([^<]*)/,1]])},reviews:{resource:"reviewData",scraper:ScriptedResourceScraper(function(){var authorMatches,contentMatches,dateMatches,i,ratingsMatches,reviews,reviewsText,titleMatch,titleMatches,_ref;return reviewsText=(_ref=this.resource.match(/BVRRDisplayContentBodyID([\S\s]*)/))!=null?_ref[1]:void 0,reviewsText?(titleMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewTitle\\">([\S\s]*?)<\\\/span>/,1),contentMatches=this.matchAll(reviewsText,/<span class=\\"BVRRReviewText\\">([\S\s]*?)<\\\/span>/,1),ratingsMatches=this.matchAll(reviewsText,/alt=\\"(\d*) out of 5\\"/,1),authorMatches=this.matchAll(reviewsText,/<span class=\\"BVRRNickname\\">([^<]*?) <\\\/span>/,1),dateMatches=this.matchAll(reviewsText,/<span class=\\"BVRRValue BVRRReviewDate\\">([^<]*)<\\\/span>/,1),reviews=function(){var _i,_len,_results;_results=[];for(i=_i=0,_len=titleMatches.length;_i<_len;i=++_i)titleMatch=titleMatches[i],_results.push({title:titleMatch,content:contentMatches[i],rating:ratingsMatches[i],author:authorMatches[i],date:dateMatches[i]});return _results}(),this.value(reviews)):this.value([])})}},WetSealProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WetSeal/WetSealSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var WetSealSiteInjector,parseImageUrl;return parseImageUrl=function(url){var matches;return matches=url.match(/Sites-wetseal-Site\/Sites-WS-MASTER\/default\/v[^\/]*\/(\d{8})(\d*)_/i),matches?""+matches[1]+"_"+matches[2]:null},WetSealSiteInjector=function(_super){__extends(WetSealSiteInjector,_super);function WetSealSiteInjector(){return WetSealSiteInjector.__super__.constructor.apply(this,arguments)}return WetSealSiteInjector.prototype.productListing={mode:2,overlayZIndex:1,image:'a:not(.thumbnail-link) img[src^="http://demandware.edgesuite.net/sits_pod21/dw/image/v2/AANJ_PRD/on/demandware.static/Sites-wetseal-Site/Sites-WS-MASTER"]',productSid:function(href,a,img){return parseImageUrl(img.attr("src"))}},WetSealSiteInjector.prototype.productPage={mode:2,test:function(){return $("h1.product-name").length},productSid:function(){return parseImageUrl($('img[itemprop="image"]').attr("src"))},image:'img[itemprop="image"]',attach:"body",position:'img[itemprop="image"]',zIndex:999},WetSealSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["offers","deals"],hasProductClass:!0,slug:"womanwithin",hosts:["www.womanwithin.com"],currency:"dollar",scraper:!0,hasMore:!1,icon:"http://www.womanwithin.com/favicon.ico"},define("sites/WomanWithin/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WomanWithin/WomanWithinProduct",["scraping/SiteProduct","util"],function(SiteProduct,util){var WomanWithinProduct;return WomanWithinProduct=function(_super){__extends(WomanWithinProduct,_super);function WomanWithinProduct(){return WomanWithinProduct.__super__.constructor.apply(this,arguments)}return WomanWithinProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var color,image,images,otherImages,_i,_len,_ref;images={},otherImages=function(){var _i,_len,_ref,_results;_ref=more.images,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)image=_ref[_i],_results.push({small:image,medium:image,large:image,larger:image,full:image});return _results}(),_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++)color=_ref[_i],images[color.name]=[{small:color.image,medium:color.image,large:color.image,larger:color.image,full:color.image}].concat(otherImages);return cb(images,more.color)}}(this))},WomanWithinProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var widgets;return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",colors:{title:"Colors",map:function(color){return util.ucfirst(color.name)}},reviews:{obj:reviews}}),cb(widgets)}}(this))},WomanWithinProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WomanWithin/WomanWithinProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/JsonResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,JsonResourceScraper,DeclarativeResourceScraper,_){var WomanWithinProductScraper;return WomanWithinProductScraper=function(_super){__extends(WomanWithinProductScraper,_super);function WomanWithinProductScraper(){return WomanWithinProductScraper.__super__.constructor.apply(this,arguments)}return WomanWithinProductScraper.prototype.parseSid=function(sid){var sku,style,_ref;return _ref=sid.split("-"),sku=_ref[0],style=_ref[1],{sku:sku,style:style}},WomanWithinProductScraper.prototype.resources={productPage:{url:function(){var url;return url="http://www.womanwithin.com/clothing/-.aspx?pfId="+this.productSid.sku+"&producttypeid=1",this.productSid.style&&(url+="&styleno="+this.productSid.style),url}}},WomanWithinProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},reviews:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","reviews")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var color,more,_i,_len,_ref;more=this.declarativeScraper("scraper","more"),_ref=more.colors;for(_i=0,_len=_ref.length;_i<_len;_i++){color=_ref[_i];if(color.id===this.productSid.style){more.color=color.name;break}}return this.value(more)})},image:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var image,style,_ref;return style=this.productSid.style,image=(_ref=this.resource.match("mainimageUrl='(.*?_"+style+".jpg?[^']*)' colorName"))!=null?_ref[1]:void 0,image?image=image.replace(/&amp;/g,"&"):image=/<meta property="og:image" content="([^"]*)/.exec(this.resource)[1],this.value(image)})}},WomanWithinProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/WomanWithin/WomanWithinSiteInjector",[],function(){return{d:["DataDrivenSiteInjector"],c:function(){var WomanWithinSiteInjector;return WomanWithinSiteInjector=function(_super){__extends(WomanWithinSiteInjector,_super);function WomanWithinSiteInjector(){return WomanWithinSiteInjector.__super__.constructor.apply(this,arguments)}return WomanWithinSiteInjector.prototype.parseUrl=function(url){var id,style,_ref,_ref1;id=(_ref=url.match(/[?&]pfid=(\d+)/i))!=null?_ref[1]:void 0;if(id)return style=(_ref1=url.match(/[?&]styleno=(\d+)/i))!=null?_ref1[1]:void 0,style?""+id+"-"+style:id},WomanWithinSiteInjector.prototype.productListing={mode:2,overlayZIndex:1,image:'a img[src^="http://media.plussizetech.com/womanwithin/"]',forcePositioned:!0},WomanWithinSiteInjector.prototype.productPage={mode:2,productSid:function(){var id,style,_ref,_ref1;if($("#Main_Image_0").length)return id=(_ref=document.location.href.match(/[?&]pfid=(\d+)/i))!=null?_ref[1]:void 0,style=(_ref1=$("#Main_Image_0").attr("src").match(/.*?\_(\d*).jpg?[^']*/))!=null?_ref1[1]:void 0,style?""+id+"-"+style:id},image:"#Main_Image_0",overlay:"#alt_main_image_0 .zoomLink span",attach:"body"},WomanWithinSiteInjector}(DataDrivenSiteInjector)}}}),{excludedFeatures:["deals","offers"],hasProductClass:!0,slug:"zappos",hosts:["www.zappos.com"],currency:"dollar",scraper:!0,hasMore:!0,icon:"http://www.zappos.com/favicon.ico",productUrl:function(sid){var colorId,productId,_ref;return _ref=sid.split("-"),productId=_ref[0],colorId=_ref[1],colorId?"http://www.zappos.com/viewProduct.do?productId="+productId+"&colorId="+colorId:"http://www.zappos.com/viewProduct.do?productId="+productId},query:function(product){return{brand:product.get("more").brand.name,title:product.get("more").name}}},define("sites/Zappos/config",function(){});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Zappos/ZapposProduct",["scraping/SiteProduct"],function(SiteProduct){var ZapposProduct;return ZapposProduct=function(_super){__extends(ZapposProduct,_super);function ZapposProduct(){return ZapposProduct.__super__.constructor.apply(this,arguments)}return ZapposProduct.prototype.baseUrl="http://www.zappos.com",ZapposProduct.prototype.images=function(cb){return this.product["with"]("more",function(_this){return function(more){var id,image,images,name,style,_ref,_ref1;images={},_ref=more.styles;for(id in _ref){style=_ref[id],images[id]=[],_ref1=style.images;for(name in _ref1)image=_ref1[name],image.MULTIVIEW&&images[id].push({small:image.MULTIVIEW,medium:image.MULTIVIEW,large:image["4x"],larger:image["4x"],full:image["4x"]})}return cb(images,more.currentStyle)}}(this))},ZapposProduct.prototype.widgets=function(cb){return this.product["with"]("more","reviews",function(_this){return function(more,reviews){var colors,id,style,widgets,_ref;colors=[],_ref=more.styles;for(id in _ref)style=_ref[id],colors.push(style.color.name);return widgets=_this.genWidgets(more,{description:"Description",sizes:"Sizes",colors:{obj:colors,title:"Colors"},reviews:{obj:reviews}}),cb(widgets)}}(this))},ZapposProduct}(SiteProduct)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Zappos/ZapposProductScraper",["scraping/ProductScraper","scraping/resourceScrapers/PatternResourceScraper","scraping/resourceScrapers/ScriptedResourceScraper","scraping/resourceScrapers/DeclarativeResourceScraper","underscore"],function(ProductScraper,PatternResourceScraper,ScriptedResourceScraper,DeclarativeResourceScraper,_){var ZapposProductScraper,matchAll;return matchAll=function(string,pattern){var match,matches,_i,_len,_results;matches=string.match(new RegExp(_.isString(pattern)?pattern:pattern.source,"g"));if(matches){_results=[];for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],_results.push(match.match(pattern));return _results}return[]},ZapposProductScraper=function(_super){__extends(ZapposProductScraper,_super);function ZapposProductScraper(){return ZapposProductScraper.__super__.constructor.apply(this,arguments)}return ZapposProductScraper.productSid=function(background,url,cb){return background.httpRequest(url,{cb:function(response){var colorId,matches,sku;return matches=/<span id="sku" itemprop="sku">SKU (\d+)<\/span>/.exec(response),matches?(sku=matches[1],matches=/<input type="hidden" id="color" value="(\d+)" name="colorId" \/>/.exec(response),matches?colorId=matches[1]:(matches=/<select id="color" name="colorId" class="btn secondary">([\S\s]+)<\/select>/.exec(response),matches=/<option value="(\d+)" selected="selected">[^<]+<\/option>/.exec(matches[1]),colorId=matches[1]),cb(""+sku+"-"+colorId)):cb()}})},ZapposProductScraper.prototype.resources={productPage:{url:function(){return this.site.productUrl(this.productSid)}}},ZapposProductScraper.prototype.properties={title:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","title")},price:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","price")},image:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","image")},rating:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","rating")},ratingCount:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","ratingCount")},reviews:{resource:"productPage",scraper:DeclarativeResourceScraper("scraper","reviews")},more:{resource:"productPage",scraper:ScriptedResourceScraper(function(){var colorId,colorName,colorToStyle,currentColorId,id,m,match,matches,style,styleId,styles,switches,type,url,value,_base,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref;switches={styles:!0},value=this.declarativeScraper("scraper");if(switches.styles){styles={},colorToStyle={},currentColorId=this.resource.match(/<option value="(\d*)" selected="selected">/)[1],matches=this.resource.match(/var styleIds = \{([^}]*)/),matches=matches[1].match(/'([^']*)':\s*(\d*)/g);for(_i=0,_len=matches.length;_i<_len;_i++)match=matches[_i],m=match.match(/'([^']*)':\s*(\d*)/),colorId=m[1],styleId=m[2],styles[styleId]={id:styleId,color:{id:colorId},images:{}},colorToStyle[colorId]=styleId;value.currentStyle=colorToStyle[currentColorId],matches=this.matchAll(this.resource,/<img src="([^"]*)" class="gae-click\*Product-Page\*PrImage\*Swatch" \/>/);for(_j=0,_len1=matches.length;_j<_len1;_j++)match=matches[_j],url=match[1],styleId=/http:\/\/[^.]*.zassets.com\/images\/[a-z]*\/\d\/.*?\/(\d*)-[a-z]-\w*\.jpg/.exec(url)[1],styles[styleId].thumbUrl=url;matches=this.resource.match(/var colorNames = \{([^}]*)/),matches=matches[1].match(/'([^']*)':"([^"]*)"/g);for(_k=0,_len2=matches.length;_k<_len2;_k++)match=matches[_k],m=match.match(/'([^']*)':"([^"]*)"/),colorId=m[1],colorName=m[2],styleId=colorToStyle[colorId],styles[styleId].color.name=colorName;matches=this.resource.match(/pImgs\[(\d+)\]\['([^']*)'\]\['([^']*)'\] = (?:'([^']*)'|\{ filename: '([^']*)', width: '\d*', height: '\d*' \};)/g);for(_l=0,_len3=matches.length;_l<_len3;_l++)match=matches[_l],m=match.match(/pImgs\[(\d+)\]\['([^']*)'\]\['([^']*)'\] = (?:'([^']*)'|\{ filename: '([^']*)', width: '\d*', height: '\d*' \};)/),style=m[1],type=m[2],id=m[3],url=(_ref=m[4])!=null?_ref:m[5],(_base=styles[style].images)[id]==null&&(_base[id]={}),styles[style].images[id][type]=url;value.styles=styles}return this.value(value)})}},ZapposProductScraper}(ProductScraper)});var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};define("sites/Zappos/ZapposSiteInjector",[],function(){return{d:["SiteInjector","views/ShoppingBarView","DataDrivenSiteInjector"],c:function(){var ZapposSiteInjector;return ZapposSiteInjector=function(_super){__extends(ZapposSiteInjector,_super);function ZapposSiteInjector(){return ZapposSiteInjector.__super__.constructor.apply(this,arguments)}return ZapposSiteInjector.prototype.siteName="Zappos",ZapposSiteInjector.prototype.productListing={mode:2,selectors:{"a[rel=product] img, a.product img, .productReviews a img":{productData:function(href,a,img,el){var matches;matches=/http:\/\/[^.]*.zassets.com\/images\/[a-z]*\/\d\/.*?\/(\d*)-[a-z]-\w*\.jpg/.exec(img.attr("src"));if(matches)return{productUrl:href,retrievalId:matches[1]}}}}},ZapposSiteInjector.prototype.productPage={mode:2,test:function(){return $("#content.productPage").length},image:"#detailImage img, #detailImage2 img, #actors img",attach:"#prdImage",productSid:function(){var colorId,sku;return sku=$("#sku").html().match("^SKU (\\d+)")[1],colorId=$("#color").val(),""+sku+"-"+colorId}},ZapposSiteInjector.prototype.initProduct=function(){var colorId,productSid,sku;return sku=$("#sku").html().match("^SKU (\\d+)")[1],colorId=$("#color").val(),productSid=""+sku+"-"+colorId,this.buttonView.represent({siteName:this.siteName,productSid:productSid}),this.products("#detailImage img",{siteName:this.siteName,productSid:productSid}),this.products("#detailImage2 img",{siteName:this.siteName,productSid:productSid}),this.bottomBarView.activeProduct={siteName:this.siteName,productSid:productSid}},ZapposSiteInjector.prototype.runOff=function(){return this.initPage(function(_this){return function(){var currentSid,initProduct,initProducts,selector;return _this.bottomBarView=new ShoppingBarView(_this.contentScript),_this.bottomBarView.el.appendTo(document.body),_this.bottomBarView.represent(),initProduct=function(el,retrievalId,url,mousedover){return _this.initProductEl(el,{productUrl:url,retrievalId:retrievalId},{hovering:mousedover})},selector="a[rel=product] img, a.product img, .productReviews a img",window.initProducts=initProducts=function(){return $(selector).each(function(){var a,matches;matches=/http:\/\/[^.]*.zassets.com\/images\/[a-z]*\/\d\/.*?\/(\d*)-[a-z]-\w*\.jpg/.exec($(this).attr("src"));if(matches)return a=$(this).parents("a"),initProduct(this,matches[1],a.prop("href"),!1)})},initProducts(),setInterval(initProducts,2e3),currentSid=function(){var colorId,sku;return sku=$("#sku").html().match("^SKU (\\d+)")[1],colorId=$("#color").val(),""+sku+"-"+colorId},$("body").delegate("#actors .actor img","mouseover",function(e){return _this.clearProductEl(e.target),_this.initProductEl(e.target,{productSid:currentSid()},{overlay:!1})}),$(function(){return _this.initProductEl($("#protagonist"),{productSid:currentSid()},{image:!1,initOverlay:function(overlay){return overlay.addAlwaysShow("productPage"),overlay.autoFixPosition()}})}),!0}}(this))},ZapposSiteInjector}(DataDrivenSiteInjector)}}}),require(["views/AddArgumentView","views/AddDataView","views/AddDescriptorView","views/AddFeelingView","views/AddItemView","views/BuyView","views/ChatView","views/CollaborateView","views/compare/BundleTileItem","views/compare/CompareView","views/compare/DecisionTileItem","views/compare/ListTileItem","views/compare/ProductTileItem","views/compare/TileItem","views/compare/TileItemView","views/compare/UnauthorizedTileItem","views/CompetitiveProcessView","views/ContactView","views/CouponsView","views/DataView","views/DecisionPreviewView","views/EditDescriptorView","views/items/DecisionItem","views/items/Item","views/ItemView","views/OffersView","views/ProductAddedView","views/ProductClipView","views/ProductMenuView","views/ProductOverlayView","views/ProductPopupView","views/ProductPreviewView","views/ProductPriceView","views/ReviewsView","views/SettingsView","views/SharedWithYouView","views/ShareView","views/ShoppingBarView/BarItem","views/ShoppingBarView/BarItemView","views/ShoppingBarView/BarItemView1","views/ShoppingBarView/BeltBarItem","views/ShoppingBarView/BundleBarItem","views/ShoppingBarView/CompositeBarItem","views/ShoppingBarView/CompositeSlotBarItem","views/ShoppingBarView/DecisionBarItem","views/ShoppingBarView/ListBarItem","views/ShoppingBarView/ProductBarItem","views/ShoppingBarView/SessionBarItem","views/ShoppingBarView/SharedBeltBarItem","views/ShoppingBarView/UnauthorizedBarItem","views/ShoppingBarView","views/SocialShareView","views/WebAppView","sites/Amazon/AmazonProduct","sites/Amazon/AmazonProductScraper","sites/Amazon/AmazonSite","sites/Amazon/AmazonSiteInjector","sites/Amazon/config","sites/AmericanApparel/AmericanApparelProduct","sites/AmericanApparel/AmericanApparelProductScraper","sites/AmericanApparel/AmericanApparelSiteInjector","sites/AmericanApparel/config","sites/Asos/AsosProduct","sites/Asos/AsosProductScraper","sites/Asos/AsosSiteInjector","sites/Asos/config","sites/BarnesAndNoble/BarnesAndNobleProduct","sites/BarnesAndNoble/BarnesAndNobleProductScraper","sites/BarnesAndNoble/BarnesAndNobleSiteInjector","sites/BarnesAndNoble/config","sites/BestBuy/BestBuyProduct","sites/BestBuy/BestBuyProductScraper","sites/BestBuy/BestBuySiteInjector","sites/BestBuy/config","sites/Bloomingdales/BloomingdalesProduct","sites/Bloomingdales/BloomingdalesProductScraper","sites/Bloomingdales/BloomingdalesSiteInjector","sites/Bloomingdales/config","sites/ColdwaterCreek/ColdwaterCreekProduct","sites/ColdwaterCreek/ColdwaterCreekProductScraper","sites/ColdwaterCreek/ColdwaterCreekSiteInjector","sites/ColdwaterCreek/config","sites/Costco/config","sites/Costco/CostcoProduct","sites/Costco/CostcoProductScraper","sites/Costco/CostcoSiteInjector","sites/CVS/CVSProductScraper","sites/CVS/CVSSiteInjector","sites/Dev/config","sites/Dev/DevProduct","sites/Dev/DevProductScraper","sites/Dev/DevSiteInjector","sites/Diapers/config","sites/Diapers/DiapersProduct","sites/Diapers/DiapersProductScraper","sites/Diapers/DiapersSiteInjector","sites/Ebay/config","sites/Ebay/EbayProductScraper","sites/Ebay/EbaySiteInjector","sites/Etsy/config","sites/Etsy/EtsyProduct","sites/Etsy/EtsyProductScraper","sites/Etsy/EtsySiteInjector","sites/Express/config","sites/Express/ExpressProduct","sites/Express/ExpressProductScraper","sites/Express/ExpressSiteInjector","sites/Fab/config","sites/Fab/FabProduct","sites/Fab/FabProductScraper","sites/Fab/FabSiteInjector","sites/Fancy/config","sites/Fancy/FancyProduct","sites/Fancy/FancyProductScraper","sites/Fancy/FancySiteInjector","sites/FashionBug/config","sites/FashionBug/FashionBugProduct","sites/FashionBug/FashionBugSiteInjector","sites/Forever21/config","sites/Forever21/Forever21ProductScraper","sites/Forever21/Forever21SiteInjector","sites/FreePeople/config","sites/FreePeople/FreePeopleProduct","sites/FreePeople/FreePeopleProductScraper","sites/FreePeople/FreePeopleSiteInjector","sites/Gap/config","sites/Gap/GapProductScraper","sites/Gap/GapSiteInjector","sites/General/config","sites/General/GeneralProductScraper","sites/General/GeneralSiteInjector","sites/HM/config","sites/HM/HMProduct","sites/HM/HMProductScraper","sites/HM/HMSiteInjector","sites/HomeDepot/config","sites/HomeDepot/HomeDepotProduct","sites/HomeDepot/HomeDepotProductScraper","sites/HomeDepot/HomeDepotSiteInjector","sites/JCPenney/config","sites/JCPenney/JCPenneyProduct","sites/JCPenney/JCPenneyProductScraper","sites/JCPenney/JCPenneySiteInjector","sites/JCrew/config","sites/JCrew/JCrewProduct","sites/JCrew/JCrewProductScraper","sites/JCrew/JCrewSiteInjector","sites/KateSpade/config","sites/KateSpade/KateSpadeProduct","sites/KateSpade/KateSpadeProductScraper","sites/KateSpade/KateSpadeSiteInjector","sites/Kmart/config","sites/Kmart/KmartProduct","sites/Kmart/KmartProductScraper","sites/Kmart/KmartSiteInjector","sites/Kohls/config","sites/Kohls/KohlsProductScraper","sites/Kohls/KohlsSiteInjector","sites/LandsEnd/config","sites/LandsEnd/LandsEndProduct","sites/LandsEnd/LandsEndProductScraper","sites/LandsEnd/LandsEndSiteInjector","sites/LLBean/config","sites/LLBean/LLBeanProduct","sites/LLBean/LLBeanProductScraper","sites/LLBean/LLBeanSiteInjector","sites/Lowes/LowesProductScraper","sites/Lowes/LowesSiteInjector","sites/LuLus/config","sites/LuLus/LuLusProduct","sites/LuLus/LulusProductScraper","sites/LuLus/LulusSiteInjector","sites/Macys/config","sites/Macys/MacysProductScraper","sites/Macys/MacysSiteInjector","sites/MakeMeChic/config","sites/MakeMeChic/MakeMeChicProduct","sites/MakeMeChic/MakeMeChicProductScraper","sites/MakeMeChic/MakeMeChicSiteInjector","sites/ModCloth/config","sites/ModCloth/ModClothProduct","sites/ModCloth/ModClothProductScraper","sites/ModCloth/ModClothSiteInjector","sites/NastyGal/config","sites/NastyGal/NastyGalProduct","sites/NastyGal/NastyGalProductScraper","sites/NastyGal/NastyGalSiteInjector","sites/Newegg/config","sites/Newegg/NeweggProductScraper","sites/Newegg/NeweggSiteInjector","sites/Nordstrom/config","sites/Nordstrom/NordstromProduct","sites/Nordstrom/NordstromProductScraper","sites/Nordstrom/NordstromSiteInjector","sites/Overstock/config","sites/Overstock/OverstockProductScraper","sites/Overstock/OverstockSiteInjector","sites/QVC/config","sites/QVC/QVCProduct","sites/QVC/QVCProductScraper","sites/QVC/QVCSiteInjector","sites/Rakuten/config","sites/Rakuten/RakutenProductScraper","sites/Rakuten/RakutenSiteInjector","sites/Rei/config","sites/Rei/ReiProductScraper","sites/Rei/ReiSiteInjector","sites/RentTheRunway/config","sites/RentTheRunway/RentTheRunwayProduct","sites/RentTheRunway/RentTheRunwayProductScraper","sites/RentTheRunway/RentTheRunwaySiteInjector","sites/SamsClub/config","sites/SamsClub/SamsClubProductScraper","sites/SamsClub/SamsClubSiteInjector","sites/Sears/config","sites/Sears/SearsProduct","sites/Sears/SearsProductScraper","sites/Sears/SearsSiteInjector","sites/Singer22/config","sites/Singer22/Singer22Product","sites/Singer22/Singer22ProductScraper","sites/Singer22/Singer22SiteInjector","sites/SixPM/config","sites/SixPM/SixPmProduct","sites/SixPM/SixPMProductScraper","sites/SixPM/SixPmSiteInjector","sites/Soap/config","sites/Soap/SoapProduct","sites/Soap/SoapProductScraper","sites/Soap/SoapSiteInjector","sites/Staples/StaplesProductScraper","sites/Staples/StaplesSiteInjector","sites/Target/config","sites/Target/TargetProductScraper","sites/Target/TargetSiteInjector","sites/TheLimited/config","sites/TheLimited/TheLimitedProduct","sites/TheLimited/TheLimitedProductScraper","sites/TheLimited/TheLimitedSiteInjector","sites/ToysRUs/config","sites/ToysRUs/ToysRUsProductScraper","sites/ToysRUs/ToysRUsSiteInjector","sites/Tutorial/config","sites/Tutorial/TutorialSiteInjector","sites/Uniqlo/config","sites/Uniqlo/UniqloProduct","sites/Uniqlo/UniqloProductScraper","sites/Uniqlo/UniqloSiteInjector","sites/VictoriasSecret/config","sites/VictoriasSecret/VictoriasSecretProductScraper","sites/VictoriasSecret/VictoriasSecretSiteInjector","sites/Vitacost/_SiteInjector","sites/Vitacost/VitacostProductScraper","sites/Walgreens/config","sites/Walgreens/WalgreensProductScraper","sites/Walgreens/WalgreensSiteInjector","sites/Webapp/config","sites/Webapp/WebappProductScraper","sites/Webapp/WebappSiteInjector","sites/WetSeal/config","sites/WetSeal/WetSealProduct","sites/WetSeal/WetSealProductScraper","sites/WetSeal/WetSealSiteInjector","sites/WomanWithin/config","sites/WomanWithin/WomanWithinProduct","sites/WomanWithin/WomanWithinProductScraper","sites/WomanWithin/WomanWithinSiteInjector","sites/Zappos/config","sites/Zappos/ZapposProduct","sites/Zappos/ZapposProductScraper","sites/Zappos/ZapposSiteInjector"]),define("../../all.js",function(){}),define("Background",["client/ContentScript"],function(ContentScript){var Background;return Background=function(){Background.prototype.apiVersion="0.0.1",Background.prototype.contentScriptListen=function(eventName,tabId){var l;if(!(l=this.contentScriptListeners[eventName]))return this.contentScriptListeners[eventName]=[tabId];if(l.indexOf(tabId)===-1)return l.push(tabId)},Background.prototype.setDomain=function(domain){return this.domain=domain,this.apiRoot="http://"+this.domain+"/ext/"};function Background(){typeof env!="undefined"&&this.domain==null&&(this.domain=env.domain),this.apiRoot="http://"+this.domain+"/ext/",this.instanceId=(new Date).getTime()+"-"+(Math.random()+"").replace(".",""),this.listeners={},this.contentScriptListeners={},this.onRequest(function(_this){return function(request,sender,sendResponse){var eventSource,i,l,listener;if(request.version!=null&&request.version!==_this.version)return sendResponse("oldVersion"),!0;switch(request.request){case"injectUtilScripts":return _this.injectUtilScripts(sender,sendResponse),!0;case"listen":if(!(l=_this.contentScriptListeners[request.eventName]))return _this.contentScriptListeners[request.eventName]=[sender.id];if(l.indexOf(sender.id)===-1)return l.push(sender.id);break;case"stopListening":if(l=_this.contentScriptListeners[request.eventName]){i=l.indexOf(sender.id),l.splice(i,1);if(!l.length)return delete _this.contentScriptListeners[request.eventName]}break;case"BackgroundMessage":return(listener=_this.listeners[request.messageName])?(eventSource={url:sender.url,tabId:sender.id},listener(eventSource,request.args,sendResponse)):console.log("No listener for "+request.event),!0}}}(this)),String.prototype.safeMatch=function(pattern){var matches;if(this.match){matches=this.match(pattern);if(matches)return matches;throw new Error(""+pattern+" not found in "+this)}}}return Background.prototype.triggerContentScriptEvent=function(eventName,args,debug){var l,tabID,_i,_len,_ref,_results;debug==null&&(debug=!1),l=this.contentScriptListeners[eventName],debug&&console.debug("triggerContentScriptEvent",eventName,args,(_ref=this.contentScriptListeners[eventName])!=null?_ref.length:void 0);if(l){_results=[];for(_i=0,_len=l.length;_i<_len;_i++)tabID=l[_i],_results.push(this.sendRequest(tabID,{eventName:eventName,args:args}));return _results}},Background.prototype.listen=function(request,cb){return this.listeners[request]=cb},Background.prototype.logError=function(type,message,file,line,column,stack,info,args){if(!env.dontSubmitErrors)return this.httpRequest(""+this.apiRoot+"logErrors.php",{method:"post",data:{type:type,args:args,error:{message:message,file:file,line:line,column:column,info:info,stack:stack},userId:this.userId,extVersion:this.version,apiVersion:this.apiVersion,clientId:this.clientId}})},Background.prototype.error=function(){var arg,args,error,i,realError,_i,_len,_ref;args=[],error={},realError=null,_ref=Array.prototype.slice.call(arguments,1);for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)arg=_ref[i],arg instanceof Error?(realError=arg,error={message:arg.message,stack:arg.stack,info:arg.info,line:arg.line}):args.push(arg);this.logError(arguments[0],error.message,error.file,error.line,error.column,error.stack,error.info,args);if(realError&&!env.gracefulFailure)throw realError},Background.prototype.contentScript=function(){},Background.prototype.httpGet=function(opts){},Background.prototype.require=function(modules,cb){},Background.prototype.unregisterTab=function(tabId){var event,i,tabIds,_ref,_results;console.log("unregistering tab",tabId),_ref=this.contentScriptListeners,_results=[];for(event in _ref)tabIds=_ref[event],i=tabIds.indexOf(tabId),i!==-1?(tabIds.splice(i,1),tabIds.length?_results.push(void 0):_results.push(delete this.contentScriptListeners[event])):_results.push(void 0);return _results},Background.prototype.reset=function(){return this.contentScriptListeners={}},Background.prototype.ping=function(){return this.httpRequest(""+this.apiRoot+"ping.php",{data:{id:this.instanceId,version:this.version}})},Background}()});